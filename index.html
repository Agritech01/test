<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบ Clean Data สำหรับข้อมูลอ้อย - แบบครบวงจร 6 ขั้นตอน</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Prompt:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* CSS Styles ที่มีทั้งหมดจะอยู่ที่นี่ */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #4cc9f0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f72585;
            --info-color: #17a2b8;
            --purple-color: #6f42c1;
            --orange-color: #fd7e14;
            --teal-color: #20c997;
            --blue-color: #0066cc;
            --sugarcane-color: #228B22;
            --fertilizer-color: #9C27B0;
            --project-color: #FF5722;
            --border-radius: 12px;
            --box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Prompt', sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        
        header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        
        h1 {
            font-family: 'Kanit', sans-serif;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* Step Navigation */
        .step-navigation {
            display: flex;
            justify-content: center;
            background-color: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: wrap;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 10px;
            position: relative;
            min-width: 150px;
            margin-bottom: 10px;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 10px;
            z-index: 2;
            transition: all 0.3s ease;
        }
        
        .step.active .step-number {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 0 0 5px rgba(67, 97, 238, 0.2);
        }
        
        .step.completed .step-number {
            background-color: var(--success-color);
            color: white;
        }
        
        .step-info {
            display: flex;
            flex-direction: column;
        }
        
        .step-title {
            font-weight: 500;
            font-size: 1rem;
            white-space: nowrap;
        }
        
        .step-description {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        /* Step Content */
        .step-content {
            padding: 40px;
            min-height: 600px;
        }
        
        .step-panel {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .step-panel.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Panel Header */
        .panel-header {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .panel-header h2 {
            font-size: 2rem;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .panel-header p {
            color: #666;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Upload Area */
        .upload-area {
            border: 3px dashed var(--accent-color);
            border-radius: var(--border-radius);
            padding: 60px 20px;
            text-align: center;
            background-color: rgba(76, 201, 240, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .upload-area:hover {
            background-color: rgba(76, 201, 240, 0.1);
            border-color: var(--primary-color);
        }
        
        .upload-area i {
            font-size: 4rem;
            color: var(--accent-color);
            margin-bottom: 20px;
        }
        
        .upload-area h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--secondary-color);
        }
        
        .upload-area p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .file-info {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .info-item strong {
            display: block;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }
        
        /* Step 2: Filtering Section */
        .filtering-section {
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
        }
        
        .filter-process-section {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .process-btn {
            padding: 20px 50px;
            font-size: 1.3rem;
            margin-bottom: 20px;
        }
        
        .filter-results-section {
            display: none;
        }
        
        .filter-results-section.show {
            display: block;
        }
        
        .process-steps {
            margin-top: 30px;
        }
        
        .step-card {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .step-card.success {
            border-left-color: var(--success-color);
        }
        
        .step-card.warning {
            border-left-color: var(--warning-color);
        }
        
        .step-card.error {
            border-left-color: var(--danger-color);
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 15px;
        }
        
        .step-card.success .step-icon {
            background-color: var(--success-color);
        }
        
        .step-card.warning .step-icon {
            background-color: var(--warning-color);
        }
        
        .step-card.error .step-icon {
            background-color: var(--danger-color);
        }
        
        .step-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .step-description {
            color: #666;
            margin-bottom: 15px;
        }
        
        .step-results {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .result-item {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }
        
        .result-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .result-label {
            font-size: 0.85rem;
            color: #666;
        }
        
        .final-summary {
            background: linear-gradient(135deg, #e8f4fd 0%, #d1ecf1 100%);
            padding: 30px;
            border-radius: var(--border-radius);
            margin-top: 40px;
            text-align: center;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .summary-item {
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .summary-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Navigation Buttons */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 25px;
            border-radius: 30px;
            border: none;
            font-family: 'Kanit', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3d8b40;
            transform: translateY(-2px);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Spinner */
        .spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 30px;
            color: #666;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .step-navigation {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .step {
                width: 100%;
                max-width: 300px;
            }
            
            .step-content {
                padding: 30px 20px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .panel-header h2 {
                font-size: 1.5rem;
            }
            
            .upload-area {
                padding: 40px 15px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .navigation-buttons button {
                width: 100%;
            }
            
            .process-btn {
                padding: 15px 30px;
                font-size: 1.1rem;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-value {
                font-size: 1.5rem;
            }
            /* Column Selection Panel */
.column-selection-panel {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    padding: 25px;
    margin-bottom: 30px;
}

.selection-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.search-container {
    flex: 1;
    min-width: 300px;
}

.search-box {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #ddd;
    border-radius: 30px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.search-box:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

.search-stats {
    display: flex;
    gap: 15px;
    font-size: 0.9rem;
    color: #666;
}

.selection-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.selection-btn {
    padding: 8px 15px;
    background-color: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.selection-btn:hover {
    background-color: #e9ecef;
}

.selection-btn.active {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.columns-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    max-height: 400px;
    overflow-y: auto;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: var(--border-radius);
    margin-bottom: 20px;
}

.column-item {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.column-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 10px rgba(0,0,0,0.1);
}

.column-item.selected {
    border-color: var(--primary-color);
    background-color: rgba(67, 97, 238, 0.05);
}

.column-item.sugarcane {
    border-left: 4px solid var(--sugarcane-color);
}

.column-item.activity {
    border-left: 4px solid var(--accent-color);
}

.column-item.project {
    border-left: 4px solid var(--project-color);
}

.column-item.fertilizer {
    border-left: 4px solid var(--fertilizer-color);
}

.column-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.column-info {
    flex: 1;
}

.column-name {
    font-weight: 500;
    margin-bottom: 5px;
    word-break: break-word;
}

.column-type {
    font-size: 0.8rem;
    color: #666;
    background-color: #f0f0f0;
    padding: 2px 8px;
    border-radius: 10px;
    display: inline-block;
}

.column-stats {
    font-size: 0.8rem;
    color: #888;
    margin-top: 5px;
}

.selected-summary {
    background-color: #e8f5e9;
    padding: 15px;
    border-radius: var(--border-radius);
    border-left: 4px solid var(--success-color);
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

@media (max-width: 768px) {
    .columns-grid {
        grid-template-columns: 1fr;
    }
    
    .selection-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .search-container {
        min-width: 100%;
    }
    
    .selected-summary {
        flex-direction: column;
        align-items: flex-start;
    }
    /* Dashboard Summary */
.dashboard-summary {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 20px;
    border-radius: var(--border-radius);
    margin-bottom: 30px;
    animation: slideDown 0.5s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.summary-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 20px;
    box-shadow: var(--box-shadow);
    display: flex;
    align-items: center;
    gap: 15px;
    transition: transform 0.3s ease;
}

.summary-card:hover {
    transform: translateY(-5px);
}

.summary-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.summary-icon.success {
    background: rgba(76, 175, 80, 0.1);
    color: var(--success-color);
}

.summary-icon.warning {
    background: rgba(255, 152, 0, 0.1);
    color: var(--warning-color);
}

.summary-icon.error {
    background: rgba(247, 37, 133, 0.1);
    color: var(--danger-color);
}

.summary-icon.info {
    background: rgba(67, 97, 238, 0.1);
    color: var(--primary-color);
}

.summary-content {
    flex: 1;
}

.summary-content h4 {
    margin: 0 0 5px 0;
    color: #495057;
    font-size: 0.9rem;
}

.summary-value {
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.progress-bar {
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 1s ease;
}

.progress-fill.success {
    background: var(--success-color);
}

.progress-fill.warning {
    background: var(--warning-color);
}

.progress-fill.error {
    background: var(--danger-color);
}

.progress-fill.info {
    background: var(--primary-color);
}

.summary-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
}

.btn-sm {
    padding: 8px 15px;
    font-size: 0.9rem;
}

/* Data Type Configuration */
.data-type-configuration {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    padding: 25px;
    margin-bottom: 30px;
    animation: fadeIn 0.5s ease;
    display: none;
}

.data-type-configuration h3 {
    color: var(--secondary-color);
    margin-bottom: 20px;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.config-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.data-type-table-container {
    overflow-x: auto;
    margin-top: 20px;
    border-radius: 8px;
    border: 1px solid #ddd;
    max-height: 400px;
    overflow-y: auto;
}

.data-type-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

.data-type-table th {
    background-color: var(--primary-color);
    color: white;
    padding: 15px;
    text-align: left;
    font-weight: 500;
    position: sticky;
    top: 0;
    z-index: 10;
    cursor: pointer;
    user-select: none;
}

.data-type-table th:hover {
    background-color: var(--secondary-color);
}

.data-type-table th i {
    margin-left: 5px;
    opacity: 0.7;
}

.data-type-table td {
    padding: 12px;
    border-bottom: 1px solid #eee;
}

.type-select, .format-select, .unit-select {
    width: 100%;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #ddd;
    font-family: 'Prompt', sans-serif;
    background: white;
}

.type-select:focus, .format-select:focus, .unit-select:focus {
    border-color: var(--accent-color);
    outline: none;
}

.data-sample-cell {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Data Table */
.data-table-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: white;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    border: 1px solid #dee2e6;
    border-bottom: none;
}

.table-info {
    display: flex;
    gap: 20px;
    color: #6c757d;
    font-size: 0.9rem;
    align-items: center;
}

.table-actions {
    display: flex;
    gap: 10px;
}

#dataStatus {
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
}

#dataStatus:hover {
    opacity: 0.9;
}

.data-table-container {
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0 0 var(--border-radius) var(--border-radius);
    background: white;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th {
    background: var(--primary-color);
    color: white;
    padding: 12px;
    text-align: left;
    font-weight: 500;
    position: sticky;
    top: 0;
    z-index: 10;
    border-bottom: 2px solid var(--secondary-color);
}

.data-table td {
    padding: 10px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.3s ease;
}

.data-table tr:hover td {
    background: #f8f9fa;
}

/* Cell Styling */
.cell-error {
    background: rgba(247, 37, 133, 0.1) !important;
    color: var(--danger-color) !important;
    font-weight: 600;
    position: relative;
    cursor: pointer;
}

.cell-error:hover {
    background: rgba(247, 37, 133, 0.2) !important;
}

.cell-error:after {
    content: "!";
    position: absolute;
    top: 2px;
    right: 2px;
    width: 16px;
    height: 16px;
    background: var(--danger-color);
    color: white;
    border-radius: 50%;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.cell-warning {
    background: rgba(255, 152, 0, 0.1) !important;
    color: var(--warning-color) !important;
    cursor: pointer;
}

.cell-valid {
    color: var(--success-color);
}

.cell-editing {
    background: #fffde7 !important;
    border: 2px solid var(--accent-color) !important;
}

.cell-highlight {
    animation: highlightCell 2s ease;
}

@keyframes highlightCell {
    0% { background-color: #fff3e0; }
    50% { background-color: #ffecb3; }
    100% { background-color: transparent; }
}

/* Cell Editor Modal */
.cell-editor-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.cell-editor-modal.show {
    display: flex;
}

.cell-editor-modal .modal-content {
    background: white;
    border-radius: var(--border-radius);
    width: 90%;
    max-width: 500px;
    animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
}

.modal-header h4 {
    margin: 0;
    color: var(--secondary-color);
}

.close-modal {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6c757d;
    cursor: pointer;
    line-height: 1;
}

.modal-body {
    padding: 20px;
}

.cell-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.cell-info p {
    margin: 5px 0;
    color: #495057;
}

.error-text {
    color: var(--danger-color) !important;
    font-weight: 500;
}

.warning-text {
    color: var(--warning-color) !important;
    font-weight: 500;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    color: #495057;
    font-weight: 500;
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 0.9rem;
}

.form-control:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.1);
}

.suggestions {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-top: 5px;
}

.suggestion-item {
    background: #e3f2fd;
    color: var(--primary-color);
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: background 0.3s ease;
}

.suggestion-item:hover {
    background: #bbdefb;
}

.modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* Filter dropdown in table header */
.filter-dropdown {
    width: calc(100% - 10px);
    margin-top: 5px;
    padding: 4px 6px;
    font-size: 0.8rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: 'Prompt', sans-serif;
    background-color: white;
}

.filter-dropdown:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.2);
}

/* Responsive */
@media (max-width: 992px) {
    .data-type-controls {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .data-table-controls {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .table-info {
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .table-actions {
        width: 100%;
        justify-content: flex-end;
    }
}

@media (max-width: 768px) {
    .summary-cards {
        grid-template-columns: 1fr;
    }
    
    .data-table-controls {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
    
    .table-info {
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .table-actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .config-controls {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .btn-sm {
        width: 100%;
        justify-content: center;
    }
}
}
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-seedling"></i> ระบบ Clean Data สำหรับข้อมูลอ้อย</h1>
            <p class="subtitle">ระบบตรวจสอบและทำความสะอาดข้อมูลอ้อยครบวงจร - 6 ขั้นตอน</p>
        </header>
        
        <!-- Step Navigation -->
        <div class="step-navigation">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-info">
                    <div class="step-title">อัปโหลดไฟล์ CSV</div>
                    <div class="step-description">อัปโหลดไฟล์ข้อมูลอ้อย</div>
                </div>
            </div>
            
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-info">
                    <div class="step-title">กรองข้อมูลทั้งหมด</div>
                    <div class="step-description">ทำความสะอาดข้อมูล 11 ขั้นตอน</div>
                </div>
            </div>
            
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-info">
                    <div class="step-title">เลือกคอลัมน์ที่ต้องการ</div>
                    <div class="step-description">ค้นหาและเลือกคอลัมน์ที่ต้องการตรวจสอบ</div>
                </div>
            </div>
            
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div class="step-info">
                    <div class="step-title">ตรวจสอบและแก้ไขข้อมูล</div>
                    <div class="step-description">ตรวจสอบและแก้ไขข้อมูลที่เลือก</div>
                </div>
            </div>
            
            <div class="step" id="step5">
                <div class="step-number">5</div>
                <div class="step-info">
                    <div class="step-title">ตรวจสอบเงื่อนไข</div>
                    <div class="step-description">ตรวจสอบเงื่อนไขเฉพาะข้อมูลอ้อย</div>
                </div>
            </div>
            
            <div class="step" id="step6">
                <div class="step-number">6</div>
                <div class="step-info">
                    <div class="step-title">เลือกคอลัมน์สำหรับส่งออก</div>
                    <div class="step-description">เลือกคอลัมน์ที่ต้องการส่งออก</div>
                </div>
            </div>
        </div>
        
       <!-- แทนที่เนื้อหาใน panel1 (ในส่วนของ <div class="step-content">) -->
<div class="step-panel active" id="panel1">
    <div class="panel-header">
        <h2><i class="fas fa-file-upload"></i> อัปโหลดไฟล์ CSV</h2>
        <p>อัปโหลดไฟล์ข้อมูลอ้อยของคุณในรูปแบบ CSV (สูงสุด 500MB)</p>
    </div>
    
    <div class="upload-area" id="uploadArea">
        <i class="fas fa-file-csv"></i>
        <h3>ลากไฟล์ CSV ของคุณมาวางที่นี่</h3>
        <p>หรือคลิกเพื่อเลือกไฟล์จากคอมพิวเตอร์ของคุณ</p>
        <p><strong>รองรับไฟล์ขนาดใหญ่ถึง 500MB</strong></p>
        <input type="file" id="csvFileInput" class="file-input" accept=".csv" style="display: none;">
        <button class="btn btn-primary" id="browseBtn">
            <i class="fas fa-folder-open"></i> เลือกไฟล์ CSV
        </button>
    </div>
    
    <div class="file-info" id="fileInfo">
        <h4><i class="fas fa-info-circle"></i> ข้อมูลไฟล์</h4>
        <div class="info-grid">
            <div class="info-item">
                <strong>ชื่อไฟล์:</strong>
                <span id="fileName">-</span>
            </div>
            <div class="info-item">
                <strong>ขนาดไฟล์:</strong>
                <span id="fileSize">-</span>
            </div>
            <div class="info-item">
                <strong>จำนวนแถว:</strong>
                <span id="fileRows">-</span>
            </div>
            <div class="info-item">
                <strong>จำนวนคอลัมน์:</strong>
                <span id="fileCols">-</span>
            </div>
        </div>
    </div>
    
    <div id="loadingSpinner" class="spinner" style="display: none;"></div>
    
    <div class="navigation-buttons">
        <div></div>
        <button class="btn btn-success" id="nextToStep2" disabled>
            ต่อไป <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

<!-- แทนที่เนื้อหาใน panel2 -->
<div class="step-panel" id="panel2">
    <div class="panel-header">
        <h2><i class="fas fa-filter"></i> กรองข้อมูลทั้งหมด</h2>
        <p>ทำความสะอาดข้อมูลด้วย 11 ขั้นตอนการกรองแบบอัตโนมัติ</p>
    </div>
    
    <div class="filtering-section">
        <!-- ปุ่มกรองข้อมูลทั้งหมด -->
        <div class="filter-process-section">
            <button class="btn btn-success process-btn" id="processAllBtn" disabled>
                <i class="fas fa-filter"></i> เริ่มกรองข้อมูลทั้งหมด (11 ขั้นตอน)
            </button>
            <div id="processSpinner" class="spinner"></div>
        </div>
        
        <!-- ผลการกรอง -->
        <div class="filter-results-section" id="filterResultsSection">
            <!-- แสดงสถานะคอลัมน์ที่พบ -->
            <div id="columnsStatus" style="margin-bottom: 25px;"></div>
            
            <!-- ขั้นตอนการกรอง -->
            <div class="process-steps" id="processSteps">
                <!-- ขั้นตอนการกรองจะถูกสร้างโดย JavaScript -->
            </div>
            
            <!-- สรุปผล -->
            <div class="final-summary">
                <h3><i class="fas fa-clipboard-check"></i> สรุปผลการกรองทั้งหมด</h3>
                <div class="summary-grid" id="finalSummary">
                    <div class="summary-item">
                        <div class="summary-value" id="totalRowsBefore">0</div>
                        <div class="summary-label">แถวทั้งหมดก่อนกรอง</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="totalRowsAfter">0</div>
                        <div class="summary-label">แถวที่เหลือหลังกรอง</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="totalRemoved">0</div>
                        <div class="summary-label">แถวที่ถูกตัดออก</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="removedPercentage">0%</div>
                        <div class="summary-label">เปอร์เซ็นต์ที่ถูกตัด</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="navigation-buttons">
        <button class="btn btn-outline" id="backToStep1">
            <i class="fas fa-arrow-left"></i> ย้อนกลับ
        </button>
        <button class="btn btn-success" id="nextToStep3" disabled>
            ต่อไป <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>
           <!-- แทนที่เนื้อหาใน panel3 -->
<div class="step-panel" id="panel3">
    <div class="panel-header">
        <h2><i class="fas fa-columns"></i> เลือกคอลัมน์ที่ต้องการตรวจสอบ</h2>
        <p>ค้นหาและเลือกคอลัมน์ที่ต้องการตรวจสอบจากทั้งหมด <span id="totalColumns">0</span> คอลัมน์</p>
    </div>
    
    <div class="column-selection-panel">
        <div class="selection-header">
            <div class="search-container">
                <input type="text" id="columnSearch" class="search-box" placeholder="ค้นหาคอลัมน์...">
            </div>
            <div class="search-stats">
                <span>พบ <span id="filteredCount">0</span> คอลัมน์</span>
                <span>เลือกแล้ว <span id="selectedCount">0</span> คอลัมน์</span>
            </div>
        </div>
        
        <div class="selection-controls">
            <button class="selection-btn active" data-filter="all">ทั้งหมด</button>
            <button class="selection-btn" data-filter="sugarcane">ข้อมูลอ้อย</button>
            <button class="selection-btn" data-filter="activity">กิจกรรมงวด</button>
            <button class="selection-btn" data-filter="project">โครงการ</button>
            <button class="selection-btn" data-filter="fertilizer">ปุ๋ย</button>
            <button class="selection-btn" data-filter="selected">ที่เลือกแล้ว</button>
            <button class="selection-btn" data-filter="unselected">ยังไม่เลือก</button>
        </div>
        
        <div class="columns-grid" id="columnsGrid">
            <!-- Column items will be populated here -->
        </div>
        
        <div class="selected-summary">
            <div>
                <h4><i class="fas fa-check-circle"></i> คุณเลือกคอลัมน์แล้ว <span id="selectedSummaryCount">0</span> คอลัมน์</h4>
                <p id="selectedColumnsList" style="font-size: 0.9rem; color: #666; margin-top: 5px;">ยังไม่ได้เลือกคอลัมน์</p>
            </div>
            <div>
                <button class="btn btn-outline" id="selectAllBtn">
                    <i class="fas fa-check-double"></i> เลือกทั้งหมด
                </button>
                <button class="btn btn-outline" id="deselectAllBtn">
                    <i class="fas fa-times"></i> ยกเลิกทั้งหมด
                </button>
            </div>
        </div>
    </div>
    
    <div class="navigation-buttons">
        <button class="btn btn-outline" id="backToStep2From3">
            <i class="fas fa-arrow-left"></i> ย้อนกลับ
        </button>
        <button class="btn btn-success" id="nextToStep4" disabled>
            ต่อไป <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>
            
          <!-- แทนที่เนื้อหาใน panel4 -->
<div class="step-panel" id="panel4">
    <div class="panel-header">
        <h2><i class="fas fa-search"></i> ตรวจสอบและแก้ไขข้อมูล</h2>
        <p>AI ช่วยตรวจสอบข้อมูลและแสดงผลลัพธ์ คลิกที่เซลล์สีแดงเพื่อแก้ไขได้ทันที</p>
    </div>
    
    <!-- Dashboard Summary -->
    <div class="dashboard-summary" id="dashboardSummary">
        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="summary-content">
                    <h4>ข้อมูลถูกต้อง</h4>
                    <div class="summary-value" id="correctDataPercent">0%</div>
                    <div class="summary-progress">
                        <div class="progress-bar">
                            <div class="progress-fill success" id="correctDataBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon warning">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="summary-content">
                    <h4>ต้องตรวจสอบ</h4>
                    <div class="summary-value" id="needReviewCount">0</div>
                    <button class="btn btn-sm btn-outline" id="showReviewBtn" style="margin-top: 5px; display: none;">
                        <i class="fas fa-eye"></i> แสดง
                    </button>
                    <div class="summary-progress">
                        <div class="progress-bar">
                            <div class="progress-fill warning" id="needReviewBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon error">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="summary-content">
                    <h4>ข้อผิดพลาด</h4>
                    <div class="summary-value" id="errorDataCount">0</div>
                    <div class="progress-bar">
                        <div class="progress-fill error" id="errorDataBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon info">
                    <i class="fas fa-edit"></i>
                </div>
                <div class="summary-content">
                    <h4>แก้ไขแล้ว</h4>
                    <div class="summary-value" id="editedCellsCount">0</div>
                    <div class="progress-bar">
                        <div class="progress-fill info" id="editedCellsBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="summary-actions">
            <button class="btn btn-primary btn-sm" id="refreshDashboard">
                <i class="fas fa-sync-alt"></i> อัพเดต Dashboard
            </button>
            <button class="btn btn-success btn-sm" id="fixAllErrors">
                <i class="fas fa-robot"></i> AI แก้ไขข้อผิดพลาดทั้งหมด
            </button>
        </div>
    </div>
    
    <!-- Data Type Configuration -->
    <div class="data-type-configuration" id="dataTypeConfig">
        <h3><i class="fas fa-cogs"></i> กำหนดประเภทข้อมูลให้แต่ละคอลัมน์</h3>
        <div class="config-controls">
            <button class="btn btn-outline btn-sm" id="autoDetectTypes">
                <i class="fas fa-robot"></i> ตรวจจับประเภทอัตโนมัติ
            </button>
            <button class="btn btn-success btn-sm" id="applyDataTypes">
                <i class="fas fa-check"></i> ใช้การตั้งค่านี้
            </button>
        </div>
        <div class="data-type-table-container">
            <table class="data-type-table" id="dataTypeTable">
                <thead>
                    <tr>
                        <th>คอลัมน์</th>
                        <th>ตัวอย่างข้อมูล</th>
                        <th>ประเภทข้อมูล</th>
                        <th>รูปแบบ</th>
                        <th>หน่วย</th>
                        <th>คำอธิบาย</th>
                    </tr>
                </thead>
                <tbody id="dataTypeTableBody">
                    <!-- จะถูกเพิ่มโดย JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Data Preview Table -->
    <div class="data-table-controls">
        <div class="table-info">
            <span><i class="fas fa-table"></i> แสดง <span id="currentRows">0</span>/<span id="totalRows">0</span> แถว</span>
            <span><i class="fas fa-columns"></i> <span id="currentColumns">0</span> คอลัมน์</span>
            <span id="dataStatus"></span>
        </div>
        
        <div class="table-actions">
            <button class="btn btn-outline btn-sm" id="toggleAllRows">
                <i class="fas fa-expand"></i> แสดงทั้งหมด (<span id="totalRowCount">0</span>)
            </button>
            <button class="btn btn-outline btn-sm" id="exportTable">
                <i class="fas fa-download"></i> ส่งออกตาราง
            </button>
            <button class="btn btn-outline btn-sm" id="showDataTypeConfig">
                <i class="fas fa-cog"></i> กำหนดประเภทข้อมูล
            </button>
        </div>
    </div>
    
    <div class="data-table-container">
        <table class="data-table" id="dataPreviewTable">
            <thead id="dataTableHeader">
                <!-- Headers will be populated by JavaScript -->
            </thead>
            <tbody id="dataTableBody">
                <!-- Rows will be populated by JavaScript -->
            </tbody>
        </table>
    </div>
    
    <!-- Cell Editor Modal -->
    <div class="cell-editor-modal" id="cellEditorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h4><i class="fas fa-edit"></i> แก้ไขข้อมูลเซลล์</h4>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="cell-info">
                    <p><strong>คอลัมน์:</strong> <span id="editColumnName">-</span></p>
                    <p><strong>แถวที่:</strong> <span id="editRowNumber">-</span></p>
                    <p><strong>ประเภทข้อมูล:</strong> 
                        <select id="editDataTypeSelect" class="form-control" style="width: auto; display: inline-block; margin-left: 10px;">
                            <option value="text">ข้อความ</option>
                            <option value="number">ตัวเลข</option>
                            <option value="date">วันที่</option>
                            <option value="enum">ค่าที่กำหนด</option>
                            <option value="identifier">รหัส</option>
                        </select>
                    </p>
                    <p><strong>ปัญหาที่พบ:</strong> <span id="editIssue" class="error-text">-</span></p>
                </div>
                
                <div class="form-group">
                    <label for="cellValueInput">ค่าใหม่:</label>
                    <input type="text" id="cellValueInput" class="form-control" placeholder="ป้อนค่าใหม่...">
                    <div class="suggestions" id="valueSuggestions">
                        <!-- Suggestions will be added here -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="correctionReason">เหตุผลในการแก้ไข:</label>
                    <select id="correctionReason" class="form-control">
                        <option value="">เลือกเหตุผล</option>
                        <option value="format_error">รูปแบบไม่ถูกต้อง</option>
                        <option value="invalid_value">ค่าที่ใช้ไม่ได้</option>
                        <option value="out_of_range">ไม่อยู่ในช่วงที่กำหนด</option>
                        <option value="typo_error">พิมพ์ผิด</option>
                        <option value="other">อื่นๆ</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelEdit">ยกเลิก</button>
                <button class="btn btn-success" id="saveEdit">บันทึกการแก้ไข</button>
            </div>
        </div>
    </div>
    
    <div class="navigation-buttons">
        <button class="btn btn-outline" id="backToStep3">
            <i class="fas fa-arrow-left"></i> ย้อนกลับ
        </button>
        <button class="btn btn-success" id="nextToStep5" disabled>
            <i class="fas fa-arrow-right"></i> ดำเนินการต่อ
        </button>
    </div>
</div>
            
            <!-- Step 5: Condition Checking -->
            <div class="step-panel" id="panel5">
                <!-- Step 5 Content จะเพิ่มที่นี่ -->
            </div>
            
            <!-- Step 6: Export Selection -->
            <div class="step-panel" id="panel6">
                <!-- Step 6 Content จะเพิ่มที่นี่ -->
            </div>
        </div>
        
        <footer>
            <p>© 2024 ระบบ Clean Data สำหรับข้อมูลอ้อย - แบบขั้นตอนการใช้งาน 6 ขั้นตอน</p>
        </footer>
    </div>

    <script>
        // JavaScript Code จะอยู่ที่นี่
        // เริ่มต้นตัวแปรหลัก
        let uploadedData = null;
        let filteredData = null;
        let allStepsResults = {};
        let selectedColumns = [];
        let allColumns = [];
        let currentStep = 1;
        
        // อ้างอิงองค์ประกอบ DOM
        const steps = document.querySelectorAll('.step');
        const panels = document.querySelectorAll('.step-panel');
        
        // ฟังก์ชันเปลี่ยนขั้นตอน
        function goToStep(stepNumber) {
            currentStep = stepNumber;
            
            // อัพเดต navigation steps
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
           // ============================================
// ขั้นตอนที่ 1: อัปโหลดไฟล์ CSV
// ============================================

// อ้างอิงองค์ประกอบสำหรับ Step 1
const csvFileInput = document.getElementById('csvFileInput');
const uploadArea = document.getElementById('uploadArea');
const browseBtn = document.getElementById('browseBtn');
const fileInfo = document.getElementById('fileInfo');
const fileName = document.getElementById('fileName');
const fileSize = document.getElementById('fileSize');
const fileRows = document.getElementById('fileRows');
const fileCols = document.getElementById('fileCols');
const loadingSpinner = document.getElementById('loadingSpinner');
const nextToStep2 = document.getElementById('nextToStep2');

// อ้างอิงองค์ประกอบสำหรับ Step 2
const processAllBtn = document.getElementById('processAllBtn');
const processSpinner = document.getElementById('processSpinner');
const filterResultsSection = document.getElementById('filterResultsSection');
const processSteps = document.getElementById('processSteps');
const columnsStatus = document.getElementById('columnsStatus');
const nextToStep3 = document.getElementById('nextToStep3');
const backToStep1 = document.getElementById('backToStep1');

// สรุปผลสำหรับ Step 2
const totalRowsBefore = document.getElementById('totalRowsBefore');
const totalRowsAfter = document.getElementById('totalRowsAfter');
const totalRemoved = document.getElementById('totalRemoved');
const removedPercentage = document.getElementById('removedPercentage');

// Event Listeners สำหรับ Step 1
uploadArea.addEventListener('click', () => csvFileInput.click());
browseBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    csvFileInput.click();
});

// Drag and drop
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = 'var(--primary-color)';
    uploadArea.style.backgroundColor = 'rgba(76, 201, 240, 0.15)';
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.style.borderColor = 'var(--accent-color)';
    uploadArea.style.backgroundColor = 'rgba(76, 201, 240, 0.05)';
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = 'var(--accent-color)';
    uploadArea.style.backgroundColor = 'rgba(76, 201, 240, 0.05)';
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

csvFileInput.addEventListener('change', function(e) {
    if (this.files.length === 0) return;
    handleFile(this.files[0]);
});

function handleFile(file) {
    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('กรุณาเลือกไฟล์ CSV เท่านั้น');
        return;
    }
    
    const maxSize = 500 * 1024 * 1024;
    if (file.size > maxSize) {
        alert('ไฟล์มีขนาดใหญ่เกินไป กรุณาเลือกไฟล์ขนาดไม่เกิน 500MB');
        return;
    }
    
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    
    loadingSpinner.style.display = 'block';
    
    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            const csvText = event.target.result;
            processCSVData(csvText, file.name);
        } catch (error) {
            alert('เกิดข้อผิดพลาดในการอ่านไฟล์: ' + error.message);
            loadingSpinner.style.display = 'none';
        }
    };
    
    reader.onerror = function() {
        alert('เกิดข้อผิดพลาดในการอ่านไฟล์');
        loadingSpinner.style.display = 'none';
    };
    
    reader.readAsText(file, 'UTF-8');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function processCSVData(csvText, fileName) {
    try {
        const lines = csvText.split('\n');
        if (lines.length === 0) {
            throw new Error('ไฟล์ว่างเปล่า');
        }
        
        const headers = parseCSVLine(lines[0]);
        
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim() === '') continue;
            
            const values = parseCSVLine(lines[i]);
            const row = {};
            
            headers.forEach((header, index) => {
                row[header] = values[index] ? values[index].trim() : '';
            });
            
            data.push(row);
        }
        
        uploadedData = {
            headers: headers,
            data: data,
            fileName: fileName,
            totalRows: data.length,
            totalCols: headers.length,
            originalCSV: csvText
        };
        
        filteredData = [...data];
        
        fileRows.textContent = data.length.toLocaleString();
        fileCols.textContent = headers.length;
        fileInfo.classList.add('show');
        loadingSpinner.style.display = 'none';
        
        // เปิดใช้งานปุ่มต่อไป
        nextToStep2.disabled = false;
        processAllBtn.disabled = false;
        
        // แสดงสถานะคอลัมน์สำหรับการกรอง
        showColumnsStatus();
        
        console.log('โหลดข้อมูลสำเร็จ:', uploadedData);
    } catch (error) {
        alert('รูปแบบไฟล์ CSV ไม่ถูกต้อง: ' + error.message);
        loadingSpinner.style.display = 'none';
    }
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            if (i + 1 < line.length && line[i + 1] === '"') {
                current += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    
    result.push(current);
    return result;
}

// ============================================
// ขั้นตอนที่ 2: กรองข้อมูลทั้งหมด
// ============================================

// Event Listeners สำหรับ Step 2
nextToStep2.addEventListener('click', () => {
    if (!uploadedData) {
        alert('กรุณาอัปโหลดไฟล์ก่อน');
        return;
    }
    goToStep(2);
});

backToStep1.addEventListener('click', () => {
    goToStep(1);
});

processAllBtn.addEventListener('click', processAllFilters);

nextToStep3.addEventListener('click', () => {
    if (!filteredData || filteredData.length === 0) {
        alert('กรุณากรองข้อมูลก่อนดำเนินการต่อ');
        return;
    }
    goToStep(3);
});

// แสดงสถานะคอลัมน์ที่พบสำหรับการกรอง
function showColumnsStatus() {
    const columns = [
        { name: "เลขโควต้า", found: false },
        { name: "ชื่อประเภทอ้อย", found: false },
        { name: "ประเภทแปลง", found: false },
        { name: "โซน", found: false },
        { name: "สาเหตุเสียหาย", found: false },
        { name: "พื้นที่เสียหาย", found: false },
        { name: "รหัสนักเกษตร", found: false },
        { name: "พื้นที่", found: false },
        { name: "เลขแปลงintech", found: false }
    ];
    
    let foundCount = 0;
    columns.forEach(col => {
        col.found = findColumnExact(col.name) !== null;
        if (col.found) foundCount++;
    });
    
    let statusClass = "status-error";
    let statusIcon = "exclamation-triangle";
    let statusTitle = "ไม่พบคอลัมน์บางส่วน";
    
    if (foundCount === columns.length) {
        statusClass = "status-success";
        statusIcon = "check-circle";
        statusTitle = "พบคอลัมน์ทั้งหมด";
    } else if (foundCount > 0) {
        statusClass = "status-warning";
        statusIcon = "exclamation-circle";
        statusTitle = "พบคอลัมน์บางส่วน";
    }
    
    let columnsListHTML = '';
    columns.forEach(col => {
        columnsListHTML += `
            <div class="condition-item">
                <i class="fas fa-${col.found ? 'check text-success' : 'times text-danger'}"></i>
                ${col.name} ${col.found ? '<span class="text-success">(พบ)</span>' : '<span class="text-danger">(ไม่พบ)</span>'}
            </div>
        `;
    });
    
    columnsStatus.innerHTML = `
        <div class="column-status ${statusClass}">
            <h5><i class="fas fa-${statusIcon}"></i> ${statusTitle}</h5>
            <p>พบ ${foundCount} จาก ${columns.length} คอลัมน์ที่ต้องการ</p>
            <div class="conditions-list">
                ${columnsListHTML}
            </div>
            ${foundCount < columns.length ? 
                '<p class="mt-2"><small>ระบบยังสามารถทำงานได้ แต่ขั้นตอนที่เกี่ยวข้องกับคอลัมน์ที่ไม่พบจะถูกข้ามไป</small></p>' : 
                ''}
        </div>
    `;
}

// ฟังก์ชันค้นหาคอลัมน์
function findColumnExact(columnName) {
    if (!uploadedData || !uploadedData.headers) return null;
    
    for (const header of uploadedData.headers) {
        if (header.trim() === columnName) {
            return header;
        }
    }
    
    return null;
}

function isAllNumbers(value) {
    if (!value || value.trim() === '') return false;
    
    const cleanedValue = value.trim();
    
    if (!isNaN(cleanedValue) && !isNaN(parseFloat(cleanedValue))) {
        const regex = /^[-+]?\d*\.?\d+$/;
        return regex.test(cleanedValue);
    }
    
    return false;
}

function formatToTwoDecimals(value) {
    if (value === null || value === undefined || value === '') {
        return '';
    }
    
    const num = parseFloat(value);
    
    if (isNaN(num)) {
        return value;
    }
    
    return num.toFixed(2);
}

function convertScientificNotation(value) {
    if (!value || value.trim() === '') return value;
    
    const strValue = value.toString().trim();
    
    const scientificNotationRegex = /^[-+]?[0-9]*\.?[0-9]+[eE][-+]?[0-9]+$/;
    
    if (scientificNotationRegex.test(strValue)) {
        try {
            const num = parseFloat(strValue);
            
            if (!isNaN(num)) {
                return num.toLocaleString('fullwide', { useGrouping: false });
            }
        } catch (e) {
            console.warn('ไม่สามารถแปลงสัญกรณ์ทางวิทยาศาสตร์:', strValue, e);
        }
    }
    
    return strValue;
}

function convertToText(value) {
    if (value === null || value === undefined || value === '') {
        return '';
    }
    
    const strValue = value.toString().trim();
    
    if (isAllNumbers(strValue)) {
        return "'" + strValue;
    }
    
    return strValue;
}

// CSS สำหรับ column status (เพิ่มในส่วน style)
const columnStatusCSS = `
    .column-status {
        margin-top: 15px;
        padding: 15px;
        border-radius: 8px;
    }
    
    .status-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .conditions-list {
        background-color: white;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        border: 1px solid #dee2e6;
    }
    
    .condition-item {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    
    .condition-item:last-child {
        border-bottom: none;
    }
    
    .text-success {
        color: #28a745 !important;
    }
    
    .text-danger {
        color: #dc3545 !important;
    }
    
    .mt-2 {
        margin-top: 10px;
    }
`;

// เพิ่ม CSS ใน head
const styleSheet = document.createElement('style');
styleSheet.textContent = columnStatusCSS;
document.head.appendChild(styleSheet); 
            // ============================================
// ฟังก์ชันกรองข้อมูลทั้งหมด (11 ขั้นตอน)
// ============================================

async function processAllFilters() {
    if (!uploadedData || !filteredData) return;
    
    processSpinner.style.display = 'block';
    processAllBtn.disabled = true;
    nextToStep3.disabled = true;
    
    // รีเซ็ตผลลัพธ์
    allStepsResults = {};
    
    // กำหนดลำดับขั้นตอนการกรอง
    const steps = [
        { 
            id: 1, 
            title: "กรองเลขโควต้า", 
            description: "ตัดแถวที่มีค่า '59008956' หรือ '40000542' ในคอลัมน์ 'เลขโควต้า'",
            icon: "filter",
            color: "danger"
        },
        { 
            id: 2, 
            title: "กรองชื่อประเภทอ้อย", 
            description: "ตัดแถวที่มีค่า 'พื้นที่เสียหาย' ในคอลัมน์ 'ชื่อประเภทอ้อย'",
            icon: "filter",
            color: "info"
        },
        { 
            id: 3, 
            title: "กรองประเภทแปลง", 
            description: "ตัดแถวที่มีค่า 'แปลงดัมมี่' ในคอลัมน์ 'ประเภทแปลง'",
            icon: "filter",
            color: "purple"
        },
        { 
            id: 4, 
            title: "แก้ไขโซน", 
            description: "แก้ไข 'C1/1' → 'C1' และ 'C4/1' → 'C4' ในคอลัมน์ 'โซน'",
            icon: "edit",
            color: "teal"
        },
        { 
            id: 5, 
            title: "กรองสาเหตุเสียหาย", 
            description: "ล้างข้อมูลในคอลัมน์ 'พื้นที่เสียหาย' และ 'สาเหตุเสียหาย' เมื่อมีค่า '-', ตัวเลขทั้งหมด, หรือค่าว่าง",
            icon: "filter",
            color: "blue"
        },
        { 
            id: 6, 
            title: "แก้ไขรหัสนักเกษตร", 
            description: "แก้ไข '2' → '002', '3' → '003', '4' → '004', '8' → '008', '9' → '009' ในคอลัมน์ 'รหัสนักเกษตร'",
            icon: "id-card",
            color: "warning"
        },
        { 
            id: 7, 
            title: "แปลงพื้นที่เสียหาย", 
            description: "เรียงข้อมูลจาก Z-A และแปลงเป็นตัวเลขทศนิยม 2 ตำแหน่งในคอลัมน์ 'พื้นที่เสียหาย'",
            icon: "sort-amount-down",
            color: "teal"
        },
        { 
            id: 8, 
            title: "แปลงและคำนวณพื้นที่", 
            description: "แปลงเป็นทศนิยม 2 ตำแหน่ง, คำนวณ พื้นที่ - พื้นที่เสียหาย, ตัดแถวที่พื้นที่ ≤ 0",
            icon: "calculator",
            color: "teal"
        },
        { 
            id: 9, 
            title: "กรองเลขแปลงintech", 
            description: "ตัดแถวที่มีค่า '' หรือช่องว่างในคอลัมน์ 'เลขแปลงintech'",
            icon: "filter",
            color: "orange"
        },
        { 
            id: 10, 
            title: "แปลงสัญกรณ์วิทยาศาสตร์", 
            description: "แปลงสัญกรณ์วิทยาศาสตร์ในคอลัมน์ 'เลขแปลงintech' เป็นตัวเลขเต็ม",
            icon: "calculator",
            color: "blue"
        },
        { 
            id: 11, 
            title: "เพิ่ม ' หน้าข้อมูล", 
            description: "เพิ่มเครื่องหมาย ' หน้าข้อมูลในคอลัมน์ 'รหัสนักเกษตร' เพื่อป้องกันไม่ให้ Excel ตัดเลขนำหน้า 0",
            icon: "text-height",
            color: "info"
        }
    ];
    
    // สร้างโครงสร้างขั้นตอนใน UI
    processSteps.innerHTML = '';
    steps.forEach(step => {
        const stepCard = document.createElement('div');
        stepCard.className = 'step-card';
        stepCard.id = `step-${step.id}`;
        stepCard.innerHTML = `
            <div class="step-header">
                <div class="step-icon">${step.id}</div>
                <div>
                    <div class="step-title">${step.title}</div>
                    <div class="step-description">${step.description}</div>
                </div>
            </div>
            <div class="step-results">
                <div id="step-${step.id}-status" style="text-align: center; padding: 10px;">
                    <i class="fas fa-spinner fa-spin"></i> กำลังประมวลผล...
                </div>
                <div class="results-grid" id="step-${step.id}-results" style="display: none;"></div>
            </div>
        `;
        processSteps.appendChild(stepCard);
    });
    
    // แสดงผลลัพธ์
    filterResultsSection.classList.add('show');
    
    // ดำเนินการกรองทีละขั้นตอน
    for (let i = 0; i < steps.length; i++) {
        const step = steps[i];
        const stepCard = document.getElementById(`step-${step.id}`);
        const stepStatus = document.getElementById(`step-${step.id}-status`);
        const stepResults = document.getElementById(`step-${step.id}-results`);
        
        // เรียกฟังก์ชันกรองตามขั้นตอน
        let stepResult = {};
        try {
            switch(step.id) {
                case 1:
                    stepResult = await filterQuotaData();
                    break;
                case 2:
                    stepResult = await filterSugarcaneTypeData();
                    break;
                case 3:
                    stepResult = await filterSugarcaneCategoryData();
                    break;
                case 4:
                    stepResult = await filterZoneData();
                    break;
                case 5:
                    stepResult = await filterDamageCauseData();
                    break;
                case 6:
                    stepResult = await filterFarmerCodeData();
                    break;
                case 7:
                    stepResult = await processDamageAreaData();
                    break;
                case 8:
                    stepResult = await processAreaData();
                    break;
                case 9:
                    stepResult = await filterIntechPlotData();
                    break;
                case 10:
                    stepResult = await formatScientificNotation();
                    break;
                case 11:
                    stepResult = await addQuotationPrefix();
                    break;
            }
        } catch (error) {
            stepResult = { 
                success: false, 
                message: "เกิดข้อผิดพลาด: " + error.message,
                stats: {}
            };
        }
        
        // อัปเดต UI
        allStepsResults[step.id] = stepResult;
        
        if (stepResult.success) {
            stepCard.classList.add('success');
            stepStatus.innerHTML = `<i class="fas fa-check-circle text-success"></i> ดำเนินการสำเร็จ`;
            stepStatus.style.color = "var(--success-color)";
            
            // แสดงผลลัพธ์
            let resultsHTML = '';
            if (stepResult.stats) {
                Object.keys(stepResult.stats).forEach(key => {
                    resultsHTML += `
                        <div class="result-item">
                            <div class="result-value">${stepResult.stats[key]}</div>
                            <div class="result-label">${key}</div>
                        </div>
                    `;
                });
            }
            
            stepResults.innerHTML = resultsHTML;
            stepResults.style.display = 'grid';
            
        } else {
            stepCard.classList.add(stepResult.skipped ? 'warning' : 'error');
            stepStatus.innerHTML = stepResult.skipped ? 
                `<i class="fas fa-exclamation-triangle text-warning"></i> ข้ามขั้นตอน: ${stepResult.message}` :
                `<i class="fas fa-times-circle text-danger"></i> ล้มเหลว: ${stepResult.message}`;
            stepStatus.style.color = stepResult.skipped ? "var(--warning-color)" : "var(--danger-color)";
        }
        
        // รอเล็กน้อยระหว่างขั้นตอนเพื่อให้เห็นการเปลี่ยนแปลง
        await delay(300);
    }
    
    // อัปเดตสรุปผลรวม
    updateFinalSummary();
    
    processSpinner.style.display = 'none';
    processAllBtn.disabled = false;
    nextToStep3.disabled = false;
    
    // เลื่อนไปที่ผลลัพธ์
    filterResultsSection.scrollIntoView({ behavior: 'smooth' });
}

function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// ============================================
// ฟังก์ชันกรองข้อมูลแต่ละขั้นตอน
// ============================================

async function filterQuotaData() {
    const columnName = findColumnExact("เลขโควต้า");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'เลขโควต้า'",
            stats: {}
        };
    }
    
    const newFilteredData = [];
    const removedRows = [];
    let removed59008956 = 0;
    let removed40000542 = 0;
    
    filteredData.forEach((row, index) => {
        const value = row[columnName] ? row[columnName].toString().trim() : '';
        let shouldRemove = false;
        
        if (value === '59008956') {
            shouldRemove = true;
            removed59008956++;
        }
        else if (value === '40000542') {
            shouldRemove = true;
            removed40000542++;
        }
        
        if (shouldRemove) {
            removedRows.push({
                index: index + 2,
                value: value
            });
        } else {
            newFilteredData.push(row);
        }
    });
    
    filteredData = newFilteredData;
    
    return {
        success: true,
        removedCount: removedRows.length,
        stats: {
            "ตัดออก": removedRows.length.toLocaleString(),
            "59008956": removed59008956.toLocaleString(),
            "40000542": removed40000542.toLocaleString(),
            "เหลือ": filteredData.length.toLocaleString()
        }
    };
}

async function filterSugarcaneTypeData() {
    const columnName = findColumnExact("ชื่อประเภทอ้อย");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'ชื่อประเภทอ้อย'",
            stats: {}
        };
    }
    
    const newFilteredData = [];
    const removedRows = [];
    let removedCount = 0;
    
    filteredData.forEach((row, index) => {
        const value = row[columnName] ? row[columnName].toString().trim() : '';
        let shouldRemove = false;
        
        if (value === "พื้นที่เสียหาย") {
            shouldRemove = true;
            removedCount++;
        }
        
        if (shouldRemove) {
            removedRows.push({
                index: index + 2,
                value: value
            });
        } else {
            newFilteredData.push(row);
        }
    });
    
    filteredData = newFilteredData;
    
    return {
        success: true,
        removedCount: removedRows.length,
        stats: {
            "ตัดออก": removedRows.length.toLocaleString(),
            "พื้นที่เสียหาย": removedCount.toLocaleString(),
            "เหลือ": filteredData.length.toLocaleString()
        }
    };
}

async function filterSugarcaneCategoryData() {
    const columnName = findColumnExact("ประเภทแปลง");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'ประเภทแปลง'",
            stats: {}
        };
    }
    
    const newFilteredData = [];
    const removedRows = [];
    let removedCount = 0;
    
    filteredData.forEach((row, index) => {
        const value = row[columnName] ? row[columnName].toString().trim() : '';
        let shouldRemove = false;
        
        if (value === "แปลงดัมมี่") {
            shouldRemove = true;
            removedCount++;
        }
        
        if (shouldRemove) {
            removedRows.push({
                index: index + 2,
                value: value
            });
        } else {
            newFilteredData.push(row);
        }
    });
    
    filteredData = newFilteredData;
    
    return {
        success: true,
        removedCount: removedRows.length,
        stats: {
            "ตัดออก": removedRows.length.toLocaleString(),
            "แปลงดัมมี่": removedCount.toLocaleString(),
            "เหลือ": filteredData.length.toLocaleString()
        }
    };
}

async function filterZoneData() {
    const columnName = findColumnExact("โซน");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'โซน'",
            stats: {}
        };
    }
    
    const modifiedData = [];
    const modifiedRows = [];
    let modifiedC1 = 0;
    let modifiedC4 = 0;
    
    filteredData.forEach((row, index) => {
        const modifiedRow = {...row};
        const value = row[columnName] ? row[columnName].toString().trim() : '';
        let isModified = false;
        let newValue = value;
        
        if (value === "C1/1") {
            newValue = "C1";
            isModified = true;
            modifiedC1++;
        } else if (value === "C4/1") {
            newValue = "C4";
            isModified = true;
            modifiedC4++;
        }
        
        modifiedRow[columnName] = newValue;
        
        if (isModified) {
            modifiedRows.push({
                index: index + 2,
                originalValue: value,
                newValue: newValue
            });
        }
        
        modifiedData.push(modifiedRow);
    });
    
    filteredData = modifiedData;
    
    return {
        success: true,
        modifiedCount: modifiedRows.length,
        stats: {
            "แก้ไข": modifiedRows.length.toLocaleString(),
            "C1/1→C1": modifiedC1.toLocaleString(),
            "C4/1→C4": modifiedC4.toLocaleString(),
            "แถวทั้งหมด": filteredData.length.toLocaleString()
        }
    };
}

async function filterDamageCauseData() {
    const damageCauseColumn = findColumnExact("สาเหตุเสียหาย");
    const damageAreaColumn = findColumnExact("พื้นที่เสียหาย");
    
    if (!damageCauseColumn || !damageAreaColumn) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'สาเหตุเสียหาย' หรือ 'พื้นที่เสียหาย'",
            stats: {}
        };
    }
    
    const modifiedData = [];
    const clearedRows = [];
    let clearedDash = 0;
    let clearedNumber = 0;
    let clearedEmpty = 0;
    
    filteredData.forEach((row, index) => {
        const modifiedRow = {...row};
        const damageCauseValue = row[damageCauseColumn] ? row[damageCauseColumn].toString().trim() : '';
        const damageAreaValue = row[damageAreaColumn] ? row[damageAreaColumn].toString().trim() : '';
        let shouldClear = false;
        
        if (damageCauseValue === "-") {
            shouldClear = true;
            clearedDash++;
        } else if (isAllNumbers(damageCauseValue)) {
            shouldClear = true;
            clearedNumber++;
        } else if (damageCauseValue === "") {
            shouldClear = true;
            clearedEmpty++;
        }
        
        if (shouldClear) {
            modifiedRow[damageCauseColumn] = "";
            modifiedRow[damageAreaColumn] = "";
            
            clearedRows.push({
                index: index + 2,
                damageCauseOriginal: damageCauseValue,
                damageAreaOriginal: damageAreaValue
            });
        }
        
        modifiedData.push(modifiedRow);
    });
    
    filteredData = modifiedData;
    
    return {
        success: true,
        clearedCount: clearedRows.length,
        stats: {
            "ล้างข้อมูล": clearedRows.length.toLocaleString(),
            "ค่า '-':": clearedDash.toLocaleString(),
            "ตัวเลขทั้งหมด": clearedNumber.toLocaleString(),
            "ค่าว่าง": clearedEmpty.toLocaleString(),
            "แถวทั้งหมด": filteredData.length.toLocaleString()
        }
    };
}

async function filterFarmerCodeData() {
    const columnName = findColumnExact("รหัสนักเกษตร");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'รหัสนักเกษตร'",
            stats: {}
        };
    }
    
    const modifiedData = [];
    const modifiedRows = [];
    let modified2 = 0;
    let modified3 = 0;
    let modified4 = 0;
    let modified8 = 0;
    let modified9 = 0;
    
    filteredData.forEach((row, index) => {
        const modifiedRow = {...row};
        const value = row[columnName] ? row[columnName].toString().trim() : '';
        let isModified = false;
        let newValue = value;
        
        if (value === "2") {
            newValue = "002";
            isModified = true;
            modified2++;
        } else if (value === "3") {
            newValue = "003";
            isModified = true;
            modified3++;
        } else if (value === "4") {
            newValue = "004";
            isModified = true;
            modified4++;
        } else if (value === "8") {
            newValue = "008";
            isModified = true;
            modified8++;
        } else if (value === "9") {
            newValue = "009";
            isModified = true;
            modified9++;
        }
        
        modifiedRow[columnName] = newValue;
        
        if (isModified) {
            modifiedRows.push({
                index: index + 2,
                originalValue: value,
                newValue: newValue
            });
        }
        
        modifiedData.push(modifiedRow);
    });
    
    filteredData = modifiedData;
    
    return {
        success: true,
        modifiedCount: modifiedRows.length,
        stats: {
            "แก้ไข": modifiedRows.length.toLocaleString(),
            "2→002": modified2.toLocaleString(),
            "3→003": modified3.toLocaleString(),
            "4→004": modified4.toLocaleString(),
            "8→008": modified8.toLocaleString(),
            "9→009": modified9.toLocaleString(),
            "แถวทั้งหมด": filteredData.length.toLocaleString()
        }
    };
}

async function processDamageAreaData() {
    const columnName = findColumnExact("พื้นที่เสียหาย");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'พื้นที่เสียหาย'",
            stats: {}
        };
    }
    
    // เรียงข้อมูลจาก Z-A
    const sortedData = [...filteredData].sort((a, b) => {
        const valueA = a[columnName] ? a[columnName].toString().trim() : '';
        const valueB = b[columnName] ? b[columnName].toString().trim() : '';
        return valueB.localeCompare(valueA);
    });
    
    // แปลงเป็นตัวเลขและจัดรูปแบบ
    const processedData = sortedData.map(row => {
        const modifiedRow = {...row};
        const originalValue = row[columnName] ? row[columnName].toString().trim() : '';
        
        if (originalValue !== '') {
            const formattedValue = formatToTwoDecimals(originalValue);
            modifiedRow[columnName] = formattedValue;
        }
        
        return modifiedRow;
    });
    
    filteredData = processedData;
    
    // นับข้อมูลที่แปลง
    let convertedCount = 0;
    filteredData.forEach(row => {
        const value = row[columnName] ? row[columnName].toString().trim() : '';
        if (value !== '' && !isNaN(parseFloat(value))) {
            convertedCount++;
        }
    });
    
    return {
        success: true,
        stats: {
            "แปลงข้อมูล": convertedCount.toLocaleString(),
            "เรียง Z-A": filteredData.length.toLocaleString(),
            "แถวทั้งหมด": filteredData.length.toLocaleString()
        }
    };
}

async function processAreaData() {
    const areaColumn = findColumnExact("พื้นที่");
    const damageAreaColumn = findColumnExact("พื้นที่เสียหาย");
    
    if (!areaColumn || !damageAreaColumn) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'พื้นที่' หรือ 'พื้นที่เสียหาย'",
            stats: {}
        };
    }
    
    const newFilteredData = [];
    const removedRows = [];
    let formattedCount = 0;
    let calculatedCount = 0;
    let removedZeroCount = 0;
    
    filteredData.forEach((row, index) => {
        const modifiedRow = {...row};
        const areaValue = row[areaColumn] ? row[areaColumn].toString().trim() : '';
        const damageAreaValue = row[damageAreaColumn] ? row[damageAreaColumn].toString().trim() : '';
        let shouldRemove = false;
        let newAreaValue = areaValue;
        
        // แปลงพื้นที่เดิมเป็นทศนิยม 2 ตำแหน่ง
        if (areaValue !== '') {
            const formattedAreaValue = formatToTwoDecimals(areaValue);
            if (formattedAreaValue !== areaValue && formattedAreaValue !== '') {
                newAreaValue = formattedAreaValue;
                formattedCount++;
            } else if (!isNaN(parseFloat(areaValue))) {
                formattedCount++;
            }
        }
        
        // คำนวณพื้นที่ใหม่ = พื้นที่ - พื้นที่เสียหาย
        if (newAreaValue !== '' && damageAreaValue !== '') {
            const areaNum = parseFloat(newAreaValue);
            const damageAreaNum = parseFloat(formatToTwoDecimals(damageAreaValue));
            
            if (!isNaN(areaNum) && !isNaN(damageAreaNum)) {
                const newAreaNum = areaNum - damageAreaNum;
                const formattedNewArea = newAreaNum.toFixed(2);
                
                if (formattedNewArea !== newAreaValue) {
                    newAreaValue = formattedNewArea;
                    calculatedCount++;
                }
                
                // ตรวจสอบว่าพื้นที่ใหม่ ≤ 0 หรือไม่
                if (newAreaNum <= 0) {
                    shouldRemove = true;
                    removedZeroCount++;
                }
            }
        }
        
        modifiedRow[areaColumn] = newAreaValue;
        
        if (shouldRemove) {
            removedRows.push({
                index: index + 2,
                areaValue: newAreaValue,
                damageAreaValue: damageAreaValue
            });
        } else {
            newFilteredData.push(modifiedRow);
        }
    });
    
    filteredData = newFilteredData;
    
    return {
        success: true,
        removedCount: removedRows.length,
        stats: {
            "ตัดออก": removedRows.length.toLocaleString(),
            "แปลงทศนิยม": formattedCount.toLocaleString(),
            "คำนวณพื้นที่": calculatedCount.toLocaleString(),
            "พื้นที่ ≤ 0": removedZeroCount.toLocaleString(),
            "เหลือ": filteredData.length.toLocaleString()
        }
    };
}

async function filterIntechPlotData() {
    const columnName = findColumnExact("เลขแปลงintech");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'เลขแปลงintech'",
            stats: {}
        };
    }
    
    const newFilteredData = [];
    const removedRows = [];
    let removedCount = 0;
    
    filteredData.forEach((row, index) => {
        const value = row[columnName] ? row[columnName].toString().trim() : '';
        let shouldRemove = false;
        
        if (value === "") {
            shouldRemove = true;
            removedCount++;
        }
        
        if (shouldRemove) {
            removedRows.push({
                index: index + 2,
                value: value
            });
        } else {
            newFilteredData.push(row);
        }
    });
    
    filteredData = newFilteredData;
    
    return {
        success: true,
        removedCount: removedRows.length,
        stats: {
            "ตัดออก": removedRows.length.toLocaleString(),
            "ค่าว่าง": removedCount.toLocaleString(),
            "เหลือ": filteredData.length.toLocaleString()
        }
    };
}

async function formatScientificNotation() {
    const columnName = findColumnExact("เลขแปลงintech");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'เลขแปลงintech'",
            stats: {}
        };
    }
    
    const modifiedData = [];
    let convertedCount = 0;
    
    filteredData.forEach(row => {
        const modifiedRow = {...row};
        const value = row[columnName] ? row[columnName].toString() : '';
        
        if (value !== '') {
            const convertedValue = convertScientificNotation(value);
            if (convertedValue !== value) {
                modifiedRow[columnName] = convertedValue;
                convertedCount++;
            }
        }
        
        modifiedData.push(modifiedRow);
    });
    
    filteredData = modifiedData;
    
    return {
        success: true,
        convertedCount: convertedCount,
        stats: {
            "แปลงสัญกรณ์": convertedCount.toLocaleString(),
            "แถวทั้งหมด": filteredData.length.toLocaleString()
        }
    };
}

async function addQuotationPrefix() {
    const columnName = findColumnExact("รหัสนักเกษตร");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'รหัสนักเกษตร'",
            stats: {}
        };
    }
    
    const modifiedData = [];
    let convertedCount = 0;
    
    filteredData.forEach(row => {
        const modifiedRow = {...row};
        const value = row[columnName] ? row[columnName].toString() : '';
        
        if (value !== '') {
            const convertedValue = convertToText(value);
            if (convertedValue !== value) {
                modifiedRow[columnName] = convertedValue;
                convertedCount++;
            }
        }
        
        modifiedData.push(modifiedRow);
    });
    
    filteredData = modifiedData;
    
    return {
        success: true,
        convertedCount: convertedCount,
        stats: {
            "เพิ่ม ' หน้า": convertedCount.toLocaleString(),
            "แถวทั้งหมด": filteredData.length.toLocaleString()
        }
    };
}

// อัปเดตสรุปผลรวม
function updateFinalSummary() {
    if (!uploadedData || !filteredData) return;
    
    const initialRows = uploadedData.data.length;
    const finalRows = filteredData.length;
    const totalRemovedRows = initialRows - finalRows;
    const percentage = initialRows > 0 ? ((totalRemovedRows / initialRows) * 100).toFixed(2) : 0;
    
    totalRowsBefore.textContent = initialRows.toLocaleString();
    totalRowsAfter.textContent = finalRows.toLocaleString();
    totalRemoved.textContent = totalRemovedRows.toLocaleString();
    removedPercentage.textContent = `${percentage}%`;
}

// ============================================
// ขั้นตอนที่ 3: เลือกคอลัมน์
// ============================================

// อ้างอิงองค์ประกอบสำหรับ Step 3
const totalColumns = document.getElementById('totalColumns');
const filteredCount = document.getElementById('filteredCount');
const selectedCount = document.getElementById('selectedCount');
const selectedSummaryCount = document.getElementById('selectedSummaryCount');
const selectedColumnsList = document.getElementById('selectedColumnsList');
const columnSearch = document.getElementById('columnSearch');
const columnsGrid = document.getElementById('columnsGrid');
const selectAllBtn = document.getElementById('selectAllBtn');
const deselectAllBtn = document.getElementById('deselectAllBtn');
const columnFilterButtons = document.querySelectorAll('.selection-btn');
const nextToStep4 = document.getElementById('nextToStep4');
const backToStep2From3 = document.getElementById('backToStep2From3');

// Event Listeners สำหรับ Step 3
backToStep2From3.addEventListener('click', () => {
    goToStep(2);
});

nextToStep3.addEventListener('click', function() {
    if (!filteredData || filteredData.length === 0) {
        alert('กรุณากรองข้อมูลก่อนดำเนินการต่อ');
        return;
    }
    
    // เตรียมข้อมูลคอลัมน์ทั้งหมดจากข้อมูลที่กรองแล้ว
    prepareColumnSelection();
    
    // ไปยังขั้นตอนที่ 3
    goToStep(3);
});

function prepareColumnSelection() {
    // ใช้ headers จากข้อมูลที่กรองแล้ว
    allColumns = [...uploadedData.headers];
    
    // ✅ เลือกคอลัมน์ทั้งหมดอัตโนมัติ
    selectedColumns = [...allColumns];
    
    // อัพเดตจำนวนคอลัมน์ทั้งหมด
    totalColumns.textContent = allColumns.length;
    
    // สร้างรายการคอลัมน์
    renderColumnGrid();
    
    // อัพเดตสถิติ
    updateColumnStats();
    
    // ✅ เปิดใช้งานปุ่มต่อไปทันทีเมื่อเลือกคอลัมน์ทั้งหมด
    nextToStep4.disabled = false;
}

function renderColumnGrid() {
    columnsGrid.innerHTML = '';
    
    const searchTerm = columnSearch.value.toLowerCase();
    let displayedCount = 0;
    
    allColumns.forEach(column => {
        // ตรวจสอบว่าคอลัมน์นี้ผ่านการกรองหรือไม่
        const columnNameLower = column.toLowerCase();
        const isSelected = selectedColumns.includes(column);
        const matchesSearch = searchTerm === '' || columnNameLower.includes(searchTerm);
        
        // ตรวจสอบประเภทคอลัมน์
        let columnType = '';
        let columnClass = '';
        
        if (columnNameLower.includes('ประเภทอ้อย') || columnNameLower.includes('sugarcane') || 
            columnNameLower.includes('พันธุ์') || columnNameLower.includes('type')) {
            columnType = 'ข้อมูลอ้อย';
            columnClass = 'sugarcane';
        } else if (columnNameLower.includes('อายุ') || columnNameLower.includes('age') ||
                  columnNameLower.includes('งวด') || columnNameLower.includes('period') ||
                  columnNameLower.includes('กิจกรรม') || columnNameLower.includes('activity')) {
            columnType = 'กิจกรรมงวด';
            columnClass = 'activity';
        } else if (columnNameLower.includes('โครงการ') || columnNameLower.includes('project')) {
            columnType = 'โครงการ';
            columnClass = 'project';
        } else if (columnNameLower.includes('ปุ๋ย') || columnNameLower.includes('fertilizer') ||
                  columnNameLower.includes('ยา') || columnNameLower.includes('chemical')) {
            columnType = 'ปุ๋ย';
            columnClass = 'fertilizer';
        } else if (columnNameLower.includes('วันที่') || columnNameLower.includes('date')) {
            columnType = 'วันที่';
        } else if (columnNameLower.includes('รหัส') || columnNameLower.includes('code') || 
                  columnNameLower.includes('id') || columnNameLower.includes('หมายเลข')) {
            columnType = 'รหัส';
        } else if (columnNameLower.includes('จำนวน') || columnNameLower.includes('quantity') ||
                  columnNameLower.includes('ปริมาณ') || columnNameLower.includes('amount') ||
                  columnNameLower.includes('พื้นที่') || columnNameLower.includes('area')) {
            columnType = 'จำนวน';
        } else if (columnNameLower === 'lat' || columnNameLower === 'latitude') {
            columnType = 'พิกัด lat';
            columnClass = 'sugarcane';
        } else if (columnNameLower === 'long' || columnNameLower === 'longitude') {
            columnType = 'พิกัด long';
            columnClass = 'sugarcane';
        } else {
            columnType = 'ข้อมูลทั่วไป';
        }
        
        // ตรวจสอบว่าควรแสดงคอลัมน์นี้ตาม filter ปัจจุบันหรือไม่
        let shouldShow = matchesSearch;
        const currentFilter = document.querySelector('.selection-btn.active')?.dataset.filter || 'all';
        
        if (currentFilter === 'selected') {
            shouldShow = shouldShow && isSelected;
        } else if (currentFilter === 'unselected') {
            shouldShow = shouldShow && !isSelected;
        } else if (currentFilter !== 'all') {
            shouldShow = shouldShow && columnClass === currentFilter;
        }
        
        if (!shouldShow) return;
        
        displayedCount++;
        
        // ตรวจสอบว่าคอลัมน์นี้มีข้อมูลหรือไม่ (ตัวอย่าง 5 แถวแรก)
        const sampleValues = filteredData.slice(0, 5).map(row => row[column]);
        const emptyCount = sampleValues.filter(v => v === '' || v === null || v === undefined).length;
        const fillRate = sampleValues.length > 0 ? 
            ((sampleValues.length - emptyCount) / sampleValues.length * 100).toFixed(0) : 0;
        
        const columnItem = document.createElement('div');
        columnItem.className = `column-item ${columnClass} ${isSelected ? 'selected' : ''}`;
        
        columnItem.innerHTML = `
            <input type="checkbox" class="column-checkbox" ${isSelected ? 'checked' : ''} data-column="${column}">
            <div class="column-info">
                <div class="column-name" title="${column}">${column}</div>
                <span class="column-type">${columnType}</span>
                <div class="column-stats">
                    <i class="fas fa-database"></i> มีข้อมูล ${fillRate}%
                </div>
            </div>
        `;
        
        columnsGrid.appendChild(columnItem);
        
        // เพิ่ม event listener สำหรับ checkbox
        const checkbox = columnItem.querySelector('.column-checkbox');
        checkbox.addEventListener('change', function() {
            const columnName = this.dataset.column;
            
            if (this.checked) {
                if (!selectedColumns.includes(columnName)) {
                    selectedColumns.push(columnName);
                }
            } else {
                const index = selectedColumns.indexOf(columnName);
                if (index > -1) {
                    selectedColumns.splice(index, 1);
                }
            }
            
            // อัพเดต UI
            columnItem.classList.toggle('selected', this.checked);
            updateColumnStats();
            
            // เปิด/ปิดใช้งานปุ่มต่อไป
            nextToStep4.disabled = selectedColumns.length === 0;
        });
    });
    
    filteredCount.textContent = displayedCount;
}

function updateColumnStats() {
    selectedCount.textContent = selectedColumns.length;
    selectedSummaryCount.textContent = selectedColumns.length;
    
    if (selectedColumns.length === 0) {
        selectedColumnsList.textContent = 'ยังไม่ได้เลือกคอลัมน์';
    } else {
        const displayedColumns = selectedColumns.slice(0, 3);
        const moreCount = selectedColumns.length - 3;
        selectedColumnsList.textContent = displayedColumns.join(', ') + 
            (moreCount > 0 ? ` และอีก ${moreCount} คอลัมน์...` : '');
    }
}

// Search functionality
columnSearch.addEventListener('input', function() {
    renderColumnGrid();
});

// Column filter buttons
columnFilterButtons.forEach(btn => {
    btn.addEventListener('click', function() {
        // อัพเดตปุ่มที่ active
        columnFilterButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // กรองคอลัมน์
        renderColumnGrid();
    });
});

// Select all / Deselect all
selectAllBtn.addEventListener('click', function() {
    const checkboxes = columnsGrid.querySelectorAll('.column-checkbox');
    
    checkboxes.forEach(checkbox => {
        const columnName = checkbox.dataset.column;
        
        if (!checkbox.checked) {
            checkbox.checked = true;
            if (!selectedColumns.includes(columnName)) {
                selectedColumns.push(columnName);
            }
            
            const columnItem = checkbox.closest('.column-item');
            if (columnItem) {
                columnItem.classList.add('selected');
            }
        }
    });
    
    updateColumnStats();
    nextToStep4.disabled = selectedColumns.length === 0;
});

deselectAllBtn.addEventListener('click', function() {
    const checkboxes = columnsGrid.querySelectorAll('.column-checkbox');
    
    checkboxes.forEach(checkbox => {
        const columnName = checkbox.dataset.column;
        
        if (checkbox.checked) {
            checkbox.checked = false;
            const index = selectedColumns.indexOf(columnName);
            if (index > -1) {
                selectedColumns.splice(index, 1);
            }
            
            const columnItem = checkbox.closest('.column-item');
            if (columnItem) {
                columnItem.classList.remove('selected');
            }
        }
    });
    
    updateColumnStats();
    nextToStep4.disabled = selectedColumns.length === 0;
});

nextToStep4.addEventListener('click', function() {
    if (selectedColumns.length === 0) {
        alert('กรุณาเลือกคอลัมน์ที่ต้องการตรวจสอบ');
        return;
    }
    
    // ไปยังขั้นตอนที่ 4
    goToStep(4);
});
            // ============================================
// ขั้นตอนที่ 4: ตรวจสอบและแก้ไขข้อมูล
// ============================================

// ตัวแปรสำหรับระบบตรวจสอบข้อมูล
let userSelectedDataTypes = {};
let currentValidationResults = {};
let cellValidationStatus = {};
let editingCell = null;
let totalCells = 0;
let isShowingAllRows = false;
let currentRowLimit = 50;
let dataTypeConfigVisible = false;

// ข้อมูลสำหรับการตรวจสอบ
const sugarcaneTypes = [
    "ปลายฝนขยาย", 
    "ปลายฝนรื้อตอ", 
    "ตอ1", 
    "ตอ2", 
    "ตอ3", 
    "ต้นฝนขยาย", 
    "ต้นฝนรื้อตอ", 
    "พื้นที่เสียหาย", 
    ">ตอ3"
];

const sugarcaneNumbers = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];

// อ้างอิงองค์ประกอบสำหรับ Step 4
const backToStep3 = document.getElementById('backToStep3');
const nextToStep5 = document.getElementById('nextToStep5');
const refreshDashboard = document.getElementById('refreshDashboard');
const fixAllErrors = document.getElementById('fixAllErrors');
const showReviewBtn = document.getElementById('showReviewBtn');
const correctDataPercent = document.getElementById('correctDataPercent');
const needReviewCount = document.getElementById('needReviewCount');
const errorDataCount = document.getElementById('errorDataCount');
const editedCellsCount = document.getElementById('editedCellsCount');
const correctDataBar = document.getElementById('correctDataBar');
const needReviewBar = document.getElementById('needReviewBar');
const errorDataBar = document.getElementById('errorDataBar');
const editedCellsBar = document.getElementById('editedCellsBar');

// Data Table elements
const dataTableHeader = document.getElementById('dataTableHeader');
const dataTableBody = document.getElementById('dataTableBody');
const currentRows = document.getElementById('currentRows');
const totalRows = document.getElementById('totalRows');
const currentColumns = document.getElementById('currentColumns');
const totalRowCount = document.getElementById('totalRowCount');
const dataStatus = document.getElementById('dataStatus');
const toggleAllRowsBtn = document.getElementById('toggleAllRows');
const exportTableBtn = document.getElementById('exportTable');
const showDataTypeConfigBtn = document.getElementById('showDataTypeConfig');

// Data Type Configuration elements
const dataTypeConfig = document.getElementById('dataTypeConfig');
const dataTypeTableBody = document.getElementById('dataTypeTableBody');
const autoDetectTypesBtn = document.getElementById('autoDetectTypes');
const applyDataTypesBtn = document.getElementById('applyDataTypes');
const editDataTypeSelect = document.getElementById('editDataTypeSelect');

// Cell Editor Modal elements
const cellEditorModal = document.getElementById('cellEditorModal');
const editColumnName = document.getElementById('editColumnName');
const editRowNumber = document.getElementById('editRowNumber');
const editIssue = document.getElementById('editIssue');
const cellValueInput = document.getElementById('cellValueInput');
const valueSuggestions = document.getElementById('valueSuggestions');
const correctionReason = document.getElementById('correctionReason');
const saveEditBtn = document.getElementById('saveEdit');
const cancelEditBtn = document.getElementById('cancelEdit');
const closeModalBtn = document.querySelector('.close-modal');

// Event Listeners สำหรับ Step 4
backToStep3.addEventListener('click', () => {
    goToStep(3);
});

nextToStep4.addEventListener('click', function() {
    if (!selectedColumns || selectedColumns.length === 0) {
        alert('กรุณาเลือกคอลัมน์ที่ต้องการตรวจสอบ');
        return;
    }
    
    // เริ่มต้นระบบตรวจสอบข้อมูล
    initDataValidationSystem();
    
    // ไปยังขั้นตอนที่ 4
    goToStep(4);
});

// เริ่มต้นระบบตรวจสอบข้อมูล
function initDataValidationSystem() {
    // แสดง Dashboard
    dashboardSummary.style.display = 'block';
    
    // ตรวจสอบว่ามีข้อมูลที่กรองแล้วหรือไม่
    if (!filteredData || selectedColumns.length === 0) {
        alert('กรุณากรองข้อมูลและเลือกคอลัมน์ก่อน');
        return;
    }
    
    // รันการตรวจสอบข้อมูล
    runDataValidation();
}

function runDataValidation() {
    if (!filteredData || selectedColumns.length === 0) return;
    
    // ตัดแถวที่ว่างทั้งหมดออกก่อนตรวจสอบ
    const removedCount = removeEmptyRows();
    
    currentValidationResults = {
        totalCells: 0,
        validCells: 0,
        warningCells: 0,
        errorCells: 0,
        details: {}
    };
    
    cellValidationStatus = {};
    
    // ใช้แถวแรกตามจำนวนที่กำหนด
    const sampleRows = filteredData.slice(0, currentRowLimit);
    totalCells = sampleRows.length * selectedColumns.length;
    
    // ตรวจสอบแต่ละเซลล์
    sampleRows.forEach((row, rowIndex) => {
        selectedColumns.forEach((columnName, colIndex) => {
            const cellValue = row[columnName] || '';
            
            // ถ้าค่าเป็นช่องว่าง ให้ผ่านได้เลย
            if (cellValue.trim() === '') {
                if (!cellValidationStatus[rowIndex]) {
                    cellValidationStatus[rowIndex] = {};
                }
                cellValidationStatus[rowIndex][colIndex] = {
                    status: 'valid',
                    message: 'ค่าว่าง - ผ่าน',
                    suggestions: [],
                    dataType: 'text',
                    edited: false
                };
                
                currentValidationResults.totalCells++;
                currentValidationResults.validCells++;
                return;
            }
            
            // ใช้ประเภทข้อมูลที่ผู้ใช้เลือก หรือตรวจจับอัตโนมัติ
            const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, cellValue);
            const validation = validateCellData(columnName, cellValue, columnType, rowIndex, colIndex);
            
            // บันทึกผลการตรวจสอบ
            if (!cellValidationStatus[rowIndex]) {
                cellValidationStatus[rowIndex] = {};
            }
            
            cellValidationStatus[rowIndex][colIndex] = validation;
            
            // นับสถิติ
            currentValidationResults.totalCells++;
            
            if (validation.status === 'valid') {
                currentValidationResults.validCells++;
            } else if (validation.status === 'warning') {
                currentValidationResults.warningCells++;
            } else if (validation.status === 'error') {
                currentValidationResults.errorCells++;
            }
            
            // บันทึกรายละเอียด
            if (!currentValidationResults.details[columnName]) {
                currentValidationResults.details[columnName] = {
                    errors: [],
                    warnings: []
                };
            }
            
            if (validation.status === 'error') {
                currentValidationResults.details[columnName].errors.push({
                    row: rowIndex + 1,
                    value: cellValue,
                    message: validation.message
                });
            } else if (validation.status === 'warning') {
                currentValidationResults.details[columnName].warnings.push({
                    row: rowIndex + 1,
                    value: cellValue,
                    message: validation.message
                });
            }
        });
    });
    
    // แสดงข้อมูลในตาราง
    renderDataTable();
    
    // อัพเดต Dashboard
    updateDashboard();
    
    // อัพเดตสถานะ
    updateDataStatus();
}

function detectColumnType(columnName, sampleValue) {
    const columnNameLower = columnName.toLowerCase();
    
    // คอลัมน์ "ชื่อประเภทอ้อย" ให้เป็นประเภท "text"
    if (columnNameLower === 'ชื่อประเภทอ้อย' || 
        columnNameLower.includes('ชื่อประเภทอ้อย')) {
        return 'text';
    }
    
    // คอลัมน์ "ประเภทอ้อย" ให้เป็นประเภท "number"
    if (columnNameLower === 'ประเภทอ้อย' || 
        columnNameLower.includes('ประเภทอ้อย')) {
        return 'number';
    }
    
    // ตรวจสอบจากชื่อคอลัมน์
    if (columnNameLower.includes('วันที่') || columnNameLower.includes('date') || 
        columnNameLower.includes('วัน') || columnNameLower.includes('month') || 
        columnNameLower.includes('year')) {
        return 'date';
    }
    
    if (columnNameLower.includes('จำนวน') || columnNameLower.includes('quantity') ||
        columnNameLower.includes('ปริมาณ') || columnNameLower.includes('amount') ||
        columnNameLower.includes('น้ำหนัก') || columnNameLower.includes('weight') ||
        columnNameLower.includes('พื้นที่') || columnNameLower.includes('area') ||
        columnNameLower.includes('ราคา') || columnNameLower.includes('price') ||
        columnNameLower === 'lat' || columnNameLower === 'latitude' ||
        columnNameLower === 'long' || columnNameLower === 'longitude') {
        return 'number';
    }
    
    if (columnNameLower.includes('รหัส') || columnNameLower.includes('code') || 
        columnNameLower.includes('id') || columnNameLower.includes('หมายเลข') ||
        columnNameLower.includes('เลขที่') || columnNameLower.includes('no.')) {
        return 'identifier';
    }
    
    if (columnNameLower.includes('ประเภท') || columnNameLower.includes('type') ||
        columnNameLower.includes('สถานะ') || columnNameLower.includes('status') ||
        columnNameLower.includes('ใช่/ไม่') || columnNameLower.includes('yes/no') ||
        columnNameLower.includes('ระดับ') || columnNameLower.includes('level') ||
        columnNameLower.includes('การจัด') || columnNameLower.includes('category')) {
        return 'enum';
    }
    
    // ตรวจสอบจากค่าตัวอย่าง
    if (sampleValue === '' || sampleValue === null || sampleValue === undefined) {
        return 'text';
    }
    
    // ตรวจสอบตัวเลข
    const numValue = parseFloat(sampleValue);
    if (!isNaN(numValue) && sampleValue.trim() !== '' && 
        !isNaN(parseFloat(sampleValue)) && isFinite(sampleValue)) {
        return 'number';
    }
    
    // ตรวจสอบวันที่
    const datePatterns = [
        /^\d{4}-\d{1,2}-\d{1,2}$/,
        /^\d{4}\/\d{1,2}\/\d{1,2}$/,
        /^\d{1,2}\/\d{1,2}\/\d{4}$/,
        /^\d{1,2}-\d{1,2}-\d{4}$/
    ];
    
    if (datePatterns.some(pattern => pattern.test(sampleValue.trim()))) {
        return 'date';
    }
    
    // ค่าเริ่มต้นเป็นข้อความ
    return 'text';
}

function validateCellData(columnName, value, columnType, rowIndex, colIndex) {
    const effectiveType = userSelectedDataTypes[columnName] || columnType;
    
    const result = {
        status: 'valid',
        message: '',
        suggestions: [],
        dataType: effectiveType,
        edited: false
    };
    
    // ตรวจสอบค่าว่าง (ผ่านแล้วในขั้นต้น)
    if (value === '' || value === null || value === undefined) {
        return result;
    }
    
    // คอลัมน์ "เลขแปลงintech" เป็นค่าเริ่มต้น ไม่ต้องตรวจสอบ
    if (columnName.toLowerCase().includes('แปลงintech')) {
        return result;
    }
    
    // การตรวจสอบสำหรับคอลัมน์ "ชื่อประเภทอ้อย"
    if (columnName.toLowerCase() === 'ชื่อประเภทอ้อย') {
        if (!sugarcaneTypes.includes(value.trim())) {
            result.status = 'error';
            result.message = `ต้องเป็นหนึ่งใน: ${sugarcaneTypes.join(', ')}`;
            result.suggestions = sugarcaneTypes;
        }
        return result;
    }
    
    // การตรวจสอบสำหรับคอลัมน์ "ประเภทอ้อย"
    if (columnName.toLowerCase() === 'ประเภทอ้อย') {
        const numValue = parseFloat(value);
        if (isNaN(numValue)) {
            result.status = 'error';
            result.message = 'ต้องเป็นตัวเลข';
            result.suggestions = sugarcaneNumbers;
        } else if (!sugarcaneNumbers.includes(value.trim())) {
            result.status = 'error';
            result.message = `ต้องเป็นหนึ่งใน: ${sugarcaneNumbers.join(', ')}`;
            result.suggestions = sugarcaneNumbers;
        }
        return result;
    }
    
    // ตรวจสอบตามประเภทข้อมูล
    switch(effectiveType) {
        case 'number':
            if (isNaN(value) || value.trim() === '') {
                result.status = 'error';
                result.message = 'ต้องเป็นตัวเลข';
                
                if (columnName.toLowerCase() === 'lat') {
                    result.suggestions = ['13.7563', '14.0790', '15.8700', '16.4393'];
                } else if (columnName.toLowerCase() === 'long') {
                    result.suggestions = ['100.5018', '101.0037', '102.4956', '103.8499'];
                } else if (columnName.includes('พื้นที่')) {
                    result.suggestions = ['10.0', '15.5', '20.0', '25.5'];
                } else if (columnName.includes('อายุ')) {
                    result.suggestions = ['120', '150', '180', '210'];
                } else if (columnName.includes('โควต้า')) {
                    result.suggestions = ['100', '150', '200', '250'];
                } else {
                    result.suggestions = ['0', '10', '50', '100'];
                }
            } else {
                const numValue = parseFloat(value);
                
                // ตรวจสอบพิกัด latitude
                if (columnName.toLowerCase() === 'lat') {
                    if (numValue < -90 || numValue > 90) {
                        result.status = 'error';
                        result.message = 'latitude ต้องอยู่ระหว่าง -90 ถึง 90';
                        result.suggestions = ['13.7563', '14.0790', '15.8700', '16.4393'];
                    }
                }
                
                // ตรวจสอบพิกัด longitude
                if (columnName.toLowerCase() === 'long') {
                    if (numValue < -180 || numValue > 180) {
                        result.status = 'error';
                        result.message = 'longitude ต้องอยู่ระหว่าง -180 ถึง 180';
                        result.suggestions = ['100.5018', '101.0037', '102.4956', '103.8499'];
                    }
                }
                
                // ตรวจสอบค่าติดลบ
                if ((columnName.includes('พื้นที่') || columnName.includes('อายุ') || 
                     columnName.includes('จำนวน') || columnName.includes('โควต้า')) && numValue < 0) {
                    result.status = 'error';
                    result.message = 'ค่าต้องมากกว่าหรือเท่ากับ 0';
                    result.suggestions = ['0', '1', '10'];
                }
            }
            break;
            
        case 'date':
            const datePatterns = [
                /^\d{4}-\d{1,2}-\d{1,2}$/,
                /^\d{4}\/\d{1,2}\/\d{1,2}$/,
                /^\d{1,2}\/\d{1,2}\/\d{4}$/,
                /^\d{1,2}-\d{1,2}-\d{4}$/
            ];
            
            const isValidDate = datePatterns.some(pattern => pattern.test(value.trim()));
            if (!isValidDate) {
                result.status = 'error';
                result.message = 'รูปแบบวันที่ไม่ถูกต้อง (รองรับ: YYYY/MM/DD, YYYY/M/D, DD/MM/YYYY)';
                result.suggestions = ['2023/01/01', '2023/6/15', '2023/12/31'];
            }
            break;
            
        case 'enum':
            if (columnName.toLowerCase().includes('ใช่/ไม่') || columnName.toLowerCase().includes('yes/no')) {
                const validValues = ['ใช่', 'ไม่', 'yes', 'no', 'true', 'false'];
                if (!validValues.includes(value.toLowerCase())) {
                    result.status = 'error';
                    result.message = 'ต้องเป็น "ใช่" หรือ "ไม่"';
                    result.suggestions = ['ใช่', 'ไม่'];
                }
            }
            break;
    }
    
    return result;
}

function renderDataTable() {
    // ล้างตารางเดิม
    dataTableHeader.innerHTML = '';
    dataTableBody.innerHTML = '';
    
    if (!filteredData || selectedColumns.length === 0) return;
    
    // สร้างหัวตาราง
    const headerRow = document.createElement('tr');
    
    // เพิ่มคอลัมน์หมายเลขแถว
    const rowNumHeader = document.createElement('th');
    rowNumHeader.textContent = '#';
    rowNumHeader.style.width = '50px';
    headerRow.appendChild(rowNumHeader);
    
    // เพิ่มหัวคอลัมน์ข้อมูลที่เลือก
    selectedColumns.forEach(columnName => {
        const th = document.createElement('th');
        
        // ตรวจสอบประเภทคอลัมน์
        const effectiveType = userSelectedDataTypes[columnName] || 
                             detectColumnType(columnName, filteredData[0] ? filteredData[0][columnName] || '' : '');
        
        // เพิ่ม badge ประเภทข้อมูล
        const typeBadge = document.createElement('span');
        typeBadge.className = 'column-type-badge';
        typeBadge.textContent = getTypeDisplayName(effectiveType);
        typeBadge.style.marginLeft = '5px';
        typeBadge.style.padding = '2px 6px';
        typeBadge.style.borderRadius = '10px';
        typeBadge.style.backgroundColor = getTypeColor(effectiveType);
        typeBadge.style.color = 'white';
        typeBadge.style.fontSize = '0.7rem';
        
        th.innerHTML = `${columnName} `;
        th.appendChild(typeBadge);
        
        // เพิ่มฟิลเตอร์ dropdown
        const filterSelect = document.createElement('select');
        filterSelect.className = 'filter-dropdown';
        filterSelect.innerHTML = '<option value="">ทั้งหมด</option>';
        
        // เก็บค่าที่ไม่ซ้ำกันสำหรับ dropdown
        const uniqueValues = new Set();
        const sampleRows = filteredData.slice(0, Math.min(100, filteredData.length));
        
        sampleRows.forEach(row => {
            const value = row[columnName] || '';
            if (value.trim() !== '') {
                uniqueValues.add(value);
            }
        });
        
        // เพิ่มตัวเลือก (จำกัดที่ 50 รายการ)
        Array.from(uniqueValues).slice(0, 50).forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value.length > 30 ? value.substring(0, 27) + '...' : value;
            filterSelect.appendChild(option);
        });
        
        filterSelect.addEventListener('change', function() {
            filterTableRows();
        });
        
        th.appendChild(document.createElement('br'));
        th.appendChild(filterSelect);
        headerRow.appendChild(th);
    });
    
    dataTableHeader.appendChild(headerRow);
    
    // สร้างแถวข้อมูล
    const displayRows = filteredData.slice(0, currentRowLimit);
    
    // อัพเดตจำนวนแถวที่แสดง
    totalRows.textContent = filteredData.length;
    currentRows.textContent = Math.min(currentRowLimit, filteredData.length);
    totalRowCount.textContent = filteredData.length;
    currentColumns.textContent = selectedColumns.length;
    
    displayRows.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        
        // เพิ่มหมายเลขแถว
        const rowNumCell = document.createElement('td');
        rowNumCell.textContent = rowIndex + 1;
        rowNumCell.style.fontWeight = 'bold';
        tr.appendChild(rowNumCell);
        
        // เพิ่มข้อมูลแต่ละเซลล์
        selectedColumns.forEach((columnName, colIndex) => {
            const td = document.createElement('td');
            const cellValue = row[columnName] || '';
            td.textContent = cellValue;
            
            // ตรวจสอบประเภทที่ควรใช้
            const effectiveType = userSelectedDataTypes[columnName] || 
                                 detectColumnType(columnName, cellValue);
            
            // ตรวจสอบข้อมูล
            const validation = cellValidationStatus[rowIndex] ? cellValidationStatus[rowIndex][colIndex] : 
                               validateCellData(columnName, cellValue, effectiveType, rowIndex, colIndex);
            
            // เพิ่มคลาสตามสถานะการตรวจสอบ
            if (validation.status === 'error') {
                td.className = 'cell-error cell-highlight';
                td.title = validation.message;
                td.style.cursor = 'pointer';
                td.addEventListener('click', () => openCellEditor(rowIndex, colIndex));
            } else if (validation.status === 'warning') {
                td.className = 'cell-warning cell-highlight';
                td.title = validation.message;
                td.style.cursor = 'pointer';
                td.addEventListener('click', () => openCellEditor(rowIndex, colIndex));
            } else {
                td.className = 'cell-valid';
            }
            
            // เพิ่มข้อมูลสำหรับการแก้ไข
            td.dataset.row = rowIndex;
            td.dataset.col = colIndex;
            td.dataset.column = columnName;
            td.dataset.value = cellValue;
            td.dataset.type = effectiveType;
            
            tr.appendChild(td);
        });
        
        dataTableBody.appendChild(tr);
    });
}

function getTypeDisplayName(type) {
    const names = {
        'text': 'ข้อความ',
        'number': 'ตัวเลข',
        'date': 'วันที่',
        'enum': 'ค่าที่กำหนด',
        'identifier': 'รหัส'
    };
    return names[type] || type;
}

function getTypeColor(type) {
    const colors = {
        'text': '#1565c0',
        'number': '#2e7d32',
        'date': '#ef6c00',
        'enum': '#7b1fa2',
        'identifier': '#00695c'
    };
    return colors[type] || '#6c757d';
}

function updateDashboard() {
    const total = currentValidationResults.totalCells;
    const valid = currentValidationResults.validCells;
    const warning = currentValidationResults.warningCells;
    const error = currentValidationResults.errorCells;
    
    // คำนวณเปอร์เซ็นต์
    const validPercent = total > 0 ? Math.round((valid / total) * 100) : 0;
    const warningPercent = total > 0 ? Math.round((warning / total) * 100) : 0;
    const errorPercent = total > 0 ? Math.round((error / total) * 100) : 0;
    
    // อัพเดต Dashboard
    correctDataPercent.textContent = `${validPercent}%`;
    needReviewCount.textContent = warning;
    errorDataCount.textContent = error;
    
    // แสดงปุ่ม "ต้องตรวจสอบ" ถ้ามีข้อมูลที่ต้องตรวจสอบ
    if (warning > 0) {
        showReviewBtn.style.display = 'inline-block';
        showReviewBtn.addEventListener('click', showReviewRows);
    } else {
        showReviewBtn.style.display = 'none';
    }
    
    // อัพเดต Progress bars
    correctDataBar.style.width = `${validPercent}%`;
    needReviewBar.style.width = `${warningPercent}%`;
    errorDataBar.style.width = `${errorPercent}%`;
    
    // อัพเดตจำนวนเซลล์ที่แก้ไขแล้ว
    const editedCount = countEditedCells();
    editedCellsCount.textContent = editedCount;
    const editedPercent = total > 0 ? Math.round((editedCount / total) * 100) : 0;
    editedCellsBar.style.width = `${Math.min(editedPercent, 100)}%`;
    
    // ต้องมีข้อมูลถูกต้อง 100% จึงจะไปขั้นตอนต่อไปได้
    nextToStep5.disabled = validPercent !== 100 || error > 0;
}

function countEditedCells() {
    let count = 0;
    for (let rowIndex in cellValidationStatus) {
        for (let colIndex in cellValidationStatus[rowIndex]) {
            if (cellValidationStatus[rowIndex][colIndex].edited) {
                count++;
            }
        }
    }
    return count;
}

function updateDataStatus() {
    const errorCount = currentValidationResults.errorCells;
    const warningCount = currentValidationResults.warningCells;
    
    if (errorCount > 0) {
        dataStatus.innerHTML = `<span style="cursor: pointer; text-decoration: underline;" id="showErrorsBtn">⚠️ มี ${errorCount} ข้อผิดพลาดที่ต้องแก้ไข</span>`;
        dataStatus.style.color = 'var(--danger-color)';
        dataStatus.style.backgroundColor = 'rgba(247, 37, 133, 0.1)';
        
        // เพิ่ม event listener สำหรับปุ่มแสดงข้อผิดพลาด
        setTimeout(() => {
            const showErrorsBtn = document.getElementById('showErrorsBtn');
            if (showErrorsBtn) {
                showErrorsBtn.addEventListener('click', showErrorRowsOnly);
            }
        }, 100);
    } else if (warningCount > 0) {
        dataStatus.textContent = `⚠️ มี ${warningCount} รายการที่ต้องตรวจสอบ`;
        dataStatus.style.color = 'var(--warning-color)';
        dataStatus.style.backgroundColor = 'rgba(255, 152, 0, 0.1)';
    } else {
        dataStatus.textContent = '✓ ข้อมูลถูกต้องทั้งหมด (100%)';
        dataStatus.style.color = 'var(--success-color)';
        dataStatus.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
    }
}

function filterTableRows() {
    const filterSelects = document.querySelectorAll('.filter-dropdown');
    const rows = document.querySelectorAll('#dataTableBody tr');
    
    rows.forEach(row => {
        let shouldShow = true;
        
        filterSelects.forEach((filterSelect, index) => {
            const filterValue = filterSelect.value;
            if (filterValue === '') return;
            
            const cell = row.children[index + 1]; // +1 เพราะข้ามเซลล์หมายเลขแถว
            if (cell) {
                const cellValue = cell.textContent;
                if (cellValue !== filterValue) {
                    shouldShow = false;
                }
            }
        });
        
        row.style.display = shouldShow ? '' : 'none';
    });
}

function showErrorRowsOnly() {
    const rows = document.querySelectorAll('#dataTableBody tr');
    let errorRowCount = 0;
    
    rows.forEach(row => {
        let hasError = false;
        const cells = row.querySelectorAll('td');
        
        cells.forEach(cell => {
            if (cell.classList.contains('cell-error')) {
                hasError = true;
            }
        });
        
        if (hasError) {
            row.style.display = '';
            errorRowCount++;
            row.style.backgroundColor = 'rgba(255, 235, 238, 0.5)';
        } else {
            row.style.display = 'none';
        }
    });
    
    if (errorRowCount > 0) {
        alert(`แสดงเฉพาะแถวที่มีข้อผิดพลาด: ${errorRowCount} แถว`);
    }
}

function showReviewRows() {
    const rows = document.querySelectorAll('#dataTableBody tr');
    let reviewRowCount = 0;
    
    rows.forEach(row => {
        let hasWarning = false;
        const cells = row.querySelectorAll('td');
        
        cells.forEach(cell => {
            if (cell.classList.contains('cell-warning')) {
                hasWarning = true;
            }
        });
        
        if (hasWarning) {
            row.style.display = '';
            reviewRowCount++;
            row.style.backgroundColor = 'rgba(255, 248, 225, 0.5)';
        } else {
            row.style.display = 'none';
        }
    });
    
    if (reviewRowCount > 0) {
        alert(`แสดงเฉพาะแถวที่ต้องตรวจสอบ: ${reviewRowCount} แถว`);
    }
}

function removeEmptyRows() {
    if (!filteredData || selectedColumns.length === 0) return 0;
    
    const originalRowCount = filteredData.length;
    const newFilteredData = [];
    
    filteredData.forEach(row => {
        let hasData = false;
        
        selectedColumns.forEach(columnName => {
            const value = row[columnName] || '';
            if (value.toString().trim() !== '') {
                hasData = true;
            }
        });
        
        if (hasData) {
            newFilteredData.push(row);
        }
    });
    
    filteredData = newFilteredData;
    
    return originalRowCount - newFilteredData.length;
}

// Event Listeners สำหรับฟังก์ชันเพิ่มเติม
refreshDashboard.addEventListener('click', () => {
    if (filteredData) {
        runDataValidation();
        updateDashboard();
        updateDataStatus();
        alert('✅ อัพเดต Dashboard เรียบร้อยแล้ว');
    }
});

fixAllErrors.addEventListener('click', () => {
    if (filteredData) {
        if (confirm('AI จะพยายามแก้ไขข้อผิดพลาดทั้งหมดอัตโนมัติ\nยืนยันดำเนินการ?')) {
            autoFixAllErrors();
        }
    }
});

// Cell Editor Modal functions
function openCellEditor(rowIndex, colIndex) {
    if (!filteredData || !cellValidationStatus[rowIndex]) return;
    
    const columnName = selectedColumns[colIndex];
    const cell = document.querySelector(`td[data-row="${rowIndex}"][data-col="${colIndex}"]`);
    const currentValue = filteredData[rowIndex][columnName] || '';
    const validation = cellValidationStatus[rowIndex][colIndex];
    const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, currentValue);
    
    // บันทึกข้อมูลเซลล์ที่กำลังแก้ไข
    editingCell = { rowIndex, colIndex, cell, columnName, currentValue, validation, columnType };
    
    // อัพเดตข้อมูลใน modal
    editColumnName.textContent = columnName;
    editRowNumber.textContent = rowIndex + 1;
    editDataTypeSelect.value = columnType;
    editIssue.textContent = validation.message;
    editIssue.className = validation.status === 'error' ? 'error-text' : 'warning-text';
    cellValueInput.value = currentValue;
    
    // เพิ่มคำแนะนำ
    valueSuggestions.innerHTML = '';
    
    if (columnName.toLowerCase() === 'ชื่อประเภทอ้อย') {
        const suggestions = [
            "ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ตอ1", "ตอ2", "ตอ3", 
            "ต้นฝนขยาย", "ต้นฝนรื้อตอ", "พื้นที่เสียหาย", ">ตอ3"
        ];
        suggestions.forEach(suggestion => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'suggestion-item';
            btn.textContent = suggestion;
            btn.addEventListener('click', () => {
                cellValueInput.value = suggestion;
            });
            valueSuggestions.appendChild(btn);
        });
    }
    else if (columnName.toLowerCase() === 'ประเภทอ้อย') {
        const suggestions = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];
        suggestions.forEach(suggestion => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'suggestion-item';
            btn.textContent = suggestion;
            btn.addEventListener('click', () => {
                cellValueInput.value = suggestion;
            });
            valueSuggestions.appendChild(btn);
        });
    }
    else if (validation.suggestions && validation.suggestions.length > 0) {
        validation.suggestions.forEach(suggestion => {
            const suggestionItem = document.createElement('div');
            suggestionItem.className = 'suggestion-item';
            suggestionItem.textContent = suggestion;
            suggestionItem.addEventListener('click', () => {
                cellValueInput.value = suggestion;
            });
            valueSuggestions.appendChild(suggestionItem);
        });
    }
    
    // แสดง modal
    cellEditorModal.classList.add('show');
    cellValueInput.focus();
}

function saveCellEdit() {
    if (!editingCell || !filteredData) return;
    
    const newValue = cellValueInput.value.trim();
    const newDataType = editDataTypeSelect.value;
    const { rowIndex, colIndex, cell, columnName, currentValue, columnType } = editingCell;
    
    // อัพเดตประเภทข้อมูลถ้าผู้ใช้เปลี่ยน
    if (newDataType !== columnType) {
        userSelectedDataTypes[columnName] = newDataType;
    }
    
    // อัพเดตข้อมูล
    filteredData[rowIndex][columnName] = newValue;
    
    // ตรวจสอบข้อมูลใหม่
    const newValidation = validateCellData(columnName, newValue, newDataType, rowIndex, colIndex);
    newValidation.edited = true;
    cellValidationStatus[rowIndex][colIndex] = newValidation;
    
    // อัพเดตเซลล์ในตาราง
    cell.textContent = newValue;
    cell.dataset.value = newValue;
    
    // อัพเดตคลาสตามสถานะใหม่
    cell.className = '';
    if (newValidation.status === 'error') {
        cell.className = 'cell-error cell-highlight';
        cell.title = newValidation.message;
        cell.style.cursor = 'pointer';
        cell.addEventListener('click', () => openCellEditor(rowIndex, colIndex));
    } else if (newValidation.status === 'warning') {
        cell.className = 'cell-warning cell-highlight';
        cell.title = newValidation.message;
        cell.style.cursor = 'pointer';
        cell.addEventListener('click', () => openCellEditor(rowIndex, colIndex));
    } else {
        cell.className = 'cell-valid';
    }
    
    // รันการตรวจสอบใหม่
    runDataValidation();
    
    // ปิด modal
    closeCellEditor();
}

function closeCellEditor() {
    cellEditorModal.classList.remove('show');
    editingCell = null;
    cellValueInput.value = '';
    valueSuggestions.innerHTML = '';
    correctionReason.value = '';
}

// Event Listeners สำหรับ modal
saveEditBtn.addEventListener('click', saveCellEdit);
cancelEditBtn.addEventListener('click', closeCellEditor);
closeModalBtn.addEventListener('click', closeCellEditor);

cellEditorModal.addEventListener('click', (e) => {
    if (e.target === cellEditorModal) {
        closeCellEditor();
    }
});

// Data Type Configuration
showDataTypeConfigBtn.addEventListener('click', showDataTypeConfiguration);

autoDetectTypesBtn.addEventListener('click', autoDetectDataTypes);

applyDataTypesBtn.addEventListener('click', function() {
    dataTypeConfigVisible = false;
    dataTypeConfig.style.display = 'none';
    
    // รันการตรวจสอบใหม่ด้วยประเภทข้อมูลที่ตั้งค่า
    if (filteredData) {
        runDataValidation();
        alert('✅ ใช้การตั้งค่าประเภทข้อมูลเรียบร้อย!');
    }
});

toggleAllRowsBtn.addEventListener('click', toggleAllRows);

exportTableBtn.addEventListener('click', exportTableToCSV);

nextToStep5.addEventListener('click', () => {
    if (currentValidationResults.errorCells > 0) {
        alert('ยังมีข้อผิดพลาดที่ต้องแก้ไข กรุณาตรวจสอบเซลล์สีแดง');
        return;
    }
    
    const validPercent = parseInt(correctDataPercent.textContent);
    if (validPercent !== 100) {
        alert(`ข้อมูลถูกต้อง ${validPercent}% ยังไม่ครบ 100% กรุณาตรวจสอบและแก้ไขข้อมูลให้ถูกต้องทั้งหมด`);
        return;
    }
    
    const editedCount = countEditedCells();
    
    alert(`✅ ตรวจสอบข้อมูลเสร็จสมบูรณ์\n✅ แก้ไขข้อมูลแล้ว: ${editedCount} เซลล์\n✅ ข้อมูลถูกต้อง: 100%\n\nกำลังไปยังขั้นตอนต่อไป...`);
    
    // ไปยังขั้นตอนที่ 5
    goToStep(5);
});

function showDataTypeConfiguration() {
    dataTypeConfigVisible = true;
    dataTypeConfig.style.display = 'block';
    renderDataTypeConfigurationTable();
}

function renderDataTypeConfigurationTable() {
    if (!filteredData || selectedColumns.length === 0) return;
    
    const tableBody = document.getElementById('dataTypeTableBody');
    tableBody.innerHTML = '';
    
    selectedColumns.forEach((columnName) => {
        const row = document.createElement('tr');
        
        // หาตัวอย่างข้อมูล
        const sampleValues = filteredData.slice(0, 5).map(row => row[columnName] || '');
        const nonEmptySamples = sampleValues.filter(v => v.trim() !== '');
        const sampleText = nonEmptySamples.length > 0 ? nonEmptySamples[0] : '(ค่าว่าง)';
        
        // ตรวจจับประเภทอัตโนมัติ
        const columnNameLower = columnName.toLowerCase();
        let currentType;
        
        if (columnNameLower === 'ชื่อประเภทอ้อย') {
            currentType = 'text';
        } else if (columnNameLower === 'ประเภทอ้อย') {
            currentType = 'number';
        } else {
            const autoType = detectColumnType(columnName, sampleText);
            currentType = userSelectedDataTypes[columnName] || autoType;
        }
        
        row.innerHTML = `
            <td><strong>${columnName}</strong></td>
            <td class="data-sample-cell" title="${sampleText}">${sampleText}</td>
            <td>
                <select class="type-select" data-column="${columnName}">
                    <option value="text" ${currentType === 'text' ? 'selected' : ''}>ข้อความ</option>
                    <option value="number" ${currentType === 'number' ? 'selected' : ''}>ตัวเลข</option>
                    <option value="date" ${currentType === 'date' ? 'selected' : ''}>วันที่</option>
                    <option value="enum" ${currentType === 'enum' ? 'selected' : ''}>ค่าที่กำหนด</option>
                    <option value="identifier" ${currentType === 'identifier' ? 'selected' : ''}>รหัส</option>
                </select>
            </td>
            <td>
                <select class="format-select" data-column="${columnName}">
                    <option value="default" selected>ค่าเริ่มต้น</option>
                    ${currentType === 'number' ? 
                        '<option value="decimal">ทศนิยม</option><option value="integer">จำนวนเต็ม</option>' : 
                        currentType === 'date' ?
                        '<option value="YYYY-MM-DD">YYYY-MM-DD</option><option value="DD/MM/YYYY">DD/MM/YYYY</option><option value="YYYY/MM/DD">YYYY/MM/DD</option>' :
                        currentType === 'text' && columnNameLower === 'ชื่อประเภทอ้อย' ?
                        sugarcaneTypes.map(type => `<option value="${type}">${type}</option>`).join('') :
                        ''}
                </select>
            </td>
            <td>
                <select class="unit-select" data-column="${columnName}">
                    <option value="none" selected>ไม่มีหน่วย</option>
                    ${columnName.toLowerCase().includes('พื้นที่') ? 
                        '<option value="ไร่">ไร่</option><option value="งาน">งาน</option><option value="ตารางเมตร">ตร.ม.</option>' :
                        columnName.toLowerCase().includes('อายุ') ?
                        '<option value="วัน">วัน</option><option value="เดือน">เดือน</option><option value="ปี">ปี</option>' :
                        columnName.toLowerCase().includes('ปริมาณ') ?
                        '<option value="กิโลกรัม">กก.</option><option value="ตัน">ตัน</option>' : ''}
                </select>
            </td>
            <td><input type="text" class="form-control" placeholder="คำอธิบาย..." value="${getColumnDescription(columnName)}"></td>
        `;
        
        tableBody.appendChild(row);
    });
    
    // เพิ่ม event listeners สำหรับ dropdown
    document.querySelectorAll('.type-select').forEach(select => {
        select.addEventListener('change', function() {
            const column = this.dataset.column;
            userSelectedDataTypes[column] = this.value;
            
            // อัพเดต format select ตามประเภท
            const row = this.closest('tr');
            const formatSelect = row.querySelector('.format-select');
            
            // รีเซ็ต format
            formatSelect.innerHTML = '<option value="default" selected>ค่าเริ่มต้น</option>';
            
            if (this.value === 'number') {
                formatSelect.innerHTML += '<option value="decimal">ทศนิยม</option><option value="integer">จำนวนเต็ม</option>';
            } else if (this.value === 'date') {
                formatSelect.innerHTML += '<option value="YYYY-MM-DD">YYYY-MM-DD</option><option value="DD/MM/YYYY">DD/MM/YYYY</option><option value="YYYY/MM/DD">YYYY/MM/DD</option>';
            } else if (this.value === 'text' && column.toLowerCase() === 'ชื่อประเภทอ้อย') {
                sugarcaneTypes.forEach(type => {
                    formatSelect.innerHTML += `<option value="${type}">${type}</option>`;
                });
            }
        });
    });
}

function getColumnDescription(columnName) {
    const descriptions = {
        'โซน': 'เขตพื้นที่',
        'รหัสนักเกษตร': 'รหัสประจำตัวนักเกษตร',
        'ชื่อนักเกษตร': 'ชื่อ-นามสกุลนักเกษตร',
        'ชื่อประเภทอ้อย': 'ประเภทของอ้อย เช่น ปลายฝนขยาย, ต้นฝนรื้อตอ',
        'ประเภทอ้อย': 'รหัสประเภทอ้อย เช่น 101, 102, 103, 104, 105',
        'เลขโควต้า': 'หมายเลขโควต้าที่ได้รับจัดสรร',
        'ชื่อชาวไร่': 'ชื่อ-นามสกุลชาวไร่',
        'เลขแปลงintech': 'หมายเลขแปลงในระบบ Intech',
        'lat': 'ค่าพิกัดละติจูด',
        'long': 'ค่าพิกัดลองจิจูด',
        'พื้นที่': 'ขนาดพื้นที่ปลูกอ้อย',
        'อายุ': 'อายุอ้อย (วัน)',
        'จำนวน': 'ปริมาณหรือจำนวน',
        'ปริมาณปุ๋ย': 'ปริมาณปุ๋ยที่ใช้',
        'โครงการ': 'ชื่อโครงการที่เกี่ยวข้อง',
        'วันที่ปลูก': 'วันที่ปลูกอ้อย'
    };
    
    for (const key in descriptions) {
        if (columnName.toLowerCase().includes(key.toLowerCase())) {
            return descriptions[key];
        }
    }
    
    return '';
}

function autoDetectDataTypes() {
    if (!filteredData || selectedColumns.length === 0) return;
    
    selectedColumns.forEach(columnName => {
        const columnNameLower = columnName.toLowerCase();
        
        if (columnNameLower === 'ชื่อประเภทอ้อย') {
            userSelectedDataTypes[columnName] = 'text';
        }
        else if (columnNameLower === 'ประเภทอ้อย') {
            userSelectedDataTypes[columnName] = 'number';
        }
        else {
            const sampleValues = filteredData.slice(0, 10).map(row => row[columnName] || '');
            const nonEmptySamples = sampleValues.filter(v => v.trim() !== '');
            
            if (nonEmptySamples.length > 0) {
                const detectedType = detectColumnType(columnName, nonEmptySamples[0]);
                userSelectedDataTypes[columnName] = detectedType;
            }
        }
    });
    
    renderDataTypeConfigurationTable();
    alert('✅ ตรวจจับประเภทข้อมูลอัตโนมัติเรียบร้อยแล้ว!');
}

function toggleAllRows() {
    isShowingAllRows = !isShowingAllRows;
    
    if (isShowingAllRows) {
        currentRowLimit = filteredData.length;
        toggleAllRowsBtn.innerHTML = 
            `<i class="fas fa-compress"></i> ซ่อนบางส่วน (${currentRowLimit})`;
    } else {
        currentRowLimit = 50;
        toggleAllRowsBtn.innerHTML = 
            `<i class="fas fa-expand"></i> แสดงทั้งหมด (${filteredData.length})`;
    }
    
    renderDataTable();
}

function exportTableToCSV() {
    if (!filteredData || selectedColumns.length === 0) return;
    
    // ใช้คอลัมน์ตามลำดับเดิมในไฟล์ต้นฉบับ
    const exportColumns = [...uploadedData.headers].filter(col => 
        selectedColumns.includes(col)
    );
    
    // สร้าง CSV
    let csvContent = '';
    
    // เพิ่ม BOM สำหรับ UTF-8
    csvContent += '\ufeff';
    
    // เพิ่มหัวตาราง
    csvContent += exportColumns.join(',') + '\n';
    
    // เพิ่มข้อมูลทั้งหมด
    filteredData.forEach(row => {
        const rowValues = exportColumns.map(col => {
            let value = row[col] || '';
            
            // แปลงอักขระพิเศษ
            value = value.toString().replace(/"/g, '""');
            
            // ใส่ quotes ถ้ามี comma, newline หรือ quotes
            if (value.includes(',') || value.includes('\n') || value.includes('\r') || value.includes('"')) {
                value = `"${value}"`;
            }
            
            return value;
        });
        csvContent += rowValues.join(',') + '\n';
    });
    
    // สร้าง blob และดาวน์โหลด
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `cleaned_${uploadedData.fileName.replace('.csv', '')}_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert(`✅ ดาวน์โหลดไฟล์ CSV เรียบร้อย!\nจำนวนแถว: ${filteredData.length}\nจำนวนคอลัมน์: ${exportColumns.length}\n✅ คอลัมน์เรียงตามลำดับเดิม`);
}

function autoFixAllErrors() {
    if (!filteredData) return;
    
    let fixedCount = 0;
    const sampleRows = filteredData.slice(0, currentRowLimit);
    
    sampleRows.forEach((row, rowIndex) => {
        selectedColumns.forEach((columnName, colIndex) => {
            const validation = cellValidationStatus[rowIndex] ? cellValidationStatus[rowIndex][colIndex] : null;
            
            if (validation && validation.status === 'error') {
                let cellValue = row[columnName] || '';
                let fixedValue = cellValue;
                const columnNameLower = columnName.toLowerCase();
                const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, cellValue);
                
                // AI แก้ไขสำหรับคอลัมน์ "ชื่อประเภทอ้อย"
                if (columnNameLower === 'ชื่อประเภทอ้อย') {
                    const validTypes = [
                        "ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ตอ1", "ตอ2", "ตอ3", 
                        "ต้นฝนขยาย", "ต้นฝนรื้อตอ", "พื้นที่เสียหาย", ">ตอ3"
                    ];
                    
                    // พยายามหาค่าที่ใกล้เคียง
                    let bestMatch = null;
                    let bestScore = 0;
                    
                    validTypes.forEach(validType => {
                        const similarity = calculateSimilarity(cellValue, validType);
                        if (similarity > bestScore && similarity > 0.3) {
                            bestScore = similarity;
                            bestMatch = validType;
                        }
                    });
                    
                    if (bestMatch) {
                        fixedValue = bestMatch;
                    } else {
                        fixedValue = validTypes[0];
                    }
                }
                // AI แก้ไขสำหรับคอลัมน์ "ประเภทอ้อย"
                else if (columnNameLower === 'ประเภทอ้อย') {
                    const validNumbers = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];
                    
                    const numValue = parseFloat(cellValue);
                    if (isNaN(numValue)) {
                        fixedValue = "101";
                    } else {
                        let closest = validNumbers[0];
                        let minDiff = Math.abs(numValue - parseInt(closest));
                        
                        validNumbers.forEach(num => {
                            const diff = Math.abs(numValue - parseInt(num));
                            if (diff < minDiff) {
                                minDiff = diff;
                                closest = num;
                            }
                        });
                        
                        fixedValue = closest;
                    }
                }
                else if (columnType === 'number' && isNaN(cellValue)) {
                    if (columnName.toLowerCase().includes('ประเภทอ้อย')) {
                        fixedValue = '101';
                    } else if (columnName.toLowerCase() === 'lat') {
                        fixedValue = '13.7563';
                    } else if (columnName.toLowerCase() === 'long') {
                        fixedValue = '100.5018';
                    } else if (columnName.includes('พื้นที่')) {
                        fixedValue = '10.0';
                    } else if (columnName.includes('อายุ')) {
                        fixedValue = '120';
                    } else if (columnName.includes('โควต้า')) {
                        fixedValue = '100';
                    } else {
                        fixedValue = '0';
                    }
                } else if (columnType === 'date' && !/^\d{4}-\d{1,2}-\d{1,2}$/.test(cellValue)) {
                    const dateMatch = cellValue.match(/(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})/);
                    if (dateMatch) {
                        const day = dateMatch[1].padStart(2, '0');
                        const month = dateMatch[2].padStart(2, '0');
                        const year = dateMatch[3];
                        fixedValue = `${year}/${month}/${day}`;
                    } else {
                        fixedValue = '2023/06/01';
                    }
                }
                
                // บันทึกค่าที่แก้ไข
                if (fixedValue !== cellValue) {
                    filteredData[rowIndex][columnName] = fixedValue;
                    fixedCount++;
                    
                    if (!cellValidationStatus[rowIndex]) {
                        cellValidationStatus[rowIndex] = {};
                    }
                    cellValidationStatus[rowIndex][colIndex].edited = true;
                }
            }
        });
    });
    
    // อัพเดตการตรวจสอบใหม่
    runDataValidation();
    renderDataTable();
    updateDashboard();
    updateDataStatus();
    
    alert(`AI ได้แก้ไขข้อผิดพลาด ${fixedCount} รายการ`);
}

function calculateSimilarity(str1, str2) {
    const longer = str1.length > str2.length ? str1 : str2;
    const shorter = str1.length > str2.length ? str2 : str1;
    
    if (longer.length === 0) return 1.0;
    
    return (longer.length - editDistance(longer, shorter)) / parseFloat(longer.length);
}

function editDistance(s1, s2) {
    s1 = s1.toLowerCase();
    s2 = s2.toLowerCase();
    
    const costs = [];
    for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
            if (i === 0) {
                costs[j] = j;
            } else {
                if (j > 0) {
                    let newValue = costs[j - 1];
                    if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                        newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    }
                    costs[j - 1] = lastValue;
                    lastValue = newValue;
                }
            }
        }
        if (i > 0) costs[s2.length] = lastValue;
    }
    return costs[s2.length];
}
            // อัพเดต panels
            panels.forEach((panel, index) => {
                panel.classList.remove('active');
                if (index + 1 === stepNumber) {
                    panel.classList.add('active');
                }
            });
        }
        
        // Event listener สำหรับเริ่มต้น
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ระบบพร้อมใช้งาน');
        });
    </script>
</body>
</html>
