<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบ Clean Data - ตรวจสอบข้อมูลอ้อยครบวงจร</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Prompt:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #4cc9f0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f72585;
            --sugarcane-color: #228B22;
            --fertilizer-color: #9C27B0;
            --project-color: #FF5722;
            --border-radius: 12px;
            --box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Prompt', sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        
        header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        
        h1 {
            font-family: 'Kanit', sans-serif;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* Navigation Steps */
        .step-navigation {
            display: flex;
            justify-content: center;
            background-color: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 15px;
            position: relative;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 10px;
            z-index: 2;
            transition: all 0.3s ease;
        }
        
        .step.active .step-number {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 0 0 5px rgba(67, 97, 238, 0.2);
        }
        
        .step.completed .step-number {
            background-color: var(--success-color);
            color: white;
        }
        
        .step-info {
            display: flex;
            flex-direction: column;
        }
        
        .step-title {
            font-weight: 500;
            font-size: 1rem;
        }
        
        .step-description {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        /* Dashboard Summary */
        .dashboard-summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
        }
        
        .summary-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .summary-icon.success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
        }
        
        .summary-icon.warning {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }
        
        .summary-icon.error {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger-color);
        }
        
        .summary-icon.info {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
        }
        
        .summary-content {
            flex: 1;
        }
        
        .summary-content h4 {
            margin: 0 0 5px 0;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 1s ease;
        }
        
        .progress-fill.success {
            background: var(--success-color);
        }
        
        .progress-fill.warning {
            background: var(--warning-color);
        }
        
        .progress-fill.error {
            background: var(--danger-color);
        }
        
        .progress-fill.info {
            background: var(--primary-color);
        }
        
        .summary-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Step Content Area */
        .step-content {
            padding: 40px;
            min-height: 600px;
        }
        
        .step-panel {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .step-panel.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Panel Styling */
        .panel-header {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .panel-header h2 {
            font-size: 2rem;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .panel-header p {
            color: #666;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Upload Section */
        .upload-area {
            border: 3px dashed var(--accent-color);
            border-radius: var(--border-radius);
            padding: 60px 20px;
            text-align: center;
            background-color: rgba(76, 201, 240, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .upload-area:hover {
            background-color: rgba(76, 201, 240, 0.1);
            border-color: var(--primary-color);
        }
        
        .upload-area i {
            font-size: 4rem;
            color: var(--accent-color);
            margin-bottom: 20px;
        }
        
        .upload-area h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--secondary-color);
        }
        
        .upload-area p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .file-info {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .info-item strong {
            display: block;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }
        
        /* Column Selection Panel */
        .column-selection-panel {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-container {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 30px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .search-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .selection-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .selection-btn {
            padding: 8px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .selection-btn:hover {
            background-color: #e9ecef;
        }
        
        .selection-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .columns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .column-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .column-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .column-item.selected {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .column-item.sugarcane {
            border-left: 4px solid var(--sugarcane-color);
        }
        
        .column-item.activity {
            border-left: 4px solid var(--accent-color);
        }
        
        .column-item.project {
            border-left: 4px solid var(--project-color);
        }
        
        .column-item.fertilizer {
            border-left: 4px solid var(--fertilizer-color);
        }
        
        .column-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .column-info {
            flex: 1;
        }
        
        .column-name {
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .column-type {
            font-size: 0.8rem;
            color: #666;
            background-color: #f0f0f0;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .column-stats {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }
        
        .selected-summary {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--success-color);
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* Data Type Configuration */
        .data-type-configuration {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
            display: none;
        }
        
        .data-type-configuration h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .config-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .data-type-table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .data-type-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .data-type-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }
        
        .data-type-table th:hover {
            background-color: var(--secondary-color);
        }
        
        .data-type-table th i {
            margin-left: 5px;
            opacity: 0.7;
        }
        
        .data-type-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .type-select, .format-select, .unit-select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: 'Prompt', sans-serif;
            background: white;
        }
        
        .type-select:focus, .format-select:focus, .unit-select:focus {
            border-color: var(--accent-color);
            outline: none;
        }
        
        .data-sample-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Data Table */
        .data-table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            border: 1px solid #dee2e6;
            border-bottom: none;
        }
        
        .table-info {
            display: flex;
            gap: 20px;
            color: #6c757d;
            font-size: 0.9rem;
            align-items: center;
        }
        
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        #dataStatus {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
        }
        
        #dataStatus:hover {
            opacity: 0.9;
        }
        
        .data-table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            background: white;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--primary-color);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--secondary-color);
        }
        
        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }
        
        .data-table tr:hover td {
            background: #f8f9fa;
        }
        
        /* Filter dropdown */
        .filter-dropdown {
            width: calc(100% - 10px);
            margin-top: 5px;
            padding: 4px 6px;
            font-size: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Prompt', sans-serif;
            background-color: white;
        }
        
        .filter-dropdown:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.2);
        }
        
        /* Animation สำหรับ highlight เซลล์ */
        @keyframes highlightCell {
            0% { background-color: #fff3e0; }
            50% { background-color: #ffecb3; }
            100% { background-color: transparent; }
        }
        
        .cell-highlight {
            animation: highlightCell 2s ease;
        }
        
        /* Cell Styling */
        .cell-error {
            background: rgba(247, 37, 133, 0.1) !important;
            color: var(--danger-color) !important;
            font-weight: 600;
            position: relative;
            cursor: pointer;
        }
        
        .cell-error:hover {
            background: rgba(247, 37, 133, 0.2) !important;
        }
        
        .cell-error:after {
            content: "!";
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .cell-warning {
            background: rgba(255, 152, 0, 0.1) !important;
            color: var(--warning-color) !important;
            cursor: pointer;
        }
        
        .cell-valid {
            color: var(--success-color);
        }
        
        .cell-editing {
            background: #fffde7 !important;
            border: 2px solid var(--accent-color) !important;
        }
        
        /* Cell Editor Modal */
        .cell-editor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .cell-editor-modal.show {
            display: flex;
        }
        
        .cell-editor-modal .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-header h4 {
            margin: 0;
            color: var(--secondary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6c757d;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .cell-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .cell-info p {
            margin: 5px 0;
            color: #495057;
        }
        
        .error-text {
            color: var(--danger-color) !important;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.1);
        }
        
        .suggestions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        
        .suggestion-item {
            background: #e3f2fd;
            color: var(--primary-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .suggestion-item:hover {
            background: #bbdefb;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 25px;
            border-radius: 30px;
            border: none;
            font-family: 'Kanit', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3d8b40;
            transform: translateY(-2px);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        /* Loading Spinner */
        .spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 30px;
            color: #666;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .step-navigation {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            
            .step {
                width: 100%;
                max-width: 300px;
            }
            
            .step-content {
                padding: 30px 20px;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .panel-header h2 {
                font-size: 1.5rem;
            }
            
            .upload-area {
                padding: 40px 15px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .navigation-buttons button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-seedling"></i> ระบบ Clean Data สำหรับข้อมูลอ้อย</h1>
            <p class="subtitle">ระบบตรวจสอบข้อมูลอ้อยครบวงจร - แบบขั้นตอนการใช้งาน</p>
        </header>
        
        <!-- Step Navigation -->
        <div class="step-navigation">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-info">
                    <div class="step-title">อัปโหลดไฟล์ CSV</div>
                    <div class="step-description">อัปโหลดไฟล์ข้อมูลของคุณ</div>
                </div>
            </div>
            
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-info">
                    <div class="step-title">เลือกคอลัมน์ที่ต้องการ</div>
                    <div class="step-description">ค้นหาและเลือกคอลัมน์ที่ต้องการตรวจสอบ</div>
                </div>
            </div>
            
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-info">
                    <div class="step-title">ตรวจสอบและแก้ไขข้อมูล</div>
                    <div class="step-description">ตรวจสอบและแก้ไขข้อมูลที่เลือก</div>
                </div>
            </div>
            
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div class="step-info">
                    <div class="step-title">ตรวจสอบเงื่อนไข</div>
                    <div class="step-description">ตรวจสอบเงื่อนไขเฉพาะข้อมูลอ้อย</div>
                </div>
            </div>
            
            <div class="step" id="step5">
                <div class="step-number">5</div>
                <div class="step-info">
                    <div class="step-title">เลือกคอลัมน์สำหรับส่งออก</div>
                    <div class="step-description">เลือกคอลัมน์ที่ต้องการส่งออก</div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Summary -->
        <div class="dashboard-summary" id="dashboardSummary" style="display: none;">
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="summary-content">
                        <h4>ข้อมูลถูกต้อง</h4>
                        <div class="summary-value" id="correctDataPercent">0%</div>
                        <div class="summary-progress">
                            <div class="progress-bar">
                                <div class="progress-fill success" id="correctDataBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon warning">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="summary-content">
                        <h4>ต้องตรวจสอบ</h4>
                        <div class="summary-value" id="needReviewCount">0</div>
                        <button class="btn btn-sm btn-outline" id="showReviewBtn" style="margin-top: 5px; display: none;">
                            <i class="fas fa-eye"></i> แสดง
                        </button>
                        <div class="summary-progress">
                            <div class="progress-bar">
                                <div class="progress-fill warning" id="needReviewBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon error">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="summary-content">
                        <h4>ข้อผิดพลาด</h4>
                        <div class="summary-value" id="errorDataCount">0</div>
                        <div class="progress-bar">
                            <div class="progress-fill error" id="errorDataBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon info">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="summary-content">
                        <h4>แก้ไขแล้ว</h4>
                        <div class="summary-value" id="editedCellsCount">0</div>
                        <div class="progress-bar">
                            <div class="progress-fill info" id="editedCellsBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="summary-actions">
                <button class="btn btn-primary btn-sm" id="refreshDashboard">
                    <i class="fas fa-sync-alt"></i> อัพเดต Dashboard
                </button>
                <button class="btn btn-success btn-sm" id="fixAllErrors">
                    <i class="fas fa-robot"></i> AI แก้ไขข้อผิดพลาดทั้งหมด
                </button>
            </div>
        </div>
        
        <!-- Step Content -->
        <div class="step-content">
            <!-- Step 1: Upload CSV File -->
            <div class="step-panel active" id="panel1">
                <div class="panel-header">
                    <h2><i class="fas fa-file-upload"></i> อัปโหลดไฟล์ CSV</h2>
                    <p>อัปโหลดไฟล์ข้อมูลอ้อยของคุณในรูปแบบ CSV (สูงสุด 500MB)</p>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-file-csv"></i>
                    <h3>ลากไฟล์ CSV ของคุณมาวางที่นี่</h3>
                    <p>หรือคลิกเพื่อเลือกไฟล์จากคอมพิวเตอร์ของคุณ</p>
                    <p><strong>รองรับไฟล์ขนาดใหญ่ถึง 500MB</strong></p>
                    <input type="file" id="csvFileInput" class="file-input" accept=".csv" style="display: none;">
                    <button class="btn btn-primary" id="browseBtn">
                        <i class="fas fa-folder-open"></i> เลือกไฟล์ CSV
                    </button>
                </div>
                
                <div class="file-info" id="fileInfo">
                    <h4><i class="fas fa-info-circle"></i> ข้อมูลไฟล์</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>ชื่อไฟล์:</strong>
                            <span id="fileName">-</span>
                        </div>
                        <div class="info-item">
                            <strong>ขนาดไฟล์:</strong>
                            <span id="fileSize">-</span>
                        </div>
                        <div class="info-item">
                            <strong>จำนวนแถว:</strong>
                            <span id="fileRows">-</span>
                        </div>
                        <div class="info-item">
                            <strong>จำนวนคอลัมน์:</strong>
                            <span id="fileCols">-</span>
                        </div>
                    </div>
                </div>
                
                <div id="loadingSpinner" class="spinner" style="display: none;"></div>
                
                <div class="navigation-buttons">
                    <div></div>
                    <button class="btn btn-success" id="nextToStep2" disabled>
                        ต่อไป <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Column Selection -->
            <div class="step-panel" id="panel2">
                <div class="panel-header">
                    <h2><i class="fas fa-columns"></i> เลือกคอลัมน์ที่ต้องการตรวจสอบ</h2>
                    <p>ค้นหาและเลือกคอลัมน์ที่ต้องการตรวจสอบจากทั้งหมด <span id="totalColumns">0</span> คอลัมน์</p>
                </div>
                
                <div class="column-selection-panel">
                    <div class="selection-header">
                        <div class="search-container">
                            <input type="text" id="columnSearch" class="search-box" placeholder="ค้นหาคอลัมน์...">
                        </div>
                        <div class="search-stats">
                            <span>พบ <span id="filteredCount">0</span> คอลัมน์</span>
                            <span>เลือกแล้ว <span id="selectedCount">0</span> คอลัมน์</span>
                        </div>
                    </div>
                    
                    <div class="selection-controls">
                        <button class="selection-btn active" data-filter="all">ทั้งหมด</button>
                        <button class="selection-btn" data-filter="sugarcane">ข้อมูลอ้อย</button>
                        <button class="selection-btn" data-filter="activity">กิจกรรมงวด</button>
                        <button class="selection-btn" data-filter="project">โครงการ</button>
                        <button class="selection-btn" data-filter="fertilizer">ปุ๋ย</button>
                        <button class="selection-btn" data-filter="selected">ที่เลือกแล้ว</button>
                        <button class="selection-btn" data-filter="unselected">ยังไม่เลือก</button>
                    </div>
                    
                    <div class="columns-grid" id="columnsGrid">
                        <!-- Column items will be populated here -->
                    </div>
                    
                    <div class="selected-summary">
                        <div>
                            <h4><i class="fas fa-check-circle"></i> คุณเลือกคอลัมน์แล้ว <span id="selectedSummaryCount">0</span> คอลัมน์</h4>
                            <p id="selectedColumnsList" style="font-size: 0.9rem; color: #666; margin-top: 5px;">ยังไม่ได้เลือกคอลัมน์</p>
                        </div>
                        <div>
                            <button class="btn btn-outline" id="selectAllBtn">
                                <i class="fas fa-check-double"></i> เลือกทั้งหมด
                            </button>
                            <button class="btn btn-outline" id="deselectAllBtn">
                                <i class="fas fa-times"></i> ยกเลิกทั้งหมด
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep1">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="nextToStep3" disabled>
                        ต่อไป <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Data Validation and Editing -->
            <div class="step-panel" id="panel3">
                <div class="panel-header">
                    <h2><i class="fas fa-search"></i> ตรวจสอบและแก้ไขข้อมูล</h2>
                    <p>AI ช่วยตรวจสอบข้อมูลและแสดงผลลัพธ์ คลิกที่เซลล์สีแดงเพื่อแก้ไขได้ทันที</p>
                </div>
                
                <!-- Data Type Configuration -->
                <div class="data-type-configuration" id="dataTypeConfig">
                    <h3><i class="fas fa-cogs"></i> กำหนดประเภทข้อมูลให้แต่ละคอลัมน์</h3>
                    <div class="config-controls">
                        <button class="btn btn-outline btn-sm" id="autoDetectTypes">
                            <i class="fas fa-robot"></i> ตรวจจับประเภทอัตโนมัติ
                        </button>
                        <button class="btn btn-success btn-sm" id="applyDataTypes">
                            <i class="fas fa-check"></i> ใช้การตั้งค่านี้
                        </button>
                    </div>
                    <div class="data-type-table-container">
                        <table class="data-type-table" id="dataTypeTable">
                            <thead>
                                <tr>
                                    <th>คอลัมน์</th>
                                    <th>ตัวอย่างข้อมูล</th>
                                    <th>ประเภทข้อมูล</th>
                                    <th>รูปแบบ</th>
                                    <th>หน่วย</th>
                                    <th>คำอธิบาย</th>
                                </tr>
                            </thead>
                            <tbody id="dataTypeTableBody">
                                <!-- จะถูกเพิ่มโดย JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Data Preview Table -->
                <div class="data-table-controls">
                    <div class="table-info">
                        <span><i class="fas fa-table"></i> แสดง <span id="currentRows">0</span>/<span id="totalRows">0</span> แถว</span>
                        <span><i class="fas fa-columns"></i> <span id="currentColumns">0</span> คอลัมน์</span>
                        <span id="dataStatus"></span>
                    </div>
                    
                    <div class="table-actions">
                        <button class="btn btn-outline btn-sm" id="toggleAllRows">
                            <i class="fas fa-expand"></i> แสดงทั้งหมด (<span id="totalRowCount">0</span>)
                        </button>
                        <button class="btn btn-outline btn-sm" id="exportTable">
                            <i class="fas fa-download"></i> ส่งออกตาราง
                        </button>
                        <button class="btn btn-outline btn-sm" id="showDataTypeConfig">
                            <i class="fas fa-cog"></i> กำหนดประเภทข้อมูล
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <table class="data-table" id="dataPreviewTable">
                        <thead id="dataTableHeader">
                            <!-- Headers will be populated by JavaScript -->
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="cell-editor-modal" id="cellEditorModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4><i class="fas fa-edit"></i> แก้ไขข้อมูลเซลล์</h4>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="cell-info">
                                <p><strong>คอลัมน์:</strong> <span id="editColumnName">-</span></p>
                                <p><strong>แถวที่:</strong> <span id="editRowNumber">-</span></p>
                                <p><strong>ปัญหาที่พบ:</strong> <span id="editIssue" class="error-text">-</span></p>
                            </div>
                            
                            <div class="form-group">
                                <label for="cellValueInput">ค่าใหม่:</label>
                                <input type="text" id="cellValueInput" class="form-control" placeholder="ป้อนค่าใหม่...">
                                <div class="suggestions" id="valueSuggestions">
                                    <!-- Suggestions will be added here -->
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="correctionReason">เหตุผลในการแก้ไข:</label>
                                <select id="correctionReason" class="form-control">
                                    <option value="">เลือกเหตุผล</option>
                                    <option value="format_error">รูปแบบไม่ถูกต้อง</option>
                                    <option value="invalid_value">ค่าที่ใช้ไม่ได้</option>
                                    <option value="out_of_range">ไม่อยู่ในช่วงที่กำหนด</option>
                                    <option value="typo_error">พิมพ์ผิด</option>
                                    <option value="other">อื่นๆ</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" id="cancelEdit">ยกเลิก</button>
                            <button class="btn btn-success" id="saveEdit">บันทึกการแก้ไข</button>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep2">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="nextToStep4" disabled>
                        <i class="fas fa-arrow-right"></i> ดำเนินการต่อ
                    </button>
                </div>
            </div>
            
            <!-- Step 4: Condition Checking -->
            <div class="step-panel" id="panel4">
                <div class="panel-header">
                    <h2><i class="fas fa-search"></i> ตรวจสอบเงื่อนไขข้อมูลอ้อย</h2>
                    <p>เลือกเงื่อนไขที่ต้องการตรวจสอบ และดูผลการตรวจสอบในตารางด้านล่าง</p>
                </div>
                
                <!-- ปุ่มเลือกเงื่อนไข -->
                <div class="condition-selection">
                    <h3><i class="fas fa-filter"></i> เลือกเงื่อนไขที่ต้องการตรวจสอบ</h3>
                    <div class="condition-buttons">
                        <button class="condition-select-btn active" data-condition="sugarcane">
                            <i class="fas fa-seedling"></i> ประเภทอ้อย
                            <span class="condition-desc">(ต้องมีคอลัมน์: ชื่อประเภทอ้อย, วันที่ปลูก)</span>
                        </button>
                        <button class="condition-select-btn" data-condition="fertilizer">
                            <i class="fas fa-prescription-bottle"></i> ปุ๋ย
                            <span class="condition-desc">(ต้องมีคอลัมน์ที่เกี่ยวข้องกับปุ๋ย)</span>
                        </button>
                    </div>
                </div>
                
                <!-- ข้อมูลการตรวจสอบ -->
                <div class="checking-controls">
                    <div class="checking-info">
                        <h4><i class="fas fa-info-circle"></i> สถานะการตรวจสอบ</h4>
                        <div class="checking-stats">
                            <span>เงื่อนไขที่เลือก: <strong id="selectedCondition">ประเภทอ้อย</strong></span>
                            <span>ตรวจพบ: <strong id="foundIssues">0</strong> ปัญหา</span>
                            <span>ผ่าน: <strong id="passedChecks">0</strong> รายการ</span>
                            <span>ไม่ผ่าน: <strong id="failedChecks">0</strong> รายการ</span>
                            <span>แสดง: <strong id="checkingRowsCount">0</strong> แถวทั้งหมด</span>
                        </div>
                    </div>
                    <div class="checking-actions">
                        <button class="btn btn-primary" id="runSelectedCheck">
                            <i class="fas fa-play"></i> เริ่มตรวจสอบเงื่อนไขที่เลือก
                        </button>
                        <button class="btn btn-success" id="runAllChecks">
                            <i class="fas fa-play-circle"></i> ตรวจสอบเงื่อนไขทั้งหมด
                        </button>
                        <button class="btn btn-outline" id="exportCheckResults">
                            <i class="fas fa-download"></i> ส่งออกผลตรวจสอบ
                        </button>
                    </div>
                </div>
                
                <!-- ตารางแสดงข้อมูลและผลตรวจสอบ -->
                <div class="checking-table-container">
                    <div class="table-controls">
                        <div class="table-info">
                            <span><i class="fas fa-table"></i> ตารางผลการตรวจสอบเงื่อนไข</span>
                        </div>
                    </div>
                    
                    <div class="checking-table-wrapper">
                        <table class="checking-table" id="checkingTable">
                            <thead id="checkingTableHeader">
                                <!-- Headers will be populated by JavaScript -->
                            </thead>
                            <tbody id="checkingTableBody">
                                <!-- ข้อมูลจะถูกเพิ่มโดย JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- รายละเอียดการตรวจสอบ -->
                <div class="checking-details">
                    <h4><i class="fas fa-list-alt"></i> รายละเอียดผลการตรวจสอบ</h4>
                    <div class="checking-results" id="checkingResults">
                        <div class="result-summary">
                            <p><i class="fas fa-info-circle"></i> กดปุ่มด้านบนเพื่อเริ่มตรวจสอบเงื่อนไข</p>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep3">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="nextToStep5">
                        <i class="fas fa-arrow-right"></i> ดำเนินการต่อ
                    </button>
                </div>
            </div>
            
            <!-- Step 5: Column Selection for Export -->
            <div class="step-panel" id="panel5">
                <div class="panel-header">
                    <h2><i class="fas fa-download"></i> เลือกคอลัมน์สำหรับส่งออก</h2>
                    <p>เลือกคอลัมน์ที่ต้องการส่งออกหลังจากผ่านการตรวจสอบทั้งหมดแล้ว</p>
                </div>
                
                <div class="export-column-selection">
                    <h3><i class="fas fa-check-circle"></i> เลือกคอลัมน์ที่ต้องการส่งออก</h3>
                    <p>ระบบได้เลือกคอลัมน์พื้นฐานที่จำเป็นให้อัตโนมัติแล้ว คุณสามารถเพิ่ม/ลดคอลัมน์อื่นๆ ได้ตามต้องการ</p>
                    
                    <div class="selection-controls">
                        <button class="selection-btn active" data-filter="all">ทั้งหมด</button>
                        <button class="selection-btn" data-filter="recommended">แนะนำ</button>
                        <button class="selection-btn" data-filter="selected">ที่เลือกแล้ว</button>
                        <button class="selection-btn" data-filter="unselected">ยังไม่เลือก</button>
                    </div>
                    
                    <div class="export-column-list" id="exportColumnsGrid">
                        <!-- Column items will be populated here -->
                    </div>
                    
                    <div class="selected-summary">
                        <div>
                            <h4><i class="fas fa-check-circle"></i> คุณเลือกคอลัมน์แล้ว <span id="exportSelectedCount">0</span> คอลัมน์</h4>
                            <p id="exportColumnsList" style="font-size: 0.9rem; color: #666; margin-top: 5px;">ยังไม่ได้เลือกคอลัมน์</p>
                        </div>
                        <div>
                            <button class="btn btn-outline" id="exportSelectAllBtn">
                                <i class="fas fa-check-double"></i> เลือกทั้งหมด
                            </button>
                            <button class="btn btn-outline" id="exportDeselectAllBtn">
                                <i class="fas fa-times"></i> ยกเลิกทั้งหมด
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep4">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="downloadCleanData">
                        <i class="fas fa-download"></i> ดาวน์โหลดข้อมูลที่ Clean แล้ว
                    </button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2023 ระบบ Clean Data สำหรับข้อมูลอ้อย - ตรวจสอบประเภทข้อมูลและเงื่อนไขครบวงจร</p>
        </footer>
    </div>

    <script>
        // ตัวแปรสำหรับระบบกรองข้อมูล
        let uploadedDataForFilter = null;
        let filteredData = null;
        let filterStepsResults = {};
        
        // ข้อมูลสำหรับการตรวจสอบ
        const sugarcaneTypes = [
            "ปลายฝนขยาย", 
            "ปลายฝนรื้อตอ", 
            "ตอ1", 
            "ตอ2", 
            "ตอ3", 
            "ต้นฝนขยาย", 
            "ต้นฝนรื้อตอ", 
            "พื้นที่เสียหาย", 
            ">ตอ3"
        ];
        
        const sugarcaneNumbers = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];
        const fertilizerTypes = ["ปุ๋ยเคมี", "ปุ๋ยอินทรีย์", "ปุ๋ยชีวภาพ", "ปุ๋ยหมัก", "ปุ๋ยคอก"];

        // ประเภทการใส่ปุ๋ยตามเงื่อนไขใหม่
        const fertilizerConditions = {
            "ปลายฝนขยาย": {
                period1: { minAge: 1, maxAge: 60, expected: "รองพื้น", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 3" }
            },
            "ปลายฝนรื้อตอ": {
                period1: { minAge: 1, maxAge: 60, expected: "รองพื้น", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 3" }
            },
            "ต้นฝนขยาย": {
                period1: { minAge: 1, maxAge: 60, expected: "รองพื้น", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 3" }
            },
            "ต้นฝนรื้อตอ": {
                period1: { minAge: 1, maxAge: 60, expected: "รองพื้น", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 3" }
            },
            "ตอ1": {
                period1: { minAge: 1, maxAge: 60, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่3", periodName: "งวด 3" }
            },
            "ตอ2": {
                period1: { minAge: 1, maxAge: 60, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่3", periodName: "งวด 3" }
            },
            "ตอ3": {
                period1: { minAge: 1, maxAge: 60, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่3", periodName: "งวด 3" }
            },
            ">ตอ3": {
                period1: { minAge: 1, maxAge: 60, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่3", periodName: "งวด 3" }
            }
        };
        
        // ประเภทข้อมูลที่รองรับ
        const dataTypes = ["text", "number", "date", "enum", "identifier"];
        
        // คอลัมน์ที่ต้องการเลือกอัตโนมัติสำหรับขั้นตอนที่ 5
        const autoExportColumns = [
            "โซน", "รหัสนักเกษตร", "ชื่อนักเกษตร", "ชื่อประเภทอ้อย", 
            "พื้นที่", "เลขโควต้า", "ชื่อชาวไร่", "เลขแปลงintech"
        ];
        
        // ตัวแปรเก็บข้อมูลหลัก
        let uploadedData = null;
        let allColumns = [];
        let selectedColumns = [];
        let exportColumns = [];
        let dataTypeConfigurations = {};
        let currentStep = 1;
        let currentFilter = "all";
        let currentColumnFilter = "all";
        let editedCells = {};
        
        // สำหรับ Dashboard และ Data Table
        let currentValidationResults = {};
        let cellValidationStatus = {};
        let editingCell = null;
        let totalCells = 0;
        
        // ตัวแปรเพิ่มเติม
        let userSelectedDataTypes = {};
        let isShowingAllRows = false;
        let currentRowLimit = 50;
        let dataTypeConfigVisible = false;
        
        // ตัวแปรสำหรับระบบตรวจสอบเงื่อนไข
        let currentCondition = "sugarcane";
        let conditionResults = {};
        let checkingTableData = [];
        let showOnlyFailed = false;
        
        // ============================================
        // อ้างอิงองค์ประกอบ DOM
        // ============================================
        const csvFileInput = document.getElementById('csvFileInput');
        const uploadArea = document.getElementById('uploadArea');
        const browseBtn = document.getElementById('browseBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileRows = document.getElementById('fileRows');
        const fileCols = document.getElementById('fileCols');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        // Step navigation
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const step5 = document.getElementById('step5');
        
        // Panels
        const panel1 = document.getElementById('panel1');
        const panel2 = document.getElementById('panel2');
        const panel3 = document.getElementById('panel3');
        const panel4 = document.getElementById('panel4');
        const panel5 = document.getElementById('panel5');
        
        // Navigation buttons
        const nextToStep2 = document.getElementById('nextToStep2');
        const nextToStep3 = document.getElementById('nextToStep3');
        const nextToStep4 = document.getElementById('nextToStep4');
        const nextToStep5 = document.getElementById('nextToStep5');
        const backToStep1 = document.getElementById('backToStep1');
        const backToStep2 = document.getElementById('backToStep2');
        const backToStep3 = document.getElementById('backToStep3');
        const backToStep4 = document.getElementById('backToStep4');
        const downloadCleanData = document.getElementById('downloadCleanData');
        
        // Column selection elements
        const totalColumns = document.getElementById('totalColumns');
        const filteredCount = document.getElementById('filteredCount');
        const selectedCount = document.getElementById('selectedCount');
        const selectedSummaryCount = document.getElementById('selectedSummaryCount');
        const selectedColumnsList = document.getElementById('selectedColumnsList');
        const columnSearch = document.getElementById('columnSearch');
        const columnsGrid = document.getElementById('columnsGrid');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const columnFilterButtons = document.querySelectorAll('.selection-btn');
        
        // Dashboard elements
        const dashboardSummary = document.getElementById('dashboardSummary');
        const correctDataPercent = document.getElementById('correctDataPercent');
        const needReviewCount = document.getElementById('needReviewCount');
        const errorDataCount = document.getElementById('errorDataCount');
        const editedCellsCount = document.getElementById('editedCellsCount');
        const correctDataBar = document.getElementById('correctDataBar');
        const needReviewBar = document.getElementById('needReviewBar');
        const errorDataBar = document.getElementById('errorDataBar');
        const editedCellsBar = document.getElementById('editedCellsBar');
        const refreshDashboard = document.getElementById('refreshDashboard');
        const fixAllErrors = document.getElementById('fixAllErrors');
        const showReviewBtn = document.getElementById('showReviewBtn');
        
        // Data Table elements
        const dataTableHeader = document.getElementById('dataTableHeader');
        const dataTableBody = document.getElementById('dataTableBody');
        const cellEditorModal = document.getElementById('cellEditorModal');
        const editColumnName = document.getElementById('editColumnName');
        const editRowNumber = document.getElementById('editRowNumber');
        const editIssue = document.getElementById('editIssue');
        const cellValueInput = document.getElementById('cellValueInput');
        const valueSuggestions = document.getElementById('valueSuggestions');
        const saveEdit = document.getElementById('saveEdit');
        const cancelEdit = document.getElementById('cancelEdit');
        const closeModal = document.querySelector('.close-modal');
        const dataStatus = document.getElementById('dataStatus');
        const showAllRows = document.getElementById('toggleAllRows');
        const exportTable = document.getElementById('exportTable');
        const currentRows = document.getElementById('currentRows');
        const totalRows = document.getElementById('totalRows');
        const currentColumns = document.getElementById('currentColumns');
        const totalRowCount = document.getElementById('totalRowCount');
        
        // Data Type Configuration elements
        const dataTypeConfig = document.getElementById('dataTypeConfig');
        const dataTypeTableBody = document.getElementById('dataTypeTableBody');
        const autoDetectTypes = document.getElementById('autoDetectTypes');
        const applyDataTypes = document.getElementById('applyDataTypes');
        const showDataTypeConfig = document.getElementById('showDataTypeConfig');
        
        // Step 4 elements
        const runSelectedCheck = document.getElementById('runSelectedCheck');
        const runAllChecks = document.getElementById('runAllChecks');
        const exportCheckResults = document.getElementById('exportCheckResults');
        const checkingRowsCount = document.getElementById('checkingRowsCount');
        const foundIssues = document.getElementById('foundIssues');
        const passedChecks = document.getElementById('passedChecks');
        const failedChecks = document.getElementById('failedChecks');
        
        // Step 5 elements
        const exportColumnsGrid = document.getElementById('exportColumnsGrid');
        const exportSelectedCount = document.getElementById('exportSelectedCount');
        const exportColumnsList = document.getElementById('exportColumnsList');
        const exportSelectAllBtn = document.getElementById('exportSelectAllBtn');
        const exportDeselectAllBtn = document.getElementById('exportDeselectAllBtn');
        
        // ============================================
        // ฟังก์ชันจัดการขั้นตอน
        // ============================================
        function goToStep(stepNumber) {
            currentStep = stepNumber;
            
            [step1, step2, step3, step4, step5].forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
            
            [panel1, panel2, panel3, panel4, panel5].forEach((panel, index) => {
                panel.classList.remove('active');
                if (index + 1 === stepNumber) {
                    panel.classList.add('active');
                }
            });
            
            if (stepNumber === 3) {
                dashboardSummary.style.display = 'block';
                initDataValidationSystem();
            } else {
                dashboardSummary.style.display = 'none';
            }
            
            if (stepNumber === 4) {
                setTimeout(initConditionChecking, 100);
            }
            
            if (stepNumber === 5) {
                setTimeout(initExportColumnSelection, 100);
            }
        }
        
        // ============================================
        // ขั้นตอนที่ 1: อัปโหลดไฟล์ CSV
        // ============================================
        browseBtn.onclick = function() {
            csvFileInput.click();
        };
        
        uploadArea.onclick = function(event) {
            if (event.target !== browseBtn && !browseBtn.contains(event.target)) {
                csvFileInput.click();
            }
        };
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary-color)';
            uploadArea.style.backgroundColor = 'rgba(76, 201, 240, 0.1)';
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--accent-color)';
            uploadArea.style.backgroundColor = 'rgba(76, 201, 240, 0.05)';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--accent-color)';
            uploadArea.style.backgroundColor = 'rgba(76, 201, 240, 0.05)';
            
            if (e.dataTransfer.files.length) {
                csvFileInput.files = e.dataTransfer.files;
                handleFileUpload(csvFileInput.files[0]);
            }
        });
        
        csvFileInput.addEventListener('change', function(e) {
            if (this.files.length === 0) return;
            handleFileUpload(this.files[0]);
        });
        
        function handleFileUpload(file) {
            if (!file) return;
            
            const maxSize = 500 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('ไฟล์มีขนาดใหญ่เกินไป กรุณาเลือกไฟล์ขนาดไม่เกิน 500MB');
                csvFileInput.value = '';
                return;
            }
            
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            loadingSpinner.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const csvText = event.target.result;
                    processCSVData(csvText, file.name);
                } catch (error) {
                    alert('เกิดข้อผิดพลาดในการอ่านไฟล์: ' + error.message);
                    loadingSpinner.style.display = 'none';
                }
            };
            
            reader.onerror = function() {
                alert('เกิดข้อผิดพลาดในการอ่านไฟล์');
                loadingSpinner.style.display = 'none';
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function processCSVData(csvText, fileName) {
            try {
                const lines = csvText.split('\n');
                if (lines.length === 0) {
                    throw new Error('ไฟล์ว่างเปล่า');
                }
                
                const headers = parseCSVLine(lines[0]);
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const values = parseCSVLine(lines[i]);
                    const row = {};
                    
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    
                    data.push(row);
                }
                
                uploadedData = {
                    headers: headers,
                    data: data,
                    fileName: fileName,
                    totalRows: data.length,
                    totalCols: headers.length,
                    originalCSV: csvText
                };
                
                fileRows.textContent = data.length;
                fileCols.textContent = headers.length;
                fileInfo.classList.add('show');
                loadingSpinner.style.display = 'none';
                nextToStep2.disabled = false;
                
                console.log('โหลดข้อมูลสำเร็จ:', uploadedData);
            } catch (error) {
                alert('รูปแบบไฟล์ CSV ไม่ถูกต้อง: ' + error.message);
                loadingSpinner.style.display = 'none';
            }
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (i + 1 < line.length && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        // ============================================
        // ขั้นตอนที่ 2: เลือกคอลัมน์
        // ============================================
        nextToStep2.addEventListener('click', function() {
            if (!uploadedData) {
                alert('กรุณาอัปโหลดไฟล์ก่อน');
                return;
            }
            
            prepareColumnSelection();
            goToStep(2);
        });
        
        function prepareColumnSelection() {
            allColumns = [...uploadedData.headers];
            selectedColumns = [...allColumns];
            
            totalColumns.textContent = allColumns.length;
            renderColumnGrid();
            updateColumnStats();
            nextToStep3.disabled = false;
        }
        
        function renderColumnGrid() {
            columnsGrid.innerHTML = '';
            
            const searchTerm = columnSearch.value.toLowerCase();
            
            allColumns.forEach(column => {
                const columnNameLower = column.toLowerCase();
                const isSelected = selectedColumns.includes(column);
                const matchesSearch = searchTerm === '' || columnNameLower.includes(searchTerm);
                
                let columnType = '';
                let columnClass = '';
                
                if (columnNameLower.includes('ประเภทอ้อย') || columnNameLower.includes('sugarcane') || 
                    columnNameLower.includes('พันธุ์') || columnNameLower.includes('type')) {
                    columnType = 'ข้อมูลอ้อย';
                    columnClass = 'sugarcane';
                } else if (columnNameLower.includes('อายุ') || columnNameLower.includes('age') ||
                          columnNameLower.includes('งวด') || columnNameLower.includes('period') ||
                          columnNameLower.includes('กิจกรรม') || columnNameLower.includes('activity')) {
                    columnType = 'กิจกรรมงวด';
                    columnClass = 'activity';
                } else if (columnNameLower.includes('โครงการ') || columnNameLower.includes('project')) {
                    columnType = 'โครงการ';
                    columnClass = 'project';
                } else if (columnNameLower.includes('ปุ๋ย') || columnNameLower.includes('fertilizer') ||
                          columnNameLower.includes('ยา') || columnNameLower.includes('chemical')) {
                    columnType = 'ปุ๋ย';
                    columnClass = 'fertilizer';
                } else if (columnNameLower.includes('วันที่') || columnNameLower.includes('date')) {
                    columnType = 'วันที่';
                } else if (columnNameLower.includes('รหัส') || columnNameLower.includes('code') || 
                          columnNameLower.includes('id') || columnNameLower.includes('หมายเลข')) {
                    columnType = 'รหัส';
                } else if (columnNameLower.includes('จำนวน') || columnNameLower.includes('quantity') ||
                          columnNameLower.includes('ปริมาณ') || columnNameLower.includes('amount') ||
                          columnNameLower.includes('พื้นที่') || columnNameLower.includes('area')) {
                    columnType = 'จำนวน';
                } else if (columnNameLower === 'lat' || columnNameLower === 'latitude') {
                    columnType = 'พิกัด lat';
                    columnClass = 'sugarcane';
                } else if (columnNameLower === 'long' || columnNameLower === 'longitude') {
                    columnType = 'พิกัด long';
                    columnClass = 'sugarcane';
                } else {
                    columnType = 'ข้อมูลทั่วไป';
                }
                
                let shouldShow = matchesSearch;
                
                if (currentColumnFilter === 'selected') {
                    shouldShow = shouldShow && isSelected;
                } else if (currentColumnFilter === 'unselected') {
                    shouldShow = shouldShow && !isSelected;
                } else if (currentColumnFilter !== 'all') {
                    shouldShow = shouldShow && columnClass === currentColumnFilter;
                }
                
                const sampleValues = uploadedData.data.slice(0, 5).map(row => row[column]);
                const emptyCount = sampleValues.filter(v => v === '').length;
                const fillRate = ((sampleValues.length - emptyCount) / sampleValues.length * 100).toFixed(0);
                
                const columnItem = document.createElement('div');
                columnItem.className = `column-item ${columnClass} ${isSelected ? 'selected' : ''}`;
                columnItem.style.display = shouldShow ? 'flex' : 'none';
                
                columnItem.innerHTML = `
                    <input type="checkbox" class="column-checkbox" ${isSelected ? 'checked' : ''} data-column="${column}">
                    <div class="column-info">
                        <div class="column-name" title="${column}">${column}</div>
                        <span class="column-type">${columnType}</span>
                        <div class="column-stats">
                            <i class="fas fa-database"></i> มีข้อมูล ${fillRate}%
                        </div>
                    </div>
                `;
                
                columnsGrid.appendChild(columnItem);
                
                const checkbox = columnItem.querySelector('.column-checkbox');
                checkbox.addEventListener('change', function() {
                    const columnName = this.dataset.column;
                    
                    if (this.checked) {
                        if (!selectedColumns.includes(columnName)) {
                            selectedColumns.push(columnName);
                        }
                    } else {
                        const index = selectedColumns.indexOf(columnName);
                        if (index > -1) {
                            selectedColumns.splice(index, 1);
                        }
                    }
                    
                    columnItem.classList.toggle('selected', this.checked);
                    updateColumnStats();
                    nextToStep3.disabled = selectedColumns.length === 0;
                });
            });
            
            updateFilteredCount();
        }
        
        function updateColumnStats() {
            selectedCount.textContent = selectedColumns.length;
            selectedSummaryCount.textContent = selectedColumns.length;
            
            if (selectedColumns.length === 0) {
                selectedColumnsList.textContent = 'ยังไม่ได้เลือกคอลัมน์';
            } else {
                const displayedColumns = selectedColumns.slice(0, 3);
                const moreCount = selectedColumns.length - 3;
                selectedColumnsList.textContent = displayedColumns.join(', ') + 
                    (moreCount > 0 ? ` และอีก ${moreCount} คอลัมน์...` : '');
            }
        }
        
        function updateFilteredCount() {
            const visibleColumns = Array.from(columnsGrid.querySelectorAll('.column-item'))
                .filter(item => item.style.display !== 'none');
            filteredCount.textContent = visibleColumns.length;
        }
        
        columnSearch.addEventListener('input', renderColumnGrid);
        
        columnFilterButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                columnFilterButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentColumnFilter = this.dataset.filter;
                renderColumnGrid();
            });
        });
        
        selectAllBtn.addEventListener('click', function() {
            const visibleColumns = Array.from(columnsGrid.querySelectorAll('.column-item'))
                .filter(item => item.style.display !== 'none');
            
            visibleColumns.forEach(item => {
                const checkbox = item.querySelector('.column-checkbox');
                const columnName = checkbox.dataset.column;
                
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    if (!selectedColumns.includes(columnName)) {
                        selectedColumns.push(columnName);
                    }
                    item.classList.add('selected');
                }
            });
            
            updateColumnStats();
            nextToStep3.disabled = selectedColumns.length === 0;
        });
        
        deselectAllBtn.addEventListener('click', function() {
            const visibleColumns = Array.from(columnsGrid.querySelectorAll('.column-item'))
                .filter(item => item.style.display !== 'none');
            
            visibleColumns.forEach(item => {
                const checkbox = item.querySelector('.column-checkbox');
                const columnName = checkbox.dataset.column;
                
                if (checkbox.checked) {
                    checkbox.checked = false;
                    const index = selectedColumns.indexOf(columnName);
                    if (index > -1) {
                        selectedColumns.splice(index, 1);
                    }
                    item.classList.remove('selected');
                }
            });
            
            updateColumnStats();
            nextToStep3.disabled = selectedColumns.length === 0;
        });
        
        // ============================================
        // ขั้นตอนที่ 3: ตรวจสอบประเภทข้อมูล
        // ============================================
        nextToStep3.addEventListener('click', function() {
            if (selectedColumns.length === 0) {
                alert('กรุณาเลือกคอลัมน์ที่ต้องการตรวจสอบ');
                return;
            }
            
            goToStep(3);
        });
        
        function initDataValidationSystem() {
            dashboardSummary.style.display = 'block';
            
            if (uploadedData && selectedColumns.length > 0) {
                runDataValidationFromUploadedData();
            }
        }
        
        function runDataValidationFromUploadedData() {
            if (!uploadedData || selectedColumns.length === 0) return;
            
            const removedCount = removeEmptyRows();
            if (removedCount > 0) {
                alert(`✅ ตัดแถวที่ว่างทั้งหมดออกแล้ว: ${removedCount} แถว`);
            }
            
            currentValidationResults = {
                totalCells: 0,
                validCells: 0,
                warningCells: 0,
                errorCells: 0,
                details: {}
            };
            
            cellValidationStatus = {};
            
            const sampleRows = uploadedData.data.slice(0, currentRowLimit);
            totalCells = sampleRows.length * selectedColumns.length;
            
            sampleRows.forEach((row, rowIndex) => {
                selectedColumns.forEach((columnName, colIndex) => {
                    const cellValue = row[columnName] || '';
                    
                    if (cellValue.trim() === '') {
                        if (!cellValidationStatus[rowIndex]) {
                            cellValidationStatus[rowIndex] = {};
                        }
                        cellValidationStatus[rowIndex][colIndex] = {
                            status: 'valid',
                            message: 'ค่าว่าง - ผ่าน',
                            suggestions: [],
                            dataType: 'text',
                            edited: false
                        };
                        
                        currentValidationResults.totalCells++;
                        currentValidationResults.validCells++;
                        return;
                    }
                    
                    const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, cellValue);
                    const validation = validateCellData(columnName, cellValue, columnType, rowIndex, colIndex);
                    
                    if (!cellValidationStatus[rowIndex]) {
                        cellValidationStatus[rowIndex] = {};
                    }
                    
                    cellValidationStatus[rowIndex][colIndex] = validation;
                    currentValidationResults.totalCells++;
                    
                    if (validation.status === 'valid') {
                        currentValidationResults.validCells++;
                    } else if (validation.status === 'warning') {
                        currentValidationResults.warningCells++;
                    } else if (validation.status === 'error') {
                        currentValidationResults.errorCells++;
                    }
                    
                    if (!currentValidationResults.details[columnName]) {
                        currentValidationResults.details[columnName] = {
                            errors: [],
                            warnings: []
                        };
                    }
                    
                    if (validation.status === 'error') {
                        currentValidationResults.details[columnName].errors.push({
                            row: rowIndex + 1,
                            value: cellValue,
                            message: validation.message
                        });
                    } else if (validation.status === 'warning') {
                        currentValidationResults.details[columnName].warnings.push({
                            row: rowIndex + 1,
                            value: cellValue,
                            message: validation.message
                        });
                    }
                });
            });
            
            renderDataTableFromUploadedData();
            updateDashboard();
        }
        
        function detectColumnType(columnName, sampleValue) {
            const columnNameLower = columnName.toLowerCase();
            
            if (columnNameLower === 'ชื่อประเภทอ้อย' || 
                columnNameLower.includes('ชื่อประเภทอ้อย')) {
                return 'text';
            }
            
            if (columnNameLower === 'ประเภทอ้อย' || 
                columnNameLower.includes('ประเภทอ้อย')) {
                return 'number';
            }
            
            if (columnNameLower.includes('ประวัติการใช้พื้นที่') || 
                columnNameLower.includes('ประวัติ') || 
                columnNameLower.includes('การใช้พื้นที่')) {
                return 'text';
            }
            
            if (columnNameLower.includes('ความเสี่ยงพื้นที่') || columnNameLower.includes('ความเสี่ยง')) {
                return 'text';
            }
            
            if (columnNameLower.includes('ความลาดเอียง') || columnNameLower.includes('ลาดเอียง') || columnNameLower.includes('slope')) {
                return 'text';
            }
            
            if (columnNameLower.includes('วันที่') || columnNameLower.includes('date') || 
                columnNameLower.includes('วัน') || columnNameLower.includes('month') || 
                columnNameLower.includes('year')) {
                return 'date';
            }
            
            if (columnNameLower.includes('จำนวน') || columnNameLower.includes('quantity') ||
                columnNameLower.includes('ปริมาณ') || columnNameLower.includes('amount') ||
                columnNameLower.includes('น้ำหนัก') || columnNameLower.includes('weight') ||
                columnNameLower.includes('พื้นที่') || columnNameLower.includes('area') ||
                columnNameLower.includes('ราคา') || columnNameLower.includes('price') ||
                columnNameLower === 'lat' || columnNameLower === 'latitude' ||
                columnNameLower === 'long' || columnNameLower === 'longitude') {
                return 'number';
            }
            
            if (columnNameLower.includes('รหัส') || columnNameLower.includes('code') || 
                columnNameLower.includes('id') || columnNameLower.includes('หมายเลข') ||
                columnNameLower.includes('เลขที่') || columnNameLower.includes('no.')) {
                return 'identifier';
            }
            
            if (columnNameLower.includes('ประเภท') || columnNameLower.includes('type') ||
                columnNameLower.includes('สถานะ') || columnNameLower.includes('status') ||
                columnNameLower.includes('ใช่/ไม่') || columnNameLower.includes('yes/no') ||
                columnNameLower.includes('ระดับ') || columnNameLower.includes('level') ||
                columnNameLower.includes('การจัด') || columnNameLower.includes('category')) {
                return 'enum';
            }
            
            if (sampleValue === '' || sampleValue === null || sampleValue === undefined) {
                return 'text';
            }
            
            const numValue = parseFloat(sampleValue);
            if (!isNaN(numValue) && sampleValue.trim() !== '' && 
                !isNaN(parseFloat(sampleValue)) && isFinite(sampleValue)) {
                return 'number';
            }
            
            const datePatterns = [
                /^\d{4}-\d{1,2}-\d{1,2}$/,
                /^\d{4}\/\d{1,2}\/\d{1,2}$/,
                /^\d{1,2}\/\d{1,2}\/\d{4}$/,
                /^\d{1,2}-\d{1,2}-\d{4}$/
            ];
            
            if (datePatterns.some(pattern => pattern.test(sampleValue.trim()))) {
                return 'date';
            }
            
            const sampleLower = sampleValue.toLowerCase().trim();
            if (sampleLower === 'ใช่' || sampleLower === 'ไม่' || 
                sampleLower === 'yes' || sampleLower === 'no' ||
                sampleLower === 'true' || sampleLower === 'false') {
                return 'enum';
            }
            
            return 'text';
        }
        
        function validateCellData(columnName, value, columnType, rowIndex, colIndex) {
            const result = {
                status: 'valid',
                message: '',
                suggestions: [],
                dataType: columnType,
                edited: false
            };
            
            if (value === '' || value === null || value === undefined) {
                return result;
            }
            
            if (columnName.toLowerCase().includes('แปลงintech')) {
                return result;
            }
            
            if (columnName.toLowerCase() === 'ชื่อประเภทอ้อย') {
                const validTypes = [
                    "ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ตอ1", "ตอ2", "ตอ3", 
                    "ต้นฝนขยาย", "ต้นฝนรื้อตอ", "พื้นที่เสียหาย", ">ตอ3"
                ];
                
                if (!validTypes.includes(value.trim())) {
                    result.status = 'error';
                    result.message = `ต้องเป็นหนึ่งใน: ${validTypes.join(', ')}`;
                    result.suggestions = validTypes;
                }
                return result;
            }
            
            if (columnName.toLowerCase() === 'ประเภทอ้อย') {
                const validNumbers = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];
                
                const numValue = parseFloat(value);
                if (isNaN(numValue)) {
                    result.status = 'error';
                    result.message = 'ต้องเป็นตัวเลข';
                    result.suggestions = validNumbers;
                } else if (!validNumbers.includes(value.trim())) {
                    result.status = 'error';
                    result.message = `ต้องเป็นหนึ่งใน: ${validNumbers.join(', ')}`;
                    result.suggestions = validNumbers;
                }
                return result;
            }
            
            switch(columnType) {
                case 'number':
                    if (isNaN(value) || value.trim() === '') {
                        result.status = 'error';
                        result.message = 'ต้องเป็นตัวเลข';
                        
                        if (columnName.toLowerCase() === 'lat') {
                            result.suggestions = ['13.7563', '14.0790', '15.8700', '16.4393'];
                        } else if (columnName.toLowerCase() === 'long') {
                            result.suggestions = ['100.5018', '101.0037', '102.4956', '103.8499'];
                        } else if (columnName.includes('พื้นที่')) {
                            result.suggestions = ['10.0', '15.5', '20.0', '25.5'];
                        } else if (columnName.includes('อายุ')) {
                            result.suggestions = ['120', '150', '180', '210'];
                        } else if (columnName.includes('โควต้า')) {
                            result.suggestions = ['100', '150', '200', '250'];
                        } else {
                            result.suggestions = ['0', '10', '50', '100'];
                        }
                    } else {
                        const numValue = parseFloat(value);
                        
                        if (columnName.toLowerCase() === 'lat') {
                            if (numValue < -90 || numValue > 90) {
                                result.status = 'error';
                                result.message = 'latitude ต้องอยู่ระหว่าง -90 ถึง 90';
                                result.suggestions = ['13.7563', '14.0790', '15.8700', '16.4393'];
                            } else if (Math.abs(numValue) < 1 || Math.abs(numValue) > 99) {
                                result.status = 'warning';
                                result.message = 'latitude มักเป็นเลขหลักสิบ (13-17 สำหรับประเทศไทย)';
                                result.suggestions = ['13.7563', '14.0790', '15.8700', '16.4393'];
                            }
                        }
                        
                        if (columnName.toLowerCase() === 'long') {
                            if (numValue < -180 || numValue > 180) {
                                result.status = 'error';
                                result.message = 'longitude ต้องอยู่ระหว่าง -180 ถึง 180';
                                result.suggestions = ['100.5018', '101.0037', '102.4956', '103.8499'];
                            } else if (Math.abs(numValue) < 90 || Math.abs(numValue) > 110) {
                                result.status = 'warning';
                                result.message = 'longitude มักเป็นเลขหลักร้อย (100-104 สำหรับประเทศไทย)';
                                result.suggestions = ['100.5018', '101.0037', '102.4956', '103.8499'];
                            }
                        }
                        
                        if ((columnName.includes('พื้นที่') || columnName.includes('อายุ') || 
                             columnName.includes('จำนวน') || columnName.includes('โควต้า')) && numValue < 0) {
                            result.status = 'error';
                            result.message = 'ค่าต้องมากกว่าหรือเท่ากับ 0';
                            result.suggestions = ['0', '1', '10'];
                        }
                    }
                    break;
                    
                case 'date':
                    const datePatterns = [
                        /^\d{4}-\d{1,2}-\d{1,2}$/,
                        /^\d{4}\/\d{1,2}\/\d{1,2}$/,
                        /^\d{1,2}\/\d{1,2}\/\d{4}$/,
                        /^\d{1,2}-\d{1,2}-\d{4}$/
                    ];
                    
                    const isValidDate = datePatterns.some(pattern => pattern.test(value.trim()));
                    if (!isValidDate) {
                        result.status = 'error';
                        result.message = 'รูปแบบวันที่ไม่ถูกต้อง (รองรับ: YYYY/MM/DD, YYYY/M/D, DD/MM/YYYY)';
                        result.suggestions = ['2023/01/01', '2023/6/15', '2023/12/31'];
                    }
                    break;
                    
                case 'enum':
                    if (columnName.toLowerCase().includes('ใช่/ไม่') || columnName.toLowerCase().includes('yes/no')) {
                        const validValues = ['ใช่', 'ไม่', 'yes', 'no', 'true', 'false'];
                        if (!validValues.includes(value.toLowerCase())) {
                            result.status = 'error';
                            result.message = 'ต้องเป็น "ใช่" หรือ "ไม่"';
                            result.suggestions = ['ใช่', 'ไม่'];
                        }
                    }
                    break;
                    
                case 'identifier':
                    if (value.length > 50) {
                        result.status = 'warning';
                        result.message = 'รหัสยาวเกินไป';
                    }
                    break;
                    
                case 'text':
                    if (columnName.toLowerCase().includes('แปลงintech')) {
                        if (!/^\d+$/.test(value) && value.trim() !== '') {
                            result.status = 'warning';
                            result.message = 'เลขแปลงintech ควรเป็นตัวเลข';
                        }
                    } else if (value.length < 1 && value.trim() !== '') {
                        result.status = 'warning';
                        result.message = 'ข้อความสั้นเกินไป';
                    }
                    break;
            }
            
            return result;
        }
        
        function renderDataTableFromUploadedData() {
            dataTableHeader.innerHTML = '';
            dataTableBody.innerHTML = '';
            
            if (!uploadedData || selectedColumns.length === 0) return;
            
            const headerRow = document.createElement('tr');
            
            const rowNumHeader = document.createElement('th');
            rowNumHeader.textContent = '#';
            rowNumHeader.style.width = '50px';
            headerRow.appendChild(rowNumHeader);
            
            selectedColumns.forEach(columnName => {
                const th = document.createElement('th');
                th.textContent = columnName;
                headerRow.appendChild(th);
            });
            
            dataTableHeader.appendChild(headerRow);
            
            const displayRows = uploadedData.data.slice(0, currentRowLimit);
            totalRows.textContent = uploadedData.data.length;
            currentRows.textContent = Math.min(currentRowLimit, uploadedData.data.length);
            totalRowCount.textContent = uploadedData.data.length;
            
            displayRows.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                
                const rowNumCell = document.createElement('td');
                rowNumCell.textContent = rowIndex + 1;
                rowNumCell.style.fontWeight = 'bold';
                tr.appendChild(rowNumCell);
                
                selectedColumns.forEach((columnName, colIndex) => {
                    const td = document.createElement('td');
                    const cellValue = row[columnName] || '';
                    td.textContent = cellValue;
                    
                    const effectiveType = userSelectedDataTypes[columnName] || 
                                         detectColumnType(columnName, cellValue);
                    const validation = validateCellData(columnName, cellValue, effectiveType, rowIndex, colIndex);
                    
                    if (validation.status === 'error') {
                        td.className = 'cell-error cell-highlight';
                        td.title = validation.message;
                    } else if (validation.status === 'warning') {
                        td.className = 'cell-warning cell-highlight';
                        td.title = validation.message;
                    } else {
                        td.className = 'cell-valid';
                    }
                    
                    td.dataset.row = rowIndex;
                    td.dataset.col = colIndex;
                    td.dataset.column = columnName;
                    td.dataset.value = cellValue;
                    td.dataset.type = effectiveType;
                    
                    if (validation.status === 'error' || validation.status === 'warning') {
                        td.style.cursor = 'pointer';
                        td.addEventListener('click', () => openCellEditorForUploadedData(rowIndex, colIndex));
                    }
                    
                    tr.appendChild(td);
                });
                
                dataTableBody.appendChild(tr);
            });
            
            currentColumns.textContent = selectedColumns.length;
            updateDataStatus();
        }
        
        function updateDashboard() {
            const total = currentValidationResults.totalCells;
            const valid = currentValidationResults.validCells;
            const warning = currentValidationResults.warningCells;
            const error = currentValidationResults.errorCells;
            
            const validPercent = total > 0 ? Math.round((valid / total) * 100) : 0;
            const warningPercent = total > 0 ? Math.round((warning / total) * 100) : 0;
            const errorPercent = total > 0 ? Math.round((error / total) * 100) : 0;
            
            correctDataPercent.textContent = `${validPercent}%`;
            needReviewCount.textContent = warning;
            errorDataCount.textContent = error;
            
            if (warning > 0) {
                showReviewBtn.style.display = 'inline-block';
            } else {
                showReviewBtn.style.display = 'none';
            }
            
            correctDataBar.style.width = `${validPercent}%`;
            needReviewBar.style.width = `${warningPercent}%`;
            errorDataBar.style.width = `${errorPercent}%`;
            
            const editedCount = countEditedCells();
            editedCellsCount.textContent = editedCount;
            const editedPercent = total > 0 ? Math.round((editedCount / total) * 100) : 0;
            editedCellsBar.style.width = `${Math.min(editedPercent, 100)}%`;
            
            nextToStep4.disabled = validPercent !== 100 || error > 0;
        }
        
        function countEditedCells() {
            let count = 0;
            for (let rowIndex in cellValidationStatus) {
                for (let colIndex in cellValidationStatus[rowIndex]) {
                    if (cellValidationStatus[rowIndex][colIndex].edited) {
                        count++;
                    }
                }
            }
            return count;
        }
        
        function updateDataStatus() {
            const errorCount = currentValidationResults.errorCells;
            const warningCount = currentValidationResults.warningCells;
            
            if (errorCount > 0) {
                dataStatus.innerHTML = `<span style="cursor: pointer; text-decoration: underline;" id="showErrorsBtn">⚠️ มี ${errorCount} ข้อผิดพลาดที่ต้องแก้ไข</span>`;
                dataStatus.style.color = 'var(--danger-color)';
                dataStatus.style.backgroundColor = 'rgba(247, 37, 133, 0.1)';
            } else if (warningCount > 0) {
                dataStatus.textContent = `⚠️ มี ${warningCount} รายการที่ต้องตรวจสอบ`;
                dataStatus.style.color = 'var(--warning-color)';
                dataStatus.style.backgroundColor = 'rgba(255, 152, 0, 0.1)';
            } else {
                dataStatus.textContent = '✓ ข้อมูลถูกต้องทั้งหมด (100%)';
                dataStatus.style.color = 'var(--success-color)';
                dataStatus.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
            }
        }
        
        function removeEmptyRows() {
            if (!uploadedData || selectedColumns.length === 0) return 0;
            
            const originalRowCount = uploadedData.data.length;
            const filteredData = [];
            
            uploadedData.data.forEach(row => {
                let hasData = false;
                
                selectedColumns.forEach(columnName => {
                    const value = row[columnName] || '';
                    if (value.toString().trim() !== '') {
                        hasData = true;
                    }
                });
                
                if (hasData) {
                    filteredData.push(row);
                }
            });
            
            uploadedData.data = filteredData;
            uploadedData.totalRows = filteredData.length;
            
            const removedCount = originalRowCount - filteredData.length;
            return removedCount;
        }
        
        function setupEnhancedEventListeners() {
            refreshDashboard.addEventListener('click', () => {
                if (uploadedData) {
                    runDataValidationFromUploadedData();
                    updateDashboard();
                    updateDataStatus();
                    alert('✅ อัพเดต Dashboard เรียบร้อยแล้ว');
                }
            });
            
            fixAllErrors.addEventListener('click', () => {
                if (uploadedData) {
                    if (confirm('AI จะพยายามแก้ไขข้อผิดพลาดทั้งหมดอัตโนมัติ\nยืนยันดำเนินการ?')) {
                        autoFixAllErrorsForUploadedData();
                    }
                }
            });
            
            saveEdit.addEventListener('click', () => {
                if (uploadedData && editingCell) {
                    saveCellEditForUploadedData();
                }
            });
            
            cancelEdit.addEventListener('click', closeCellEditor);
            closeModal.addEventListener('click', closeCellEditor);
            
            cellEditorModal.addEventListener('click', (e) => {
                if (e.target === cellEditorModal) {
                    closeCellEditor();
                }
            });
            
            showDataTypeConfig.addEventListener('click', showDataTypeConfiguration);
            autoDetectTypes.addEventListener('click', autoDetectDataTypes);
            
            applyDataTypes.addEventListener('click', function() {
                dataTypeConfigVisible = false;
                dataTypeConfig.style.display = 'none';
                
                if (uploadedData) {
                    runDataValidationFromUploadedData();
                    alert('✅ ใช้การตั้งค่าประเภทข้อมูลเรียบร้อย!');
                }
            });
            
            showAllRows.addEventListener('click', toggleAllRows);
            exportTable.addEventListener('click', exportTableToCSV);
            
            nextToStep4.addEventListener('click', () => {
                if (currentValidationResults.errorCells > 0) {
                    alert('ยังมีข้อผิดพลาดที่ต้องแก้ไข กรุณาตรวจสอบเซลล์สีแดง');
                    return;
                }
                
                const validPercent = parseInt(correctDataPercent.textContent);
                if (validPercent !== 100) {
                    alert(`ข้อมูลถูกต้อง ${validPercent}% ยังไม่ครบ 100% กรุณาตรวจสอบและแก้ไขข้อมูลให้ถูกต้องทั้งหมด`);
                    return;
                }
                
                const editedCount = countEditedCells();
                alert(`✅ ตรวจสอบข้อมูลเสร็จสมบูรณ์\n✅ แก้ไขข้อมูลแล้ว: ${editedCount} เซลล์\n✅ ข้อมูลถูกต้อง: 100%\n\nกำลังไปยังขั้นตอนต่อไป...`);
                goToStep(4);
            });
        }
        
        function showDataTypeConfiguration() {
            dataTypeConfigVisible = true;
            dataTypeConfig.style.display = 'block';
            renderDataTypeConfigurationTable();
        }
        
        function renderDataTypeConfigurationTable() {
            if (!uploadedData || selectedColumns.length === 0) return;
            
            const tableBody = document.getElementById('dataTypeTableBody');
            tableBody.innerHTML = '';
            
            selectedColumns.forEach((columnName) => {
                const row = document.createElement('tr');
                
                const sampleValues = uploadedData.data.slice(0, 5).map(row => row[columnName] || '');
                const nonEmptySamples = sampleValues.filter(v => v.trim() !== '');
                const sampleText = nonEmptySamples.length > 0 ? nonEmptySamples[0] : '(ค่าว่าง)';
                
                const columnNameLower = columnName.toLowerCase();
                let currentType;
                
                if (columnNameLower === 'ชื่อประเภทอ้อย') {
                    currentType = 'text';
                } else if (columnNameLower === 'ประเภทอ้อย') {
                    currentType = 'number';
                } else {
                    const autoType = detectColumnType(columnName, sampleText);
                    currentType = userSelectedDataTypes[columnName] || autoType;
                }
                
                row.innerHTML = `
                    <td><strong>${columnName}</strong></td>
                    <td class="data-sample-cell" title="${sampleText}">${sampleText}</td>
                    <td>
                        <select class="type-select" data-column="${columnName}">
                            <option value="text" ${currentType === 'text' ? 'selected' : ''}>ข้อความ</option>
                            <option value="number" ${currentType === 'number' ? 'selected' : ''}>ตัวเลข</option>
                            <option value="date" ${currentType === 'date' ? 'selected' : ''}>วันที่</option>
                            <option value="enum" ${currentType === 'enum' ? 'selected' : ''}>ค่าที่กำหนด</option>
                            <option value="identifier" ${currentType === 'identifier' ? 'selected' : ''}>รหัส</option>
                        </select>
                    </td>
                    <td>
                        <select class="format-select" data-column="${columnName}">
                            <option value="default" selected>ค่าเริ่มต้น</option>
                        </select>
                    </td>
                    <td>
                        <select class="unit-select" data-column="${columnName}">
                            <option value="none" selected>ไม่มีหน่วย</option>
                        </select>
                    </td>
                    <td><input type="text" class="form-control" placeholder="คำอธิบาย..." value=""></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            document.querySelectorAll('.type-select').forEach(select => {
                select.addEventListener('change', function() {
                    const column = this.dataset.column;
                    userSelectedDataTypes[column] = this.value;
                });
            });
        }
        
        function autoDetectDataTypes() {
            if (!uploadedData || selectedColumns.length === 0) return;
            
            selectedColumns.forEach(columnName => {
                const columnNameLower = columnName.toLowerCase();
                
                if (columnNameLower === 'ชื่อประเภทอ้อย') {
                    userSelectedDataTypes[columnName] = 'text';
                } else if (columnNameLower === 'ประเภทอ้อย') {
                    userSelectedDataTypes[columnName] = 'number';
                } else {
                    const sampleValues = uploadedData.data.slice(0, 10).map(row => row[columnName] || '');
                    const nonEmptySamples = sampleValues.filter(v => v.trim() !== '');
                    
                    if (nonEmptySamples.length > 0) {
                        const detectedType = detectColumnType(columnName, nonEmptySamples[0]);
                        userSelectedDataTypes[columnName] = detectedType;
                    }
                }
            });
            
            renderDataTypeConfigurationTable();
            alert('✅ ตรวจจับประเภทข้อมูลอัตโนมัติเรียบร้อยแล้ว!');
        }
        
        function toggleAllRows() {
            isShowingAllRows = !isShowingAllRows;
            
            if (isShowingAllRows) {
                currentRowLimit = uploadedData.data.length;
                document.getElementById('toggleAllRows').innerHTML = 
                    `<i class="fas fa-compress"></i> ซ่อนบางส่วน (${currentRowLimit})`;
            } else {
                currentRowLimit = 50;
                document.getElementById('toggleAllRows').innerHTML = 
                    `<i class="fas fa-expand"></i> แสดงทั้งหมด (${uploadedData.data.length})`;
            }
            
            renderDataTableFromUploadedData();
        }
        
        function exportTableToCSV() {
            if (!uploadedData || selectedColumns.length === 0) return;
            
            const exportColumns = [...uploadedData.headers].filter(col => 
                selectedColumns.includes(col)
            );
            
            let csvContent = '';
            csvContent += '\ufeff';
            csvContent += exportColumns.join(',') + '\n';
            
            uploadedData.data.forEach(row => {
                const rowValues = exportColumns.map(col => {
                    let value = row[col] || '';
                    value = value.toString().replace(/"/g, '""');
                    
                    if (value.includes(',') || value.includes('\n') || value.includes('\r') || value.includes('"')) {
                        value = `"${value}"`;
                    }
                    
                    return value;
                });
                csvContent += rowValues.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `cleaned_${uploadedData.fileName.replace('.csv', '')}_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ ดาวน์โหลดไฟล์ CSV เรียบร้อย!\nจำนวนแถว: ${uploadedData.data.length}\nจำนวนคอลัมน์: ${exportColumns.length}`);
        }
        
        function openCellEditorForUploadedData(rowIndex, colIndex) {
            if (!uploadedData || !cellValidationStatus[rowIndex]) return;
            
            const columnName = selectedColumns[colIndex];
            const cell = document.querySelector(`td[data-row="${rowIndex}"][data-col="${colIndex}"]`);
            const currentValue = uploadedData.data[rowIndex][columnName] || '';
            const validation = cellValidationStatus[rowIndex][colIndex];
            
            editingCell = { rowIndex, colIndex, cell, columnName, currentValue, validation };
            
            editColumnName.textContent = columnName;
            editRowNumber.textContent = rowIndex + 1;
            editIssue.textContent = validation.message;
            editIssue.className = validation.status === 'error' ? 'error-text' : 'warning-text';
            cellValueInput.value = currentValue;
            
            valueSuggestions.innerHTML = '';
            
            if (columnName.toLowerCase() === 'ชื่อประเภทอ้อย') {
                const suggestions = [
                    "ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ตอ1", "ตอ2", "ตอ3", 
                    "ต้นฝนขยาย", "ต้นฝนรื้อตอ", "พื้นที่เสียหาย", ">ตอ3"
                ];
                suggestions.forEach(suggestion => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'suggestion-item';
                    btn.textContent = suggestion;
                    btn.addEventListener('click', () => {
                        cellValueInput.value = suggestion;
                    });
                    valueSuggestions.appendChild(btn);
                });
            } else if (columnName.toLowerCase() === 'ประเภทอ้อย') {
                const suggestions = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];
                suggestions.forEach(suggestion => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'suggestion-item';
                    btn.textContent = suggestion;
                    btn.addEventListener('click', () => {
                        cellValueInput.value = suggestion;
                    });
                    valueSuggestions.appendChild(btn);
                });
            } else if (validation.suggestions && validation.suggestions.length > 0) {
                validation.suggestions.forEach(suggestion => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'suggestion-item';
                    suggestionItem.textContent = suggestion;
                    suggestionItem.addEventListener('click', () => {
                        cellValueInput.value = suggestion;
                    });
                    valueSuggestions.appendChild(suggestionItem);
                });
            }
            
            cellEditorModal.classList.add('show');
            cellValueInput.focus();
        }
        
        function saveCellEditForUploadedData() {
            if (!editingCell || !uploadedData) return;
            
            const newValue = cellValueInput.value.trim();
            const { rowIndex, colIndex, cell, columnName, currentValue } = editingCell;
            
            uploadedData.data[rowIndex][columnName] = newValue;
            
            const newValidation = validateCellData(columnName, newValue, 'text', rowIndex, colIndex);
            newValidation.edited = true;
            cellValidationStatus[rowIndex][colIndex] = newValidation;
            
            cell.textContent = newValue;
            cell.dataset.value = newValue;
            
            cell.className = '';
            if (newValidation.status === 'error') {
                cell.className = 'cell-error cell-highlight';
                cell.title = newValidation.message;
            } else if (newValidation.status === 'warning') {
                cell.className = 'cell-warning cell-highlight';
                cell.title = newValidation.message;
            } else {
                cell.className = 'cell-valid';
            }
            
            if (newValidation.status === 'error' || newValidation.status === 'warning') {
                cell.style.cursor = 'pointer';
                cell.addEventListener('click', () => openCellEditorForUploadedData(rowIndex, colIndex));
            }
            
            runDataValidationFromUploadedData();
            updateDashboard();
            updateDataStatus();
            closeCellEditor();
        }
        
        function closeCellEditor() {
            cellEditorModal.classList.remove('show');
            editingCell = null;
            cellValueInput.value = '';
            valueSuggestions.innerHTML = '';
        }
        
        function autoFixAllErrorsForUploadedData() {
            if (!uploadedData) return;
            
            let fixedCount = 0;
            const sampleRows = uploadedData.data.slice(0, currentRowLimit);
            
            sampleRows.forEach((row, rowIndex) => {
                selectedColumns.forEach((columnName, colIndex) => {
                    const validation = cellValidationStatus[rowIndex] ? cellValidationStatus[rowIndex][colIndex] : null;
                    
                    if (validation && validation.status === 'error') {
                        let cellValue = row[columnName] || '';
                        let fixedValue = cellValue;
                        const columnNameLower = columnName.toLowerCase();
                        
                        if (columnNameLower === 'ชื่อประเภทอ้อย') {
                            const validTypes = [
                                "ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ตอ1", "ตอ2", "ตอ3", 
                                "ต้นฝนขยาย", "ต้นฝนรื้อตอ", "พื้นที่เสียหาย", ">ตอ3"
                            ];
                            
                            let bestMatch = null;
                            let bestScore = 0;
                            
                            validTypes.forEach(validType => {
                                const similarity = calculateSimilarity(cellValue, validType);
                                if (similarity > bestScore && similarity > 0.3) {
                                    bestScore = similarity;
                                    bestMatch = validType;
                                }
                            });
                            
                            if (bestMatch) {
                                fixedValue = bestMatch;
                            } else {
                                fixedValue = validTypes[0];
                            }
                        } else if (columnNameLower === 'ประเภทอ้อย') {
                            const validNumbers = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];
                            
                            const numValue = parseFloat(cellValue);
                            if (isNaN(numValue)) {
                                fixedValue = "101";
                            } else {
                                let closest = validNumbers[0];
                                let minDiff = Math.abs(numValue - parseInt(closest));
                                
                                validNumbers.forEach(num => {
                                    const diff = Math.abs(numValue - parseInt(num));
                                    if (diff < minDiff) {
                                        minDiff = diff;
                                        closest = num;
                                    }
                                });
                                
                                fixedValue = closest;
                            }
                        } else if (cellValue === '' && columnName.includes('พื้นที่')) {
                            fixedValue = '0.0';
                        }
                        
                        if (fixedValue !== cellValue) {
                            uploadedData.data[rowIndex][columnName] = fixedValue;
                            fixedCount++;
                            
                            if (!cellValidationStatus[rowIndex]) {
                                cellValidationStatus[rowIndex] = {};
                            }
                            cellValidationStatus[rowIndex][colIndex].edited = true;
                        }
                    }
                });
            });
            
            runDataValidationFromUploadedData();
            renderDataTableFromUploadedData();
            updateDashboard();
            updateDataStatus();
            
            alert(`AI ได้แก้ไขข้อผิดพลาด ${fixedCount} รายการ`);
        }
        
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            return (longer.length - editDistance(longer, shorter)) / parseFloat(longer.length);
        }
        
        function editDistance(s1, s2) {
            s1 = s1.toLowerCase();
            s2 = s2.toLowerCase();
            
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else {
                        if (j > 0) {
                            let newValue = costs[j - 1];
                            if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                                newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                            }
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }
        
        // ============================================
        // ระบบตรวจสอบเงื่อนไข (Step 4)
        // ============================================
        function initConditionChecking() {
            if (!uploadedData || !selectedColumns) {
                document.getElementById('checkingResults').innerHTML = `
                    <div class="result-summary">
                        <p><i class="fas fa-exclamation-triangle"></i> ยังไม่มีข้อมูล กรุณาไปที่ขั้นตอนที่ 1-3 ก่อน</p>
                    </div>
                `;
                return;
            }
            
            setupConditionCheckingSystem();
            prepareCheckingTable();
        }
        
        function setupConditionCheckingSystem() {
            document.querySelectorAll('.condition-select-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.condition-select-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    currentCondition = this.dataset.condition;
                    document.getElementById('selectedCondition').textContent = 
                        getConditionDisplayName(currentCondition);
                    prepareCheckingTable();
                });
            });
            
            document.getElementById('runSelectedCheck').addEventListener('click', function() {
                if (!checkingTableData || checkingTableData.length === 0) {
                    alert('กรุณาเตรียมข้อมูลก่อนเริ่มตรวจสอบ');
                    return;
                }
                
                if (currentCondition === "sugarcane") {
                    const results = performSugarcaneConditionCheck();
                    updateCheckingTableWithResults(results, currentCondition);
                    updateCheckingStats(results);
                    displayCheckingResults(results, currentCondition);
                } else if (currentCondition === "fertilizer") {
                    const results = performFertilizerConditionCheck();
                    updateCheckingTableWithResults(results, currentCondition);
                    updateCheckingStats(results);
                    displayCheckingResults(results, currentCondition);
                }
            });
            
            document.getElementById('runAllChecks').addEventListener('click', function() {
                runAllConditionChecks();
            });
            
            document.getElementById('exportCheckResults').addEventListener('click', exportCheckingResultsWithColors);
        }
        
        function getConditionDisplayName(condition) {
            const names = {
                "sugarcane": "ประเภทอ้อย",
                "fertilizer": "ปุ๋ย"
            };
            return names[condition] || condition;
        }
        
        function getSugarcaneGroup(sugarcaneType) {
            const newPlantingTypes = ["ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ต้นฝนขยาย", "ต้นฝนรื้อตอ"];
            const ratoonTypes = ["ตอ1", "ตอ2", "ตอ3", ">ตอ3"];
            
            const normalizedType = sugarcaneType.trim();
            
            if (newPlantingTypes.includes(normalizedType)) {
                return "new";
            } else if (ratoonTypes.includes(normalizedType)) {
                return "ratoon";
            } else {
                return "unknown";
            }
        }
        
        function getExpectedFertilizerType(sugarcaneType, age, period) {
            const normalizedType = sugarcaneType.trim();
            
            if (fertilizerConditions[normalizedType]) {
                const condition = fertilizerConditions[normalizedType];
                
                switch(period) {
                    case 1:
                        if (age >= condition.period1.minAge && age <= condition.period1.maxAge) {
                            return condition.period1.expected;
                        }
                        break;
                    case 2:
                        if (age >= condition.period2.minAge && age <= condition.period2.maxAge) {
                            return condition.period2.expected;
                        }
                        break;
                    case 3:
                        if (age >= condition.period3.minAge && age <= condition.period3.maxAge) {
                            return condition.period3.expected;
                        }
                        break;
                }
            }
            
            return null;
        }
        
        function findColumnByName(columns, possibleNames) {
            for (const column of columns) {
                const columnLower = column.toLowerCase().trim();
                for (const name of possibleNames) {
                    if (columnLower.includes(name.toLowerCase())) {
                        return column;
                    }
                }
            }
            return null;
        }
        
        function prepareCheckingTable() {
            const tableBody = document.getElementById('checkingTableBody');
            tableBody.innerHTML = '';
            
            if (!uploadedData || !selectedColumns || selectedColumns.length === 0) {
                console.error('No uploaded data or selected columns');
                return;
            }
            
            if (currentCondition === "sugarcane") {
                prepareSugarcaneCheckingTable();
            } else if (currentCondition === "fertilizer") {
                prepareFertilizerCheckingTable();
            }
        }
        
        function prepareSugarcaneCheckingTable() {
            const tableBody = document.getElementById('checkingTableBody');
            tableBody.innerHTML = '';
            
            const requiredColumns = [
                { name: "เลขแปลงintech", keywords: ["แปลงintech", "แปลง intech", "แปลง"] },
                { name: "ชื่อประเภทอ้อย", keywords: ["ชื่อประเภทอ้อย", "ประเภทอ้อย", "พันธุ์อ้อย"] },
                { name: "วันที่ปลูก", keywords: ["วันที่ปลูก", "วันปลูก", "planting date"] },
                { name: "อายุอ้อย", keywords: ["อายุอ้อย", "อายุ", "age", "วัน"] }
            ];
            
            const foundColumns = {};
            
            requiredColumns.forEach(reqCol => {
                let foundColumn = null;
                
                for (const col of selectedColumns) {
                    const colLower = col.toLowerCase().trim();
                    const reqNameLower = reqCol.name.toLowerCase();
                    
                    if (colLower === reqNameLower) {
                        foundColumn = col;
                        break;
                    }
                }
                
                if (!foundColumn) {
                    for (const col of selectedColumns) {
                        const colLower = col.toLowerCase();
                        for (const keyword of reqCol.keywords) {
                            if (colLower.includes(keyword.toLowerCase())) {
                                foundColumn = col;
                                break;
                            }
                        }
                        if (foundColumn) break;
                    }
                }
                
                foundColumns[reqCol.name] = foundColumn;
            });
            
            const missingColumns = [];
            Object.keys(foundColumns).forEach(key => {
                if (!foundColumns[key]) {
                    missingColumns.push(key);
                }
            });
            
            if (missingColumns.length > 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; background: #ffebee;">
                            <div style="color: #d32f2f; font-size: 1.2rem; margin-bottom: 15px;">
                                <i class="fas fa-exclamation-triangle"></i> <strong>ไม่พบคอลัมน์ที่จำเป็น</strong>
                            </div>
                            <p>กรุณาเลือกคอลัมน์เหล่านี้ในขั้นตอนที่ 2:</p>
                            <ul style="text-align: left; display: inline-block; margin-top: 10px;">
                                ${missingColumns.map(col => `<li>${col}</li>`).join('')}
                            </ul>
                        </td>
                    </tr>
                `;
                return;
            }
            
            checkingTableData = [];
            
            uploadedData.data.forEach((row, rowIndex) => {
                const intechValue = foundColumns["เลขแปลงintech"] ? row[foundColumns["เลขแปลงintech"]] || '' : '';
                const hasIntech = intechValue.trim() !== '';
                
                const rowData = {
                    id: rowIndex + 1,
                    originalRowIndex: rowIndex,
                    hasIntech: hasIntech,
                    intechPlot: intechValue,
                    sugarcaneType: foundColumns["ชื่อประเภทอ้อย"] ? row[foundColumns["ชื่อประเภทอ้อย"]] || '' : '',
                    plantingDate: foundColumns["วันที่ปลูก"] ? row[foundColumns["วันที่ปลูก"]] || '' : '',
                    age: foundColumns["อายุอ้อย"] ? row[foundColumns["อายุอ้อย"]] || '' : '',
                    condition: getConditionDisplayName(currentCondition),
                    status: "รอตรวจสอบ",
                    notes: "ยังไม่ได้ตรวจสอบ",
                    passed: false,
                    failedCells: {}
                };
                
                checkingTableData.push(rowData);
            });
            
            const tableHeader = document.getElementById('checkingTableHeader');
            tableHeader.innerHTML = '';
            
            const headerRow = document.createElement('tr');
            const headers = ["ลำดับ", "เลขแปลงintech", "ชื่อประเภทอ้อย", "วันที่ปลูก", "อายุอ้อย (วัน)", "เงื่อนไขที่ตรวจ", "สถานะ", "หมายเหตุ"];
            
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            tableHeader.appendChild(headerRow);
            
            renderCheckingTable();
            document.getElementById('checkingRowsCount').textContent = checkingTableData.length;
            
            const resultsContainer = document.getElementById('checkingResults');
            resultsContainer.innerHTML = `
                <div class="result-summary" style="background: #e8f5e9; border-left-color: #4caf50;">
                    <p><i class="fas fa-check-circle"></i> <strong>เตรียมตารางตรวจสอบประเภทอ้อยเสร็จเรียบร้อย</strong></p>
                    <p>ข้อมูลทั้งหมด: <strong>${checkingTableData.length} แถว</strong></p>
                    <p>พบคอลัมน์ที่ใช้ตรวจสอบ:</p>
                    <ul>
                        <li><strong>เลขแปลงintech:</strong> "${foundColumns["เลขแปลงintech"]}"</li>
                        <li><strong>ชื่อประเภทอ้อย:</strong> "${foundColumns["ชื่อประเภทอ้อย"]}"</li>
                        <li><strong>วันที่ปลูก:</strong> "${foundColumns["วันที่ปลูก"]}"</li>
                        <li><strong>อายุอ้อย:</strong> "${foundColumns["อายุอ้อย"]}"</li>
                    </ul>
                    <p style="margin-top: 15px;">
                        <button class="btn btn-primary" id="startSugarcaneCheckBtn">
                            <i class="fas fa-play"></i> เริ่มตรวจสอบประเภทอ้อย
                        </button>
                    </p>
                </div>
            `;
            
            document.getElementById('startSugarcaneCheckBtn').addEventListener('click', function() {
                const results = performSugarcaneConditionCheck();
                updateCheckingTableWithResults(results, currentCondition);
                updateCheckingStats(results);
                displayCheckingResults(results, currentCondition);
            });
        }
        
        function renderCheckingTable() {
            const tableBody = document.getElementById('checkingTableBody');
            tableBody.innerHTML = '';
            
            checkingTableData.forEach(rowData => {
                const tr = document.createElement('tr');
                
                if (rowData.status === "ไม่มีข้อมูลวันที่ปลูก") {
                    tr.classList.add('warning-row');
                }
                
                const formatPlantingDate = (dateStr) => {
                    if (!dateStr || dateStr.trim() === '') return '';
                    
                    const dateStrTrimmed = dateStr.trim();
                    
                    if (dateStrTrimmed.length > 15) {
                        const dateMatch = dateStrTrimmed.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
                        if (dateMatch) {
                            const year = dateMatch[1];
                            const month = dateMatch[2];
                            const day = dateMatch[3];
                            return `${year}/${month}/${day}`;
                        }
                        
                        return dateStrTrimmed.length > 20 ? 
                            dateStrTrimmed.substring(0, 17) + '...' : 
                            dateStrTrimmed;
                    }
                    
                    return dateStrTrimmed;
                };
                
                const formattedPlantingDate = formatPlantingDate(rowData.plantingDate);
                
                const cells = [
                    rowData.id,
                    rowData.intechPlot || '(ไม่พบข้อมูล)',
                    rowData.sugarcaneType || '(ไม่พบข้อมูล)',
                    formattedPlantingDate || '(ไม่พบข้อมูล)',
                    rowData.age || '',
                    rowData.condition,
                    createStatusBadge(rowData.status),
                    rowData.notes
                ];
                
                cells.forEach((cellContent, cellIndex) => {
                    const td = document.createElement('td');
                    
                    if (typeof cellContent === 'string' && cellContent.includes('status-badge')) {
                        td.innerHTML = cellContent;
                    } else {
                        td.textContent = cellContent;
                        
                        if (cellIndex === 3 && rowData.plantingDate && rowData.plantingDate !== formattedPlantingDate) {
                            td.title = rowData.plantingDate;
                            td.classList.add('date-cell-compact');
                        }
                        
                        if (rowData.failedCells && rowData.failedCells[cellIndex]) {
                            td.style.color = 'var(--danger-color)';
                            td.style.fontWeight = 'bold';
                            td.style.backgroundColor = 'rgba(247, 37, 133, 0.1)';
                        } else if (rowData.passed && (cellIndex === 2 || cellIndex === 3)) {
                            td.style.color = 'var(--success-color)';
                            td.style.fontWeight = 'bold';
                            td.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
                        }
                    }
                    
                    tr.appendChild(td);
                });
                
                tableBody.appendChild(td);
            });
        }
        
        function parseDateString(dateStr) {
            if (!dateStr || dateStr.trim() === '') return null;
            
            try {
                const trimmedStr = dateStr.trim();
                let date;
                
                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(trimmedStr)) {
                    const parts = trimmedStr.split('/');
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1;
                    const year = parseInt(parts[2]);
                    
                    date = new Date(year, month, day);
                    
                    if (date.getDate() !== day || date.getMonth() !== month || date.getFullYear() !== year) {
                        return null;
                    }
                } else if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(trimmedStr)) {
                    const parts = trimmedStr.split('/');
                    date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                } else if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(trimmedStr)) {
                    const parts = trimmedStr.split('-');
                    date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                } else if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(trimmedStr)) {
                    const parts = trimmedStr.split('-');
                    date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                } else {
                    date = new Date(trimmedStr);
                }
                
                if (isNaN(date.getTime())) {
                    return null;
                }
                
                return date;
            } catch (error) {
                console.error('Error parsing date:', dateStr, error);
                return null;
            }
        }
        
        function createStatusBadge(status) {
            let badgeClass = "status-info";
            let badgeText = status;
            
            if (status === "ผ่าน") {
                badgeClass = "status-valid";
                badgeText = "ผ่าน";
            } else if (status === "ไม่ผ่าน") {
                badgeClass = "status-error";
                badgeText = "ไม่ผ่าน";
            } else if (status === "ต้องตรวจสอบ") {
                badgeClass = "status-warning";
                badgeText = "ต้องตรวจสอบ";
            } else if (status === "รอตรวจสอบ") {
                badgeClass = "status-warning";
                badgeText = "รอตรวจสอบ";
            } else if (status === "ไม่มีข้อมูลวันที่ปลูก") {
                badgeClass = "status-warning";
                badgeText = "ไม่มีข้อมูลวันที่ปลูก";
            }
            
            return `<span class="status-badge ${badgeClass}">${badgeText}</span>`;
        }
        
        function performSugarcaneConditionCheck() {
            const results = {
                condition: "sugarcane",
                totalRows: checkingTableData.length,
                passed: 0,
                failed: 0,
                warnings: 0,
                pending: 0,
                issues: []
            };
            
            checkingTableData.forEach((rowData, index) => {
                let passed = false;
                let pending = false;
                let notes = "";
                let failedCells = {};
                
                if (rowData.sugarcaneType && rowData.sugarcaneType.trim() !== '') {
                    const sugarcaneType = rowData.sugarcaneType.trim();
                    
                    if (sugarcaneTypes.includes(sugarcaneType)) {
                        if (rowData.plantingDate && rowData.plantingDate.trim() !== '') {
                            try {
                                const plantingDate = parseDateString(rowData.plantingDate.trim());
                                
                                if (plantingDate) {
                                    const sugarcaneDateRanges = {
                                        "ปลายฝนขยาย": [
                                            { start: "2025-10-01", end: "2026-02-28", description: "ตุลาคม 2568 - กุมภาพันธ์ 2569", year: "2568-2569" },
                                            { start: "2024-10-01", end: "2025-01-31", description: "ตุลาคม 2567 - มกราคม 2568", year: "2567-2568" }
                                        ],
                                        "ปลายฝนรื้อตอ": [
                                            { start: "2025-10-01", end: "2026-02-28", description: "ตุลาคม 2568 - กุมภาพันธ์ 2569", year: "2568-2569" },
                                            { start: "2024-10-01", end: "2025-01-31", description: "ตุลาคม 2567 - มกราคม 2568", year: "2567-2568" }
                                        ],
                                        "ต้นฝนขยาย": [
                                            { start: "2026-03-01", end: "2026-06-30", description: "มีนาคม 2569 - มิถุนายน 2569", year: "2569" },
                                            { start: "2024-02-01", end: "2025-05-31", description: "กุมภาพันธ์ 2567 - พฤษภาคม 2568", year: "2567-2568" }
                                        ],
                                        "ต้นฝนรื้อตอ": [
                                            { start: "2026-03-01", end: "2026-06-30", description: "มีนาคม 2569 - มิถุนายน 2569", year: "2569" },
                                            { start: "2024-02-01", end: "2025-05-31", description: "กุมภาพันธ์ 2567 - พฤษภาคม 2568", year: "2567-2568" }
                                        ],
                                        "ตอ1": [
                                            { start: "2025-12-01", end: "2026-03-31", description: "ธันวาคม 2568 - มีนาคม 2569", year: "2568-2569" },
                                            { start: "2024-12-01", end: "2025-03-31", description: "ธันวาคม 2567 - มีนาคม 2568", year: "2567-2568" }
                                        ],
                                        "ตอ2": [
                                            { start: "2025-12-01", end: "2026-03-31", description: "ธันวาคม 2568 - มีนาคม 2569", year: "2568-2569" },
                                            { start: "2024-12-01", end: "2025-03-31", description: "ธันวาคม 2567 - มีนาคม 2568", year: "2567-2568" }
                                        ],
                                        "ตอ3": [
                                            { start: "2025-12-01", end: "2026-03-31", description: "ธันวาคม 2568 - มีนาคม 2569", year: "2568-2569" },
                                            { start: "2024-12-01", end: "2025-03-31", description: "ธันวาคม 2567 - มีนาคม 2568", year: "2567-2568" }
                                        ],
                                        ">ตอ3": [
                                            { start: "2025-12-01", end: "2026-03-31", description: "ธันวาคม 2568 - มีนาคม 2569", year: "2568-2569" },
                                            { start: "2024-12-01", end: "2025-03-31", description: "ธันวาคม 2567 - มีนาคม 2568", year: "2567-2568" }
                                        ]
                                    };
                                    
                    let matchedType = null;
                    let matchedRanges = null;
                    
                    for (const [typeKey, ranges] of Object.entries(sugarcaneDateRanges)) {
                        if (sugarcaneType.includes(typeKey) || typeKey.includes(sugarcaneType)) {
                            matchedType = typeKey;
                            matchedRanges = ranges;
                            break;
                        }
                    }
                    
                    if (!matchedRanges) {
                        if (sugarcaneType.includes("ปลายฝน")) {
                            matchedType = "ปลายฝน";
                            matchedRanges = sugarcaneDateRanges["ปลายฝนขยาย"];
                        } else if (sugarcaneType.includes("ต้นฝน")) {
                            matchedType = "ต้นฝน";
                            matchedRanges = sugarcaneDateRanges["ต้นฝนขยาย"];
                        } else if (sugarcaneType.includes("ตอ") || sugarcaneType.includes(">ตอ3")) {
                            matchedType = "ตอ1";
                            matchedRanges = sugarcaneDateRanges["ตอ1"];
                        }
                    }
                    
                    if (matchedRanges && matchedRanges.length > 0) {
                        let isInAnyRange = false;
                        let matchedRangeDescription = "";
                        
                        for (const range of matchedRanges) {
                            const startDate = new Date(range.start);
                            const endDate = new Date(range.end);
                            
                            if (plantingDate >= startDate && plantingDate <= endDate) {
                                isInAnyRange = true;
                                matchedRangeDescription = range.description;
                                break;
                            }
                        }
                        
                        if (isInAnyRange) {
                            const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", 
                                                "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
                            const plantingMonth = monthNames[plantingDate.getMonth()];
                            const plantingYear = plantingDate.getFullYear() + 543;
                            
                            passed = true;
                            notes = `✓ ถูกต้อง: ประเภทอ้อย "${sugarcaneType}" ปลูกเดือน ${plantingMonth} ${plantingYear} สอดคล้องกับช่วง ${matchedRangeDescription}`;
                            rowData.passed = true;
                        } else {
                            pending = true;
                            
                            const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", 
                                                "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
                            const plantingMonth = monthNames[plantingDate.getMonth()];
                            const plantingYear = plantingDate.getFullYear() + 543;
                            
                            const allRangesDesc = matchedRanges.map(r => `${r.description} (ปี ${r.year})`).join(" หรือ ");
                            
                            notes = `⏳ รอตรวจสอบ: ปลูกเดือน ${plantingMonth} ${plantingYear} ไม่อยู่ในช่วงที่กำหนดสำหรับ "${sugarcaneType}" | ช่วงที่กำหนด: ${allRangesDesc}`;
                            
                            failedCells[2] = true;
                            failedCells[3] = true;
                            rowData.passed = false;
                            results.issues.push({
                                row: rowData.originalRowIndex + 1,
                                message: notes,
                                type: sugarcaneType,
                                plantingDate: rowData.plantingDate,
                                actualMonth: plantingMonth,
                                actualYear: plantingYear,
                                expectedRanges: allRangesDesc,
                                status: "รอตรวจสอบ"
                            });
                        }
                    } else {
                        pending = true;
                        notes = `⏳ รอตรวจสอบ: ประเภทอ้อย "${sugarcaneType}" ไม่มีช่วงวันที่กำหนดในระบบ`;
                        failedCells[2] = true;
                        rowData.passed = false;
                        results.issues.push({
                            row: rowData.originalRowIndex + 1,
                            message: notes,
                            type: sugarcaneType,
                            status: "รอตรวจสอบ"
                        });
                    }
                } else {
                    passed = false;
                    notes = "✗ รูปแบบวันที่ไม่ถูกต้อง";
                    failedCells[3] = true;
                    rowData.passed = false;
                    results.issues.push({
                        row: rowData.originalRowIndex + 1,
                        message: notes,
                        type: sugarcaneType,
                        plantingDate: rowData.plantingDate
                    });
                }
            } catch (error) {
                passed = false;
                notes = `✗ ข้อผิดพลาดในการตรวจสอบวันที่: ${error.message}`;
                failedCells[3] = true;
                rowData.passed = false;
                results.issues.push({
                    row: rowData.originalRowIndex + 1,
                    message: notes,
                    type: sugarcaneType,
                    plantingDate: rowData.plantingDate
                });
            }
        } else {
            passed = false;
            rowData.status = "ไม่มีข้อมูลวันที่ปลูก";
            notes = "ยังไม่ได้ทำกิจกรรมงวด 1";
            failedCells[3] = true;
            rowData.passed = false;
            results.warnings++;
            results.issues.push({
                row: rowData.originalRowIndex + 1,
                message: notes,
                type: sugarcaneType,
                status: "ไม่มีข้อมูลวันที่ปลูก"
            });
        }
    } else {
        passed = false;
        notes = `✗ ประเภทอ้อย "${sugarcaneType}" ไม่ตรงกับค่ามาตรฐานที่กำหนด`;
        failedCells[2] = true;
        rowData.passed = false;
        results.issues.push({
            row: rowData.originalRowIndex + 1,
            message: notes,
            type: sugarcaneType
        });
    }
} else {
    passed = false;
    notes = "✗ ไม่มีข้อมูลประเภทอ้อย";
    failedCells[2] = true;
    rowData.passed = false;
    results.issues.push({
        row: rowData.originalRowIndex + 1,
        message: notes
    });
}

if (passed) {
    results.passed++;
    rowData.status = "ผ่าน";
} else if (pending) {
    results.pending++;
    rowData.status = "รอตรวจสอบ";
} else if (rowData.status === "ไม่มีข้อมูลวันที่ปลูก") {
    results.warnings++;
} else {
    results.failed++;
    rowData.status = "ไม่ผ่าน";
}

rowData.condition = getConditionDisplayName("sugarcane");
rowData.notes = notes;
rowData.failedCells = failedCells;
            });
            
            return results;
        }
        
        function updateCheckingTableWithResults(results, condition) {
            checkingTableData.forEach((rowData) => {
                rowData.condition = getConditionDisplayName(condition);
            });
            
            renderCheckingTable();
        }
        
        function updateCheckingStats(results) {
            document.getElementById('foundIssues').textContent = results.failed + results.warnings;
            document.getElementById('passedChecks').textContent = results.passed;
            document.getElementById('failedChecks').textContent = results.failed;
        }
        
        function displayCheckingResults(results, condition) {
            const resultsContainer = document.getElementById('checkingResults');
            
            let html = `
                <div class="result-summary">
                    <p><i class="fas fa-check-circle" style="color: #4caf50;"></i> ตรวจสอบเงื่อนไข "<strong>${getConditionDisplayName(condition)}</strong>" เรียบร้อยแล้ว</p>
                    <div class="result-header">
                        <span class="result-condition">สรุปผลการตรวจสอบ</span>
                        <span class="result-count">ตรวจ ${results.totalRows} แถว</span>
                    </div>
                    <ul>
                        <li>ผ่าน: ${results.passed} รายการ</li>
                        <li>ไม่ผ่าน: ${results.failed} รายการ</li>
                        ${results.warnings > 0 ? `<li>ต้องตรวจสอบ: <span style="color: #ff9800; font-weight: bold;">${results.warnings} รายการ</span></li>` : ''}
                    </ul>
            `;
            
            if (results.issues.length > 0) {
                html += `
                    <div class="result-details">
                        <p><strong>ปัญหาที่พบ:</strong></p>
                `;
                
                const issuesByStatus = {};
                results.issues.forEach(issue => {
                    const status = issue.status || 'ไม่ระบุสถานะ';
                    if (!issuesByStatus[status]) {
                        issuesByStatus[status] = [];
                    }
                    issuesByStatus[status].push(issue);
                });
                
                for (const [status, issues] of Object.entries(issuesByStatus)) {
                    html += `
                        <div class="result-item ${status.includes('ไม่ผ่าน') ? 'error' : 'warning'}" style="margin-bottom: 10px;">
                            <div class="result-header">
                                <span class="result-condition">${status}</span>
                                <span class="result-count">พบปัญหา ${issues.length} รายการ</span>
                            </div>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            html += `</div>`;
            
            resultsContainer.innerHTML = html;
        }
        
        function runAllConditionChecks() {
            const conditions = ["sugarcane", "fertilizer"];
            const allResults = [];
            
            document.getElementById('runAllChecks').disabled = true;
            document.getElementById('runAllChecks').innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังตรวจสอบทั้งหมด...';
            
            let completedChecks = 0;
            
            conditions.forEach(condition => {
                setTimeout(() => {
                    currentCondition = condition;
                    prepareCheckingTable();
                    
                    setTimeout(() => {
                        let results;
                        
                        switch(condition) {
                            case "sugarcane":
                                results = performSugarcaneConditionCheck();
                                break;
                            case "fertilizer":
                                results = performFertilizerConditionCheck();
                                break;
                        }
                        
                        if (results) {
                            allResults.push(results);
                            updateCheckingTableWithResults(results, condition);
                        }
                        
                        completedChecks++;
                        
                        if (completedChecks === conditions.length) {
                            displayAllCheckingResults(allResults);
                            document.getElementById('runAllChecks').disabled = false;
                            document.getElementById('runAllChecks').innerHTML = '<i class="fas fa-play-circle"></i> ตรวจสอบเงื่อนไขทั้งหมด';
                        }
                    }, 500);
                }, 1000 * conditions.indexOf(condition));
            });
        }
        
        function displayAllCheckingResults(allResults) {
            const resultsContainer = document.getElementById('checkingResults');
            
            let html = `
                <div class="result-summary">
                    <p><i class="fas fa-check-circle" style="color: #4caf50;"></i> ตรวจสอบเงื่อนไขทั้งหมดเรียบร้อยแล้ว</p>
                    <div class="result-header">
                        <span class="result-condition">สรุปผลการตรวจสอบทั้งหมด</span>
                        <span class="result-count">ตรวจ ${allResults[0].totalRows} แถว</span>
                    </div>
            `;
            
            allResults.forEach(results => {
                const conditionName = getConditionDisplayName(results.condition);
                
                html += `
                    <div class="result-item ${results.failed > 0 || results.warnings > 0 ? 'error' : 'success'}">
                        <div class="result-header">
                            <span class="result-condition">${conditionName}</span>
                            <span class="result-count">ผ่าน ${results.passed}/${results.totalRows}</span>
                        </div>
                        <div class="result-details">
                            <p>พบปัญหา ${results.failed} รายการ${results.warnings > 0 ? `, ต้องตรวจสอบ ${results.warnings} รายการ` : ''}</p>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            resultsContainer.innerHTML = html;
        }
        
        function exportCheckingResultsWithColors() {
            if (checkingTableData.length === 0) {
                alert('ไม่มีข้อมูลผลการตรวจสอบ');
                return;
            }
            
            let csvContent = '';
            csvContent += '\ufeff';
            
            const tableHeader = document.getElementById('checkingTableHeader');
            const headerRow = tableHeader.querySelector('tr');
            const headers = [];
            
            for (let i = 0; i < headerRow.cells.length; i++) {
                headers.push(headerRow.cells[i].textContent);
            }
            
            csvContent += headers.join(',') + '\n';
            
            checkingTableData.forEach(row => {
                const rowData = [];
                
                for (let i = 0; i < headers.length; i++) {
                    const header = headers[i];
                    let cellValue = '';
                    
                    if (header === "ลำดับ") {
                        cellValue = row.id;
                    } else if (header === "สถานะ") {
                        cellValue = row.status;
                    } else if (header === "หมายเหตุ") {
                        cellValue = row.notes || '';
                    } else if (header === "เงื่อนไขที่ตรวจ") {
                        cellValue = row.condition || '';
                    } else {
                        cellValue = row[header] || '';
                    }
                    
                    cellValue = cellValue.toString().replace(/"/g, '""');
                    rowData.push(`"${cellValue}"`);
                }
                
                csvContent += rowData.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `condition_check_results_${currentCondition}_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('ส่งออกผลการตรวจสอบเรียบร้อยแล้ว!');
        }
        
        // ============================================
        // ขั้นตอนที่ 5: เลือกคอลัมน์สำหรับส่งออก
        // ============================================
        nextToStep5.addEventListener('click', function() {
            goToStep(5);
        });
        
        function initExportColumnSelection() {
            if (!uploadedData || !selectedColumns) {
                alert('ยังไม่มีข้อมูล กรุณาไปที่ขั้นตอนที่ 1-4 ก่อน');
                return;
            }
            
            exportColumns = [];
            
            autoExportColumns.forEach(targetCol => {
                const foundColumn = selectedColumns.find(col => 
                    col.toLowerCase().includes(targetCol.toLowerCase())
                );
                
                if (foundColumn && !exportColumns.includes(foundColumn)) {
                    exportColumns.push(foundColumn);
                }
            });
            
            exportColumns.sort((a, b) => {
                const indexA = uploadedData.headers.indexOf(a);
                const indexB = uploadedData.headers.indexOf(b);
                return indexA - indexB;
            });
            
            renderExportColumnGrid();
            updateExportColumnStats();
        }
        
        function renderExportColumnGrid() {
            exportColumnsGrid.innerHTML = '';
            
            const searchTerm = columnSearch.value.toLowerCase();
            
            selectedColumns.forEach(column => {
                const columnNameLower = column.toLowerCase();
                const isSelected = exportColumns.includes(column);
                const matchesSearch = searchTerm === '' || columnNameLower.includes(searchTerm);
                const isRecommended = autoExportColumns.some(targetCol => 
                    columnNameLower.includes(targetCol.toLowerCase())
                );
                
                let columnType = '';
                
                if (columnNameLower.includes('ประเภทอ้อย') || columnNameLower.includes('sugarcane') || 
                    columnNameLower.includes('พันธุ์') || columnNameLower.includes('type')) {
                    columnType = 'ข้อมูลอ้อย';
                } else if (columnNameLower.includes('อายุ') || columnNameLower.includes('age') ||
                          columnNameLower.includes('งวด') || columnNameLower.includes('period') ||
                          columnNameLower.includes('กิจกรรม') || columnNameLower.includes('activity')) {
                    columnType = 'กิจกรรมงวด';
                } else if (columnNameLower.includes('โครงการ') || columnNameLower.includes('project')) {
                    columnType = 'โครงการ';
                } else if (columnNameLower.includes('ปุ๋ย') || columnNameLower.includes('fertilizer') ||
                          columnNameLower.includes('ยา') || columnNameLower.includes('chemical')) {
                    columnType = 'ปุ๋ย';
                } else if (columnNameLower.includes('วันที่') || columnNameLower.includes('date')) {
                    columnType = 'วันที่';
                } else if (columnNameLower.includes('รหัส') || columnNameLower.includes('code') || 
                          columnNameLower.includes('id') || columnNameLower.includes('หมายเลข')) {
                    columnType = 'รหัส';
                } else if (columnNameLower.includes('จำนวน') || columnNameLower.includes('quantity') ||
                          columnNameLower.includes('ปริมาณ') || columnNameLower.includes('amount') ||
                          columnNameLower.includes('พื้นที่') || columnNameLower.includes('area')) {
                    columnType = 'จำนวน';
                } else if (columnNameLower === 'lat' || columnNameLower === 'latitude') {
                    columnType = 'พิกัด lat';
                } else if (columnNameLower === 'long' || columnNameLower === 'longitude') {
                    columnType = 'พิกัด long';
                } else {
                    columnType = 'ข้อมูลทั่วไป';
                }
                
                let shouldShow = matchesSearch;
                
                if (currentColumnFilter === 'selected') {
                    shouldShow = shouldShow && isSelected;
                } else if (currentColumnFilter === 'unselected') {
                    shouldShow = shouldShow && !isSelected;
                } else if (currentColumnFilter === 'recommended') {
                    shouldShow = shouldShow && isRecommended;
                }
                
                const columnItem = document.createElement('div');
                columnItem.className = `export-column-item ${isSelected ? 'selected' : ''} ${isRecommended ? 'recommended' : ''}`;
                columnItem.style.display = shouldShow ? 'flex' : 'none';
                
                columnItem.innerHTML = `
                    <input type="checkbox" class="export-column-checkbox" ${isSelected ? 'checked' : ''} data-column="${column}">
                    <div class="export-column-info">
                        <div class="export-column-name" title="${column}">${column}</div>
                        <span class="export-column-type">${columnType}</span>
                        ${isRecommended ? '<span style="color: #4CAF50; font-size: 0.7rem; margin-left: 5px;"><i class="fas fa-star"></i> แนะนำ</span>' : ''}
                    </div>
                `;
                
                exportColumnsGrid.appendChild(columnItem);
                
                const checkbox = columnItem.querySelector('.export-column-checkbox');
                checkbox.addEventListener('change', function() {
                    const columnName = this.dataset.column;
                    
                    if (this.checked) {
                        if (!exportColumns.includes(columnName)) {
                            exportColumns.push(columnName);
                        }
                    } else {
                        const index = exportColumns.indexOf(columnName);
                        if (index > -1) {
                            exportColumns.splice(index, 1);
                        }
                    }
                    
                    columnItem.classList.toggle('selected', this.checked);
                    updateExportColumnStats();
                });
            });
        }
        
        function updateExportColumnStats() {
            exportSelectedCount.textContent = exportColumns.length;
            
            if (exportColumns.length === 0) {
                exportColumnsList.textContent = 'ยังไม่ได้เลือกคอลัมน์';
            } else {
                const displayedColumns = exportColumns.slice(0, 5);
                const moreCount = exportColumns.length - 5;
                exportColumnsList.textContent = displayedColumns.join(', ') + 
                    (moreCount > 0 ? ` และอีก ${moreCount} คอลัมน์...` : '');
            }
        }
        
        document.querySelectorAll('#panel5 .selection-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#panel5 .selection-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentColumnFilter = this.dataset.filter;
                renderExportColumnGrid();
            });
        });
        
        exportSelectAllBtn.addEventListener('click', function() {
            const visibleColumns = Array.from(exportColumnsGrid.querySelectorAll('.export-column-item'))
                .filter(item => item.style.display !== 'none');
            
            visibleColumns.forEach(item => {
                const checkbox = item.querySelector('.export-column-checkbox');
                const columnName = checkbox.dataset.column;
                
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    if (!exportColumns.includes(columnName)) {
                        exportColumns.push(columnName);
                    }
                    item.classList.add('selected');
                }
            });
            
            updateExportColumnStats();
        });
        
        exportDeselectAllBtn.addEventListener('click', function() {
            const visibleColumns = Array.from(exportColumnsGrid.querySelectorAll('.export-column-item'))
                .filter(item => item.style.display !== 'none');
            
            visibleColumns.forEach(item => {
                const checkbox = item.querySelector('.export-column-checkbox');
                const columnName = checkbox.dataset.column;
                
                if (checkbox.checked) {
                    checkbox.checked = false;
                    const index = exportColumns.indexOf(columnName);
                    if (index > -1) {
                        exportColumns.splice(index, 1);
                    }
                    item.classList.remove('selected');
                }
            });
            
            updateExportColumnStats();
        });
        
        downloadCleanData.addEventListener('click', function() {
            if (!uploadedData) {
                alert('ไม่พบข้อมูล');
                return;
            }
            
            if (exportColumns.length === 0) {
                alert('ไม่มีคอลัมน์ที่เลือกสำหรับส่งออก');
                return;
            }
            
            const exportColumnsOrdered = [];
            
            uploadedData.headers.forEach(header => {
                if (exportColumns.includes(header)) {
                    exportColumnsOrdered.push(header);
                }
            });
            
            let csvContent = '';
            csvContent += '\ufeff';
            csvContent += exportColumnsOrdered.join(',') + '\n';
            
            uploadedData.data.forEach(row => {
                const rowValues = exportColumnsOrdered.map(col => {
                    let value = row[col] || '';
                    value = value.replace(/"/g, '""');
                    
                    if (value.includes(',') || value.includes('\n') || value.includes('\r') || value.includes('"')) {
                        value = `"${value}"`;
                    }
                    
                    return value;
                });
                csvContent += rowValues.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `cleaned_${uploadedData.fileName.replace('.csv', '')}_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('✅ ดาวน์โหลดไฟล์ที่ clean แล้วเรียบร้อย!\nจำนวนคอลัมน์: ' + exportColumnsOrdered.length + '\nจำนวนแถว: ' + uploadedData.data.length);
        });
        
        // ============================================
        // ฟังก์ชันการนำทาง
        // ============================================
        backToStep1.addEventListener('click', function() {
            goToStep(1);
        });
        
        backToStep2.addEventListener('click', function() {
            goToStep(2);
        });
        
        backToStep3.addEventListener('click', function() {
            goToStep(3);
        });
        
        backToStep4.addEventListener('click', function() {
            goToStep(4);
        });
        
        // ============================================
        // เริ่มต้นระบบ
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            setupEnhancedEventListeners();
            console.log('✅ ระบบตรวจสอบข้อมูลอ้อยพร้อมใช้งาน');
        });
    </script>
</body>
</html>
