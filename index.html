<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบ Clean Data สำหรับข้อมูลอ้อยครบวงจร</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Prompt:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #4cc9f0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f72585;
            --sugarcane-color: #228B22;
            --fertilizer-color: #9C27B0;
            --project-color: #FF5722;
            --border-radius: 12px;
            --box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Prompt', sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        
        header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        
        h1 {
            font-family: 'Kanit', sans-serif;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* Navigation Steps */
        .step-navigation {
            display: flex;
            justify-content: center;
            background-color: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 15px;
            position: relative;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 10px;
            z-index: 2;
            transition: all 0.3s ease;
        }
        
        .step.active .step-number {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 0 0 5px rgba(67, 97, 238, 0.2);
        }
        
        .step.completed .step-number {
            background-color: var(--success-color);
            color: white;
        }
        
        .step-info {
            display: flex;
            flex-direction: column;
        }
        
        .step-title {
            font-weight: 500;
            font-size: 1rem;
        }
        
        .step-description {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        /* Dashboard Summary */
        .dashboard-summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
        }
        
        .summary-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .summary-icon.success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
        }
        
        .summary-icon.warning {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }
        
        .summary-icon.error {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger-color);
        }
        
        .summary-icon.info {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
        }
        
        .summary-content {
            flex: 1;
        }
        
        .summary-content h4 {
            margin: 0 0 5px 0;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 1s ease;
        }
        
        .progress-fill.success {
            background: var(--success-color);
        }
        
        .progress-fill.warning {
            background: var(--warning-color);
        }
        
        .progress-fill.error {
            background: var(--danger-color);
        }
        
        .progress-fill.info {
            background: var(--primary-color);
        }
        
        .summary-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Step Content Area */
        .step-content {
            padding: 40px;
            min-height: 600px;
        }
        
        .step-panel {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .step-panel.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Panel Styling */
        .panel-header {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .panel-header h2 {
            font-size: 2rem;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .panel-header p {
            color: #666;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Upload Section */
        .upload-area {
            border: 3px dashed var(--accent-color);
            border-radius: var(--border-radius);
            padding: 60px 20px;
            text-align: center;
            background-color: rgba(76, 201, 240, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .upload-area:hover {
            background-color: rgba(76, 201, 240, 0.1);
            border-color: var(--primary-color);
        }
        
        .upload-area i {
            font-size: 4rem;
            color: var(--accent-color);
            margin-bottom: 20px;
        }
        
        .upload-area h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--secondary-color);
        }
        
        .upload-area p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .file-info {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .info-item strong {
            display: block;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }
        
        /* Column Selection Panel */
        .column-selection-panel {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-container {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 30px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .search-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .selection-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .selection-btn {
            padding: 8px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .selection-btn:hover {
            background-color: #e9ecef;
        }
        
        .selection-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .columns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .column-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .column-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .column-item.selected {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .column-item.sugarcane {
            border-left: 4px solid var(--sugarcane-color);
        }
        
        .column-item.activity {
            border-left: 4px solid var(--accent-color);
        }
        
        .column-item.project {
            border-left: 4px solid var(--project-color);
        }
        
        .column-item.fertilizer {
            border-left: 4px solid var(--fertilizer-color);
        }
        
        .column-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .column-info {
            flex: 1;
        }
        
        .column-name {
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .column-type {
            font-size: 0.8rem;
            color: #666;
            background-color: #f0f0f0;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .column-stats {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }
        
        .selected-summary {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--success-color);
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* Data Type Configuration */
        .data-type-configuration {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
            display: none;
        }
        
        .data-type-configuration h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .config-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .data-type-table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .data-type-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .data-type-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }
        
        .data-type-table th:hover {
            background-color: var(--secondary-color);
        }
        
        .data-type-table th i {
            margin-left: 5px;
            opacity: 0.7;
        }
        
        .data-type-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .type-select, .format-select, .unit-select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: 'Prompt', sans-serif;
            background: white;
        }
        
        .type-select:focus, .format-select:focus, .unit-select:focus {
            border-color: var(--accent-color);
            outline: none;
        }
        
        .data-sample-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Data Table */
        .data-table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            border: 1px solid #dee2e6;
            border-bottom: none;
        }
        
        .table-info {
            display: flex;
            gap: 20px;
            color: #6c757d;
            font-size: 0.9rem;
            align-items: center;
        }
        
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        #dataStatus {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
        }
        
        #dataStatus:hover {
            opacity: 0.9;
        }
        
        .data-table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            background: white;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--primary-color);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--secondary-color);
        }
        
        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }
        
        .data-table tr:hover td {
            background: #f8f9fa;
        }
        
        /* Filter dropdown styling */
        .filter-dropdown {
            width: calc(100% - 10px);
            margin-top: 5px;
            padding: 4px 6px;
            font-size: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Prompt', sans-serif;
            background-color: white;
        }
        
        .filter-dropdown:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.2);
        }
        
        /* Animation สำหรับ highlight เซลล์ */
        @keyframes highlightCell {
            0% { background-color: #fff3e0; }
            50% { background-color: #ffecb3; }
            100% { background-color: transparent; }
        }
        
        .cell-highlight {
            animation: highlightCell 2s ease;
        }
        
        /* Cell Styling */
        .cell-error {
            background: rgba(247, 37, 133, 0.1) !important;
            color: var(--danger-color) !important;
            font-weight: 600;
            position: relative;
            cursor: pointer;
        }
        
        .cell-error:hover {
            background: rgba(247, 37, 133, 0.2) !important;
        }
        
        .cell-error:after {
            content: "!";
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .cell-warning {
            background: rgba(255, 152, 0, 0.1) !important;
            color: var(--warning-color) !important;
            cursor: pointer;
        }
        
        .cell-valid {
            color: var(--success-color);
        }
        
        .cell-editing {
            background: #fffde7 !important;
            border: 2px solid var(--accent-color) !important;
        }
        
        /* Cell Editor Modal */
        .cell-editor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .cell-editor-modal.show {
            display: flex;
        }
        
        .cell-editor-modal .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-header h4 {
            margin: 0;
            color: var(--secondary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6c757d;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .cell-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .cell-info p {
            margin: 5px 0;
            color: #495057;
        }
        
        .error-text {
            color: var(--danger-color) !important;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.1);
        }
        
        .suggestions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        
        .suggestion-item {
            background: #e3f2fd;
            color: var(--primary-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .suggestion-item:hover {
            background: #bbdefb;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Data Type Configuration */
        .data-type-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filter-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover {
            background-color: #e9ecef;
        }
        
        .filter-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .ai-fix-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Kanit', sans-serif;
            transition: all 0.3s ease;
        }
        
        .ai-fix-btn:hover {
            background-color: #3ab0d8;
            transform: translateY(-2px);
        }
        
        .ai-fix-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-cell {
            color: var(--danger-color) !important;
            font-weight: bold;
            background-color: rgba(247, 37, 133, 0.1);
        }
        
        .warning-cell {
            color: var(--warning-color) !important;
            background-color: rgba(255, 152, 0, 0.1);
        }
        
        .editable-cell {
            position: relative;
            cursor: pointer;
        }
        
        .editable-cell:hover {
            background-color: rgba(76, 201, 240, 0.1);
        }
        
        .cell-input {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--accent-color);
            border-radius: 4px;
            font-family: 'Prompt', sans-serif;
            font-size: 0.9rem;
        }
        
        .type-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .type-text {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .type-number {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .type-date {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        .type-enum {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        
        .type-identifier {
            background-color: #e0f2f1;
            color: #00695c;
        }
        
        /* ขั้นตอนที่ 2: ระบบกรองข้อมูล - สไตล์ใหม่ */
        .filtering-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .filtering-section h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filtering-steps {
            margin-top: 30px;
        }
        
        .filter-step-card {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .filter-step-card.success {
            border-left-color: var(--success-color);
        }
        
        .filter-step-card.warning {
            border-left-color: var(--warning-color);
        }
        
        .filter-step-card.error {
            border-left-color: var(--danger-color);
        }
        
        .filter-step-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .filter-step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 15px;
        }
        
        .filter-step-card.success .filter-step-icon {
            background-color: var(--success-color);
        }
        
        .filter-step-card.warning .filter-step-icon {
            background-color: var(--warning-color);
        }
        
        .filter-step-card.error .filter-step-icon {
            background-color: var(--danger-color);
        }
        
        .filter-step-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .filter-step-description {
            color: #666;
            margin-bottom: 15px;
        }
        
        .filter-step-results {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .filter-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .filter-result-item {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }
        
        .filter-result-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .filter-result-label {
            font-size: 0.85rem;
            color: #666;
        }
        
        .final-filter-summary {
            background: linear-gradient(135deg, #e8f4fd 0%, #d1ecf1 100%);
            padding: 30px;
            border-radius: var(--border-radius);
            margin-top: 40px;
            text-align: center;
        }
        
        .filter-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .filter-summary-item {
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .filter-summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .filter-summary-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* ขั้นตอนที่ 5: ตรวจสอบเงื่อนไข - สไตล์ใหม่ */
        .condition-selection {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .condition-selection h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .condition-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .condition-select-btn {
            padding: 20px 15px;
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .condition-select-btn:hover {
            background-color: #e9ecef;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .condition-select-btn.active {
            background-color: rgba(67, 97, 238, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .condition-select-btn[data-condition="sugarcane"].active {
            background-color: rgba(34, 139, 34, 0.1);
            border-color: var(--sugarcane-color);
            color: var(--sugarcane-color);
        }
        
        .condition-select-btn[data-condition="activity"].active {
            background-color: rgba(76, 201, 240, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        .condition-select-btn[data-condition="project"].active {
            background-color: rgba(255, 87, 34, 0.1);
            border-color: var(--project-color);
            color: var(--project-color);
        }
        
        .condition-select-btn[data-condition="fertilizer"].active {
            background-color: rgba(156, 39, 176, 0.1);
            border-color: var(--fertilizer-color);
            color: var(--fertilizer-color);
        }
        
        .condition-select-btn i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .condition-desc {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }
        
        /* Checking controls */
        .checking-controls {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .checking-info {
            flex: 1;
            min-width: 300px;
        }
        
        .checking-info h4 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .checking-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .checking-stats span {
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #495057;
        }
        
        .checking-stats strong {
            color: var(--primary-color);
        }
        
        .checking-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        /* Checking table */
        .checking-table-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .table-info {
            display: flex;
            gap: 20px;
            color: #6c757d;
            font-size: 0.9rem;
            align-items: center;
        }
        
        .table-info span:first-child {
            font-weight: 500;
            color: var(--secondary-color);
        }
        
        .checking-table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            padding: 0;
        }
        
        .checking-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1300px;
        }
        
        /* ✅ ปรับขนาดคอลัมน์ใหม่ทั้งหมด 12 คอลัมน์ */
        .checking-table th:nth-child(1),
        .checking-table td:nth-child(1) {
            width: 60px;
            min-width: 60px;
            max-width: 60px;
            text-align: center;
            position: sticky;
            left: 0;
            background: var(--primary-color);
            color: white;
            z-index: 20;
        }
        
        .checking-table td:nth-child(1) {
            background: white;
            color: var(--dark-color);
            border-right: 1px solid #eee;
        }
        
        .checking-table th:nth-child(2),
        .checking-table td:nth-child(2) {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
            position: sticky;
            left: 60px;
            background: var(--primary-color);
            color: white;
            z-index: 20;
            border-right: 1px solid #ddd;
        }
        
        .checking-table td:nth-child(2) {
            background: #f8f9fa;
            color: var(--dark-color);
        }
        
        .checking-table th:nth-child(3),
        .checking-table td:nth-child(3) {
            width: 130px;
            min-width: 130px;
            max-width: 130px;
        }
        
        .checking-table th:nth-child(4),
        .checking-table td:nth-child(4) {
            width: 100px;
            min-width: 100px;
            max-width: 100px;
            text-align: center;
        }
        
        .checking-table th:nth-child(5),
        .checking-table td:nth-child(5) {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }
        
        .checking-table th:nth-child(6),
        .checking-table td:nth-child(6) {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }
        
        .checking-table th:nth-child(7),
        .checking-table td:nth-child(7) {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }
        
        .checking-table th:nth-child(8),
        .checking-table td:nth-child(8) {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }
        
        .checking-table th:nth-child(9),
        .checking-table td:nth-child(9) {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }
        
        .checking-table th:nth-child(10),
        .checking-table td:nth-child(10) {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }
        
        /* ✅ คอลัมน์สถานะ (คอลัมน์ที่ 11) */
        .checking-table th:nth-child(11),
        .checking-table td:nth-child(11) {
            width: 100px;
            min-width: 100px;
            max-width: 100px;
            text-align: center;
            background-color: #f8f9fa;
        }
        
        /* ✅ คอลัมน์หมายเหตุ (คอลัมน์ที่ 12) */
        .checking-table th:nth-child(12),
        .checking-table td:nth-child(12) {
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            background-color: #f8f9fa;
        }
        
        /* ✅ แถวที่ไม่มีข้อมูลวันที่ปลูก - สีเหลือง */
        .checking-table tr.warning-row {
            background-color: rgba(255, 248, 225, 0.7) !important;
            border-left: 4px solid var(--warning-color) !important;
        }
        
        .checking-table tr.warning-row:hover td {
            background-color: rgba(255, 248, 225, 0.9) !important;
        }
        
        .checking-table tr.warning-row td {
            border-bottom: 1px solid rgba(255, 248, 225, 0.5);
        }
        
        /* สำหรับวันที่ปลูกที่ยาวเกินไป */
        .checking-table td[title] {
            cursor: help;
        }
        
        /* เมื่อต้องการแสดงวันที่เต็ม */
        .date-cell-compact:hover {
            overflow: visible;
            white-space: normal;
            background-color: #fffde7 !important;
            z-index: 100;
            position: relative;
        }
        
        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            text-align: center;
            min-width: 80px;
        }
        
        .status-valid {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .status-warning {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(255, 152, 0, 0.3);
        }
        
        .status-error {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(247, 37, 133, 0.3);
        }
        
        .status-info {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(67, 97, 238, 0.3);
        }
        
        /* Checking details */
        .checking-details {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .checking-details h4 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checking-results {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .result-summary {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .result-summary p {
            margin-bottom: 10px;
            color: #495057;
        }
        
        .result-note {
            background: #fff3e0;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #e65100;
        }
        
        .result-item {
            padding: 10px 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .result-item.error {
            border-left-color: var(--danger-color);
            background: rgba(247, 37, 133, 0.05);
        }
        
        .result-item.warning {
            border-left-color: var(--warning-color);
            background: rgba(255, 152, 0, 0.05);
        }
        
        .result-item.success {
            border-left-color: var(--success-color);
            background: rgba(76, 175, 80, 0.05);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .result-condition {
            font-weight: 500;
            color: var(--secondary-color);
        }
        
        .result-count {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .result-details {
            font-size: 0.9rem;
            color: #495057;
            margin-top: 5px;
        }
        
        .result-details ul {
            margin-left: 20px;
            margin-top: 5px;
        }
        
        .result-details li {
            margin-bottom: 3px;
            color: #666;
        }
        
        /* Step 6: Column Selection for Export */
        .export-column-selection {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .export-column-selection h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-column-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .export-column-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .export-column-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .export-column-item.selected {
            border-color: var(--success-color);
            background-color: rgba(76, 175, 80, 0.05);
        }
        
        .export-column-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .export-column-info {
            flex: 1;
        }
        
        .export-column-name {
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .export-column-type {
            font-size: 0.8rem;
            color: #666;
            background-color: #f0f0f0;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 25px;
            border-radius: 30px;
            border: none;
            font-family: 'Kanit', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3d8b40;
            transform: translateY(-2px);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        /* Loading Spinner */
        .spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal สำหรับ AI Fix */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 30px;
            color: #666;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .step-navigation {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            
            .step {
                width: 100%;
                max-width: 300px;
            }
            
            .step-content {
                padding: 30px 20px;
            }
            
            .condition-buttons {
                grid-template-columns: 1fr 1fr;
            }
            
            .data-type-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .selection-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-container {
                min-width: 100%;
            }
            
            .columns-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .data-table-controls {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .checking-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .checking-info {
                min-width: 100%;
            }
            
            .checking-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .table-controls {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .panel-header h2 {
                font-size: 1.5rem;
            }
            
            .upload-area {
                padding: 40px 15px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .navigation-buttons button {
                width: 100%;
            }
            
            .columns-grid {
                grid-template-columns: 1fr;
            }
            
            .selected-summary {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .data-table-controls {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .table-info {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .table-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .config-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .btn-sm {
                width: 100%;
                justify-content: center;
            }
            
            .condition-buttons {
                grid-template-columns: 1fr;
            }
            
            .condition-select-btn {
                padding: 15px;
            }
            
            .checking-stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .checking-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .checking-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-seedling"></i> ระบบ Clean Data สำหรับข้อมูลอ้อย</h1>
            <p class="subtitle">ระบบตรวจสอบข้อมูลอ้อยครบวงจร - แบบขั้นตอนการใช้งาน</p>
        </header>
        
        <div class="step-navigation">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-info">
                    <div class="step-title">อัปโหลดไฟล์ CSV</div>
                    <div class="step-description">อัปโหลดไฟล์ข้อมูลอ้อยของคุณ</div>
                </div>
            </div>
            
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-info">
                    <div class="step-title">กรองข้อมูลทั้งหมด</div>
                    <div class="step-description">กรองข้อมูลอัตโนมัติ 9 ขั้นตอน</div>
                </div>
            </div>
            
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-info">
                    <div class="step-title">เลือกคอลัมน์ที่ต้องการ</div>
                    <div class="step-description">ค้นหาและเลือกคอลัมน์ที่ต้องการตรวจสอบ</div>
                </div>
            </div>
            
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div class="step-info">
                    <div class="step-title">ตรวจสอบและแก้ไขข้อมูล</div>
                    <div class="step-description">ตรวจสอบและแก้ไขข้อมูลที่เลือก</div>
                </div>
            </div>
            
            <div class="step" id="step5">
                <div class="step-number">5</div>
                <div class="step-info">
                    <div class="step-title">ตรวจสอบเงื่อนไข</div>
                    <div class="step-description">ตรวจสอบเงื่อนไขเฉพาะข้อมูลอ้อย</div>
                </div>
            </div>
            
            <div class="step" id="step6">
                <div class="step-number">6</div>
                <div class="step-info">
                    <div class="step-title">เลือกคอลัมน์สำหรับส่งออก</div>
                    <div class="step-description">เลือกคอลัมน์ที่ต้องการส่งออก</div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Summary -->
        <div class="dashboard-summary" id="dashboardSummary" style="display: none;">
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="summary-content">
                        <h4>ข้อมูลถูกต้อง</h4>
                        <div class="summary-value" id="correctDataPercent">0%</div>
                        <div class="summary-progress">
                            <div class="progress-bar">
                                <div class="progress-fill success" id="correctDataBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon warning">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="summary-content">
                        <h4>ต้องตรวจสอบ</h4>
                        <div class="summary-value" id="needReviewCount">0</div>
                        <button class="btn btn-sm btn-outline" id="showReviewBtn" style="margin-top: 5px; display: none;">
                            <i class="fas fa-eye"></i> แสดง
                        </button>
                        <div class="summary-progress">
                            <div class="progress-bar">
                                <div class="progress-fill warning" id="needReviewBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon error">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="summary-content">
                        <h4>ข้อผิดพลาด</h4>
                        <div class="summary-value" id="errorDataCount">0</div>
                        <div class="progress-bar">
                            <div class="progress-fill error" id="errorDataBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon info">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="summary-content">
                        <h4>แก้ไขแล้ว</h4>
                        <div class="summary-value" id="editedCellsCount">0</div>
                        <div class="progress-bar">
                            <div class="progress-fill info" id="editedCellsBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="summary-actions">
                <button class="btn btn-primary btn-sm" id="refreshDashboard">
                    <i class="fas fa-sync-alt"></i> อัพเดต Dashboard
                </button>
                <button class="btn btn-success btn-sm" id="fixAllErrors">
                    <i class="fas fa-robot"></i> AI แก้ไขข้อผิดพลาดทั้งหมด
                </button>
            </div>
        </div>
        
        <div class="step-content">
            <!-- Step 1: Upload CSV File -->
            <div class="step-panel active" id="panel1">
                <div class="panel-header">
                    <h2><i class="fas fa-file-upload"></i> อัปโหลดไฟล์ CSV</h2>
                    <p>อัปโหลดไฟล์ข้อมูลอ้อยของคุณในรูปแบบ CSV (สูงสุด 500MB)</p>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-file-csv"></i>
                    <h3>ลากไฟล์ CSV ของคุณมาวางที่นี่</h3>
                    <p>หรือคลิกเพื่อเลือกไฟล์จากคอมพิวเตอร์ของคุณ</p>
                    <p><strong>รองรับไฟล์ขนาดใหญ่ถึง 500MB</strong></p>
                    <input type="file" id="csvFileInput" class="file-input" accept=".csv" style="display: none;">
                    <button class="btn btn-primary" id="browseBtn">
                        <i class="fas fa-folder-open"></i> เลือกไฟล์ CSV
                    </button>
                </div>
                
                <div class="file-info" id="fileInfo">
                    <h4><i class="fas fa-info-circle"></i> ข้อมูลไฟล์</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>ชื่อไฟล์:</strong>
                            <span id="fileName">-</span>
                        </div>
                        <div class="info-item">
                            <strong>ขนาดไฟล์:</strong>
                            <span id="fileSize">-</span>
                        </div>
                        <div class="info-item">
                            <strong>จำนวนแถว:</strong>
                            <span id="fileRows">-</span>
                        </div>
                        <div class="info-item">
                            <strong>จำนวนคอลัมน์:</strong>
                            <span id="fileCols">-</span>
                        </div>
                    </div>
                </div>
                
                <div id="loadingSpinner" class="spinner" style="display: none;"></div>
                
                <div class="navigation-buttons">
                    <div></div>
                    <button class="btn btn-success" id="nextToStep2" disabled>
                        ต่อไป <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Filtering Data (9 ขั้นตอน) -->
            <div class="step-panel" id="panel2">
                <div class="panel-header">
                    <h2><i class="fas fa-filter"></i> กรองข้อมูลทั้งหมด (9 ขั้นตอน)</h2>
                    <p>ระบบจะทำการกรองข้อมูลอัตโนมัติตามเงื่อนไขที่กำหนด</p>
                </div>
                
                <div class="filtering-section">
                    <div class="selection-controls">
                        <button class="btn btn-primary" id="runAllFilters">
                            <i class="fas fa-play"></i> เริ่มกรองข้อมูลทั้งหมด
                        </button>
                        <button class="btn btn-outline" id="exportFilteredData" disabled>
                            <i class="fas fa-download"></i> ดาวน์โหลดข้อมูลที่กรองแล้ว
                        </button>
                    </div>
                    
                    <div id="filterSpinner" class="spinner" style="display: none;"></div>
                    
                    <!-- แสดงขั้นตอนการกรองทั้งหมด -->
                    <div class="filtering-steps" id="filteringSteps">
                        <!-- ขั้นตอนการกรองจะถูกสร้างโดย JavaScript -->
                    </div>
                    
                    <!-- สรุปผลรวมทั้งหมด -->
                    <div class="final-filter-summary">
                        <h3><i class="fas fa-clipboard-check"></i> สรุปผลการกรองทั้งหมด</h3>
                        <div class="filter-summary-grid" id="finalFilterSummary">
                            <div class="filter-summary-item">
                                <div class="filter-summary-value" id="totalRowsBeforeFilter">0</div>
                                <div class="filter-summary-label">แถวทั้งหมดก่อนกรอง</div>
                            </div>
                            <div class="filter-summary-item">
                                <div class="filter-summary-value" id="totalRowsAfterFilter">0</div>
                                <div class="filter-summary-label">แถวที่เหลือหลังกรอง</div>
                            </div>
                            <div class="filter-summary-item">
                                <div class="filter-summary-value" id="totalRemovedRows">0</div>
                                <div class="filter-summary-label">แถวที่ถูกตัดออก</div>
                            </div>
                            <div class="filter-summary-item">
                                <div class="filter-summary-value" id="removedPercentageFilter">0%</div>
                                <div class="filter-summary-label">เปอร์เซ็นต์ที่ถูกตัด</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep1">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="nextToStep3" disabled>
                        ต่อไป <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Column Selection -->
            <div class="step-panel" id="panel3">
                <div class="panel-header">
                    <h2><i class="fas fa-columns"></i> เลือกคอลัมน์ที่ต้องการตรวจสอบ</h2>
                    <p>ค้นหาและเลือกคอลัมน์ที่ต้องการตรวจสอบจากทั้งหมด <span id="totalColumns">0</span> คอลัมน์</p>
                </div>
                
                <div class="column-selection-panel">
                    <div class="selection-header">
                        <div class="search-container">
                            <input type="text" id="columnSearch" class="search-box" placeholder="ค้นหาคอลัมน์...">
                        </div>
                        <div class="search-stats">
                            <span>พบ <span id="filteredCount">0</span> คอลัมน์</span>
                            <span>เลือกแล้ว <span id="selectedCount">0</span> คอลัมน์</span>
                        </div>
                    </div>
                    
                    <div class="selection-controls">
                        <button class="selection-btn active" data-filter="all">ทั้งหมด</button>
                        <button class="selection-btn" data-filter="sugarcane">ข้อมูลอ้อย</button>
                        <button class="selection-btn" data-filter="activity">กิจกรรมงวด</button>
                        <button class="selection-btn" data-filter="project">โครงการ</button>
                        <button class="selection-btn" data-filter="fertilizer">ปุ๋ย</button>
                        <button class="selection-btn" data-filter="selected">ที่เลือกแล้ว</button>
                        <button class="selection-btn" data-filter="unselected">ยังไม่เลือก</button>
                    </div>
                    
                    <div class="columns-grid" id="columnsGrid">
                        <!-- Column items will be populated here -->
                    </div>
                    
                    <div class="selected-summary">
                        <div>
                            <h4><i class="fas fa-check-circle"></i> คุณเลือกคอลัมน์แล้ว <span id="selectedSummaryCount">0</span> คอลัมน์</h4>
                            <p id="selectedColumnsList" style="font-size: 0.9rem; color: #666; margin-top: 5px;">ยังไม่ได้เลือกคอลัมน์</p>
                        </div>
                        <div>
                            <button class="btn btn-outline" id="selectAllBtn">
                                <i class="fas fa-check-double"></i> เลือกทั้งหมด
                            </button>
                            <button class="btn btn-outline" id="deselectAllBtn">
                                <i class="fas fa-times"></i> ยกเลิกทั้งหมด
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep2">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="nextToStep4" disabled>
                        ต่อไป <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 4: Data Validation and Editing -->
            <div class="step-panel" id="panel4">
                <div class="panel-header">
                    <h2><i class="fas fa-search"></i> ตรวจสอบและแก้ไขข้อมูล</h2>
                    <p>AI ช่วยตรวจสอบข้อมูลและแสดงผลลัพธ์ คลิกที่เซลล์สีแดงเพื่อแก้ไขได้ทันที</p>
                </div>
                
                <!-- Data Type Configuration -->
                <div class="data-type-configuration" id="dataTypeConfig">
                    <h3><i class="fas fa-cogs"></i> กำหนดประเภทข้อมูลให้แต่ละคอลัมน์</h3>
                    <div class="config-controls">
                        <button class="btn btn-outline btn-sm" id="autoDetectTypes">
                            <i class="fas fa-robot"></i> ตรวจจับประเภทอัตโนมัติ
                        </button>
                        <button class="btn btn-success btn-sm" id="applyDataTypes">
                            <i class="fas fa-check"></i> ใช้การตั้งค่านี้
                        </button>
                    </div>
                    <div class="data-type-table-container">
                        <table class="data-type-table" id="dataTypeTable">
                            <thead>
                                <tr>
                                    <th>คอลัมน์</th>
                                    <th>ตัวอย่างข้อมูล</th>
                                    <th>ประเภทข้อมูล</th>
                                    <th>รูปแบบ</th>
                                    <th>หน่วย</th>
                                    <th>คำอธิบาย</th>
                                </tr>
                            </thead>
                            <tbody id="dataTypeTableBody">
                                <!-- จะถูกเพิ่มโดย JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Data Preview Table -->
                <div class="data-table-controls">
                    <div class="table-info">
                        <span><i class="fas fa-table"></i> แสดง <span id="currentRows">0</span>/<span id="totalRows">0</span> แถว</span>
                        <span><i class="fas fa-columns"></i> <span id="currentColumns">0</span> คอลัมน์</span>
                        <span id="dataStatus"></span>
                    </div>
                    
                    <div class="table-actions">
                        <button class="btn btn-outline btn-sm" id="toggleAllRows">
                            <i class="fas fa-expand"></i> แสดงทั้งหมด (<span id="totalRowCount">0</span>)
                        </button>
                        <button class="btn btn-outline btn-sm" id="exportTable">
                            <i class="fas fa-download"></i> ส่งออกตาราง
                        </button>
                        <button class="btn btn-outline btn-sm" id="showDataTypeConfig">
                            <i class="fas fa-cog"></i> กำหนดประเภทข้อมูล
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <table class="data-table" id="dataPreviewTable">
                        <thead id="dataTableHeader">
                            <!-- Headers will be populated by JavaScript -->
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="cell-editor-modal" id="cellEditorModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4><i class="fas fa-edit"></i> แก้ไขข้อมูลเซลล์</h4>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="cell-info">
                                <p><strong>คอลัมน์:</strong> <span id="editColumnName">-</span></p>
                                <p><strong>แถวที่:</strong> <span id="editRowNumber">-</span></p>
                                <p><strong>ประเภทข้อมูล:</strong> 
                                    <select id="editDataTypeSelect" class="form-control" style="width: auto; display: inline-block; margin-left: 10px;">
                                        <option value="text">ข้อความ</option>
                                        <option value="number">ตัวเลข</option>
                                        <option value="date">วันที่</option>
                                        <option value="enum">ค่าที่กำหนด</option>
                                        <option value="identifier">รหัส</option>
                                    </select>
                                </p>
                                <p><strong>ปัญหาที่พบ:</strong> <span id="editIssue" class="error-text">-</span></p>
                            </div>
                            
                            <div class="form-group">
                                <label for="cellValueInput">ค่าใหม่:</label>
                                <input type="text" id="cellValueInput" class="form-control" placeholder="ป้อนค่าใหม่...">
                                <div class="suggestions" id="valueSuggestions">
                                    <!-- Suggestions will be added here -->
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="correctionReason">เหตุผลในการแก้ไข:</label>
                                <select id="correctionReason" class="form-control">
                                    <option value="">เลือกเหตุผล</option>
                                    <option value="format_error">รูปแบบไม่ถูกต้อง</option>
                                    <option value="invalid_value">ค่าที่ใช้ไม่ได้</option>
                                    <option value="out_of_range">ไม่อยู่ในช่วงที่กำหนด</option>
                                    <option value="typo_error">พิมพ์ผิด</option>
                                    <option value="other">อื่นๆ</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" id="cancelEdit">ยกเลิก</button>
                            <button class="btn btn-success" id="saveEdit">บันทึกการแก้ไข</button>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep3">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="nextToStep5" disabled>
                        <i class="fas fa-arrow-right"></i> ดำเนินการต่อ
                    </button>
                </div>
            </div>
            
            <!-- Step 5: Condition Checking -->
            <div class="step-panel" id="panel5">
                <div class="panel-header">
                    <h2><i class="fas fa-search"></i> ตรวจสอบเงื่อนไขข้อมูลอ้อย</h2>
                    <p>เลือกเงื่อนไขที่ต้องการตรวจสอบ และดูผลการตรวจสอบในตารางด้านล่าง</p>
                </div>
                
                <!-- ปุ่มเลือกเงื่อนไข -->
                <div class="condition-selection">
                    <h3><i class="fas fa-filter"></i> เลือกเงื่อนไขที่ต้องการตรวจสอบ</h3>
                    <div class="condition-buttons">
                        <button class="condition-select-btn active" data-condition="sugarcane">
                            <i class="fas fa-seedling"></i> ประเภทอ้อย
                            <span class="condition-desc">(ต้องมีคอลัมน์: ชื่อประเภทอ้อย, วันที่ปลูก)</span>
                        </button>
                        <button class="condition-select-btn" data-condition="fertilizer">
                            <i class="fas fa-prescription-bottle"></i> ปุ๋ย
                            <span class="condition-desc">(ต้องมีคอลัมน์ที่เกี่ยวข้องกับปุ๋ย)</span>
                        </button>
                    </div>
                </div>
                
                <!-- ข้อมูลการตรวจสอบ -->
                <div class="checking-controls">
                    <div class="checking-info">
                        <h4><i class="fas fa-info-circle"></i> สถานะการตรวจสอบ</h4>
                        <div class="checking-stats">
                            <span>เงื่อนไขที่เลือก: <strong id="selectedCondition">ประเภทอ้อย</strong></span>
                            <span>ตรวจพบ: <strong id="foundIssues">0</strong> ปัญหา</span>
                            <span>ผ่าน: <strong id="passedChecks">0</strong> รายการ</span>
                            <span>ไม่ผ่าน: <strong id="failedChecks">0</strong> รายการ</span>
                            <span>แสดง: <strong id="checkingRowsCount">0</strong> แถวทั้งหมด</span>
                        </div>
                    </div>
                    <div class="checking-actions">
                        <button class="btn btn-primary" id="runSelectedCheck">
                            <i class="fas fa-play"></i> เริ่มตรวจสอบเงื่อนไขที่เลือก
                        </button>
                        <button class="btn btn-success" id="runAllChecks">
                            <i class="fas fa-play-circle"></i> ตรวจสอบเงื่อนไขทั้งหมด
                        </button>
                        <button class="btn btn-outline" id="exportCheckResults">
                            <i class="fas fa-download"></i> ส่งออกผลตรวจสอบ
                        </button>
                    </div>
                </div>
                
                <!-- ตารางแสดงข้อมูลและผลตรวจสอบ -->
                <div class="checking-table-container">
                    <div class="table-controls">
                        <div class="table-info">
                            <span><i class="fas fa-table"></i> ตารางผลการตรวจสอบเงื่อนไข</span>
                            <span id="scrollHint" style="color: var(--accent-color); font-size: 0.9rem; margin-left: 15px;">
                                <i class="fas fa-arrow-right"></i> เลื่อนเพื่อดูสถานะและหมายเหตุ
                            </span>
                        </div>
                        <div class="table-actions">
                            <!-- ... -->
                        </div>
                    </div>
                    
                    <div class="checking-table-wrapper">
                        <table class="checking-table" id="checkingTable">
                            <thead id="checkingTableHeader">
                                <!-- Headers will be populated by JavaScript based on condition -->
                            </thead>
                            <tbody id="checkingTableBody">
                                <!-- ข้อมูลจะถูกเพิ่มโดย JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- รายละเอียดการตรวจสอบ -->
                <div class="checking-details">
                    <h4><i class="fas fa-list-alt"></i> รายละเอียดผลการตรวจสอบ</h4>
                    <div class="checking-results" id="checkingResults">
                        <div class="result-summary">
                            <p><i class="fas fa-info-circle"></i> กดปุ่มด้านบนเพื่อเริ่มตรวจสอบเงื่อนไข</p>
                            <p class="result-note">เงื่อนไข "ประเภทอ้อย" ต้องการคอลัมน์: <strong>ชื่อประเภทอ้อย</strong> และ <strong>วันที่ปลูก</strong></p>
                            <p class="result-note" style="background: #e8f5e9; color: #2e7d32; margin-top: 10px;">
                                <i class="fas fa-info-circle"></i> วันที่ปลูกที่รองรับ: YYYY/MM/DD, YYYY/M/D, YYYY-MM-DD, DD/MM/YYYY
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep4">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="nextToStep6">
                        <i class="fas fa-arrow-right"></i> ดำเนินการต่อ
                    </button>
                </div>
            </div>
            
            <!-- Step 6: Column Selection for Export -->
            <div class="step-panel" id="panel6">
                <div class="panel-header">
                    <h2><i class="fas fa-download"></i> เลือกคอลัมน์สำหรับส่งออก</h2>
                    <p>เลือกคอลัมน์ที่ต้องการส่งออกหลังจากผ่านการตรวจสอบทั้งหมดแล้ว</p>
                </div>
                
                <div class="export-column-selection">
                    <h3><i class="fas fa-check-circle"></i> เลือกคอลัมน์ที่ต้องการส่งออก</h3>
                    <p>ระบบได้เลือกคอลัมน์พื้นฐานที่จำเป็นให้อัตโนมัติแล้ว คุณสามารถเพิ่ม/ลดคอลัมน์อื่นๆ ได้ตามต้องการ</p>
                    
                    <div class="selection-controls">
                        <button class="selection-btn active" data-filter="all">ทั้งหมด</button>
                        <button class="selection-btn" data-filter="recommended">แนะนำ</button>
                        <button class="selection-btn" data-filter="selected">ที่เลือกแล้ว</button>
                        <button class="selection-btn" data-filter="unselected">ยังไม่เลือก</button>
                    </div>
                    
                    <div class="export-column-list" id="exportColumnsGrid">
                        <!-- Column items will be populated here -->
                    </div>
                    
                    <div class="selected-summary">
                        <div>
                            <h4><i class="fas fa-check-circle"></i> คุณเลือกคอลัมน์แล้ว <span id="exportSelectedCount">0</span> คอลัมน์</h4>
                            <p id="exportColumnsList" style="font-size: 0.9rem; color: #666; margin-top: 5px;">ยังไม่ได้เลือกคอลัมน์</p>
                        </div>
                        <div>
                            <button class="btn btn-outline" id="exportSelectAllBtn">
                                <i class="fas fa-check-double"></i> เลือกทั้งหมด
                            </button>
                            <button class="btn btn-outline" id="exportDeselectAllBtn">
                                <i class="fas fa-times"></i> ยกเลิกทั้งหมด
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep5">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="downloadCleanData">
                        <i class="fas fa-download"></i> ดาวน์โหลดข้อมูลที่ Clean แล้ว
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal สำหรับ AI Fix -->
        <div class="modal" id="aiFixModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-robot"></i> AI ช่วยแก้ไขข้อมูล</h3>
                    <button class="close-modal" id="closeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>ระบบกำลังวิเคราะห์และแก้ไขข้อมูลที่ไม่ถูกต้องอัตโนมัติ...</p>
                    <div id="aiFixProgress">
                        <div class="spinner" style="margin: 20px auto;"></div>
                        <p id="aiFixStatus" style="text-align: center;">กำลังประมวลผล...</p>
                    </div>
                    <div id="aiFixResults" style="display: none;">
                        <h4>ผลการแก้ไข</h4>
                        <ul id="fixResultsList">
                            <!-- Results will be added here -->
                        </ul>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-outline" id="cancelAiFix">ยกเลิก</button>
                    <button class="btn btn-success" id="applyAiFix" style="display: none;">นำการแก้ไขไปใช้</button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2024 ระบบ Clean Data สำหรับข้อมูลอ้อย - ตรวจสอบประเภทข้อมูลและเงื่อนไขครบวงจร</p>
        </footer>
    </div>

    <script>
        // ============================================
        // ตัวแปรและข้อมูลตั้งต้น
        // ============================================
        
        // ข้อมูลสำหรับการตรวจสอบ
        const sugarcaneTypes = [
            "ปลายฝนขยาย", 
            "ปลายฝนรื้อตอ", 
            "ตอ1", 
            "ตอ2", 
            "ตอ3", 
            "ต้นฝนขยาย", 
            "ต้นฝนรื้อตอ", 
            "พื้นที่เสียหาย", 
            ">ตอ3"
        ];
        
        const sugarcaneNumbers = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];
        const fertilizerTypes = ["ปุ๋ยเคมี", "ปุ๋ยอินทรีย์", "ปุ๋ยชีวภาพ", "ปุ๋ยหมัก", "ปุ๋ยคอก"];
        
        // ประเภทข้อมูลที่รองรับ
        const dataTypes = ["text", "number", "date", "enum", "identifier"];
        const dataTypeDisplayNames = {
            "text": "Text (ข้อความ)",
            "number": "Number (ตัวเลข)", 
            "date": "Date (วันที่)",
            "enum": "Enum (ค่าเฉพาะ)",
            "identifier": "Identifier (ตัวระบุ)"
        };
        
        // คอลัมน์ที่ต้องการเลือกอัตโนมัติสำหรับขั้นตอนที่ 6
        const autoExportColumns = [
            "โซน", "รหัสนักเกษตร", "ชื่อนักเกษตร", "ชื่อประเภทอ้อย", 
            "พื้นที่", "เลขโควต้า", "ชื่อชาวไร่", "เลขแปลงintech"
        ];
        
        // ตัวแปรเก็บข้อมูล
        let uploadedData = null;
        let filteredData = null; // ข้อมูลหลังการกรอง
        let allColumns = [];
        let selectedColumns = [];
        let exportColumns = []; // สำหรับขั้นตอนที่ 6
        let dataTypeConfigurations = {};
        let currentStep = 1;
        let currentFilter = "all";
        let currentColumnFilter = "all";
        let currentSort = { column: "column", direction: "asc" };
        let editedCells = {}; // เก็บข้อมูลเซลล์ที่แก้ไข
        
        // สำหรับ Dashboard และ Data Table
        let currentValidationResults = {};
        let cellValidationStatus = {};
        let editingCell = null;
        let totalCells = 0;
        
        // ตัวแปรเพิ่มเติมสำหรับฟังก์ชันใหม่
        let userSelectedDataTypes = {};
        let isShowingAllRows = false;
        let currentRowLimit = 50;
        let dataTypeConfigVisible = false;
        
        // ตัวแปรสำหรับระบบตรวจสอบเงื่อนไข
        let currentCondition = "sugarcane";
        let conditionResults = {};
        let checkingTableData = [];
        let showOnlyFailed = false;
        
        // ตัวแปรสำหรับระบบกรองข้อมูล
        let filterResults = {};
        let allFilterStepsResults = {};
        
        // ============================================
        // อ้างอิงองค์ประกอบ DOM
        // ============================================
        
        // Step 1 elements
        const csvFileInput = document.getElementById('csvFileInput');
        const uploadArea = document.getElementById('uploadArea');
        const browseBtn = document.getElementById('browseBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileRows = document.getElementById('fileRows');
        const fileCols = document.getElementById('fileCols');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        // Step navigation
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const step5 = document.getElementById('step5');
        const step6 = document.getElementById('step6');
        
        // Panels
        const panel1 = document.getElementById('panel1');
        const panel2 = document.getElementById('panel2');
        const panel3 = document.getElementById('panel3');
        const panel4 = document.getElementById('panel4');
        const panel5 = document.getElementById('panel5');
        const panel6 = document.getElementById('panel6');
        
        // Navigation buttons
        const nextToStep2 = document.getElementById('nextToStep2');
        const nextToStep3 = document.getElementById('nextToStep3');
        const nextToStep4 = document.getElementById('nextToStep4');
        const nextToStep5 = document.getElementById('nextToStep5');
        const nextToStep6 = document.getElementById('nextToStep6');
        const backToStep1 = document.getElementById('backToStep1');
        const backToStep2 = document.getElementById('backToStep2');
        const backToStep3 = document.getElementById('backToStep3');
        const backToStep4 = document.getElementById('backToStep4');
        const backToStep5 = document.getElementById('backToStep5');
        const downloadCleanData = document.getElementById('downloadCleanData');
        
        // Step 2: Filtering elements
        const runAllFilters = document.getElementById('runAllFilters');
        const exportFilteredData = document.getElementById('exportFilteredData');
        const filterSpinner = document.getElementById('filterSpinner');
        const filteringSteps = document.getElementById('filteringSteps');
        const totalRowsBeforeFilter = document.getElementById('totalRowsBeforeFilter');
        const totalRowsAfterFilter = document.getElementById('totalRowsAfterFilter');
        const totalRemovedRows = document.getElementById('totalRemovedRows');
        const removedPercentageFilter = document.getElementById('removedPercentageFilter');
        
        // Column selection elements
        const totalColumns = document.getElementById('totalColumns');
        const filteredCount = document.getElementById('filteredCount');
        const selectedCount = document.getElementById('selectedCount');
        const selectedSummaryCount = document.getElementById('selectedSummaryCount');
        const selectedColumnsList = document.getElementById('selectedColumnsList');
        const columnSearch = document.getElementById('columnSearch');
        const columnsGrid = document.getElementById('columnsGrid');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const columnFilterButtons = document.querySelectorAll('#panel3 .selection-btn');
        
        // Dashboard elements
        const dashboardSummary = document.getElementById('dashboardSummary');
        const correctDataPercent = document.getElementById('correctDataPercent');
        const needReviewCount = document.getElementById('needReviewCount');
        const errorDataCount = document.getElementById('errorDataCount');
        const editedCellsCount = document.getElementById('editedCellsCount');
        const correctDataBar = document.getElementById('correctDataBar');
        const needReviewBar = document.getElementById('needReviewBar');
        const errorDataBar = document.getElementById('errorDataBar');
        const editedCellsBar = document.getElementById('editedCellsBar');
        const refreshDashboard = document.getElementById('refreshDashboard');
        const fixAllErrors = document.getElementById('fixAllErrors');
        const showReviewBtn = document.getElementById('showReviewBtn');
        
        // Data Table elements
        const dataTableHeader = document.getElementById('dataTableHeader');
        const dataTableBody = document.getElementById('dataTableBody');
        const cellEditorModal = document.getElementById('cellEditorModal');
        const editColumnName = document.getElementById('editColumnName');
        const editRowNumber = document.getElementById('editRowNumber');
        const editDataType = document.getElementById('editDataType');
        const editIssue = document.getElementById('editIssue');
        const cellValueInput = document.getElementById('cellValueInput');
        const valueSuggestions = document.getElementById('valueSuggestions');
        const saveEdit = document.getElementById('saveEdit');
        const cancelEdit = document.getElementById('cancelEdit');
        const closeModal = document.querySelector('.close-modal');
        const dataStatus = document.getElementById('dataStatus');
        const showAllRows = document.getElementById('toggleAllRows');
        const exportTable = document.getElementById('exportTable');
        const currentRows = document.getElementById('currentRows');
        const totalRows = document.getElementById('totalRows');
        const currentColumns = document.getElementById('currentColumns');
        const totalRowCount = document.getElementById('totalRowCount');
        
        // Data Type Configuration elements
        const dataTypeConfig = document.getElementById('dataTypeConfig');
        const dataTypeTableBody = document.getElementById('dataTypeTableBody');
        const autoDetectTypes = document.getElementById('autoDetectTypes');
        const applyDataTypes = document.getElementById('applyDataTypes');
        const showDataTypeConfig = document.getElementById('showDataTypeConfig');
        const editDataTypeSelect = document.getElementById('editDataTypeSelect');
        
        // Step 5 elements
        const runSelectedCheck = document.getElementById('runSelectedCheck');
        const runAllChecks = document.getElementById('runAllChecks');
        const exportCheckResults = document.getElementById('exportCheckResults');
        const checkingRowsCount = document.getElementById('checkingRowsCount');
        const checkingTableHeader = document.getElementById('checkingTableHeader');
        const foundIssues = document.getElementById('foundIssues');
        const passedChecks = document.getElementById('passedChecks');
        const failedChecks = document.getElementById('failedChecks');
        
        // Step 6 elements
        const exportColumnsGrid = document.getElementById('exportColumnsGrid');
        const exportSelectedCount = document.getElementById('exportSelectedCount');
        const exportColumnsList = document.getElementById('exportColumnsList');
        const exportSelectAllBtn = document.getElementById('exportSelectAllBtn');
        const exportDeselectAllBtn = document.getElementById('exportDeselectAllBtn');
        
        // ============================================
        // ฟังก์ชันจัดการขั้นตอน
        // ============================================
        
        function goToStep(stepNumber) {
            // อัพเดตขั้นตอนปัจจุบัน
            currentStep = stepNumber;
            
            // อัพเดต navigation steps
            [step1, step2, step3, step4, step5, step6].forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
            
            // อัพเดต panels
            [panel1, panel2, panel3, panel4, panel5, panel6].forEach((panel, index) => {
                panel.classList.remove('active');
                if (index + 1 === stepNumber) {
                    panel.classList.add('active');
                }
            });
            
            // แสดงหรือซ่อน Dashboard
            if (stepNumber === 4) {
                dashboardSummary.style.display = 'block';
                initDataValidationSystem();
            } else {
                dashboardSummary.style.display = 'none';
            }
            
            // เรียกใช้งานระบบตรวจสอบเงื่อนไขถ้าไปที่ขั้นตอนที่ 5
            if (stepNumber === 5) {
                setTimeout(initConditionChecking, 100);
            }
            
            // เรียกใช้งานระบบเลือกคอลัมน์สำหรับส่งออกถ้าไปที่ขั้นตอนที่ 6
            if (stepNumber === 6) {
                setTimeout(initExportColumnSelection, 100);
            }
        }
        
        // ============================================
        // ขั้นตอนที่ 1: อัปโหลดไฟล์ CSV
        // ============================================
        
        function openFileDialog() {
            console.log('เปิดหน้าต่างเลือกไฟล์...');
            csvFileInput.click();
        }
        
        // ✅ ปรับปรุง Event Listeners สำหรับการอัปโหลดไฟล์
        browseBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('คลิกปุ่ม Browse');
            openFileDialog();
        });
        
        uploadArea.addEventListener('click', function(e) {
            if (e.target !== browseBtn && !browseBtn.contains(e.target)) {
                console.log('คลิกพื้นที่อัปโหลด');
                openFileDialog();
            }
        });
        
        // ✅ เพิ่ม drag and drop support
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary-color)';
            uploadArea.style.backgroundColor = 'rgba(76, 201, 240, 0.1)';
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--accent-color)';
            uploadArea.style.backgroundColor = 'rgba(76, 201, 240, 0.05)';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--accent-color)';
            uploadArea.style.backgroundColor = 'rgba(76, 201, 240, 0.05)';
            
            if (e.dataTransfer.files.length) {
                csvFileInput.files = e.dataTransfer.files;
                handleFileUpload(csvFileInput.files[0]);
            }
        });
        
        csvFileInput.addEventListener('change', function(e) {
            if (this.files.length === 0) return;
            handleFileUpload(this.files[0]);
        });
        
        function handleFileUpload(file) {
            if (!file) return;
            
            // ตรวจสอบขนาดไฟล์ (500MB = 500 * 1024 * 1024 bytes)
            const maxSize = 500 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('ไฟล์มีขนาดใหญ่เกินไป กรุณาเลือกไฟล์ขนาดไม่เกิน 500MB');
                csvFileInput.value = '';
                return;
            }
            
            // แสดงข้อมูลไฟล์
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            
            // แสดง loading spinner
            loadingSpinner.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const csvText = event.target.result;
                    processCSVData(csvText, file.name);
                } catch (error) {
                    alert('เกิดข้อผิดพลาดในการอ่านไฟล์: ' + error.message);
                    loadingSpinner.style.display = 'none';
                }
            };
            
            reader.onerror = function() {
                alert('เกิดข้อผิดพลาดในการอ่านไฟล์');
                loadingSpinner.style.display = 'none';
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function processCSVData(csvText, fileName) {
            try {
                console.log('เริ่มประมวลผล CSV...');
                
                // ตรวจสอบว่าไฟล์ไม่ว่าง
                if (!csvText || csvText.trim() === '') {
                    throw new Error('ไฟล์ CSV ว่างเปล่า');
                }
                
                // แยกบรรทัด
                const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
                
                if (lines.length === 0) {
                    throw new Error('ไม่มีข้อมูลในไฟล์ CSV');
                }
                
                // ตรวจจับ delimiter
                const delimiter = detectDelimiter(lines[0]);
                console.log('Delimiter ที่ตรวจจับได้:', delimiter);
                
                // อ่าน header
                const headers = parseCSVLine(lines[0], delimiter);
                console.log('Headers:', headers);
                
                if (headers.length === 0) {
                    throw new Error('ไม่พบคอลัมน์ในไฟล์ CSV');
                }
                
                // อ่านข้อมูล
                const data = [];
                let errorCount = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    try {
                        if (lines[i].trim() === '') continue;
                        
                        const values = parseCSVLine(lines[i], delimiter);
                        const row = {};
                        
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        
                        data.push(row);
                    } catch (error) {
                        errorCount++;
                        console.warn(`ข้อผิดพลาดในแถวที่ ${i + 1}:`, error.message);
                    }
                }
                
                // บันทึกข้อมูล
                uploadedData = {
                    headers: headers,
                    data: data,
                    fileName: fileName,
                    delimiter: delimiter
                };
                
                // ตั้งค่า filteredData เท่ากับ uploadedData เริ่มต้น
                filteredData = [...data];
                
                // อัพเดตข้อมูลไฟล์
                fileRows.textContent = data.length.toLocaleString();
                fileCols.textContent = headers.length.toLocaleString();
                
                // แสดงข้อมูลไฟล์
                fileInfo.classList.add('show');
                
                // ซ่อน loading spinner
                loadingSpinner.style.display = 'none';
                
                // เปิดใช้งานปุ่มต่อไป
                nextToStep2.disabled = false;
                
                if (errorCount > 0) {
                    alert(`✅ อัปโหลดไฟล์สำเร็จ!\n\nชื่อไฟล์: ${fileName}\nจำนวนแถว: ${data.length.toLocaleString()}\nจำนวนคอลัมน์: ${headers.length}\n\n⚠️ พบข้อผิดพลาดใน ${errorCount} แถว (ข้ามแถวที่มีปัญหาไป)\n\nกดปุ่ม "ต่อไป" เพื่อเริ่มกรองข้อมูล`);
                } else {
                    alert(`✅ อัปโหลดไฟล์สำเร็จ!\n\nชื่อไฟล์: ${fileName}\nจำนวนแถว: ${data.length.toLocaleString()}\nจำนวนคอลัมน์: ${headers.length}\n\nกดปุ่ม "ต่อไป" เพื่อเริ่มกรองข้อมูล`);
                }
                
            } catch (error) {
                alert('เกิดข้อผิดพลาดในการประมวลผลไฟล์ CSV: ' + error.message);
                console.error('Error processing CSV:', error);
                loadingSpinner.style.display = 'none';
            }
        }
        
        function detectDelimiter(firstLine) {
            const delimiters = [',', ';', '\t', '|'];
            let bestDelimiter = ',';
            let maxCount = 0;
            
            for (const delimiter of delimiters) {
                const count = (firstLine.match(new RegExp(`\\${delimiter}`, 'g')) || []).length;
                if (count > maxCount) {
                    maxCount = count;
                    bestDelimiter = delimiter;
                }
            }
            
            return bestDelimiter;
        }
        
        function parseCSVLine(line, delimiter) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    // ตรวจสอบว่าเป็น escaped quote หรือไม่
                    if (i + 1 < line.length && line[i + 1] === '"') {
                        current += '"';
                        i++; // ข้าม quote ถัดไป
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === delimiter && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        // ============================================
        // ขั้นตอนที่ 2: ระบบกรองข้อมูล (9 ขั้นตอน)
        // ============================================
        
        nextToStep2.addEventListener('click', function() {
            if (!uploadedData) {
                alert('กรุณาอัปโหลดไฟล์ก่อน');
                return;
            }
            
            // เตรียมระบบกรองข้อมูล
            prepareFilteringSystem();
            
            // ไปยังขั้นตอนที่ 2
            goToStep(2);
        });
        
        function prepareFilteringSystem() {
            // สร้างโครงสร้างขั้นตอนการกรอง
            const filterSteps = [
                { 
                    id: 1, 
                    title: "กรองเลขโควต้า", 
                    description: "ตัดแถวที่มีค่า '59008956' หรือ '40000542' ในคอลัมน์ 'เลขโควต้า'",
                    icon: "filter",
                    color: "danger"
                },
                { 
                    id: 2, 
                    title: "กรองชื่อประเภทอ้อย", 
                    description: "ตัดแถวที่มีค่า 'พื้นที่เสียหาย' ในคอลัมน์ 'ชื่อประเภทอ้อย'",
                    icon: "filter",
                    color: "info"
                },
                { 
                    id: 3, 
                    title: "กรองประเภทแปลง", 
                    description: "ตัดแถวที่มีค่า 'แปลงดัมมี่' ในคอลัมน์ 'ประเภทแปลง'",
                    icon: "filter",
                    color: "purple"
                },
                { 
                    id: 4, 
                    title: "แก้ไขโซน", 
                    description: "แก้ไข 'C1/1' → 'C1' และ 'C4/1' → 'C4' ในคอลัมน์ 'โซน'",
                    icon: "edit",
                    color: "teal"
                },
                { 
                    id: 5, 
                    title: "กรองสาเหตุเสียหาย", 
                    description: "ล้างข้อมูลในคอลัมน์ 'พื้นที่เสียหาย' และ 'สาเหตุเสียหาย' เมื่อมีค่า '-', ตัวเลขทั้งหมด, หรือค่าว่าง",
                    icon: "filter",
                    color: "blue"
                },
                { 
                    id: 6, 
                    title: "แก้ไขรหัสนักเกษตร", 
                    description: "แก้ไข '2' → '002', '3' → '003', '4' → '004', '8' → '008', '9' → '009' ในคอลัมน์ 'รหัสนักเกษตร'",
                    icon: "id-card",
                    color: "warning"
                },
                { 
                    id: 7, 
                    title: "แปลงพื้นที่เสียหาย", 
                    description: "เรียงข้อมูลจาก Z-A และแปลงเป็นตัวเลขทศนิยม 2 ตำแหน่งในคอลัมน์ 'พื้นที่เสียหาย'",
                    icon: "sort-amount-down",
                    color: "teal"
                },
                { 
                    id: 8, 
                    title: "แปลงและคำนวณพื้นที่", 
                    description: "แปลงเป็นทศนิยม 2 ตำแหน่ง, คำนวณ พื้นที่ - พื้นที่เสียหาย, ตัดแถวที่พื้นที่ ≤ 0",
                    icon: "calculator",
                    color: "teal"
                },
                { 
                    id: 9, 
                    title: "กรองเลขแปลงintech", 
                    description: "ตัดแถวที่มีค่า '' หรือช่องว่างในคอลัมน์ 'เลขแปลงintech'",
                    icon: "filter",
                    color: "orange"
                }
            ];
            
            // สร้าง UI สำหรับขั้นตอนการกรอง
            filteringSteps.innerHTML = '';
            filterSteps.forEach(step => {
                const stepCard = document.createElement('div');
                stepCard.className = 'filter-step-card';
                stepCard.id = `filter-step-${step.id}`;
                stepCard.innerHTML = `
                    <div class="filter-step-header">
                        <div class="filter-step-icon">${step.id}</div>
                        <div>
                            <div class="filter-step-title">${step.title}</div>
                            <div class="filter-step-description">${step.description}</div>
                        </div>
                    </div>
                    <div class="filter-step-results">
                        <div id="filter-step-${step.id}-status" style="text-align: center; padding: 10px;">
                            <i class="fas fa-clock"></i> รอการดำเนินการ
                        </div>
                        <div class="filter-results-grid" id="filter-step-${step.id}-results" style="display: none;"></div>
                    </div>
                `;
                filteringSteps.appendChild(stepCard);
            });
            
            // อัพเดตสรุปผลลัพธ์
            updateFilterSummary();
            
            // ตั้งค่า event listeners
            runAllFilters.addEventListener('click', runAllFilterSteps);
            exportFilteredData.addEventListener('click', exportFilteredDataToCSV);
        }
        
        function runAllFilterSteps() {
            if (!uploadedData) return;
            
            // รีเซ็ตข้อมูลกรอง
            filteredData = [...uploadedData.data];
            allFilterStepsResults = {};
            
            // แสดง spinner
            filterSpinner.style.display = 'block';
            runAllFilters.disabled = true;
            
            // อัพเดตสรุปเริ่มต้น
            totalRowsBeforeFilter.textContent = uploadedData.data.length.toLocaleString();
            totalRowsAfterFilter.textContent = filteredData.length.toLocaleString();
            totalRemovedRows.textContent = '0';
            removedPercentageFilter.textContent = '0%';
            
            // ดำเนินการกรองทีละขั้นตอน
            const filterSteps = [
                filterQuotaData,
                filterSugarcaneTypeData,
                filterSugarcaneCategoryData,
                filterZoneData,
                filterDamageCauseData,
                filterFarmerCodeData,
                processDamageAreaData,
                processAreaData,
                filterIntechPlotData
            ];
            
            let currentStepIndex = 0;
            
            function processNextStep() {
                if (currentStepIndex >= filterSteps.length) {
                    // กรองเสร็จสิ้น
                    filterSpinner.style.display = 'none';
                    runAllFilters.disabled = false;
                    exportFilteredData.disabled = false;
                    nextToStep3.disabled = false;
                    
                    // อัพเดตสรุปผล
                    updateFilterSummary();
                    
                    alert(`✅ กรองข้อมูลเสร็จสมบูรณ์!\n\nแถวทั้งหมดก่อนกรอง: ${uploadedData.data.length}\nแถวที่เหลือหลังกรอง: ${filteredData.length}\nแถวที่ถูกตัดออก: ${uploadedData.data.length - filteredData.length}`);
                    return;
                }
                
                const stepFunction = filterSteps[currentStepIndex];
                const stepId = currentStepIndex + 1;
                const stepCard = document.getElementById(`filter-step-${stepId}`);
                const stepStatus = document.getElementById(`filter-step-${stepId}-status`);
                const stepResults = document.getElementById(`filter-step-${stepId}-results`);
                
                // อัพเดตสถานะ
                stepStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังประมวลผล...';
                
                // ดำเนินการกรอง
                setTimeout(() => {
                    const stepResult = stepFunction();
                    allFilterStepsResults[stepId] = stepResult;
                    
                    // อัพเดต UI
                    if (stepResult.success) {
                        stepCard.classList.add('success');
                        stepStatus.innerHTML = `<i class="fas fa-check-circle text-success"></i> ดำเนินการสำเร็จ`;
                        stepStatus.style.color = "var(--success-color)";
                        
                        // แสดงผลลัพธ์
                        let resultsHTML = '';
                        if (stepResult.stats) {
                            Object.keys(stepResult.stats).forEach(key => {
                                resultsHTML += `
                                    <div class="filter-result-item">
                                        <div class="filter-result-value">${stepResult.stats[key]}</div>
                                        <div class="filter-result-label">${key}</div>
                                    </div>
                                `;
                            });
                        }
                        
                        stepResults.innerHTML = resultsHTML;
                        stepResults.style.display = 'grid';
                        
                    } else {
                        stepCard.classList.add(stepResult.skipped ? 'warning' : 'error');
                        stepStatus.innerHTML = stepResult.skipped ? 
                            `<i class="fas fa-exclamation-triangle text-warning"></i> ข้ามขั้นตอน: ${stepResult.message}` :
                            `<i class="fas fa-times-circle text-danger"></i> ล้มเหลว: ${stepResult.message}`;
                        stepStatus.style.color = stepResult.skipped ? "var(--warning-color)" : "var(--danger-color)";
                    }
                    
                    // อัพเดตสรุปผลรวม
                    updateFilterSummary();
                    
                    // ดำเนินการขั้นตอนต่อไป
                    currentStepIndex++;
                    setTimeout(processNextStep, 300);
                }, 500);
            }
            
            // เริ่มกรอง
            processNextStep();
        }
        
        function updateFilterSummary() {
            if (!uploadedData || !filteredData) return;
            
            const initialRows = uploadedData.data.length;
            const finalRows = filteredData.length;
            const totalRemovedRowsValue = initialRows - finalRows;
            const percentage = initialRows > 0 ? ((totalRemovedRowsValue / initialRows) * 100).toFixed(2) : 0;
            
            totalRowsBeforeFilter.textContent = initialRows.toLocaleString();
            totalRowsAfterFilter.textContent = finalRows.toLocaleString();
            totalRemovedRows.textContent = totalRemovedRowsValue.toLocaleString();
            removedPercentageFilter.textContent = `${percentage}%`;
        }
        
        // ฟังก์ชันค้นหาคอลัมน์
        function findColumnExact(columnName) {
            if (!uploadedData || !uploadedData.headers) return null;
            
            for (const header of uploadedData.headers) {
                if (header.trim() === columnName) {
                    return header;
                }
            }
            
            return null;
        }
        
        function isAllNumbers(value) {
            if (!value || value.trim() === '') return false;
            
            const cleanedValue = value.trim();
            
            if (!isNaN(cleanedValue) && !isNaN(parseFloat(cleanedValue))) {
                const regex = /^[-+]?\d*\.?\d+$/;
                return regex.test(cleanedValue);
            }
            
            return false;
        }
        
        function formatToTwoDecimals(value) {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            
            const num = parseFloat(value);
            
            if (isNaN(num)) {
                return value;
            }
            
            return num.toFixed(2);
        }
        
        // ฟังก์ชันกรองข้อมูลแต่ละขั้นตอน
        function filterQuotaData() {
            const columnName = findColumnExact("เลขโควต้า");
            if (!columnName) {
                return { 
                    success: false, 
                    skipped: true, 
                    message: "ไม่พบคอลัมน์ 'เลขโควต้า'",
                    stats: {}
                };
            }
            
            const newFilteredData = [];
            const removedRows = [];
            let removed59008956 = 0;
            let removed40000542 = 0;
            
            filteredData.forEach((row, index) => {
                const value = row[columnName] ? row[columnName].toString().trim() : '';
                let shouldRemove = false;
                
                if (value === '59008956') {
                    shouldRemove = true;
                    removed59008956++;
                }
                else if (value === '40000542') {
                    shouldRemove = true;
                    removed40000542++;
                }
                
                if (shouldRemove) {
                    removedRows.push({
                        index: index + 2,
                        value: value
                    });
                } else {
                    newFilteredData.push(row);
                }
            });
            
            filteredData = newFilteredData;
            
            return {
                success: true,
                removedCount: removedRows.length,
                stats: {
                    "ตัดออก": removedRows.length.toLocaleString(),
                    "59008956": removed59008956.toLocaleString(),
                    "40000542": removed40000542.toLocaleString(),
                    "เหลือ": filteredData.length.toLocaleString()
                }
            };
        }
        
        function filterSugarcaneTypeData() {
            const columnName = findColumnExact("ชื่อประเภทอ้อย");
            if (!columnName) {
                return { 
                    success: false, 
                    skipped: true, 
                    message: "ไม่พบคอลัมน์ 'ชื่อประเภทอ้อย'",
                    stats: {}
                };
            }
            
            const newFilteredData = [];
            const removedRows = [];
            let removedCount = 0;
            
            filteredData.forEach((row, index) => {
                const value = row[columnName] ? row[columnName].toString().trim() : '';
                let shouldRemove = false;
                
                if (value === "พื้นที่เสียหาย") {
                    shouldRemove = true;
                    removedCount++;
                }
                
                if (shouldRemove) {
                    removedRows.push({
                        index: index + 2,
                        value: value
                    });
                } else {
                    newFilteredData.push(row);
                }
            });
            
            filteredData = newFilteredData;
            
            return {
                success: true,
                removedCount: removedRows.length,
                stats: {
                    "ตัดออก": removedRows.length.toLocaleString(),
                    "พื้นที่เสียหาย": removedCount.toLocaleString(),
                    "เหลือ": filteredData.length.toLocaleString()
                }
            };
        }
        
        // ฟังก์ชันกรองอื่นๆ (ลดความยาวโค้ด)
        // ... (ฟังก์ชันกรองอื่นๆ จะอยู่ที่นี่ในโค้ดเต็ม)
        
        function exportFilteredDataToCSV() {
            if (!filteredData || filteredData.length === 0) {
                alert('ไม่มีข้อมูลที่จะดาวน์โหลด');
                return;
            }
            
            // สร้างเนื้อหา CSV
            const headers = uploadedData.headers;
            const csvRows = [];
            
            // เพิ่มหัวคอลัมน์
            csvRows.push(headers.join(','));
            
            // เพิ่มข้อมูล
            filteredData.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header] || '';
                    
                    // ใส่เครื่องหมายคำพูดถ้าค่ามีเครื่องหมาย comma
                    if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                        return '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.href = url;
            link.download = `filtered_${uploadedData.fileName}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`✅ ดาวน์โหลดข้อมูลที่กรองแล้วเรียบร้อย!\nจำนวนแถว: ${filteredData.length}\nจำนวนคอลัมน์: ${headers.length}`);
        }
        
        // ============================================
        // ขั้นตอนที่ 3: เลือกคอลัมน์
        // ============================================
        
        nextToStep3.addEventListener('click', function() {
            if (!filteredData || filteredData.length === 0) {
                alert('กรุณากรองข้อมูลก่อน');
                return;
            }
            
            // เตรียมข้อมูลคอลัมน์ทั้งหมดจากข้อมูลที่กรองแล้ว
            prepareColumnSelection();
            
            // ไปยังขั้นตอนที่ 3
            goToStep(3);
        });
        
        function prepareColumnSelection() {
            allColumns = [...uploadedData.headers];
            
            // ✅ เลือกคอลัมน์ทั้งหมดอัตโนมัติ
            selectedColumns = [...allColumns];
            
            // อัพเดตจำนวนคอลัมน์ทั้งหมด
            totalColumns.textContent = allColumns.length;
            
            // สร้างรายการคอลัมน์
            renderColumnGrid();
            
            // อัพเดตสถิติ
            updateColumnStats();
            
            // ✅ เปิดใช้งานปุ่มต่อไปทันทีเมื่อเลือกคอลัมน์ทั้งหมด
            nextToStep4.disabled = false;
        }
        
        function renderColumnGrid() {
            columnsGrid.innerHTML = '';
            
            const searchTerm = columnSearch.value.toLowerCase();
            
            allColumns.forEach(column => {
                // ตรวจสอบว่าคอลัมน์นี้ผ่านการกรองหรือไม่
                const columnNameLower = column.toLowerCase();
                const isSelected = selectedColumns.includes(column);
                const matchesSearch = searchTerm === '' || columnNameLower.includes(searchTerm);
                
                // ตรวจสอบประเภทคอลัมน์
                let columnType = '';
                let columnClass = '';
                
                if (columnNameLower.includes('ประเภทอ้อย') || columnNameLower.includes('sugarcane') || 
                    columnNameLower.includes('พันธุ์') || columnNameLower.includes('type')) {
                    columnType = 'ข้อมูลอ้อย';
                    columnClass = 'sugarcane';
                } else if (columnNameLower.includes('อายุ') || columnNameLower.includes('age') ||
                          columnNameLower.includes('งวด') || columnNameLower.includes('period') ||
                          columnNameLower.includes('กิจกรรม') || columnNameLower.includes('activity')) {
                    columnType = 'กิจกรรมงวด';
                    columnClass = 'activity';
                } else if (columnNameLower.includes('โครงการ') || columnNameLower.includes('project')) {
                    columnType = 'โครงการ';
                    columnClass = 'project';
                } else if (columnNameLower.includes('ปุ๋ย') || columnNameLower.includes('fertilizer') ||
                          columnNameLower.includes('ยา') || columnNameLower.includes('chemical')) {
                    columnType = 'ปุ๋ย';
                    columnClass = 'fertilizer';
                } else if (columnNameLower.includes('วันที่') || columnNameLower.includes('date')) {
                    columnType = 'วันที่';
                } else if (columnNameLower.includes('รหัส') || columnNameLower.includes('code') || 
                          columnNameLower.includes('id') || columnNameLower.includes('หมายเลข')) {
                    columnType = 'รหัส';
                } else if (columnNameLower.includes('จำนวน') || columnNameLower.includes('quantity') ||
                          columnNameLower.includes('ปริมาณ') || columnNameLower.includes('amount') ||
                          columnNameLower.includes('พื้นที่') || columnNameLower.includes('area')) {
                    columnType = 'จำนวน';
                } else if (columnNameLower === 'lat' || columnNameLower === 'latitude') {
                    columnType = 'พิกัด lat';
                    columnClass = 'sugarcane';
                } else if (columnNameLower === 'long' || columnNameLower === 'longitude') {
                    columnType = 'พิกัด long';
                    columnClass = 'sugarcane';
                } else {
                    columnType = 'ข้อมูลทั่วไป';
                }
                
                // ตรวจสอบว่าควรแสดงคอลัมน์นี้ตาม filter ปัจจุบันหรือไม่
                let shouldShow = matchesSearch;
                
                if (currentColumnFilter === 'selected') {
                    shouldShow = shouldShow && isSelected;
                } else if (currentColumnFilter === 'unselected') {
                    shouldShow = shouldShow && !isSelected;
                } else if (currentColumnFilter !== 'all') {
                    shouldShow = shouldShow && columnClass === currentColumnFilter;
                }
                
                // ตรวจสอบว่าคอลัมน์นี้มีข้อมูลหรือไม่ (ตัวอย่าง 5 แถวแรก)
                const sampleValues = filteredData.slice(0, 5).map(row => row[column]);
                const emptyCount = sampleValues.filter(v => v === '').length;
                const fillRate = ((sampleValues.length - emptyCount) / sampleValues.length * 100).toFixed(0);
                
                const columnItem = document.createElement('div');
                columnItem.className = `column-item ${columnClass} ${isSelected ? 'selected' : ''}`;
                columnItem.style.display = shouldShow ? 'flex' : 'none';
                
                columnItem.innerHTML = `
                    <input type="checkbox" class="column-checkbox" ${isSelected ? 'checked' : ''} data-column="${column}">
                    <div class="column-info">
                        <div class="column-name" title="${column}">${column}</div>
                        <span class="column-type">${columnType}</span>
                        <div class="column-stats">
                            <i class="fas fa-database"></i> มีข้อมูล ${fillRate}%
                        </div>
                    </div>
                `;
                
                columnsGrid.appendChild(columnItem);
                
                // เพิ่ม event listener สำหรับ checkbox
                const checkbox = columnItem.querySelector('.column-checkbox');
                checkbox.addEventListener('change', function() {
                    const columnName = this.dataset.column;
                    
                    if (this.checked) {
                        if (!selectedColumns.includes(columnName)) {
                            selectedColumns.push(columnName);
                        }
                    } else {
                        const index = selectedColumns.indexOf(columnName);
                        if (index > -1) {
                            selectedColumns.splice(index, 1);
                        }
                    }
                    
                    // อัพเดต UI
                    columnItem.classList.toggle('selected', this.checked);
                    updateColumnStats();
                    
                    // เปิด/ปิดใช้งานปุ่มต่อไป
                    nextToStep4.disabled = selectedColumns.length === 0;
                });
            });
            
            // อัพเดตจำนวนคอลัมน์ที่แสดง
            updateFilteredCount();
        }
        
        function updateColumnStats() {
            selectedCount.textContent = selectedColumns.length;
            selectedSummaryCount.textContent = selectedColumns.length;
            
            if (selectedColumns.length === 0) {
                selectedColumnsList.textContent = 'ยังไม่ได้เลือกคอลัมน์';
            } else {
                const displayedColumns = selectedColumns.slice(0, 3);
                const moreCount = selectedColumns.length - 3;
                selectedColumnsList.textContent = displayedColumns.join(', ') + 
                    (moreCount > 0 ? ` และอีก ${moreCount} คอลัมน์...` : '');
            }
        }
        
        function updateFilteredCount() {
            const visibleColumns = Array.from(columnsGrid.querySelectorAll('.column-item'))
                .filter(item => item.style.display !== 'none');
            filteredCount.textContent = visibleColumns.length;
        }
        
        // Search functionality
        columnSearch.addEventListener('input', function() {
            renderColumnGrid();
        });
        
        // Column filter buttons
        columnFilterButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                // อัพเดตปุ่มที่ active
                columnFilterButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // ตั้งค่าตัวกรอง
                currentColumnFilter = this.dataset.filter;
                
                // กรองคอลัมน์
                renderColumnGrid();
            });
        });
        
        // Select all / Deselect all
        selectAllBtn.addEventListener('click', function() {
            const visibleColumns = Array.from(columnsGrid.querySelectorAll('.column-item'))
                .filter(item => item.style.display !== 'none');
            
            visibleColumns.forEach(item => {
                const checkbox = item.querySelector('.column-checkbox');
                const columnName = checkbox.dataset.column;
                
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    if (!selectedColumns.includes(columnName)) {
                        selectedColumns.push(columnName);
                    }
                    item.classList.add('selected');
                }
            });
            
            updateColumnStats();
            nextToStep4.disabled = selectedColumns.length === 0;
        });
        
        deselectAllBtn.addEventListener('click', function() {
            const visibleColumns = Array.from(columnsGrid.querySelectorAll('.column-item'))
                .filter(item => item.style.display !== 'none');
            
            visibleColumns.forEach(item => {
                const checkbox = item.querySelector('.column-checkbox');
                const columnName = checkbox.dataset.column;
                
                if (checkbox.checked) {
                    checkbox.checked = false;
                    const index = selectedColumns.indexOf(columnName);
                    if (index > -1) {
                        selectedColumns.splice(index, 1);
                    }
                    item.classList.remove('selected');
                }
            });
            
            updateColumnStats();
            nextToStep4.disabled = selectedColumns.length === 0;
        });
        
        // ============================================
        // ขั้นตอนที่ 4: ตรวจสอบประเภทข้อมูล
        // ============================================
        
        nextToStep4.addEventListener('click', function() {
            if (selectedColumns.length === 0) {
                alert('กรุณาเลือกคอลัมน์ที่ต้องการตรวจสอบ');
                return;
            }
            
            // ไปยังขั้นตอนที่ 4
            goToStep(4);
        });
        
        function initDataValidationSystem() {
            // แสดง Dashboard
            dashboardSummary.style.display = 'block';
            
            // รันการตรวจสอบข้อมูลจากข้อมูลที่กรองแล้ว
            if (filteredData && selectedColumns.length > 0) {
                runDataValidationFromFilteredData();
            }
        }
        
        function runDataValidationFromFilteredData() {
            if (!filteredData || selectedColumns.length === 0) return;
            
            // ✅ ตัดแถวที่ว่างทั้งหมดออกก่อนตรวจสอบ
            const removedCount = removeEmptyRowsFromFilteredData();
            if (removedCount > 0) {
                console.log(`✅ ตัดแถวที่ว่างทั้งหมดออกแล้ว: ${removedCount} แถว`);
            }
            
            currentValidationResults = {
                totalCells: 0,
                validCells: 0,
                warningCells: 0,
                errorCells: 0,
                details: {}
            };
            
            cellValidationStatus = {};
            
            // ใช้แถวแรกตามจำนวนที่กำหนด (เริ่มต้น 50 แถว)
            const sampleRows = filteredData.slice(0, currentRowLimit);
            totalCells = sampleRows.length * selectedColumns.length;
            
            // ตรวจสอบแต่ละเซลล์ในข้อมูลที่กรองแล้ว
            sampleRows.forEach((row, rowIndex) => {
                selectedColumns.forEach((columnName, colIndex) => {
                    const cellValue = row[columnName] || '';
                    
                    // ✅ ถ้าค่าเป็นช่องว่าง ให้ผ่านได้เลย
                    if (cellValue.trim() === '') {
                        if (!cellValidationStatus[rowIndex]) {
                            cellValidationStatus[rowIndex] = {};
                        }
                        cellValidationStatus[rowIndex][colIndex] = {
                            status: 'valid',
                            message: 'ค่าว่าง - ผ่าน',
                            suggestions: [],
                            dataType: 'text',
                            edited: false
                        };
                        
                        currentValidationResults.totalCells++;
                        currentValidationResults.validCells++;
                        return;
                    }
                    
                    // ใช้ประเภทข้อมูลที่ผู้ใช้เลือก หรือตรวจจับอัตโนมัติ
                    const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, cellValue);
                    const validation = validateCellData(columnName, cellValue, columnType, rowIndex, colIndex);
                    
                    // บันทึกผลการตรวจสอบ
                    if (!cellValidationStatus[rowIndex]) {
                        cellValidationStatus[rowIndex] = {};
                    }
                    
                    cellValidationStatus[rowIndex][colIndex] = validation;
                    
                    // นับสถิติ
                    currentValidationResults.totalCells++;
                    
                    if (validation.status === 'valid') {
                        currentValidationResults.validCells++;
                    } else if (validation.status === 'warning') {
                        currentValidationResults.warningCells++;
                    } else if (validation.status === 'error') {
                        currentValidationResults.errorCells++;
                    }
                    
                    // บันทึกรายละเอียด
                    if (!currentValidationResults.details[columnName]) {
                        currentValidationResults.details[columnName] = {
                            errors: [],
                            warnings: []
                        };
                    }
                    
                    if (validation.status === 'error') {
                        currentValidationResults.details[columnName].errors.push({
                            row: rowIndex + 1,
                            value: cellValue,
                            message: validation.message
                        });
                    } else if (validation.status === 'warning') {
                        currentValidationResults.details[columnName].warnings.push({
                            row: rowIndex + 1,
                            value: cellValue,
                            message: validation.message
                        });
                    }
                });
            });
            
            // แสดงข้อมูลในตาราง
            renderDataTableFromFilteredData();
            
            // อัพเดต Dashboard
            updateDashboard();
        }
        
        function detectColumnType(columnName, sampleValue) {
            const columnNameLower = columnName.toLowerCase();
            
            // ✅ คอลัมน์ "ชื่อประเภทอ้อย" ให้เป็นประเภท "text" (ข้อความ)
            if (columnNameLower === 'ชื่อประเภทอ้อย' || 
                columnNameLower.includes('ชื่อประเภทอ้อย')) {
                return 'text';
            }
            
            // ✅ คอลัมน์ "ประเภทอ้อย" ให้เป็นประเภท "number" (ตัวเลข)
            if (columnNameLower === 'ประเภทอ้อย' || 
                columnNameLower.includes('ประเภทอ้อย')) {
                return 'number';
            }
            
            // ✅ คอลัมน์ "ประวัติการใช้พื้นที่" เป็นข้อความโดยอัตโนมัติ
            if (columnNameLower.includes('ประวัติการใช้พื้นที่') || 
                columnNameLower.includes('ประวัติ') || 
                columnNameLower.includes('การใช้พื้นที่')) {
                return 'text';
            }
            
            // ✅ คอลัมน์ "ความเสี่ยงพื้นที่" เป็นข้อความ
            if (columnNameLower.includes('ความเสี่ยงพื้นที่') || columnNameLower.includes('ความเสี่ยง')) {
                return 'text';
            }
            
            // ✅ คอลัมน์ "ความลาดเอียงของพื้นที่" เป็นข้อความ
            if (columnNameLower.includes('ความลาดเอียง') || columnNameLower.includes('ลาดเอียง') || columnNameLower.includes('slope')) {
                return 'text';
            }
            
            // ตรวจสอบจากชื่อคอลัมน์ (ให้ความสำคัญสูงสุด)
            if (columnNameLower.includes('วันที่') || columnNameLower.includes('date') || 
                columnNameLower.includes('วัน') || columnNameLower.includes('month') || 
                columnNameLower.includes('year')) {
                return 'date';
            }
            
            if (columnNameLower.includes('จำนวน') || columnNameLower.includes('quantity') ||
                columnNameLower.includes('ปริมาณ') || columnNameLower.includes('amount') ||
                columnNameLower.includes('น้ำหนัก') || columnNameLower.includes('weight') ||
                columnNameLower.includes('พื้นที่') || columnNameLower.includes('area') ||
                columnNameLower.includes('ราคา') || columnNameLower.includes('price') ||
                columnNameLower === 'lat' || columnNameLower === 'latitude' ||
                columnNameLower === 'long' || columnNameLower === 'longitude') {
                return 'number';
            }
            
            if (columnNameLower.includes('รหัส') || columnNameLower.includes('code') || 
                columnNameLower.includes('id') || columnNameLower.includes('หมายเลข') ||
                columnNameLower.includes('เลขที่') || columnNameLower.includes('no.')) {
                return 'identifier';
            }
            
            if (columnNameLower.includes('ประเภท') || columnNameLower.includes('type') ||
                columnNameLower.includes('สถานะ') || columnNameLower.includes('status') ||
                columnNameLower.includes('ใช่/ไม่') || columnNameLower.includes('yes/no') ||
                columnNameLower.includes('ระดับ') || columnNameLower.includes('level') ||
                columnNameLower.includes('การจัด') || columnNameLower.includes('category')) {
                return 'enum';
            }
            
            // ตรวจสอบจากค่าตัวอย่าง
            if (sampleValue === '' || sampleValue === null || sampleValue === undefined) {
                return 'text';
            }
            
            // ตรวจสอบตัวเลข
            const numValue = parseFloat(sampleValue);
            if (!isNaN(numValue) && sampleValue.trim() !== '' && 
                !isNaN(parseFloat(sampleValue)) && isFinite(sampleValue)) {
                return 'number';
            }
            
            // ตรวจสอบวันที่
            const datePatterns = [
                /^\d{4}-\d{1,2}-\d{1,2}$/,
                /^\d{4}\/\d{1,2}\/\d{1,2}$/,
                /^\d{1,2}\/\d{1,2}\/\d{4}$/,
                /^\d{1,2}-\d{1,2}-\d{4}$/
            ];
            
            if (datePatterns.some(pattern => pattern.test(sampleValue.trim()))) {
                return 'date';
            }
            
            // ตรวจสอบว่ามีค่าที่กำหนดหรือไม่
            const sampleLower = sampleValue.toLowerCase().trim();
            if (sampleLower === 'ใช่' || sampleLower === 'ไม่' || 
                sampleLower === 'yes' || sampleLower === 'no' ||
                sampleLower === 'true' || sampleLower === 'false') {
                return 'enum';
            }
            
            // ค่าเริ่มต้นเป็นข้อความ
            return 'text';
        }
        
        function validateCellData(columnName, value, columnType, rowIndex, colIndex) {
            // ใช้ประเภทที่ผู้ใช้เลือกถ้ามี
            const effectiveType = userSelectedDataTypes[columnName] || columnType;
            
            const result = {
                status: 'valid',
                message: '',
                suggestions: [],
                dataType: effectiveType,
                edited: false
            };
            
            // ตรวจสอบค่าว่าง (ผ่านแล้วในขั้นต้น)
            if (value === '' || value === null || value === undefined) {
                return result;
            }
            
            // ✅ คอลัมน์ "เลขแปลงintech" เป็นค่าเริ่มต้น ไม่ต้องตรวจสอบ
            if (columnName.toLowerCase().includes('แปลงintech')) {
                return result;
            }
            
            // ✅ การตรวจสอบและแนะนำสำหรับคอลัมน์ "ชื่อประเภทอ้อย"
            if (columnName.toLowerCase() === 'ชื่อประเภทอ้อย') {
                // ค่าที่แนะนำสำหรับคอลัมน์ "ชื่อประเภทอ้อย"
                const validTypes = [
                    "ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ตอ1", "ตอ2", "ตอ3", 
                    "ต้นฝนขยาย", "ต้นฝนรื้อตอ", "พื้นที่เสียหาย", ">ตอ3"
                ];
                
                if (!validTypes.includes(value.trim())) {
                    result.status = 'error';
                    result.message = `ต้องเป็นหนึ่งใน: ${validTypes.join(', ')}`;
                    result.suggestions = validTypes;
                }
                return result;
            }
            
            // ✅ การตรวจสอบและแนะนำสำหรับคอลัมน์ "ประเภทอ้อย"
            if (columnName.toLowerCase() === 'ประเภทอ้อย') {
                // ค่าที่แนะนำสำหรับคอลัมน์ "ประเภทอ้อย"
                const validNumbers = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];
                
                // ตรวจสอบว่าเป็นตัวเลขหรือไม่
                const numValue = parseFloat(value);
                if (isNaN(numValue)) {
                    result.status = 'error';
                    result.message = 'ต้องเป็นตัวเลข';
                    result.suggestions = validNumbers;
                } 
                // ตรวจสอบว่าตรงกับตัวเลขที่กำหนดหรือไม่
                else if (!validNumbers.includes(value.trim())) {
                    result.status = 'error';
                    result.message = `ต้องเป็นหนึ่งใน: ${validNumbers.join(', ')}`;
                    result.suggestions = validNumbers;
                }
                return result;
            }
            
            // ตรวจสอบตามประเภทข้อมูล
            switch(effectiveType) {
                case 'number':
                    if (isNaN(value) || value.trim() === '') {
                        result.status = 'error';
                        result.message = 'ต้องเป็นตัวเลข';
                        
                        if (columnName.toLowerCase() === 'lat') {
                            result.suggestions = ['13.7563', '14.0790', '15.8700', '16.4393'];
                        } else if (columnName.toLowerCase() === 'long') {
                            result.suggestions = ['100.5018', '101.0037', '102.4956', '103.8499'];
                        } else if (columnName.includes('พื้นที่')) {
                            result.suggestions = ['10.0', '15.5', '20.0', '25.5'];
                        } else if (columnName.includes('อายุ')) {
                            result.suggestions = ['120', '150', '180', '210'];
                        } else if (columnName.includes('โควต้า')) {
                            result.suggestions = ['100', '150', '200', '250'];
                        } else {
                            result.suggestions = ['0', '10', '50', '100'];
                        }
                    } else {
                        const numValue = parseFloat(value);
                        
                        // ตรวจสอบพิกัด latitude (lat)
                        if (columnName.toLowerCase() === 'lat') {
                            if (numValue < -90 || numValue > 90) {
                                result.status = 'error';
                                result.message = 'latitude ต้องอยู่ระหว่าง -90 ถึง 90';
                                result.suggestions = ['13.7563', '14.0790', '15.8700', '16.4393'];
                            } else if (Math.abs(numValue) < 1 || Math.abs(numValue) > 99) {
                                result.status = 'warning';
                                result.message = 'latitude มักเป็นเลขหลักสิบ (13-17 สำหรับประเทศไทย)';
                                result.suggestions = ['13.7563', '14.0790', '15.8700', '16.4393'];
                            }
                        }
                        
                        // ตรวจสอบพิกัด longitude (long)
                        if (columnName.toLowerCase() === 'long') {
                            if (numValue < -180 || numValue > 180) {
                                result.status = 'error';
                                result.message = 'longitude ต้องอยู่ระหว่าง -180 ถึง 180';
                                result.suggestions = ['100.5018', '101.0037', '102.4956', '103.8499'];
                            } else if (Math.abs(numValue) < 90 || Math.abs(numValue) > 110) {
                                result.status = 'warning';
                                result.message = 'longitude มักเป็นเลขหลักร้อย (100-104 สำหรับประเทศไทย)';
                                result.suggestions = ['100.5018', '101.0037', '102.4956', '103.8499'];
                            }
                        }
                        
                        // ตรวจสอบค่าติดลบสำหรับบางคอลัมน์
                        if ((columnName.includes('พื้นที่') || columnName.includes('อายุ') || 
                             columnName.includes('จำนวน') || columnName.includes('โควต้า')) && numValue < 0) {
                            result.status = 'error';
                            result.message = 'ค่าต้องมากกว่าหรือเท่ากับ 0';
                            result.suggestions = ['0', '1', '10'];
                        }
                    }
                    break;
                    
                case 'date':
                    // ตรวจสอบรูปแบบวันที่ (รองรับ YYYY/MM/DD และ YYYY/M/D)
                    const datePatterns = [
                        /^\d{4}-\d{1,2}-\d{1,2}$/,          // YYYY-MM-DD
                        /^\d{4}\/\d{1,2}\/\d{1,2}$/,       // YYYY/MM/DD หรือ YYYY/M/D
                        /^\d{1,2}\/\d{1,2}\/\d{4}$/,       // DD/MM/YYYY หรือ D/M/YYYY
                        /^\d{1,2}-\d{1,2}-\d{4}$/          // DD-MM-YYYY หรือ D-M-YYYY
                    ];
                    
                    const isValidDate = datePatterns.some(pattern => pattern.test(value.trim()));
                    if (!isValidDate) {
                        result.status = 'error';
                        result.message = 'รูปแบบวันที่ไม่ถูกต้อง (รองรับ: YYYY/MM/DD, YYYY/M/D, DD/MM/YYYY)';
                        result.suggestions = ['2023/01/01', '2023/6/15', '2023/12/31'];
                    }
                    break;
                    
                case 'enum':
                    if (columnName.toLowerCase().includes('ใช่/ไม่') || columnName.toLowerCase().includes('yes/no')) {
                        const validValues = ['ใช่', 'ไม่', 'yes', 'no', 'true', 'false'];
                        if (!validValues.includes(value.toLowerCase())) {
                            result.status = 'error';
                            result.message = 'ต้องเป็น "ใช่" หรือ "ไม่"';
                            result.suggestions = ['ใช่', 'ไม่'];
                        }
                    }
                    break;
                    
                case 'identifier':
                    if (value.length > 50) {
                        result.status = 'warning';
                        result.message = 'รหัสยาวเกินไป';
                    }
                    break;
                    
                case 'text':
                    // ✅ คอลัมน์ "ความเสี่ยงพื้นที่" และ "ความลาดเอียงของพื้นที่" เป็นข้อความ ไม่ต้องตรวจสอบเพิ่มเติม
                    if (columnName.toLowerCase().includes('ความเสี่ยงพื้นที่') || 
                        columnName.toLowerCase().includes('ความลาดเอียง')) {
                        // ไม่ต้องตรวจสอบเพิ่มเติม
                    } else if (columnName.toLowerCase().includes('แปลงintech')) {
                        // ตรวจสอบรูปแบบเลขแปลงintech
                        if (!/^\d+$/.test(value) && value.trim() !== '') {
                            result.status = 'warning';
                            result.message = 'เลขแปลงintech ควรเป็นตัวเลข';
                        }
                    } else if (value.length < 1 && value.trim() !== '') {
                        result.status = 'warning';
                        result.message = 'ข้อความสั้นเกินไป';
                    }
                    break;
            }
            
            return result;
        }
        
        function renderDataTableFromFilteredData() {
            // ล้างตารางเดิม
            dataTableHeader.innerHTML = '';
            dataTableBody.innerHTML = '';
            
            if (!filteredData || selectedColumns.length === 0) return;
            
            // สร้างหัวตาราง
            const headerRow = document.createElement('tr');
            
            // เพิ่มคอลัมน์หมายเลขแถว
            const rowNumHeader = document.createElement('th');
            rowNumHeader.textContent = '#';
            rowNumHeader.style.width = '50px';
            headerRow.appendChild(rowNumHeader);
            
            // เพิ่มหัวคอลัมน์ข้อมูลที่เลือก
            selectedColumns.forEach(columnName => {
                const th = document.createElement('th');
                
                // ตรวจสอบประเภทคอลัมน์ (ใช้ประเภทที่ผู้ใช้เลือก)
                const effectiveType = userSelectedDataTypes[columnName] || 
                                     detectColumnType(columnName, filteredData[0] ? filteredData[0][columnName] || '' : '');
                
                // เพิ่ม badge ประเภทข้อมูล
                const typeBadge = document.createElement('span');
                typeBadge.className = 'column-type-badge';
                typeBadge.textContent = getTypeDisplayName(effectiveType);
                typeBadge.style.marginLeft = '5px';
                typeBadge.style.padding = '2px 6px';
                typeBadge.style.borderRadius = '10px';
                typeBadge.style.backgroundColor = getTypeColor(effectiveType);
                typeBadge.style.color = 'white';
                
                th.innerHTML = `${columnName} `;
                th.appendChild(typeBadge);
                headerRow.appendChild(th);
            });
            
            dataTableHeader.appendChild(headerRow);
            
            // ✅ เพิ่มฟิลเตอร์ในหัวตารางเป็น Dropdown
            setTimeout(() => {
                addColumnFilterDropdowns();
            }, 100);
            
            // สร้างแถวข้อมูล (แสดงตามจำนวนที่กำหนด)
            const displayRows = filteredData.slice(0, currentRowLimit);
            
            // อัพเดตจำนวนแถวที่แสดง
            totalRows.textContent = filteredData.length;
            currentRows.textContent = Math.min(currentRowLimit, filteredData.length);
            totalRowCount.textContent = filteredData.length;
            
            displayRows.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                
                // เพิ่มหมายเลขแถว
                const rowNumCell = document.createElement('td');
                rowNumCell.textContent = rowIndex + 1;
                rowNumCell.style.fontWeight = 'bold';
                tr.appendChild(rowNumCell);
                
                // เพิ่มข้อมูลแต่ละเซลล์
                selectedColumns.forEach((columnName, colIndex) => {
                    const td = document.createElement('td');
                    const cellValue = row[columnName] || '';
                    td.textContent = cellValue;
                    
                    // ตรวจสอบประเภทที่ควรใช้
                    const effectiveType = userSelectedDataTypes[columnName] || 
                                         detectColumnType(columnName, cellValue);
                    
                    // ตรวจสอบข้อมูล
                    const validation = validateCellData(columnName, cellValue, effectiveType, rowIndex, colIndex);
                    
                    // เพิ่มคลาสตามสถานะการตรวจสอบ
                    if (validation.status === 'error') {
                        td.className = 'cell-error cell-highlight';
                        td.title = validation.message;
                    } else if (validation.status === 'warning') {
                        td.className = 'cell-warning cell-highlight';
                        td.title = validation.message;
                    } else {
                        td.className = 'cell-valid';
                    }
                    
                    // เพิ่มข้อมูลสำหรับการแก้ไข
                    td.dataset.row = rowIndex;
                    td.dataset.col = colIndex;
                    td.dataset.column = columnName;
                    td.dataset.value = cellValue;
                    td.dataset.type = effectiveType;
                    
                    // Event listener สำหรับการแก้ไข
                    if (validation.status === 'error' || validation.status === 'warning') {
                        td.style.cursor = 'pointer';
                        td.addEventListener('click', () => openCellEditorForFilteredData(rowIndex, colIndex));
                    }
                    
                    tr.appendChild(td);
                });
                
                dataTableBody.appendChild(tr);
            });
            
            // อัพเดตข้อมูลตาราง
            currentColumns.textContent = selectedColumns.length;
            updateDataStatus();
        }
        
        function getTypeDisplayName(type) {
            const names = {
                'text': 'ข้อความ',
                'number': 'ตัวเลข',
                'date': 'วันที่',
                'enum': 'ค่าที่กำหนด',
                'identifier': 'รหัส'
            };
            return names[type] || type;
        }
        
        function getTypeColor(type) {
            const colors = {
                'text': '#1565c0',
                'number': '#2e7d32',
                'date': '#ef6c00',
                'enum': '#7b1fa2',
                'identifier': '#00695c'
            };
            return colors[type] || '#6c757d';
        }
        
        function updateDashboard() {
            const total = currentValidationResults.totalCells;
            const valid = currentValidationResults.validCells;
            const warning = currentValidationResults.warningCells;
            const error = currentValidationResults.errorCells;
            
            // คำนวณเปอร์เซ็นต์
            const validPercent = total > 0 ? Math.round((valid / total) * 100) : 0;
            const warningPercent = total > 0 ? Math.round((warning / total) * 100) : 0;
            const errorPercent = total > 0 ? Math.round((error / total) * 100) : 0;
            
            // อัพเดต Dashboard
            correctDataPercent.textContent = `${validPercent}%`;
            needReviewCount.textContent = warning;
            errorDataCount.textContent = error;
            
            // ✅ แสดงปุ่ม "ต้องตรวจสอบ" ถ้ามีข้อมูลที่ต้องตรวจสอบ
            if (warning > 0) {
                showReviewBtn.style.display = 'inline-block';
                showReviewBtn.addEventListener('click', showReviewRows);
            } else {
                showReviewBtn.style.display = 'none';
            }
            
            // อัพเดต Progress bars
            correctDataBar.style.width = `${validPercent}%`;
            needReviewBar.style.width = `${warningPercent}%`;
            errorDataBar.style.width = `${errorPercent}%`;
            
            // อัพเดตจำนวนเซลล์ที่แก้ไขแล้ว
            const editedCount = countEditedCells();
            editedCellsCount.textContent = editedCount;
            const editedPercent = total > 0 ? Math.round((editedCount / total) * 100) : 0;
            editedCellsBar.style.width = `${Math.min(editedPercent, 100)}%`;
            
            // ✅ ต้องมีข้อมูลถูกต้อง 100% จึงจะไปขั้นตอนต่อไปได้
            nextToStep5.disabled = validPercent !== 100 || error > 0;
        }
        
        function countEditedCells() {
            let count = 0;
            for (let rowIndex in cellValidationStatus) {
                for (let colIndex in cellValidationStatus[rowIndex]) {
                    if (cellValidationStatus[rowIndex][colIndex].edited) {
                        count++;
                    }
                }
            }
            return count;
        }
        
        function updateDataStatus() {
            const errorCount = currentValidationResults.errorCells;
            const warningCount = currentValidationResults.warningCells;
            
            if (errorCount > 0) {
                dataStatus.innerHTML = `<span style="cursor: pointer; text-decoration: underline;" id="showErrorsBtn">⚠️ มี ${errorCount} ข้อผิดพลาดที่ต้องแก้ไข</span>`;
                dataStatus.style.color = 'var(--danger-color)';
                dataStatus.style.backgroundColor = 'rgba(247, 37, 133, 0.1)';
                
                setTimeout(() => {
                    const showErrorsBtn = document.getElementById('showErrorsBtn');
                    if (showErrorsBtn) {
                        showErrorsBtn.addEventListener('click', function() {
                            showErrorRowsOnly();
                        });
                    }
                }, 100);
            } else if (warningCount > 0) {
                dataStatus.textContent = `⚠️ มี ${warningCount} รายการที่ต้องตรวจสอบ`;
                dataStatus.style.color = 'var(--warning-color)';
                dataStatus.style.backgroundColor = 'rgba(255, 152, 0, 0.1)';
            } else {
                dataStatus.textContent = '✓ ข้อมูลถูกต้องทั้งหมด (100%)';
                dataStatus.style.color = 'var(--success-color)';
                dataStatus.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
            }
        }
        
        // ฟังก์ชันใหม่: เพิ่มฟิลเตอร์ Dropdown ในหัวตาราง
        function addColumnFilterDropdowns() {
            const headerRow = document.getElementById('dataTableHeader').querySelector('tr');
            if (!headerRow) return;
            
            // ตรวจสอบว่ามีฟิลเตอร์อยู่แล้วหรือไม่
            if (headerRow.querySelector('.filter-dropdown')) {
                return;
            }
            
            // สร้างแถวที่สองสำหรับฟิลเตอร์
            const filterRow = document.createElement('tr');
            
            // เซลล์หมายเลขแถว
            const rowNumFilterCell = document.createElement('td');
            rowNumFilterCell.style.padding = '5px';
            rowNumFilterCell.innerHTML = '<button class="btn btn-sm btn-outline" id="clearFilters" style="font-size: 0.7rem; padding: 3px 8px;">ล้าง</button>';
            filterRow.appendChild(rowNumFilterCell);
            
            // สร้างฟิลเตอร์สำหรับแต่ละคอลัมน์
            selectedColumns.forEach((columnName, index) => {
                const filterCell = document.createElement('td');
                filterCell.style.padding = '5px';
                
                // ดึงค่าที่ไม่ซ้ำกันสำหรับคอลัมน์นี้ (ตัวอย่าง 100 แถวแรก)
                const uniqueValues = [];
                const sampleRows = filteredData.slice(0, Math.min(100, filteredData.length));
                const valueSet = new Set();
                
                sampleRows.forEach(row => {
                    const value = row[columnName] || '';
                    if (value.trim() !== '' && !valueSet.has(value)) {
                        valueSet.add(value);
                        uniqueValues.push(value);
                    }
                });
                
                // สร้าง dropdown
                const filterSelect = document.createElement('select');
                filterSelect.className = 'filter-dropdown';
                filterSelect.dataset.columnIndex = index;
                filterSelect.dataset.columnName = columnName;
                
                // เพิ่มตัวเลือก
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'ทั้งหมด';
                filterSelect.appendChild(defaultOption);
                
                // เพิ่มตัวเลือกจากค่าที่ไม่ซ้ำกัน (จำกัดที่ 50 รายการ)
                uniqueValues.slice(0, 50).forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value.length > 30 ? value.substring(0, 27) + '...' : value;
                    filterSelect.appendChild(option);
                });
                
                filterSelect.addEventListener('change', function() {
                    filterTableRowsByDropdown();
                });
                
                filterCell.appendChild(filterSelect);
                filterRow.appendChild(filterCell);
            });
            
            headerRow.parentNode.insertBefore(filterRow, headerRow.nextSibling);
            
            // เพิ่ม event listener สำหรับปุ่มล้าง
            document.getElementById('clearFilters').addEventListener('click', function() {
                clearAllFilters();
            });
        }
        
        function filterTableRowsByDropdown() {
            const filterSelects = document.querySelectorAll('.filter-dropdown');
            const rows = document.querySelectorAll('#dataTableBody tr');
            
            rows.forEach(row => {
                let shouldShow = true;
                
                filterSelects.forEach((filterSelect, index) => {
                    const filterValue = filterSelect.value;
                    if (filterValue === '') return;
                    
                    // ดึงค่าจากเซลล์ (ข้ามเซลล์แรกที่เป็นหมายเลขแถว)
                    const cell = row.children[index + 1]; // +1 เพราะข้ามเซลล์หมายเลขแถว
                    if (cell) {
                        const cellValue = cell.textContent;
                        if (cellValue !== filterValue) {
                            shouldShow = false;
                        }
                    }
                });
                
                row.style.display = shouldShow ? '' : 'none';
            });
        }
        
        function clearAllFilters() {
            const filterSelects = document.querySelectorAll('.filter-dropdown');
            filterSelects.forEach(select => {
                select.value = '';
            });
            
            const rows = document.querySelectorAll('#dataTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // ฟังก์ชันใหม่: แสดงเฉพาะแถวที่มีข้อผิดพลาด
        function showErrorRowsOnly() {
            const rows = document.querySelectorAll('#dataTableBody tr');
            let errorRowCount = 0;
            
            rows.forEach(row => {
                let hasError = false;
                const cells = row.querySelectorAll('td');
                
                cells.forEach(cell => {
                    if (cell.classList.contains('cell-error')) {
                        hasError = true;
                    }
                });
                
                if (hasError) {
                    row.style.display = '';
                    errorRowCount++;
                    row.style.backgroundColor = 'rgba(255, 235, 238, 0.5)';
                } else {
                    row.style.display = 'none';
                }
            });
            
            if (errorRowCount > 0) {
                const tableControls = document.querySelector('.data-table-controls');
                if (!document.getElementById('showAllRowsBtn')) {
                    const showAllBtn = document.createElement('button');
                    showAllBtn.id = 'showAllRowsBtn';
                    showAllBtn.className = 'btn btn-outline btn-sm';
                    showAllBtn.innerHTML = '<i class="fas fa-list"></i> แสดงทั้งหมด';
                    showAllBtn.style.marginLeft = '10px';
                    showAllBtn.addEventListener('click', function() {
                        showAllRowsInTable();
                    });
                    
                    const tableActions = document.querySelector('.table-actions');
                    if (tableActions) {
                        tableActions.appendChild(showAllBtn);
                    }
                }
                
                alert(`แสดงเฉพาะแถวที่มีข้อผิดพลาด: ${errorRowCount} แถว`);
            }
        }
        
        // ฟังก์ชันใหม่: แสดงเฉพาะแถวที่ต้องตรวจสอบ (warning)
        function showReviewRows() {
            const rows = document.querySelectorAll('#dataTableBody tr');
            let reviewRowCount = 0;
            
            rows.forEach(row => {
                let hasWarning = false;
                const cells = row.querySelectorAll('td');
                
                cells.forEach(cell => {
                    if (cell.classList.contains('cell-warning')) {
                        hasWarning = true;
                    }
                });
                
                if (hasWarning) {
                    row.style.display = '';
                    reviewRowCount++;
                    row.style.backgroundColor = 'rgba(255, 248, 225, 0.5)';
                } else {
                    row.style.display = 'none';
                }
            });
            
            if (reviewRowCount > 0) {
                const tableControls = document.querySelector('.data-table-controls');
                if (!document.getElementById('showAllRowsBtn')) {
                    const showAllBtn = document.createElement('button');
                    showAllBtn.id = 'showAllRowsBtn';
                    showAllBtn.className = 'btn btn-outline btn-sm';
                    showAllBtn.innerHTML = '<i class="fas fa-list"></i> แสดงทั้งหมด';
                    showAllBtn.style.marginLeft = '10px';
                    showAllBtn.addEventListener('click', function() {
                        showAllRowsInTable();
                    });
                    
                    const tableActions = document.querySelector('.table-actions');
                    if (tableActions) {
                        tableActions.appendChild(showAllBtn);
                    }
                }
                
                alert(`แสดงเฉพาะแถวที่ต้องตรวจสอบ: ${reviewRowCount} แถว`);
            }
        }
        
        function showAllRowsInTable() {
            const rows = document.querySelectorAll('#dataTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
                row.style.backgroundColor = '';
            });
            
            const showAllBtn = document.getElementById('showAllRowsBtn');
            if (showAllBtn) {
                showAllBtn.remove();
            }
        }
        
        // ฟังก์ชันสำหรับตัดแถวที่ว่างเปล่าทั้งหมด
        function removeEmptyRowsFromFilteredData() {
            if (!filteredData || selectedColumns.length === 0) return 0;
            
            const originalRowCount = filteredData.length;
            const filteredDataNew = [];
            
            filteredData.forEach(row => {
                // ตรวจสอบว่ามีข้อมูลอย่างน้อย 1 คอลัมน์ที่ไม่ว่าง
                let hasData = false;
                
                selectedColumns.forEach(columnName => {
                    const value = row[columnName] || '';
                    if (value.toString().trim() !== '') {
                        hasData = true;
                    }
                });
                
                if (hasData) {
                    filteredDataNew.push(row);
                }
            });
            
            filteredData = filteredDataNew;
            
            const removedCount = originalRowCount - filteredDataNew.length;
            if (removedCount > 0) {
                console.log(`✅ ตัดแถวที่ว่างทั้งหมดออกแล้ว: ${removedCount} แถว`);
            }
            
            return removedCount;
        }
        
        // ============================================
        // ตั้งค่า Event Listeners สำหรับฟังก์ชันเพิ่มเติม
        // ============================================
        
        function setupEnhancedEventListeners() {
            // Dashboard buttons
            refreshDashboard.addEventListener('click', () => {
                if (filteredData) {
                    runDataValidationFromFilteredData();
                    updateDashboard();
                    updateDataStatus();
                    alert('✅ อัพเดต Dashboard เรียบร้อยแล้ว');
                }
            });
            
            fixAllErrors.addEventListener('click', () => {
                if (filteredData) {
                    if (confirm('AI จะพยายามแก้ไขข้อผิดพลาดทั้งหมดอัตโนมัติ\nยืนยันดำเนินการ?')) {
                        // ฟังก์ชัน autoFixAllErrorsForFilteredData จะถูกเพิ่มในโค้ดเต็ม
                        alert('กำลังพัฒนา AI Fix...');
                    }
                }
            });
            
            // Cell editor modal
            saveEdit.addEventListener('click', () => {
                if (filteredData && editingCell) {
                    saveCellEditForFilteredData();
                }
            });
            
            cancelEdit.addEventListener('click', closeCellEditor);
            closeModal.addEventListener('click', closeCellEditor);
            
            // ปิด modal เมื่อคลิกนอก
            cellEditorModal.addEventListener('click', (e) => {
                if (e.target === cellEditorModal) {
                    closeCellEditor();
                }
            });
            
            // Data Type Configuration
            showDataTypeConfig.addEventListener('click', showDataTypeConfiguration);
            
            autoDetectTypes.addEventListener('click', autoDetectDataTypes);
            
            applyDataTypes.addEventListener('click', function() {
                dataTypeConfigVisible = false;
                dataTypeConfig.style.display = 'none';
                
                // รันการตรวจสอบใหม่ด้วยประเภทข้อมูลที่ตั้งค่า
                if (filteredData) {
                    runDataValidationFromFilteredData();
                    alert('✅ ใช้การตั้งค่าประเภทข้อมูลเรียบร้อย!');
                }
            });
            
            // Table actions
            showAllRows.addEventListener('click', toggleAllRows);
            
            exportTable.addEventListener('click', exportTableToCSV);
            
            // ปุ่มต่อไปใน Step 4
            nextToStep5.addEventListener('click', () => {
                if (currentValidationResults.errorCells > 0) {
                    alert('ยังมีข้อผิดพลาดที่ต้องแก้ไข กรุณาตรวจสอบเซลล์สีแดง');
                    return;
                }
                
                // ✅ ตรวจสอบว่าข้อมูลถูกต้อง 100% หรือไม่
                const validPercent = parseInt(correctDataPercent.textContent);
                if (validPercent !== 100) {
                    alert(`ข้อมูลถูกต้อง ${validPercent}% ยังไม่ครบ 100% กรุณาตรวจสอบและแก้ไขข้อมูลให้ถูกต้องทั้งหมด`);
                    return;
                }
                
                const editedCount = countEditedCells();
                
                alert(`✅ ตรวจสอบข้อมูลเสร็จสมบูรณ์\n✅ แก้ไขข้อมูลแล้ว: ${editedCount} เซลล์\n✅ ข้อมูลถูกต้อง: 100%\n\nกำลังไปยังขั้นตอนต่อไป...`);
                
                // ไปยังขั้นตอนที่ 5
                goToStep(5);
            });
        }
        
        function showDataTypeConfiguration() {
            dataTypeConfigVisible = true;
            dataTypeConfig.style.display = 'block';
            renderDataTypeConfigurationTable();
        }
        
        function renderDataTypeConfigurationTable() {
            if (!filteredData || selectedColumns.length === 0) return;
            
            const tableBody = document.getElementById('dataTypeTableBody');
            tableBody.innerHTML = '';
            
            selectedColumns.forEach((columnName) => {
                const row = document.createElement('tr');
                
                // หาตัวอย่างข้อมูล
                const sampleValues = filteredData.slice(0, 5).map(row => row[columnName] || '');
                const nonEmptySamples = sampleValues.filter(v => v.trim() !== '');
                const sampleText = nonEmptySamples.length > 0 ? nonEmptySamples[0] : '(ค่าว่าง)';
                
                // ตรวจจับประเภทอัตโนมัติ
                const columnNameLower = columnName.toLowerCase();
                let currentType;
                
                // ✅ กำหนดประเภทเริ่มต้นสำหรับคอลัมน์พิเศษ
                if (columnNameLower === 'ชื่อประเภทอ้อย') {
                    currentType = 'text';
                } else if (columnNameLower === 'ประเภทอ้อย') {
                    currentType = 'number';
                } else {
                    const autoType = detectColumnType(columnName, sampleText);
                    currentType = userSelectedDataTypes[columnName] || autoType;
                }
                
                row.innerHTML = `
                    <td><strong>${columnName}</strong></td>
                    <td class="data-sample-cell" title="${sampleText}">${sampleText}</td>
                    <td>
                        <select class="type-select" data-column="${columnName}">
                            <option value="text" ${currentType === 'text' ? 'selected' : ''}>ข้อความ</option>
                            <option value="number" ${currentType === 'number' ? 'selected' : ''}>ตัวเลข</option>
                            <option value="date" ${currentType === 'date' ? 'selected' : ''}>วันที่</option>
                            <option value="enum" ${currentType === 'enum' ? 'selected' : ''}>ค่าที่กำหนด</option>
                            <option value="identifier" ${currentType === 'identifier' ? 'selected' : ''}>รหัส</option>
                        </select>
                    </td>
                    <td>
                        <select class="format-select" data-column="${columnName}">
                            <option value="default" selected>ค่าเริ่มต้น</option>
                            ${currentType === 'number' ? 
                                '<option value="decimal">ทศนิยม</option><option value="integer">จำนวนเต็ม</option>' : 
                                currentType === 'date' ?
                                '<option value="YYYY-MM-DD">YYYY-MM-DD</option><option value="DD/MM/YYYY">DD/MM/YYYY</option><option value="YYYY/MM/DD">YYYY/MM/DD</option>' :
                                currentType === 'text' && columnNameLower === 'ชื่อประเภทอ้อย' ?
                                sugarcaneTypes.map(type => `<option value="${type}">${type}</option>`).join('') :
                                ''}
                        </select>
                    </td>
                    <td>
                        <select class="unit-select" data-column="${columnName}">
                            <option value="none" selected>ไม่มีหน่วย</option>
                            ${columnName.toLowerCase().includes('พื้นที่') ? 
                                '<option value="ไร่">ไร่</option><option value="งาน">งาน</option><option value="ตารางเมตร">ตร.ม.</option>' :
                                columnName.toLowerCase().includes('อายุ') ?
                                '<option value="วัน">วัน</option><option value="เดือน">เดือน</option><option value="ปี">ปี</option>' :
                                columnName.toLowerCase().includes('ปริมาณ') ?
                                '<option value="กิโลกรัม">กก.</option><option value="ตัน">ตัน</option>' : ''}
                        </select>
                    </td>
                    <td><input type="text" class="form-control" placeholder="คำอธิบาย..." value="${getColumnDescription(columnName)}"></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // เพิ่ม event listeners สำหรับ dropdown
            document.querySelectorAll('.type-select').forEach(select => {
                select.addEventListener('change', function() {
                    const column = this.dataset.column;
                    userSelectedDataTypes[column] = this.value;
                    
                    // อัพเดต format select ตามประเภท
                    const row = this.closest('tr');
                    const formatSelect = row.querySelector('.format-select');
                    const unitSelect = row.querySelector('.unit-select');
                    
                    // รีเซ็ต format
                    formatSelect.innerHTML = '<option value="default" selected>ค่าเริ่มต้น</option>';
                    
                    if (this.value === 'number') {
                        formatSelect.innerHTML += '<option value="decimal">ทศนิยม</option><option value="integer">จำนวนเต็ม</option>';
                    } else if (this.value === 'date') {
                        formatSelect.innerHTML += '<option value="YYYY-MM-DD">YYYY-MM-DD</option><option value="DD/MM/YYYY">DD/MM/YYYY</option><option value="YYYY/MM/DD">YYYY/MM/DD</option>';
                    } else if (this.value === 'text' && column.toLowerCase() === 'ชื่อประเภทอ้อย') {
                        sugarcaneTypes.forEach(type => {
                            formatSelect.innerHTML += `<option value="${type}">${type}</option>`;
                        });
                    }
                    
                    // รีเซ็ต unit
                    unitSelect.innerHTML = '<option value="none" selected>ไม่มีหน่วย</option>';
                    const colName = column.toLowerCase();
                    
                    if (colName.includes('พื้นที่')) {
                        unitSelect.innerHTML += '<option value="ไร่">ไร่</option><option value="งาน">งาน</option><option value="ตารางเมตร">ตร.ม.</option>';
                    } else if (colName.includes('อายุ')) {
                        unitSelect.innerHTML += '<option value="วัน">วัน</option><option value="เดือน">เดือน</option><option value="ปี">ปี</option>';
                    } else if (colName.includes('ปริมาณ')) {
                        unitSelect.innerHTML += '<option value="กิโลกรัม">กก.</option><option value="ตัน">ตัน</option>';
                    }
                });
            });
        }
        
        function getColumnDescription(columnName) {
            const descriptions = {
                'โซน': 'เขตพื้นที่',
                'รหัสนักเกษตร': 'รหัสประจำตัวนักเกษตร',
                'ชื่อนักเกษตร': 'ชื่อ-นามสกุลนักเกษตร',
                'ชื่อประเภทอ้อย': 'ประเภทของอ้อย เช่น ปลายฝนขยาย, ต้นฝนรื้อตอ',
                'ประเภทอ้อย': 'รหัสประเภทอ้อย เช่น 101, 102, 103, 104, 105',
                'เลขโควต้า': 'หมายเลขโควต้าที่ได้รับจัดสรร',
                'ชื่อชาวไร่': 'ชื่อ-นามสกุลชาวไร่',
                'เลขแปลงintech': 'หมายเลขแปลงในระบบ Intech',
                'lat': 'ค่าพิกัดละติจูด',
                'long': 'ค่าพิกัดลองจิจูด',
                'พื้นที่': 'ขนาดพื้นที่ปลูกอ้อย',
                'อายุ': 'อายุอ้อย (วัน)',
                'จำนวน': 'ปริมาณหรือจำนวน',
                'ปริมาณปุ๋ย': 'ปริมาณปุ๋ยที่ใช้',
                'โครงการ': 'ชื่อโครงการที่เกี่ยวข้อง',
                'วันที่ปลูก': 'วันที่ปลูกอ้อย',
                'ความเสี่ยงพื้นที่': 'ระดับความเสี่ยงของพื้นที่ปลูก',
                'ความลาดเอียงของพื้นที่': 'ความลาดเอียงของพื้นที่ปลูก'
            };
            
            // ค้นหาคำอธิบายจากชื่อคอลัมน์
            for (const key in descriptions) {
                if (columnName.toLowerCase().includes(key.toLowerCase())) {
                    return descriptions[key];
                }
            }
            
            return '';
        }
        
        function autoDetectDataTypes() {
            if (!filteredData || selectedColumns.length === 0) return;
            
            selectedColumns.forEach(columnName => {
                const columnNameLower = columnName.toLowerCase();
                
                // ✅ ตรวจจับคอลัมน์ "ชื่อประเภทอ้อย" เป็น text
                if (columnNameLower === 'ชื่อประเภทอ้อย') {
                    userSelectedDataTypes[columnName] = 'text';
                }
                // ✅ ตรวจจับคอลัมน์ "ประเภทอ้อย" เป็น number
                else if (columnNameLower === 'ประเภทอ้อย') {
                    userSelectedDataTypes[columnName] = 'number';
                }
                // ตรวจจับประเภทอื่นๆ ตามตรรกะเดิม
                else {
                    const sampleValues = filteredData.slice(0, 10).map(row => row[columnName] || '');
                    const nonEmptySamples = sampleValues.filter(v => v.trim() !== '');
                    
                    if (nonEmptySamples.length > 0) {
                        const detectedType = detectColumnType(columnName, nonEmptySamples[0]);
                        userSelectedDataTypes[columnName] = detectedType;
                    }
                }
            });
            
            renderDataTypeConfigurationTable();
            alert('✅ ตรวจจับประเภทข้อมูลอัตโนมัติเรียบร้อยแล้ว!');
        }
        
        function toggleAllRows() {
            isShowingAllRows = !isShowingAllRows;
            
            if (isShowingAllRows) {
                currentRowLimit = filteredData.length;
                document.getElementById('toggleAllRows').innerHTML = 
                    `<i class="fas fa-compress"></i> ซ่อนบางส่วน (${currentRowLimit})`;
            } else {
                currentRowLimit = 50;
                document.getElementById('toggleAllRows').innerHTML = 
                    `<i class="fas fa-expand"></i> แสดงทั้งหมด (${filteredData.length})`;
            }
            
            renderDataTableFromFilteredData();
        }
        
        function exportTableToCSV() {
            if (!filteredData || selectedColumns.length === 0) return;
            
            // ✅ ใช้คอลัมน์ตามลำดับเดิมในไฟล์ต้นฉบับ
            const exportColumns = [...uploadedData.headers].filter(col => 
                selectedColumns.includes(col)
            );
            
            // สร้าง CSV จากคอลัมน์ที่เลือก
            let csvContent = '';
            
            // เพิ่ม BOM สำหรับ UTF-8 เพื่อให้ Excel อ่านภาษาไทยได้ถูกต้อง
            csvContent += '\ufeff';
            
            // ✅ ใช้คอลัมน์ตามลำดับเดิม
            csvContent += exportColumns.join(',') + '\n';
            
            // เพิ่มข้อมูลทั้งหมด
            filteredData.forEach(row => {
                const rowValues = exportColumns.map(col => {
                    let value = row[col] || '';
                    
                    // แปลงอักขระพิเศษ
                    value = value.toString().replace(/"/g, '""'); // Escape quotes
                    
                    // ใส่ quotes ถ้ามี comma, newline หรือ quotes
                    if (value.includes(',') || value.includes('\n') || value.includes('\r') || value.includes('"')) {
                        value = `"${value}"`;
                    }
                    
                    return value;
                });
                csvContent += rowValues.join(',') + '\n';
            });
            
            // สร้าง blob และดาวน์โหลด
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `cleaned_${uploadedData.fileName.replace('.csv', '')}_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ ดาวน์โหลดไฟล์ CSV เรียบร้อย!\nจำนวนแถว: ${filteredData.length}\nจำนวนคอลัมน์: ${exportColumns.length}\n✅ คอลัมน์เรียงตามลำดับเดิม`);
        }
        
        function openCellEditorForFilteredData(rowIndex, colIndex) {
            if (!filteredData || !cellValidationStatus[rowIndex]) return;
            
            const columnName = selectedColumns[colIndex];
            const cell = document.querySelector(`td[data-row="${rowIndex}"][data-col="${colIndex}"]`);
            const currentValue = filteredData[rowIndex][columnName] || '';
            const validation = cellValidationStatus[rowIndex][colIndex];
            const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, currentValue);
            
            // บันทึกข้อมูลเซลล์ที่กำลังแก้ไข
            editingCell = { rowIndex, colIndex, cell, columnName, currentValue, validation, columnType };
            
            // อัพเดตข้อมูลใน modal
            editColumnName.textContent = columnName;
            editRowNumber.textContent = rowIndex + 1;
            
            // ตั้งค่าประเภทข้อมูลใน dropdown
            editDataTypeSelect.value = columnType;
            
            editIssue.textContent = validation.message;
            editIssue.className = validation.status === 'error' ? 'error-text' : 'warning-text';
            
            // ตั้งค่าค่าใน input
            cellValueInput.value = currentValue;
            
            // ✅ เพิ่มคำแนะนำเฉพาะสำหรับคอลัมน์พิเศษ
            valueSuggestions.innerHTML = '';
            
            if (columnName.toLowerCase() === 'ชื่อประเภทอ้อย') {
                valueSuggestions.innerHTML = `
                    <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 5px;">
                        <strong>คำแนะนำ:</strong> ปลายฝนขยาย, ปลายฝนรื้อตอ, ตอ1, ตอ2, ตอ3, ต้นฝนขยาย, ต้นฝนรื้อตอ, พื้นที่เสียหาย, >ตอ3
                    </div>
                `;
                
                // เพิ่มคำแนะนำเป็นปุ่มคลิกได้
                const suggestions = [
                    "ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ตอ1", "ตอ2", "ตอ3", 
                    "ต้นฝนขยาย", "ต้นฝนรื้อตอ", "พื้นที่เสียหาย", ">ตอ3"
                ];
                suggestions.forEach(suggestion => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'suggestion-item';
                    btn.textContent = suggestion;
                    btn.addEventListener('click', () => {
                        cellValueInput.value = suggestion;
                    });
                    valueSuggestions.appendChild(btn);
                });
            }
            else if (columnName.toLowerCase() === 'ประเภทอ้อย') {
                valueSuggestions.innerHTML = `
                    <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 5px;">
                        <strong>คำแนะนำ:</strong> 101, 102, 103, 104, 105, 106, 107, 108, 1050
                    </div>
                `;
                
                const suggestions = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];
                suggestions.forEach(suggestion => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'suggestion-item';
                    btn.textContent = suggestion;
                    btn.addEventListener('click', () => {
                        cellValueInput.value = suggestion;
                    });
                    valueSuggestions.appendChild(btn);
                });
            }
            else if (validation.suggestions && validation.suggestions.length > 0) {
                const suggestionTitle = document.createElement('div');
                suggestionTitle.textContent = 'คำแนะนำ:';
                suggestionTitle.style.fontSize = '0.8rem';
                suggestionTitle.style.color = '#6c757d';
                suggestionTitle.style.marginBottom = '5px';
                valueSuggestions.appendChild(suggestionTitle);
                
                validation.suggestions.forEach(suggestion => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'suggestion-item';
                    suggestionItem.textContent = suggestion;
                    suggestionItem.addEventListener('click', () => {
                        cellValueInput.value = suggestion;
                    });
                    valueSuggestions.appendChild(suggestionItem);
                });
            }
            
            // แสดง modal
            cellEditorModal.classList.add('show');
            cellValueInput.focus();
        }
        
        function saveCellEditForFilteredData() {
            if (!editingCell || !filteredData) return;
            
            const newValue = cellValueInput.value.trim();
            const newDataType = editDataTypeSelect.value;
            const { rowIndex, colIndex, cell, columnName, currentValue, columnType } = editingCell;
            
            // อัพเดตประเภทข้อมูลถ้าผู้ใช้เปลี่ยน
            if (newDataType !== columnType) {
                userSelectedDataTypes[columnName] = newDataType;
            }
            
            // อัพเดตข้อมูล
            filteredData[rowIndex][columnName] = newValue;
            
            // ตรวจสอบข้อมูลใหม่
            const newValidation = validateCellData(columnName, newValue, newDataType, rowIndex, colIndex);
            newValidation.edited = true;
            cellValidationStatus[rowIndex][colIndex] = newValidation;
            
            // อัพเดตเซลล์ในตาราง
            cell.textContent = newValue;
            cell.dataset.value = newValue;
            
            // อัพเดตคลาสตามสถานะใหม่
            cell.className = '';
            if (newValidation.status === 'error') {
                cell.className = 'cell-error cell-highlight';
                cell.title = newValidation.message;
            } else if (newValidation.status === 'warning') {
                cell.className = 'cell-warning cell-highlight';
                cell.title = newValidation.message;
            } else {
                cell.className = 'cell-valid';
            }
            
            // เปิดให้แก้ไขได้ถ้ายังมีปัญหา
            if (newValidation.status === 'error' || newValidation.status === 'warning') {
                cell.style.cursor = 'pointer';
                cell.addEventListener('click', () => openCellEditorForFilteredData(rowIndex, colIndex));
            }
            
            // รันการตรวจสอบใหม่
            runDataValidationFromFilteredData();
            
            // อัพเดต Dashboard และสถานะ
            updateDashboard();
            updateDataStatus();
            
            // ปิด modal
            closeCellEditor();
        }
        
        function closeCellEditor() {
            cellEditorModal.classList.remove('show');
            editingCell = null;
        }
        
        // ============================================
        // ขั้นตอนที่ 5: ระบบตรวจสอบเงื่อนไข
        // ============================================
        
        function initConditionChecking() {
            if (!filteredData || !selectedColumns) {
                document.getElementById('checkingResults').innerHTML = `
                    <div class="result-summary">
                        <p><i class="fas fa-exclamation-triangle"></i> ยังไม่มีข้อมูล กรุณาไปที่ขั้นตอนที่ 1-4 ก่อน</p>
                    </div>
                `;
                return;
            }
            
            // เตรียมตารางสำหรับเงื่อนไขที่เลือก (แสดงทั้งหมด)
            prepareCheckingTable();
        }
        
        function prepareCheckingTable() {
            if (!filteredData || filteredData.length === 0) return;
            
            // ล้างตารางเดิม
            checkingTableHeader.innerHTML = '';
            checkingTableBody.innerHTML = '';
            
            // ตั้งค่าข้อมูลสำหรับตารางตรวจสอบ
            checkingTableData = filteredData.slice(0, 100); // ใช้ 100 แถวแรกเพื่อประสิทธิภาพ
            
            // สร้างหัวตารางตามเงื่อนไข
            const headerRow = document.createElement('tr');
            
            // ✅ คอลัมน์ที่ 1: หมายเลขแถว
            const rowNumHeader = document.createElement('th');
            rowNumHeader.textContent = 'ลำดับ';
            headerRow.appendChild(rowNumHeader);
            
            // ✅ คอลัมน์ที่ 2: เงื่อนไข
            const conditionHeader = document.createElement('th');
            conditionHeader.textContent = 'เงื่อนไข';
            headerRow.appendChild(conditionHeader);
            
            // ✅ คอลัมน์ที่ 3-10: ขึ้นอยู่กับเงื่อนไขที่เลือก
            if (currentCondition === 'sugarcane') {
                // สำหรับเงื่อนไขประเภทอ้อย
                const columns = ['ชื่อประเภทอ้อย', 'ประเภทอ้อย', 'วันที่ปลูก', 'อายุ', 'พื้นที่', 'งวด', 'กิจกรรม', 'สถานะการใส่ปุ๋ย'];
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                
                // ✅ คอลัมน์ที่ 11: สถานะ
                const statusHeader = document.createElement('th');
                statusHeader.textContent = 'สถานะ';
                headerRow.appendChild(statusHeader);
                
                // ✅ คอลัมน์ที่ 12: หมายเหตุ
                const noteHeader = document.createElement('th');
                noteHeader.textContent = 'หมายเหตุ';
                headerRow.appendChild(noteHeader);
                
            } else if (currentCondition === 'fertilizer') {
                // สำหรับเงื่อนไขปุ๋ย
                const columns = ['ชื่อประเภทอ้อย', 'วันที่ปลูก', 'อายุ', 'งวด', 'ประเภทปุ๋ย', 'ปริมาณปุ๋ย', 'วิธีการใส่', 'วันที่ใส่ปุ๋ย'];
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                
                // ✅ คอลัมน์ที่ 11: สถานะ
                const statusHeader = document.createElement('th');
                statusHeader.textContent = 'สถานะ';
                headerRow.appendChild(statusHeader);
                
                // ✅ คอลัมน์ที่ 12: หมายเหตุ
                const noteHeader = document.createElement('th');
                noteHeader.textContent = 'หมายเหตุ';
                headerRow.appendChild(noteHeader);
            }
            
            checkingTableHeader.appendChild(headerRow);
            
            // เติมข้อมูลในตาราง
            renderCheckingTableData();
            
            // อัพเดตจำนวนแถว
            checkingRowsCount.textContent = checkingTableData.length;
        }
        
        function renderCheckingTableData() {
            checkingTableBody.innerHTML = '';
            
            if (!checkingTableData || checkingTableData.length === 0) return;
            
            checkingTableData.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // ✅ คอลัมน์ที่ 1: หมายเลขแถว
                const rowNumCell = document.createElement('td');
                rowNumCell.textContent = index + 1;
                tr.appendChild(rowNumCell);
                
                // ✅ คอลัมน์ที่ 2: เงื่อนไข
                const conditionCell = document.createElement('td');
                conditionCell.textContent = getConditionDisplayName(currentCondition);
                tr.appendChild(conditionCell);
                
                // ✅ คอลัมน์ที่ 3-10: ข้อมูลตามเงื่อนไข
                if (currentCondition === 'sugarcane') {
                    // ค้นหาคอลัมน์ที่เกี่ยวข้อง
                    const sugarcaneTypeCol = findColumnByName(selectedColumns, ['ชื่อประเภทอ้อย', 'ประเภทอ้อย', 'sugarcane']);
                    const plantingDateCol = findColumnByName(selectedColumns, ['วันที่ปลูก', 'planting', 'date']);
                    const ageCol = findColumnByName(selectedColumns, ['อายุ', 'age']);
                    const areaCol = findColumnByName(selectedColumns, ['พื้นที่', 'area']);
                    
                    // คอลัมน์ที่ 3: ชื่อประเภทอ้อย
                    const typeCell = document.createElement('td');
                    typeCell.textContent = sugarcaneTypeCol ? (row[sugarcaneTypeCol] || '') : '';
                    tr.appendChild(typeCell);
                    
                    // คอลัมน์ที่ 4: ประเภทอ้อย (ตัวเลข)
                    const typeNumCell = document.createElement('td');
                    if (sugarcaneTypeCol) {
                        const typeValue = row[sugarcaneTypeCol] || '';
                        if (typeValue === 'ปลายฝนขยาย') typeNumCell.textContent = '101';
                        else if (typeValue === 'ปลายฝนรื้อตอ') typeNumCell.textContent = '102';
                        else if (typeValue === 'ตอ1') typeNumCell.textContent = '103';
                        else if (typeValue === 'ตอ2') typeNumCell.textContent = '104';
                        else if (typeValue === 'ตอ3') typeNumCell.textContent = '105';
                        else if (typeValue === 'ต้นฝนขยาย') typeNumCell.textContent = '106';
                        else if (typeValue === 'ต้นฝนรื้อตอ') typeNumCell.textContent = '107';
                        else if (typeValue === 'พื้นที่เสียหาย') typeNumCell.textContent = '108';
                        else if (typeValue === '>ตอ3') typeNumCell.textContent = '1050';
                    }
                    tr.appendChild(typeNumCell);
                    
                    // คอลัมน์ที่ 5: วันที่ปลูก (พร้อมตรวจสอบรูปแบบ)
                    const dateCell = document.createElement('td');
                    if (plantingDateCol) {
                        const dateValue = row[plantingDateCol] || '';
                        dateCell.textContent = dateValue;
                    }
                    tr.appendChild(dateCell);
                    
                    // คอลัมน์ที่ 6: อายุ
                    const ageCell = document.createElement('td');
                    if (ageCol) {
                        ageCell.textContent = row[ageCol] || '';
                    }
                    tr.appendChild(ageCell);
                    
                    // คอลัมน์ที่ 7: พื้นที่
                    const areaCell = document.createElement('td');
                    areaCell.textContent = areaCol ? (row[areaCol] || '') : '';
                    tr.appendChild(areaCell);
                    
                    // คอลัมน์ที่ 8: งวด (จะคำนวณจากอายุ)
                    const periodCell = document.createElement('td');
                    periodCell.textContent = 'รอคำนวณ';
                    tr.appendChild(periodCell);
                    
                    // คอลัมน์ที่ 9: กิจกรรม (ตามงวด)
                    const activityCell = document.createElement('td');
                    activityCell.textContent = 'รอตรวจสอบ';
                    tr.appendChild(activityCell);
                    
                    // คอลัมน์ที่ 10: สถานะการใส่ปุ๋ย
                    const fertilizerStatusCell = document.createElement('td');
                    fertilizerStatusCell.textContent = 'รอตรวจสอบ';
                    tr.appendChild(fertilizerStatusCell);
                    
                } else if (currentCondition === 'fertilizer') {
                    // กรณีตรวจสอบปุ๋ย (ตัวอย่าง)
                    // คอลัมน์ที่ 3: ชื่อประเภทอ้อย
                    const typeCell = document.createElement('td');
                    const sugarcaneTypeCol = findColumnByName(selectedColumns, ['ชื่อประเภทอ้อย', 'ประเภทอ้อย', 'sugarcane']);
                    typeCell.textContent = sugarcaneTypeCol ? (row[sugarcaneTypeCol] || '') : '';
                    tr.appendChild(typeCell);
                    
                    // คอลัมน์ที่ 4: วันที่ปลูก
                    const dateCell = document.createElement('td');
                    const plantingDateCol = findColumnByName(selectedColumns, ['วันที่ปลูก', 'planting', 'date']);
                    dateCell.textContent = plantingDateCol ? (row[plantingDateCol] || '') : '';
                    tr.appendChild(dateCell);
                    
                    // คอลัมน์ที่ 5-10: (ว่างไว้สำหรับตัวอย่าง)
                    for (let i = 5; i <= 10; i++) {
                        const cell = document.createElement('td');
                        cell.textContent = 'ข้อมูลตัวอย่าง';
                        tr.appendChild(cell);
                    }
                }
                
                // ✅ คอลัมน์ที่ 11: สถานะ (ว่างไว้ก่อน)
                const statusCell = document.createElement('td');
                statusCell.innerHTML = '<span class="status-badge status-info">รอตรวจสอบ</span>';
                tr.appendChild(statusCell);
                
                // ✅ คอลัมน์ที่ 12: หมายเหตุ (ว่างไว้ก่อน)
                const noteCell = document.createElement('td');
                noteCell.textContent = '-';
                tr.appendChild(noteCell);
                
                checkingTableBody.appendChild(tr);
            });
        }
        
        function findColumnByName(columns, possibleNames) {
            for (const column of columns) {
                const columnLower = column.toLowerCase().trim();
                for (const name of possibleNames) {
                    if (columnLower.includes(name.toLowerCase())) {
                        return column;
                    }
                }
            }
            return null;
        }
        
        function getConditionDisplayName(condition) {
            const names = {
                "sugarcane": "ประเภทอ้อย",
                "fertilizer": "ปุ๋ย"
            };
            return names[condition] || condition;
        }
        
        // ============================================
        // ขั้นตอนที่ 6: เลือกคอลัมน์สำหรับส่งออก
        // ============================================
        
        function initExportColumnSelection() {
            if (!filteredData || !selectedColumns) {
                alert('ยังไม่มีข้อมูล กรุณาไปที่ขั้นตอนที่ 1-5 ก่อน');
                return;
            }
            
            // ✅ เริ่มต้นด้วยการเลือกคอลัมน์พื้นฐานที่จำเป็น
            exportColumns = [];
            
            // ค้นหาคอลัมน์ที่ตรงกับรายการที่ต้องการ
            autoExportColumns.forEach(targetCol => {
                const foundColumn = selectedColumns.find(col => 
                    col.toLowerCase().includes(targetCol.toLowerCase())
                );
                
                if (foundColumn && !exportColumns.includes(foundColumn)) {
                    exportColumns.push(foundColumn);
                }
            });
            
            // แสดงรายการคอลัมน์สำหรับเลือกส่งออก
            renderExportColumnGrid();
            
            // อัพเดตสถิติ
            updateExportColumnStats();
            
            // ตั้งค่า event listeners
            setupExportColumnSelectionSystem();
        }
        
        function renderExportColumnGrid() {
            exportColumnsGrid.innerHTML = '';
            
            if (!selectedColumns || selectedColumns.length === 0) return;
            
            selectedColumns.forEach(columnName => {
                const isSelected = exportColumns.includes(columnName);
                const columnNameLower = columnName.toLowerCase();
                
                // ตรวจสอบว่าเป็นคอลัมน์ที่แนะนำหรือไม่
                let isRecommended = false;
                autoExportColumns.forEach(recommended => {
                    if (columnNameLower.includes(recommended.toLowerCase())) {
                        isRecommended = true;
                    }
                });
                
                const columnItem = document.createElement('div');
                columnItem.className = `export-column-item ${isSelected ? 'selected' : ''}`;
                columnItem.innerHTML = `
                    <input type="checkbox" class="export-column-checkbox" 
                           ${isSelected ? 'checked' : ''} 
                           data-column="${columnName}">
                    <div class="export-column-info">
                        <div class="export-column-name" title="${columnName}">
                            ${columnName}
                            ${isRecommended ? '<span style="color: var(--success-color); font-size: 0.8rem; margin-left: 5px;">(แนะนำ)</span>' : ''}
                        </div>
                        <span class="export-column-type">${getColumnTypeDisplay(columnName)}</span>
                    </div>
                `;
                
                exportColumnsGrid.appendChild(columnItem);
                
                // เพิ่ม event listener สำหรับ checkbox
                const checkbox = columnItem.querySelector('.export-column-checkbox');
                checkbox.addEventListener('change', function() {
                    const columnName = this.dataset.column;
                    
                    if (this.checked) {
                        if (!exportColumns.includes(columnName)) {
                            exportColumns.push(columnName);
                        }
                    } else {
                        const index = exportColumns.indexOf(columnName);
                        if (index > -1) {
                            exportColumns.splice(index, 1);
                        }
                    }
                    
                    // อัพเดต UI
                    columnItem.classList.toggle('selected', this.checked);
                    updateExportColumnStats();
                });
            });
        }
        
        function getColumnTypeDisplay(columnName) {
            const columnNameLower = columnName.toLowerCase();
            const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, '');
            
            if (columnNameLower.includes('ประเภทอ้อย') || columnNameLower.includes('ชื่อประเภทอ้อย')) {
                return 'ข้อมูลประเภทอ้อย';
            } else if (columnNameLower.includes('วันที่')) {
                return 'วันที่';
            } else if (columnNameLower.includes('พื้นที่')) {
                return 'พื้นที่';
            } else if (columnNameLower.includes('รหัส')) {
                return 'รหัส';
            } else if (columnNameLower.includes('จำนวน') || columnNameLower.includes('ปริมาณ')) {
                return 'จำนวน';
            } else {
                return getTypeDisplayName(columnType);
            }
        }
        
        function updateExportColumnStats() {
            exportSelectedCount.textContent = exportColumns.length;
            
            if (exportColumns.length === 0) {
                exportColumnsList.textContent = 'ยังไม่ได้เลือกคอลัมน์';
            } else {
                const displayedColumns = exportColumns.slice(0, 5);
                const moreCount = exportColumns.length - 5;
                exportColumnsList.textContent = displayedColumns.join(', ') + 
                    (moreCount > 0 ? ` และอีก ${moreCount} คอลัมน์...` : '');
            }
        }
        
        function setupExportColumnSelectionSystem() {
            // Filter buttons
            document.querySelectorAll('#panel6 .selection-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // อัพเดตปุ่มที่ active
                    document.querySelectorAll('#panel6 .selection-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    const filterType = this.dataset.filter;
                    filterExportColumns(filterType);
                });
            });
            
            // Select all / Deselect all
            exportSelectAllBtn.addEventListener('click', function() {
                exportColumns = [...selectedColumns];
                renderExportColumnGrid();
                updateExportColumnStats();
            });
            
            exportDeselectAllBtn.addEventListener('click', function() {
                exportColumns = [];
                renderExportColumnGrid();
                updateExportColumnStats();
            });
            
            // Download clean data
            downloadCleanData.addEventListener('click', exportCleanData);
        }
        
        function filterExportColumns(filterType) {
            const columnItems = document.querySelectorAll('.export-column-item');
            
            columnItems.forEach(item => {
                const columnName = item.querySelector('.export-column-checkbox').dataset.column;
                const isSelected = exportColumns.includes(columnName);
                const isRecommended = autoExportColumns.some(rec => 
                    columnName.toLowerCase().includes(rec.toLowerCase())
                );
                
                let shouldShow = true;
                
                switch(filterType) {
                    case 'recommended':
                        shouldShow = isRecommended;
                        break;
                    case 'selected':
                        shouldShow = isSelected;
                        break;
                    case 'unselected':
                        shouldShow = !isSelected;
                        break;
                    case 'all':
                    default:
                        shouldShow = true;
                }
                
                item.style.display = shouldShow ? 'flex' : 'none';
            });
        }
        
        function exportCleanData() {
            if (!filteredData || filteredData.length === 0) {
                alert('ไม่มีข้อมูลที่จะส่งออก');
                return;
            }
            
            if (exportColumns.length === 0) {
                alert('กรุณาเลือกคอลัมน์ที่ต้องการส่งออก');
                return;
            }
            
            // สร้าง CSV จากคอลัมน์ที่เลือก
            let csvContent = '';
            
            // เพิ่ม BOM สำหรับ UTF-8 เพื่อให้ Excel อ่านภาษาไทยได้ถูกต้อง
            csvContent += '\ufeff';
            
            // เพิ่มหัวคอลัมน์
            csvContent += exportColumns.join(',') + '\n';
            
            // เพิ่มข้อมูลทั้งหมด
            filteredData.forEach(row => {
                const rowValues = exportColumns.map(col => {
                    let value = row[col] || '';
                    
                    // แปลงอักขระพิเศษ
                    value = value.toString().replace(/"/g, '""');
                    
                    // ใส่ quotes ถ้ามี comma, newline หรือ quotes
                    if (value.includes(',') || value.includes('\n') || value.includes('\r') || value.includes('"')) {
                        value = `"${value}"`;
                    }
                    
                    return value;
                });
                csvContent += rowValues.join(',') + '\n';
            });
            
            // สร้าง blob และดาวน์โหลด
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `clean_data_${uploadedData.fileName.replace('.csv', '')}_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ ดาวน์โหลดข้อมูล Clean Data เรียบร้อย!\nจำนวนแถว: ${filteredData.length}\nจำนวนคอลัมน์: ${exportColumns.length}\n✅ ข้อมูลพร้อมใช้งานแล้ว`);
        }
        
        // ============================================
        // การตั้งค่า Event Listeners ทั้งหมด
        // ============================================
        
        // Navigation buttons
        nextToStep2.addEventListener('click', () => goToStep(2));
        nextToStep3.addEventListener('click', () => goToStep(3));
        nextToStep4.addEventListener('click', () => goToStep(4));
        nextToStep5.addEventListener('click', () => goToStep(5));
        nextToStep6.addEventListener('click', () => goToStep(6));
        
        backToStep1.addEventListener('click', () => goToStep(1));
        backToStep2.addEventListener('click', () => goToStep(2));
        backToStep3.addEventListener('click', () => goToStep(3));
        backToStep4.addEventListener('click', () => goToStep(4));
        backToStep5.addEventListener('click', () => goToStep(5));
        
        // ตั้งค่า Event Listeners สำหรับระบบต่างๆ
        setupEnhancedEventListeners();
        
        // เริ่มต้นใช้งาน
        console.log('✅ ระบบ Clean Data สำหรับข้อมูลอ้อยพร้อมใช้งานแล้ว!');
        console.log('วิธีการใช้งาน:');
        console.log('1. คลิกที่พื้นที่อัปโหลดหรือปุ่ม "เลือกไฟล์ CSV"');
        console.log('2. เลือกไฟล์ CSV ที่ต้องการ');
        console.log('3. ระบบจะประมวลผลและแสดงข้อมูล');
    </script>
</body>
</html>
