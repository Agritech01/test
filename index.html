<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบ Clean Data - ตรวจสอบข้อมูลไฟล์ KAT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Prompt:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #4cc9f0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f72585;
            --sugarcane-color: #228B22;
            --fertilizer-color: #9C27B0;
            --project-color: #FF5722;
            --border-radius: 12px;
            --box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Prompt', sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        
        header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        
        h1 {
            font-family: 'Kanit', sans-serif;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* Navigation Steps */
        .step-navigation {
            display: flex;
            justify-content: center;
            background-color: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 15px;
            position: relative;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 10px;
            z-index: 2;
            transition: all 0.3s ease;
        }
        
        .step.active .step-number {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 0 0 5px rgba(67, 97, 238, 0.2);
        }
        
        .step.completed .step-number {
            background-color: var(--success-color);
            color: white;
        }
        
        .step-info {
            display: flex;
            flex-direction: column;
        }
        
        .step-title {
            font-weight: 500;
            font-size: 1rem;
        }
        
        .step-description {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        /* Dashboard Summary */
        .dashboard-summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
        }
        
        .summary-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .summary-icon.success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
        }
        
        .summary-icon.warning {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }
        
        .summary-icon.error {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger-color);
        }
        
        .summary-icon.info {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
        }
        
        .summary-content {
            flex: 1;
        }
        
        .summary-content h4 {
            margin: 0 0 5px 0;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 1s ease;
        }
        
        .progress-fill.success {
            background: var(--success-color);
        }
        
        .progress-fill.warning {
            background: var(--warning-color);
        }
        
        .progress-fill.error {
            background: var(--danger-color);
        }
        
        .progress-fill.info {
            background: var(--primary-color);
        }
        
        .summary-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Step Content Area */
        .step-content {
            padding: 40px;
            min-height: 600px;
        }
        
        .step-panel {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .step-panel.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Panel Styling */
        .panel-header {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .panel-header h2 {
            font-size: 2rem;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .panel-header p {
            color: #666;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Upload Section - NEW DESIGN */
        .upload-area {
            border: 3px dashed var(--accent-color);
            border-radius: var(--border-radius);
            padding: 60px 20px;
            text-align: center;
            background-color: rgba(76, 201, 240, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .upload-area:hover {
            background-color: rgba(76, 201, 240, 0.1);
            border-color: var(--primary-color);
        }
        
        .upload-area i {
            font-size: 4rem;
            color: var(--accent-color);
            margin-bottom: 20px;
        }
        
        .upload-area h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--secondary-color);
        }
        
        .upload-area p {
            color: #666;
            margin-bottom: 20px;
        }
        
        /* File Meta Card - NEW DESIGN */
        .file-meta-card {
            background: #fff;
            border: 1px solid #e0e6ed;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            border-left: 5px solid var(--primary-color);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            display: none;
        }
        
        .meta-item {
            display: flex;
            flex-direction: column;
        }
        
        .meta-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
        }
        
        .meta-value {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }
        
        /* Stats Grid - NEW DESIGN */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 30px auto;
            max-width: 800px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
            border-bottom: 4px solid var(--primary-color);
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        /* Report Container - NEW DESIGN */
        .report-container {
            margin-top: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .report-header {
            background: #f8f9fa;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .report-item {
            display: flex;
            justify-content: space-between;
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
        }
        
        .count-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .count-removed {
            color: #c62828;
            background: #ffcdd2;
        }
        
        .count-modified {
            color: #ef6c00;
            background: #ffe0b2;
        }
        
        /* Column Selection Panel */
        .column-selection-panel {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-container {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 30px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .search-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .selection-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .selection-btn {
            padding: 8px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .selection-btn:hover {
            background-color: #e9ecef;
        }
        
        .selection-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .columns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .column-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .column-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .column-item.selected {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .column-item.sugarcane {
            border-left: 4px solid var(--sugarcane-color);
        }
        
        .column-item.activity {
            border-left: 4px solid var(--accent-color);
        }
        
        .column-item.project {
            border-left: 4px solid var(--project-color);
        }
        
        .column-item.fertilizer {
            border-left: 4px solid var(--fertilizer-color);
        }
        
        .column-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .column-info {
            flex: 1;
        }
        
        .column-name {
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .column-type {
            font-size: 0.8rem;
            color: #666;
            background-color: #f0f0f0;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .column-stats {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }
        
        .selected-summary {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--success-color);
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* Data Type Configuration */
        .data-type-configuration {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
            display: none;
        }
        
        .data-type-configuration h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .config-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .data-type-table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .data-type-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .data-type-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }
        
        .data-type-table th:hover {
            background-color: var(--secondary-color);
        }
        
        .data-type-table th i {
            margin-left: 5px;
            opacity: 0.7;
        }
        
        .data-type-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .type-select, .format-select, .unit-select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: 'Prompt', sans-serif;
            background: white;
        }
        
        .type-select:focus, .format-select:focus, .unit-select:focus {
            border-color: var(--accent-color);
            outline: none;
        }
        
        .data-sample-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Data Table */
        .data-table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            border: 1px solid #dee2e6;
            border-bottom: none;
        }
        
        .table-info {
            display: flex;
            gap: 20px;
            color: #6c757d;
            font-size: 0.9rem;
            align-items: center;
        }
        
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        #dataStatus {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
        }
        
        #dataStatus:hover {
            opacity: 0.9;
        }
        
        .data-table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            background: white;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--primary-color);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--secondary-color);
        }
        
        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }
        
        .data-table tr:hover td {
            background: #f8f9fa;
        }
        
        /* ✅ สไตล์สำหรับฟิลเตอร์ในหัวตาราง (Dropdown) */
        .data-table th, .checking-table th {
            position: relative;
        }
        
        .filter-dropdown {
            width: calc(100% - 10px);
            margin-top: 5px;
            padding: 4px 6px;
            font-size: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Prompt', sans-serif;
            background-color: white;
        }
        
        .filter-dropdown:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.2);
        }
        
        /* Animation สำหรับ highlight เซลล์ */
        @keyframes highlightCell {
            0% { background-color: #fff3e0; }
            50% { background-color: #ffecb3; }
            100% { background-color: transparent; }
        }
        
        .cell-highlight {
            animation: highlightCell 2s ease;
        }
        
        /* Cell Styling */
        .cell-error {
            background: rgba(247, 37, 133, 0.1) !important;
            color: var(--danger-color) !important;
            font-weight: 600;
            position: relative;
            cursor: pointer;
        }
        
        .cell-error:hover {
            background: rgba(247, 37, 133, 0.2) !important;
        }
        
        .cell-error:after {
            content: "!";
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .cell-warning {
            background: rgba(255, 152, 0, 0.1) !important;
            color: var(--warning-color) !important;
            cursor: pointer;
        }
        
        .cell-valid {
            color: var(--success-color);
        }
        
        .cell-editing {
            background: #fffde7 !important;
            border: 2px solid var(--accent-color) !important;
        }
        
        /* Cell Editor Modal */
        .cell-editor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .cell-editor-modal.show {
            display: flex;
        }
        
        .cell-editor-modal .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-header h4 {
            margin: 0;
            color: var(--secondary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6c757d;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .cell-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .cell-info p {
            margin: 5px 0;
            color: #495057;
        }
        
        .error-text {
            color: var(--danger-color) !important;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.1);
        }
        
        .suggestions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        
        .suggestion-item {
            background: #e3f2fd;
            color: var(--primary-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .suggestion-item:hover {
            background: #bbdefb;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Data Type Configuration */
        .data-type-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filter-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover {
            background-color: #e9ecef;
        }
        
        .filter-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .ai-fix-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Kanit', sans-serif;
            transition: all 0.3s ease;
        }
        
        .ai-fix-btn:hover {
            background-color: #3ab0d8;
            transform: translateY(-2px);
        }
        
        .ai-fix-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-cell {
            color: var(--danger-color) !important;
            font-weight: bold;
            background-color: rgba(247, 37, 133, 0.1);
        }
        
        .warning-cell {
            color: var(--warning-color) !important;
            background-color: rgba(255, 152, 0, 0.1);
        }
        
        .editable-cell {
            position: relative;
            cursor: pointer;
        }
        
        .editable-cell:hover {
            background-color: rgba(76, 201, 240, 0.1);
        }
        
        .cell-input {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--accent-color);
            border-radius: 4px;
            font-family: 'Prompt', sans-serif;
            font-size: 0.9rem;
        }
        
        .type-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .type-text {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .type-number {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .type-date {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        .type-enum {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        
        .type-identifier {
            background-color: #e0f2f1;
            color: #00695c;
        }
        
        /* ขั้นตอนที่ 4: ตรวจสอบเงื่อนไข - สไตล์ใหม่ */
        .condition-selection {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .condition-selection h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .condition-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .condition-select-btn {
            padding: 20px 15px;
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .condition-select-btn:hover {
            background-color: #e9ecef;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .condition-select-btn.active {
            background-color: rgba(67, 97, 238, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .condition-select-btn[data-condition="sugarcane"].active {
            background-color: rgba(34, 139, 34, 0.1);
            border-color: var(--sugarcane-color);
            color: var(--sugarcane-color);
        }
        
        .condition-select-btn[data-condition="activity"].active {
            background-color: rgba(76, 201, 240, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        .condition-select-btn[data-condition="project"].active {
            background-color: rgba(255, 87, 34, 0.1);
            border-color: var(--project-color);
            color: var(--project-color);
        }
        
        .condition-select-btn[data-condition="fertilizer"].active {
            background-color: rgba(156, 39, 176, 0.1);
            border-color: var(--fertilizer-color);
            color: var(--fertilizer-color);
        }
        
        .condition-select-btn i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .condition-desc {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }
        
        /* Checking controls */
        .checking-controls {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .checking-info {
            flex: 1;
            min-width: 300px;
        }
        
        .checking-info h4 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .checking-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .checking-stats span {
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #495057;
        }
        
        .checking-stats strong {
            color: var(--primary-color);
        }
        
        .checking-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        /* Checking table */
        .checking-table-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .table-info {
            display: flex;
            gap: 20px;
            color: #6c757d;
            font-size: 0.9rem;
            align-items: center;
        }
        
        .table-info span:first-child {
            font-weight: 500;
            color: var(--secondary-color);
        }
        
        .checking-table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            padding: 0;
        }
        
        .checking-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1300px; /* ✅ เพิ่มความกว้างให้พอดีกับคอลัมน์ใหม่ */
        }
        
     /* ✅ ปรับให้คอลัมน์ลำดับตรึงอยู่ด้านซ้าย */
.checking-table th:nth-child(1),
.checking-table td:nth-child(1) {
    width: 60px;
    min-width: 60px;
    max-width: 60px;
    text-align: center;
    position: sticky;
    left: 0;
    background: var(--primary-color);
    color: white;
    z-index: 30; /* เพิ่ม z-index เพื่อให้อยู่ด้านบน */
}

.checking-table td:nth-child(1) {
    background: #f8f9fa; /* เปลี่ยนพื้นหลังให้เหมือนกับแถว */
    color: var(--dark-color);
    font-weight: bold;
    border-right: 2px solid #ddd; /* เพิ่มเส้นขวาเพื่อแยกคอลัมน์ */
}

/* ✅ ปรับให้คอลัมน์เลขแปลงintech ตรึงอยู่ด้านซ้ายถัดจากลำดับ */
.checking-table th:nth-child(2),
.checking-table td:nth-child(2) {
    width: 140px; /* เพิ่มความกว้างเล็กน้อย */
    min-width: 140px;
    max-width: 140px;
    position: sticky;
    left: 60px; /* เริ่มจากความกว้างของคอลัมน์แรก */
    background: var(--primary-color);
    color: white;
    z-index: 25; /* z-index น้อยกว่าคอลัมน์แรก */
    border-right: 2px solid #ddd;
}

.checking-table td:nth-child(2) {
    background: #f8f9fa;
    color: var(--dark-color);
    font-weight: 500;
    border-right: 2px solid #ddd; /* เส้นขวาที่ชัดเจน */
}

/* ✅ สำหรับแถวที่มีคำเตือน/ข้อผิดพลาด */
.checking-table tr.warning-row td:nth-child(1),
.checking-table tr.warning-row td:nth-child(2) {
    background: rgba(255, 248, 225, 0.7); /* สีเหลืองอ่อนเหมือนแถว */
}

.checking-table tr.project-row-error td:nth-child(1),
.checking-table tr.project-row-error td:nth-child(2) {
    background: rgba(255, 235, 238, 0.7); /* สีแดงอ่อนเหมือนแถว */
}

.checking-table tr.project-row-success td:nth-child(1),
.checking-table tr.project-row-success td:nth-child(2) {
    background: rgba(232, 245, 233, 0.7); /* สีเขียวอ่อนเหมือนแถว */
}

/* ✅ เมื่อ hover ต้องไม่เปลี่ยนสีพื้นหลังของคอลัมน์ที่ตรึง */
.checking-table tr:hover td:nth-child(1),
.checking-table tr:hover td:nth-child(2) {
    background: inherit !important; /* ใช้สีเดิม ไม่เปลี่ยนตาม hover */
}
/* ✅ ปรับ scroll hint ให้ชัดเจนขึ้น */
#scrollHint {
    color: var(--accent-color);
    font-size: 0.9rem;
    margin-left: 15px;
    display: flex;
    align-items: center;
    gap: 5px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
}

/* ✅ ข้อความแจ้งเตือนเมื่อเลื่อน */
.checking-table-wrapper::-webkit-scrollbar {
    height: 8px;
}

.checking-table-wrapper::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.checking-table-wrapper::-webkit-scrollbar-thumb {
    background: var(--accent-color);
    border-radius: 4px;
}
/* ✅ คอลัมน์โซน (คอลัมน์ที่ 3) */
.checking-table th:nth-child(3),
.checking-table td:nth-child(3) {
    width: 80px;
    min-width: 80px;
    max-width: 80px;
    background-color: #e8f5e9;
}

/* ✅ คอลัมน์รหัสนักเกษตร (คอลัมน์ที่ 4) */
.checking-table th:nth-child(4),
.checking-table td:nth-child(4) {
    width: 120px;
    min-width: 120px;
    max-width: 120px;
    background-color: #e3f2fd;
}

/* คอลัมน์อื่นๆ... */
.checking-table th:nth-child(5),
.checking-table td:nth-child(5) {
    width: 130px;
    min-width: 130px;
    max-width: 130px;
}

.checking-table th:nth-child(6),
.checking-table td:nth-child(6) {
    width: 100px;
    min-width: 100px;
    max-width: 100px;
    text-align: center;
}

        .checking-table th:nth-child(7),
        .checking-table td:nth-child(7) {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }

        .checking-table th:nth-child(8),
        .checking-table td:nth-child(8) {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }

        .checking-table th:nth-child(9),
        .checking-table td:nth-child(9) {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }

        .checking-table th:nth-child(10),
        .checking-table td:nth-child(10) {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }

        /* ✅ คอลัมน์สถานะ (คอลัมน์ที่ 11) */
        .checking-table th:nth-child(11),
        .checking-table td:nth-child(11) {
            width: 100px;
            min-width: 100px;
            max-width: 100px;
            text-align: center;
            background-color: #f8f9fa;
        }

        /* ✅ คอลัมน์หมายเหตุ (คอลัมน์ที่ 12) */
        .checking-table th:nth-child(12),
        .checking-table td:nth-child(12) {
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            background-color: #f8f9fa;
        }
        
        /* ✅ แถวที่ไม่มีข้อมูลวันที่ปลูก - สีเหลือง */
        .checking-table tr.warning-row {
            background-color: rgba(255, 248, 225, 0.7) !important;
            border-left: 4px solid var(--warning-color) !important;
        }
        
        .checking-table tr.warning-row:hover td {
            background-color: rgba(255, 248, 225, 0.9) !important;
        }
        
        .checking-table tr.warning-row td {
            border-bottom: 1px solid rgba(255, 248, 225, 0.5);
        }
        
        /* สำหรับวันที่ปลูกที่ยาวเกินไป */
        .checking-table td[title] {
            cursor: help;
        }
        
        /* เมื่อต้องการแสดงวันที่เต็ม */
        .date-cell-compact:hover {
            overflow: visible;
            white-space: normal;
            background-color: #fffde7 !important;
            z-index: 100;
            position: relative;
        }
        
        /* สำหรับหน้าจอขนาดเล็ก */
        @media (max-width: 768px) {
            .checking-table th:nth-child(4),
            .checking-table td:nth-child(4) {
                width: 100px;
                min-width: 100px;
                max-width: 100px;
                font-size: 0.85em;
            }
            
            .checking-table th:nth-child(3),
            .checking-table td:nth-child(3) {
                width: 120px;
                min-width: 120px;
                max-width: 120px;
                font-size: 0.9em;
            }
        }
        
        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            text-align: center;
            min-width: 80px;
        }
        
        .status-valid {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .status-warning {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(255, 152, 0, 0.3);
        }
        
        .status-error {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(247, 37, 133, 0.3);
        }
        
        .status-info {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(67, 97, 238, 0.3);
        }
        
        /* Checking details */
        .checking-details {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .checking-details h4 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checking-results {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .result-summary {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .result-summary p {
            margin-bottom: 10px;
            color: #495057;
        }
        
        .result-note {
            background: #fff3e0;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #e65100;
        }
        
        .result-item {
            padding: 10px 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .result-item.error {
            border-left-color: var(--danger-color);
            background: rgba(247, 37, 133, 0.05);
        }
        
        .result-item.warning {
            border-left-color: var(--warning-color);
            background: rgba(255, 152, 0, 0.05);
        }
        
        .result-item.success {
            border-left-color: var(--success-color);
            background: rgba(76, 175, 80, 0.05);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .result-condition {
            font-weight: 500;
            color: var(--secondary-color);
        }
        
        .result-count {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .result-details {
            font-size: 0.9rem;
            color: #495057;
            margin-top: 5px;
        }
        
        .result-details ul {
            margin-left: 20px;
            margin-top: 5px;
        }
        
        .result-details li {
            margin-bottom: 3px;
            color: #666;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 25px;
            border-radius: 30px;
            border: none;
            font-family: 'Kanit', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3d8b40;
            transform: translateY(-2px);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        /* Loading Spinner */
        .spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal สำหรับ AI Fix */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        /* สไตล์สำหรับขั้นตอนที่ 4 */
.condition-selection {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    padding: 25px;
    margin-bottom: 25px;
}

.condition-selection h3 {
    color: var(--secondary-color);
    margin-bottom: 20px;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.condition-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
}

.condition-select-btn {
    padding: 20px 15px;
    background-color: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: var(--border-radius);
    cursor: pointer;
    text-align: left;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.condition-select-btn:hover {
    background-color: #e9ecef;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.condition-select-btn.active {
    background-color: rgba(67, 97, 238, 0.1);
    border-color: var(--primary-color);
    color: var(--primary-color);
}

.condition-select-btn[data-condition="sugarcane"].active {
    background-color: rgba(34, 139, 34, 0.1);
    border-color: var(--sugarcane-color);
    color: var(--sugarcane-color);
}

.condition-select-btn[data-condition="activity"].active {
    background-color: rgba(76, 201, 240, 0.1);
    border-color: var(--accent-color);
    color: var(--accent-color);
}

.condition-select-btn[data-condition="project"].active {
    background-color: rgba(255, 87, 34, 0.1);
    border-color: var(--project-color);
    color: var(--project-color);
}

.condition-select-btn[data-condition="fertilizer"].active {
    background-color: rgba(156, 39, 176, 0.1);
    border-color: var(--fertilizer-color);
    color: var(--fertilizer-color);
}

.condition-select-btn i {
    font-size: 1.5rem;
    margin-bottom: 5px;
}

.condition-desc {
    font-size: 0.85rem;
    color: #666;
    line-height: 1.4;
}

.checking-controls {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    padding: 20px;
    margin-bottom: 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
}

.checking-info {
    flex: 1;
    min-width: 300px;
}

.checking-info h4 {
    color: var(--secondary-color);
    margin-bottom: 10px;
    font-size: 1.1rem;
}

.checking-stats {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.checking-stats span {
    background: #f8f9fa;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9rem;
    color: #495057;
}

.checking-stats strong {
    color: var(--primary-color);
}

.checking-actions {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.checking-table-container {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    margin-bottom: 25px;
    overflow: hidden;
}

.table-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.table-info {
    display: flex;
    gap: 20px;
    color: #6c757d;
    font-size: 0.9rem;
    align-items: center;
}

.checking-table-wrapper {
    max-height: 600px;
    overflow-y: auto;
    padding: 0;
}

.checking-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1000px;
}

.checking-table th {
    background: var(--primary-color);
    color: white;
    padding: 12px;
    text-align: left;
    font-weight: 500;
    position: sticky;
    top: 0;
    z-index: 10;
}

.checking-table td {
    padding: 10px;
    border-bottom: 1px solid #eee;
}

.checking-table tr:hover td {
    background: #f8f9fa;
}

.checking-details {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    padding: 25px;
    margin-bottom: 25px;
}

.checking-details h4 {
    color: var(--secondary-color);
    margin-bottom: 15px;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.checking-results {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    max-height: 300px;
    overflow-y: auto;
}

.result-summary {
    padding: 15px;
    background: white;
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
}

.result-summary p {
    margin-bottom: 10px;
    color: #495057;
}

.result-note {
    background: #fff3e0;
    padding: 10px 15px;
    border-radius: 6px;
    font-size: 0.9rem;
    color: #e65100;
}

.result-item {
    padding: 10px 15px;
    margin-bottom: 10px;
    background: white;
    border-radius: 8px;
    border-left: 4px solid #ddd;
    cursor: pointer;
    transition: all 0.3s ease;
}

.result-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 10px rgba(0,0,0,0.1);
}

.result-item.error {
    border-left-color: var(--danger-color);
    background: rgba(247, 37, 133, 0.05);
}

.result-item.warning {
    border-left-color: var(--warning-color);
    background: rgba(255, 152, 0, 0.05);
}

.result-item.success {
    border-left-color: var(--success-color);
    background: rgba(76, 175, 80, 0.05);
}

.result-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.result-condition {
    font-weight: 500;
    color: var(--secondary-color);
}

.result-count {
    font-size: 0.9rem;
    color: #6c757d;
}

.result-details {
    font-size: 0.9rem;
    color: #495057;
    margin-top: 5px;
}

.status-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    text-align: center;
    min-width: 80px;
}

.status-valid {
    background: rgba(76, 175, 80, 0.1);
    color: var(--success-color);
    border: 1px solid rgba(76, 175, 80, 0.3);
}

.status-warning {
    background: rgba(255, 152, 0, 0.1);
    color: var(--warning-color);
    border: 1px solid rgba(255, 152, 0, 0.3);
}

.status-error {
    background: rgba(247, 37, 133, 0.1);
    color: var(--danger-color);
    border: 1px solid rgba(247, 37, 133, 0.3);
}

.status-info {
    background: rgba(67, 97, 238, 0.1);
    color: var(--primary-color);
    border: 1px solid rgba(67, 97, 238, 0.3);
}

/* สำหรับแถวที่ไม่มีข้อมูลวันที่ปลูก */
.checking-table tr.warning-row {
    background-color: rgba(255, 248, 225, 0.7) !important;
    border-left: 4px solid var(--warning-color) !important;
}

.checking-table tr.warning-row:hover td {
    background-color: rgba(255, 248, 225, 0.9) !important;
}
/* เพิ่มสไตล์สำหรับตารางโครงการ */
.checking-table tr.project-row-warning {
    background-color: rgba(255, 248, 225, 0.7) !important;
    border-left: 4px solid var(--warning-color) !important;
}

.checking-table tr.project-row-error {
    background-color: rgba(255, 235, 238, 0.7) !important;
    border-left: 4px solid var(--danger-color) !important;
}

.checking-table tr.project-row-success {
    background-color: rgba(232, 245, 233, 0.7) !important;
    border-left: 4px solid var(--success-color) !important;
}

/* สไตล์สำหรับเซลล์โครงการ */
.project-cell {
    position: relative;
}

.project-cell.not-in-project {
    color: #757575 !important;
    font-style: italic !important;
    background-color: #f5f5f5 !important;
}

.project-cell.applied {
    color: var(--success-color) !important;
    font-weight: bold !important;
    background-color: rgba(76, 175, 80, 0.1) !important;
}

.project-cell.error {
    color: var(--danger-color) !important;
    font-weight: bold !important;
    background-color: rgba(247, 37, 133, 0.1) !important;
    border: 1px solid var(--danger-color) !important;
}

/* Badge สถานะสำหรับโครงการ */
.status-not-in-project {
    background: rgba(117, 117, 117, 0.1) !important;
    color: #757575 !important;
    border: 1px solid rgba(117, 117, 117, 0.3) !important;
}        
        /* Step 5: Column Selection for Export */
        .export-column-selection {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .export-column-selection h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-column-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .export-column-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .export-column-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .export-column-item.selected {
            border-color: var(--success-color);
            background-color: rgba(76, 175, 80, 0.05);
        }
        
        .export-column-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .export-column-info {
            flex: 1;
        }
        
        .export-column-name {
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .export-column-type {
            font-size: 0.8rem;
            color: #666;
            background-color: #f0f0f0;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 30px;
            color: #666;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .step-navigation {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            
            .step {
                width: 100%;
                max-width: 300px;
            }
            
            .step-content {
                padding: 30px 20px;
            }
            
            .condition-buttons {
                grid-template-columns: 1fr 1fr;
            }
            
            .data-type-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .selection-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-container {
                min-width: 100%;
            }
            
            .columns-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .data-table-controls {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .checking-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .checking-info {
                min-width: 100%;
            }
            
            .checking-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .table-controls {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .panel-header h2 {
                font-size: 1.5rem;
            }
            
            .upload-area {
                padding: 40px 15px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .navigation-buttons button {
                width: 100%;
            }
            
            .columns-grid {
                grid-template-columns: 1fr;
            }
            
            .selected-summary {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .data-table-controls {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .table-info {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .table-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .config-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .btn-sm {
                width: 100%;
                justify-content: center;
            }
            
            .condition-buttons {
                grid-template-columns: 1fr;
            }
            
            .condition-select-btn {
                padding: 15px;
            }
            
            .checking-stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .checking-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .checking-actions button {
                width: 100%;
            }
        }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .rule-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            margin-right: 10px;
            background: #f0f4ff;
            border-radius: 50%;
            color: var(--primary-color);
        }
        
        .rule-name {
            display: flex;
            align-items: center;
        }/* ✅ Class สำหรับคอลัมน์ที่ตรึง */
.sticky-column {
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); /* เงาเพื่อแยกคอลัมน์ */
    transition: background-color 0.3s ease;
}

/* ✅ เมื่อเลื่อนแนวนอน ให้แสดงเงาเพิ่มเติม */
.checking-table-wrapper {
    scroll-behavior: smooth;
}

.checking-table-wrapper.scrolling {
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
}
     /* ✅ เพิ่มสไตล์สำหรับแถวข้อผิดพลาด */
.error-row {
    border-left: 4px solid var(--danger-color) !important;
    animation: pulseError 2s infinite;
}

.error-detail-row {
    border-left: 4px solid #ff9800 !important;
}

@keyframes pulseError {
    0% { background-color: rgba(255, 235, 238, 0.5); }
    50% { background-color: rgba(255, 235, 238, 0.8); }
    100% { background-color: rgba(255, 235, 238, 0.5); }
}

/* ✅ ปุ่มแสดงข้อผิดพลาดในสถานะ */
#dataStatus button {
    transition: all 0.3s ease;
}

#dataStatus button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* ✅ สไตล์สำหรับข้อความข้อผิดพลาด */
.cell-error {
    position: relative;
}

.cell-error:after {
    content: "!";
    position: absolute;
    top: 2px;
    right: 2px;
    width: 16px;
    height: 16px;
    background: var(--danger-color);
    color: white;
    border-radius: 50%;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    animation: pulseIcon 1.5s infinite;
}

@keyframes pulseIcon {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}   
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="loading-spinner"></div>
        <h3 style="color: var(--primary-color);">กำลังประมวลผล...</h3>
    
    </div>

    <div class="container">
        <header>
            <h1><i class="fas fa-seedling"></i> ระบบ Clean Data ตรวจสอบข้อมูลไฟล์ KAT</h1>
            <p class="subtitle">ขั้นตอนการใช้งาน</p>
        </header>
        
        <div class="step-navigation">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-info">
                    <div class="step-title">อัปโหลดไฟล์ CSV</div>
                    <div class="step-description">อัปโหลดไฟล์ข้อมูลอ้อยของคุณ</div>
                </div>
            </div>
            
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-info">
                    <div class="step-title">เลือกคอลัมน์ที่ต้องการ</div>
                    <div class="step-description">ค้นหาและเลือกคอลัมน์ที่ต้องการตรวจสอบ</div>
                </div>
            </div>
            
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-info">
                    <div class="step-title">ตรวจสอบและแก้ไขข้อมูล</div>
                    <div class="step-description">ตรวจสอบและแก้ไขข้อมูลที่เลือก</div>
                </div>
            </div>
            
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div class="step-info">
                    <div class="step-title">ตรวจสอบเงื่อนไข</div>
                    <div class="step-description">ตรวจสอบเงื่อนไขเฉพาะข้อมูลอ้อย</div>
                </div>
            </div>
            
            <div class="step" id="step5">
                <div class="step-number">5</div>
                <div class="step-info">
                    <div class="step-title">เลือกคอลัมน์สำหรับส่งออก</div>
                    <div class="step-description">เลือกคอลัมน์ที่ต้องการส่งออก</div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Summary -->
        <div class="dashboard-summary" id="dashboardSummary" style="display: none;">
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="summary-content">
                        <h4>ข้อมูลถูกต้อง</h4>
                        <div class="summary-value" id="correctDataPercent">0%</div>
                        <div class="summary-progress">
                            <div class="progress-bar">
                                <div class="progress-fill success" id="correctDataBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon warning">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="summary-content">
                        <h4>ต้องตรวจสอบ</h4>
                        <div class="summary-value" id="needReviewCount">0</div>
                        <button class="btn btn-sm btn-outline" id="showReviewBtn" style="margin-top: 5px; display: none;">
                            <i class="fas fa-eye"></i> แสดง
                        </button>
                        <div class="summary-progress">
                            <div class="progress-bar">
                                <div class="progress-fill warning" id="needReviewBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon error">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="summary-content">
                        <h4>ข้อผิดพลาด</h4>
                        <div class="summary-value" id="errorDataCount">0</div>
                        <div class="progress-bar">
                            <div class="progress-fill error" id="errorDataBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon info">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="summary-content">
                        <h4>แก้ไขแล้ว</h4>
                        <div class="summary-value" id="editedCellsCount">0</div>
                        <div class="progress-bar">
                            <div class="progress-fill info" id="editedCellsBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="summary-actions">
                <button class="btn btn-primary btn-sm" id="refreshDashboard">
                    <i class="fas fa-sync-alt"></i> อัพเดต Dashboard
                </button>
                <button class="btn btn-success btn-sm" id="fixAllErrors">
                    <i class="fas fa-robot"></i> AI แก้ไขข้อผิดพลาดทั้งหมด
                </button>
            </div>
        </div>
        
        <div class="step-content">
            <!-- Step 1: Upload CSV File - UPDATED DESIGN -->
            <div class="step-panel active" id="panel1">
                <div class="panel-header">
                    <h2><i class="fas fa-robot"></i> อัปโหลดและกรองข้อมูลอัตโนมัติ</h2>
                    <p>ระบบ Advanced Validation จะทำการตรวจสอบและกรองข้อมูลอัตโนมัติตามเงื่อนไข</p>
                    <div style="background: #e3f2fd; color: #0d47a1; padding: 8px 20px; border-radius: 20px; font-size: 0.9rem; font-weight: 500; display: inline-block; margin-top: 10px;">
                        <i class="fas fa-shield-alt"></i> Auto-Clean Logic Active
                    </div>
                </div>
                
                <div class="upload-area" id="dropZone">
                    <i class="fas fa-cloud-upload-alt fa-3x" style="color:var(--primary-color); margin-bottom:15px;"></i>
                    <h3>ลากไฟล์ CSV มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์</h3>
                    <p style="color: #888;">รองรับเฉพาะไฟล์ .csv เท่านั้น</p>
                    <input type="file" id="fileInput" accept=".csv" style="display: none;">
                </div>

                <div id="fileInfo" style="display: none; margin-top: 30px;">
                    <!-- File Meta Card -->
                    <div class="file-meta-card">
                        <div class="meta-item">
                            <span class="meta-label"><i class="far fa-file"></i> ชื่อไฟล์</span>
                            <span class="meta-value" id="metaFileName">-</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label"><i class="far fa-hdd"></i> ขนาดไฟล์</span>
                            <span class="meta-value" id="metaFileSize">-</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label"><i class="fas fa-columns"></i> จำนวนคอลัมน์</span>
                            <span class="meta-value" id="metaColCount">-</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label"><i class="far fa-clock"></i> เวลาที่ประมวลผล</span>
                            <span class="meta-value" id="metaProcessTime">-</span>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">ข้อมูลต้นฉบับ</div>
                            <div class="stat-value" id="statTotal">-</div>
                        </div>
                        <div class="stat-card" style="border-bottom-color: var(--success-color);">
                            <div class="stat-label">คงเหลือ</div>
                            <div class="stat-value" id="statPass" style="color: var(--success-color);">-</div>
                        </div>
                        <div class="stat-card" style="border-bottom-color: var(--danger-color);">
                            <div class="stat-label">ถูกตัดออก</div>
                            <div class="stat-value" id="statRemoved" style="color: var(--danger-color);">-</div>
                        </div>
                    </div>

                    <!-- Report Container -->
                    <div class="report-container">
                        <div class="report-header">
                            <span><i class="fas fa-list-alt"></i> สรุปการทำงาน (Auto-Clean Logic)</span>
                        </div>
                        <div id="detailedReportList"></div>
                    </div>
                    
                    <div class="navigation-buttons">
                        <div></div>
                        <button class="btn btn-success" id="nextToStep2" disabled>
                            ต่อไป <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Column Selection -->
            <div class="step-panel" id="panel2">
                <div class="panel-header">
                    <h2><i class="fas fa-columns"></i> เลือกคอลัมน์ที่ต้องการตรวจสอบ</h2>
                    <p>ค้นหาและเลือกคอลัมน์ที่ต้องการตรวจสอบจากทั้งหมด <span id="totalColumns">0</span> คอลัมน์</p>
                </div>
                
                <div class="column-selection-panel">
                    <div class="selection-header">
                        <div class="search-container">
                            <input type="text" id="columnSearch" class="search-box" placeholder="ค้นหาคอลัมน์...">
                        </div>
                        <div class="search-stats">
                            <span>พบ <span id="filteredCount">0</span> คอลัมน์</span>
                            <span>เลือกแล้ว <span id="selectedCount">0</span> คอลัมน์</span>
                        </div>
                    </div>
                    
                    <div class="selection-controls">
                        <button class="selection-btn active" data-filter="all">ทั้งหมด</button>
                        <button class="selection-btn" data-filter="sugarcane">ข้อมูลอ้อย</button>
                        <button class="selection-btn" data-filter="activity">กิจกรรมงวด</button>
                        <button class="selection-btn" data-filter="project">โครงการ</button>
                        <button class="selection-btn" data-filter="fertilizer">ปุ๋ย</button>
                        <button class="selection-btn" data-filter="selected">ที่เลือกแล้ว</button>
                        <button class="selection-btn" data-filter="unselected">ยังไม่เลือก</button>
                    </div>
                    
                    <div class="columns-grid" id="columnsGrid">
                        <!-- Column items will be populated here -->
                    </div>
                    
                    <div class="selected-summary">
                        <div>
                            <h4><i class="fas fa-check-circle"></i> คุณเลือกคอลัมน์แล้ว <span id="selectedSummaryCount">0</span> คอลัมน์</h4>
                            <p id="selectedColumnsList" style="font-size: 0.9rem; color: #666; margin-top: 5px;">ยังไม่ได้เลือกคอลัมน์</p>
                        </div>
                        <div>
                            <button class="btn btn-outline" id="selectAllBtn">
                                <i class="fas fa-check-double"></i> เลือกทั้งหมด
                            </button>
                            <button class="btn btn-outline" id="deselectAllBtn">
                                <i class="fas fa-times"></i> ยกเลิกทั้งหมด
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep1">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="nextToStep3" disabled>
                        ต่อไป <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Data Validation and Editing -->
            <div class="step-panel" id="panel3">
                <div class="panel-header">
                    <h2><i class="fas fa-search"></i> ตรวจสอบและแก้ไขข้อมูล</h2>
                    <p>AI ช่วยตรวจสอบข้อมูลและแสดงผลลัพธ์ คลิกที่เซลล์สีแดงเพื่อแก้ไขได้ทันที</p>
                </div>
                
                <!-- Data Type Configuration -->
                <div class="data-type-configuration" id="dataTypeConfig">
                    <h3><i class="fas fa-cogs"></i> กำหนดประเภทข้อมูลให้แต่ละคอลัมน์</h3>
                    <div class="config-controls">
                        <button class="btn btn-outline btn-sm" id="autoDetectTypes">
                            <i class="fas fa-robot"></i> ตรวจจับประเภทอัตโนมัติ
                        </button>
                        <button class="btn btn-success btn-sm" id="applyDataTypes">
                            <i class="fas fa-check"></i> ใช้การตั้งค่านี้
                        </button>
                    </div>
                    <div class="data-type-table-container">
                        <table class="data-type-table" id="dataTypeTable">
                            <thead>
                                <tr>
                                    <th>คอลัมน์</th>
                                    <th>ตัวอย่างข้อมูล</th>
                                    <th>ประเภทข้อมูล</th>
                                    <th>รูปแบบ</th>
                                    <th>หน่วย</th>
                                    <th>คำอธิบาย</th>
                                </tr>
                            </thead>
                            <tbody id="dataTypeTableBody">
                                <!-- จะถูกเพิ่มโดย JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Data Preview Table -->
                <div class="data-table-controls">
                    <div class="table-info">
                        <span><i class="fas fa-table"></i> แสดง <span id="currentRows">0</span>/<span id="totalRows">0</span> แถว</span>
                        <span><i class="fas fa-columns"></i> <span id="currentColumns">0</span> คอลัมน์</span>
                        <span id="dataStatus"></span>
                    </div>
                    
                    <div class="table-actions">
                        <button class="btn btn-outline btn-sm" id="toggleAllRows">
                            <i class="fas fa-expand"></i> แสดงทั้งหมด (<span id="totalRowCount">0</span>)
                        </button>
                        <button class="btn btn-outline btn-sm" id="exportTable">
                            <i class="fas fa-download"></i> ส่งออกตาราง
                        </button>
                        <button class="btn btn-outline btn-sm" id="showDataTypeConfig">
                            <i class="fas fa-cog"></i> กำหนดประเภทข้อมูล
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <table class="data-table" id="dataPreviewTable">
                        <thead id="dataTableHeader">
                            <!-- Headers will be populated by JavaScript -->
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="cell-editor-modal" id="cellEditorModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4><i class="fas fa-edit"></i> แก้ไขข้อมูลเซลล์</h4>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="cell-info">
                                <p><strong>คอลัมน์:</strong> <span id="editColumnName">-</span></p>
                                <p><strong>แถวที่:</strong> <span id="editRowNumber">-</span></p>
                                <p><strong>ประเภทข้อมูล:</strong> 
                                    <select id="editDataTypeSelect" class="form-control" style="width: auto; display: inline-block; margin-left: 10px;">
                                        <option value="text">ข้อความ</option>
                                        <option value="number">ตัวเลข</option>
                                        <option value="date">วันที่</option>
                                        <option value="enum">ค่าที่กำหนด</option>
                                        <option value="identifier">รหัส</option>
                                    </select>
                                </p>
                                <p><strong>ปัญหาที่พบ:</strong> <span id="editIssue" class="error-text">-</span></p>
                            </div>
                            
                            <div class="form-group">
                                <label for="cellValueInput">ค่าใหม่:</label>
                                <input type="text" id="cellValueInput" class="form-control" placeholder="ป้อนค่าใหม่...">
                                <div class="suggestions" id="valueSuggestions">
                                    <!-- Suggestions will be added here -->
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="correctionReason">เหตุผลในการแก้ไข:</label>
                                <select id="correctionReason" class="form-control">
                                    <option value="">เลือกเหตุผล</option>
                                    <option value="format_error">รูปแบบไม่ถูกต้อง</option>
                                    <option value="invalid_value">ค่าที่ใช้ไม่ได้</option>
                                    <option value="out_of_range">ไม่อยู่ในช่วงที่กำหนด</option>
                                    <option value="typo_error">พิมพ์ผิด</option>
                                    <option value="other">อื่นๆ</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" id="cancelEdit">ยกเลิก</button>
                            <button class="btn btn-success" id="saveEdit">บันทึกการแก้ไข</button>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep2">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="nextToStep4" disabled>
                        <i class="fas fa-arrow-right"></i> ดำเนินการต่อ
                    </button>
                </div>
            </div>
            
            <!-- Step 4: Condition Checking -->
            <div class="step-panel" id="panel4">
                <div class="panel-header">
                    <h2><i class="fas fa-search"></i> ตรวจสอบเงื่อนไขข้อมูลอ้อย</h2>
                    <p>เลือกเงื่อนไขที่ต้องการตรวจสอบ และดูผลการตรวจสอบในตารางด้านล่าง</p>
                </div>
                
               <!-- ในขั้นตอนที่ 4: เพิ่มปุ่มเลือกเงื่อนไข "โครงการ" -->
<div class="condition-buttons">
    <button class="condition-select-btn active" data-condition="sugarcane">
        <i class="fas fa-seedling"></i> ประเภทอ้อย
        <span class="condition-desc">(ต้องมีคอลัมน์: ชื่อประเภทอ้อย, วันที่ปลูก)</span>
    </button>
    <button class="condition-select-btn" data-condition="fertilizer">
        <i class="fas fa-prescription-bottle"></i> ปุ๋ย
        <span class="condition-desc">(ต้องมีคอลัมน์ที่เกี่ยวข้องกับปุ๋ย)</span>
    </button>
    <!-- เพิ่มปุ่มตรวจสอบโครงการ -->
    <button class="condition-select-btn" data-condition="project">
        <i class="fas fa-project-diagram"></i> โครงการ
        <span class="condition-desc">(ตรวจสอบโครงการซ้ำและเงื่อนไขพิเศษ)</span>
    </button>
</div>
                
                <!-- ข้อมูลการตรวจสอบ -->
                <div class="checking-controls">
                    <div class="checking-info">
                        <h4><i class="fas fa-info-circle"></i> สถานะการตรวจสอบ</h4>
                        <div class="checking-stats">
                            <span>เงื่อนไขที่เลือก: <strong id="selectedCondition">ประเภทอ้อย</strong></span>
                            <span>ตรวจพบ: <strong id="foundIssues">0</strong> ปัญหา</span>
                            <span>ผ่าน: <strong id="passedChecks">0</strong> รายการ</span>
                            <span>ไม่ผ่าน: <strong id="failedChecks">0</strong> รายการ</span>
                            <span>แสดง: <strong id="checkingRowsCount">0</strong> แถวทั้งหมด</span>
                        </div>
                    </div>
                    <div class="checking-actions">
                        <button class="btn btn-primary" id="runSelectedCheck">
                            <i class="fas fa-play"></i> เริ่มตรวจสอบเงื่อนไขที่เลือก
                        </button>
                        <button class="btn btn-success" id="runAllChecks">
                            <i class="fas fa-play-circle"></i> ตรวจสอบเงื่อนไขทั้งหมด
                        </button>
                        <button class="btn btn-outline" id="exportCheckResults">
                            <i class="fas fa-download"></i> ส่งออกผลตรวจสอบ
                        </button>
                    </div>
                </div>
                
                <!-- ตารางแสดงข้อมูลและผลตรวจสอบ -->
                <div class="checking-table-container">
                    <div class="table-controls">
                        <div class="table-info">
                            <span><i class="fas fa-table"></i> ตารางผลการตรวจสอบเงื่อนไข</span>
                            <span id="scrollHint" style="color: var(--accent-color); font-size: 0.9rem; margin-left: 15px;">
                                <i class="fas fa-arrow-right"></i> เลื่อนเพื่อดูสถานะและหมายเหตุ
                            </span>
                        </div>
                        <div class="table-actions">
                            <!-- ... -->
                        </div>
                    </div>
                    
                    <div class="checking-table-wrapper">
                        <table class="checking-table" id="checkingTable">
                            <thead id="checkingTableHeader">
                                <!-- Headers will be populated by JavaScript based on condition -->
                            </thead>
                            <tbody id="checkingTableBody">
                                <!-- ข้อมูลจะถูกเพิ่มโดย JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- รายละเอียดการตรวจสอบ -->
                <div class="checking-details">
                    <h4><i class="fas fa-list-alt"></i> รายละเอียดผลการตรวจสอบ</h4>
                    <div class="checking-results" id="checkingResults">
                        <div class="result-summary">
                            <p><i class="fas fa-info-circle"></i> กดปุ่มด้านบนเพื่อเริ่มตรวจสอบเงื่อนไข</p>
                            <p class="result-note">เงื่อนไข "ประเภทอ้อย" ต้องการคอลัมน์: <strong>ชื่อประเภทอ้อย</strong> และ <strong>วันที่ปลูก</strong></p>
                            <p class="result-note" style="background: #e8f5e9; color: #2e7d32; margin-top: 10px;">
                                <i class="fas fa-info-circle"></i> วันที่ปลูกที่รองรับ: YYYY/MM/DD, YYYY/M/D, YYYY-MM-DD, DD/MM/YYYY
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep3">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="nextToStep5">
                        <i class="fas fa-arrow-right"></i> ดำเนินการต่อ
                    </button>
                </div>
            </div>
            
            <!-- Step 5: Column Selection for Export -->
            <div class="step-panel" id="panel5">
                <div class="panel-header">
                    <h2><i class="fas fa-download"></i> เลือกคอลัมน์สำหรับส่งออก</h2>
                    <p>เลือกคอลัมน์ที่ต้องการส่งออกหลังจากผ่านการตรวจสอบทั้งหมดแล้ว</p>
                </div>
                
                <div class="export-column-selection">
                    <h3><i class="fas fa-check-circle"></i> เลือกคอลัมน์ที่ต้องการส่งออก</h3>
                    <p>ระบบได้เลือกคอลัมน์พื้นฐานที่จำเป็นให้อัตโนมัติแล้ว คุณสามารถเพิ่ม/ลดคอลัมน์อื่นๆ ได้ตามต้องการ</p>
                    
                    <div class="selection-controls">
                        <button class="selection-btn active" data-filter="all">ทั้งหมด</button>
                        <button class="selection-btn" data-filter="recommended">แนะนำ</button>
                        <button class="selection-btn" data-filter="selected">ที่เลือกแล้ว</button>
                        <button class="selection-btn" data-filter="unselected">ยังไม่เลือก</button>
                    </div>
                    
                    <div class="export-column-list" id="exportColumnsGrid">
                        <!-- Column items will be populated here -->
                    </div>
                    
                    <div class="selected-summary">
                        <div>
                            <h4><i class="fas fa-check-circle"></i> คุณเลือกคอลัมน์แล้ว <span id="exportSelectedCount">0</span> คอลัมน์</h4>
                            <p id="exportColumnsList" style="font-size: 0.9rem; color: #666; margin-top: 5px;">ยังไม่ได้เลือกคอลัมน์</p>
                        </div>
                        <div>
                            <button class="btn btn-outline" id="exportSelectAllBtn">
                                <i class="fas fa-check-double"></i> เลือกทั้งหมด
                            </button>
                            <button class="btn btn-outline" id="exportDeselectAllBtn">
                                <i class="fas fa-times"></i> ยกเลิกทั้งหมด
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep4">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="downloadCleanData">
                        <i class="fas fa-download"></i> ดาวน์โหลดข้อมูลที่ Clean แล้ว
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal สำหรับ AI Fix -->
        <div class="modal" id="aiFixModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-robot"></i> AI ช่วยแก้ไขข้อมูล</h3>
                    <button class="close-modal" id="closeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>ระบบกำลังวิเคราะห์และแก้ไขข้อมูลที่ไม่ถูกต้องอัตโนมัติ...</p>
                    <div id="aiFixProgress">
                        <div class="spinner" style="margin: 20px auto;"></div>
                        <p id="aiFixStatus" style="text-align: center;">กำลังประมวลผล...</p>
                    </div>
                    <div id="aiFixResults" style="display: none;">
                        <h4>ผลการแก้ไข</h4>
                        <ul id="fixResultsList">
                            <!-- Results will be added here -->
                        </ul>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-outline" id="cancelAiFix">ยกเลิก</button>
                    <button class="btn btn-success" id="applyAiFix" style="display: none;">นำการแก้ไขไปใช้</button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2023 ระบบ Clean Data สำหรับข้อมูลอ้อย - ตรวจสอบประเภทข้อมูลและเงื่อนไขครบวงจร</p>
        </footer>
    </div>

    <script>
        // --- DATA VALIDATION CONFIGURATION ---
        const ALLOWED_CANE_TYPES = [
            "ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ตอ1", "ตอ2", "ตอ3",
            "ต้นฝนขยาย", "ต้นฝนรื้อตอ", "พื้นที่เสียหาย", ">ตอ3"
        ];

        const THAI_LOCATIONS = {
            "นครราชสีมา": ["เมืองนครราชสีมา", "ครบุรี", "เสิงสาง", "คง", "บ้านเหลื่อม", "จักราช", "โชคชัย", "ด่านขุนทด", "โนนไทย", "โนนสูง", "ขามสะแกแสง", "บัวใหญ่", "ประทาย", "ปักธงชัย", "พิมาย", "ห้วยแถลง", "ชุมพวง", "สูงเนิน", "ขามทะเลสอ", "สีคิ้ว", "ปากช่อง", "หนองบุญมาก", "หนองบุนนาก", "แก้งสนามนาง", "โนนแดง", "วังน้ำเขียว", "เทพารักษ์", "เมืองยาง", "พระทองคำ", "ลำทะเมนชัย", "บัวลาย", "สีดา", "เฉลิมพระเกียรติ"],
            "ขอนแก่น": ["เมืองขอนแก่น", "บ้านฝาง", "พระยืน", "หนองเรือ", "ชุมแพ", "สีชมพู", "น้ำพอง", "อุบลรัตน์", "กระนวน", "บ้านไผ่", "เปือยน้อย", "เมืองพล", "แวงใหญ่", "แวงน้อย", "หนองสองห้อง", "ภูเวียง", "มัญจาคีรี", "ชนบท", "เขาสวนกวาง", "ภูผาม่าน", "ซำสูง", "โคกโพธิ์ไชย", "หนองนาคำ", "บ้านแฮด", "โนนศิลา", "เวียงเก่า"],
            "อุดรธานี": ["เมืองอุดรธานี", "กุดจับ", "หนองวัวซอ", "กุมภวาปี", "โนนสะอาด", "หนองหาน", "ทุ่งฝน", "ไชยวาน", "ศรีธาตุ", "วังสามหมอ", "บ้านดุง", "บ้านผือ", "น้ำโสม", "เพ็ญ", "สร้างคอม", "หนองแสง", "นายูง", "พิบูลย์รักษ์", "กู่แก้ว", "ประจักษ์ศิลปาคม"],
            "ชัยภูมิ": ["เมืองชัยภูมิ", "บ้านเขว้า", "คอนสวรรค์", "เกษตรสมบูรณ์", "หนองบัวแดง", "จัตุรัส", "บำเหน็จณรงค์", "หนองบัวระเหว", "เทพสถิต", "ภูเขียว", "บ้านแท่น", "แก้งคร้อ", "คอนสาร", "ภักดีชุมพล", "เนินสง่า", "ซับใหญ่"],
            "บุรีรัมย์": ["เมืองบุรีรัมย์", "คูเมือง", "กระสัง", "นางรอง", "หนองกี่", "ละหานทราย", "ประโคนชัย", "บ้านกรวด", "พุทไธสง", "ลำปลายมาศ", "สตึก", "ปะคำ", "นาโพธิ์", "หนองหงส์", "พลับพลาชัย", "ห้วยราช", "โนนสุวรรณ", "ชำนิ", "บ้านใหม่ไชยพจน์", "โนนดินแดง", "บ้านด่าน", "แคนดง", "เฉลิมพระเกียรติ"],
            "กาฬสินธุ์": ["เมืองกาฬสินธุ์", "นามน", "กมลาไสย", "ร่องคำ", "กุฉินารายณ์", "เขาวง", "ยางตลาด", "ห้วยเม็ก", "สหัสขันธ์", "คำม่วง", "ท่าคันโท", "หนองกุงศรี", "สมเด็จ", "ห้วยผึ้ง", "สามชัย", "นาคู", "ดอนจาน", "ฆ้องชัย"],
            "มหาสารคาม": ["เมืองมหาสารคาม", "แกดำ", "โกสุมพิสัย", "กันทรวิชัย", "เชียงยืน", "บรบือ", "นาเชือก", "พยัคฆภูมิพิสัย", "วาปีปทุม", "นาดูน", "ยางสีสุราช", "กุดรัง", "ชื่นชม"],
            "ร้อยเอ็ด": ["เมืองร้อยเอ็ด", "เกษตรวิสัย", "ปทุมรัตต์", "จตุรพักตรพิมาน", "ธวัชบุรี", "พนมไพร", "โพนทอง", "โพธิ์ชัย", "หนองพอก", "เสลภูมิ", "สุวรรณภูมิ", "เมืองสรวง", "โพนทราย", "อาจสามารถ", "เมยวดี", "ศรีสมเด็จ", "จังหาร", "เชียงขวัญ", "หนองฮี", "ทุ่งเขาหลวง"]
        };

        // ข้อมูลสำหรับการตรวจสอบ - แก้ไขตามเงื่อนไขใหม่
        const sugarcaneNumbers = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];
        
        const fertilizerTypes = ["ปุ๋ยเคมี", "ปุ๋ยอินทรีย์", "ปุ๋ยชีวภาพ", "ปุ๋ยหมัก", "ปุ๋ยคอก"];

        // ✅ เพิ่ม: ประเภทการใส่ปุ๋ยตามเงื่อนไขใหม่
        const fertilizerConditions = {
            // อ้อยปลูกใหม่
            "ปลายฝนขยาย": {
                period1: { minAge: 1, maxAge: 60, expected: "รองพื้น", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 3" }
            },
            "ปลายฝนรื้อตอ": {
                period1: { minAge: 1, maxAge: 60, expected: "รองพื้น", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 3" }
            },
            "ต้นฝนขยาย": {
                period1: { minAge: 1, maxAge: 60, expected: "รองพื้น", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 3" }
            },
            "ต้นฝนรื้อตอ": {
                period1: { minAge: 1, maxAge: 60, expected: "รองพื้น", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 3" }
            },
            // อ้อยตอ
            "ตอ1": {
                period1: { minAge: 1, maxAge: 60, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่3", periodName: "งวด 3" }
            },
            "ตอ2": {
                period1: { minAge: 1, maxAge: 60, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่3", periodName: "งวด 3" }
            },
            "ตอ3": {
                period1: { minAge: 1, maxAge: 60, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่3", periodName: "งวด 3" }
            },
            ">ตอ3": {
                period1: { minAge: 1, maxAge: 60, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 1" },
                period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 2" },
                period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่3", periodName: "งวด 3" }
            }
        };

        // ✅ เพิ่ม: ฟังก์ชันตรวจสอบว่าประเภทอ้อยอยู่ในกลุ่มใด
        function getSugarcaneGroup(sugarcaneType) {
            const newPlantingTypes = ["ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ต้นฝนขยาย", "ต้นฝนรื้อตอ"];
            const ratoonTypes = ["ตอ1", "ตอ2", "ตอ3", ">ตอ3"];
            
            const normalizedType = sugarcaneType.trim();
            
            if (newPlantingTypes.includes(normalizedType)) {
                return "new";
            } else if (ratoonTypes.includes(normalizedType)) {
                return "ratoon";
            } else {
                return "unknown";
            }
        }

        // ✅ เพิ่ม: ฟังก์ชันตรวจสอบว่าอายุอยู่ในช่วงที่กำหนดหรือไม่
        function checkAgeRange(age, minAge, maxAge) {
            if (!age || age.trim() === "") return false;
            
            const ageNum = parseInt(age);
            if (isNaN(ageNum)) return false;
            
            return ageNum >= minAge && ageNum <= maxAge;
        }
        
        // ประเภทข้อมูลที่รองรับ
        const dataTypes = ["text", "number", "date", "enum", "identifier"];
        const dataTypeDisplayNames = {
            "text": "Text (ข้อความ)",
            "number": "Number (ตัวเลข)", 
            "date": "Date (วันที่)",
            "enum": "Enum (ค่าเฉพาะ)",
            "identifier": "Identifier (ตัวระบุ)"
        };
        
        // คอลัมน์ที่ต้องการเลือกอัตโนมัติสำหรับขั้นตอนที่ 5
        const autoExportColumns = [
            "โซน", "รหัสนักเกษตร", "ชื่อนักเกษตร", "ชื่อประเภทอ้อย", 
            "พื้นที่", "เลขโควต้า", "ชื่อชาวไร่", "เลขแปลงintech"
        ];
        
        // ตัวแปรเก็บข้อมูล
        let uploadedData = null;
        let allColumns = [];
        let selectedColumns = [];
        let exportColumns = []; // สำหรับขั้นตอนที่ 5
        let dataTypeConfigurations = {};
        let currentStep = 1;
        let currentFilter = "all";
        let currentColumnFilter = "all";
        let currentSort = { column: "column", direction: "asc" };
        let editedCells = {}; // เก็บข้อมูลเซลล์ที่แก้ไข
        
        // สำหรับ Dashboard และ Data Table
        let currentValidationResults = {};
        let cellValidationStatus = {};
        let editingCell = null;
        let totalCells = 0;
        
        // ตัวแปรเพิ่มเติมสำหรับฟังก์ชันใหม่
        let userSelectedDataTypes = {};
        let isShowingAllRows = false;
        let currentRowLimit = 50;
        let dataTypeConfigVisible = false;
        
        // ตัวแปรสำหรับระบบตรวจสอบเงื่อนไข
        let currentCondition = "sugarcane";
        let conditionResults = {};
        let checkingTableData = [];
        let showOnlyFailed = false;
        
        // สำหรับระบบ Advanced Validation
        let appData = { fileName: '', headers: [], data: [], removedStats: {}, rowMeta: [] };
        
        // อ้างอิงองค์ประกอบ DOM
        const csvFileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('dropZone');
        const fileInfo = document.getElementById('fileInfo');
        const metaFileName = document.getElementById('metaFileName');
        const metaFileSize = document.getElementById('metaFileSize');
        const metaColCount = document.getElementById('metaColCount');
        const metaProcessTime = document.getElementById('metaProcessTime');
        const statTotal = document.getElementById('statTotal');
        const statPass = document.getElementById('statPass');
        const statRemoved = document.getElementById('statRemoved');
        const detailedReportList = document.getElementById('detailedReportList');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Step navigation
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const step5 = document.getElementById('step5');
        
        // Panels
        const panel1 = document.getElementById('panel1');
        const panel2 = document.getElementById('panel2');
        const panel3 = document.getElementById('panel3');
        const panel4 = document.getElementById('panel4');
        const panel5 = document.getElementById('panel5');
        
        // Navigation buttons
        const nextToStep2 = document.getElementById('nextToStep2');
        const nextToStep3 = document.getElementById('nextToStep3');
        const nextToStep4 = document.getElementById('nextToStep4');
        const nextToStep5 = document.getElementById('nextToStep5');
        const backToStep1 = document.getElementById('backToStep1');
        const backToStep2 = document.getElementById('backToStep2');
        const backToStep3 = document.getElementById('backToStep3');
        const backToStep4 = document.getElementById('backToStep4');
        const downloadCleanData = document.getElementById('downloadCleanData');
        
        // Column selection elements
        const totalColumns = document.getElementById('totalColumns');
        const filteredCount = document.getElementById('filteredCount');
        const selectedCount = document.getElementById('selectedCount');
        const selectedSummaryCount = document.getElementById('selectedSummaryCount');
        const selectedColumnsList = document.getElementById('selectedColumnsList');
        const columnSearch = document.getElementById('columnSearch');
        const columnsGrid = document.getElementById('columnsGrid');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const columnFilterButtons = document.querySelectorAll('.selection-btn');
        
        // Dashboard elements
        const dashboardSummary = document.getElementById('dashboardSummary');
        const correctDataPercent = document.getElementById('correctDataPercent');
        const needReviewCount = document.getElementById('needReviewCount');
        const errorDataCount = document.getElementById('errorDataCount');
        const editedCellsCount = document.getElementById('editedCellsCount');
        const correctDataBar = document.getElementById('correctDataBar');
        const needReviewBar = document.getElementById('needReviewBar');
        const errorDataBar = document.getElementById('errorDataBar');
        const editedCellsBar = document.getElementById('editedCellsBar');
        const refreshDashboard = document.getElementById('refreshDashboard');
        const fixAllErrors = document.getElementById('fixAllErrors');
        const showReviewBtn = document.getElementById('showReviewBtn');
        
        // Data Table elements
        const dataTableHeader = document.getElementById('dataTableHeader');
        const dataTableBody = document.getElementById('dataTableBody');
        const cellEditorModal = document.getElementById('cellEditorModal');
        const editColumnName = document.getElementById('editColumnName');
        const editRowNumber = document.getElementById('editRowNumber');
        const editDataType = document.getElementById('editDataType');
        const editIssue = document.getElementById('editIssue');
        const cellValueInput = document.getElementById('cellValueInput');
        const valueSuggestions = document.getElementById('valueSuggestions');
        const saveEdit = document.getElementById('saveEdit');
        const cancelEdit = document.getElementById('cancelEdit');
        const closeModal = document.querySelector('.close-modal');
        const dataStatus = document.getElementById('dataStatus');
        const showAllRows = document.getElementById('toggleAllRows');
        const exportTable = document.getElementById('exportTable');
        const currentRows = document.getElementById('currentRows');
        const totalRows = document.getElementById('totalRows');
        const currentColumns = document.getElementById('currentColumns');
        const totalRowCount = document.getElementById('totalRowCount');
        
        // Data Type Configuration elements
        const dataTypeConfig = document.getElementById('dataTypeConfig');
        const dataTypeTableBody = document.getElementById('dataTypeTableBody');
        const autoDetectTypes = document.getElementById('autoDetectTypes');
        const applyDataTypes = document.getElementById('applyDataTypes');
        const showDataTypeConfig = document.getElementById('showDataTypeConfig');
        const editDataTypeSelect = document.getElementById('editDataTypeSelect');
        
        // Step 4 elements
        const runSelectedCheck = document.getElementById('runSelectedCheck');
        const runAllChecks = document.getElementById('runAllChecks');
        const exportCheckResults = document.getElementById('exportCheckResults');
        const checkingRowsCount = document.getElementById('checkingRowsCount');
        const showOnlyFailedBtn = document.getElementById('showOnlyFailed');
        const showAllResultsBtn = document.getElementById('showAllResults');
        const checkingTableHeader = document.getElementById('checkingTableHeader');
        const foundIssues = document.getElementById('foundIssues');
        const passedChecks = document.getElementById('passedChecks');
        const failedChecks = document.getElementById('failedChecks');
        
        // Step 5 elements
        const exportColumnsGrid = document.getElementById('exportColumnsGrid');
        const exportSelectedCount = document.getElementById('exportSelectedCount');
        const exportColumnsList = document.getElementById('exportColumnsList');
        const exportSelectAllBtn = document.getElementById('exportSelectAllBtn');
        const exportDeselectAllBtn = document.getElementById('exportDeselectAllBtn');
        
        // ============================================
        // ขั้นตอนที่ 1: อัปโหลดไฟล์ CSV - ADVANCED VALIDATION
        // ============================================
        // --- LOGIC REV.17 ---
        function runRev17Detailed(rawRows) {
            const headers = rawRows[0];
            const find = (n) => headers.findIndex(h => h.trim() === n);
            const idx = {
                quota: find("เลขโควต้า"), caneType: find("ชื่อประเภทอ้อย"), plotType: find("ประเภทแปลง"),
                zone: find("โซน"), dmgCause: find("สาเหตุเสียหาย"), dmgArea: find("พื้นที่เสียหาย"),
                farmerId: find("รหัสนักเกษตร"), area: find("พื้นที่"), netArea: find("พื้นที่สุทธิ"), intech: find("เลขแปลงintech")
            };
            let stats = { removedQuota: 0, removedCaneType: 0, removedPlotType: 0, fixedZone: 0, fixedId: 0, removedNetArea: 0, removedIntech: 0, cleanedEquals: 0 };
            let cleaned = [];
            let rowMetaList = [];

            for (let i = 1; i < rawRows.length; i++) {
                let row = [...rawRows[i]];
                if (!row[0] && row.length <= 1) continue; // Skip empty rows

                let isModified = false;
                
                if (idx.quota !== -1) { 
                    const val = String(row[idx.quota]).trim();
                    if (val === '59008956' || val === '40000542') { stats.removedQuota++; continue; } 
                }
                if (idx.caneType !== -1 && String(row[idx.caneType]).includes('พื้นที่เสียหาย')) { stats.removedCaneType++; continue; }
                if (idx.plotType !== -1 && String(row[idx.plotType]).includes('แปลงดัมมี่')) { stats.removedPlotType++; continue; }

                if (idx.zone !== -1) {
                    let z = String(row[idx.zone]).trim();
                    if (z === 'C1/1') { row[idx.zone] = 'C1'; stats.fixedZone++; isModified = true; }
                    else if (z === 'C4/1') { row[idx.zone] = 'C4'; stats.fixedZone++; isModified = true; }
                }

                if (idx.dmgCause !== -1) {
                    let c = String(row[idx.dmgCause]).trim();
                    if (c === '-' || /^\d+$/.test(c) || c === '') { 
                        row[idx.dmgCause] = '';
                        if (idx.dmgArea !== -1) row[idx.dmgArea] = ''; 
                    }
                }
                
                if (idx.dmgArea !== -1) {
                    let dStr = String(row[idx.dmgArea]).trim();
                    if (dStr === '=' || dStr === '-') { row[idx.dmgArea] = ''; stats.cleanedEquals++; }
                }

                if (idx.farmerId !== -1) {
                    let fid = String(row[idx.farmerId]).trim();
                    if (fid.length === 1 && /^\d$/.test(fid)) { row[idx.farmerId] = '00' + fid; stats.fixedId++; isModified = true; }
                }

                if (idx.area !== -1) {
                    let rawArea = parseFloat(String(row[idx.area]).replace(/,/g,'')) || 0;
                    let rawDmg = 0;
                    if (idx.dmgArea !== -1) rawDmg = parseFloat(String(row[idx.dmgArea]).replace(/,/g,'')) || 0;

                    let fixedAreaStr = rawArea.toFixed(2);
                    let fixedDmgStr = (idx.dmgArea !== -1) ? rawDmg.toFixed(2) : "0.00";
                    if(idx.dmgArea !== -1) row[idx.dmgArea] = fixedDmgStr;
                    
                    let net = parseFloat(fixedAreaStr) - parseFloat(fixedDmgStr);
                    if (net <= 0.000001) { stats.removedNetArea++; continue; }

                    let newNetStr = net.toFixed(2);
                    if (row[idx.area] !== newNetStr) { row[idx.area] = newNetStr; isModified = true; }
                    if (idx.netArea !== -1) row[idx.netArea] = newNetStr;
                }

                if (idx.intech !== -1) { 
                    if (!row[idx.intech] || String(row[idx.intech]).trim() === '') { stats.removedIntech++; continue; } 
                }

                cleaned.push(row);
                rowMetaList.push({ isModified: isModified, hasError: false });
            }
            return { headers, cleaned, stats, rowMetaList };
        }
        
        // --- HELPER FUNCTIONS ---
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function createReportItem(icon, text, count, isRemove) {
            if (count === 0) return '';
            const classBadge = isRemove ? 'count-removed' : 'count-modified';
            const unit = isRemove ? 'แถว' : 'จุด';
            return `<div class="report-item"><div class="rule-name"><div class="rule-icon"><i class="${icon}"></i></div><span>${text}</span></div><span class="count-badge ${classBadge}">${count.toLocaleString()} ${unit}</span></div>`;
        }
        
        // --- FILE HANDLING ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        dropZone.onclick = () => fileInput.click();
        
        dropZone.ondragover = (e) => { 
            e.preventDefault(); 
            dropZone.style.borderColor = 'var(--primary-color)'; 
        };
        
        dropZone.ondragleave = (e) => { 
            e.preventDefault(); 
            dropZone.style.borderColor = 'var(--accent-color)'; 
        };
        
        dropZone.ondrop = (e) => { 
            e.preventDefault(); 
            dropZone.style.borderColor = 'var(--accent-color)'; 
            if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); 
        };

        function handleFile(file) {
            loadingOverlay.style.display = 'flex';
            appData.fileName = file.name;
            
            // Set File Meta
            metaFileName.innerText = file.name;
            metaFileSize.innerText = formatBytes(file.size);
            metaProcessTime.innerText = new Date().toLocaleTimeString('th-TH');

            Papa.parse(file, {
                complete: (res) => {
                    setTimeout(() => {
                        const raw = res.data.filter(row => row.length > 1 || (row[0] && row[0].trim() !== ""));
                        const totalOriginal = raw.length - 1; 
                        const result = runRev17Detailed(raw);
                        
                        // บันทึกข้อมูลสำหรับระบบเดิม
                        appData.headers = result.headers;
                        appData.data = result.cleaned;
                        appData.removedStats = result.stats;
                        appData.rowMeta = result.rowMetaList;
                        
                        // แปลงข้อมูลให้เข้ากับระบบเดิม
                        uploadedData = {
                            headers: result.headers,
                            data: result.cleaned.map(row => {
                                const obj = {};
                                result.headers.forEach((header, index) => {
                                    obj[header] = row[index] || '';
                                });
                                return obj;
                            }),
                            fileName: file.name,
                            totalRows: result.cleaned.length,
                            totalCols: result.headers.length
                        };
                        
                        allColumns = [...result.headers];
                        selectedColumns = [...result.headers]; // เลือกทั้งหมดโดยอัตโนมัติ

                        metaColCount.innerText = appData.headers.length + " คอลัมน์";
                        statTotal.innerText = totalOriginal.toLocaleString();
                        statPass.innerText = appData.data.length.toLocaleString();
                        statRemoved.innerText = (totalOriginal - appData.data.length).toLocaleString();

                        const s = result.stats;
                        let rHtml = '';
                        rHtml += createReportItem('fas fa-id-card-alt', 'กรองเลขโควต้า', s.removedQuota, true);
                        rHtml += createReportItem('fas fa-leaf', 'กรองชื่อประเภทอ้อย', s.removedCaneType, true);
                        rHtml += createReportItem('fas fa-eraser', 'ลบ "=" ในพื้นที่เสียหาย', s.cleanedEquals, false);
                        rHtml += createReportItem('fas fa-calculator', 'กรองพื้นที่สุทธิ (<= 0)', s.removedNetArea, true);
                        rHtml += createReportItem('fas fa-map-marked-alt', 'กรองเลขแปลง Intech', s.removedIntech, true);
                        rHtml += createReportItem('fas fa-map-signs', 'แก้ไขชื่อโซน', s.fixedZone, false);
                        rHtml += createReportItem('fas fa-user-tag', 'เติมศูนย์รหัสเกษตร', s.fixedId, false);
                        
                        if(rHtml === '') rHtml = '<div style="padding:20px; text-align:center; color:#888;">ไม่พบการตัดหรือแก้ไขข้อมูล</div>';
                        detailedReportList.innerHTML = rHtml;

                        dropZone.style.display = 'none';
                        fileInfo.style.display = 'block';
                        loadingOverlay.style.display = 'none';
                        
                        // เปิดใช้งานปุ่มต่อไป
                        nextToStep2.disabled = false;
                    }, 800); 
                }
            });
        }
        
        fileInput.onchange = (e) => { 
            if(e.target.files[0]) handleFile(e.target.files[0]); 
        };

        // ============================================
        // ฟังก์ชันจัดการขั้นตอน
        // ============================================
        function goToStep(stepNumber) {
            // อัพเดตขั้นตอนปัจจุบัน
            currentStep = stepNumber;
            
            // อัพเดต navigation steps
            [step1, step2, step3, step4, step5].forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
            
            // อัพเดต panels
            [panel1, panel2, panel3, panel4, panel5].forEach((panel, index) => {
                panel.classList.remove('active');
                if (index + 1 === stepNumber) {
                    panel.classList.add('active');
                }
            });
            
            // แสดงหรือซ่อน Dashboard
            if (stepNumber === 3) {
                dashboardSummary.style.display = 'block';
                initDataValidationSystem();
            } else {
                dashboardSummary.style.display = 'none';
            }
            
            // เรียกใช้งานระบบตรวจสอบเงื่อนไขถ้าไปที่ขั้นตอนที่ 4
            if (stepNumber === 4) {
                setTimeout(initConditionChecking, 100);
            }
            
            // เรียกใช้งานระบบเลือกคอลัมน์สำหรับส่งออกถ้าไปที่ขั้นตอนที่ 5
            if (stepNumber === 5) {
                setTimeout(initExportColumnSelection, 100);
            }
        }

        // ============================================
        // ขั้นตอนที่ 2: เลือกคอลัมน์
        // ============================================
        nextToStep2.addEventListener('click', function() {
            if (!uploadedData) {
                alert('กรุณาอัปโหลดไฟล์ก่อน');
                return;
            }
            
            // เตรียมข้อมูลคอลัมน์ทั้งหมด
            prepareColumnSelection();
            
            // ไปยังขั้นตอนที่ 2
            goToStep(2);
        });
        
        function prepareColumnSelection() {
            allColumns = [...uploadedData.headers];
            
            // ✅ แก้ไข: เลือกคอลัมน์ทั้งหมดอัตโนมัติ
            selectedColumns = [...allColumns];
            
            // อัพเดตจำนวนคอลัมน์ทั้งหมด
            totalColumns.textContent = allColumns.length;
            
            // สร้างรายการคอลัมน์
            renderColumnGrid();
            
            // อัพเดตสถิติ
            updateColumnStats();
            
            // ✅ แก้ไข: เปิดใช้งานปุ่มต่อไปทันทีเมื่อเลือกคอลัมน์ทั้งหมด
            nextToStep3.disabled = false;
        }
        
        function renderColumnGrid() {
            columnsGrid.innerHTML = '';
            
            const searchTerm = columnSearch.value.toLowerCase();
            
            allColumns.forEach(column => {
                // ตรวจสอบว่าคอลัมน์นี้ผ่านการกรองหรือไม่
                const columnNameLower = column.toLowerCase();
                const isSelected = selectedColumns.includes(column);
                const matchesSearch = searchTerm === '' || columnNameLower.includes(searchTerm);
                
                // ตรวจสอบประเภทคอลัมน์
                let columnType = '';
                let columnClass = '';
                
                if (columnNameLower.includes('ประเภทอ้อย') || columnNameLower.includes('sugarcane') || 
                    columnNameLower.includes('พันธุ์') || columnNameLower.includes('type')) {
                    columnType = 'ข้อมูลอ้อย';
                    columnClass = 'sugarcane';
                } else if (columnNameLower.includes('อายุ') || columnNameLower.includes('age') ||
                          columnNameLower.includes('งวด') || columnNameLower.includes('period') ||
                          columnNameLower.includes('กิจกรรม') || columnNameLower.includes('activity')) {
                    columnType = 'กิจกรรมงวด';
                    columnClass = 'activity';
                } else if (columnNameLower.includes('โครงการ') || columnNameLower.includes('project')) {
                    columnType = 'โครงการ';
                    columnClass = 'project';
                } else if (columnNameLower.includes('ปุ๋ย') || columnNameLower.includes('fertilizer') ||
                          columnNameLower.includes('ยา') || columnNameLower.includes('chemical')) {
                    columnType = 'ปุ๋ย';
                    columnClass = 'fertilizer';
                } else if (columnNameLower.includes('วันที่') || columnNameLower.includes('date')) {
                    columnType = 'วันที่';
                } else if (columnNameLower.includes('รหัส') || columnNameLower.includes('code') || 
                          columnNameLower.includes('id') || columnNameLower.includes('หมายเลข')) {
                    columnType = 'รหัส';
                } else if (columnNameLower.includes('จำนวน') || columnNameLower.includes('quantity') ||
                          columnNameLower.includes('ปริมาณ') || columnNameLower.includes('amount') ||
                          columnNameLower.includes('พื้นที่') || columnNameLower.includes('area')) {
                    columnType = 'จำนวน';
                } else if (columnNameLower === 'lat' || columnNameLower === 'latitude') {
                    columnType = 'พิกัด lat';
                    columnClass = 'sugarcane';
                } else if (columnNameLower === 'long' || columnNameLower === 'longitude') {
                    columnType = 'พิกัด long';
                    columnClass = 'sugarcane';
                } else {
                    columnType = 'ข้อมูลทั่วไป';
                }
                
                // ตรวจสอบว่าควรแสดงคอลัมน์นี้ตาม filter ปัจจุบันหรือไม่
                let shouldShow = matchesSearch;
                
                if (currentColumnFilter === 'selected') {
                    shouldShow = shouldShow && isSelected;
                } else if (currentColumnFilter === 'unselected') {
                    shouldShow = shouldShow && !isSelected;
                } else if (currentColumnFilter !== 'all') {
                    shouldShow = shouldShow && columnClass === currentColumnFilter;
                }
                
                // ตรวจสอบว่าคอลัมน์นี้มีข้อมูลหรือไม่ (ตัวอย่าง 5 แถวแรก)
                const sampleValues = uploadedData.data.slice(0, 5).map(row => row[column]);
                const emptyCount = sampleValues.filter(v => v === '').length;
                const fillRate = ((sampleValues.length - emptyCount) / sampleValues.length * 100).toFixed(0);
                
                const columnItem = document.createElement('div');
                columnItem.className = `column-item ${columnClass} ${isSelected ? 'selected' : ''}`;
                columnItem.style.display = shouldShow ? 'flex' : 'none';
                
                columnItem.innerHTML = `
                    <input type="checkbox" class="column-checkbox" ${isSelected ? 'checked' : ''} data-column="${column}">
                    <div class="column-info">
                        <div class="column-name" title="${column}">${column}</div>
                        <span class="column-type">${columnType}</span>
                        <div class="column-stats">
                            <i class="fas fa-database"></i> มีข้อมูล ${fillRate}%
                        </div>
                    </div>
                `;
                
                columnsGrid.appendChild(columnItem);
                
                // เพิ่ม event listener สำหรับ checkbox
                const checkbox = columnItem.querySelector('.column-checkbox');
                checkbox.addEventListener('change', function() {
                    const columnName = this.dataset.column;
                    
                    if (this.checked) {
                        if (!selectedColumns.includes(columnName)) {
                            selectedColumns.push(columnName);
                        }
                    } else {
                        const index = selectedColumns.indexOf(columnName);
                        if (index > -1) {
                            selectedColumns.splice(index, 1);
                        }
                    }
                    
                    // อัพเดต UI
                    columnItem.classList.toggle('selected', this.checked);
                    updateColumnStats();
                    
                    // เปิด/ปิดใช้งานปุ่มต่อไป
                    nextToStep3.disabled = selectedColumns.length === 0;
                });
            });
            
            // อัพเดตจำนวนคอลัมน์ที่แสดง
            updateFilteredCount();
        }
        
        function updateColumnStats() {
            selectedCount.textContent = selectedColumns.length;
            selectedSummaryCount.textContent = selectedColumns.length;
            
            if (selectedColumns.length === 0) {
                selectedColumnsList.textContent = 'ยังไม่ได้เลือกคอลัมน์';
            } else {
                const displayedColumns = selectedColumns.slice(0, 3);
                const moreCount = selectedColumns.length - 3;
                selectedColumnsList.textContent = displayedColumns.join(', ') + 
                    (moreCount > 0 ? ` และอีก ${moreCount} คอลัมน์...` : '');
            }
        }
        
        function updateFilteredCount() {
            const visibleColumns = Array.from(columnsGrid.querySelectorAll('.column-item'))
                .filter(item => item.style.display !== 'none');
            filteredCount.textContent = visibleColumns.length;
        }
        
        // Search functionality
        columnSearch.addEventListener('input', function() {
            renderColumnGrid();
        });
        
        // Column filter buttons
        columnFilterButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                // อัพเดตปุ่มที่ active
                columnFilterButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // ตั้งค่าตัวกรอง
                currentColumnFilter = this.dataset.filter;
                
                // กรองคอลัมน์
                renderColumnGrid();
            });
        });
        
        // Select all / Deselect all
        selectAllBtn.addEventListener('click', function() {
            const visibleColumns = Array.from(columnsGrid.querySelectorAll('.column-item'))
                .filter(item => item.style.display !== 'none');
            
            visibleColumns.forEach(item => {
                const checkbox = item.querySelector('.column-checkbox');
                const columnName = checkbox.dataset.column;
                
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    if (!selectedColumns.includes(columnName)) {
                        selectedColumns.push(columnName);
                    }
                    item.classList.add('selected');
                }
            });
            
            updateColumnStats();
            nextToStep3.disabled = selectedColumns.length === 0;
        });
        
        deselectAllBtn.addEventListener('click', function() {
            const visibleColumns = Array.from(columnsGrid.querySelectorAll('.column-item'))
                .filter(item => item.style.display !== 'none');
            
            visibleColumns.forEach(item => {
                const checkbox = item.querySelector('.column-checkbox');
                const columnName = checkbox.dataset.column;
                
                if (checkbox.checked) {
                    checkbox.checked = false;
                    const index = selectedColumns.indexOf(columnName);
                    if (index > -1) {
                        selectedColumns.splice(index, 1);
                    }
                    item.classList.remove('selected');
                }
            });
            
            updateColumnStats();
            nextToStep3.disabled = selectedColumns.length === 0;
        });
        
        // ============================================
        // ขั้นตอนที่ 3: ตรวจสอบประเภทข้อมูล
        // ============================================
        nextToStep3.addEventListener('click', function() {
            if (selectedColumns.length === 0) {
                alert('กรุณาเลือกคอลัมน์ที่ต้องการตรวจสอบ');
                return;
            }
            
            // ไปยังขั้นตอนที่ 3
            goToStep(3);
        });
        
        // ============================================
        // ระบบตรวจสอบข้อมูล (Step 3)
        // ============================================
        function initDataValidationSystem() {
            // แสดง Dashboard
            dashboardSummary.style.display = 'block';
            
            // รันการตรวจสอบข้อมูลจากข้อมูลที่อัปโหลด
            if (uploadedData && selectedColumns.length > 0) {
                runDataValidationFromUploadedData();
            }
        }
        
     function runDataValidationFromUploadedData() {
    if (!uploadedData || selectedColumns.length === 0) return;
    
    // ✅ แก้ไข: ตัดแถวที่ว่างทั้งหมดออกก่อนตรวจสอบ
    const removedCount = removeEmptyRows();
    if (removedCount > 0) {
        alert(`✅ ตัดแถวที่ว่างทั้งหมดออกแล้ว: ${removedCount} แถว`);
    }
    
    currentValidationResults = {
        totalCells: 0,
        validCells: 0,
        warningCells: 0,
        errorCells: 0,
        details: {}
    };
    
    cellValidationStatus = {};
    
    // ✅ แก้ไข: ใช้ข้อมูลทั้งหมดแทน 50 แถว
    const allRows = uploadedData.data; // ใช้ข้อมูลทั้งหมด
    totalCells = allRows.length * selectedColumns.length;
    
    // ตรวจสอบแต่ละเซลล์ในข้อมูลที่อัปโหลด
    allRows.forEach((row, rowIndex) => {
        selectedColumns.forEach((columnName, colIndex) => {
            const cellValue = row[columnName] || '';
            
            // ✅ แก้ไข: ถ้าค่าเป็นช่องว่าง ให้ผ่านได้เลย
            if (cellValue.trim() === '') {
                if (!cellValidationStatus[rowIndex]) {
                    cellValidationStatus[rowIndex] = {};
                }
                cellValidationStatus[rowIndex][colIndex] = {
                    status: 'valid',
                    message: 'ค่าว่าง - ผ่าน',
                    suggestions: [],
                    dataType: 'text',
                    edited: false
                };
                
                currentValidationResults.totalCells++;
                currentValidationResults.validCells++;
                return;
            }
            
            // ใช้ประเภทข้อมูลที่ผู้ใช้เลือก หรือตรวจจับอัตโนมัติ
            const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, cellValue);
            const validation = validateCellData(columnName, cellValue, columnType, rowIndex, colIndex);
            
            // บันทึกผลการตรวจสอบ
            if (!cellValidationStatus[rowIndex]) {
                cellValidationStatus[rowIndex] = {};
            }
            
            cellValidationStatus[rowIndex][colIndex] = validation;
            
            // นับสถิติ
            currentValidationResults.totalCells++;
            
            if (validation.status === 'valid') {
                currentValidationResults.validCells++;
            } else if (validation.status === 'warning') {
                currentValidationResults.warningCells++;
            } else if (validation.status === 'error') {
                currentValidationResults.errorCells++;
            }
            
            // บันทึกรายละเอียด
            if (!currentValidationResults.details[columnName]) {
                currentValidationResults.details[columnName] = {
                    errors: [],
                    warnings: []
                };
            }
            
            if (validation.status === 'error') {
                currentValidationResults.details[columnName].errors.push({
                    row: rowIndex + 1,
                    value: cellValue,
                    message: validation.message
                });
            } else if (validation.status === 'warning') {
                currentValidationResults.details[columnName].warnings.push({
                    row: rowIndex + 1,
                    value: cellValue,
                    message: validation.message
                });
            }
        });
    });
    
    // แสดงข้อมูลในตาราง
    renderDataTableFromUploadedData();
    
    // อัพเดต Dashboard
    updateDashboard();
}

function renderDataTableFromUploadedData() {
    // ล้างตารางเดิม
    dataTableHeader.innerHTML = '';
    dataTableBody.innerHTML = '';
    
    if (!uploadedData || selectedColumns.length === 0) return;
    
    // สร้างหัวตาราง
    const headerRow = document.createElement('tr');
    
    // เพิ่มคอลัมน์หมายเลขแถว
    const rowNumHeader = document.createElement('th');
    rowNumHeader.textContent = '#';
    rowNumHeader.style.width = '50px';
    headerRow.appendChild(rowNumHeader);
    
    // เพิ่มหัวคอลัมน์ข้อมูลที่เลือก
    selectedColumns.forEach(columnName => {
        const th = document.createElement('th');
        
        // ตรวจสอบประเภทคอลัมน์ (ใช้ประเภทที่ผู้ใช้เลือก)
        const effectiveType = userSelectedDataTypes[columnName] || 
                             detectColumnType(columnName, uploadedData.data[0] ? uploadedData.data[0][columnName] || '' : '');
        
        // เพิ่ม badge ประเภทข้อมูล
        const typeBadge = document.createElement('span');
        typeBadge.className = 'column-type-badge';
        typeBadge.textContent = getTypeDisplayName(effectiveType);
        typeBadge.style.marginLeft = '5px';
        typeBadge.style.padding = '2px 6px';
        typeBadge.style.borderRadius = '10px';
        typeBadge.style.backgroundColor = getTypeColor(effectiveType);
        typeBadge.style.color = 'white';
        
        th.innerHTML = `${columnName} `;
        th.appendChild(typeBadge);
        headerRow.appendChild(th);
    });
    
    dataTableHeader.appendChild(headerRow);
    
    // ✅ แก้ไข: เพิ่มฟิลเตอร์ในหัวตารางเป็น Dropdown
    setTimeout(() => {
        addColumnFilterDropdowns();
    }, 100);
    
    // ✅ แก้ไข: แสดงข้อมูลทั้งหมด
    const displayRows = uploadedData.data; // ใช้ข้อมูลทั้งหมด
    
    // อัพเดตจำนวนแถวที่แสดง
    totalRows.textContent = uploadedData.data.length;
    currentRows.textContent = uploadedData.data.length;
    totalRowCount.textContent = uploadedData.data.length;
    
    // ✅ แก้ไข: แสดงเฉพาะ 100 แถวแรกเพื่อไม่ให้หน้าเว็บล่ม (แต่ Dashboard จะคำนวณจากทั้งหมด)
    const rowsToDisplay = displayRows.slice(0, 100); // แสดง 100 แถวแรกในตาราง
    
    rowsToDisplay.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        
        // เพิ่มหมายเลขแถว
        const rowNumCell = document.createElement('td');
        rowNumCell.textContent = rowIndex + 1;
        rowNumCell.style.fontWeight = 'bold';
        tr.appendChild(rowNumCell);
        
        // เพิ่มข้อมูลแต่ละเซลล์
        selectedColumns.forEach((columnName, colIndex) => {
            const td = document.createElement('td');
            const cellValue = row[columnName] || '';
            td.textContent = cellValue;
            
            // ตรวจสอบประเภทที่ควรใช้
            const effectiveType = userSelectedDataTypes[columnName] || 
                                 detectColumnType(columnName, cellValue);
            
            // ตรวจสอบข้อมูล (ใช้การตรวจสอบแบบคร่าวๆ สำหรับการแสดงผล)
            const validation = validateCellData(columnName, cellValue, effectiveType, rowIndex, colIndex);
            
            // เพิ่มคลาสตามสถานะการตรวจสอบ
            if (validation.status === 'error') {
                td.className = 'cell-error cell-highlight';
                td.title = validation.message;
            } else if (validation.status === 'warning') {
                td.className = 'cell-warning cell-highlight';
                td.title = validation.message;
            } else {
                td.className = 'cell-valid';
            }
            
            // เพิ่มข้อมูลสำหรับการแก้ไข
            td.dataset.row = rowIndex;
            td.dataset.col = colIndex;
            td.dataset.column = columnName;
            td.dataset.value = cellValue;
            td.dataset.type = effectiveType;
            
            // Event listener สำหรับการแก้ไข
            if (validation.status === 'error' || validation.status === 'warning') {
                td.style.cursor = 'pointer';
                td.addEventListener('click', () => openCellEditorForUploadedData(rowIndex, colIndex));
            }
            
            tr.appendChild(td);
        });
        
        dataTableBody.appendChild(tr);
    });
    
    // ✅ แก้ไข: เพิ่มข้อความเตือนถ้ามีข้อมูลมากกว่า 100 แถว
    if (displayRows.length > 100) {
        const infoRow = document.createElement('tr');
        const infoCell = document.createElement('td');
        infoCell.colSpan = selectedColumns.length + 1;
        infoCell.style.textAlign = 'center';
        infoCell.style.padding = '20px';
        infoCell.style.backgroundColor = '#f8f9fa';
        infoCell.style.color = '#666';
        infoCell.innerHTML = `
            <i class="fas fa-info-circle"></i> แสดง ${rowsToDisplay.length} แถวแรกจากทั้งหมด ${displayRows.length} แถว 
            | Dashboard คำนวณจากข้อมูลทั้งหมด ${displayRows.length} แถว
            <button class="btn btn-sm btn-outline" id="showAllDataBtn" style="margin-left: 10px;">
                <i class="fas fa-expand"></i> แสดงทั้งหมด
            </button>
        `;
        infoRow.appendChild(infoCell);
        dataTableBody.appendChild(infoRow);
        
        // เพิ่ม event listener สำหรับปุ่มแสดงทั้งหมด
        setTimeout(() => {
            document.getElementById('showAllDataBtn').addEventListener('click', function() {
                loadAllDataToTable();
            });
        }, 100);
    }
    
    // อัพเดตข้อมูลตาราง
    currentColumns.textContent = selectedColumns.length;
    updateDataStatus();
}

// ✅ แก้ไข: เพิ่มฟังก์ชันโหลดข้อมูลทั้งหมดลงตาราง
function loadAllDataToTable() {
    if (!uploadedData || selectedColumns.length === 0) return;
    
    // ล้างตารางเดิม
    dataTableBody.innerHTML = '';
    
    // แสดงข้อมูลทั้งหมด
    uploadedData.data.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        
        // เพิ่มหมายเลขแถว
        const rowNumCell = document.createElement('td');
        rowNumCell.textContent = rowIndex + 1;
        rowNumCell.style.fontWeight = 'bold';
        tr.appendChild(rowNumCell);
        
        // เพิ่มข้อมูลแต่ละเซลล์
        selectedColumns.forEach((columnName, colIndex) => {
            const td = document.createElement('td');
            const cellValue = row[columnName] || '';
            td.textContent = cellValue;
            
            // ตรวจสอบประเภทที่ควรใช้
            const effectiveType = userSelectedDataTypes[columnName] || 
                                 detectColumnType(columnName, cellValue);
            
            // ตรวจสอบข้อมูล
            const validation = validateCellData(columnName, cellValue, effectiveType, rowIndex, colIndex);
            
            // เพิ่มคลาสตามสถานะการตรวจสอบ
            if (validation.status === 'error') {
                td.className = 'cell-error cell-highlight';
                td.title = validation.message;
            } else if (validation.status === 'warning') {
                td.className = 'cell-warning cell-highlight';
                td.title = validation.message;
            } else {
                td.className = 'cell-valid';
            }
            
            // เพิ่มข้อมูลสำหรับการแก้ไข
            td.dataset.row = rowIndex;
            td.dataset.col = colIndex;
            td.dataset.column = columnName;
            td.dataset.value = cellValue;
            td.dataset.type = effectiveType;
            
            // Event listener สำหรับการแก้ไข
            if (validation.status === 'error' || validation.status === 'warning') {
                td.style.cursor = 'pointer';
                td.addEventListener('click', () => openCellEditorForUploadedData(rowIndex, colIndex));
            }
            
            tr.appendChild(td);
        });
        
        dataTableBody.appendChild(tr);
    });
    
    // อัพเดตจำนวนแถวที่แสดง
    currentRows.textContent = uploadedData.data.length;
    
    // แสดงข้อความสรุป
    const summaryRow = document.createElement('tr');
    const summaryCell = document.createElement('td');
    summaryCell.colSpan = selectedColumns.length + 1;
    summaryCell.style.textAlign = 'center';
    summaryCell.style.padding = '15px';
    summaryCell.style.backgroundColor = '#e8f5e9';
    summaryCell.style.color = '#2e7d32';
    summaryCell.innerHTML = `
        <i class="fas fa-check-circle"></i> แสดงข้อมูลทั้งหมด ${uploadedData.data.length} แถว
        | Dashboard คำนวณจากข้อมูลทั้งหมด
    `;
    summaryRow.appendChild(summaryCell);
    dataTableBody.appendChild(summaryRow);
    
    alert(`✅ แสดงข้อมูลทั้งหมด ${uploadedData.data.length} แถวเรียบร้อยแล้ว`);
}

function toggleAllRows() {
    isShowingAllRows = !isShowingAllRows;
    
    if (isShowingAllRows) {
        loadAllDataToTable();
        document.getElementById('toggleAllRows').innerHTML = 
            `<i class="fas fa-compress"></i> แสดงบางส่วน`;
    } else {
        renderDataTableFromUploadedData(); // กลับไปแสดง 100 แถวแรก
        document.getElementById('toggleAllRows').innerHTML = 
            `<i class="fas fa-expand"></i> แสดงทั้งหมด (${uploadedData.data.length})`;
    }
}
        
        // ✅ แก้ไขฟังก์ชันตรวจจับประเภทข้อมูลตามข้อกำหนดใหม่
        function detectColumnType(columnName, sampleValue) {
            const columnNameLower = columnName.toLowerCase();
            
            // ✅ แก้ไข: คอลัมน์ "ชื่อประเภทอ้อย" ให้เป็นประเภท "text" (ข้อความ)
            if (columnNameLower === 'ชื่อประเภทอ้อย' || 
                columnNameLower.includes('ชื่อประเภทอ้อย')) {
                return 'text';
            }
            
            // ✅ แก้ไข: คอลัมน์ "ประเภทอ้อย" ให้เป็นประเภท "number" (ตัวเลข)
            if (columnNameLower === 'ประเภทอ้อย' || 
                columnNameLower.includes('ประเภทอ้อย')) {
                return 'number';
            }
            
            // ✅ แก้ไข: คอลัมน์ "ประวัติการใช้พื้นที่" เป็นข้อความโดยอัตโนมัติ
            if (columnNameLower.includes('ประวัติการใช้พื้นที่') || 
                columnNameLower.includes('ประวัติ') || 
                columnNameLower.includes('การใช้พื้นที่')) {
                return 'text';
            }
            
            // ✅ แก้ไข: คอลัมน์ "ความเสี่ยงพื้นที่" เป็นข้อความ
            if (columnNameLower.includes('ความเสี่ยงพื้นที่') || columnNameLower.includes('ความเสี่ยง')) {
                return 'text';
            }
            
            // ✅ แก้ไข: คอลัมน์ "ความลาดเอียงของพื้นที่" เป็นข้อความ
            if (columnNameLower.includes('ความลาดเอียง') || columnNameLower.includes('ลาดเอียง') || columnNameLower.includes('slope')) {
                return 'text';
            }
            
            // ตรวจสอบจากชื่อคอลัมน์ (ให้ความสำคัญสูงสุด)
            if (columnNameLower.includes('วันที่') || columnNameLower.includes('date') || 
                columnNameLower.includes('วัน') || columnNameLower.includes('month') || 
                columnNameLower.includes('year')) {
                return 'date';
            }
            
            if (columnNameLower.includes('จำนวน') || columnNameLower.includes('quantity') ||
                columnNameLower.includes('ปริมาณ') || columnNameLower.includes('amount') ||
                columnNameLower.includes('น้ำหนัก') || columnNameLower.includes('weight') ||
                columnNameLower.includes('พื้นที่') || columnNameLower.includes('area') ||
                columnNameLower.includes('ราคา') || columnNameLower.includes('price') ||
                columnNameLower === 'lat' || columnNameLower === 'latitude' ||
                columnNameLower === 'long' || columnNameLower === 'longitude') {
                return 'number';
            }
            
            if (columnNameLower.includes('รหัส') || columnNameLower.includes('code') || 
                columnNameLower.includes('id') || columnNameLower.includes('หมายเลข') ||
                columnNameLower.includes('เลขที่') || columnNameLower.includes('no.')) {
                return 'identifier';
            }
            
            if (columnNameLower.includes('ประเภท') || columnNameLower.includes('type') ||
                columnNameLower.includes('สถานะ') || columnNameLower.includes('status') ||
                columnNameLower.includes('ใช่/ไม่') || columnNameLower.includes('yes/no') ||
                columnNameLower.includes('ระดับ') || columnNameLower.includes('level') ||
                columnNameLower.includes('การจัด') || columnNameLower.includes('category')) {
                return 'enum';
            }
            
            // ตรวจสอบจากค่าตัวอย่าง
            if (sampleValue === '' || sampleValue === null || sampleValue === undefined) {
                return 'text';
            }
            
            // ตรวจสอบตัวเลข
            const numValue = parseFloat(sampleValue);
            if (!isNaN(numValue) && sampleValue.trim() !== '' && 
                !isNaN(parseFloat(sampleValue)) && isFinite(sampleValue)) {
                return 'number';
            }
            
            // ตรวจสอบวันที่
            const datePatterns = [
                /^\d{4}-\d{1,2}-\d{1,2}$/,
                /^\d{4}\/\d{1,2}\/\d{1,2}$/,
                /^\d{1,2}\/\d{1,2}\/\d{4}$/,
                /^\d{1,2}-\d{1,2}-\d{4}$/
            ];
            
            if (datePatterns.some(pattern => pattern.test(sampleValue.trim()))) {
                return 'date';
            }
            
            // ตรวจสอบว่ามีค่าที่กำหนดหรือไม่
            const sampleLower = sampleValue.toLowerCase().trim();
            if (sampleLower === 'ใช่' || sampleLower === 'ไม่' || 
                sampleLower === 'yes' || sampleLower === 'no' ||
                sampleLower === 'true' || sampleLower === 'false') {
                return 'enum';
            }
            
            // ค่าเริ่มต้นเป็นข้อความ
            return 'text';
        }
        
        function validateCellData(columnName, value, columnType, rowIndex, colIndex) {
            // ใช้ประเภทที่ผู้ใช้เลือกถ้ามี
            const effectiveType = userSelectedDataTypes[columnName] || columnType;
            
            const result = {
                status: 'valid',
                message: '',
                suggestions: [],
                dataType: effectiveType,
                edited: false
            };
            
            // ตรวจสอบค่าว่าง (ผ่านแล้วในขั้นต้น)
            if (value === '' || value === null || value === undefined) {
                return result;
            }
            
            // ✅ แก้ไข: คอลัมน์ "เลขแปลงintech" เป็นค่าเริ่มต้น ไม่ต้องตรวจสอบ
            if (columnName.toLowerCase().includes('แปลงintech')) {
                return result;
            }
            
            // ✅ แก้ไข: การตรวจสอบและแนะนำสำหรับคอลัมน์ "ชื่อประเภทอ้อย"
            if (columnName.toLowerCase() === 'ชื่อประเภทอ้อย') {
                // ค่าที่แนะนำสำหรับคอลัมน์ "ชื่อประเภทอ้อย"
                const validTypes = ALLOWED_CANE_TYPES;
                
                if (!validTypes.includes(value.trim())) {
                    result.status = 'error';
                    result.message = `ต้องเป็นหนึ่งใน: ${validTypes.join(', ')}`;
                    result.suggestions = validTypes;
                }
                return result;
            }
            
            // ✅ แก้ไข: การตรวจสอบและแนะนำสำหรับคอลัมน์ "ประเภทอ้อย"
            if (columnName.toLowerCase() === 'ประเภทอ้อย') {
                // ค่าที่แนะนำสำหรับคอลัมน์ "ประเภทอ้อย"
                const validNumbers = sugarcaneNumbers;
                
                // ตรวจสอบว่าเป็นตัวเลขหรือไม่
                const numValue = parseFloat(value);
                if (isNaN(numValue)) {
                    result.status = 'error';
                    result.message = 'ต้องเป็นตัวเลข';
                    result.suggestions = validNumbers;
                } 
                // ตรวจสอบว่าตรงกับตัวเลขที่กำหนดหรือไม่
                else if (!validNumbers.includes(value.trim())) {
                    result.status = 'error';
                    result.message = `ต้องเป็นหนึ่งใน: ${validNumbers.join(', ')}`;
                    result.suggestions = validNumbers;
                }
                return result;
            }
            
            // ✅ ตรวจสอบจังหวัดและอำเภอตามข้อมูล THAI_LOCATIONS
            if (columnName.toLowerCase().includes('จังหวัด')) {
                if (value !== '' && !THAI_LOCATIONS.hasOwnProperty(value)) {
                    result.status = 'error';
                    result.message = `จังหวัด "${value}" ไม่มีในฐานข้อมูลประเทศไทย`;
                    result.suggestions = Object.keys(THAI_LOCATIONS);
                }
                return result;
            }
            
            if (columnName.toLowerCase().includes('อำเภอ')) {
                // หาจังหวัดจากแถวเดียวกัน
                const provinceColumn = selectedColumns.find(col => col.toLowerCase().includes('จังหวัด'));
                if (provinceColumn && uploadedData.data[rowIndex]) {
                    const provinceValue = uploadedData.data[rowIndex][provinceColumn] || '';
                    if (provinceValue && THAI_LOCATIONS[provinceValue]) {
                        const districts = THAI_LOCATIONS[provinceValue];
                        const cleanDistrict = value.replace(/^อ\./, '').trim();
                        if (!districts.some(d => d === cleanDistrict || d.includes(cleanDistrict) || cleanDistrict.includes(d))) {
                            result.status = 'error';
                            result.message = `อำเภอ "${value}" ไม่มีในจังหวัด "${provinceValue}"`;
                            result.suggestions = districts;
                        }
                    }
                }
                return result;
            }
            
            // ตรวจสอบตามประเภทข้อมูล
            switch(effectiveType) {
                case 'number':
                    if (isNaN(value) || value.trim() === '') {
                        result.status = 'error';
                        result.message = 'ต้องเป็นตัวเลข';
                        
                        if (columnName.toLowerCase() === 'lat') {
                            result.suggestions = ['13.7563', '14.0790', '15.8700', '16.4393'];
                        } else if (columnName.toLowerCase() === 'long') {
                            result.suggestions = ['100.5018', '101.0037', '102.4956', '103.8499'];
                        } else if (columnName.includes('พื้นที่')) {
                            result.suggestions = ['10.0', '15.5', '20.0', '25.5'];
                        } else if (columnName.includes('อายุ')) {
                            result.suggestions = ['120', '150', '180', '210'];
                        } else if (columnName.includes('โควต้า')) {
                            result.suggestions = ['100', '150', '200', '250'];
                        } else {
                            result.suggestions = ['0', '10', '50', '100'];
                        }
                    } else {
                        const numValue = parseFloat(value);
                        
                        // ตรวจสอบพิกัด latitude (lat)
                        if (columnName.toLowerCase() === 'lat') {
                            if (numValue < -90 || numValue > 90) {
                                result.status = 'error';
                                result.message = 'latitude ต้องอยู่ระหว่าง -90 ถึง 90';
                                result.suggestions = ['13.7563', '14.0790', '15.8700', '16.4393'];
                            } else if (Math.abs(numValue) < 1 || Math.abs(numValue) > 99) {
                                result.status = 'warning';
                                result.message = 'latitude มักเป็นเลขหลักสิบ (13-17 สำหรับประเทศไทย)';
                                result.suggestions = ['13.7563', '14.0790', '15.8700', '16.4393'];
                            }
                        }
                        
                        // ตรวจสอบพิกัด longitude (long)
                        if (columnName.toLowerCase() === 'long') {
                            if (numValue < -180 || numValue > 180) {
                                result.status = 'error';
                                result.message = 'longitude ต้องอยู่ระหว่าง -180 ถึง 180';
                                result.suggestions = ['100.5018', '101.0037', '102.4956', '103.8499'];
                            } else if (Math.abs(numValue) < 90 || Math.abs(numValue) > 110) {
                                result.status = 'warning';
                                result.message = 'longitude มักเป็นเลขหลักร้อย (100-104 สำหรับประเทศไทย)';
                                result.suggestions = ['100.5018', '101.0037', '102.4956', '103.8499'];
                            }
                        }
                        
                        // ตรวจสอบค่าติดลบสำหรับบางคอลัมน์
                        if ((columnName.includes('พื้นที่') || columnName.includes('อายุ') || 
                             columnName.includes('จำนวน') || columnName.includes('โควต้า')) && numValue < 0) {
                            result.status = 'error';
                            result.message = 'ค่าต้องมากกว่าหรือเท่ากับ 0';
                            result.suggestions = ['0', '1', '10'];
                        }
                    }
                    break;
                    
                case 'date':
                    // ตรวจสอบรูปแบบวันที่ (รองรับ YYYY/MM/DD และ YYYY/M/D)
                    const datePatterns = [
                        /^\d{4}-\d{1,2}-\d{1,2}$/,          // YYYY-MM-DD
                        /^\d{4}\/\d{1,2}\/\d{1,2}$/,       // YYYY/MM/DD หรือ YYYY/M/D
                        /^\d{1,2}\/\d{1,2}\/\d{4}$/,       // DD/MM/YYYY หรือ D/M/YYYY
                        /^\d{1,2}-\d{1,2}-\d{4}$/          // DD-MM-YYYY หรือ D-M-YYYY
                    ];
                    
                    const isValidDate = datePatterns.some(pattern => pattern.test(value.trim()));
                    if (!isValidDate) {
                        result.status = 'error';
                        result.message = 'รูปแบบวันที่ไม่ถูกต้อง (รองรับ: YYYY/MM/DD, YYYY/M/D, DD/MM/YYYY)';
                        result.suggestions = ['2023/01/01', '2023/6/15', '2023/12/31'];
                    }
                    break;
                    
                case 'enum':
                    if (columnName.toLowerCase().includes('ใช่/ไม่') || columnName.toLowerCase().includes('yes/no')) {
                        const validValues = ['ใช่', 'ไม่', 'yes', 'no', 'true', 'false'];
                        if (!validValues.includes(value.toLowerCase())) {
                            result.status = 'error';
                            result.message = 'ต้องเป็น "ใช่" หรือ "ไม่"';
                            result.suggestions = ['ใช่', 'ไม่'];
                        }
                    }
                    break;
                    
                case 'identifier':
                    if (value.length > 50) {
                        result.status = 'warning';
                        result.message = 'รหัสยาวเกินไป';
                    }
                    break;
                    
                case 'text':
                    // ✅ แก้ไข: คอลัมน์ "ความเสี่ยงพื้นที่" และ "ความลาดเอียงของพื้นที่" เป็นข้อความ ไม่ต้องตรวจสอบเพิ่มเติม
                    if (columnName.toLowerCase().includes('ความเสี่ยงพื้นที่') || 
                        columnName.toLowerCase().includes('ความลาดเอียง')) {
                        // ไม่ต้องตรวจสอบเพิ่มเติม
                    } else if (columnName.toLowerCase().includes('แปลงintech')) {
                        // ตรวจสอบรูปแบบเลขแปลงintech
                        if (!/^\d+$/.test(value) && value.trim() !== '') {
                            result.status = 'warning';
                            result.message = 'เลขแปลงintech ควรเป็นตัวเลข';
                        }
                    } else if (value.length < 1 && value.trim() !== '') {
                        result.status = 'warning';
                        result.message = 'ข้อความสั้นเกินไป';
                    }
                    break;
            }
            
            return result;
        }
        
        function renderDataTableFromUploadedData() {
            // ล้างตารางเดิม
            dataTableHeader.innerHTML = '';
            dataTableBody.innerHTML = '';
            
            if (!uploadedData || selectedColumns.length === 0) return;
            
            // สร้างหัวตาราง
            const headerRow = document.createElement('tr');
            
            // เพิ่มคอลัมน์หมายเลขแถว
            const rowNumHeader = document.createElement('th');
            rowNumHeader.textContent = '#';
            rowNumHeader.style.width = '50px';
            headerRow.appendChild(rowNumHeader);
            
            // เพิ่มหัวคอลัมน์ข้อมูลที่เลือก
            selectedColumns.forEach(columnName => {
                const th = document.createElement('th');
                
                // ตรวจสอบประเภทคอลัมน์ (ใช้ประเภทที่ผู้ใช้เลือก)
                const effectiveType = userSelectedDataTypes[columnName] || 
                                     detectColumnType(columnName, uploadedData.data[0] ? uploadedData.data[0][columnName] || '' : '');
                
                // เพิ่ม badge ประเภทข้อมูล
                const typeBadge = document.createElement('span');
                typeBadge.className = 'column-type-badge';
                typeBadge.textContent = getTypeDisplayName(effectiveType);
                typeBadge.style.marginLeft = '5px';
                typeBadge.style.padding = '2px 6px';
                typeBadge.style.borderRadius = '10px';
                typeBadge.style.backgroundColor = getTypeColor(effectiveType);
                typeBadge.style.color = 'white';
                
                th.innerHTML = `${columnName} `;
                th.appendChild(typeBadge);
                headerRow.appendChild(th);
            });
            
            dataTableHeader.appendChild(headerRow);
            
            // ✅ แก้ไข: เพิ่มฟิลเตอร์ในหัวตารางเป็น Dropdown
            setTimeout(() => {
                addColumnFilterDropdowns();
            }, 100);
            
            // สร้างแถวข้อมูล (แสดงตามจำนวนที่กำหนด)
            const displayRows = uploadedData.data.slice(0, currentRowLimit);
            
            // อัพเดตจำนวนแถวที่แสดง
            totalRows.textContent = uploadedData.data.length;
            currentRows.textContent = Math.min(currentRowLimit, uploadedData.data.length);
            totalRowCount.textContent = uploadedData.data.length;
            
            displayRows.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                
                // เพิ่มหมายเลขแถว
                const rowNumCell = document.createElement('td');
                rowNumCell.textContent = rowIndex + 1;
                rowNumCell.style.fontWeight = 'bold';
                tr.appendChild(rowNumCell);
                
                // เพิ่มข้อมูลแต่ละเซลล์
                selectedColumns.forEach((columnName, colIndex) => {
                    const td = document.createElement('td');
                    const cellValue = row[columnName] || '';
                    td.textContent = cellValue;
                    
                    // ตรวจสอบประเภทที่ควรใช้
                    const effectiveType = userSelectedDataTypes[columnName] || 
                                         detectColumnType(columnName, cellValue);
                    
                    // ตรวจสอบข้อมูล
                    const validation = validateCellData(columnName, cellValue, effectiveType, rowIndex, colIndex);
                    
                    // เพิ่มคลาสตามสถานะการตรวจสอบ
                    if (validation.status === 'error') {
                        td.className = 'cell-error cell-highlight';
                        td.title = validation.message;
                    } else if (validation.status === 'warning') {
                        td.className = 'cell-warning cell-highlight';
                        td.title = validation.message;
                    } else {
                        td.className = 'cell-valid';
                    }
                    
                    // เพิ่มข้อมูลสำหรับการแก้ไข
                    td.dataset.row = rowIndex;
                    td.dataset.col = colIndex;
                    td.dataset.column = columnName;
                    td.dataset.value = cellValue;
                    td.dataset.type = effectiveType;
                    
                    // Event listener สำหรับการแก้ไข
                    if (validation.status === 'error' || validation.status === 'warning') {
                        td.style.cursor = 'pointer';
                        td.addEventListener('click', () => openCellEditorForUploadedData(rowIndex, colIndex));
                    }
                    
                    tr.appendChild(td);
                });
                
                dataTableBody.appendChild(tr);
            });
            
            // อัพเดตข้อมูลตาราง
            currentColumns.textContent = selectedColumns.length;
            updateDataStatus();
        }
        
        function getTypeDisplayName(type) {
            const names = {
                'text': 'ข้อความ',
                'number': 'ตัวเลข',
                'date': 'วันที่',
                'enum': 'ค่าที่กำหนด',
                'identifier': 'รหัส'
            };
            return names[type] || type;
        }
        
        function getTypeColor(type) {
            const colors = {
                'text': '#1565c0',
                'number': '#2e7d32',
                'date': '#ef6c00',
                'enum': '#7b1fa2',
                'identifier': '#00695c'
            };
            return colors[type] || '#6c757d';
        }
        
        function updateDashboard() {
            const total = currentValidationResults.totalCells;
            const valid = currentValidationResults.validCells;
            const warning = currentValidationResults.warningCells;
            const error = currentValidationResults.errorCells;
            
            // คำนวณเปอร์เซ็นต์
            const validPercent = total > 0 ? Math.round((valid / total) * 100) : 0;
            const warningPercent = total > 0 ? Math.round((warning / total) * 100) : 0;
            const errorPercent = total > 0 ? Math.round((error / total) * 100) : 0;
            
            // อัพเดต Dashboard
            correctDataPercent.textContent = `${validPercent}%`;
            needReviewCount.textContent = warning;
            errorDataCount.textContent = error;
            
            // ✅ แก้ไข: แสดงปุ่ม "ต้องตรวจสอบ" ถ้ามีข้อมูลที่ต้องตรวจสอบ
            if (warning > 0) {
                showReviewBtn.style.display = 'inline-block';
                showReviewBtn.addEventListener('click', showReviewRows);
            } else {
                showReviewBtn.style.display = 'none';
            }
            
            // อัพเดต Progress bars
            correctDataBar.style.width = `${validPercent}%`;
            needReviewBar.style.width = `${warningPercent}%`;
            errorDataBar.style.width = `${errorPercent}%`;
            
            // อัพเดตจำนวนเซลล์ที่แก้ไขแล้ว
            const editedCount = countEditedCells();
            editedCellsCount.textContent = editedCount;
            const editedPercent = total > 0 ? Math.round((editedCount / total) * 100) : 0;
            editedCellsBar.style.width = `${Math.min(editedPercent, 100)}%`;
            
            // ✅ แก้ไข: ต้องมีข้อมูลถูกต้อง 100% จึงจะไปขั้นตอนต่อไปได้
            nextToStep4.disabled = validPercent !== 100 || error > 0;
        }
        
        function countEditedCells() {
            let count = 0;
            for (let rowIndex in cellValidationStatus) {
                for (let colIndex in cellValidationStatus[rowIndex]) {
                    if (cellValidationStatus[rowIndex][colIndex].edited) {
                        count++;
                    }
                }
            }
            return count;
        }
        function showAllErrorRows() {
    if (!uploadedData || !selectedColumns || selectedColumns.length === 0) return;
    
    // ล้างตารางเดิม
    dataTableBody.innerHTML = '';
    
    let errorRowCount = 0;
    const allRows = uploadedData.data;
    
    // แสดงแถวทั้งหมดและตรวจสอบข้อผิดพลาด
    allRows.forEach((row, rowIndex) => {
        let hasError = false;
        let errorCells = [];
        
        // ตรวจสอบแต่ละเซลล์ในแถว
        selectedColumns.forEach((columnName, colIndex) => {
            const cellValue = row[columnName] || '';
            const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, cellValue);
            const validation = validateCellData(columnName, cellValue, columnType, rowIndex, colIndex);
            
            if (validation.status === 'error') {
                hasError = true;
                errorCells.push({
                    column: columnName,
                    value: cellValue,
                    message: validation.message,
                    colIndex: colIndex
                });
            }
        });
        
        // ถ้าแถวนี้มีข้อผิดพลาด ให้แสดง
        if (hasError) {
            errorRowCount++;
            const tr = document.createElement('tr');
            tr.style.backgroundColor = 'rgba(255, 235, 238, 0.5)'; // สีพื้นหลังแดงอ่อน
            tr.classList.add('error-row');
            
            // เพิ่มหมายเลขแถว
            const rowNumCell = document.createElement('td');
            rowNumCell.textContent = rowIndex + 1;
            rowNumCell.style.fontWeight = 'bold';
            rowNumCell.style.color = '#d32f2f';
            tr.appendChild(rowNumCell);
            
            // เพิ่มข้อมูลแต่ละเซลล์
            selectedColumns.forEach((columnName, colIndex) => {
                const td = document.createElement('td');
                const cellValue = row[columnName] || '';
                td.textContent = cellValue;
                
                // ตรวจสอบประเภทที่ควรใช้
                const effectiveType = userSelectedDataTypes[columnName] || 
                                     detectColumnType(columnName, cellValue);
                
                // ตรวจสอบข้อมูล
                const validation = validateCellData(columnName, cellValue, effectiveType, rowIndex, colIndex);
                
                // เพิ่มคลาสตามสถานะการตรวจสอบ
                if (validation.status === 'error') {
                    td.className = 'cell-error cell-highlight';
                    td.title = validation.message;
                    td.style.fontWeight = 'bold';
                    td.style.color = '#d32f2f';
                    td.style.backgroundColor = 'rgba(255, 205, 210, 0.5)';
                } else if (validation.status === 'warning') {
                    td.className = 'cell-warning cell-highlight';
                    td.title = validation.message;
                } else {
                    td.className = 'cell-valid';
                }
                
                // เพิ่มข้อมูลสำหรับการแก้ไข
                td.dataset.row = rowIndex;
                td.dataset.col = colIndex;
                td.dataset.column = columnName;
                td.dataset.value = cellValue;
                td.dataset.type = effectiveType;
                
                // Event listener สำหรับการแก้ไข
                if (validation.status === 'error' || validation.status === 'warning') {
                    td.style.cursor = 'pointer';
                    td.addEventListener('click', () => openCellEditorForUploadedData(rowIndex, colIndex));
                }
                
                tr.appendChild(td);
            });
            
            dataTableBody.appendChild(tr);
            
            // เพิ่มแถวแสดงรายละเอียดข้อผิดพลาด
            if (errorCells.length > 0) {
                const errorDetailRow = document.createElement('tr');
                errorDetailRow.style.backgroundColor = '#fff8e1';
                errorDetailRow.classList.add('error-detail-row');
                
                const detailCell = document.createElement('td');
                detailCell.colSpan = selectedColumns.length + 1;
                detailCell.style.padding = '10px 15px';
                detailCell.style.fontSize = '0.9rem';
                detailCell.style.color = '#e65100';
                detailCell.style.borderTop = '1px dashed #ffcc80';
                
                let detailHTML = '<div style="display: flex; align-items: center; gap: 10px;">';
                detailHTML += '<i class="fas fa-exclamation-circle" style="color: #f44336;"></i>';
                detailHTML += '<div>';
                detailHTML += `<strong>แถวที่ ${rowIndex + 1} มี ${errorCells.length} ข้อผิดพลาด:</strong>`;
                detailHTML += '<ul style="margin: 5px 0 0 20px;">';
                
                errorCells.forEach((error, idx) => {
                    detailHTML += `<li><strong>${error.column}:</strong> "${error.value}" - ${error.message}</li>`;
                });
                
                detailHTML += '</ul>';
                detailHTML += '</div>';
                detailHTML += '</div>';
                
                detailCell.innerHTML = detailHTML;
                errorDetailRow.appendChild(detailCell);
                dataTableBody.appendChild(errorDetailRow);
            }
        }
    });
    
    // อัพเดตจำนวนแถวที่แสดง
    currentRows.textContent = errorRowCount;
    
    // แสดงข้อความสรุป
    if (errorRowCount === 0) {
        const noErrorRow = document.createElement('tr');
        const noErrorCell = document.createElement('td');
        noErrorCell.colSpan = selectedColumns.length + 1;
        noErrorCell.style.textAlign = 'center';
        noErrorCell.style.padding = '30px';
        noErrorCell.style.color = '#4caf50';
        noErrorCell.innerHTML = `
            <i class="fas fa-check-circle fa-2x" style="margin-bottom: 15px;"></i>
            <h3>ไม่มีข้อผิดพลาดที่ต้องแก้ไข</h3>
            <p>ข้อมูลทั้งหมดถูกต้องเรียบร้อยแล้ว</p>
            <button class="btn btn-success" id="showAllDataAgainBtn" style="margin-top: 15px;">
                <i class="fas fa-list"></i> แสดงข้อมูลทั้งหมด
            </button>
        `;
        noErrorRow.appendChild(noErrorCell);
        dataTableBody.appendChild(noErrorRow);
        
        // เพิ่ม event listener สำหรับปุ่มแสดงข้อมูลทั้งหมด
        setTimeout(() => {
            document.getElementById('showAllDataAgainBtn').addEventListener('click', function() {
                renderDataTableFromUploadedData();
            });
        }, 100);
    } else {
        const summaryRow = document.createElement('tr');
        const summaryCell = document.createElement('td');
        summaryCell.colSpan = selectedColumns.length + 1;
        summaryCell.style.textAlign = 'center';
        summaryCell.style.padding = '15px';
        summaryCell.style.backgroundColor = '#ffebee';
        summaryCell.style.color = '#d32f2f';
        summaryCell.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="text-align: left;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>พบ ${errorRowCount} แถวที่มีข้อผิดพลาดที่ต้องแก้ไข</strong>
                    <p style="margin: 5px 0 0 0; font-size: 0.9rem;">
                        คลิกที่เซลล์สีแดงเพื่อแก้ไขข้อมูล
                    </p>
                </div>
                <div>
                    <button class="btn btn-primary" id="fixSelectedErrorsBtn">
                        <i class="fas fa-robot"></i> AI ช่วยแก้ไขที่เลือก
                    </button>
                    <button class="btn btn-success" id="showAllDataBtn2">
                        <i class="fas fa-list"></i> แสดงข้อมูลทั้งหมด
                    </button>
                </div>
            </div>
        `;
        summaryRow.appendChild(summaryCell);
        dataTableBody.appendChild(summaryRow);
        
        // เพิ่ม event listener สำหรับปุ่มต่างๆ
        setTimeout(() => {
            // ปุ่ม AI ช่วยแก้ไขที่เลือก
            document.getElementById('fixSelectedErrorsBtn').addEventListener('click', function() {
                if (confirm('ต้องการให้ AI ช่วยแก้ไขข้อผิดพลาดในแถวที่แสดงอยู่หรือไม่?')) {
                    autoFixVisibleErrors();
                }
            });
            
            // ปุ่มแสดงข้อมูลทั้งหมด
            document.getElementById('showAllDataBtn2').addEventListener('click', function() {
                renderDataTableFromUploadedData();
            });
        }, 100);
    }
    
    // อัพเดตสถานะตาราง
    dataStatus.innerHTML = `<span style="color: #d32f2f;">
        <i class="fas fa-exclamation-triangle"></i> แสดง ${errorRowCount} แถวที่มีข้อผิดพลาด
    </span>`;
    dataStatus.style.backgroundColor = 'rgba(255, 235, 238, 0.5)';
    
    return errorRowCount;
}
       / ✅ แก้ไข: ฟังก์ชันอัพเดตสถานะข้อมูลให้มีปุ่มคลิก
function updateDataStatus() {
    const errorCount = currentValidationResults.errorCells;
    const warningCount = currentValidationResults.warningCells;
    
    if (errorCount > 0) {
        dataStatus.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong style="color: var(--danger-color);">มี ${errorCount} ข้อผิดพลาดที่ต้องแก้ไข</strong>
                    <div style="margin-top: 5px;">
                        <button class="btn btn-sm btn-outline" id="showErrorsBtn" style="padding: 3px 10px; font-size: 0.85rem;">
                            <i class="fas fa-eye"></i> แสดงแถวที่มีข้อผิดพลาด
                        </button>
                        <button class="btn btn-sm btn-outline" id="showAllDataBtn3" style="padding: 3px 10px; font-size: 0.85rem; margin-left: 5px;">
                            <i class="fas fa-list"></i> แสดงข้อมูลทั้งหมด
                        </button>
                    </div>
                </div>
            </div>
        `;
        dataStatus.style.color = 'var(--danger-color)';
        dataStatus.style.backgroundColor = 'rgba(247, 37, 133, 0.1)';
        dataStatus.style.padding = '10px 15px';
        dataStatus.style.borderRadius = '8px';
        dataStatus.style.cursor = 'default';
        
        // เพิ่ม event listener สำหรับปุ่มต่างๆ
        setTimeout(() => {
            // ปุ่มแสดงแถวที่มีข้อผิดพลาด
            document.getElementById('showErrorsBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                showAllErrorRows();
                alert(`แสดงแถวที่มีข้อผิดพลาดทั้งหมด ${errorCount} ข้อผิดพลาด`);
            });
            
            // ปุ่มแสดงข้อมูลทั้งหมด
            document.getElementById('showAllDataBtn3').addEventListener('click', function(e) {
                e.stopPropagation();
                renderDataTableFromUploadedData();
            });
        }, 100);
    } else if (warningCount > 0) {
        dataStatus.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-exclamation-circle" style="color: var(--warning-color);"></i>
                <div>
                    <strong style="color: var(--warning-color);">มี ${warningCount} รายการที่ต้องตรวจสอบ</strong>
                    <div style="margin-top: 5px;">
                        <button class="btn btn-sm btn-outline" id="showWarningsBtn" style="padding: 3px 10px; font-size: 0.85rem;">
                            <i class="fas fa-eye"></i> แสดงแถวที่ต้องตรวจสอบ
                        </button>
                    </div>
                </div>
            </div>
        `;
        dataStatus.style.color = 'var(--warning-color)';
        dataStatus.style.backgroundColor = 'rgba(255, 152, 0, 0.1)';
        dataStatus.style.padding = '10px 15px';
        dataStatus.style.borderRadius = '8px';
        
        // เพิ่ม event listener สำหรับปุ่มแสดงแถวที่ต้องตรวจสอบ
        setTimeout(() => {
            document.getElementById('showWarningsBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                showReviewRows();
            });
        }, 100);
    } else {
        dataStatus.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                <div>
                    <strong style="color: var(--success-color);">ข้อมูลถูกต้องทั้งหมด (100%)</strong>
                    <div style="margin-top: 5px;">
                        <button class="btn btn-sm btn-outline" id="showAllDataBtn4" style="padding: 3px 10px; font-size: 0.85rem;">
                            <i class="fas fa-list"></i> แสดงข้อมูลทั้งหมด
                        </button>
                    </div>
                </div>
            </div>
        `;
        dataStatus.style.color = 'var(--success-color)';
        dataStatus.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
        dataStatus.style.padding = '10px 15px';
        dataStatus.style.borderRadius = '8px';
        
        // เพิ่ม event listener สำหรับปุ่มแสดงข้อมูลทั้งหมด
        setTimeout(() => {
            document.getElementById('showAllDataBtn4').addEventListener('click', function(e) {
                e.stopPropagation();
                renderDataTableFromUploadedData();
            });
        }, 100);
    }
} 
        // ✅ ฟังก์ชันใหม่: เพิ่มฟิลเตอร์ Dropdown ในหัวตาราง
        function addColumnFilterDropdowns() {
            const headerRow = document.getElementById('dataTableHeader').querySelector('tr');
            if (!headerRow) return;
            
            // ตรวจสอบว่ามีฟิลเตอร์อยู่แล้วหรือไม่
            if (headerRow.querySelector('.filter-dropdown')) {
                return;
            }
            
            // สร้างแถวที่สองสำหรับฟิลเตอร์
            const filterRow = document.createElement('tr');
            
            // เซลล์หมายเลขแถว
            const rowNumFilterCell = document.createElement('td');
            rowNumFilterCell.style.padding = '5px';
            rowNumFilterCell.innerHTML = '<button class="btn btn-sm btn-outline" id="clearFilters" style="font-size: 0.7rem; padding: 3px 8px;">ล้าง</button>';
            filterRow.appendChild(rowNumFilterCell);
            
            // สร้างฟิลเตอร์สำหรับแต่ละคอลัมน์
            selectedColumns.forEach((columnName, index) => {
                const filterCell = document.createElement('td');
                filterCell.style.padding = '5px';
                
                // ดึงค่าที่ไม่ซ้ำกันสำหรับคอลัมน์นี้ (ตัวอย่าง 100 แถวแรก)
                const uniqueValues = [];
                const sampleRows = uploadedData.data.slice(0, Math.min(100, uploadedData.data.length));
                const valueSet = new Set();
                
                sampleRows.forEach(row => {
                    const value = row[columnName] || '';
                    if (value.trim() !== '' && !valueSet.has(value)) {
                        valueSet.add(value);
                        uniqueValues.push(value);
                    }
                });
                
                // สร้าง dropdown
                const filterSelect = document.createElement('select');
                filterSelect.className = 'filter-dropdown';
                filterSelect.dataset.columnIndex = index;
                filterSelect.dataset.columnName = columnName;
                
                // เพิ่มตัวเลือก
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'ทั้งหมด';
                filterSelect.appendChild(defaultOption);
                
                // เพิ่มตัวเลือกจากค่าที่ไม่ซ้ำกัน (จำกัดที่ 50 รายการ)
                uniqueValues.slice(0, 50).forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value.length > 30 ? value.substring(0, 27) + '...' : value;
                    filterSelect.appendChild(option);
                });
                
                filterSelect.addEventListener('change', function() {
                    filterTableRowsByDropdown();
                });
                
                filterCell.appendChild(filterSelect);
                filterRow.appendChild(filterCell);
            });
            
            headerRow.parentNode.insertBefore(filterRow, headerRow.nextSibling);
            
            // เพิ่ม event listener สำหรับปุ่มล้าง
            document.getElementById('clearFilters').addEventListener('click', function() {
                clearAllFilters();
            });
        }
        
        function filterTableRowsByDropdown() {
            const filterSelects = document.querySelectorAll('.filter-dropdown');
            const rows = document.querySelectorAll('#dataTableBody tr');
            
            rows.forEach(row => {
                let shouldShow = true;
                
                filterSelects.forEach((filterSelect, index) => {
                    const filterValue = filterSelect.value;
                    if (filterValue === '') return;
                    
                    // ดึงค่าจากเซลล์ (ข้ามเซลล์แรกที่เป็นหมายเลขแถว)
                    const cell = row.children[index + 1]; // +1 เพราะข้ามเซลล์หมายเลขแถว
                    if (cell) {
                        const cellValue = cell.textContent;
                        if (cellValue !== filterValue) {
                            shouldShow = false;
                        }
                    }
                });
                
                row.style.display = shouldShow ? '' : 'none';
            });
        }
        
        function clearAllFilters() {
            const filterSelects = document.querySelectorAll('.filter-dropdown');
            filterSelects.forEach(select => {
                select.value = '';
            });
            
            const rows = document.querySelectorAll('#dataTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // ✅ ฟังก์ชันใหม่: แสดงเฉพาะแถวที่มีข้อผิดพลาด
      function showErrorRowsOnly() {
    showAllErrorRows();}
            
            rows.forEach(row => {
                let hasError = false;
                const cells = row.querySelectorAll('td');
                
                cells.forEach(cell => {
                    if (cell.classList.contains('cell-error')) {
                        hasError = true;
                    }
                });
                
                if (hasError) {
                    row.style.display = '';
                    errorRowCount++;
                    row.style.backgroundColor = 'rgba(255, 235, 238, 0.5)';
                } else {
                    row.style.display = 'none';
                }
            });
            
            if (errorRowCount > 0) {
                const tableControls = document.querySelector('.data-table-controls');
                if (!document.getElementById('showAllRowsBtn')) {
                    const showAllBtn = document.createElement('button');
                    showAllBtn.id = 'showAllRowsBtn';
                    showAllBtn.className = 'btn btn-outline btn-sm';
                    showAllBtn.innerHTML = '<i class="fas fa-list"></i> แสดงทั้งหมด';
                    showAllBtn.style.marginLeft = '10px';
                    showAllBtn.addEventListener('click', function() {
                        showAllRowsInTable();
                    });
                    
                    const tableActions = document.querySelector('.table-actions');
                    if (tableActions) {
                        tableActions.appendChild(showAllBtn);
                    }
                }
                
                alert(`แสดงเฉพาะแถวที่มีข้อผิดพลาด: ${errorRowCount} แถว`);
            }
        }
        function autoFixVisibleErrors() {
    const errorRows = document.querySelectorAll('.error-row');
    let fixedCount = 0;
    
    errorRows.forEach((row, rowIndex) => {
        const cells = row.querySelectorAll('td.cell-error');
        
        cells.forEach((cell, cellIndex) => {
            const rowIndex = parseInt(cell.dataset.row);
            const colIndex = parseInt(cell.dataset.col);
            const columnName = cell.dataset.column;
            const currentValue = cell.dataset.value;
            
            if (!uploadedData || !uploadedData.data[rowIndex]) return;
            
            // หาค่าใหม่ที่เหมาะสม
            let newValue = currentValue;
            const columnNameLower = columnName.toLowerCase();
            
            // ✅ แก้ไขสำหรับคอลัมน์ "ชื่อประเภทอ้อย"
            if (columnNameLower === 'ชื่อประเภทอ้อย') {
                // พยายามหาค่าที่ใกล้เคียง
                let bestMatch = null;
                let bestScore = 0;
                
                ALLOWED_CANE_TYPES.forEach(validType => {
                    const similarity = calculateSimilarity(currentValue, validType);
                    if (similarity > bestScore && similarity > 0.3) {
                        bestScore = similarity;
                        bestMatch = validType;
                    }
                });
                
                if (bestMatch) {
                    newValue = bestMatch;
                } else {
                    newValue = ALLOWED_CANE_TYPES[0];
                }
            }
            // ✅ แก้ไขสำหรับคอลัมน์ "ประเภทอ้อย"
            else if (columnNameLower === 'ประเภทอ้อย') {
                const numValue = parseFloat(currentValue);
                if (isNaN(numValue)) {
                    newValue = "101";
                } else {
                    let closest = sugarcaneNumbers[0];
                    let minDiff = Math.abs(numValue - parseInt(closest));
                    
                    sugarcaneNumbers.forEach(num => {
                        const diff = Math.abs(numValue - parseInt(num));
                        if (diff < minDiff) {
                            minDiff = diff;
                            closest = num;
                        }
                    });
                    
                    newValue = closest;
                }
            }
            // แก้ไขตัวเลขทั่วไป
            else if (isNaN(currentValue) && currentValue.trim() !== '') {
                if (columnNameLower === 'lat') {
                    newValue = '13.7563';
                } else if (columnNameLower === 'long') {
                    newValue = '100.5018';
                } else if (columnName.includes('พื้นที่')) {
                    newValue = '10.0';
                } else if (columnName.includes('อายุ')) {
                    newValue = '120';
                } else {
                    newValue = '0';
                }
            }
            
            // ถ้าค่าเปลี่ยน ให้อัพเดต
            if (newValue !== currentValue) {
                uploadedData.data[rowIndex][columnName] = newValue;
                fixedCount++;
                
                // อัพเดตเซลล์
                cell.textContent = newValue;
                cell.dataset.value = newValue;
                
                // ตรวจสอบใหม่
                const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, newValue);
                const newValidation = validateCellData(columnName, newValue, columnType, rowIndex, colIndex);
                
                // อัพเดตคลาส
                cell.className = '';
                if (newValidation.status === 'error') {
                    cell.className = 'cell-error cell-highlight';
                    cell.title = newValidation.message;
                } else if (newValidation.status === 'warning') {
                    cell.className = 'cell-warning cell-highlight';
                    cell.title = newValidation.message;
                } else {
                    cell.className = 'cell-valid';
                    cell.style.color = '#4caf50';
                    cell.style.fontWeight = 'normal';
                    cell.style.backgroundColor = '';
                }
            }
        });
    });
    
    if (fixedCount > 0) {
        // รันการตรวจสอบใหม่
        runDataValidationFromUploadedData();
        updateDashboard();
        
        alert(`✅ AI ได้แก้ไขข้อผิดพลาด ${fixedCount} จุด`);
        
        // แสดงข้อผิดพลาดที่เหลือ (ถ้ามี)
        setTimeout(() => {
            const remainingErrors = document.querySelectorAll('.cell-error').length;
            if (remainingErrors > 0) {
                alert(`⚠️ ยังมีข้อผิดพลาดที่ต้องแก้ไขด้วยตนเอง: ${remainingErrors} จุด`);
            } else {
                alert(`🎉 แก้ไขข้อผิดพลาดทั้งหมดเรียบร้อยแล้ว!`);
                renderDataTableFromUploadedData();
            }
        }, 500);
    } else {
        alert('ไม่พบข้อผิดพลาดที่ AI สามารถแก้ไขได้อัตโนมัติ');
    }
}
        // ✅ ฟังก์ชันใหม่: แสดงเฉพาะแถวที่ต้องตรวจสอบ (warning)
        function showReviewRows() {
            const rows = document.querySelectorAll('#dataTableBody tr');
            let reviewRowCount = 0;
            
            rows.forEach(row => {
                let hasWarning = false;
                const cells = row.querySelectorAll('td');
                
                cells.forEach(cell => {
                    if (cell.classList.contains('cell-warning')) {
                        hasWarning = true;
                    }
                });
                
                if (hasWarning) {
                    row.style.display = '';
                    reviewRowCount++;
                    row.style.backgroundColor = 'rgba(255, 248, 225, 0.5)';
                } else {
                    row.style.display = 'none';
                }
            });
            
            if (reviewRowCount > 0) {
                const tableControls = document.querySelector('.data-table-controls');
                if (!document.getElementById('showAllRowsBtn')) {
                    const showAllBtn = document.createElement('button');
                    showAllBtn.id = 'showAllRowsBtn';
                    showAllBtn.className = 'btn btn-outline btn-sm';
                    showAllBtn.innerHTML = '<i class="fas fa-list"></i> แสดงทั้งหมด';
                    showAllBtn.style.marginLeft = '10px';
                    showAllBtn.addEventListener('click', function() {
                        showAllRowsInTable();
                    });
                    
                    const tableActions = document.querySelector('.table-actions');
                    if (tableActions) {
                        tableActions.appendChild(showAllBtn);
                    }
                }
                
                alert(`แสดงเฉพาะแถวที่ต้องตรวจสอบ: ${reviewRowCount} แถว`);
            }
        }
        
        function showAllRowsInTable() {
            const rows = document.querySelectorAll('#dataTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
                row.style.backgroundColor = '';
            });
            
            const showAllBtn = document.getElementById('showAllRowsBtn');
            if (showAllBtn) {
                showAllBtn.remove();
            }
        }
        
        // ✅ ฟังก์ชันสำหรับตัดแถวที่ว่างเปล่าทั้งหมด
        function removeEmptyRows() {
            if (!uploadedData || selectedColumns.length === 0) return 0;
            
            const originalRowCount = uploadedData.data.length;
            const filteredData = [];
            
            uploadedData.data.forEach(row => {
                // ตรวจสอบว่ามีข้อมูลอย่างน้อย 1 คอลัมน์ที่ไม่ว่าง
                let hasData = false;
                
                selectedColumns.forEach(columnName => {
                    const value = row[columnName] || '';
                    if (value.toString().trim() !== '') {
                        hasData = true;
                    }
                });
                
                if (hasData) {
                    filteredData.push(row);
                }
            });
            
            uploadedData.data = filteredData;
            uploadedData.totalRows = filteredData.length;
            
            const removedCount = originalRowCount - filteredData.length;
            if (removedCount > 0) {
                console.log(`✅ ตัดแถวที่ว่างทั้งหมดออกแล้ว: ${removedCount} แถว`);
            }
            
            return removedCount;
        }
        function runDataValidationFromUploadedData() {
    if (!uploadedData || selectedColumns.length === 0) return;
    
    // ✅ แก้ไข: ตัดแถวที่ว่างทั้งหมดออกก่อนตรวจสอบ
    const removedCount = removeEmptyRows();
    if (removedCount > 0) {
        console.log(`✅ ตัดแถวที่ว่างทั้งหมดออกแล้ว: ${removedCount} แถว`);
    }
    
    currentValidationResults = {
        totalCells: 0,
        validCells: 0,
        warningCells: 0,
        errorCells: 0,
        details: {}
    };
    
    cellValidationStatus = {};
    
    // ✅ แก้ไข: ใช้ข้อมูลทั้งหมด
    const allRows = uploadedData.data;
    totalCells = allRows.length * selectedColumns.length;
    
    // ตรวจสอบแต่ละเซลล์ในข้อมูลที่อัปโหลด
    allRows.forEach((row, rowIndex) => {
        selectedColumns.forEach((columnName, colIndex) => {
            const cellValue = row[columnName] || '';
            
            // ✅ แก้ไข: ถ้าค่าเป็นช่องว่าง ให้ผ่านได้เลย
            if (cellValue.trim() === '') {
                if (!cellValidationStatus[rowIndex]) {
                    cellValidationStatus[rowIndex] = {};
                }
                cellValidationStatus[rowIndex][colIndex] = {
                    status: 'valid',
                    message: 'ค่าว่าง - ผ่าน',
                    suggestions: [],
                    dataType: 'text',
                    edited: false
                };
                
                currentValidationResults.totalCells++;
                currentValidationResults.validCells++;
                return;
            }
            
            // ใช้ประเภทข้อมูลที่ผู้ใช้เลือก หรือตรวจจับอัตโนมัติ
            const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, cellValue);
            const validation = validateCellData(columnName, cellValue, columnType, rowIndex, colIndex);
            
            // บันทึกผลการตรวจสอบ
            if (!cellValidationStatus[rowIndex]) {
                cellValidationStatus[rowIndex] = {};
            }
            
            cellValidationStatus[rowIndex][colIndex] = validation;
            
            // นับสถิติ
            currentValidationResults.totalCells++;
            
            if (validation.status === 'valid') {
                currentValidationResults.validCells++;
            } else if (validation.status === 'warning') {
                currentValidationResults.warningCells++;
            } else if (validation.status === 'error') {
                currentValidationResults.errorCells++;
            }
            
            // บันทึกรายละเอียด
            if (!currentValidationResults.details[columnName]) {
                currentValidationResults.details[columnName] = {
                    errors: [],
                    warnings: []
                };
            }
            
            if (validation.status === 'error') {
                currentValidationResults.details[columnName].errors.push({
                    row: rowIndex + 1,
                    value: cellValue,
                    message: validation.message
                });
            } else if (validation.status === 'warning') {
                currentValidationResults.details[columnName].warnings.push({
                    row: rowIndex + 1,
                    value: cellValue,
                    message: validation.message
                });
            }
        });
    });
    
        // ============================================
        // ตั้งค่า Event Listeners สำหรับฟังก์ชันเพิ่มเติม (Step 3)
        // ============================================
       // ✅ แก้ไข: ในฟังก์ชัน setupEnhancedEventListeners() ให้เพิ่มปุ่มแสดงข้อผิดพลาด
function setupEnhancedEventListeners() {
    // Dashboard buttons
    refreshDashboard.addEventListener('click', () => {
        if (uploadedData) {
            runDataValidationFromUploadedData();
            updateDashboard();
            alert('✅ อัพเดต Dashboard เรียบร้อยแล้ว');
        }
    });
    
    fixAllErrors.addEventListener('click', () => {
        if (uploadedData) {
            if (confirm('AI จะพยายามแก้ไขข้อผิดพลาดทั้งหมดอัตโนมัติ\nยืนยันดำเนินการ?')) {
                autoFixAllErrorsForUploadedData();
            }
        }
    });
    
    // เพิ่มปุ่มใน Dashboard สำหรับแสดงข้อผิดพลาด
    showReviewBtn.addEventListener('click', () => {
        if (currentValidationResults.warningCells > 0) {
            showReviewRows();
        } else {
            alert('ไม่มีข้อมูลที่ต้องตรวจสอบ (warning)');
        }
    });
    
    // Cell editor modal
    saveEdit.addEventListener('click', () => {
        if (uploadedData && editingCell) {
            saveCellEditForUploadedData();
        }
    });
    
    cancelEdit.addEventListener('click', closeCellEditor);
    closeModal.addEventListener('click', closeCellEditor);
    
    // ปิด modal เมื่อคลิกนอก
    cellEditorModal.addEventListener('click', (e) => {
        if (e.target === cellEditorModal) {
            closeCellEditor();
        }
    });
    
    // Data Type Configuration
    showDataTypeConfig.addEventListener('click', showDataTypeConfiguration);
    
    autoDetectTypes.addEventListener('click', autoDetectDataTypes);
    
    applyDataTypes.addEventListener('click', function() {
        dataTypeConfigVisible = false;
        dataTypeConfig.style.display = 'none';
        
        // รันการตรวจสอบใหม่ด้วยประเภทข้อมูลที่ตั้งค่า
        if (uploadedData) {
            runDataValidationFromUploadedData();
            alert('✅ ใช้การตั้งค่าประเภทข้อมูลเรียบร้อย!');
        }
    });
    
    // Table actions
    showAllRows.addEventListener('click', toggleAllRows);
    
    exportTable.addEventListener('click', exportTableToCSV);
    
    // ✅ เพิ่ม: ปุ่มแสดงข้อผิดพลาดในตาราง
    const tableActions = document.querySelector('.table-actions');
    if (tableActions && !document.getElementById('showErrorsTableBtn')) {
        const showErrorsBtn = document.createElement('button');
        showErrorsBtn.id = 'showErrorsTableBtn';
        showErrorsBtn.className = 'btn btn-outline btn-sm';
        showErrorsBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> แสดงข้อผิดพลาด';
        showErrorsBtn.style.marginLeft = '10px';
        showErrorsBtn.addEventListener('click', function() {
            if (currentValidationResults.errorCells > 0) {
                showAllErrorRows();
            } else {
                alert('ไม่มีข้อผิดพลาดที่ต้องแสดง');
            }
        });
        tableActions.appendChild(showErrorsBtn);
    }
    
    // ปุ่มต่อไปใน Step 3
    nextToStep4.addEventListener('click', () => {
        if (currentValidationResults.errorCells > 0) {
            alert('ยังมีข้อผิดพลาดที่ต้องแก้ไข กรุณาตรวจสอบเซลล์สีแดง');
            showAllErrorRows(); // แสดงข้อผิดพลาดอัตโนมัติ
            return;
        }
        
        // ✅ แก้ไข: ตรวจสอบว่าข้อมูลถูกต้อง 100% หรือไม่
        const validPercent = parseInt(correctDataPercent.textContent);
        if (validPercent !== 100) {
            alert(`ข้อมูลถูกต้อง ${validPercent}% ยังไม่ครบ 100% กรุณาตรวจสอบและแก้ไขข้อมูลให้ถูกต้องทั้งหมด`);
            return;
        }
        
        const editedCount = countEditedCells();
        
        alert(`✅ ตรวจสอบข้อมูลเสร็จสมบูรณ์\n✅ แก้ไขข้อมูลแล้ว: ${editedCount} เซลล์\n✅ ข้อมูลถูกต้อง: 100%\n\nกำลังไปยังขั้นตอนต่อไป...`);
        
        // ไปยังขั้นตอนที่ 4
        goToStep(4);
    });
}
        
        // ฟังก์ชันเพิ่มเติมสำหรับ Step 3
        function showDataTypeConfiguration() {
            dataTypeConfigVisible = true;
            dataTypeConfig.style.display = 'block';
            renderDataTypeConfigurationTable();
        }
        
        function renderDataTypeConfigurationTable() {
            if (!uploadedData || selectedColumns.length === 0) return;
            
            const tableBody = document.getElementById('dataTypeTableBody');
            tableBody.innerHTML = '';
            
            selectedColumns.forEach((columnName) => {
                const row = document.createElement('tr');
                
                // หาตัวอย่างข้อมูล
                const sampleValues = uploadedData.data.slice(0, 5).map(row => row[columnName] || '');
                const nonEmptySamples = sampleValues.filter(v => v.trim() !== '');
                const sampleText = nonEmptySamples.length > 0 ? nonEmptySamples[0] : '(ค่าว่าง)';
                
                // ตรวจจับประเภทอัตโนมัติ
                const columnNameLower = columnName.toLowerCase();
                let currentType;
                
                // ✅ แก้ไข: กำหนดประเภทเริ่มต้นสำหรับคอลัมน์พิเศษ
                if (columnNameLower === 'ชื่อประเภทอ้อย') {
                    currentType = 'text';
                } else if (columnNameLower === 'ประเภทอ้อย') {
                    currentType = 'number';
                } else {
                    const autoType = detectColumnType(columnName, sampleText);
                    currentType = userSelectedDataTypes[columnName] || autoType;
                }
                
                row.innerHTML = `
                    <td><strong>${columnName}</strong></td>
                    <td class="data-sample-cell" title="${sampleText}">${sampleText}</td>
                    <td>
                        <select class="type-select" data-column="${columnName}">
                            <option value="text" ${currentType === 'text' ? 'selected' : ''}>ข้อความ</option>
                            <option value="number" ${currentType === 'number' ? 'selected' : ''}>ตัวเลข</option>
                            <option value="date" ${currentType === 'date' ? 'selected' : ''}>วันที่</option>
                            <option value="enum" ${currentType === 'enum' ? 'selected' : ''}>ค่าที่กำหนด</option>
                            <option value="identifier" ${currentType === 'identifier' ? 'selected' : ''}>รหัส</option>
                        </select>
                    </td>
                    <td>
                        <select class="format-select" data-column="${columnName}">
                            <option value="default" selected>ค่าเริ่มต้น</option>
                            ${currentType === 'number' ? 
                                '<option value="decimal">ทศนิยม</option><option value="integer">จำนวนเต็ม</option>' : 
                                currentType === 'date' ?
                                '<option value="YYYY-MM-DD">YYYY-MM-DD</option><option value="DD/MM/YYYY">DD/MM/YYYY</option><option value="YYYY/MM/DD">YYYY/MM/DD</option>' :
                                currentType === 'text' && columnNameLower === 'ชื่อประเภทอ้อย' ?
                                ALLOWED_CANE_TYPES.map(type => `<option value="${type}">${type}</option>`).join('') :
                                ''}
                        </select>
                    </td>
                    <td>
                        <select class="unit-select" data-column="${columnName}">
                            <option value="none" selected>ไม่มีหน่วย</option>
                            ${columnName.toLowerCase().includes('พื้นที่') ? 
                                '<option value="ไร่">ไร่</option><option value="งาน">งาน</option><option value="ตารางเมตร">ตร.ม.</option>' :
                                columnName.toLowerCase().includes('อายุ') ?
                                '<option value="วัน">วัน</option><option value="เดือน">เดือน</option><option value="ปี">ปี</option>' :
                                columnName.toLowerCase().includes('ปริมาณ') ?
                                '<option value="กิโลกรัม">กก.</option><option value="ตัน">ตัน</option>' : ''}
                        </select>
                    </td>
                    <td><input type="text" class="form-control" placeholder="คำอธิบาย..." value="${getColumnDescription(columnName)}"></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // เพิ่ม event listeners สำหรับ dropdown
            document.querySelectorAll('.type-select').forEach(select => {
                select.addEventListener('change', function() {
                    const column = this.dataset.column;
                    userSelectedDataTypes[column] = this.value;
                    
                    // อัพเดต format select ตามประเภท
                    const row = this.closest('tr');
                    const formatSelect = row.querySelector('.format-select');
                    const unitSelect = row.querySelector('.unit-select');
                    
                    // รีเซ็ต format
                    formatSelect.innerHTML = '<option value="default" selected>ค่าเริ่มต้น</option>';
                    
                    if (this.value === 'number') {
                        formatSelect.innerHTML += '<option value="decimal">ทศนิยม</option><option value="integer">จำนวนเต็ม</option>';
                    } else if (this.value === 'date') {
                        formatSelect.innerHTML += '<option value="YYYY-MM-DD">YYYY-MM-DD</option><option value="DD/MM/YYYY">DD/MM/YYYY</option><option value="YYYY/MM/DD">YYYY/MM/DD</option>';
                    } else if (this.value === 'text' && column.toLowerCase() === 'ชื่อประเภทอ้อย') {
                        ALLOWED_CANE_TYPES.forEach(type => {
                            formatSelect.innerHTML += `<option value="${type}">${type}</option>`;
                        });
                    }
                    
                    // รีเซ็ต unit
                    unitSelect.innerHTML = '<option value="none" selected>ไม่มีหน่วย</option>';
                    const colName = column.toLowerCase();
                    
                    if (colName.includes('พื้นที่')) {
                        unitSelect.innerHTML += '<option value="ไร่">ไร่</option><option value="งาน">งาน</option><option value="ตารางเมตร">ตร.ม.</option>';
                    } else if (colName.includes('อายุ')) {
                        unitSelect.innerHTML += '<option value="วัน">วัน</option><option value="เดือน">เดือน</option><option value="ปี">ปี</option>';
                    } else if (colName.includes('ปริมาณ')) {
                        unitSelect.innerHTML += '<option value="กิโลกรัม">กก.</option><option value="ตัน">ตัน</option>';
                    }
                });
            });
        }
        
        function getColumnDescription(columnName) {
            const descriptions = {
                'โซน': 'เขตพื้นที่',
                'รหัสนักเกษตร': 'รหัสประจำตัวนักเกษตร',
                'ชื่อนักเกษตร': 'ชื่อ-นามสกุลนักเกษตร',
                'ชื่อประเภทอ้อย': 'ประเภทของอ้อย เช่น ปลายฝนขยาย, ต้นฝนรื้อตอ',
                'ประเภทอ้อย': 'รหัสประเภทอ้อย เช่น 101, 102, 103, 104, 105',
                'เลขโควต้า': 'หมายเลขโควต้าที่ได้รับจัดสรร',
                'ชื่อชาวไร่': 'ชื่อ-นามสกุลชาวไร่',
                'เลขแปลงintech': 'หมายเลขแปลงในระบบ Intech',
                'lat': 'ค่าพิกัดละติจูด',
                'long': 'ค่าพิกัดลองจิจูด',
                'พื้นที่': 'ขนาดพื้นที่ปลูกอ้อย',
                'อายุ': 'อายุอ้อย (วัน)',
                'จำนวน': 'ปริมาณหรือจำนวน',
                'ปริมาณปุ๋ย': 'ปริมาณปุ๋ยที่ใช้',
                'โครงการ': 'ชื่อโครงการที่เกี่ยวข้อง',
                'วันที่ปลูก': 'วันที่ปลูกอ้อย',
                'ความเสี่ยงพื้นที่': 'ระดับความเสี่ยงของพื้นที่ปลูก',
                'ความลาดเอียงของพื้นที่': 'ความลาดเอียงของพื้นที่ปลูก'
            };
            
            // ค้นหาคำอธิบายจากชื่อคอลัมน์
            for (const key in descriptions) {
                if (columnName.toLowerCase().includes(key.toLowerCase())) {
                    return descriptions[key];
                }
            }
            
            return '';
        }
        
        function autoDetectDataTypes() {
            if (!uploadedData || selectedColumns.length === 0) return;
            
            selectedColumns.forEach(columnName => {
                const columnNameLower = columnName.toLowerCase();
                
                // ✅ แก้ไข: ตรวจจับคอลัมน์ "ชื่อประเภทอ้อย" เป็น text
                if (columnNameLower === 'ชื่อประเภทอ้อย') {
                    userSelectedDataTypes[columnName] = 'text';
                }
                // ✅ แก้ไข: ตรวจจับคอลัมน์ "ประเภทอ้อย" เป็น number
                else if (columnNameLower === 'ประเภทอ้อย') {
                    userSelectedDataTypes[columnName] = 'number';
                }
                // ตรวจจับประเภทอื่นๆ ตามตรรกะเดิม
                else {
                    const sampleValues = uploadedData.data.slice(0, 10).map(row => row[columnName] || '');
                    const nonEmptySamples = sampleValues.filter(v => v.trim() !== '');
                    
                    if (nonEmptySamples.length > 0) {
                        const detectedType = detectColumnType(columnName, nonEmptySamples[0]);
                        userSelectedDataTypes[columnName] = detectedType;
                    }
                }
            });
            
            renderDataTypeConfigurationTable();
            alert('✅ ตรวจจับประเภทข้อมูลอัตโนมัติเรียบร้อยแล้ว!');
        }
        
        function toggleAllRows() {
            isShowingAllRows = !isShowingAllRows;
            
            if (isShowingAllRows) {
                currentRowLimit = uploadedData.data.length;
                document.getElementById('toggleAllRows').innerHTML = 
                    `<i class="fas fa-compress"></i> ซ่อนบางส่วน (${currentRowLimit})`;
            } else {
                currentRowLimit = 50;
                document.getElementById('toggleAllRows').innerHTML = 
                    `<i class="fas fa-expand"></i> แสดงทั้งหมด (${uploadedData.data.length})`;
            }
            
            renderDataTableFromUploadedData();
        }
        
        function exportTableToCSV() {
            if (!uploadedData || selectedColumns.length === 0) return;
            
            // ✅ แก้ไข: ใช้คอลัมน์ตามลำดับเดิมในไฟล์ต้นฉบับ
            const exportColumns = [...uploadedData.headers].filter(col => 
                selectedColumns.includes(col)
            );
            
            // สร้าง CSV จากคอลัมน์ที่เลือก
            let csvContent = '';
            
            // เพิ่ม BOM สำหรับ UTF-8 เพื่อให้ Excel อ่านภาษาไทยได้ถูกต้อง
            csvContent += '\ufeff';
            
            // ✅ แก้ไข: ใช้คอลัมน์ตามลำดับเดิม
            csvContent += exportColumns.join(',') + '\n';
            
            // เพิ่มข้อมูลทั้งหมด
            uploadedData.data.forEach(row => {
                const rowValues = exportColumns.map(col => {
                    let value = row[col] || '';
                    
                    // แปลงอักขระพิเศษ
                    value = value.toString().replace(/"/g, '""'); // Escape quotes
                    
                    // ใส่ quotes ถ้ามี comma, newline หรือ quotes
                    if (value.includes(',') || value.includes('\n') || value.includes('\r') || value.includes('"')) {
                        value = `"${value}"`;
                    }
                    
                    return value;
                });
                csvContent += rowValues.join(',') + '\n';
            });
            
            // สร้าง blob และดาวน์โหลด
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `cleaned_${uploadedData.fileName.replace('.csv', '')}_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ ดาวน์โหลดไฟล์ CSV เรียบร้อย!\nจำนวนแถว: ${uploadedData.data.length}\nจำนวนคอลัมน์: ${exportColumns.length}\n✅ คอลัมน์เรียงตามลำดับเดิม`);
        }
        
        function openCellEditorForUploadedData(rowIndex, colIndex) {
            if (!uploadedData || !cellValidationStatus[rowIndex]) return;
            
            const columnName = selectedColumns[colIndex];
            const cell = document.querySelector(`td[data-row="${rowIndex}"][data-col="${colIndex}"]`);
            const currentValue = uploadedData.data[rowIndex][columnName] || '';
            const validation = cellValidationStatus[rowIndex][colIndex];
            const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, currentValue);
            
            // บันทึกข้อมูลเซลล์ที่กำลังแก้ไข
            editingCell = { rowIndex, colIndex, cell, columnName, currentValue, validation, columnType };
            
            // อัพเดตข้อมูลใน modal
            editColumnName.textContent = columnName;
            editRowNumber.textContent = rowIndex + 1;
            
            // ตั้งค่าประเภทข้อมูลใน dropdown
            editDataTypeSelect.value = columnType;
            
            editIssue.textContent = validation.message;
            editIssue.className = validation.status === 'error' ? 'error-text' : 'warning-text';
            
            // ตั้งค่าค่าใน input
            cellValueInput.value = currentValue;
            
            // ✅ แก้ไข: เพิ่มคำแนะนำเฉพาะสำหรับคอลัมน์พิเศษ
            valueSuggestions.innerHTML = '';
            
            if (columnName.toLowerCase() === 'ชื่อประเภทอ้อย') {
                valueSuggestions.innerHTML = `
                    <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 5px;">
                        <strong>คำแนะนำ:</strong> ${ALLOWED_CANE_TYPES.join(', ')}
                    </div>
                `;
                
                // เพิ่มคำแนะนำเป็นปุ่มคลิกได้
                ALLOWED_CANE_TYPES.forEach(suggestion => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'suggestion-item';
                    btn.textContent = suggestion;
                    btn.addEventListener('click', () => {
                        cellValueInput.value = suggestion;
                    });
                    valueSuggestions.appendChild(btn);
                });
            }
            else if (columnName.toLowerCase() === 'ประเภทอ้อย') {
                valueSuggestions.innerHTML = `
                    <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 5px;">
                        <strong>คำแนะนำ:</strong> ${sugarcaneNumbers.join(', ')}
                    </div>
                `;
                
                sugarcaneNumbers.forEach(suggestion => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'suggestion-item';
                    btn.textContent = suggestion;
                    btn.addEventListener('click', () => {
                        cellValueInput.value = suggestion;
                    });
                    valueSuggestions.appendChild(btn);
                });
            }
            else if (validation.suggestions && validation.suggestions.length > 0) {
                const suggestionTitle = document.createElement('div');
                suggestionTitle.textContent = 'คำแนะนำ:';
                suggestionTitle.style.fontSize = '0.8rem';
                suggestionTitle.style.color = '#6c757d';
                suggestionTitle.style.marginBottom = '5px';
                valueSuggestions.appendChild(suggestionTitle);
                
                validation.suggestions.forEach(suggestion => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'suggestion-item';
                    suggestionItem.textContent = suggestion;
                    suggestionItem.addEventListener('click', () => {
                        cellValueInput.value = suggestion;
                    });
                    valueSuggestions.appendChild(suggestionItem);
                });
            }
            
            // แสดง modal
            cellEditorModal.classList.add('show');
            cellValueInput.focus();
        }
        
        function saveCellEditForUploadedData() {
            if (!editingCell || !uploadedData) return;
            
            const newValue = cellValueInput.value.trim();
            const newDataType = editDataTypeSelect.value;
            const { rowIndex, colIndex, cell, columnName, currentValue, columnType } = editingCell;
            
            // อัพเดตประเภทข้อมูลถ้าผู้ใช้เปลี่ยน
            if (newDataType !== columnType) {
                userSelectedDataTypes[columnName] = newDataType;
            }
            
            // อัพเดตข้อมูล
            uploadedData.data[rowIndex][columnName] = newValue;
            
            // ตรวจสอบข้อมูลใหม่
            const newValidation = validateCellData(columnName, newValue, newDataType, rowIndex, colIndex);
            newValidation.edited = true;
            cellValidationStatus[rowIndex][colIndex] = newValidation;
            
            // อัพเดตเซลล์ในตาราง
            cell.textContent = newValue;
            cell.dataset.value = newValue;
            
            // อัพเดตคลาสตามสถานะใหม่
            cell.className = '';
            if (newValidation.status === 'error') {
                cell.className = 'cell-error cell-highlight';
                cell.title = newValidation.message;
            } else if (newValidation.status === 'warning') {
                cell.className = 'cell-warning cell-highlight';
                cell.title = newValidation.message;
            } else {
                cell.className = 'cell-valid';
            }
            
            // เปิดให้แก้ไขได้ถ้ายังมีปัญหา
            if (newValidation.status === 'error' || newValidation.status === 'warning') {
                cell.style.cursor = 'pointer';
                cell.addEventListener('click', () => openCellEditorForUploadedData(rowIndex, colIndex));
            }
            
            // รันการตรวจสอบใหม่
            runDataValidationFromUploadedData();
            
            // อัพเดต Dashboard และสถานะ
            updateDashboard();
            updateDataStatus();
            
            // ปิด modal
            closeCellEditor();
        }
        
        function closeCellEditor() {
            cellEditorModal.classList.remove('show');
            editingCell = null;
            cellValueInput.value = '';
            valueSuggestions.innerHTML = '';
        }
        
        function autoFixAllErrorsForUploadedData() {
            if (!uploadedData) return;
            
            let fixedCount = 0;
            const sampleRows = uploadedData.data.slice(0, currentRowLimit);
            
            sampleRows.forEach((row, rowIndex) => {
                selectedColumns.forEach((columnName, colIndex) => {
                    const validation = cellValidationStatus[rowIndex] ? cellValidationStatus[rowIndex][colIndex] : null;
                    
                    if (validation && validation.status === 'error') {
                        let cellValue = row[columnName] || '';
                        let fixedValue = cellValue;
                        const columnNameLower = columnName.toLowerCase();
                        const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, cellValue);
                        
                        // ✅ แก้ไข: AI แก้ไขสำหรับคอลัมน์ "ชื่อประเภทอ้อย"
                        if (columnNameLower === 'ชื่อประเภทอ้อย') {
                            // พยายามหาค่าที่ใกล้เคียง
                            let bestMatch = null;
                            let bestScore = 0;
                            
                            ALLOWED_CANE_TYPES.forEach(validType => {
                                // คำนวณความคล้ายคลึง
                                const similarity = calculateSimilarity(cellValue, validType);
                                if (similarity > bestScore && similarity > 0.3) {
                                    bestScore = similarity;
                                    bestMatch = validType;
                                }
                            });
                            
                            if (bestMatch) {
                                fixedValue = bestMatch;
                            } else {
                                // ถ้าไม่เจอค่าที่ใกล้เคียง ให้ใช้ค่าแรกในรายการ
                                fixedValue = ALLOWED_CANE_TYPES[0];
                            }
                        }
                        // ✅ แก้ไข: AI แก้ไขสำหรับคอลัมน์ "ประเภทอ้อย"
                        else if (columnNameLower === 'ประเภทอ้อย') {
                            // ลองแปลงเป็นตัวเลข
                            const numValue = parseFloat(cellValue);
                            if (isNaN(numValue)) {
                                // ถ้าไม่ใช่ตัวเลข ให้ใช้ค่าแรก
                                fixedValue = "101";
                            } else {
                                // หาค่าที่ใกล้เคียงที่สุด
                                let closest = sugarcaneNumbers[0];
                                let minDiff = Math.abs(numValue - parseInt(closest));
                                
                                sugarcaneNumbers.forEach(num => {
                                    const diff = Math.abs(numValue - parseInt(num));
                                    if (diff < minDiff) {
                                        minDiff = diff;
                                        closest = num;
                                    }
                                });
                                
                                fixedValue = closest;
                            }
                        }
                        else if (columnType === 'number' && isNaN(cellValue)) {
                            // ✅ แก้ไข: คอลัมน์ "ประเภทอ้อย" ใช้ค่า 101-105
                            if (columnName.toLowerCase().includes('ประเภทอ้อย')) {
                                fixedValue = '101'; // ค่าเริ่มต้นสำหรับประเภทอ้อย
                            } else if (columnName.toLowerCase() === 'lat') {
                                fixedValue = '13.7563'; // ค่า latitude ตัวอย่างสำหรับประเทศไทย
                            } else if (columnName.toLowerCase() === 'long') {
                                fixedValue = '100.5018'; // ค่า longitude ตัวอย่างสำหรับประเทศไทย
                            } else if (columnName.includes('พื้นที่')) {
                                fixedValue = '10.0';
                            } else if (columnName.includes('อายุ')) {
                                fixedValue = '120';
                            } else if (columnName.includes('โควต้า')) {
                                fixedValue = '100';
                            } else {
                                fixedValue = '0';
                            }
                        } else if (columnType === 'date' && !/^\d{4}-\d{1,2}-\d{1,2}$/.test(cellValue)) {
                            // พยายามแปลงรูปแบบวันที่
                            const dateMatch = cellValue.match(/(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})/);
                            if (dateMatch) {
                                const day = dateMatch[1].padStart(2, '0');
                                const month = dateMatch[2].padStart(2, '0');
                                const year = dateMatch[3];
                                fixedValue = `${year}/${month}/${day}`;
                            } else {
                                fixedValue = '2023/06/01';
                            }
                        }
                        
                        // บันทึกค่าที่แก้ไข
                        if (fixedValue !== cellValue) {
                            uploadedData.data[rowIndex][columnName] = fixedValue;
                            fixedCount++;
                            
                            // ทำเครื่องหมายว่าแก้ไขแล้ว
                            if (!cellValidationStatus[rowIndex]) {
                                cellValidationStatus[rowIndex] = {};
                            }
                            cellValidationStatus[rowIndex][colIndex].edited = true;
                        }
                    }
                });
            });
            
            // อัพเดตการตรวจสอบใหม่
            runDataValidationFromUploadedData();
            renderDataTableFromUploadedData();
            updateDashboard();
            updateDataStatus();
            
            alert(`AI ได้แก้ไขข้อผิดพลาด ${fixedCount} รายการ`);
        }
        
        // ฟังก์ชันช่วยคำนวณความคล้ายคลึง
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            return (longer.length - editDistance(longer, shorter)) / parseFloat(longer.length);
        }
        
        // ฟังก์ชันคำนวณระยะห่างระหว่างข้อความ
        function editDistance(s1, s2) {
            s1 = s1.toLowerCase();
            s2 = s2.toLowerCase();
            
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else {
                        if (j > 0) {
                            let newValue = costs[j - 1];
                            if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                                newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                            }
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }  
// ============================================
// ขั้นตอนที่ 4: ตรวจสอบเงื่อนไขข้อมูลอ้อย
// ============================================

// กำหนดค่าคงที่สำหรับการตรวจสอบ
const sugarcaneTypes = [
    "ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ต้นฝนขยาย", "ต้นฝนรื้อตอ",
    "ตอ1", "ตอ2", "ตอ3", ">ตอ3", "พันธุ์อ้อย", "ปลายฝน", "ต้นฝน", "บำรุงตอ"
];

// ช่วงวันที่สำหรับแต่ละประเภทอ้อย
const sugarcaneDateRanges = {
    // ช่วงปี 2568-2569
    "ปลายฝนขยาย": [
        { start: "2025-10-01", end: "2026-02-28", description: "ตุลาคม 2568 - กุมภาพันธ์ 2569", year: "2568-2569" },
        { start: "2024-10-01", end: "2025-01-31", description: "ตุลาคม 2567 - มกราคม 2568", year: "2567-2568" }
    ],
    "ปลายฝนรื้อตอ": [
        { start: "2025-10-01", end: "2026-02-28", description: "ตุลาคม 2568 - กุมภาพันธ์ 2569", year: "2568-2569" },
        { start: "2024-10-01", end: "2025-01-31", description: "ตุลาคม 2567 - มกราคม 2568", year: "2567-2568" }
    ],
    "ปลายฝน": [
        { start: "2025-10-01", end: "2026-02-28", description: "ตุลาคม 2568 - กุมภาพันธ์ 2569", year: "2568-2569" },
        { start: "2024-10-01", end: "2025-01-31", description: "ตุลาคม 2567 - มกราคม 2568", year: "2567-2568" }
    ],
    "ต้นฝนขยาย": [
        { start: "2026-03-01", end: "2026-06-30", description: "มีนาคม 2569 - มิถุนายน 2569", year: "2569" },
        { start: "2024-02-01", end: "2025-05-31", description: "กุมภาพันธ์ 2567 - พฤษภาคม 2568", year: "2567-2568" }
    ],
    "ต้นฝนรื้อตอ": [
        { start: "2026-03-01", end: "2026-06-30", description: "มีนาคม 2569 - มิถุนายน 2569", year: "2569" },
        { start: "2024-02-01", end: "2025-05-31", description: "กุมภาพันธ์ 2567 - พฤษภาคม 2568", year: "2567-2568" }
    ],
    "ต้นฝน": [
        { start: "2026-03-01", end: "2026-06-30", description: "มีนาคม 2569 - มิถุนายน 2569", year: "2569" },
        { start: "2024-02-01", end: "2025-05-31", description: "กุมภาพันธ์ 2567 - พฤษภาคม 2568", year: "2567-2568" }
    ],
    "พันธุ์อ้อย": [
        { start: "2026-06-01", end: "2026-07-31", description: "มิถุนายน 2569 - กรกฎาคม 2569", year: "2569" },
        { start: "2024-06-01", end: "2024-06-30", description: "1 มิถุนายน 2567 - 30 มิถุนายน 2567", year: "2567" }
    ],
    "ตอ1": [
        { start: "2025-12-01", end: "2026-03-31", description: "ธันวาคม 2568 - มีนาคม 2569", year: "2568-2569" },
        { start: "2024-12-01", end: "2025-03-31", description: "ธันวาคม 2567 - มีนาคม 2568", year: "2567-2568" }
    ],
    "ตอ2": [
        { start: "2025-12-01", end: "2026-03-31", description: "ธันวาคม 2568 - มีนาคม 2569", year: "2568-2569" },
        { start: "2024-12-01", end: "2025-03-31", description: "ธันวาคม 2567 - มีนาคม 2568", year: "2567-2568" }
    ],
    "ตอ3": [
        { start: "2025-12-01", end: "2026-03-31", description: "ธันวาคม 2568 - มีนาคม 2569", year: "2568-2569" },
        { start: "2024-12-01", end: "2025-03-31", description: "ธันวาคม 2567 - มีนาคม 2568", year: "2567-2568" }
    ],
    ">ตอ3": [
        { start: "2025-12-01", end: "2026-03-31", description: "ธันวาคม 2568 - มีนาคม 2569", year: "2568-2569" },
        { start: "2024-12-01", end: "2025-03-31", description: "ธันวาคม 2567 - มีนาคม 2568", year: "2567-2568" }
    ],
    "บำรุงตอ": [
        { start: "2025-12-01", end: "2026-03-31", description: "ธันวาคม 2568 - มีนาคม 2569", year: "2568-2569" },
        { start: "2024-12-01", end: "2025-03-31", description: "ธันวาคม 2567 - มีนาคม 2568", year: "2567-2568" }
    ]
};

// ฟังก์ชันแสดงชื่อเงื่อนไข
function getConditionDisplayName(condition) {
    const names = {
        "sugarcane": "ประเภทอ้อย",
        "fertilizer": "ปุ๋ย"
    };
    return names[condition] || condition;
}

// ฟังก์ชันค้นหาคอลัมน์จากรายชื่อ
function findColumnByName(columns, possibleNames) {
    for (const column of columns) {
        const columnLower = column.toLowerCase().trim();
        for (const name of possibleNames) {
            if (columnLower.includes(name.toLowerCase())) {
                return column;
            }
        }
    }
    return null;
}

// ฟังก์ชันแปลงวันที่
function parseDateString(dateStr) {
    if (!dateStr || dateStr.trim() === '') return null;
    
    try {
        const trimmedStr = dateStr.trim();
        let date;
        
        // รองรับรูปแบบ DD/MM/YYYY หรือ D/M/YYYY
        if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(trimmedStr)) {
            const parts = trimmedStr.split('/');
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const year = parseInt(parts[2]);
            
            date = new Date(year, month, day);
            
            if (date.getDate() !== day || date.getMonth() !== month || date.getFullYear() !== year) {
                return null;
            }
        }
        // รูปแบบ YYYY/MM/DD หรือ YYYY/M/D
        else if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(trimmedStr)) {
            const parts = trimmedStr.split('/');
            date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        }
        // รูปแบบ YYYY-MM-DD
        else if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(trimmedStr)) {
            const parts = trimmedStr.split('-');
            date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        }
        // รูปแบบ DD-MM-YYYY หรือ D-M-YYYY
        else if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(trimmedStr)) {
            const parts = trimmedStr.split('-');
            date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
        }
        // รูปแบบอื่นๆ
        else {
            date = new Date(trimmedStr);
        }
        
        if (isNaN(date.getTime())) {
            return null;
        }
        
        return date;
    } catch (error) {
        console.error('Error parsing date:', dateStr, error);
        return null;
    }
}

// อัพเดตฟังก์ชันสร้าง Badge สถานะ
function createStatusBadge(status) {
    let badgeClass = "status-info";
    let badgeText = status;
    
    if (status === "ผ่าน") {
        badgeClass = "status-valid";
        badgeText = "ผ่าน";
    } else if (status === "ไม่ผ่าน") {
        badgeClass = "status-error";
        badgeText = "ไม่ผ่าน";
    } else if (status === "ต้องตรวจสอบ" || status === "รอตรวจสอบ") {
        badgeClass = "status-warning";
        badgeText = "ต้องตรวจสอบ";
    } else if (status === "ไม่มีข้อมูลวันที่ปลูก") {
        badgeClass = "status-warning";
        badgeText = "ไม่มีข้อมูลวันที่ปลูก";
    } else if (status === "ไม่เข้าโครงการ") {
        badgeClass = "status-not-in-project";
        badgeText = "ไม่เข้าโครงการ";
    }
    
    return `<span class="status-badge ${badgeClass}">${badgeText}</span>`;
}
// ฟังก์ชันเตรียมตารางตรวจสอบประเภทอ้อย
function prepareSugarcaneCheckingTable() {
    const tableBody = document.getElementById('checkingTableBody');
    tableBody.innerHTML = '';
    
    // คอลัมน์ที่จำเป็น
    const requiredColumns = [
        { name: "เลขแปลงintech", keywords: ["แปลงintech", "แปลง intech", "แปลง"] },
        { name: "ชื่อประเภทอ้อย", keywords: ["ชื่อประเภทอ้อย", "ประเภทอ้อย", "พันธุ์อ้อย"] },
        { name: "วันที่ปลูก", keywords: ["วันที่ปลูก", "วันปลูก", "planting date"] }
    ];
    
    // หาคอลัมน์
    const foundColumns = {};
    
    requiredColumns.forEach(reqCol => {
        let foundColumn = null;
        
        // ค้นหาด้วยชื่อตรง
        for (const col of selectedColumns) {
            const colLower = col.toLowerCase().trim();
            const reqNameLower = reqCol.name.toLowerCase();
            
            if (colLower === reqNameLower) {
                foundColumn = col;
                break;
            }
        }
        
        // ค้นหาด้วยคำสำคัญ
        if (!foundColumn) {
            foundColumn = findColumnByName(selectedColumns, reqCol.keywords);
        }
        
        foundColumns[reqCol.name] = foundColumn;
    });
    
    // ตรวจสอบคอลัมน์ที่ขาด
    const missingColumns = [];
    Object.keys(foundColumns).forEach(key => {
        if (!foundColumns[key]) {
            missingColumns.push(key);
        }
    });
    
    if (missingColumns.length > 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px; background: #ffebee;">
                    <div style="color: #d32f2f; font-size: 1.2rem; margin-bottom: 15px;">
                        <i class="fas fa-exclamation-triangle"></i> <strong>ไม่พบคอลัมน์ที่จำเป็น</strong>
                    </div>
                    <p>กรุณาเลือกคอลัมน์เหล่านี้ในขั้นตอนที่ 2:</p>
                    <ul style="text-align: left; display: inline-block; margin-top: 10px;">
                        ${missingColumns.map(col => `<li>${col}</li>`).join('')}
                    </ul>
                </td>
            </tr>
        `;
        return;
    }
    
    // สร้างข้อมูลตาราง
    checkingTableData = [];
    
    uploadedData.data.forEach((row, rowIndex) => {
        const rowData = {
            id: rowIndex + 1,
            originalRowIndex: rowIndex,
            intechPlot: foundColumns["เลขแปลงintech"] ? row[foundColumns["เลขแปลงintech"]] || '' : '',
            sugarcaneType: foundColumns["ชื่อประเภทอ้อย"] ? row[foundColumns["ชื่อประเภทอ้อย"]] || '' : '',
            plantingDate: foundColumns["วันที่ปลูก"] ? row[foundColumns["วันที่ปลูก"]] || '' : '',
            condition: getConditionDisplayName(currentCondition),
            status: "รอตรวจสอบ",
            notes: "ยังไม่ได้ตรวจสอบ",
            passed: false,
            failedCells: {}
        };
        
        checkingTableData.push(rowData);
    });
    
    // สร้างหัวตาราง
    const tableHeader = document.getElementById('checkingTableHeader');
    tableHeader.innerHTML = '';
    
    const headerRow = document.createElement('tr');
    const headers = ["ลำดับ", "เลขแปลงintech", "ชื่อประเภทอ้อย", "วันที่ปลูก", "เงื่อนไขที่ตรวจ", "สถานะ", "หมายเหตุ"];
    
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    
    tableHeader.appendChild(headerRow);
    
    // แสดงตาราง
    renderCheckingTable();
    
    // อัพเดตจำนวนแถว
    document.getElementById('checkingRowsCount').textContent = checkingTableData.length;
    
    // แสดงข้อความแจ้งเตือน
    const resultsContainer = document.getElementById('checkingResults');
    resultsContainer.innerHTML = `
        <div class="result-summary" style="background: #e8f5e9; border-left-color: #4caf50;">
            <p><i class="fas fa-check-circle"></i> <strong>เตรียมตารางตรวจสอบประเภทอ้อยเสร็จเรียบร้อย</strong></p>
            <p>พบข้อมูลทั้งหมด: <strong>${checkingTableData.length} แถว</strong></p>
            <p>พบคอลัมน์ที่ใช้ตรวจสอบ:</p>
            <ul>
                <li><strong>เลขแปลงintech:</strong> "${foundColumns["เลขแปลงintech"]}"</li>
                <li><strong>ชื่อประเภทอ้อย:</strong> "${foundColumns["ชื่อประเภทอ้อย"]}"</li>
                <li><strong>วันที่ปลูก:</strong> "${foundColumns["วันที่ปลูก"]}"</li>
            </ul>
            <p style="margin-top: 15px;">
                <button class="btn btn-primary" id="startSugarcaneCheckBtn">
                    <i class="fas fa-play"></i> เริ่มตรวจสอบประเภทอ้อย
                </button>
            </p>
        </div>
    `;
    
    // เพิ่ม Event Listener
    document.getElementById('startSugarcaneCheckBtn').addEventListener('click', function() {
        const results = performSugarcaneConditionCheck();
        updateCheckingTableWithResults(results, currentCondition);
        updateCheckingStats(results);
        displayCheckingResults(results, currentCondition);
        
        alert(`✅ ตรวจสอบเงื่อนไข "ประเภทอ้อย" เสร็จสิ้น\n\nตรวจทั้งหมด: ${results.totalRows} แถว\nผ่าน: ${results.passed} แถว\nไม่ผ่าน: ${results.failed} แถว\nต้องตรวจสอบ: ${results.warnings} แถว`);
    });
}

// ฟังก์ชันแสดงตารางตรวจสอบ
function renderCheckingTable() {
    const tableBody = document.getElementById('checkingTableBody');
    tableBody.innerHTML = '';
    
    let displayedRows = 0;
    
    checkingTableData.forEach(rowData => {
        // กรองแสดงเฉพาะที่ไม่ผ่านถ้าเลือก
        if (showOnlyFailed && rowData.status === "ผ่าน") {
            return;
        }
        
        displayedRows++;
        
        const tr = document.createElement('tr');
        
        // เพิ่มคลาสสำหรับแถวที่ไม่มีข้อมูลวันที่ปลูก
        if (rowData.status === "ไม่มีข้อมูลวันที่ปลูก") {
            tr.classList.add('warning-row');
        }
        // ✅ เพิ่มคลาสพิเศษสำหรับแถวที่มีสีพิเศษ
        if (rowData.status === "ไม่มีข้อมูลวันที่ปลูก") {
            tr.classList.add('warning-row');
        }
        // สร้างเซลล์
        const cells = [
            rowData.id,
            rowData.intechPlot || '(ไม่พบข้อมูล)',
            rowData.sugarcaneType || '(ไม่พบข้อมูล)',
            rowData.plantingDate || '(ไม่พบข้อมูล)',
            rowData.condition,
            createStatusBadge(rowData.status),
            rowData.notes
        ];
        
        cells.forEach((cellContent, cellIndex) => {
            const td = document.createElement('td');
            // ✅ สำหรับคอลัมน์ที่ 1 และ 2 (ลำดับและเลขแปลง)
            if (cellIndex === 0 || cellIndex === 1) {
                td.classList.add('sticky-column');
            }
            if (typeof cellContent === 'string' && cellContent.includes('status-badge')) {
                td.innerHTML = cellContent;
            } else {
                td.textContent = cellContent;
                
                // ตรวจสอบค่าว่าง
                if (cellContent === '' || cellContent === '(ไม่พบข้อมูล)') {
                    td.style.color = '#999';
                    td.style.fontStyle = 'italic';
                }
                
                // ตรวจสอบข้อผิดพลาด
                if (rowData.failedCells && rowData.failedCells[cellIndex]) {
                    td.style.color = 'var(--danger-color)';
                    td.style.fontWeight = 'bold';
                    td.style.backgroundColor = 'rgba(247, 37, 133, 0.1)';
                }
                
                // ถ้าผ่าน ให้เพิ่มสีเขียว
                if (rowData.passed && (cellIndex === 2 || cellIndex === 3)) {
                    td.style.color = 'var(--success-color)';
                    td.style.fontWeight = 'bold';
                    td.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
                }
            }
            
            tr.appendChild(td);
        });
        
        tableBody.appendChild(tr);
    });
    
    // อัพเดตจำนวนแถวที่แสดง
    document.getElementById('checkingRowsCount').textContent = displayedRows;
}

// ฟังก์ชันตรวจสอบเงื่อนไขประเภทอ้อย
function performSugarcaneConditionCheck() {
    const results = {
        condition: "sugarcane",
        totalRows: checkingTableData.length,
        passed: 0,
        failed: 0,
        warnings: 0,
        pending: 0,
        issues: []
    };
    
    checkingTableData.forEach((rowData, index) => {
        let passed = true;
        let issues = [];
        let failedCells = {};
        
        // ตรวจสอบ 1: ประเภทอ้อย
        const sugarcaneType = rowData.sugarcaneType ? rowData.sugarcaneType.trim() : '';
        if (!sugarcaneType) {
            issues.push('ไม่มีข้อมูลประเภทอ้อย');
            passed = false;
            failedCells[2] = true;
        } else if (!sugarcaneTypes.includes(sugarcaneType)) {
            issues.push(`ประเภทอ้อย "${sugarcaneType}" ไม่ตรงกับค่ามาตรฐาน`);
            passed = false;
            failedCells[2] = true;
        }
        
        // ตรวจสอบ 2: วันที่ปลูก
        const plantingDateStr = rowData.plantingDate ? rowData.plantingDate.trim() : '';
        if (!plantingDateStr) {
            // ไม่มีข้อมูลวันที่ปลูก
            rowData.status = "ไม่มีข้อมูลวันที่ปลูก";
            rowData.notes = "ยังไม่ได้ทำกิจกรรมงวด 1";
            failedCells[3] = true;
            results.warnings++;
            results.issues.push({
                row: rowData.originalRowIndex + 1,
                intech: rowData.intechPlot,
                issues: ['ไม่มีข้อมูลวันที่ปลูก'],
                status: "ไม่มีข้อมูลวันที่ปลูก"
            });
            
            // ยังไม่ตัดสินใจผ่านหรือไม่ผ่าน
            rowData.passed = false;
            rowData.failedCells = failedCells;
            return;
        }
        
        // แปลงวันที่
        const plantingDate = parseDateString(plantingDateStr);
        if (!plantingDate) {
            issues.push(`รูปแบบวันที่ปลูกไม่ถูกต้อง: "${plantingDateStr}"`);
            passed = false;
            failedCells[3] = true;
        } else if (sugarcaneType && sugarcaneTypes.includes(sugarcaneType)) {
            // ตรวจสอบความสัมพันธ์ระหว่างประเภทอ้อยและวันที่ปลูก
            const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", 
                              "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            const plantingMonth = monthNames[plantingDate.getMonth()];
            const plantingYear = plantingDate.getFullYear() + 543;
            
            // หาประเภทอ้อยที่ตรง
            let matchedType = null;
            let matchedRanges = null;
            
            for (const [typeKey, ranges] of Object.entries(sugarcaneDateRanges)) {
                if (sugarcaneType.includes(typeKey) || typeKey.includes(sugarcaneType)) {
                    matchedType = typeKey;
                    matchedRanges = ranges;
                    break;
                }
            }
            
            // ถ้าไม่เจอตรงๆ ให้ตรวจสอบประเภทหลัก
            if (!matchedRanges) {
                if (sugarcaneType.includes("ปลายฝน")) {
                    matchedType = "ปลายฝน";
                    matchedRanges = sugarcaneDateRanges["ปลายฝน"];
                } else if (sugarcaneType.includes("ต้นฝน")) {
                    matchedType = "ต้นฝน";
                    matchedRanges = sugarcaneDateRanges["ต้นฝน"];
                } else if (sugarcaneType.includes("พันธุ์")) {
                    matchedType = "พันธุ์อ้อย";
                    matchedRanges = sugarcaneDateRanges["พันธุ์อ้อย"];
                } else if (sugarcaneType.includes("ตอ") || sugarcaneType.includes(">ตอ3") || sugarcaneType.includes("บำรุง")) {
                    matchedType = "ตอ1";
                    matchedRanges = sugarcaneDateRanges["ตอ1"];
                }
            }
            
            if (matchedRanges && matchedRanges.length > 0) {
                // ตรวจสอบกับทุกช่วงวันที่
                let isInAnyRange = false;
                let matchedRangeDescription = "";
                
                for (const range of matchedRanges) {
                    const startDate = new Date(range.start);
                    const endDate = new Date(range.end);
                    
                    if (plantingDate >= startDate && plantingDate <= endDate) {
                        isInAnyRange = true;
                        matchedRangeDescription = range.description;
                        break;
                    }
                }
                
                if (isInAnyRange) {
                    // ถูกต้อง
                    rowData.notes = `✓ ถูกต้อง: ประเภทอ้อย "${sugarcaneType}" ปลูกเดือน ${plantingMonth} ${plantingYear} สอดคล้องกับช่วง ${matchedRangeDescription}`;
                } else {
                    // ไม่อยู่ในช่วงที่กำหนด
                    passed = false;
                    const allRangesDesc = matchedRanges.map(r => `${r.description} (ปี ${r.year})`).join(" หรือ ");
                    issues.push(`ปลูกเดือน ${plantingMonth} ${plantingYear} ไม่อยู่ในช่วงที่กำหนดสำหรับ "${sugarcaneType}"`);
                    failedCells[2] = true;
                    failedCells[3] = true;
                    
                    rowData.notes = `⏳ ต้องตรวจสอบ: ปลูกเดือน ${plantingMonth} ${plantingYear} ไม่อยู่ในช่วงที่กำหนด | ช่วงที่กำหนด: ${allRangesDesc}`;
                }
            } else {
                // ไม่พบช่วงวันที่สำหรับประเภทนี้
                passed = false;
                issues.push(`ประเภทอ้อย "${sugarcaneType}" ไม่มีช่วงวันที่กำหนดในระบบ`);
                failedCells[2] = true;
                rowData.notes = `⏳ ต้องตรวจสอบ: ประเภทอ้อย "${sugarcaneType}" ไม่มีช่วงวันที่กำหนด`;
            }
        }
        
        // กำหนดสถานะ
        if (passed && issues.length === 0) {
            results.passed++;
            rowData.status = "ผ่าน";
            rowData.passed = true;
        } else if (issues.length > 0 && rowData.notes.includes("ต้องตรวจสอบ")) {
            results.warnings++;
            rowData.status = "ต้องตรวจสอบ";
            rowData.passed = false;
            results.issues.push({
                row: rowData.originalRowIndex + 1,
                intech: rowData.intechPlot,
                issues: issues,
                status: "ต้องตรวจสอบ"
            });
        } else {
            results.failed++;
            rowData.status = "ไม่ผ่าน";
            rowData.passed = false;
            results.issues.push({
                row: rowData.originalRowIndex + 1,
                intech: rowData.intechPlot,
                issues: issues
            });
        }
        
        rowData.failedCells = failedCells;
    });
    
    return results;
}

// ฟังก์ชันเตรียมตารางตรวจสอบปุ๋ย
function prepareFertilizerCheckingTable() {
    const tableBody = document.getElementById('checkingTableBody');
    tableBody.innerHTML = '';
    
    // คอลัมน์ปุ๋ย
    const fertilizerColumns = [
        { name: "เลขแปลงintech", keywords: ["แปลงintech", "แปลง intech", "แปลง"] },
        { name: "โซน", keywords: ["โซน", "zone"] }, // ✅ เพิ่ม
        { name: "รหัสนักเกษตร", keywords: ["รหัสนักเกษตร", "รหัสเกษตร", "farmer code"] }, // ✅ เพิ่ม
        { name: "ชื่อประเภทอ้อย", keywords: ["ชื่อประเภทอ้อย", "ประเภทอ้อย", "พันธุ์อ้อย"] },
        { name: "อายุอ้อย", keywords: ["อายุอ้อย", "อายุ", "age", "วัน"] },
        { name: "ประเภทการใส่ปุ๋ยงวด 1", keywords: ["ประเภทการใส่ปุ๋ยงวด 1", "ประเภทปุ๋ยงวด1", "ปุ๋ยงวด1"] },
        { name: "สูตรปุ๋ยเคมีครั้งที่1", keywords: ["สูตรปุ๋ยเคมีครั้งที่1", "สูตรปุ๋ย1", "ปุ๋ยเคมี1"] },
        { name: "ประเภทการใส่ปุ๋ยงวด 2", keywords: ["ประเภทการใส่ปุ๋ยงวด 2", "ประเภทปุ๋ยงวด2", "ปุ๋ยงวด2"] },
        { name: "ปุ๋ยเคมีงวด2", keywords: ["ปุ๋ยเคมีงวด2", "สูตรปุ๋ย2", "ปุ๋ยเคมี2"] },
        { name: "ประเภทการใส่ปุ๋ยงวด 3", keywords: ["ประเภทการใส่ปุ๋ยงวด 3", "ประเภทปุ๋ยงวด3", "ปุ๋ยงวด3"] },
        { name: "ปุ๋ยเคมีงวด 3", keywords: ["ปุ๋ยเคมีงวด 3", "สูตรปุ๋ย3", "ปุ๋ยเคมี3"] }
    ];
    
    // หาคอลัมน์
    const foundColumns = {};
    
    fertilizerColumns.forEach(colDef => {
        let foundColumn = null;
        
        // ค้นหาด้วยชื่อตรง
        for (const col of selectedColumns) {
            const colLower = col.toLowerCase().trim();
            const reqNameLower = colDef.name.toLowerCase();
            
            if (colLower === reqNameLower) {
                foundColumn = col;
                break;
            }
        }
        
        // ค้นหาด้วยคำสำคัญ
        if (!foundColumn) {
            foundColumn = findColumnByName(selectedColumns, colDef.keywords);
        }
        
        foundColumns[colDef.name] = foundColumn;
    });
    
    // สร้างข้อมูลตาราง
    checkingTableData = [];
    
    uploadedData.data.forEach((row, rowIndex) => {
        const rowData = {
            id: rowIndex + 1,
            originalRowIndex: rowIndex,
            intechPlot: foundColumns["เลขแปลงintech"] ? row[foundColumns["เลขแปลงintech"]] || '' : '',
            zone: foundColumns["โซน"] ? row[foundColumns["โซน"]] || '' : '', // ✅ เพิ่ม
            farmerCode: foundColumns["รหัสนักเกษตร"] ? row[foundColumns["รหัสนักเกษตร"]] || '' : '', // ✅ เพิ่ม
            sugarcaneType: foundColumns["ชื่อประเภทอ้อย"] ? row[foundColumns["ชื่อประเภทอ้อย"]] || '' : '',
            sugarcaneType: foundColumns["ชื่อประเภทอ้อย"] ? row[foundColumns["ชื่อประเภทอ้อย"]] || '' : '',
            age: foundColumns["อายุอ้อย"] ? row[foundColumns["อายุอ้อย"]] || '' : '',
            fertilizerType1: foundColumns["ประเภทการใส่ปุ๋ยงวด 1"] ? row[foundColumns["ประเภทการใส่ปุ๋ยงวด 1"]] || '' : '',
            fertilizerFormula1: foundColumns["สูตรปุ๋ยเคมีครั้งที่1"] ? row[foundColumns["สูตรปุ๋ยเคมีครั้งที่1"]] || '' : '',
            fertilizerType2: foundColumns["ประเภทการใส่ปุ๋ยงวด 2"] ? row[foundColumns["ประเภทการใส่ปุ๋ยงวด 2"]] || '' : '',
            fertilizerFormula2: foundColumns["ปุ๋ยเคมีงวด2"] ? row[foundColumns["ปุ๋ยเคมีงวด2"]] || '' : '',
            fertilizerType3: foundColumns["ประเภทการใส่ปุ๋ยงวด 3"] ? row[foundColumns["ประเภทการใส่ปุ๋ยงวด 3"]] || '' : '',
            fertilizerFormula3: foundColumns["ปุ๋ยเคมีงวด 3"] ? row[foundColumns["ปุ๋ยเคมีงวด 3"]] || '' : '',
            condition: getConditionDisplayName(currentCondition),
            status: "รอตรวจสอบ",
            notes: "ยังไม่ได้ตรวจสอบ",
            passed: false,
            failedCells: {}
        };
        
        checkingTableData.push(rowData);
    });
    
    // สร้างหัวตาราง
    const tableHeader = document.getElementById('checkingTableHeader');
    tableHeader.innerHTML = '';
    
    const headerRow = document.createElement('tr');
    const headers = [
        "ลำดับ",
        "เลขแปลงintech",
        "โซน",              // ✅ เพิ่ม
        "รหัสนักเกษตร",     // ✅ เพิ่ม
        "ชื่อประเภทอ้อย",
        "อายุอ้อย",
        "ประเภทการใส่ปุ๋ยงวด 1",
        "สูตรปุ๋ยเคมีครั้งที่1",
        "ประเภทการใส่ปุ๋ยงวด 2",
        "ปุ๋ยเคมีงวด2",
        "ประเภทการใส่ปุ๋ยงวด 3",
        "ปุ๋ยเคมีงวด 3",
        "สถานะ",
        "หมายเหตุ"
    ];
    
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    
    tableHeader.appendChild(headerRow);
    
    // แสดงตาราง
    renderFertilizerCheckingTable();
    
    // อัพเดตจำนวนแถว
    document.getElementById('checkingRowsCount').textContent = checkingTableData.length;
    
    // แสดงข้อความแจ้งเตือน
    const resultsContainer = document.getElementById('checkingResults');
    
    const foundCount = Object.values(foundColumns).filter(col => col !== null).length;
    const totalColumns = fertilizerColumns.length;
    
     resultsContainer.innerHTML = `
        <div class="result-summary" style="background: #e8f5e9; border-left-color: #4caf50;">
            <p><i class="fas fa-check-circle"></i> <strong>เตรียมตารางตรวจสอบ "${getConditionDisplayName(currentCondition)}" เสร็จเรียบร้อย</strong></p>
            <p>พบข้อมูลทั้งหมด: <strong>${checkingTableData.length} แถว</strong></p>
            <p>พบคอลัมน์ปุ๋ย: ${foundCount}/${totalColumns} คอลัมน์</p>
            ${foundColumns["โซน"] ? `<p><i class="fas fa-map-marker-alt"></i> พบคอลัมน์โซน: <strong>"${foundColumns["โซน"]}"</strong></p>` : ''}
            ${foundColumns["รหัสนักเกษตร"] ? `<p><i class="fas fa-user-tag"></i> พบคอลัมน์รหัสนักเกษตร: <strong>"${foundColumns["รหัสนักเกษตร"]}"</strong></p>` : ''}
            <div style="margin-top: 15px;">
                <button class="btn btn-primary" id="startFertilizerCheckBtn">
                    <i class="fas fa-play"></i> เริ่มตรวจสอบปุ๋ย
                </button>
            </div>
        </div>
    `;
    
     // เพิ่ม Event Listener
    document.getElementById('startFertilizerCheckBtn').addEventListener('click', function() {
        const results = performFertilizerConditionCheck();
        updateCheckingTableWithResults(results, currentCondition);
        updateCheckingStats(results);
        displayCheckingResults(results, currentCondition);
        
        alert(`✅ ตรวจสอบเงื่อนไข "ปุ๋ย" เสร็จสิ้น\n\nตรวจทั้งหมด: ${results.totalRows} แถว\nผ่าน: ${results.passed} แถว\nไม่ผ่าน: ${results.failed} แถว\nต้องตรวจสอบ: ${results.warnings} แถว`);
    });
}

// ฟังก์ชันแสดงตารางตรวจสอบปุ๋ย
function renderFertilizerCheckingTable() {
    const tableBody = document.getElementById('checkingTableBody');
    tableBody.innerHTML = '';
    
    let displayedRows = 0;
    
    checkingTableData.forEach(rowData => {
        if (showOnlyFailed && rowData.status === "ผ่าน") {
            return;
        }
        
        displayedRows++;
        
        const tr = document.createElement('tr');
        
        const cells = [
            rowData.id,
            rowData.intechPlot || '(ไม่พบข้อมูล)',
            rowData.zone || '(ไม่พบข้อมูล)',      // ✅ เพิ่ม
            rowData.farmerCode || '(ไม่พบข้อมูล)', // ✅ เพิ่ม
            rowData.sugarcaneType || '(ไม่พบข้อมูล)',
            rowData.age || '',
            rowData.fertilizerType1 || '',
            rowData.fertilizerFormula1 || '',
            rowData.fertilizerType2 || '',
            rowData.fertilizerFormula2 || '',
            rowData.fertilizerType3 || '',
            rowData.fertilizerFormula3 || '',
            createStatusBadge(rowData.status),
            rowData.notes || ''
        ];
        
        cells.forEach((cellContent, cellIndex) => {
            const td = document.createElement('td');
            
            if (typeof cellContent === 'string' && cellContent.includes('status-badge')) {
                td.innerHTML = cellContent;
            } else {
                td.textContent = cellContent;
                
               // ตรวจสอบค่าว่าง
                if (cellContent === '' || cellContent === '(ไม่พบข้อมูล)') {
                    td.style.color = '#999';
                    td.style.fontStyle = 'italic';
                }
                
                // ตรวจสอบข้อผิดพลาด
                if (rowData.failedCells && rowData.failedCells[cellIndex]) {
                    td.style.color = 'var(--danger-color)';
                    td.style.fontWeight = 'bold';
                    td.style.backgroundColor = 'rgba(247, 37, 133, 0.1)';
                }
                
                // ถ้าผ่าน ให้เพิ่มสีเขียว
                if (rowData.passed && (cellIndex === 4 || cellIndex === 5)) { // ✅ ปรับ index
                    td.style.color = 'var(--success-color)';
                    td.style.fontWeight = 'bold';
                    td.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
                }
            }
            
            tr.appendChild(td);
        });
        
        tableBody.appendChild(tr);
    });
    
    // อัพเดตจำนวนแถวที่แสดง
    document.getElementById('checkingRowsCount').textContent = displayedRows;
}

// ฟังก์ชันตรวจสอบเงื่อนไขปุ๋ย
function performFertilizerConditionCheck() {
    const results = {
        condition: "fertilizer",
        totalRows: checkingTableData.length,
        passed: 0,
        failed: 0,
        warnings: 0,
        issues: []
    };

    const validFertilizerTypes = ["รองพื้น", "แต่งหน้าครั้งที่1", "แต่งหน้าครั้งที่2", "แต่งหน้าครั้งที่3"];

    checkingTableData.forEach((rowData, index) => {
        let passed = true;
        let notes = [];
        let failedCells = {};
        
        let ageValue = null;
        if (rowData.age && rowData.age.trim() !== '') {
            ageValue = parseFloat(rowData.age);
        }

        const sugarcaneType = rowData.sugarcaneType ? rowData.sugarcaneType.trim() : '';
        
        // ตรวจสอบประเภทปุ๋ยงวด 1
        if (rowData.fertilizerType1 && rowData.fertilizerType1.trim() !== '') {
            const fertilizerType1 = rowData.fertilizerType1.trim();
            if (!validFertilizerTypes.includes(fertilizerType1)) {
                passed = false;
                notes.push("ประเภทการใส่ปุ๋ยงวด 1 ไม่ถูกต้อง");
                failedCells[4] = true;
            }
        }

        // ตรวจสอบประเภทปุ๋ยงวด 2
        if (rowData.fertilizerType2 && rowData.fertilizerType2.trim() !== '') {
            const fertilizerType2 = rowData.fertilizerType2.trim();
            if (!validFertilizerTypes.includes(fertilizerType2)) {
                passed = false;
                notes.push("ประเภทการใส่ปุ๋ยงวด 2 ไม่ถูกต้อง");
                failedCells[6] = true;
            }
        }

        // ตรวจสอบประเภทปุ๋ยงวด 3
        if (rowData.fertilizerType3 && rowData.fertilizerType3.trim() !== '') {
            const fertilizerType3 = rowData.fertilizerType3.trim();
            if (!validFertilizerTypes.includes(fertilizerType3)) {
                passed = false;
                notes.push("ประเภทการใส่ปุ๋ยงวด 3 ไม่ถูกต้อง");
                failedCells[8] = true;
            }
        }

        if (passed && notes.length === 0) {
            results.passed++;
            rowData.status = "ผ่าน";
            rowData.notes = "✓ ปุ๋ยตรงตามเงื่อนไข";
        } else if (sugarcaneType === '' || ageValue === null || isNaN(ageValue)) {
            results.warnings++;
            rowData.status = "รอตรวจสอบ";
            rowData.notes = notes.join('; ') || "ไม่มีข้อมูลประเภทอ้อยหรืออายุ";
        } else {
            results.failed++;
            rowData.status = "ไม่ผ่าน";
            rowData.notes = notes.join('; ');
            results.issues.push({
                row: index + 1,
                message: notes.join('; '),
                intechPlot: rowData.intechPlot,
                sugarcaneType: rowData.sugarcaneType,
                age: rowData.age
            });
        }

        rowData.passed = passed;
        rowData.failedCells = failedCells;
    });

    return results;
}

// ฟังก์ชันอัพเดตตารางผลลัพธ์
function updateCheckingTableWithResults(results, condition) {
    checkingTableData.forEach((rowData) => {
        rowData.condition = getConditionDisplayName(condition);
    });
    
    if (condition === "fertilizer") {
        renderFertilizerCheckingTable();
    } else if (condition === "sugarcane") {
        renderCheckingTable();
    }
}

// ฟังก์ชันอัพเดตสถิติ
function updateCheckingStats(results) {
    document.getElementById('foundIssues').textContent = results.failed + results.warnings;
    document.getElementById('passedChecks').textContent = results.passed;
    document.getElementById('failedChecks').textContent = results.failed;
}

// ฟังก์ชันแสดงผลการตรวจสอบ
function displayCheckingResults(results, condition) {
    const resultsContainer = document.getElementById('checkingResults');
    
    let html = `
        <div class="result-summary">
            <p><i class="fas fa-check-circle" style="color: #4caf50;"></i> ตรวจสอบเงื่อนไข "<strong>${getConditionDisplayName(condition)}</strong>" เรียบร้อยแล้ว</p>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p><strong><i class="fas fa-info-circle"></i> สรุปผลการตรวจสอบ:</strong></p>
                <ul style="margin-top: 5px;">
                    <li>ตรวจทั้งหมด: <strong>${results.totalRows}</strong> แถว</li>
                    <li>ผ่าน: <strong>${results.passed}</strong> แถว</li>
                    <li>ไม่ผ่าน: <strong>${results.failed}</strong> แถว</li>
                    ${results.warnings > 0 ? `<li>ต้องตรวจสอบ: <strong>${results.warnings}</strong> แถว</li>` : ''}
                </ul>
            </div>
    `;
    
    if (condition === "sugarcane") {
        html += `
            <div style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 6px;">
                <p><strong><i class="fas fa-calendar-alt"></i> ช่วงวันที่ที่กำหนดสำหรับแต่ละประเภทอ้อย:</strong></p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                        <h4 style="color: #4361ee; margin-bottom: 5px;">ปี 2568-2569</h4>
                        <ul style="font-size: 0.9em;">
                            <li><strong>ปลายฝน</strong> (ปลายฝนขยาย/ปลายฝนรื้อตอ): ตุลาคม 2568 - กุมภาพันธ์ 2569</li>
                            <li><strong>ต้นฝน</strong> (ต้นฝนขยาย/ต้นฝนรื้อตอ): มีนาคม 2569 - มิถุนายน 2569</li>
                            <li><strong>พันธุ์อ้อย</strong>: มิถุนายน 2569 - กรกฎาคม 2569</li>
                            <li><strong>ตอ/บำรุงตอ</strong> (ตอ1, ตอ2, ตอ3, >ตอ3): ธันวาคม 2568 - มีนาคม 2569</li>
                        </ul>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                        <h4 style="color: #3a0ca3; margin-bottom: 5px;">ปี 2567-2568</h4>
                        <ul style="font-size: 0.9em;">
                            <li><strong>ปลายฝน</strong> (ปลายฝนขยาย/ปลายฝนรื้อตอ): ตุลาคม 2567 - มกราคม 2568</li>
                            <li><strong>ต้นฝน</strong> (ต้นฝนขยาย/ต้นฝนรื้อตอ): กุมภาพันธ์ 2567 - พฤษภาคม 2568</li>
                            <li><strong>พันธุ์อ้อย</strong>: 1 มิถุนายน 2567 - 30 มิถุนายน 2567</li>
                            <li><strong>ตอ/บำรุงตอ</strong> (ตอ1, ตอ2, ตอ3, >ตอ3): ธันวาคม 2567 - มีนาคม 2568</li>
                        </ul>
                    </div>
                </div>
                <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    <i class="fas fa-info-circle"></i> <strong>สีในตาราง:</strong>
                    <span style="color: #4CAF50;">เขียว</span> = ผ่าน, 
                    <span style="color: #F44336;">แดง</span> = ไม่ผ่าน, 
                    <span style="color: #FF9800;">เหลือง</span> = รอตรวจสอบ/ไม่มีข้อมูลวันที่ปลูก
                </p>
            </div>
        `;
    }
    
    if (condition === "fertilizer") {
        html += `
            <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
                <p><strong><i class="fas fa-info-circle"></i> มาตรฐานการตรวจสอบปุ๋ย:</strong></p>
                <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #ddd;">
                    <h4 style="color: #2196f3; margin-bottom: 5px;">ประเภทการใส่ปุ๋ยที่รับรอง</h4>
                    <ul style="font-size: 0.9em;">
                        <li><strong>รองพื้น</strong></li>
                        <li><strong>แต่งหน้าครั้งที่1</strong></li>
                        <li><strong>แต่งหน้าครั้งที่2</strong></li>
                        <li><strong>แต่งหน้าครั้งที่3</strong></li>
                    </ul>
                </div>
            </div>
        `;
    }
    
    html += `</div>`;
    
    resultsContainer.innerHTML = html;
}

// ฟังก์ชันเตรียมตารางตามเงื่อนไข
function prepareCheckingTable() {
    const tableBody = document.getElementById('checkingTableBody');
    tableBody.innerHTML = '';
    
    if (!uploadedData || !selectedColumns || selectedColumns.length === 0) {
        console.error('No uploaded data or selected columns');
        return;
    }
    
    if (currentCondition === "sugarcane") {
        prepareSugarcaneCheckingTable();
    } else if (currentCondition === "fertilizer") {
        prepareFertilizerCheckingTable();
    }
}
// ✅ เพิ่มตรวจจับการเลื่อนตาราง
function setupTableScrollDetection() {
    const tableWrapper = document.querySelector('.checking-table-wrapper');
    if (tableWrapper) {
        tableWrapper.addEventListener('scroll', function() {
            if (this.scrollLeft > 10) {
                this.classList.add('scrolling');
            } else {
                this.classList.remove('scrolling');
            }
        });
    }
}
// ในฟังก์ชัน setupConditionCheckingSystem() ให้เพิ่มเงื่อนไขโครงการ
function setupConditionCheckingSystem() {
    // ปุ่มเลือกเงื่อนไข
    document.querySelectorAll('.condition-select-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.condition-select-btn').forEach(b => {
                b.classList.remove('active');
            });
            
            this.classList.add('active');
            currentCondition = this.dataset.condition;
            document.getElementById('selectedCondition').textContent = getConditionDisplayName(currentCondition);
            prepareCheckingTable();
        });
    });
    
    // ปุ่มเริ่มตรวจสอบเงื่อนไขที่เลือก
    document.getElementById('runSelectedCheck').addEventListener('click', function() {
        if (!checkingTableData || checkingTableData.length === 0) {
            alert('กรุณาเตรียมข้อมูลก่อนเริ่มตรวจสอบ');
            return;
        }
        
        if (currentCondition === "sugarcane") {
            const results = performSugarcaneConditionCheck();
            updateCheckingTableWithResults(results, currentCondition);
            updateCheckingStats(results);
            displayCheckingResults(results, currentCondition);
        } else if (currentCondition === "fertilizer") {
            const results = performFertilizerConditionCheck();
            updateCheckingTableWithResults(results, currentCondition);
            updateCheckingStats(results);
            displayCheckingResults(results, currentCondition);
        } else if (currentCondition === "project") {
            const results = performProjectConditionCheck();
            updateCheckingTableWithResults(results, currentCondition);
            updateCheckingStats(results);
            displayCheckingResults(results, currentCondition);
        }
    });
    
    // ปุ่มตรวจสอบเงื่อนไขทั้งหมด
    document.getElementById('runAllChecks').addEventListener('click', function() {
        runAllConditionChecks();
    });
    
    // ปุ่มส่งออกผลตรวจสอบ
    document.getElementById('exportCheckResults').addEventListener('click', exportCheckingResultsWithColors);
}

// ฟังก์ชันตรวจสอบเงื่อนไขทั้งหมด
function runAllConditionChecks() {
    const conditions = ["sugarcane", "fertilizer"];
    const allResults = [];
    
    document.getElementById('runAllChecks').disabled = true;
    document.getElementById('runAllChecks').innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังตรวจสอบทั้งหมด...';
    
    let completedChecks = 0;
    
    conditions.forEach(condition => {
        setTimeout(() => {
            currentCondition = condition;
            prepareCheckingTable();
            
            setTimeout(() => {
                let results;
                
                switch(condition) {
                    case "sugarcane":
                        results = performSugarcaneConditionCheck();
                        break;
                    case "fertilizer":
                        results = performFertilizerConditionCheck();
                        break;
                }
                
                if (results) {
                    allResults.push(results);
                }
                
                completedChecks++;
                
                if (completedChecks === conditions.length) {
                    displayAllConditionResults(allResults);
                    document.getElementById('runAllChecks').disabled = false;
                    document.getElementById('runAllChecks').innerHTML = '<i class="fas fa-play-circle"></i> ตรวจสอบเงื่อนไขทั้งหมด';
                }
            }, 500);
        }, 1000 * conditions.indexOf(condition));
    });
}
// เพิ่มข้อมูลโครงการในส่วนที่กำหนดค่าคงที่
const PROJECT_LIST = [
    "เปลี่ยนพืชอื่นมาปลูกอ้อย ปี 69/70",
    "ปลูกอ้อยในนา ปี 69/70",
    "ผ่ากอ ปี 69/70",
    "ส่งเสริมระบบน้ำปลอดดอกเบี้ย ปี 69/70",
    "ส่งเสริมอุปกรณ์ปลอดดอกเบี้ย ปี 69/70",
    "สร้างความหนาแน่นอ้อยรอบโรงงาน"
];

// โครงการที่ไม่สามารถสมัครซ้ำได้
const EXCLUSIVE_PROJECTS = [
    "เปลี่ยนพืชอื่นมาปลูกอ้อย ปี 69/70",
    "ปลูกอ้อยในนา ปี 69/70"
];
// ✅ เพิ่มที่ส่วนบนของฟังก์ชัน หรือในส่วน global variables
const EXCLUSIVE_PROJECT_PAIRS = [
    {
        project1: "เปลี่ยนพืชอื่นมาปลูกอ้อย ปี 69/70",
        project2: "ปลูกอ้อยในนา ปี 69/70"
    }
    // สามารถเพิ่มคู่อื่นๆ ได้ถ้ามี
];
// คอลัมน์โครงการที่ต้องตรวจสอบ
const PROJECT_COLUMNS = [
    "โครงการ1", "โครงการ2", "โครงการ3", "โครงการ4", "โครงการ5"
];

// ฟังก์ชันแสดงชื่อเงื่อนไข - เพิ่ม "โครงการ"
function getConditionDisplayName(condition) {
    const names = {
        "sugarcane": "ประเภทอ้อย",
        "fertilizer": "ปุ๋ย",
        "project": "โครงการ"
    };
    return names[condition] || condition;
}

// ฟังก์ชันเตรียมตารางตรวจสอบโครงการ
function prepareProjectCheckingTable() {
    const tableBody = document.getElementById('checkingTableBody');
    tableBody.innerHTML = '';
    
    // คอลัมน์ที่จำเป็นสำหรับการตรวจสอบโครงการ
    const requiredColumns = [
        { name: "เลขแปลงintech", keywords: ["แปลงintech", "แปลง intech", "แปลง"] },
        { name: "โซน", keywords: ["โซน", "zone"] },
        { name: "รหัสนักเกษตร", keywords: ["รหัสนักเกษตร", "รหัสเกษตร", "farmer code"] }
    ];
    
    // เพิ่มคอลัมน์โครงการ
    PROJECT_COLUMNS.forEach(projectCol => {
        requiredColumns.push({ 
            name: projectCol, 
            keywords: [projectCol.toLowerCase(), "โครงการ", "project"] 
        });
    });
    
    // หาคอลัมน์
    const foundColumns = {};
    
    requiredColumns.forEach(colDef => {
        let foundColumn = null;
        
        // ค้นหาด้วยชื่อตรง
        for (const col of selectedColumns) {
            const colLower = col.toLowerCase().trim();
            const reqNameLower = colDef.name.toLowerCase();
            
            if (colLower === reqNameLower) {
                foundColumn = col;
                break;
            }
        }
        
        // ค้นหาด้วยคำสำคัญ
        if (!foundColumn) {
            foundColumn = findColumnByName(selectedColumns, colDef.keywords);
        }
        
        foundColumns[colDef.name] = foundColumn;
    });
    
    // ตรวจสอบคอลัมน์ที่ขาด
    const missingRequiredColumns = [];
    ["เลขแปลงintech", "โซน", "รหัสนักเกษตร"].forEach(key => {
        if (!foundColumns[key]) {
            missingRequiredColumns.push(key);
        }
    });
    
    if (missingRequiredColumns.length > 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="12" style="text-align: center; padding: 40px; background: #ffebee;">
                    <div style="color: #d32f2f; font-size: 1.2rem; margin-bottom: 15px;">
                        <i class="fas fa-exclamation-triangle"></i> <strong>ไม่พบคอลัมน์ที่จำเป็น</strong>
                    </div>
                    <p>กรุณาเลือกคอลัมน์เหล่านี้ในขั้นตอนที่ 2:</p>
                    <ul style="text-align: left; display: inline-block; margin-top: 10px;">
                        ${missingRequiredColumns.map(col => `<li>${col}</li>`).join('')}
                    </ul>
                </td>
            </tr>
        `;
        return;
    }
    
    // สร้างข้อมูลตาราง
    checkingTableData = [];
    
    uploadedData.data.forEach((row, rowIndex) => {
        const rowData = {
            id: rowIndex + 1,
            originalRowIndex: rowIndex,
            intechPlot: foundColumns["เลขแปลงintech"] ? row[foundColumns["เลขแปลงintech"]] || '' : '',
            zone: foundColumns["โซน"] ? row[foundColumns["โซน"]] || '' : '',
            farmerCode: foundColumns["รหัสนักเกษตร"] ? row[foundColumns["รหัสนักเกษตร"]] || '' : '',
            condition: getConditionDisplayName(currentCondition),
            status: "รอตรวจสอบ",
            notes: "ยังไม่ได้ตรวจสอบ",
            passed: false,
            failedCells: {},
            projects: {}
        };
        
        // เก็บข้อมูลโครงการ
        PROJECT_COLUMNS.forEach(projectCol => {
            const colName = foundColumns[projectCol];
            if (colName) {
                rowData[projectCol] = row[colName] || '';
                rowData.projects[projectCol] = row[colName] || '';
            } else {
                rowData[projectCol] = '';
                rowData.projects[projectCol] = '';
            }
        });
        
        checkingTableData.push(rowData);
    });
    
    // สร้างหัวตารางสำหรับโครงการ
    const tableHeader = document.getElementById('checkingTableHeader');
    tableHeader.innerHTML = '';
    
    const headerRow = document.createElement('tr');
    const headers = [
        "ลำดับ",
        "เลขแปลงintech",
        "โซน", 
        "รหัสนักเกษตร",
        "โครงการ1",
        "โครงการ2",
        "โครงการ3",
        "โครงการ4", 
        "โครงการ5",
        "สถานะ",
        "หมายเหตุ"
    ];
    
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    
    tableHeader.appendChild(headerRow);
    
    // แสดงตาราง
    renderProjectCheckingTable();
    
    // อัพเดตจำนวนแถว
    document.getElementById('checkingRowsCount').textContent = checkingTableData.length;
    
    // แสดงข้อความแจ้งเตือน
    const resultsContainer = document.getElementById('checkingResults');
    resultsContainer.innerHTML = `
        <div class="result-summary" style="background: #e8f5e9; border-left-color: #4caf50;">
            <p><i class="fas fa-check-circle"></i> <strong>เตรียมตารางตรวจสอบ "${getConditionDisplayName(currentCondition)}" เสร็จเรียบร้อย</strong></p>
            <p>พบข้อมูลทั้งหมด: <strong>${checkingTableData.length} แถว</strong></p>
            <p>พบคอลัมน์โครงการ: ${PROJECT_COLUMNS.filter(col => foundColumns[col]).length}/5 คอลัมน์</p>
            <div style="margin-top: 15px;">
                <button class="btn btn-primary" id="startProjectCheckBtn">
                    <i class="fas fa-play"></i> เริ่มตรวจสอบโครงการ
                </button>
            </div>
        </div>
    `;
    
    // เพิ่ม Event Listener สำหรับปุ่มเริ่มตรวจสอบโครงการ
    document.getElementById('startProjectCheckBtn').addEventListener('click', function() {
        const results = performProjectConditionCheck();
        updateCheckingTableWithResults(results, currentCondition);
        updateCheckingStats(results);
        displayCheckingResults(results, currentCondition);
        
        alert(`✅ ตรวจสอบเงื่อนไข "โครงการ" เสร็จสิ้น\n\nตรวจทั้งหมด: ${results.totalRows} แถว\nผ่าน: ${results.passed} แถว\nไม่ผ่าน: ${results.failed} แถว\nต้องตรวจสอบ: ${results.warnings} แถว`);
    });
}

// ฟังก์ชันแสดงตารางตรวจสอบโครงการ (ปรับปรุงให้แสดงผลตามเงื่อนไขใหม่)
function renderProjectCheckingTable() {
    const tableBody = document.getElementById('checkingTableBody');
    tableBody.innerHTML = '';
    
    let displayedRows = 0;
    
    checkingTableData.forEach(rowData => {
        if (showOnlyFailed && rowData.status === "ผ่าน") {
            return;
        }
        
        displayedRows++;
        
        const tr = document.createElement('tr');
        
        // กำหนดสีแถวตามสถานะ
        if (rowData.status === "ไม่ผ่าน") {
            tr.classList.add('project-row-error');
            tr.style.backgroundColor = 'rgba(255, 235, 238, 0.5)';
        } else if (rowData.status === "ผ่าน") {
            tr.classList.add('project-row-success');
            tr.style.backgroundColor = 'rgba(232, 245, 233, 0.5)';
        } else {
            tr.classList.add('project-row-warning');
            tr.style.backgroundColor = 'rgba(255, 248, 225, 0.5)';
        }
        
        const cells = [
            rowData.id,
            rowData.intechPlot || '(ไม่พบข้อมูล)',
            rowData.zone || '(ไม่พบข้อมูล)',
            rowData.farmerCode || '(ไม่พบข้อมูล)',
            rowData.projects["โครงการ1"] || '',
            rowData.projects["โครงการ2"] || '',
            rowData.projects["โครงการ3"] || '',
            rowData.projects["โครงการ4"] || '',
            rowData.projects["โครงการ5"] || '',
            createStatusBadge(rowData.status),
            rowData.notes || ''
        ];
        
        cells.forEach((cellContent, cellIndex) => {
            const td = document.createElement('td');
            
            if (typeof cellContent === 'string' && cellContent.includes('status-badge')) {
                td.innerHTML = cellContent;
            } else {
                td.textContent = cellContent;
                
                // ตรวจสอบค่าว่าง
                if (cellContent === '' || cellContent === '(ไม่พบข้อมูล)') {
                    td.style.color = '#999';
                    td.style.fontStyle = 'italic';
                }
                
                // ✅ แสดง "ไม่เข้าโครงการ" เป็นสีเทา (แต่แถวยังเป็นสีเขียวถ้าผ่าน)
                if (cellIndex >= 4 && cellIndex <= 8 && cellContent === 'ไม่เข้าโครงการ') {
                    td.classList.add('project-cell', 'not-in-project');
                    td.style.color = '#757575';
                    td.style.fontStyle = 'italic';
                    td.style.backgroundColor = '#f5f5f5';
                }
                
                // ✅ แสดงโครงการที่สมัครเป็นสีเขียว
                if (cellIndex >= 4 && cellIndex <= 8 && cellContent !== '' && 
                    cellContent !== 'ไม่เข้าโครงการ' && rowData.passed) {
                    td.classList.add('project-cell', 'applied');
                    td.style.color = 'var(--success-color)';
                    td.style.fontWeight = 'bold';
                    td.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
                }
                
                // ✅ แสดงโครงการที่ไม่รู้จัก/ผิดพลาดเป็นสีแดง
                if (rowData.failedCells && rowData.failedCells[cellIndex]) {
                    td.classList.add('project-cell', 'error');
                    td.style.color = 'var(--danger-color)';
                    td.style.fontWeight = 'bold';
                    td.style.backgroundColor = 'rgba(247, 37, 133, 0.1)';
                    td.style.border = '1px solid var(--danger-color)';
                }
            }
            
            tr.appendChild(td);
        });
        
        tableBody.appendChild(tr);
    });
    
    document.getElementById('checkingRowsCount').textContent = displayedRows;
}
function performProjectConditionCheck() {
    const results = {
        condition: "project",
        totalRows: checkingTableData.length,
        passed: 0,
        failed: 0,
        warnings: 0,
        issues: []
    };

    checkingTableData.forEach((rowData, index) => {
        let passed = true;
        let notes = [];
        let failedCells = {};
        let appliedProjects = [];
        let notInProjectCount = 0;
        let totalProjectColumns = 0;
        
        // ✅ เพิ่มตัวแปรเก็บโครงการที่สมัครในแถวนี้
        let rowProjects = [];
        
        // ตรวจสอบแต่ละคอลัมน์โครงการ
        PROJECT_COLUMNS.forEach((projectCol, colIndex) => {
            const projectValue = rowData.projects[projectCol] || '';
            totalProjectColumns++;
            
            // นับคอลัมน์ "ไม่เข้าโครงการ"
            if (projectValue.trim() === 'ไม่เข้าโครงการ') {
                notInProjectCount++;
                notes.push(`คอลัมน์ ${projectCol}: ไม่เข้าโครงการ`);
            }
            
            // ถ้ามีข้อมูลโครงการ (ไม่ใช่ค่าว่างหรือ "ไม่เข้าโครงการ")
            if (projectValue.trim() !== '' && projectValue.trim() !== 'ไม่เข้าโครงการ') {
                // ✅ เก็บโครงการที่สมัคร
                rowProjects.push({
                    column: projectCol,
                    value: projectValue.trim(),
                    colIndex: colIndex
                });
                
                // ตรวจสอบว่าเป็นโครงการที่รู้จักหรือไม่
                const isKnownProject = PROJECT_LIST.some(proj => 
                    projectValue.trim().includes(proj) || proj.includes(projectValue.trim())
                );
                
                if (isKnownProject) {
                    appliedProjects.push(projectValue.trim());
                } else {
                    notes.push(`คอลัมน์ ${projectCol}: "${projectValue}" ไม่ใช่โครงการที่รู้จัก`);
                    failedCells[colIndex + 4] = true;
                    passed = false;
                }
            }
        });
        
        // ✅ ตรวจสอบโครงการที่ห้ามสมัครซ้ำ
        let hasExclusiveConflict = false;
        let conflictDetails = [];
        
        EXCLUSIVE_PROJECT_PAIRS.forEach(pair => {
            // ตรวจสอบว่ามีทั้งสองโครงการในแถวนี้หรือไม่
            const hasProject1 = rowProjects.some(p => 
                p.value.includes(pair.project1) || pair.project1.includes(p.value)
            );
            const hasProject2 = rowProjects.some(p => 
                p.value.includes(pair.project2) || pair.project2.includes(p.value)
            );
            
            if (hasProject1 && hasProject2) {
                hasExclusiveConflict = true;
                conflictDetails.push(`${pair.project1} และ ${pair.project2}`);
                
                // ✅ ทำเครื่องหมายเซลล์ที่มีปัญหา
                rowProjects.forEach(p => {
                    if (p.value.includes(pair.project1) || p.value.includes(pair.project2)) {
                        failedCells[p.colIndex + 4] = true;
                    }
                });
            }
        });
        
        // ✅ เงื่อนไขไม่ผ่านถ้ามีโครงการที่ห้ามสมัครซ้ำ
        if (hasExclusiveConflict) {
            passed = false;
            results.failed++;
            rowData.status = "ไม่ผ่าน";
            rowData.notes = `ห้ามสมัครซ้ำ: ${conflictDetails.join(', ')}`;
            results.issues.push({
                row: index + 1,
                message: `ห้ามสมัครซ้ำ: ${conflictDetails.join(', ')}`,
                intechPlot: rowData.intechPlot,
                farmerCode: rowData.farmerCode,
                conflictProjects: conflictDetails
            });
        }
        // ตรวจสอบเงื่อนไขผ่าน: มีโครงการที่รับรอง
        else if (appliedProjects.length > 0) {
            passed = true;
            results.passed++;
            rowData.status = "ผ่าน";
            rowData.notes = `สมัครโครงการ: ${appliedProjects.join(', ')}`;
        }
        // ตรวจสอบเงื่อนไขผ่าน: มี "ไม่เข้าโครงการ" ในทุกคอลัมน์
        else if (notInProjectCount === totalProjectColumns) {
            passed = true;
            results.passed++;
            rowData.status = "ผ่าน";
            rowData.notes = "ไม่เข้าโครงการ (ทุกคอลัมน์)";
        }
        // ตรวจสอบเงื่อนไขผ่าน: มี "ไม่เข้าโครงการ" บางคอลัมน์ แต่ไม่ใช่ทุกคอลัมน์
        else if (notInProjectCount > 0 && notInProjectCount < totalProjectColumns) {
            passed = true;
            results.passed++;
            rowData.status = "ผ่าน";
            rowData.notes = `ไม่เข้าโครงการบางคอลัมน์ (${notInProjectCount}/${totalProjectColumns})`;
        }
        // ตรวจสอบเงื่อนไขผ่าน: ค่าว่างทั้งหมด
        else if (notInProjectCount === 0 && appliedProjects.length === 0) {
            passed = true;
            results.passed++;
            rowData.status = "ผ่าน";
            rowData.notes = "ไม่มีโครงการที่สมัคร";
        }
        // กรณีอื่นๆ (โครงการไม่รู้จัก)
        else {
            passed = false;
            results.failed++;
            rowData.status = "ไม่ผ่าน";
            rowData.notes = notes.join('; ');
            results.issues.push({
                row: index + 1,
                message: notes.join('; '),
                intechPlot: rowData.intechPlot,
                farmerCode: rowData.farmerCode
            });
        }

        rowData.passed = passed;
        rowData.failedCells = failedCells;
    });

    return results;
}

// ฟังก์ชันอัพเดตตารางผลลัพธ์ - เพิ่มเงื่อนไขโครงการ
function updateCheckingTableWithResults(results, condition) {
    checkingTableData.forEach((rowData) => {
        rowData.condition = getConditionDisplayName(condition);
    });
    
    if (condition === "fertilizer") {
        renderFertilizerCheckingTable();
    } else if (condition === "sugarcane") {
        renderCheckingTable();
    } else if (condition === "project") {
        renderProjectCheckingTable();
    }
}

// ในฟังก์ชัน prepareCheckingTable() ให้เพิ่มเงื่อนไขโครงการ
function prepareCheckingTable() {
    const tableBody = document.getElementById('checkingTableBody');
    tableBody.innerHTML = '';
    
    if (!uploadedData || !selectedColumns || selectedColumns.length === 0) {
        console.error('No uploaded data or selected columns');
        return;
    }
    
    if (currentCondition === "sugarcane") {
        prepareSugarcaneCheckingTable();
    } else if (currentCondition === "fertilizer") {
        prepareFertilizerCheckingTable();
    } else if (currentCondition === "project") {
        prepareProjectCheckingTable();
    }
}

// ในฟังก์ชัน displayCheckingResults() เพิ่มส่วนแสดงผลสำหรับโครงการ
function displayCheckingResults(results, condition) {
    const resultsContainer = document.getElementById('checkingResults');
    
    let html = `
        <div class="result-summary">
            <p><i class="fas fa-check-circle" style="color: #4caf50;"></i> ตรวจสอบเงื่อนไข "<strong>${getConditionDisplayName(condition)}</strong>" เรียบร้อยแล้ว</p>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p><strong><i class="fas fa-info-circle"></i> สรุปผลการตรวจสอบ:</strong></p>
                <ul style="margin-top: 5px;">
                    <li>ตรวจทั้งหมด: <strong>${results.totalRows}</strong> แถว</li>
                    <li>ผ่าน: <strong>${results.passed}</strong> แถว</li>
                    <li>ไม่ผ่าน: <strong>${results.failed}</strong> แถว</li>
                    ${results.warnings > 0 ? `<li>ต้องตรวจสอบ: <strong>${results.warnings}</strong> แถว</li>` : ''}
                </ul>
            </div>
    `;
    
    if (condition === "sugarcane") {
        // ...โค้ดเดิม...
    } else if (condition === "fertilizer") {
        // ...โค้ดเดิม...
    } else if (condition === "project") {
        html += `
            <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
                <p><strong><i class="fas fa-info-circle"></i> มาตรฐานการตรวจสอบโครงการ:</strong></p>
                <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #ddd;">
                    <h4 style="color: #2196f3; margin-bottom: 5px;">โครงการที่รับรอง (ต้องมีอย่างน้อย 1 โครงการ)</h4>
                    <ul style="font-size: 0.9em;">
                        ${PROJECT_LIST.map(proj => `<li><strong>${proj}</strong></li>`).join('')}
                    </ul>
                    
                    <h4 style="color: #f44336; margin-top: 15px; margin-bottom: 5px;">เงื่อนไขพิเศษ:</h4>
                    <ul style="font-size: 0.9em;">
                        <li>ถ้ามีข้อความ "<strong>ไม่เข้าโครงการ</strong>" ในคอลัมน์ใดคอลัมน์หนึ่ง → <span style="color: #f44336;">ไม่ผ่าน</span></li>
                        <li>โครงการ <strong>${EXCLUSIVE_PROJECTS.join(' และ ')}</strong> ไม่สามารถสมัครซ้ำได้ในแถวเดียวกัน</li>
                        <li>ถ้าไม่มีโครงการที่สมัครเลย → <span style="color: #4caf50;">ผ่าน</span> (แต่ไม่มีโครงการ)</li>
                    </ul>
                </div>
                
                <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    <i class="fas fa-info-circle"></i> <strong>สีในตาราง:</strong>
                    <span style="color: #4CAF50;">เขียว</span> = โครงการที่สมัคร, 
                    <span style="color: #F44336;">แดง</span> = ไม่ผ่าน/โครงการไม่รู้จัก, 
                    <span style="color: #757575;">เทา/เอียง</span> = "ไม่เข้าโครงการ"
                </p>
            </div>
        `;
    }
    // ในฟังก์ชัน displayCheckingResults() - เพิ่มส่วนแสดงผลสำหรับโครงการ (ปรับเงื่อนไขใหม่)
if (condition === "project") {
    html += `
        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
            <p><strong><i class="fas fa-info-circle"></i> เงื่อนไขการตรวจสอบโครงการใหม่:</strong></p>
            <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #ddd;">
                <h4 style="color: #4CAF50; margin-bottom: 5px;">✅ ผ่าน (สีเขียว):</h4>
                <ul style="font-size: 0.9em;">
                    <li><strong>มีโครงการที่รับรอง</strong> ในคอลัมน์ใดคอลัมน์หนึ่ง</li>
                    <li><strong>มี "ไม่เข้าโครงการ" บางคอลัมน์</strong> (แต่ไม่ใช่ทุกคอลัมน์)</li>
                    <li><strong>ค่าว่างทั้งหมด</strong> (ไม่มีโครงการใดๆ)</li>
                </ul>
                
                <h4 style="color: #F44336; margin-top: 15px; margin-bottom: 5px;">❌ ไม่ผ่าน (สีแดง):</h4>
                <ul style="font-size: 0.9em;">
                    <li><strong>มี "ไม่เข้าโครงการ" ในทุกคอลัมน์</strong> (โครงการ1-5)</li>
                </ul>
                
                <div style="margin-top: 15px; padding: 10px; background: #fff3e0; border-radius: 5px;">
                    <p style="color: #E65100; margin-bottom: 5px;"><strong>📋 โครงการที่รับรอง:</strong></p>
                    <ul style="font-size: 0.85em;">
                        ${PROJECT_LIST.map(proj => `<li>${proj}</li>`).join('')}
                    </ul>
                </div>
            </div>
            
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                <i class="fas fa-info-circle"></i> <strong>สีในตาราง:</strong>
                <span style="color: #4CAF50;">เขียว</span> = โครงการที่สมัคร, 
                <span style="color: #757575;">เทา/เอียง</span> = "ไม่เข้าโครงการ",
                <span style="color: #F44336;">แดง</span> = ไม่ผ่าน (ทุกคอลัมน์เป็น "ไม่เข้าโครงการ")
            </p>
            
            <div style="margin-top: 10px; padding: 8px; background: #e8f5e9; border-radius: 5px; border-left: 4px solid #4CAF50;">
                <p style="margin: 0; font-size: 0.85em; color: #2e7d32;">
                    <i class="fas fa-lightbulb"></i> <strong>ตัวอย่าง:</strong><br>
                    • โครงการ1="ไม่เข้าโครงการ", โครงการ2="เปลี่ยนพืชอื่นมาปลูกอ้อย ปี 69/70" → <strong>ผ่าน</strong><br>
                    • โครงการ1-5 ว่างทั้งหมด → <strong>ผ่าน</strong><br>
                    • ทุกคอลัมน์เป็น "ไม่เข้าโครงการ" → <strong>ไม่ผ่าน</strong>
                </p>
            </div>
        </div>
    `;
}
    html += `</div>`;
    
    resultsContainer.innerHTML = html;
}

// ในฟังก์ชัน runAllConditionChecks() ให้เพิ่มโครงการ
function runAllConditionChecks() {
    const conditions = ["sugarcane", "fertilizer", "project"]; // เพิ่ม "project"
    const allResults = [];
    
    document.getElementById('runAllChecks').disabled = true;
    document.getElementById('runAllChecks').innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังตรวจสอบทั้งหมด...';
    
    let completedChecks = 0;
    
    conditions.forEach(condition => {
        setTimeout(() => {
            currentCondition = condition;
            prepareCheckingTable();
            
            setTimeout(() => {
                let results;
                
                switch(condition) {
                    case "sugarcane":
                        results = performSugarcaneConditionCheck();
                        break;
                    case "fertilizer":
                        results = performFertilizerConditionCheck();
                        break;
                    case "project":
                        results = performProjectConditionCheck();
                        break;
                }
                
                if (results) {
                    allResults.push(results);
                }
                
                completedChecks++;
                
                if (completedChecks === conditions.length) {
                    displayAllConditionResults(allResults);
                    document.getElementById('runAllChecks').disabled = false;
                    document.getElementById('runAllChecks').innerHTML = '<i class="fas fa-play-circle"></i> ตรวจสอบเงื่อนไขทั้งหมด';
                }
            }, 500);
        }, 1000 * conditions.indexOf(condition));
    });
}
// ฟังก์ชันแสดงผลการตรวจสอบทั้งหมด
function displayAllConditionResults(allResults) {
    const resultsContainer = document.getElementById('checkingResults');
    
    let totalPassed = 0;
    let totalFailed = 0;
    let totalWarnings = 0;
    let totalRows = 0;
    
    allResults.forEach(result => {
        totalPassed += result.passed;
        totalFailed += result.failed;
        totalWarnings += result.warnings;
        totalRows += result.totalRows;
    });
    
    let html = `
        <div class="result-summary" style="background: #e3f2fd; border-left-color: #2196f3;">
            <p><i class="fas fa-chart-pie"></i> <strong>สรุปผลการตรวจสอบทั้งหมด</strong></p>
            <p><i class="fas fa-table"></i> ตรวจทั้งหมด: <strong>${totalRows}</strong> แถว (${allResults.length} เงื่อนไข)</p>
            <p><i class="fas fa-check-circle" style="color: #4caf50;"></i> ผ่านทั้งหมด: <strong>${totalPassed}</strong> แถว</p>
            <p><i class="fas fa-times-circle" style="color: #f44336;"></i> ไม่ผ่านทั้งหมด: <strong>${totalFailed}</strong> แถว</p>
            <p><i class="fas fa-exclamation-triangle" style="color: #ff9800;"></i> ต้องตรวจสอบทั้งหมด: <strong>${totalWarnings}</strong> แถว</p>
        </div>
    `;
    
    allResults.forEach((result, index) => {
        const conditionName = getConditionDisplayName(result.condition);
        html += `
            <div class="result-item ${result.failed > 0 || result.warnings > 0 ? 'error' : 'success'}" style="margin-top: 10px;">
                <div class="result-header">
                    <span class="result-condition">${conditionName}</span>
                    <span class="result-count">${result.passed}/${result.totalRows} ผ่าน</span>
                </div>
                <div class="result-details">
                    <p>ผ่าน: ${result.passed} | ไม่ผ่าน: ${result.failed} | ต้องตรวจสอบ: ${result.warnings}</p>
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
    
    alert(`✅ ตรวจสอบเงื่อนไขทั้งหมดเสร็จสิ้น\n\nตรวจทั้งหมด: ${allResults.length} เงื่อนไข\nแถวทั้งหมด: ${totalRows} แถว\nผ่านทั้งหมด: ${totalPassed} แถว\nไม่ผ่านทั้งหมด: ${totalFailed} แถว\nต้องตรวจสอบทั้งหมด: ${totalWarnings} แถว`);
}

// ฟังก์ชันเริ่มต้นระบบตรวจสอบเงื่อนไข
function initConditionChecking() {
    if (!uploadedData || !selectedColumns) {
        document.getElementById('checkingResults').innerHTML = `
            <div class="result-summary">
                <p><i class="fas fa-exclamation-triangle"></i> ยังไม่มีข้อมูล กรุณาไปที่ขั้นตอนที่ 1-3 ก่อน</p>
            </div>
        `;
        return;
    }
    
    setupConditionCheckingSystem();
    prepareCheckingTable();
}

// ฟังก์ชันส่งออกผลการตรวจสอบ
function exportCheckingResultsWithColors() {
    if (!checkingTableData || checkingTableData.length === 0) {
        alert('ไม่มีข้อมูลผลการตรวจสอบที่จะส่งออก');
        return;
    }
    
    // สร้าง CSV content
    let csvContent = '\ufeff';
    
    const tableHeader = document.getElementById('checkingTableHeader');
    const headerRow = tableHeader.querySelector('tr');
    const headers = [];
    
    for (let i = 0; i < headerRow.cells.length; i++) {
        headers.push(headerRow.cells[i].textContent);
    }
    
    csvContent += headers.join(',') + '\n';
    
    checkingTableData.forEach(rowData => {
        const rowValues = [];
        
        for (let i = 0; i < headers.length; i++) {
            const header = headers[i];
            let value = '';
            
            if (header === "ลำดับ") {
                value = rowData.id;
            } else if (header === "โซน") {
                value = rowData.zone || ''; // ✅ เพิ่ม
            } else if (header === "รหัสนักเกษตร") {
                value = rowData.farmerCode || ''; // ✅ เพิ่ม
            } else if (header === "สถานะ") {
                value = rowData.status;
            } else if (header === "หมายเหตุ") {
                value = rowData.notes || '';
            } else if (header === "เงื่อนไขที่ตรวจ") {
                value = rowData.condition || '';
            } else {
                value = rowData[header] || '';
            }
            
            value = value.toString().replace(/"/g, '""');
            if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                value = `"${value}"`;
            }
            
            rowValues.push(value);
        }
        
        csvContent += rowValues.join(',') + '\n';
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `condition_check_results_${currentCondition}_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert(`✅ ดาวน์โหลดผลการตรวจสอบเงื่อนไข "${getConditionDisplayName(currentCondition)}" เรียบร้อย!\nจำนวนแถว: ${checkingTableData.length}`);
}
    
    // ============================================
    // ขั้นตอนที่ 5: เลือกคอลัมน์สำหรับส่งออก
    // ============================================
    backToStep3.addEventListener('click', () => goToStep(3));
    nextToStep4.addEventListener('click', () => {
        // ✅ ตรวจสอบว่าข้อมูลถูกต้อง 100% หรือไม่
        const validPercent = parseInt(correctDataPercent.textContent);
        if (validPercent !== 100) {
            alert(`ข้อมูลถูกต้อง ${validPercent}% ยังไม่ครบ 100% กรุณาตรวจสอบและแก้ไขข้อมูลให้ถูกต้องทั้งหมด`);
            return;
        }
        
        goToStep(4);
    });
    
    backToStep4.addEventListener('click', () => goToStep(4));
    nextToStep5.addEventListener('click', () => goToStep(5));
    
    function initExportColumnSelection() {
        if (!uploadedData || !selectedColumns || selectedColumns.length === 0) {
            alert('กรุณากลับไปที่ขั้นตอนที่ 2-3 เพื่อเตรียมข้อมูลก่อน');
            goToStep(2);
            return;
        }
        
        // ✅ อัพเดต: เลือกคอลัมน์ที่แนะนำโดยอัตโนมัติ
        exportColumns = [];
        
        // เลือกคอลัมน์ที่แนะนำ
        autoExportColumns.forEach(column => {
            if (selectedColumns.includes(column)) {
                exportColumns.push(column);
            }
        });
        
        // ถ้ายังไม่มีคอลัมน์ที่เลือก เลือก 5 คอลัมน์แรก
        if (exportColumns.length === 0) {
            exportColumns = selectedColumns.slice(0, 5);
        }
        
        renderExportColumnGrid();
        updateExportColumnStats();
        
        // เปิดใช้งานปุ่มต่อไป
        nextToStep5.disabled = false;
    }
    
    function renderExportColumnGrid() {
        exportColumnsGrid.innerHTML = '';
        
        const searchTerm = document.getElementById('columnSearch') ? document.getElementById('columnSearch').value.toLowerCase() : '';
        
        selectedColumns.forEach(column => {
            const isSelected = exportColumns.includes(column);
            const columnNameLower = column.toLowerCase();
            const matchesSearch = searchTerm === '' || columnNameLower.includes(searchTerm);
            
            // ตรวจสอบว่าเป็นคอลัมน์แนะนำหรือไม่
            const isRecommended = autoExportColumns.includes(column);
            
            let columnType = '';
            if (columnNameLower.includes('วันที่')) {
                columnType = 'วันที่';
            } else if (columnNameLower.includes('รหัส') || columnNameLower.includes('เลขที่')) {
                columnType = 'รหัส';
            } else if (columnNameLower.includes('จำนวน') || columnNameLower.includes('พื้นที่')) {
                columnType = 'ตัวเลข';
            } else if (columnNameLower.includes('ชื่อ')) {
                columnType = 'ข้อความ';
            } else {
                columnType = 'ข้อมูลทั่วไป';
            }
            
            const columnItem = document.createElement('div');
            columnItem.className = `export-column-item ${isSelected ? 'selected' : ''}`;
            
            columnItem.innerHTML = `
                <input type="checkbox" class="export-column-checkbox" ${isSelected ? 'checked' : ''} data-column="${column}">
                <div class="export-column-info">
                    <div class="export-column-name" title="${column}">${column}</div>
                    ${isRecommended ? '<span style="color: #ff9800; font-size: 0.7rem; background: #fff3e0; padding: 2px 6px; border-radius: 10px; margin-right: 5px;">แนะนำ</span>' : ''}
                    <span class="export-column-type">${columnType}</span>
                </div>
            `;
            
            exportColumnsGrid.appendChild(columnItem);
            
            // เพิ่ม event listener สำหรับ checkbox
            const checkbox = columnItem.querySelector('.export-column-checkbox');
            checkbox.addEventListener('change', function() {
                const columnName = this.dataset.column;
                
                if (this.checked) {
                    if (!exportColumns.includes(columnName)) {
                        exportColumns.push(columnName);
                    }
                } else {
                    const index = exportColumns.indexOf(columnName);
                    if (index > -1) {
                        exportColumns.splice(index, 1);
                    }
                }
                
                // อัพเดต UI
                columnItem.classList.toggle('selected', this.checked);
                updateExportColumnStats();
            });
        });
    }
    
    function updateExportColumnStats() {
        const exportSelectedCountElement = document.getElementById('exportSelectedCount');
        const exportColumnsListElement = document.getElementById('exportColumnsList');
        
        if (exportSelectedCountElement) {
            exportSelectedCountElement.textContent = exportColumns.length;
        }
        
        if (exportColumnsListElement) {
            if (exportColumns.length === 0) {
                exportColumnsListElement.textContent = 'ยังไม่ได้เลือกคอลัมน์';
            } else {
                const displayedColumns = exportColumns.slice(0, 5);
                const moreCount = exportColumns.length - 5;
                exportColumnsListElement.textContent = displayedColumns.join(', ') + 
                    (moreCount > 0 ? ` และอีก ${moreCount} คอลัมน์...` : '');
            }
        }
    }
    
    // Event listeners สำหรับขั้นตอนที่ 5
    exportSelectAllBtn.addEventListener('click', function() {
        exportColumns = [...selectedColumns];
        renderExportColumnGrid();
        updateExportColumnStats();
    });
    
    exportDeselectAllBtn.addEventListener('click', function() {
        exportColumns = [];
        renderExportColumnGrid();
        updateExportColumnStats();
    });
    
    // Filter buttons สำหรับขั้นตอนที่ 5
    document.querySelectorAll('.export-column-selection .selection-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // อัพเดตปุ่ม active
            document.querySelectorAll('.export-column-selection .selection-btn').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            // กรองคอลัมน์ตาม filter
            const filter = this.dataset.filter;
            const columnItems = document.querySelectorAll('.export-column-item');
            
            columnItems.forEach(item => {
                const checkbox = item.querySelector('.export-column-checkbox');
                const columnName = checkbox.dataset.column;
                const isSelected = exportColumns.includes(columnName);
                const isRecommended = autoExportColumns.includes(columnName);
                
                let shouldShow = true;
                
                if (filter === 'recommended') {
                    shouldShow = isRecommended;
                } else if (filter === 'selected') {
                    shouldShow = isSelected;
                } else if (filter === 'unselected') {
                    shouldShow = !isSelected;
                }
                // 'all' แสดงทั้งหมด
                
                item.style.display = shouldShow ? 'flex' : 'none';
            });
        });
    });
    
    // ============================================
    // ดาวน์โหลดข้อมูลที่ Clean แล้ว
    // ============================================
    downloadCleanData.addEventListener('click', function() {
        if (!uploadedData || exportColumns.length === 0) {
            alert('กรุณาเลือกคอลัมน์ที่ต้องการส่งออกก่อน');
            return;
        }
        
        // สร้าง CSV จากคอลัมน์ที่เลือก
        let csvContent = '\ufeff'; // BOM สำหรับ UTF-8
        
        // เพิ่ม headers
        csvContent += exportColumns.join(',') + '\n';
        
        // เพิ่มข้อมูล
        uploadedData.data.forEach(row => {
            const rowValues = exportColumns.map(col => {
                let value = row[col] || '';
                
                // Escape commas and quotes
                value = value.toString().replace(/"/g, '""');
                if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                    value = `"${value}"`;
                }
                
                return value;
            });
            csvContent += rowValues.join(',') + '\n';
        });
        
        // สร้าง blob และดาวน์โหลด
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        
        // สร้างชื่อไฟล์
        const originalName = uploadedData.fileName.replace('.csv', '');
        const timestamp = new Date().toISOString().slice(0,19).replace(/[:T]/g, '-');
        link.setAttribute('download', `cleaned_${originalName}_${timestamp}.csv`);
        
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`✅ ดาวน์โหลดไฟล์ CSV เรียบร้อย!\nจำนวนแถว: ${uploadedData.data.length}\nจำนวนคอลัมน์: ${exportColumns.length}`);
    });
    
    // ============================================
    // Navigation Buttons
    // ============================================
    // Step navigation
    backToStep1.addEventListener('click', () => goToStep(1));
    backToStep2.addEventListener('click', () => goToStep(2));
    backToStep3.addEventListener('click', () => goToStep(3));
    backToStep4.addEventListener('click', () => goToStep(4));
    
    // Initialize the system
    document.addEventListener('DOMContentLoaded', function() {
        // ตั้งค่า event listeners พื้นฐาน
        setupEnhancedEventListeners();
        
        // แสดงข้อความต้อนรับ
        console.log('✅ ระบบ Clean Data สำหรับข้อมูลอ้อยพร้อมใช้งานแล้ว');
        console.log('✅ ระบบตรวจสอบข้อมูลอ้อยครบวงจร - แบบขั้นตอนการใช้งาน');
        
        // แสดงคำแนะนำเบื้องต้น
        setTimeout(() => {
            if (!uploadedData) {
                console.log('ℹ️ กรุณาอัปโหลดไฟล์ CSV ในขั้นตอนที่ 1 เพื่อเริ่มต้น');
            }
        }, 1000);
    });

    // ✅ เพิ่ม: ฟังก์ชันเพื่ออัพเดต progress bars
    function updateProgressBars() {
        const totalCells = currentValidationResults.totalCells || 1;
        const validPercent = ((currentValidationResults.validCells || 0) / totalCells) * 100;
        const warningPercent = ((currentValidationResults.warningCells || 0) / totalCells) * 100;
        const errorPercent = ((currentValidationResults.errorCells || 0) / totalCells) * 100;
        const editedPercent = ((countEditedCells() || 0) / totalCells) * 100;
        
        correctDataBar.style.width = `${validPercent}%`;
        needReviewBar.style.width = `${warningPercent}%`;
        errorDataBar.style.width = `${errorPercent}%`;
        editedCellsBar.style.width = `${editedPercent}%`;
    }

    // ✅ เพิ่ม: ฟังก์ชันเพื่อรีเซ็ตระบบ
    function resetSystem() {
        uploadedData = null;
        allColumns = [];
        selectedColumns = [];
        exportColumns = [];
        currentStep = 1;
        currentFilter = "all";
        currentColumnFilter = "all";
        userSelectedDataTypes = {};
        isShowingAllRows = false;
        currentRowLimit = 50;
        dataTypeConfigVisible = false;
        currentCondition = "sugarcane";
        conditionResults = {};
        checkingTableData = [];
        showOnlyFailed = false;
        
        // รีเซ็ต UI
        document.querySelectorAll('.step').forEach((step, index) => {
            step.classList.remove('active', 'completed');
            if (index === 0) step.classList.add('active');
        });
        
        document.querySelectorAll('.step-panel').forEach((panel, index) => {
            panel.classList.remove('active');
            if (index === 0) panel.classList.add('active');
        });
        
        dashboardSummary.style.display = 'none';
        fileInfo.style.display = 'none';
        uploadArea.style.display = 'block';
        
        // รีเซ็ตตารางต่างๆ
        dataTableHeader.innerHTML = '';
        dataTableBody.innerHTML = '';
        columnsGrid.innerHTML = '';
        exportColumnsGrid.innerHTML = '';
        checkingTableHeader.innerHTML = '';
        checkingTableBody.innerHTML = '';
        
        // รีเซ็ตค่าต่างๆ
        correctDataPercent.textContent = '0%';
        needReviewCount.textContent = '0';
        errorDataCount.textContent = '0';
        editedCellsCount.textContent = '0';
        correctDataBar.style.width = '0%';
        needReviewBar.style.width = '0%';
        errorDataBar.style.width = '0%';
        editedCellsBar.style.width = '0%';
        
        alert('✅ ระบบถูกรีเซ็ตเรียบร้อยแล้ว กรุณาเริ่มต้นใหม่จากขั้นตอนที่ 1');
    }

    // ✅ เพิ่มปุ่มรีเซ็ตระบบ
    document.addEventListener('DOMContentLoaded', function() {
        const resetBtn = document.createElement('button');
        resetBtn.id = 'resetSystemBtn';
        resetBtn.className = 'btn btn-outline btn-sm';
        resetBtn.innerHTML = '<i class="fas fa-redo"></i> รีเซ็ตระบบ';
        resetBtn.style.position = 'fixed';
        resetBtn.style.bottom = '20px';
        resetBtn.style.right = '20px';
        resetBtn.style.zIndex = '1000';
        resetBtn.style.backgroundColor = 'white';
        resetBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('ต้องการรีเซ็ตระบบทั้งหมดและเริ่มต้นใหม่หรือไม่?\nข้อมูลทั้งหมดจะถูกล้างออก')) {
                resetSystem();
            }
        });
        
        document.body.appendChild(resetBtn);
    });

    // ✅ ฟังก์ชันช่วยเหลือเพิ่มเติม
    function formatDateForDisplay(dateString) {
        if (!dateString) return '';
        
        try {
            const date = parseDateString(dateString);
            if (!date) return dateString;
            
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        } catch (error) {
            return dateString;
        }
    }

    function validateThaiPhoneNumber(phone) {
        if (!phone) return true; // ถ้าว่างให้ผ่าน
        const phoneStr = phone.toString().trim();
        return /^0[689]\d{8}$/.test(phoneStr) || /^\+66[689]\d{8}$/.test(phoneStr);
    }

    function validateEmail(email) {
        if (!email) return true; // ถ้าว่างให้ผ่าน
        const emailStr = email.toString().trim();
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailStr);
    }

    // ✅ ฟังก์ชันสุดท้ายสำหรับการเริ่มต้นระบบ
    function initializeCompleteSystem() {
        console.log('🚀 เริ่มต้นระบบ Clean Data สำหรับข้อมูลอ้อย');
        console.log('📊 ระบบรองรับการตรวจสอบข้อมูลอ้อยครบวงจร');
        console.log('🔍 พร้อมใช้งานขั้นตอนที่ 1-5 แล้ว');
        
        // แสดงคำแนะนำการใช้งาน
        setTimeout(() => {
            const welcomeMsg = `
                ========================================
                🎯 ระบบ Clean Data สำหรับข้อมูลอ้อย
                ========================================
                
                ขั้นตอนการใช้งาน:
                1️⃣ อัปโหลดไฟล์ CSV
                2️⃣ เลือกคอลัมน์ที่ต้องการตรวจสอบ
                3️⃣ ตรวจสอบและแก้ไขข้อมูล
                4️⃣ ตรวจสอบเงื่อนไขเฉพาะ
                5️⃣ เลือกคอลัมน์สำหรับส่งออก
                
                ✅ ระบบพร้อมใช้งานแล้ว!
                `;
            console.log(welcomeMsg);
        }, 500);
    }

    // เรียกใช้ฟังก์ชันเริ่มต้นระบบ
    initializeCompleteSystem();

</script>
</body> </html>
