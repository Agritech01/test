<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบ Clean Data - ตรวจสอบข้อมูลอ้อยครบวงจร</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Prompt:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #4cc9f0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f72585;
            --sugarcane-color: #228B22;
            --fertilizer-color: #9C27B0;
            --project-color: #FF5722;
            --border-radius: 12px;
            --box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Prompt', sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        
        header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        
        h1 {
            font-family: 'Kanit', sans-serif;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* Navigation Steps */
        .step-navigation {
            display: flex;
            justify-content: center;
            background-color: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 15px;
            position: relative;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 10px;
            z-index: 2;
            transition: all 0.3s ease;
        }
        
        .step.active .step-number {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 0 0 5px rgba(67, 97, 238, 0.2);
        }
        
        .step.completed .step-number {
            background-color: var(--success-color);
            color: white;
        }
        
        .step-info {
            display: flex;
            flex-direction: column;
        }
        
        .step-title {
            font-weight: 500;
            font-size: 1rem;
        }
        
        .step-description {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        /* Dashboard Summary */
        .dashboard-summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
        }
        
        .summary-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .summary-icon.success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
        }
        
        .summary-icon.warning {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }
        
        .summary-icon.error {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger-color);
        }
        
        .summary-icon.info {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
        }
        
        .summary-content {
            flex: 1;
        }
        
        .summary-content h4 {
            margin: 0 0 5px 0;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 1s ease;
        }
        
        .progress-fill.success {
            background: var(--success-color);
        }
        
        .progress-fill.warning {
            background: var(--warning-color);
        }
        
        .progress-fill.error {
            background: var(--danger-color);
        }
        
        .progress-fill.info {
            background: var(--primary-color);
        }
        
        .summary-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Step Content Area */
        .step-content {
            padding: 40px;
            min-height: 600px;
        }
        
        .step-panel {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .step-panel.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Panel Styling */
        .panel-header {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .panel-header h2 {
            font-size: 2rem;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .panel-header p {
            color: #666;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Upload Section */
        .upload-area {
            border: 3px dashed var(--accent-color);
            border-radius: var(--border-radius);
            padding: 60px 20px;
            text-align: center;
            background-color: rgba(76, 201, 240, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .upload-area:hover {
            background-color: rgba(76, 201, 240, 0.1);
            border-color: var(--primary-color);
        }
        
        .upload-area i {
            font-size: 4rem;
            color: var(--accent-color);
            margin-bottom: 20px;
        }
        
        .upload-area h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--secondary-color);
        }
        
        .upload-area p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .file-info {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .info-item strong {
            display: block;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }
        
        /* Column Selection Panel */
        .column-selection-panel {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-container {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 30px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .search-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .selection-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .selection-btn {
            padding: 8px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .selection-btn:hover {
            background-color: #e9ecef;
        }
        
        .selection-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .columns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .column-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .column-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .column-item.selected {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .column-item.sugarcane {
            border-left: 4px solid var(--sugarcane-color);
        }
        
        .column-item.activity {
            border-left: 4px solid var(--accent-color);
        }
        
        .column-item.project {
            border-left: 4px solid var(--project-color);
        }
        
        .column-item.fertilizer {
            border-left: 4px solid var(--fertilizer-color);
        }
        
        .column-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .column-info {
            flex: 1;
        }
        
        .column-name {
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .column-type {
            font-size: 0.8rem;
            color: #666;
            background-color: #f0f0f0;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .column-stats {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }
        
        .selected-summary {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--success-color);
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* Data Type Configuration */
        .data-type-configuration {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
            display: none;
        }
        
        .data-type-configuration h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .config-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .data-type-table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .data-type-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .data-type-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }
        
        .data-type-table th:hover {
            background-color: var(--secondary-color);
        }
        
        .data-type-table th i {
            margin-left: 5px;
            opacity: 0.7;
        }
        
        .data-type-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .type-select, .format-select, .unit-select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: 'Prompt', sans-serif;
            background: white;
        }
        
        .type-select:focus, .format-select:focus, .unit-select:focus {
            border-color: var(--accent-color);
            outline: none;
        }
        
        .data-sample-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Data Table */
        .data-table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            border: 1px solid #dee2e6;
            border-bottom: none;
        }
        
        .table-info {
            display: flex;
            gap: 20px;
            color: #6c757d;
            font-size: 0.9rem;
            align-items: center;
        }
        
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        #dataStatus {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
        }
        
        #dataStatus:hover {
            opacity: 0.9;
        }
        
        .data-table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            background: white;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--primary-color);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--secondary-color);
        }
        
        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }
        
        .data-table tr:hover td {
            background: #f8f9fa;
        }
        
        /* ✅ สไตล์สำหรับฟิลเตอร์ในหัวตาราง (Dropdown) */
        .data-table th, .checking-table th {
            position: relative;
        }
        
        .filter-dropdown {
            width: calc(100% - 10px);
            margin-top: 5px;
            padding: 4px 6px;
            font-size: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Prompt', sans-serif;
            background-color: white;
        }
        
        .filter-dropdown:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.2);
        }
        
        /* Animation สำหรับ highlight เซลล์ */
        @keyframes highlightCell {
            0% { background-color: #fff3e0; }
            50% { background-color: #ffecb3; }
            100% { background-color: transparent; }
        }
        
        .cell-highlight {
            animation: highlightCell 2s ease;
        }
        
        /* Cell Styling */
        .cell-error {
            background: rgba(247, 37, 133, 0.1) !important;
            color: var(--danger-color) !important;
            font-weight: 600;
            position: relative;
            cursor: pointer;
        }
        
        .cell-error:hover {
            background: rgba(247, 37, 133, 0.2) !important;
        }
        
        .cell-error:after {
            content: "!";
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .cell-warning {
            background: rgba(255, 152, 0, 0.1) !important;
            color: var(--warning-color) !important;
            cursor: pointer;
        }
        
        .cell-valid {
            color: var(--success-color);
        }
        
        .cell-editing {
            background: #fffde7 !important;
            border: 2px solid var(--accent-color) !important;
        }
        /* เพิ่มในส่วน CSS ที่มีอยู่ */

/* Step Card สำหรับขั้นตอนกรอง */
.step-card {
    background-color: #f8f9fa;
    border-radius: var(--border-radius);
    padding: 25px;
    margin-bottom: 20px;
    border-left: 5px solid var(--primary-color);
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.step-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.step-card.success {
    border-left-color: var(--success-color);
}

.step-card.warning {
    border-left-color: var(--warning-color);
}

.step-card.error {
    border-left-color: var(--danger-color);
}

/* Checkbox สำหรับเงื่อนไขกรอง */
.condition-item {
    padding: 12px 0;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: flex-start;
}

.condition-item:last-child {
    border-bottom: none;
}

.condition-item input[type="checkbox"] {
    margin-right: 12px;
    margin-top: 4px;
    transform: scale(1.2);
}

.condition-item label {
    flex: 1;
    cursor: pointer;
    line-height: 1.4;
}

.condition-item label strong {
    color: var(--secondary-color);
}

/* Process Controls */
.process-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
    margin: 30px 0;
}

/* Results Grid ในขั้นตอนกรอง */
.results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-top: 15px;
}

.result-item {
    padding: 15px;
    background-color: white;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}

.result-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 10px rgba(0,0,0,0.1);
}

.result-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 5px;
}

.result-label {
    font-size: 0.85rem;
    color: #666;
}

/* Filter Results */
.filter-results {
    animation: fadeIn 0.5s ease;
}

/* Status สำหรับคอลัมน์ */
.status-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
}

.status-warning {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
}

.status-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
}
        /* Cell Editor Modal */
        .cell-editor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .cell-editor-modal.show {
            display: flex;
        }
        
        .cell-editor-modal .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-header h4 {
            margin: 0;
            color: var(--secondary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6c757d;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .cell-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .cell-info p {
            margin: 5px 0;
            color: #495057;
        }
        
        .error-text {
            color: var(--danger-color) !important;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.1);
        }
        
        .suggestions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        
        .suggestion-item {
            background: #e3f2fd;
            color: var(--primary-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .suggestion-item:hover {
            background: #bbdefb;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Data Type Configuration */
        .data-type-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filter-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover {
            background-color: #e9ecef;
        }
        
        .filter-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .ai-fix-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Kanit', sans-serif;
            transition: all 0.3s ease;
        }
        
        .ai-fix-btn:hover {
            background-color: #3ab0d8;
            transform: translateY(-2px);
        }
        
        .ai-fix-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-cell {
            color: var(--danger-color) !important;
            font-weight: bold;
            background-color: rgba(247, 37, 133, 0.1);
        }
        
        .warning-cell {
            color: var(--warning-color) !important;
            background-color: rgba(255, 152, 0, 0.1);
        }
        
        .editable-cell {
            position: relative;
            cursor: pointer;
        }
        
        .editable-cell:hover {
            background-color: rgba(76, 201, 240, 0.1);
        }
        
        .cell-input {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--accent-color);
            border-radius: 4px;
            font-family: 'Prompt', sans-serif;
            font-size: 0.9rem;
        }
        
        .type-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .type-text {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .type-number {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .type-date {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        .type-enum {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        
        .type-identifier {
            background-color: #e0f2f1;
            color: #00695c;
        }
        
        /* ขั้นตอนที่ 4: ตรวจสอบเงื่อนไข - สไตล์ใหม่ */
        .condition-selection {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .condition-selection h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .condition-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .condition-select-btn {
            padding: 20px 15px;
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .condition-select-btn:hover {
            background-color: #e9ecef;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .condition-select-btn.active {
            background-color: rgba(67, 97, 238, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .condition-select-btn[data-condition="sugarcane"].active {
            background-color: rgba(34, 139, 34, 0.1);
            border-color: var(--sugarcane-color);
            color: var(--sugarcane-color);
        }
        
        .condition-select-btn[data-condition="activity"].active {
            background-color: rgba(76, 201, 240, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        .condition-select-btn[data-condition="project"].active {
            background-color: rgba(255, 87, 34, 0.1);
            border-color: var(--project-color);
            color: var(--project-color);
        }
        
        .condition-select-btn[data-condition="fertilizer"].active {
            background-color: rgba(156, 39, 176, 0.1);
            border-color: var(--fertilizer-color);
            color: var(--fertilizer-color);
        }
        
        .condition-select-btn i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .condition-desc {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }
        
        /* Checking controls */
        .checking-controls {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .checking-info {
            flex: 1;
            min-width: 300px;
        }
        
        .checking-info h4 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .checking-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .checking-stats span {
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #495057;
        }
        
        .checking-stats strong {
            color: var(--primary-color);
        }
        
        .checking-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        /* Checking table */
        .checking-table-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .table-info {
            display: flex;
            gap: 20px;
            color: #6c757d;
            font-size: 0.9rem;
            align-items: center;
        }
        
        .table-info span:first-child {
            font-weight: 500;
            color: var(--secondary-color);
        }
        
        .checking-table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            padding: 0;
        }
        
.checking-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1300px; /* ✅ เพิ่มความกว้างให้พอดีกับคอลัมน์ใหม่ */
}
        
/* ✅ ปรับขนาดคอลัมน์ใหม่ทั้งหมด 12 คอลัมน์ */
.checking-table th:nth-child(1),
.checking-table td:nth-child(1) {
    width: 60px;
    min-width: 60px;
    max-width: 60px;
    text-align: center;
    position: sticky;
    left: 0;
    background: var(--primary-color);
    color: white;
    z-index: 20;
}

.checking-table td:nth-child(1) {
    background: white;
    color: var(--dark-color);
    border-right: 1px solid #eee;
}

.checking-table th:nth-child(2),
.checking-table td:nth-child(2) {
    width: 120px;
    min-width: 120px;
    max-width: 120px;
    position: sticky;
    left: 60px;
    background: var(--primary-color);
    color: white;
    z-index: 20;
    border-right: 1px solid #ddd;
}

.checking-table td:nth-child(2) {
    background: #f8f9fa;
    color: var(--dark-color);
}

.checking-table th:nth-child(3),
.checking-table td:nth-child(3) {
    width: 130px;
    min-width: 130px;
    max-width: 130px;
}

.checking-table th:nth-child(4),
.checking-table td:nth-child(4) {
    width: 100px;
    min-width: 100px;
    max-width: 100px;
    text-align: center;
}

.checking-table th:nth-child(5),
.checking-table td:nth-child(5) {
    width: 140px;
    min-width: 140px;
    max-width: 140px;
}

.checking-table th:nth-child(6),
.checking-table td:nth-child(6) {
    width: 140px;
    min-width: 140px;
    max-width: 140px;
}

.checking-table th:nth-child(7),
.checking-table td:nth-child(7) {
    width: 140px;
    min-width: 140px;
    max-width: 140px;
}

.checking-table th:nth-child(8),
.checking-table td:nth-child(8) {
    width: 140px;
    min-width: 140px;
    max-width: 140px;
}

.checking-table th:nth-child(9),
.checking-table td:nth-child(9) {
    width: 140px;
    min-width: 140px;
    max-width: 140px;
}

.checking-table th:nth-child(10),
.checking-table td:nth-child(10) {
    width: 140px;
    min-width: 140px;
    max-width: 140px;
}

/* ✅ คอลัมน์สถานะ (คอลัมน์ที่ 11) */
.checking-table th:nth-child(11),
.checking-table td:nth-child(11) {
    width: 100px;
    min-width: 100px;
    max-width: 100px;
    text-align: center;
    background-color: #f8f9fa;
}

/* ✅ คอลัมน์หมายเหตุ (คอลัมน์ที่ 12) */
.checking-table th:nth-child(12),
.checking-table td:nth-child(12) {
    width: 200px;
    min-width: 200px;
    max-width: 200px;
    background-color: #f8f9fa;
}
        
        /* ✅ แถวที่ไม่มีข้อมูลวันที่ปลูก - สีเหลือง */
        .checking-table tr.warning-row {
            background-color: rgba(255, 248, 225, 0.7) !important;
            border-left: 4px solid var(--warning-color) !important;
        }
        
        .checking-table tr.warning-row:hover td {
            background-color: rgba(255, 248, 225, 0.9) !important;
        }
        
        .checking-table tr.warning-row td {
            border-bottom: 1px solid rgba(255, 248, 225, 0.5);
        }
        
        /* สำหรับวันที่ปลูกที่ยาวเกินไป */
        .checking-table td[title] {
            cursor: help;
        }
        
        /* เมื่อต้องการแสดงวันที่เต็ม */
        .date-cell-compact:hover {
            overflow: visible;
            white-space: normal;
            background-color: #fffde7 !important;
            z-index: 100;
            position: relative;
        }
        
        /* สำหรับหน้าจอขนาดเล็ก */
        @media (max-width: 768px) {
            .checking-table th:nth-child(4),
            .checking-table td:nth-child(4) {
                width: 100px;
                min-width: 100px;
                max-width: 100px;
                font-size: 0.85em;
            }
            
            .checking-table th:nth-child(3),
            .checking-table td:nth-child(3) {
                width: 120px;
                min-width: 120px;
                max-width: 120px;
                font-size: 0.9em;
            }
        }
        
        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            text-align: center;
            min-width: 80px;
        }
        
        .status-valid {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .status-warning {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(255, 152, 0, 0.3);
        }
        
        .status-error {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(247, 37, 133, 0.3);
        }
        
        .status-info {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(67, 97, 238, 0.3);
        }
        
        /* Checking details */
        .checking-details {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .checking-details h4 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checking-results {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .result-summary {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .result-summary p {
            margin-bottom: 10px;
            color: #495057;
        }
        
        .result-note {
            background: #fff3e0;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #e65100;
        }
        
        .result-item {
            padding: 10px 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .result-item.error {
            border-left-color: var(--danger-color);
            background: rgba(247, 37, 133, 0.05);
        }
        
        .result-item.warning {
            border-left-color: var(--warning-color);
            background: rgba(255, 152, 0, 0.05);
        }
        
        .result-item.success {
            border-left-color: var(--success-color);
            background: rgba(76, 175, 80, 0.05);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .result-condition {
            font-weight: 500;
            color: var(--secondary-color);
        }
        
        .result-count {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .result-details {
            font-size: 0.9rem;
            color: #495057;
            margin-top: 5px;
        }
        
        .result-details ul {
            margin-left: 20px;
            margin-top: 5px;
        }
        
        .result-details li {
            margin-bottom: 3px;
            color: #666;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 25px;
            border-radius: 30px;
            border: none;
            font-family: 'Kanit', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3d8b40;
            transform: translateY(-2px);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        /* Loading Spinner */
        .spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal สำหรับ AI Fix */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        
        /* Step 5: Column Selection for Export */
        .export-column-selection {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .export-column-selection h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-column-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .export-column-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .export-column-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .export-column-item.selected {
            border-color: var(--success-color);
            background-color: rgba(76, 175, 80, 0.05);
        }
        
        .export-column-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .export-column-info {
            flex: 1;
        }
        
        .export-column-name {
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .export-column-type {
            font-size: 0.8rem;
            color: #666;
            background-color: #f0f0f0;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 30px;
            color: #666;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .step-navigation {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            
            .step {
                width: 100%;
                max-width: 300px;
            }
            
            .step-content {
                padding: 30px 20px;
            }
            
            .condition-buttons {
                grid-template-columns: 1fr 1fr;
            }
            
            .data-type-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .selection-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-container {
                min-width: 100%;
            }
            
            .columns-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .data-table-controls {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .checking-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .checking-info {
                min-width: 100%;
            }
            
            .checking-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .table-controls {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .panel-header h2 {
                font-size: 1.5rem;
            }
            
            .upload-area {
                padding: 40px 15px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .navigation-buttons button {
                width: 100%;
            }
            
            .columns-grid {
                grid-template-columns: 1fr;
            }
            
            .selected-summary {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .data-table-controls {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .table-info {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .table-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .config-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .btn-sm {
                width: 100%;
                justify-content: center;
            }
            
            .condition-buttons {
                grid-template-columns: 1fr;
            }
            
            .condition-select-btn {
                padding: 15px;
            }
            
            .checking-stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .checking-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .checking-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-seedling"></i> ระบบ Clean Data สำหรับข้อมูลอ้อย</h1>
            <p class="subtitle">ระบบตรวจสอบข้อมูลอ้อยครบวงจร - แบบขั้นตอนการใช้งาน</p>
        </header>
        
       <!-- แก้ไขส่วน step-navigation -->
<div class="step-navigation">
    <div class="step active" id="step0">
        <div class="step-number">0</div>
        <div class="step-info">
            <div class="step-title">อัปโหลดไฟล์ CSV</div>
            <div class="step-description">อัปโหลดไฟล์ข้อมูลอ้อยของคุณ</div>
        </div>
    </div>
    
    <div class="step" id="step1">
        <div class="step-number">1</div>
        <div class="step-info">
            <div class="step-title">กรองข้อมูลเบื้องต้น</div>
            <div class="step-description">กรองข้อมูลตามเงื่อนไขพื้นฐาน</div>
        </div>
    </div>
    
    <div class="step" id="step2">
        <div class="step-number">2</div>
        <div class="step-info">
            <div class="step-title">เลือกคอลัมน์ที่ต้องการ</div>
            <div class="step-description">ค้นหาและเลือกคอลัมน์ที่ต้องการตรวจสอบ</div>
        </div>
    </div>
    
    <div class="step" id="step3">
        <div class="step-number">3</div>
        <div class="step-info">
            <div class="step-title">ตรวจสอบและแก้ไขข้อมูล</div>
            <div class="step-description">ตรวจสอบและแก้ไขข้อมูลที่เลือก</div>
        </div>
    </div>
    
    <div class="step" id="step4">
        <div class="step-number">4</div>
        <div class="step-info">
            <div class="step-title">ตรวจสอบเงื่อนไข</div>
            <div class="step-description">ตรวจสอบเงื่อนไขเฉพาะข้อมูลอ้อย</div>
        </div>
    </div>
    
    <div class="step" id="step5">
        <div class="step-number">5</div>
        <div class="step-info">
            <div class="step-title">เลือกคอลัมน์สำหรับส่งออก</div>
            <div class="step-description">เลือกคอลัมน์ที่ต้องการส่งออก</div>
        </div>
    </div>
</div>
        
        <!-- Dashboard Summary -->
        <div class="dashboard-summary" id="dashboardSummary" style="display: none;">
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="summary-content">
                        <h4>ข้อมูลถูกต้อง</h4>
                        <div class="summary-value" id="correctDataPercent">0%</div>
                        <div class="summary-progress">
                            <div class="progress-bar">
                                <div class="progress-fill success" id="correctDataBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon warning">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="summary-content">
                        <h4>ต้องตรวจสอบ</h4>
                        <div class="summary-value" id="needReviewCount">0</div>
                        <button class="btn btn-sm btn-outline" id="showReviewBtn" style="margin-top: 5px; display: none;">
                            <i class="fas fa-eye"></i> แสดง
                        </button>
                        <div class="summary-progress">
                            <div class="progress-bar">
                                <div class="progress-fill warning" id="needReviewBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon error">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="summary-content">
                        <h4>ข้อผิดพลาด</h4>
                        <div class="summary-value" id="errorDataCount">0</div>
                        <div class="progress-bar">
                            <div class="progress-fill error" id="errorDataBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon info">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="summary-content">
                        <h4>แก้ไขแล้ว</h4>
                        <div class="summary-value" id="editedCellsCount">0</div>
                        <div class="progress-bar">
                            <div class="progress-fill info" id="editedCellsBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="summary-actions">
                <button class="btn btn-primary btn-sm" id="refreshDashboard">
                    <i class="fas fa-sync-alt"></i> อัพเดต Dashboard
                </button>
                <button class="btn btn-success btn-sm" id="fixAllErrors">
                    <i class="fas fa-robot"></i> AI แก้ไขข้อผิดพลาดทั้งหมด
                </button>
            </div>
        </div>
        
        <div class="step-content">
            <!-- Step 1: Upload CSV File -->
            <div class="step-panel active" id="panel1">
                <div class="panel-header">
                    <h2><i class="fas fa-file-upload"></i> อัปโหลดไฟล์ CSV</h2>
                    <p>อัปโหลดไฟล์ข้อมูลอ้อยของคุณในรูปแบบ CSV (สูงสุด 500MB)</p>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-file-csv"></i>
                    <h3>ลากไฟล์ CSV ของคุณมาวางที่นี่</h3>
                    <p>หรือคลิกเพื่อเลือกไฟล์จากคอมพิวเตอร์ของคุณ</p>
                    <p><strong>รองรับไฟล์ขนาดใหญ่ถึง 500MB</strong></p>
                    <input type="file" id="csvFileInput" class="file-input" accept=".csv" style="display: none;">
                    <button class="btn btn-primary" id="browseBtn">
                        <i class="fas fa-folder-open"></i> เลือกไฟล์ CSV
                    </button>
                </div>
                
              <!-- Step 1: Basic Data Filtering -->
<!-- Step 0: Upload CSV File -->
<div class="step-panel active" id="panel0">
    <!-- เนื้อหาของ panel1 เดิมทั้งหมด -->
</div>
        <h2><i class="fas fa-filter"></i> กรองข้อมูลเบื้องต้น</h2>
        <p>กรองข้อมูลอ้อยตามเงื่อนไขพื้นฐานเพื่อเตรียมความพร้อมก่อนการตรวจสอบ</p>
    </div>
    
    <!-- ข้อมูลสรุปไฟล์ -->
    <div class="file-info" id="fileInfoAfterUpload">
        <h4><i class="fas fa-info-circle"></i> ข้อมูลไฟล์ก่อนกรอง</h4>
        <div class="info-grid">
            <div class="info-item">
                <strong>ชื่อไฟล์:</strong>
                <span id="preFilterFileName">-</span>
            </div>
            <div class="info-item">
                <strong>จำนวนแถว:</strong>
                <span id="preFilterRows">-</span>
            </div>
            <div class="info-item">
                <strong>จำนวนคอลัมน์:</strong>
                <span id="preFilterCols">-</span>
            </div>
            <div class="info-item">
                <strong>สถานะ:</strong>
                <span id="preFilterStatus">ยังไม่ได้กรอง</span>
            </div>
        </div>
    </div>
    
    <!-- เงื่อนไขการกรอง -->
    <div class="condition-selection" style="margin-top: 30px;">
        <h3><i class="fas fa-list-check"></i> เงื่อนไขการกรองข้อมูลเบื้องต้น</h3>
        <div class="conditions-list" style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
            <div class="condition-item">
                <input type="checkbox" id="filterQuota" checked>
                <label for="filterQuota"><strong>1. กรองเลขโควต้า:</strong> ตัดแถวที่มีค่า '59008956' หรือ '40000542' ในคอลัมน์ 'เลขโควต้า'</label>
            </div>
            <div class="condition-item">
                <input type="checkbox" id="filterSugarcaneType" checked>
                <label for="filterSugarcaneType"><strong>2. กรองชื่อประเภทอ้อย:</strong> ตัดแถวที่มีค่า 'พื้นที่เสียหาย' ในคอลัมน์ 'ชื่อประเภทอ้อย'</label>
            </div>
            <div class="condition-item">
                <input type="checkbox" id="filterPlotType" checked>
                <label for="filterPlotType"><strong>3. กรองประเภทแปลง:</strong> ตัดแถวที่มีค่า 'แปลงดัมมี่' ในคอลัมน์ 'ประเภทแปลง'</label>
            </div>
            <div class="condition-item">
                <input type="checkbox" id="fixZone" checked>
                <label for="fixZone"><strong>4. แก้ไขโซน:</strong> แก้ไข 'C1/1' → 'C1' และ 'C4/1' → 'C4' ในคอลัมน์ 'โซน'</label>
            </div>
            <div class="condition-item">
                <input type="checkbox" id="filterDamage" checked>
                <label for="filterDamage"><strong>5. กรองสาเหตุเสียหาย:</strong> ล้างข้อมูลในคอลัมน์ 'พื้นที่เสียหาย' และ 'สาเหตุเสียหาย' เมื่อมีค่า '-', ตัวเลขทั้งหมด, หรือค่าว่าง</label>
            </div>
            <div class="condition-item">
                <input type="checkbox" id="fixFarmerCode" checked>
                <label for="fixFarmerCode"><strong>6. แก้ไขรหัสนักเกษตร:</strong> แก้ไข '2' → '002', '3' → '003', '4' → '004', '8' → '008', '9' → '009'</label>
            </div>
            <div class="condition-item">
                <input type="checkbox" id="processDamageArea" checked>
                <label for="processDamageArea"><strong>7. แปลงพื้นที่เสียหาย:</strong> เรียงข้อมูลจาก Z-A และแปลงเป็นตัวเลขทศนิยม 2 ตำแหน่ง</label>
            </div>
            <div class="condition-item">
                <input type="checkbox" id="processArea" checked>
                <label for="processArea"><strong>8. แปลงและคำนวณพื้นที่:</strong> แปลงเป็นทศนิยม 2 ตำแหน่ง, คำนวณพื้นที่ใหม่, ตัดแถวที่พื้นที่ ≤ 0</label>
            </div>
            <div class="condition-item">
                <input type="checkbox" id="filterIntechPlot" checked>
                <label for="filterIntechPlot"><strong>9. กรองเลขแปลงintech:</strong> ตัดแถวที่มีค่าว่างในคอลัมน์ 'เลขแปลงintech'</label>
            </div>
        </div>
    </div>
    
    <!-- ปุ่มดำเนินการ -->
    <div class="process-controls" style="margin: 30px 0; text-align: center;">
        <button class="btn btn-primary" id="runAllFilters">
            <i class="fas fa-play"></i> เริ่มกรองข้อมูลทั้งหมด (9 ขั้นตอน)
        </button>
        <button class="btn btn-outline" id="selectAllFilters" style="margin-left: 10px;">
            <i class="fas fa-check-double"></i> เลือกทั้งหมด
        </button>
        <button class="btn btn-outline" id="deselectAllFilters" style="margin-left: 10px;">
            <i class="fas fa-times"></i> ยกเลิกทั้งหมด
        </button>
    </div>
    
    <!-- ผลลัพธ์การกรอง -->
    <div class="filter-results" id="filterResults" style="display: none;">
        <h3><i class="fas fa-chart-bar"></i> ผลการกรองข้อมูล</h3>
        
        <!-- สรุปผลการกรอง -->
        <div class="summary-cards" style="margin: 20px 0;">
            <div class="summary-card">
                <div class="summary-icon info">
                    <i class="fas fa-database"></i>
                </div>
                <div class="summary-content">
                    <h4>แถวก่อนกรอง</h4>
                    <div class="summary-value" id="beforeFilterCount">0</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="summary-content">
                    <h4>แถวหลังกรอง</h4>
                    <div class="summary-value" id="afterFilterCount">0</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon warning">
                    <i class="fas fa-filter"></i>
                </div>
                <div class="summary-content">
                    <h4>แถวที่ถูกตัด</h4>
                    <div class="summary-value" id="removedRowsCount">0</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon error">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="summary-content">
                    <h4>เปอร์เซ็นต์ที่ถูกตัด</h4>
                    <div class="summary-value" id="removedPercentage">0%</div>
                </div>
            </div>
        </div>
        
        <!-- รายละเอียดแต่ละขั้นตอน -->
        <div class="step-results-container" id="stepResultsContainer">
            <!-- จะถูกสร้างโดย JavaScript -->
        </div>
        
        <!-- สรุปคอลัมน์ที่พบ -->
        <div class="column-status" id="filterColumnStatus" style="margin-top: 30px;">
            <!-- จะถูกสร้างโดย JavaScript -->
        </div>
    </div>
    
    <!-- ปุ่มนำทาง -->
    <div class="navigation-buttons" style="margin-top: 30px;">
        <button class="btn btn-outline" id="backToStep0">
            <i class="fas fa-arrow-left"></i> ย้อนกลับ
        </button>
        <button class="btn btn-success" id="nextToStep2" disabled>
            ต่อไป <i class="fas fa-arrow-right"></i>
        </button>
    </div>
    
    <!-- Loading spinner -->
    <div id="filterLoadingSpinner" class="spinner" style="display: none;"></div>
</div>
            
            <!-- Step 2: Column Selection -->
            <div class="step-panel" id="panel2">
                <div class="panel-header">
                    <h2><i class="fas fa-columns"></i> เลือกคอลัมน์ที่ต้องการตรวจสอบ</h2>
                    <p>ค้นหาและเลือกคอลัมน์ที่ต้องการตรวจสอบจากทั้งหมด <span id="totalColumns">0</span> คอลัมน์</p>
                </div>
                
                <div class="column-selection-panel">
                    <div class="selection-header">
                        <div class="search-container">
                            <input type="text" id="columnSearch" class="search-box" placeholder="ค้นหาคอลัมน์...">
                        </div>
                        <div class="search-stats">
                            <span>พบ <span id="filteredCount">0</span> คอลัมน์</span>
                            <span>เลือกแล้ว <span id="selectedCount">0</span> คอลัมน์</span>
                        </div>
                    </div>
                    
                    <div class="selection-controls">
                        <button class="selection-btn active" data-filter="all">ทั้งหมด</button>
                        <button class="selection-btn" data-filter="sugarcane">ข้อมูลอ้อย</button>
                        <button class="selection-btn" data-filter="activity">กิจกรรมงวด</button>
                        <button class="selection-btn" data-filter="project">โครงการ</button>
                        <button class="selection-btn" data-filter="fertilizer">ปุ๋ย</button>
                        <button class="selection-btn" data-filter="selected">ที่เลือกแล้ว</button>
                        <button class="selection-btn" data-filter="unselected">ยังไม่เลือก</button>
                    </div>
                    
                    <div class="columns-grid" id="columnsGrid">
                        <!-- Column items will be populated here -->
                    </div>
                    
                    <div class="selected-summary">
                        <div>
                            <h4><i class="fas fa-check-circle"></i> คุณเลือกคอลัมน์แล้ว <span id="selectedSummaryCount">0</span> คอลัมน์</h4>
                            <p id="selectedColumnsList" style="font-size: 0.9rem; color: #666; margin-top: 5px;">ยังไม่ได้เลือกคอลัมน์</p>
                        </div>
                        <div>
                            <button class="btn btn-outline" id="selectAllBtn">
                                <i class="fas fa-check-double"></i> เลือกทั้งหมด
                            </button>
                            <button class="btn btn-outline" id="deselectAllBtn">
                                <i class="fas fa-times"></i> ยกเลิกทั้งหมด
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep1">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="nextToStep3" disabled>
                        ต่อไป <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Data Validation and Editing -->
            <div class="step-panel" id="panel3">
                <div class="panel-header">
                    <h2><i class="fas fa-search"></i> ตรวจสอบและแก้ไขข้อมูล</h2>
                    <p>AI ช่วยตรวจสอบข้อมูลและแสดงผลลัพธ์ คลิกที่เซลล์สีแดงเพื่อแก้ไขได้ทันที</p>
                </div>
                
                <!-- Data Type Configuration -->
                <div class="data-type-configuration" id="dataTypeConfig">
                    <h3><i class="fas fa-cogs"></i> กำหนดประเภทข้อมูลให้แต่ละคอลัมน์</h3>
                    <div class="config-controls">
                        <button class="btn btn-outline btn-sm" id="autoDetectTypes">
                            <i class="fas fa-robot"></i> ตรวจจับประเภทอัตโนมัติ
                        </button>
                        <button class="btn btn-success btn-sm" id="applyDataTypes">
                            <i class="fas fa-check"></i> ใช้การตั้งค่านี้
                        </button>
                    </div>
                    <div class="data-type-table-container">
                        <table class="data-type-table" id="dataTypeTable">
                            <thead>
                                <tr>
                                    <th>คอลัมน์</th>
                                    <th>ตัวอย่างข้อมูล</th>
                                    <th>ประเภทข้อมูล</th>
                                    <th>รูปแบบ</th>
                                    <th>หน่วย</th>
                                    <th>คำอธิบาย</th>
                                </tr>
                            </thead>
                            <tbody id="dataTypeTableBody">
                                <!-- จะถูกเพิ่มโดย JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Data Preview Table -->
                <div class="data-table-controls">
                    <div class="table-info">
                        <span><i class="fas fa-table"></i> แสดง <span id="currentRows">0</span>/<span id="totalRows">0</span> แถว</span>
                        <span><i class="fas fa-columns"></i> <span id="currentColumns">0</span> คอลัมน์</span>
                        <span id="dataStatus"></span>
                    </div>
                    
                    <div class="table-actions">
                        <button class="btn btn-outline btn-sm" id="toggleAllRows">
                            <i class="fas fa-expand"></i> แสดงทั้งหมด (<span id="totalRowCount">0</span>)
                        </button>
                        <button class="btn btn-outline btn-sm" id="exportTable">
                            <i class="fas fa-download"></i> ส่งออกตาราง
                        </button>
                        <button class="btn btn-outline btn-sm" id="showDataTypeConfig">
                            <i class="fas fa-cog"></i> กำหนดประเภทข้อมูล
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <table class="data-table" id="dataPreviewTable">
                        <thead id="dataTableHeader">
                            <!-- Headers will be populated by JavaScript -->
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="cell-editor-modal" id="cellEditorModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4><i class="fas fa-edit"></i> แก้ไขข้อมูลเซลล์</h4>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="cell-info">
                                <p><strong>คอลัมน์:</strong> <span id="editColumnName">-</span></p>
                                <p><strong>แถวที่:</strong> <span id="editRowNumber">-</span></p>
                                <p><strong>ประเภทข้อมูล:</strong> 
                                    <select id="editDataTypeSelect" class="form-control" style="width: auto; display: inline-block; margin-left: 10px;">
                                        <option value="text">ข้อความ</option>
                                        <option value="number">ตัวเลข</option>
                                        <option value="date">วันที่</option>
                                        <option value="enum">ค่าที่กำหนด</option>
                                        <option value="identifier">รหัส</option>
                                    </select>
                                </p>
                                <p><strong>ปัญหาที่พบ:</strong> <span id="editIssue" class="error-text">-</span></p>
                            </div>
                            
                            <div class="form-group">
                                <label for="cellValueInput">ค่าใหม่:</label>
                                <input type="text" id="cellValueInput" class="form-control" placeholder="ป้อนค่าใหม่...">
                                <div class="suggestions" id="valueSuggestions">
                                    <!-- Suggestions will be added here -->
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="correctionReason">เหตุผลในการแก้ไข:</label>
                                <select id="correctionReason" class="form-control">
                                    <option value="">เลือกเหตุผล</option>
                                    <option value="format_error">รูปแบบไม่ถูกต้อง</option>
                                    <option value="invalid_value">ค่าที่ใช้ไม่ได้</option>
                                    <option value="out_of_range">ไม่อยู่ในช่วงที่กำหนด</option>
                                    <option value="typo_error">พิมพ์ผิด</option>
                                    <option value="other">อื่นๆ</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" id="cancelEdit">ยกเลิก</button>
                            <button class="btn btn-success" id="saveEdit">บันทึกการแก้ไข</button>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep2">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="nextToStep4" disabled>
                        <i class="fas fa-arrow-right"></i> ดำเนินการต่อ
                    </button>
                </div>
            </div>
            
            <!-- Step 4: Condition Checking -->
            <div class="step-panel" id="panel4">
                <div class="panel-header">
                    <h2><i class="fas fa-search"></i> ตรวจสอบเงื่อนไขข้อมูลอ้อย</h2>
                    <p>เลือกเงื่อนไขที่ต้องการตรวจสอบ และดูผลการตรวจสอบในตารางด้านล่าง</p>
                </div>
                
                <!-- ปุ่มเลือกเงื่อนไข -->
                <div class="condition-selection">
                    <h3><i class="fas fa-filter"></i> เลือกเงื่อนไขที่ต้องการตรวจสอบ</h3>
                    <div class="condition-buttons">
                        <button class="condition-select-btn active" data-condition="sugarcane">
                            <i class="fas fa-seedling"></i> ประเภทอ้อย
                            <span class="condition-desc">(ต้องมีคอลัมน์: ชื่อประเภทอ้อย, วันที่ปลูก)</span>
                        </button>
                        <button class="condition-select-btn" data-condition="fertilizer">
                            <i class="fas fa-prescription-bottle"></i> ปุ๋ย
                            <span class="condition-desc">(ต้องมีคอลัมน์ที่เกี่ยวข้องกับปุ๋ย)</span>
                        </button>
                    </div>
                </div>
                
                <!-- ข้อมูลการตรวจสอบ -->
                <div class="checking-controls">
                    <div class="checking-info">
                        <h4><i class="fas fa-info-circle"></i> สถานะการตรวจสอบ</h4>
                        <div class="checking-stats">
                            <span>เงื่อนไขที่เลือก: <strong id="selectedCondition">ประเภทอ้อย</strong></span>
                            <span>ตรวจพบ: <strong id="foundIssues">0</strong> ปัญหา</span>
                            <span>ผ่าน: <strong id="passedChecks">0</strong> รายการ</span>
                            <span>ไม่ผ่าน: <strong id="failedChecks">0</strong> รายการ</span>
                            <span>แสดง: <strong id="checkingRowsCount">0</strong> แถวทั้งหมด</span>
                        </div>
                    </div>
                    <div class="checking-actions">
                        <button class="btn btn-primary" id="runSelectedCheck">
                            <i class="fas fa-play"></i> เริ่มตรวจสอบเงื่อนไขที่เลือก
                        </button>
                        <button class="btn btn-success" id="runAllChecks">
                            <i class="fas fa-play-circle"></i> ตรวจสอบเงื่อนไขทั้งหมด
                        </button>
                        <button class="btn btn-outline" id="exportCheckResults">
                            <i class="fas fa-download"></i> ส่งออกผลตรวจสอบ
                        </button>
                    </div>
                </div>
                
                <!-- ตารางแสดงข้อมูลและผลตรวจสอบ -->
                <div class="checking-table-container">
                    <div class="table-controls">
    <div class="table-info">
        <span><i class="fas fa-table"></i> ตารางผลการตรวจสอบเงื่อนไข</span>
        <span id="scrollHint" style="color: var(--accent-color); font-size: 0.9rem; margin-left: 15px;">
            <i class="fas fa-arrow-right"></i> เลื่อนเพื่อดูสถานะและหมายเหตุ
        </span>
    </div>
    <div class="table-actions">
        <!-- ... -->
    </div>
</div>
                    
                    <div class="checking-table-wrapper">
                        <table class="checking-table" id="checkingTable">
                            <thead id="checkingTableHeader">
                                <!-- Headers will be populated by JavaScript based on condition -->
                            </thead>
                            <tbody id="checkingTableBody">
                                <!-- ข้อมูลจะถูกเพิ่มโดย JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- รายละเอียดการตรวจสอบ -->
                <div class="checking-details">
                    <h4><i class="fas fa-list-alt"></i> รายละเอียดผลการตรวจสอบ</h4>
                    <div class="checking-results" id="checkingResults">
                        <div class="result-summary">
                            <p><i class="fas fa-info-circle"></i> กดปุ่มด้านบนเพื่อเริ่มตรวจสอบเงื่อนไข</p>
                            <p class="result-note">เงื่อนไข "ประเภทอ้อย" ต้องการคอลัมน์: <strong>ชื่อประเภทอ้อย</strong> และ <strong>วันที่ปลูก</strong></p>
                            <p class="result-note" style="background: #e8f5e9; color: #2e7d32; margin-top: 10px;">
                                <i class="fas fa-info-circle"></i> วันที่ปลูกที่รองรับ: YYYY/MM/DD, YYYY/M/D, YYYY-MM-DD, DD/MM/YYYY
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep3">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="nextToStep5">
                        <i class="fas fa-arrow-right"></i> ดำเนินการต่อ
                    </button>
                </div>
            </div>
            
            <!-- Step 5: Column Selection for Export -->
            <div class="step-panel" id="panel5">
                <div class="panel-header">
                    <h2><i class="fas fa-download"></i> เลือกคอลัมน์สำหรับส่งออก</h2>
                    <p>เลือกคอลัมน์ที่ต้องการส่งออกหลังจากผ่านการตรวจสอบทั้งหมดแล้ว</p>
                </div>
                
                <div class="export-column-selection">
                    <h3><i class="fas fa-check-circle"></i> เลือกคอลัมน์ที่ต้องการส่งออก</h3>
                    <p>ระบบได้เลือกคอลัมน์พื้นฐานที่จำเป็นให้อัตโนมัติแล้ว คุณสามารถเพิ่ม/ลดคอลัมน์อื่นๆ ได้ตามต้องการ</p>
                    
                    <div class="selection-controls">
                        <button class="selection-btn active" data-filter="all">ทั้งหมด</button>
                        <button class="selection-btn" data-filter="recommended">แนะนำ</button>
                        <button class="selection-btn" data-filter="selected">ที่เลือกแล้ว</button>
                        <button class="selection-btn" data-filter="unselected">ยังไม่เลือก</button>
                    </div>
                    
                    <div class="export-column-list" id="exportColumnsGrid">
                        <!-- Column items will be populated here -->
                    </div>
                    
                    <div class="selected-summary">
                        <div>
                            <h4><i class="fas fa-check-circle"></i> คุณเลือกคอลัมน์แล้ว <span id="exportSelectedCount">0</span> คอลัมน์</h4>
                            <p id="exportColumnsList" style="font-size: 0.9rem; color: #666; margin-top: 5px;">ยังไม่ได้เลือกคอลัมน์</p>
                        </div>
                        <div>
                            <button class="btn btn-outline" id="exportSelectAllBtn">
                                <i class="fas fa-check-double"></i> เลือกทั้งหมด
                            </button>
                            <button class="btn btn-outline" id="exportDeselectAllBtn">
                                <i class="fas fa-times"></i> ยกเลิกทั้งหมด
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-outline" id="backToStep4">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                    <button class="btn btn-success" id="downloadCleanData">
                        <i class="fas fa-download"></i> ดาวน์โหลดข้อมูลที่ Clean แล้ว
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal สำหรับ AI Fix -->
        <div class="modal" id="aiFixModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-robot"></i> AI ช่วยแก้ไขข้อมูล</h3>
                    <button class="close-modal" id="closeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>ระบบกำลังวิเคราะห์และแก้ไขข้อมูลที่ไม่ถูกต้องอัตโนมัติ...</p>
                    <div id="aiFixProgress">
                        <div class="spinner" style="margin: 20px auto;"></div>
                        <p id="aiFixStatus" style="text-align: center;">กำลังประมวลผล...</p>
                    </div>
                    <div id="aiFixResults" style="display: none;">
                        <h4>ผลการแก้ไข</h4>
                        <ul id="fixResultsList">
                            <!-- Results will be added here -->
                        </ul>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-outline" id="cancelAiFix">ยกเลิก</button>
                    <button class="btn btn-success" id="applyAiFix" style="display: none;">นำการแก้ไขไปใช้</button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2023 ระบบ Clean Data สำหรับข้อมูลอ้อย - ตรวจสอบประเภทข้อมูลและเงื่อนไขครบวงจร</p>
        </footer>
    </div>

    <script>
      // ============================================
// ขั้นตอนที่ 1: กรองข้อมูลเบื้องต้น
// ============================================

// ฟังก์ชันเตรียมข้อมูลสำหรับขั้นตอนกรอง
function prepareFilterStep() {
    if (!uploadedData) {
        alert('กรุณาอัปโหลดไฟล์ก่อน');
        return;
    }
    
    // อัพเดตข้อมูลไฟล์ก่อนกรอง
    document.getElementById('preFilterFileName').textContent = uploadedData.fileName;
    document.getElementById('preFilterRows').textContent = uploadedData.data.length.toLocaleString();
    document.getElementById('preFilterCols').textContent = uploadedData.headers.length;
    document.getElementById('preFilterStatus').textContent = 'รอการกรอง';
    
    // อัพเดตจำนวนแถวก่อนกรอง
    document.getElementById('beforeFilterCount').textContent = uploadedData.data.length.toLocaleString();
    
    // แสดงข้อมูลไฟล์
    document.getElementById('fileInfoAfterUpload').classList.add('show');
    
    // เปิดใช้งานปุ่มต่อไป
    document.getElementById('nextToStep2').disabled = true;
    
    console.log('เตรียมขั้นตอนกรองข้อมูลเรียบร้อย');
}

// ฟังก์ชันค้นหาคอลัมน์แบบตรง
function findColumnExact(columnName) {
    if (!uploadedData || !uploadedData.headers) return null;
    
    for (const header of uploadedData.headers) {
        if (header.trim() === columnName) {
            return header;
        }
    }
    
    return null;
}

// ฟังก์ชันตรวจสอบว่าค่าเป็นตัวเลขทั้งหมดหรือไม่
function isAllNumbers(value) {
    if (!value || value.trim() === '') return false;
    
    const cleanedValue = value.trim();
    
    if (!isNaN(cleanedValue) && !isNaN(parseFloat(cleanedValue))) {
        const regex = /^[-+]?\d*\.?\d+$/;
        return regex.test(cleanedValue);
    }
    
    return false;
}

// ฟังก์ชันแปลงเป็นทศนิยม 2 ตำแหน่ง
function formatToTwoDecimals(value) {
    if (value === null || value === undefined || value === '') {
        return '';
    }
    
    const num = parseFloat(value);
    
    if (isNaN(num)) {
        return value;
    }
    
    return num.toFixed(2);
}

// ฟังก์ชันแปลงสัญกรณ์วิทยาศาสตร์
function convertScientificNotation(value) {
    if (!value || value.trim() === '') return value;
    
    const strValue = value.toString().trim();
    
    const scientificNotationRegex = /^[-+]?[0-9]*\.?[0-9]+[eE][-+]?[0-9]+$/;
    
    if (scientificNotationRegex.test(strValue)) {
        try {
            const num = parseFloat(strValue);
            
            if (!isNaN(num)) {
                return num.toLocaleString('fullwide', { useGrouping: false });
            }
        } catch (e) {
            console.warn('ไม่สามารถแปลงสัญกรณ์ทางวิทยาศาสตร์:', strValue, e);
        }
    }
    
    return strValue;
}

// ฟังก์ชันแปลงเป็นข้อความ (สำหรับรหัสนักเกษตร)
function convertToText(value) {
    if (value === null || value === undefined || value === '') {
        return '';
    }
    
    const strValue = value.toString().trim();
    
    if (isAllNumbers(strValue)) {
        return "'" + strValue;
    }
    
    return strValue;
}

// ฟังก์ชันแสดงสถานะคอลัมน์ที่พบ
function showColumnStatusForFilter() {
    const columns = [
        { name: "เลขโควต้า", found: false },
        { name: "ชื่อประเภทอ้อย", found: false },
        { name: "ประเภทแปลง", found: false },
        { name: "โซน", found: false },
        { name: "สาเหตุเสียหาย", found: false },
        { name: "พื้นที่เสียหาย", found: false },
        { name: "รหัสนักเกษตร", found: false },
        { name: "พื้นที่", found: false },
        { name: "เลขแปลงintech", found: false }
    ];
    
    let foundCount = 0;
    columns.forEach(col => {
        col.found = findColumnExact(col.name) !== null;
        if (col.found) foundCount++;
    });
    
    let statusClass = "status-error";
    let statusIcon = "exclamation-triangle";
    let statusTitle = "ไม่พบคอลัมน์บางส่วน";
    
    if (foundCount === columns.length) {
        statusClass = "status-success";
        statusIcon = "check-circle";
        statusTitle = "พบคอลัมน์ทั้งหมด";
    } else if (foundCount > 0) {
        statusClass = "status-warning";
        statusIcon = "exclamation-circle";
        statusTitle = "พบคอลัมน์บางส่วน";
    }
    
    let columnsListHTML = '';
    columns.forEach(col => {
        columnsListHTML += `
            <div class="condition-item">
                <i class="fas fa-${col.found ? 'check text-success' : 'times text-danger'}"></i>
                ${col.name} ${col.found ? '<span class="text-success">(พบ)</span>' : '<span class="text-danger">(ไม่พบ)</span>'}
            </div>
        `;
    });
    
    const columnStatusDiv = document.getElementById('filterColumnStatus');
    if (columnStatusDiv) {
        columnStatusDiv.innerHTML = `
            <div class="column-status ${statusClass}">
                <h5><i class="fas fa-${statusIcon}"></i> ${statusTitle}</h5>
                <p>พบ ${foundCount} จาก ${columns.length} คอลัมน์ที่ต้องการสำหรับการกรอง</p>
                <div class="conditions-list">
                    ${columnsListHTML}
                </div>
                ${foundCount < columns.length ? 
                    '<p class="mt-2"><small>ระบบยังสามารถทำงานได้ แต่ขั้นตอนที่เกี่ยวข้องกับคอลัมน์ที่ไม่พบจะถูกข้ามไป</small></p>' : 
                    ''}
            </div>
        `;
    }
}

// ฟังก์ชันรันการกรองทั้งหมด
async function runAllFilters() {
    if (!uploadedData) return;
    
    const filterLoadingSpinner = document.getElementById('filterLoadingSpinner');
    const runAllFiltersBtn = document.getElementById('runAllFilters');
    const nextToStep2Btn = document.getElementById('nextToStep2');
    
    // แสดง loading
    filterLoadingSpinner.style.display = 'block';
    runAllFiltersBtn.disabled = true;
    runAllFiltersBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังกรองข้อมูล...';
    
    // รีเซ็ตข้อมูลกรอง
    filteredData = [...uploadedData.data];
    const filterStepsResults = {};
    
    // กำหนดลำดับขั้นตอนกรอง
    const filterSteps = [
        { 
            id: 1, 
            title: "กรองเลขโควต้า", 
            checkboxId: "filterQuota",
            description: "ตัดแถวที่มีค่า '59008956' หรือ '40000542' ในคอลัมน์ 'เลขโควต้า'"
        },
        { 
            id: 2, 
            title: "กรองชื่อประเภทอ้อย", 
            checkboxId: "filterSugarcaneType",
            description: "ตัดแถวที่มีค่า 'พื้นที่เสียหาย' ในคอลัมน์ 'ชื่อประเภทอ้อย'"
        },
        { 
            id: 3, 
            title: "กรองประเภทแปลง", 
            checkboxId: "filterPlotType",
            description: "ตัดแถวที่มีค่า 'แปลงดัมมี่' ในคอลัมน์ 'ประเภทแปลง'"
        },
        { 
            id: 4, 
            title: "แก้ไขโซน", 
            checkboxId: "fixZone",
            description: "แก้ไข 'C1/1' → 'C1' และ 'C4/1' → 'C4' ในคอลัมน์ 'โซน'"
        },
        { 
            id: 5, 
            title: "กรองสาเหตุเสียหาย", 
            checkboxId: "filterDamage",
            description: "ล้างข้อมูลในคอลัมน์ 'พื้นที่เสียหาย' และ 'สาเหตุเสียหาย' เมื่อมีค่า '-', ตัวเลขทั้งหมด, หรือค่าว่าง"
        },
        { 
            id: 6, 
            title: "แก้ไขรหัสนักเกษตร", 
            checkboxId: "fixFarmerCode",
            description: "แก้ไข '2' → '002', '3' → '003', '4' → '004', '8' → '008', '9' → '009' ในคอลัมน์ 'รหัสนักเกษตร'"
        },
        { 
            id: 7, 
            title: "แปลงพื้นที่เสียหาย", 
            checkboxId: "processDamageArea",
            description: "เรียงข้อมูลจาก Z-A และแปลงเป็นตัวเลขทศนิยม 2 ตำแหน่งในคอลัมน์ 'พื้นที่เสียหาย'"
        },
        { 
            id: 8, 
            title: "แปลงและคำนวณพื้นที่", 
            checkboxId: "processArea",
            description: "แปลงเป็นทศนิยม 2 ตำแหน่ง, คำนวณ พื้นที่ - พื้นที่เสียหาย, ตัดแถวที่พื้นที่ ≤ 0"
        },
        { 
            id: 9, 
            title: "กรองเลขแปลงintech", 
            checkboxId: "filterIntechPlot",
            description: "ตัดแถวที่มีค่า '' หรือช่องว่างในคอลัมน์ 'เลขแปลงintech'"
        }
    ];
    
    // สร้าง UI สำหรับผลลัพธ์แต่ละขั้นตอน
    const stepResultsContainer = document.getElementById('stepResultsContainer');
    stepResultsContainer.innerHTML = '';
    
    filterSteps.forEach(step => {
        const isEnabled = document.getElementById(step.checkboxId).checked;
        
        const stepResultDiv = document.createElement('div');
        stepResultDiv.className = 'step-card';
        stepResultDiv.id = `filter-step-${step.id}`;
        stepResultDiv.innerHTML = `
            <div class="step-header">
                <div class="step-icon">${step.id}</div>
                <div>
                    <div class="step-title">${step.title}</div>
                    <div class="step-description">${step.description}</div>
                    <div style="font-size: 0.85rem; color: ${isEnabled ? '#4caf50' : '#ff9800'}; margin-top: 5px;">
                        <i class="fas fa-${isEnabled ? 'check-circle' : 'ban'}"></i>
                        ${isEnabled ? 'เปิดใช้งาน' : 'ปิดใช้งาน'}
                    </div>
                </div>
            </div>
            <div class="step-results">
                <div id="filter-step-${step.id}-status" style="text-align: center; padding: 10px;">
                    ${isEnabled ? '<i class="fas fa-spinner fa-spin"></i> รอการประมวลผล...' : '<i class="fas fa-ban"></i> ข้ามขั้นตอน'}
                </div>
            </div>
        `;
        stepResultsContainer.appendChild(stepResultDiv);
    });
    
    // แสดงผลการกรอง
    document.getElementById('filterResults').style.display = 'block';
    
    // ดำเนินการกรองทีละขั้นตอน
    for (let i = 0; i < filterSteps.length; i++) {
        const step = filterSteps[i];
        const stepCard = document.getElementById(`filter-step-${step.id}`);
        const stepStatus = document.getElementById(`filter-step-${step.id}-status`);
        const isEnabled = document.getElementById(step.checkboxId).checked;
        
        let stepResult = {};
        
        if (isEnabled) {
            try {
                switch(step.id) {
                    case 1:
                        stepResult = await filterQuotaData();
                        break;
                    case 2:
                        stepResult = await filterSugarcaneTypeData();
                        break;
                    case 3:
                        stepResult = await filterSugarcaneCategoryData();
                        break;
                    case 4:
                        stepResult = await filterZoneData();
                        break;
                    case 5:
                        stepResult = await filterDamageCauseData();
                        break;
                    case 6:
                        stepResult = await filterFarmerCodeData();
                        break;
                    case 7:
                        stepResult = await processDamageAreaData();
                        break;
                    case 8:
                        stepResult = await processAreaData();
                        break;
                    case 9:
                        stepResult = await filterIntechPlotData();
                        break;
                }
            } catch (error) {
                stepResult = { 
                    success: false, 
                    message: "เกิดข้อผิดพลาด: " + error.message,
                    stats: {}
                };
            }
        } else {
            stepResult = { 
                success: true, 
                skipped: true, 
                message: "ขั้นตอนนี้ถูกปิดใช้งาน",
                stats: {}
            };
        }
        
        // อัพเดต UI
        filterStepsResults[step.id] = stepResult;
        
        if (stepResult.success) {
            stepCard.classList.add('success');
            if (stepResult.skipped) {
                stepStatus.innerHTML = `<i class="fas fa-minus-circle text-warning"></i> ข้ามขั้นตอน`;
                stepStatus.style.color = "var(--warning-color)";
            } else {
                stepStatus.innerHTML = `<i class="fas fa-check-circle text-success"></i> สำเร็จ`;
                stepStatus.style.color = "var(--success-color)";
                
                // แสดงผลลัพธ์
                let resultsHTML = '<div class="results-grid">';
                if (stepResult.stats) {
                    Object.keys(stepResult.stats).forEach(key => {
                        resultsHTML += `
                            <div class="result-item">
                                <div class="result-value">${stepResult.stats[key]}</div>
                                <div class="result-label">${key}</div>
                            </div>
                        `;
                    });
                }
                resultsHTML += '</div>';
                stepStatus.innerHTML += resultsHTML;
            }
        } else {
            stepCard.classList.add('error');
            stepStatus.innerHTML = `<i class="fas fa-times-circle text-danger"></i> ล้มเหลว: ${stepResult.message}`;
            stepStatus.style.color = "var(--danger-color)";
        }
        
        // รอเล็กน้อยระหว่างขั้นตอนเพื่อให้เห็นการเปลี่ยนแปลง
        await delay(200);
    }
    
    // อัพเดตสรุปผล
    updateFilterSummary();
    
    // แสดงสถานะคอลัมน์
    showColumnStatusForFilter();
    
    // ซ่อน loading
    filterLoadingSpinner.style.display = 'none';
    runAllFiltersBtn.disabled = false;
    runAllFiltersBtn.innerHTML = '<i class="fas fa-play"></i> เริ่มกรองข้อมูลทั้งหมด (9 ขั้นตอน)';
    
    // เปิดใช้งานปุ่มต่อไป
    nextToStep2Btn.disabled = false;
    
    // อัพเดตสถานะไฟล์
    document.getElementById('preFilterStatus').textContent = 'กรองข้อมูลเรียบร้อยแล้ว';
    
    console.log('กรองข้อมูลเสร็จสิ้น');
}

// ฟังก์ชันอัพเดตสรุปการกรอง
function updateFilterSummary() {
    const initialRows = uploadedData.data.length;
    const finalRows = filteredData.length;
    const totalRemovedRows = initialRows - finalRows;
    const percentage = initialRows > 0 ? ((totalRemovedRows / initialRows) * 100).toFixed(2) : 0;
    
    document.getElementById('beforeFilterCount').textContent = initialRows.toLocaleString();
    document.getElementById('afterFilterCount').textContent = finalRows.toLocaleString();
    document.getElementById('removedRowsCount').textContent = totalRemovedRows.toLocaleString();
    document.getElementById('removedPercentage').textContent = `${percentage}%`;
}

// ฟังก์ชัน delay
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// ============================================
// ฟังก์ชันกรองข้อมูลแต่ละขั้นตอน
// ============================================

async function filterQuotaData() {
    const columnName = findColumnExact("เลขโควต้า");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'เลขโควต้า'",
            stats: {}
        };
    }
    
    const newFilteredData = [];
    const removedRows = [];
    let removed59008956 = 0;
    let removed40000542 = 0;
    
    filteredData.forEach((row, index) => {
        const value = row[columnName] ? row[columnName].toString().trim() : '';
        let shouldRemove = false;
        
        if (value === '59008956') {
            shouldRemove = true;
            removed59008956++;
        }
        else if (value === '40000542') {
            shouldRemove = true;
            removed40000542++;
        }
        
        if (shouldRemove) {
            removedRows.push({
                index: index + 2,
                value: value
            });
        } else {
            newFilteredData.push(row);
        }
    });
    
    filteredData = newFilteredData;
    
    return {
        success: true,
        removedCount: removedRows.length,
        stats: {
            "ตัดออก": removedRows.length.toLocaleString(),
            "59008956": removed59008956.toLocaleString(),
            "40000542": removed40000542.toLocaleString(),
            "เหลือ": filteredData.length.toLocaleString()
        }
    };
}

async function filterSugarcaneTypeData() {
    const columnName = findColumnExact("ชื่อประเภทอ้อย");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'ชื่อประเภทอ้อย'",
            stats: {}
        };
    }
    
    const newFilteredData = [];
    const removedRows = [];
    let removedCount = 0;
    
    filteredData.forEach((row, index) => {
        const value = row[columnName] ? row[columnName].toString().trim() : '';
        let shouldRemove = false;
        
        if (value === "พื้นที่เสียหาย") {
            shouldRemove = true;
            removedCount++;
        }
        
        if (shouldRemove) {
            removedRows.push({
                index: index + 2,
                value: value
            });
        } else {
            newFilteredData.push(row);
        }
    });
    
    filteredData = newFilteredData;
    
    return {
        success: true,
        removedCount: removedRows.length,
        stats: {
            "ตัดออก": removedRows.length.toLocaleString(),
            "พื้นที่เสียหาย": removedCount.toLocaleString(),
            "เหลือ": filteredData.length.toLocaleString()
        }
    };
}

async function filterSugarcaneCategoryData() {
    const columnName = findColumnExact("ประเภทแปลง");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'ประเภทแปลง'",
            stats: {}
        };
    }
    
    const newFilteredData = [];
    const removedRows = [];
    let removedCount = 0;
    
    filteredData.forEach((row, index) => {
        const value = row[columnName] ? row[columnName].toString().trim() : '';
        let shouldRemove = false;
        
        if (value === "แปลงดัมมี่") {
            shouldRemove = true;
            removedCount++;
        }
        
        if (shouldRemove) {
            removedRows.push({
                index: index + 2,
                value: value
            });
        } else {
            newFilteredData.push(row);
        }
    });
    
    filteredData = newFilteredData;
    
    return {
        success: true,
        removedCount: removedRows.length,
        stats: {
            "ตัดออก": removedRows.length.toLocaleString(),
            "แปลงดัมมี่": removedCount.toLocaleString(),
            "เหลือ": filteredData.length.toLocaleString()
        }
    };
}

async function filterZoneData() {
    const columnName = findColumnExact("โซน");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'โซน'",
            stats: {}
        };
    }
    
    const modifiedData = [];
    const modifiedRows = [];
    let modifiedC1 = 0;
    let modifiedC4 = 0;
    
    filteredData.forEach((row, index) => {
        const modifiedRow = {...row};
        const value = row[columnName] ? row[columnName].toString().trim() : '';
        let isModified = false;
        let newValue = value;
        
        if (value === "C1/1") {
            newValue = "C1";
            isModified = true;
            modifiedC1++;
        } else if (value === "C4/1") {
            newValue = "C4";
            isModified = true;
            modifiedC4++;
        }
        
        modifiedRow[columnName] = newValue;
        
        if (isModified) {
            modifiedRows.push({
                index: index + 2,
                originalValue: value,
                newValue: newValue
            });
        }
        
        modifiedData.push(modifiedRow);
    });
    
    filteredData = modifiedData;
    
    return {
        success: true,
        modifiedCount: modifiedRows.length,
        stats: {
            "แก้ไข": modifiedRows.length.toLocaleString(),
            "C1/1→C1": modifiedC1.toLocaleString(),
            "C4/1→C4": modifiedC4.toLocaleString(),
            "แถวทั้งหมด": filteredData.length.toLocaleString()
        }
    };
}

async function filterDamageCauseData() {
    const damageCauseColumn = findColumnExact("สาเหตุเสียหาย");
    const damageAreaColumn = findColumnExact("พื้นที่เสียหาย");
    
    if (!damageCauseColumn || !damageAreaColumn) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'สาเหตุเสียหาย' หรือ 'พื้นที่เสียหาย'",
            stats: {}
        };
    }
    
    const modifiedData = [];
    const clearedRows = [];
    let clearedDash = 0;
    let clearedNumber = 0;
    let clearedEmpty = 0;
    
    filteredData.forEach((row, index) => {
        const modifiedRow = {...row};
        const damageCauseValue = row[damageCauseColumn] ? row[damageCauseColumn].toString().trim() : '';
        const damageAreaValue = row[damageAreaColumn] ? row[damageAreaColumn].toString().trim() : '';
        let shouldClear = false;
        
        if (damageCauseValue === "-") {
            shouldClear = true;
            clearedDash++;
        } else if (isAllNumbers(damageCauseValue)) {
            shouldClear = true;
            clearedNumber++;
        } else if (damageCauseValue === "") {
            shouldClear = true;
            clearedEmpty++;
        }
        
        if (shouldClear) {
            modifiedRow[damageCauseColumn] = "";
            modifiedRow[damageAreaColumn] = "";
            
            clearedRows.push({
                index: index + 2,
                damageCauseOriginal: damageCauseValue,
                damageAreaOriginal: damageAreaValue
            });
        }
        
        modifiedData.push(modifiedRow);
    });
    
    filteredData = modifiedData;
    
    return {
        success: true,
        clearedCount: clearedRows.length,
        stats: {
            "ล้างข้อมูล": clearedRows.length.toLocaleString(),
            "ค่า '-':": clearedDash.toLocaleString(),
            "ตัวเลขทั้งหมด": clearedNumber.toLocaleString(),
            "ค่าว่าง": clearedEmpty.toLocaleString(),
            "แถวทั้งหมด": filteredData.length.toLocaleString()
        }
    };
}

async function filterFarmerCodeData() {
    const columnName = findColumnExact("รหัสนักเกษตร");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'รหัสนักเกษตร'",
            stats: {}
        };
    }
    
    const modifiedData = [];
    const modifiedRows = [];
    let modified2 = 0;
    let modified3 = 0;
    let modified4 = 0;
    let modified8 = 0;
    let modified9 = 0;
    
    filteredData.forEach((row, index) => {
        const modifiedRow = {...row};
        const value = row[columnName] ? row[columnName].toString().trim() : '';
        let isModified = false;
        let newValue = value;
        
        if (value === "2") {
            newValue = "002";
            isModified = true;
            modified2++;
        } else if (value === "3") {
            newValue = "003";
            isModified = true;
            modified3++;
        } else if (value === "4") {
            newValue = "004";
            isModified = true;
            modified4++;
        } else if (value === "8") {
            newValue = "008";
            isModified = true;
            modified8++;
        } else if (value === "9") {
            newValue = "009";
            isModified = true;
            modified9++;
        }
        
        modifiedRow[columnName] = newValue;
        
        if (isModified) {
            modifiedRows.push({
                index: index + 2,
                originalValue: value,
                newValue: newValue
            });
        }
        
        modifiedData.push(modifiedRow);
    });
    
    filteredData = modifiedData;
    
    return {
        success: true,
        modifiedCount: modifiedRows.length,
        stats: {
            "แก้ไข": modifiedRows.length.toLocaleString(),
            "2→002": modified2.toLocaleString(),
            "3→003": modified3.toLocaleString(),
            "4→004": modified4.toLocaleString(),
            "8→008": modified8.toLocaleString(),
            "9→009": modified9.toLocaleString(),
            "แถวทั้งหมด": filteredData.length.toLocaleString()
        }
    };
}

async function processDamageAreaData() {
    const columnName = findColumnExact("พื้นที่เสียหาย");
    if (!columnName) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'พื้นที่เสียหาย'",
            stats: {}
        };
    }
    
    // เรียงข้อมูลจาก Z-A
    const sortedData = [...filteredData].sort((a, b) => {
        const valueA = a[columnName] ? a[columnName].toString().trim() : '';
        const valueB = b[columnName] ? b[columnName].toString().trim() : '';
        return valueB.localeCompare(valueA);
    });
    
    // แปลงเป็นตัวเลขและจัดรูปแบบ
    const processedData = sortedData.map(row => {
        const modifiedRow = {...row};
        const originalValue = row[columnName] ? row[columnName].toString().trim() : '';
        
        if (originalValue !== '') {
            const formattedValue = formatToTwoDecimals(originalValue);
            modifiedRow[columnName] = formattedValue;
        }
        
        return modifiedRow;
    });
    
    filteredData = processedData;
    
    // นับข้อมูลที่แปลง
    let convertedCount = 0;
    filteredData.forEach(row => {
        const value = row[columnName] ? row[columnName].toString().trim() : '';
        if (value !== '' && !isNaN(parseFloat(value))) {
            convertedCount++;
        }
    });
    
    return {
        success: true,
        stats: {
            "แปลงข้อมูล": convertedCount.toLocaleString(),
            "เรียง Z-A": filteredData.length.toLocaleString(),
            "แถวทั้งหมด": filteredData.length.toLocaleString()
        }
    };
}

async function processAreaData() {
    const areaColumn = findColumnExact("พื้นที่");
    const damageAreaColumn = findColumnExact("พื้นที่เสียหาย");
    
    if (!areaColumn || !damageAreaColumn) {
        return { 
            success: false, 
            skipped: true, 
            message: "ไม่พบคอลัมน์ 'พื้นที่' หรือ 'พื้นที่เสียหาย'",
            stats: {}
        };
    }
    
    const newFilteredData = [];
    const removedRows = [];
    let formattedCount = 0;
    let calculatedCount = 0;
    let removedZeroCount = 0;
    
    filteredData.forEach((row, index) => {
        const modifiedRow = {...row};
        const areaValue = row[areaColumn] ? row[areaColumn].toString().trim() : '';
        const damageAreaValue = row[damageAreaColumn] ? row[damageAreaColumn].toString().trim() : '';
        let shouldRemove = false;
        let newAreaValue = areaValue;
        
        // แปลงพื้นที่เดิมเป็นทศนิยม 2 ตำแหน่ง
        if (areaValue !== '') {
            const formattedAreaValue = formatToTwoDecimals(areaValue);
            if (formattedAreaValue !== areaValue && formattedAreaValue !== '') {
                newAreaValue = formattedAreaValue;
                formattedCount++;
            } else if (!isNaN(parseFloat(areaValue))) {
                formattedCount++;
            }
        }
        
        // คำนวณพื้นที่ใหม่ = พื้นที่ - พื้นที่เสียหาย
        if (newAreaValue !== '' && damageAreaValue !== '') {
            const areaNum = parseFloat(newAreaValue);
            const damageAreaNum = parseFloat(formatToTwoDecimals(damageAreaValue));
            
            if (!isNaN(areaNum) && !isNaN(damageAreaNum)) {
                const newAreaNum = areaNum - damageAreaNum;
                const formattedNewArea = newAreaNum.toFixed(2);
                
                if (formattedNewArea !== newAreaValue) {
                    newAreaValue = formattedNewArea;
                    calculatedCount++;
                }
                
                // ตรวจสอบว่าพื้นที่ใหม่ ≤ 0 หรือไม่
                if (newAreaNum <= 0) {
                    shouldRemove = true;
                    removedZeroCount++;
                }
            }
        }
        
        modifiedRow[areaColumn] = newAreaValue;
        
        if (shouldRemove) {
            removedRows.push({
                index: index + 2,
                areaValue: newAreaValue,
                damageAreaValue: damageAreaValue
                    });
                } else {
                    newFilteredData.push(modifiedRow);
                }
            });
            
            filteredData = newFilteredData;
            
            return {
                success: true,
                removedCount: removedRows.length,
                stats: {
                    "ตัดออก": removedRows.length.toLocaleString(),
                    "แปลงทศนิยม": formattedCount.toLocaleString(),
                    "คำนวณพื้นที่": calculatedCount.toLocaleString(),
                    "พื้นที่ ≤ 0": removedZeroCount.toLocaleString(),
                    "เหลือ": filteredData.length.toLocaleString()
                }
            };
        }
        
        async function filterIntechPlotData() {
            const columnName = findColumnExact("เลขแปลงintech");
            if (!columnName) {
                return { 
                    success: false, 
                    skipped: true, 
                    message: "ไม่พบคอลัมน์ 'เลขแปลงintech'",
                    stats: {}
                };
            }
            
            const newFilteredData = [];
            const removedRows = [];
            let removedCount = 0;
            
            filteredData.forEach((row, index) => {
                const value = row[columnName] ? row[columnName].toString().trim() : '';
                let shouldRemove = false;
                
                if (value === "") {
                    shouldRemove = true;
                    removedCount++;
                }
                
                if (shouldRemove) {
                    removedRows.push({
                        index: index + 2,
                        value: value
                    });
                } else {
                    newFilteredData.push(row);
                }
            });
            
            filteredData = newFilteredData;
            
            return {
                success: true,
                removedCount: removedRows.length,
                stats: {
                    "ตัดออก": removedRows.length.toLocaleString(),
                    "ค่าว่าง": removedCount.toLocaleString(),
                    "เหลือ": filteredData.length.toLocaleString()
                }
            };
        }
        // ข้อมูลสำหรับการตรวจสอบ - แก้ไขตามเงื่อนไขใหม่
        const sugarcaneTypes = [
            "ปลายฝนขยาย", 
            "ปลายฝนรื้อตอ", 
            "ตอ1", 
            "ตอ2", 
            "ตอ3", 
            "ต้นฝนขยาย", 
            "ต้นฝนรื้อตอ", 
            "พื้นที่เสียหาย", 
            ">ตอ3"
        ];
        
        // ✅ เพิ่มข้อมูลสำหรับคอลัมน์ "ประเภทอ้อย" (ตัวเลข)
        const sugarcaneNumbers = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];
        
        const fertilizerTypes = ["ปุ๋ยเคมี", "ปุ๋ยอินทรีย์", "ปุ๋ยชีวภาพ", "ปุ๋ยหมัก", "ปุ๋ยคอก"];

        // ✅ เพิ่ม: ประเภทการใส่ปุ๋ยตามเงื่อนไขใหม่
const fertilizerConditions = {
    // อ้อยปลูกใหม่
    "ปลายฝนขยาย": {
        period1: { minAge: 1, maxAge: 60, expected: "รองพื้น", periodName: "งวด 1" },
        period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 2" },
        period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 3" }
    },
    "ปลายฝนรื้อตอ": {
        period1: { minAge: 1, maxAge: 60, expected: "รองพื้น", periodName: "งวด 1" },
        period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 2" },
        period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 3" }
    },
    "ต้นฝนขยาย": {
        period1: { minAge: 1, maxAge: 60, expected: "รองพื้น", periodName: "งวด 1" },
        period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 2" },
        period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 3" }
    },
    "ต้นฝนรื้อตอ": {
        period1: { minAge: 1, maxAge: 60, expected: "รองพื้น", periodName: "งวด 1" },
        period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 2" },
        period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 3" }
    },
    // อ้อยตอ
    "ตอ1": {
        period1: { minAge: 1, maxAge: 60, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 1" },
        period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 2" },
        period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่3", periodName: "งวด 3" }
    },
    "ตอ2": {
        period1: { minAge: 1, maxAge: 60, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 1" },
        period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 2" },
        period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่3", periodName: "งวด 3" }
    },
    "ตอ3": {
        period1: { minAge: 1, maxAge: 60, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 1" },
        period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 2" },
        period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่3", periodName: "งวด 3" }
    },
    ">ตอ3": {
        period1: { minAge: 1, maxAge: 60, expected: "แต่งหน้าครั้งที่1", periodName: "งวด 1" },
        period2: { minAge: 61, maxAge: 120, expected: "แต่งหน้าครั้งที่2", periodName: "งวด 2" },
        period3: { minAge: 121, maxAge: 180, expected: "แต่งหน้าครั้งที่3", periodName: "งวด 3" }
    }
};

// ✅ เพิ่ม: ฟังก์ชันตรวจสอบว่าประเภทอ้อยอยู่ในกลุ่มใด
function getSugarcaneGroup(sugarcaneType) {
    const newPlantingTypes = ["ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ต้นฝนขยาย", "ต้นฝนรื้อตอ"];
    const ratoonTypes = ["ตอ1", "ตอ2", "ตอ3", ">ตอ3"];
    
    const normalizedType = sugarcaneType.trim();
    
    if (newPlantingTypes.includes(normalizedType)) {
        return "new";
    } else if (ratoonTypes.includes(normalizedType)) {
        return "ratoon";
    } else {
        return "unknown";
    }
}

// ✅ เพิ่ม: ฟังก์ชันตรวจสอบว่าอายุอยู่ในช่วงที่กำหนดหรือไม่
function checkAgeRange(age, minAge, maxAge) {
    if (!age || age.trim() === "") return false;
    
    const ageNum = parseInt(age);
    if (isNaN(ageNum)) return false;
    
    return ageNum >= minAge && ageNum <= maxAge;
}
        
        // ประเภทข้อมูลที่รองรับ
        const dataTypes = ["text", "number", "date", "enum", "identifier"];
        const dataTypeDisplayNames = {
            "text": "Text (ข้อความ)",
            "number": "Number (ตัวเลข)", 
            "date": "Date (วันที่)",
            "enum": "Enum (ค่าเฉพาะ)",
            "identifier": "Identifier (ตัวระบุ)"
        };
        
        // คอลัมน์ที่ต้องการเลือกอัตโนมัติสำหรับขั้นตอนที่ 5
        const autoExportColumns = [
            "โซน", "รหัสนักเกษตร", "ชื่อนักเกษตร", "ชื่อประเภทอ้อย", 
            "พื้นที่", "เลขโควต้า", "ชื่อชาวไร่", "เลขแปลงintech"
        ];
        
        // ตัวแปรเก็บข้อมูล
        let uploadedData = null;
        let allColumns = [];
        let selectedColumns = [];
        let exportColumns = []; // สำหรับขั้นตอนที่ 5
        let dataTypeConfigurations = {};
        let currentStep = 1;
        let currentFilter = "all";
        let currentColumnFilter = "all";
        let currentSort = { column: "column", direction: "asc" };
        let editedCells = {}; // เก็บข้อมูลเซลล์ที่แก้ไข
        
        // สำหรับ Dashboard และ Data Table
        let currentValidationResults = {};
        let cellValidationStatus = {};
        let editingCell = null;
        let totalCells = 0;
        
        // ตัวแปรเพิ่มเติมสำหรับฟังก์ชันใหม่
        let userSelectedDataTypes = {};
        let isShowingAllRows = false;
        let currentRowLimit = 50;
        let dataTypeConfigVisible = false;
        
        // ตัวแปรสำหรับระบบตรวจสอบเงื่อนไข
        let currentCondition = "sugarcane";
        let conditionResults = {};
        let checkingTableData = [];
        let showOnlyFailed = false;
        
        // อ้างอิงองค์ประกอบ DOM
        const csvFileInput = document.getElementById('csvFileInput');
        const uploadArea = document.getElementById('uploadArea');
        const browseBtn = document.getElementById('browseBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileRows = document.getElementById('fileRows');
        const fileCols = document.getElementById('fileCols');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        // Step navigation
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const step5 = document.getElementById('step5');
        
        // Panels
        const panel1 = document.getElementById('panel1');
        const panel2 = document.getElementById('panel2');
        const panel3 = document.getElementById('panel3');
        const panel4 = document.getElementById('panel4');
        const panel5 = document.getElementById('panel5');
        
        // Navigation buttons
        const nextToStep2 = document.getElementById('nextToStep2');
        const nextToStep3 = document.getElementById('nextToStep3');
        const nextToStep4 = document.getElementById('nextToStep4');
        const nextToStep5 = document.getElementById('nextToStep5');
        const backToStep1 = document.getElementById('backToStep1');
        const backToStep2 = document.getElementById('backToStep2');
        const backToStep3 = document.getElementById('backToStep3');
        const backToStep4 = document.getElementById('backToStep4');
        const downloadCleanData = document.getElementById('downloadCleanData');
        
        // Column selection elements
        const totalColumns = document.getElementById('totalColumns');
        const filteredCount = document.getElementById('filteredCount');
        const selectedCount = document.getElementById('selectedCount');
        const selectedSummaryCount = document.getElementById('selectedSummaryCount');
        const selectedColumnsList = document.getElementById('selectedColumnsList');
        const columnSearch = document.getElementById('columnSearch');
        const columnsGrid = document.getElementById('columnsGrid');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const columnFilterButtons = document.querySelectorAll('.selection-btn');
        
        // Dashboard elements
        const dashboardSummary = document.getElementById('dashboardSummary');
        const correctDataPercent = document.getElementById('correctDataPercent');
        const needReviewCount = document.getElementById('needReviewCount');
        const errorDataCount = document.getElementById('errorDataCount');
        const editedCellsCount = document.getElementById('editedCellsCount');
        const correctDataBar = document.getElementById('correctDataBar');
        const needReviewBar = document.getElementById('needReviewBar');
        const errorDataBar = document.getElementById('errorDataBar');
        const editedCellsBar = document.getElementById('editedCellsBar');
        const refreshDashboard = document.getElementById('refreshDashboard');
        const fixAllErrors = document.getElementById('fixAllErrors');
        const showReviewBtn = document.getElementById('showReviewBtn');
        
        // Data Table elements
        const dataTableHeader = document.getElementById('dataTableHeader');
        const dataTableBody = document.getElementById('dataTableBody');
        const cellEditorModal = document.getElementById('cellEditorModal');
        const editColumnName = document.getElementById('editColumnName');
        const editRowNumber = document.getElementById('editRowNumber');
        const editDataType = document.getElementById('editDataType');
        const editIssue = document.getElementById('editIssue');
        const cellValueInput = document.getElementById('cellValueInput');
        const valueSuggestions = document.getElementById('valueSuggestions');
        const saveEdit = document.getElementById('saveEdit');
        const cancelEdit = document.getElementById('cancelEdit');
        const closeModal = document.querySelector('.close-modal');
        const dataStatus = document.getElementById('dataStatus');
        const showAllRows = document.getElementById('toggleAllRows');
        const exportTable = document.getElementById('exportTable');
        const currentRows = document.getElementById('currentRows');
        const totalRows = document.getElementById('totalRows');
        const currentColumns = document.getElementById('currentColumns');
        const totalRowCount = document.getElementById('totalRowCount');
        
        // Data Type Configuration elements
        const dataTypeConfig = document.getElementById('dataTypeConfig');
        const dataTypeTableBody = document.getElementById('dataTypeTableBody');
        const autoDetectTypes = document.getElementById('autoDetectTypes');
        const applyDataTypes = document.getElementById('applyDataTypes');
        const showDataTypeConfig = document.getElementById('showDataTypeConfig');
        const editDataTypeSelect = document.getElementById('editDataTypeSelect');
        
        // Step 4 elements
        const runSelectedCheck = document.getElementById('runSelectedCheck');
        const runAllChecks = document.getElementById('runAllChecks');
        const exportCheckResults = document.getElementById('exportCheckResults');
        const checkingRowsCount = document.getElementById('checkingRowsCount');
        const showOnlyFailedBtn = document.getElementById('showOnlyFailed');
        const showAllResultsBtn = document.getElementById('showAllResults');
        const checkingTableHeader = document.getElementById('checkingTableHeader');
        const foundIssues = document.getElementById('foundIssues');
        const passedChecks = document.getElementById('passedChecks');
        const failedChecks = document.getElementById('failedChecks');
        
        // Step 5 elements
        const exportColumnsGrid = document.getElementById('exportColumnsGrid');
        const exportSelectedCount = document.getElementById('exportSelectedCount');
        const exportColumnsList = document.getElementById('exportColumnsList');
        const exportSelectAllBtn = document.getElementById('exportSelectAllBtn');
        const exportDeselectAllBtn = document.getElementById('exportDeselectAllBtn');
        
        // ============================================
        // ฟังก์ชันจัดการขั้นตอน
        // ============================================
        function goToStep(stepNumber) {
            // อัพเดตขั้นตอนปัจจุบัน
            currentStep = stepNumber;
            
            // อัพเดต navigation steps
            [step1, step2, step3, step4, step5].forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
            
            // อัพเดต panels
            [panel1, panel2, panel3, panel4, panel5].forEach((panel, index) => {
                panel.classList.remove('active');
                if (index + 1 === stepNumber) {
                    panel.classList.add('active');
                }
            });
            
            // แสดงหรือซ่อน Dashboard
            if (stepNumber === 3) {
                dashboardSummary.style.display = 'block';
                initDataValidationSystem();
            } else {
                dashboardSummary.style.display = 'none';
            }
            
            // เรียกใช้งานระบบตรวจสอบเงื่อนไขถ้าไปที่ขั้นตอนที่ 4
            if (stepNumber === 4) {
                setTimeout(initConditionChecking, 100);
            }
            
            // เรียกใช้งานระบบเลือกคอลัมน์สำหรับส่งออกถ้าไปที่ขั้นตอนที่ 5
            if (stepNumber === 5) {
                setTimeout(initExportColumnSelection, 100);
            }
        }
        
        // ============================================
        // ขั้นตอนที่ 1: อัปโหลดไฟล์ CSV (แก้ไขให้กดคลิกครั้งเดียว)
        // ============================================
// ✅ แก้ไข: ฟังก์ชันอัปโหลดไฟล์ที่ทำงานได้
function openFileDialog() {
    console.log('เปิดหน้าต่างเลือกไฟล์...');
    csvFileInput.click();
}

// ✅ ปุ่ม "เลือกไฟล์ CSV" - ใช้ onclick แบบตรง
browseBtn.onclick = function() {
    console.log('คลิกปุ่ม Browse');
    openFileDialog();
};

// ✅ พื้นที่อัปโหลด - ใช้ onclick แบบตรง
uploadArea.onclick = function(event) {
    // ตรวจสอบว่าไม่ได้คลิกที่ปุ่ม
    if (event.target !== browseBtn && !browseBtn.contains(event.target)) {
        console.log('คลิกพื้นที่อัปโหลด');
        openFileDialog();
    }
};

// ✅ แก้ไข: เพิ่ม event listener สำหรับ drag and drop
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = 'var(--primary-color)';
    uploadArea.style.backgroundColor = 'rgba(76, 201, 240, 0.1)';
});
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--accent-color)';
            uploadArea.style.backgroundColor = 'rgba(76, 201, 240, 0.05)';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--accent-color)';
            uploadArea.style.backgroundColor = 'rgba(76, 201, 240, 0.05)';
            
            if (e.dataTransfer.files.length) {
                csvFileInput.files = e.dataTransfer.files;
                handleFileUpload(csvFileInput.files[0]);
            }
        });
        
        csvFileInput.addEventListener('change', function(e) {
            if (this.files.length === 0) return;
            handleFileUpload(this.files[0]);
        });
        
        function handleFileUpload(file) {
            if (!file) return;
            
            // ตรวจสอบขนาดไฟล์ (500MB = 500 * 1024 * 1024 bytes)
            const maxSize = 500 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('ไฟล์มีขนาดใหญ่เกินไป กรุณาเลือกไฟล์ขนาดไม่เกิน 500MB');
                csvFileInput.value = '';
                return;
            }
            
            // แสดงข้อมูลไฟล์
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            
            // แสดง loading spinner
            loadingSpinner.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const csvText = event.target.result;
                    processCSVData(csvText, file.name);
                } catch (error) {
                    alert('เกิดข้อผิดพลาดในการอ่านไฟล์: ' + error.message);
                    loadingSpinner.style.display = 'none';
                }
            };
            
            reader.onerror = function() {
                alert('เกิดข้อผิดพลาดในการอ่านไฟล์');
                loadingSpinner.style.display = 'none';
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function processCSVData(csvText, fileName) {
            try {
                // แยกข้อมูล CSV
                const lines = csvText.split('\n');
                if (lines.length === 0) {
                    throw new Error('ไฟล์ว่างเปล่า');
                }
                
                // ใช้ regex เพื่อแยกค่า CSV ที่ถูกต้อง
                const headers = parseCSVLine(lines[0]);
                
                // สร้างข้อมูล
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const values = parseCSVLine(lines[i]);
                    const row = {};
                    
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    
                    data.push(row);
                }
                
                // บันทึกข้อมูล
                uploadedData = {
                    headers: headers,
                    data: data,
                    fileName: fileName,
                    totalRows: data.length,
                    totalCols: headers.length
                };
                
                // อัพเดต UI
                fileRows.textContent = data.length;
                fileCols.textContent = headers.length;
                fileInfo.classList.add('show');
                loadingSpinner.style.display = 'none';
                
                // เปิดใช้งานปุ่มต่อไป
                nextToStep2.disabled = false;
                
                console.log('โหลดข้อมูลสำเร็จ:', uploadedData);
            } catch (error) {
                alert('รูปแบบไฟล์ CSV ไม่ถูกต้อง: ' + error.message);
                loadingSpinner.style.display = 'none';
            }
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    // ตรวจสอบว่าเป็น escaped quote หรือไม่
                    if (i + 1 < line.length && line[i + 1] === '"') {
                        current += '"';
                        i++; // ข้าม quote ถัดไป
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        // ในส่วน Event Listeners
document.getElementById('runAllFilters').addEventListener('click', runAllFilters);
document.getElementById('selectAllFilters').addEventListener('click', function() {
    document.querySelectorAll('#panel1 input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = true;
    });
});
document.getElementById('deselectAllFilters').addEventListener('click', function() {
    document.querySelectorAll('#panel1 input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
});

// ปรับปรุงฟังก์ชัน goToStep
function goToStep(stepNumber) {
    // อัพเดตขั้นตอนปัจจุบัน
    currentStep = stepNumber;
    
    // อัพเดต navigation steps
    const steps = [step0, step1, step2, step3, step4, step5];
    steps.forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index < stepNumber) {
            step.classList.add('completed');
        } else if (index === stepNumber) {
            step.classList.add('active');
        }
    });
    
    // อัพเดต panels
    const panels = [panel0, panel1, panel2, panel3, panel4, panel5];
    panels.forEach((panel, index) => {
        panel.classList.remove('active');
        if (index === stepNumber) {
            panel.classList.add('active');
        }
    });
    
    // เตรียมข้อมูลสำหรับขั้นตอนที่ 1
    if (stepNumber === 1) {
        setTimeout(prepareFilterStep, 100);
    }
    
    // แสดงหรือซ่อน Dashboard
    if (stepNumber === 3) {
        dashboardSummary.style.display = 'block';
        initDataValidationSystem();
    } else {
        dashboardSummary.style.display = 'none';
    }
    
    // เรียกใช้งานระบบตรวจสอบเงื่อนไขถ้าไปที่ขั้นตอนที่ 4
    if (stepNumber === 4) {
        setTimeout(initConditionChecking, 100);
    }
    
    // เรียกใช้งานระบบเลือกคอลัมน์สำหรับส่งออกถ้าไปที่ขั้นตอนที่ 5
    if (stepNumber === 5) {
        setTimeout(initExportColumnSelection, 100);
    }
}

// ปรับปรุง navigation buttons
document.getElementById('nextToStep1').addEventListener('click', function() {
    if (!uploadedData) {
        alert('กรุณาอัปโหลดไฟล์ก่อน');
        return;
    }
    goToStep(1);
});

document.getElementById('backToStep0').addEventListener('click', function() {
    goToStep(0);
});

document.getElementById('nextToStep2').addEventListener('click', function() {
    if (filteredData.length === 0) {
        alert('กรุณากรองข้อมูลก่อนดำเนินการต่อ');
        return;
    }
    
    // อัพเดต uploadedData ด้วยข้อมูลที่กรองแล้ว
    uploadedData.data = filteredData;
    uploadedData.totalRows = filteredData.length;
    
    // ไปยังขั้นตอนที่ 2
    goToStep(2);
});

// ปรับปรุงชื่อตัวแปร
const step0 = document.getElementById('step0');
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const step3 = document.getElementById('step3');
const step4 = document.getElementById('step4');
const step5 = document.getElementById('step5');

const panel0 = document.getElementById('panel0');
const panel1 = document.getElementById('panel1');
const panel2 = document.getElementById('panel2');
const panel3 = document.getElementById('panel3');
const panel4 = document.getElementById('panel4');
const panel5 = document.getElementById('panel5');
      let filteredData = []; // สำหรับเก็บข้อมูลที่กรองแล้ว
        // ============================================
        // ขั้นตอนที่ 2: เลือกคอลัมน์
        // ============================================
        nextToStep2.addEventListener('click', function() {
            if (!uploadedData) {
                alert('กรุณาอัปโหลดไฟล์ก่อน');
                return;
            }
            
            // เตรียมข้อมูลคอลัมน์ทั้งหมด
            prepareColumnSelection();
            
            // ไปยังขั้นตอนที่ 2
            goToStep(2);
        });
        
        function prepareColumnSelection() {
            allColumns = [...uploadedData.headers];
            
            // ✅ แก้ไข: เลือกคอลัมน์ทั้งหมดอัตโนมัติ
            selectedColumns = [...allColumns];
            
            // อัพเดตจำนวนคอลัมน์ทั้งหมด
            totalColumns.textContent = allColumns.length;
            
            // สร้างรายการคอลัมน์
            renderColumnGrid();
            
            // อัพเดตสถิติ
            updateColumnStats();
            
            // ✅ แก้ไข: เปิดใช้งานปุ่มต่อไปทันทีเมื่อเลือกคอลัมน์ทั้งหมด
            nextToStep3.disabled = false;
        }
        
        function renderColumnGrid() {
            columnsGrid.innerHTML = '';
            
            const searchTerm = columnSearch.value.toLowerCase();
            
            allColumns.forEach(column => {
                // ตรวจสอบว่าคอลัมน์นี้ผ่านการกรองหรือไม่
                const columnNameLower = column.toLowerCase();
                const isSelected = selectedColumns.includes(column);
                const matchesSearch = searchTerm === '' || columnNameLower.includes(searchTerm);
                
                // ตรวจสอบประเภทคอลัมน์
                let columnType = '';
                let columnClass = '';
                
                if (columnNameLower.includes('ประเภทอ้อย') || columnNameLower.includes('sugarcane') || 
                    columnNameLower.includes('พันธุ์') || columnNameLower.includes('type')) {
                    columnType = 'ข้อมูลอ้อย';
                    columnClass = 'sugarcane';
                } else if (columnNameLower.includes('อายุ') || columnNameLower.includes('age') ||
                          columnNameLower.includes('งวด') || columnNameLower.includes('period') ||
                          columnNameLower.includes('กิจกรรม') || columnNameLower.includes('activity')) {
                    columnType = 'กิจกรรมงวด';
                    columnClass = 'activity';
                } else if (columnNameLower.includes('โครงการ') || columnNameLower.includes('project')) {
                    columnType = 'โครงการ';
                    columnClass = 'project';
                } else if (columnNameLower.includes('ปุ๋ย') || columnNameLower.includes('fertilizer') ||
                          columnNameLower.includes('ยา') || columnNameLower.includes('chemical')) {
                    columnType = 'ปุ๋ย';
                    columnClass = 'fertilizer';
                } else if (columnNameLower.includes('วันที่') || columnNameLower.includes('date')) {
                    columnType = 'วันที่';
                } else if (columnNameLower.includes('รหัส') || columnNameLower.includes('code') || 
                          columnNameLower.includes('id') || columnNameLower.includes('หมายเลข')) {
                    columnType = 'รหัส';
                } else if (columnNameLower.includes('จำนวน') || columnNameLower.includes('quantity') ||
                          columnNameLower.includes('ปริมาณ') || columnNameLower.includes('amount') ||
                          columnNameLower.includes('พื้นที่') || columnNameLower.includes('area')) {
                    columnType = 'จำนวน';
                } else if (columnNameLower === 'lat' || columnNameLower === 'latitude') {
                    columnType = 'พิกัด lat';
                    columnClass = 'sugarcane';
                } else if (columnNameLower === 'long' || columnNameLower === 'longitude') {
                    columnType = 'พิกัด long';
                    columnClass = 'sugarcane';
                } else {
                    columnType = 'ข้อมูลทั่วไป';
                }
                
                // ตรวจสอบว่าควรแสดงคอลัมน์นี้ตาม filter ปัจจุบันหรือไม่
                let shouldShow = matchesSearch;
                
                if (currentColumnFilter === 'selected') {
                    shouldShow = shouldShow && isSelected;
                } else if (currentColumnFilter === 'unselected') {
                    shouldShow = shouldShow && !isSelected;
                } else if (currentColumnFilter !== 'all') {
                    shouldShow = shouldShow && columnClass === currentColumnFilter;
                }
                
                // ตรวจสอบว่าคอลัมน์นี้มีข้อมูลหรือไม่ (ตัวอย่าง 5 แถวแรก)
                const sampleValues = uploadedData.data.slice(0, 5).map(row => row[column]);
                const emptyCount = sampleValues.filter(v => v === '').length;
                const fillRate = ((sampleValues.length - emptyCount) / sampleValues.length * 100).toFixed(0);
                
                const columnItem = document.createElement('div');
                columnItem.className = `column-item ${columnClass} ${isSelected ? 'selected' : ''}`;
                columnItem.style.display = shouldShow ? 'flex' : 'none';
                
                columnItem.innerHTML = `
                    <input type="checkbox" class="column-checkbox" ${isSelected ? 'checked' : ''} data-column="${column}">
                    <div class="column-info">
                        <div class="column-name" title="${column}">${column}</div>
                        <span class="column-type">${columnType}</span>
                        <div class="column-stats">
                            <i class="fas fa-database"></i> มีข้อมูล ${fillRate}%
                        </div>
                    </div>
                `;
                
                columnsGrid.appendChild(columnItem);
                
                // เพิ่ม event listener สำหรับ checkbox
                const checkbox = columnItem.querySelector('.column-checkbox');
                checkbox.addEventListener('change', function() {
                    const columnName = this.dataset.column;
                    
                    if (this.checked) {
                        if (!selectedColumns.includes(columnName)) {
                            selectedColumns.push(columnName);
                        }
                    } else {
                        const index = selectedColumns.indexOf(columnName);
                        if (index > -1) {
                            selectedColumns.splice(index, 1);
                        }
                    }
                    
                    // อัพเดต UI
                    columnItem.classList.toggle('selected', this.checked);
                    updateColumnStats();
                    
                    // เปิด/ปิดใช้งานปุ่มต่อไป
                    nextToStep3.disabled = selectedColumns.length === 0;
                });
            });
            
            // อัพเดตจำนวนคอลัมน์ที่แสดง
            updateFilteredCount();
        }
        
        function updateColumnStats() {
            selectedCount.textContent = selectedColumns.length;
            selectedSummaryCount.textContent = selectedColumns.length;
            
            if (selectedColumns.length === 0) {
                selectedColumnsList.textContent = 'ยังไม่ได้เลือกคอลัมน์';
            } else {
                const displayedColumns = selectedColumns.slice(0, 3);
                const moreCount = selectedColumns.length - 3;
                selectedColumnsList.textContent = displayedColumns.join(', ') + 
                    (moreCount > 0 ? ` และอีก ${moreCount} คอลัมน์...` : '');
            }
        }
        
        function updateFilteredCount() {
            const visibleColumns = Array.from(columnsGrid.querySelectorAll('.column-item'))
                .filter(item => item.style.display !== 'none');
            filteredCount.textContent = visibleColumns.length;
        }
        
        // Search functionality
        columnSearch.addEventListener('input', function() {
            renderColumnGrid();
        });
        
        // Column filter buttons
        columnFilterButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                // อัพเดตปุ่มที่ active
                columnFilterButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // ตั้งค่าตัวกรอง
                currentColumnFilter = this.dataset.filter;
                
                // กรองคอลัมน์
                renderColumnGrid();
            });
        });
        
        // Select all / Deselect all
        selectAllBtn.addEventListener('click', function() {
            const visibleColumns = Array.from(columnsGrid.querySelectorAll('.column-item'))
                .filter(item => item.style.display !== 'none');
            
            visibleColumns.forEach(item => {
                const checkbox = item.querySelector('.column-checkbox');
                const columnName = checkbox.dataset.column;
                
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    if (!selectedColumns.includes(columnName)) {
                        selectedColumns.push(columnName);
                    }
                    item.classList.add('selected');
                }
            });
            
            updateColumnStats();
            nextToStep3.disabled = selectedColumns.length === 0;
        });
        
        deselectAllBtn.addEventListener('click', function() {
            const visibleColumns = Array.from(columnsGrid.querySelectorAll('.column-item'))
                .filter(item => item.style.display !== 'none');
            
            visibleColumns.forEach(item => {
                const checkbox = item.querySelector('.column-checkbox');
                const columnName = checkbox.dataset.column;
                
                if (checkbox.checked) {
                    checkbox.checked = false;
                    const index = selectedColumns.indexOf(columnName);
                    if (index > -1) {
                        selectedColumns.splice(index, 1);
                    }
                    item.classList.remove('selected');
                }
            });
            
            updateColumnStats();
            nextToStep3.disabled = selectedColumns.length === 0;
        });
        
        // ============================================
        // ขั้นตอนที่ 3: ตรวจสอบประเภทข้อมูล
        // ============================================
        nextToStep3.addEventListener('click', function() {
            if (selectedColumns.length === 0) {
                alert('กรุณาเลือกคอลัมน์ที่ต้องการตรวจสอบ');
                return;
            }
            
            // ไปยังขั้นตอนที่ 3
            goToStep(3);
        });
        
        // ============================================
        // ระบบตรวจสอบข้อมูล (Step 3)
        // ============================================
        function initDataValidationSystem() {
            // แสดง Dashboard
            dashboardSummary.style.display = 'block';
            
            // รันการตรวจสอบข้อมูลจากข้อมูลที่อัปโหลด
            if (uploadedData && selectedColumns.length > 0) {
                runDataValidationFromUploadedData();
            }
        }
        
        function runDataValidationFromUploadedData() {
            if (!uploadedData || selectedColumns.length === 0) return;
            
            // ✅ แก้ไข: ตัดแถวที่ว่างทั้งหมดออกก่อนตรวจสอบ
            const removedCount = removeEmptyRows();
            if (removedCount > 0) {
                alert(`✅ ตัดแถวที่ว่างทั้งหมดออกแล้ว: ${removedCount} แถว`);
            }
            
            currentValidationResults = {
                totalCells: 0,
                validCells: 0,
                warningCells: 0,
                errorCells: 0,
                details: {}
            };
            
            cellValidationStatus = {};
            
            // ใช้แถวแรกตามจำนวนที่กำหนด (เริ่มต้น 50 แถว)
            const sampleRows = uploadedData.data.slice(0, currentRowLimit);
            totalCells = sampleRows.length * selectedColumns.length;
            
            // ตรวจสอบแต่ละเซลล์ในข้อมูลที่อัปโหลด
            sampleRows.forEach((row, rowIndex) => {
                selectedColumns.forEach((columnName, colIndex) => {
                    const cellValue = row[columnName] || '';
                    
                    // ✅ แก้ไข: ถ้าค่าเป็นช่องว่าง ให้ผ่านได้เลย
                    if (cellValue.trim() === '') {
                        if (!cellValidationStatus[rowIndex]) {
                            cellValidationStatus[rowIndex] = {};
                        }
                        cellValidationStatus[rowIndex][colIndex] = {
                            status: 'valid',
                            message: 'ค่าว่าง - ผ่าน',
                            suggestions: [],
                            dataType: 'text',
                            edited: false
                        };
                        
                        currentValidationResults.totalCells++;
                        currentValidationResults.validCells++;
                        return;
                    }
                    
                    // ใช้ประเภทข้อมูลที่ผู้ใช้เลือก หรือตรวจจับอัตโนมัติ
                    const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, cellValue);
                    const validation = validateCellData(columnName, cellValue, columnType, rowIndex, colIndex);
                    
                    // บันทึกผลการตรวจสอบ
                    if (!cellValidationStatus[rowIndex]) {
                        cellValidationStatus[rowIndex] = {};
                    }
                    
                    cellValidationStatus[rowIndex][colIndex] = validation;
                    
                    // นับสถิติ
                    currentValidationResults.totalCells++;
                    
                    if (validation.status === 'valid') {
                        currentValidationResults.validCells++;
                    } else if (validation.status === 'warning') {
                        currentValidationResults.warningCells++;
                    } else if (validation.status === 'error') {
                        currentValidationResults.errorCells++;
                    }
                    
                    // บันทึกรายละเอียด
                    if (!currentValidationResults.details[columnName]) {
                        currentValidationResults.details[columnName] = {
                            errors: [],
                            warnings: []
                        };
                    }
                    
                    if (validation.status === 'error') {
                        currentValidationResults.details[columnName].errors.push({
                            row: rowIndex + 1,
                            value: cellValue,
                            message: validation.message
                        });
                    } else if (validation.status === 'warning') {
                        currentValidationResults.details[columnName].warnings.push({
                            row: rowIndex + 1,
                            value: cellValue,
                            message: validation.message
                        });
                    }
                });
            });
            
            // แสดงข้อมูลในตาราง
            renderDataTableFromUploadedData();
            
            // อัพเดต Dashboard
            updateDashboard();
        }
        
        // ✅ แก้ไขฟังก์ชันตรวจจับประเภทข้อมูลตามข้อกำหนดใหม่
        function detectColumnType(columnName, sampleValue) {
            const columnNameLower = columnName.toLowerCase();
            
            // ✅ แก้ไข: คอลัมน์ "ชื่อประเภทอ้อย" ให้เป็นประเภท "text" (ข้อความ)
            if (columnNameLower === 'ชื่อประเภทอ้อย' || 
                columnNameLower.includes('ชื่อประเภทอ้อย')) {
                return 'text';
            }
            
            // ✅ แก้ไข: คอลัมน์ "ประเภทอ้อย" ให้เป็นประเภท "number" (ตัวเลข)
            if (columnNameLower === 'ประเภทอ้อย' || 
                columnNameLower.includes('ประเภทอ้อย')) {
                return 'number';
            }
            
            // ✅ แก้ไข: คอลัมน์ "ประวัติการใช้พื้นที่" เป็นข้อความโดยอัตโนมัติ
            if (columnNameLower.includes('ประวัติการใช้พื้นที่') || 
                columnNameLower.includes('ประวัติ') || 
                columnNameLower.includes('การใช้พื้นที่')) {
                return 'text';
            }
            
            // ✅ แก้ไข: คอลัมน์ "ความเสี่ยงพื้นที่" เป็นข้อความ
            if (columnNameLower.includes('ความเสี่ยงพื้นที่') || columnNameLower.includes('ความเสี่ยง')) {
                return 'text';
            }
            
            // ✅ แก้ไข: คอลัมน์ "ความลาดเอียงของพื้นที่" เป็นข้อความ
            if (columnNameLower.includes('ความลาดเอียง') || columnNameLower.includes('ลาดเอียง') || columnNameLower.includes('slope')) {
                return 'text';
            }
            
            // ตรวจสอบจากชื่อคอลัมน์ (ให้ความสำคัญสูงสุด)
            if (columnNameLower.includes('วันที่') || columnNameLower.includes('date') || 
                columnNameLower.includes('วัน') || columnNameLower.includes('month') || 
                columnNameLower.includes('year')) {
                return 'date';
            }
            
            if (columnNameLower.includes('จำนวน') || columnNameLower.includes('quantity') ||
                columnNameLower.includes('ปริมาณ') || columnNameLower.includes('amount') ||
                columnNameLower.includes('น้ำหนัก') || columnNameLower.includes('weight') ||
                columnNameLower.includes('พื้นที่') || columnNameLower.includes('area') ||
                columnNameLower.includes('ราคา') || columnNameLower.includes('price') ||
                columnNameLower === 'lat' || columnNameLower === 'latitude' ||
                columnNameLower === 'long' || columnNameLower === 'longitude') {
                return 'number';
            }
            
            if (columnNameLower.includes('รหัส') || columnNameLower.includes('code') || 
                columnNameLower.includes('id') || columnNameLower.includes('หมายเลข') ||
                columnNameLower.includes('เลขที่') || columnNameLower.includes('no.')) {
                return 'identifier';
            }
            
            if (columnNameLower.includes('ประเภท') || columnNameLower.includes('type') ||
                columnNameLower.includes('สถานะ') || columnNameLower.includes('status') ||
                columnNameLower.includes('ใช่/ไม่') || columnNameLower.includes('yes/no') ||
                columnNameLower.includes('ระดับ') || columnNameLower.includes('level') ||
                columnNameLower.includes('การจัด') || columnNameLower.includes('category')) {
                return 'enum';
            }
            
            // ตรวจสอบจากค่าตัวอย่าง
            if (sampleValue === '' || sampleValue === null || sampleValue === undefined) {
                return 'text';
            }
            
            // ตรวจสอบตัวเลข
            const numValue = parseFloat(sampleValue);
            if (!isNaN(numValue) && sampleValue.trim() !== '' && 
                !isNaN(parseFloat(sampleValue)) && isFinite(sampleValue)) {
                return 'number';
            }
            
            // ตรวจสอบวันที่
            const datePatterns = [
                /^\d{4}-\d{1,2}-\d{1,2}$/,
                /^\d{4}\/\d{1,2}\/\d{1,2}$/,
                /^\d{1,2}\/\d{1,2}\/\d{4}$/,
                /^\d{1,2}-\d{1,2}-\d{4}$/
            ];
            
            if (datePatterns.some(pattern => pattern.test(sampleValue.trim()))) {
                return 'date';
            }
            
            // ตรวจสอบว่ามีค่าที่กำหนดหรือไม่
            const sampleLower = sampleValue.toLowerCase().trim();
            if (sampleLower === 'ใช่' || sampleLower === 'ไม่' || 
                sampleLower === 'yes' || sampleLower === 'no' ||
                sampleLower === 'true' || sampleLower === 'false') {
                return 'enum';
            }
            
            // ค่าเริ่มต้นเป็นข้อความ
            return 'text';
        }
        
        function validateCellData(columnName, value, columnType, rowIndex, colIndex) {
            // ใช้ประเภทที่ผู้ใช้เลือกถ้ามี
            const effectiveType = userSelectedDataTypes[columnName] || columnType;
            
            const result = {
                status: 'valid',
                message: '',
                suggestions: [],
                dataType: effectiveType,
                edited: false
            };
            
            // ตรวจสอบค่าว่าง (ผ่านแล้วในขั้นต้น)
            if (value === '' || value === null || value === undefined) {
                return result;
            }
            
            // ✅ แก้ไข: คอลัมน์ "เลขแปลงintech" เป็นค่าเริ่มต้น ไม่ต้องตรวจสอบ
            if (columnName.toLowerCase().includes('แปลงintech')) {
                return result;
            }
            
            // ✅ แก้ไข: การตรวจสอบและแนะนำสำหรับคอลัมน์ "ชื่อประเภทอ้อย"
            if (columnName.toLowerCase() === 'ชื่อประเภทอ้อย') {
                // ค่าที่แนะนำสำหรับคอลัมน์ "ชื่อประเภทอ้อย"
                const validTypes = [
                    "ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ตอ1", "ตอ2", "ตอ3", 
                    "ต้นฝนขยาย", "ต้นฝนรื้อตอ", "พื้นที่เสียหาย", ">ตอ3"
                ];
                
                if (!validTypes.includes(value.trim())) {
                    result.status = 'error';
                    result.message = `ต้องเป็นหนึ่งใน: ${validTypes.join(', ')}`;
                    result.suggestions = validTypes;
                }
                return result;
            }
            
            // ✅ แก้ไข: การตรวจสอบและแนะนำสำหรับคอลัมน์ "ประเภทอ้อย"
            if (columnName.toLowerCase() === 'ประเภทอ้อย') {
                // ค่าที่แนะนำสำหรับคอลัมน์ "ประเภทอ้อย"
                const validNumbers = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];
                
                // ตรวจสอบว่าเป็นตัวเลขหรือไม่
                const numValue = parseFloat(value);
                if (isNaN(numValue)) {
                    result.status = 'error';
                    result.message = 'ต้องเป็นตัวเลข';
                    result.suggestions = validNumbers;
                } 
                // ตรวจสอบว่าตรงกับตัวเลขที่กำหนดหรือไม่
                else if (!validNumbers.includes(value.trim())) {
                    result.status = 'error';
                    result.message = `ต้องเป็นหนึ่งใน: ${validNumbers.join(', ')}`;
                    result.suggestions = validNumbers;
                }
                return result;
            }
            
            // ตรวจสอบตามประเภทข้อมูล
            switch(effectiveType) {
                case 'number':
                    if (isNaN(value) || value.trim() === '') {
                        result.status = 'error';
                        result.message = 'ต้องเป็นตัวเลข';
                        
                        if (columnName.toLowerCase() === 'lat') {
                            result.suggestions = ['13.7563', '14.0790', '15.8700', '16.4393'];
                        } else if (columnName.toLowerCase() === 'long') {
                            result.suggestions = ['100.5018', '101.0037', '102.4956', '103.8499'];
                        } else if (columnName.includes('พื้นที่')) {
                            result.suggestions = ['10.0', '15.5', '20.0', '25.5'];
                        } else if (columnName.includes('อายุ')) {
                            result.suggestions = ['120', '150', '180', '210'];
                        } else if (columnName.includes('โควต้า')) {
                            result.suggestions = ['100', '150', '200', '250'];
                        } else {
                            result.suggestions = ['0', '10', '50', '100'];
                        }
                    } else {
                        const numValue = parseFloat(value);
                        
                        // ตรวจสอบพิกัด latitude (lat)
                        if (columnName.toLowerCase() === 'lat') {
                            if (numValue < -90 || numValue > 90) {
                                result.status = 'error';
                                result.message = 'latitude ต้องอยู่ระหว่าง -90 ถึง 90';
                                result.suggestions = ['13.7563', '14.0790', '15.8700', '16.4393'];
                            } else if (Math.abs(numValue) < 1 || Math.abs(numValue) > 99) {
                                result.status = 'warning';
                                result.message = 'latitude มักเป็นเลขหลักสิบ (13-17 สำหรับประเทศไทย)';
                                result.suggestions = ['13.7563', '14.0790', '15.8700', '16.4393'];
                            }
                        }
                        
                        // ตรวจสอบพิกัด longitude (long)
                        if (columnName.toLowerCase() === 'long') {
                            if (numValue < -180 || numValue > 180) {
                                result.status = 'error';
                                result.message = 'longitude ต้องอยู่ระหว่าง -180 ถึง 180';
                                result.suggestions = ['100.5018', '101.0037', '102.4956', '103.8499'];
                            } else if (Math.abs(numValue) < 90 || Math.abs(numValue) > 110) {
                                result.status = 'warning';
                                result.message = 'longitude มักเป็นเลขหลักร้อย (100-104 สำหรับประเทศไทย)';
                                result.suggestions = ['100.5018', '101.0037', '102.4956', '103.8499'];
                            }
                        }
                        
                        // ตรวจสอบค่าติดลบสำหรับบางคอลัมน์
                        if ((columnName.includes('พื้นที่') || columnName.includes('อายุ') || 
                             columnName.includes('จำนวน') || columnName.includes('โควต้า')) && numValue < 0) {
                            result.status = 'error';
                            result.message = 'ค่าต้องมากกว่าหรือเท่ากับ 0';
                            result.suggestions = ['0', '1', '10'];
                        }
                    }
                    break;
                    
                case 'date':
                    // ตรวจสอบรูปแบบวันที่ (รองรับ YYYY/MM/DD และ YYYY/M/D)
                    const datePatterns = [
                        /^\d{4}-\d{1,2}-\d{1,2}$/,          // YYYY-MM-DD
                        /^\d{4}\/\d{1,2}\/\d{1,2}$/,       // YYYY/MM/DD หรือ YYYY/M/D
                        /^\d{1,2}\/\d{1,2}\/\d{4}$/,       // DD/MM/YYYY หรือ D/M/YYYY
                        /^\d{1,2}-\d{1,2}-\d{4}$/          // DD-MM-YYYY หรือ D-M-YYYY
                    ];
                    
                    const isValidDate = datePatterns.some(pattern => pattern.test(value.trim()));
                    if (!isValidDate) {
                        result.status = 'error';
                        result.message = 'รูปแบบวันที่ไม่ถูกต้อง (รองรับ: YYYY/MM/DD, YYYY/M/D, DD/MM/YYYY)';
                        result.suggestions = ['2023/01/01', '2023/6/15', '2023/12/31'];
                    }
                    break;
                    
                case 'enum':
                    if (columnName.toLowerCase().includes('ใช่/ไม่') || columnName.toLowerCase().includes('yes/no')) {
                        const validValues = ['ใช่', 'ไม่', 'yes', 'no', 'true', 'false'];
                        if (!validValues.includes(value.toLowerCase())) {
                            result.status = 'error';
                            result.message = 'ต้องเป็น "ใช่" หรือ "ไม่"';
                            result.suggestions = ['ใช่', 'ไม่'];
                        }
                    }
                    break;
                    
                case 'identifier':
                    if (value.length > 50) {
                        result.status = 'warning';
                        result.message = 'รหัสยาวเกินไป';
                    }
                    break;
                    
                case 'text':
                    // ✅ แก้ไข: คอลัมน์ "ความเสี่ยงพื้นที่" และ "ความลาดเอียงของพื้นที่" เป็นข้อความ ไม่ต้องตรวจสอบเพิ่มเติม
                    if (columnName.toLowerCase().includes('ความเสี่ยงพื้นที่') || 
                        columnName.toLowerCase().includes('ความลาดเอียง')) {
                        // ไม่ต้องตรวจสอบเพิ่มเติม
                    } else if (columnName.toLowerCase().includes('แปลงintech')) {
                        // ตรวจสอบรูปแบบเลขแปลงintech
                        if (!/^\d+$/.test(value) && value.trim() !== '') {
                            result.status = 'warning';
                            result.message = 'เลขแปลงintech ควรเป็นตัวเลข';
                        }
                    } else if (value.length < 1 && value.trim() !== '') {
                        result.status = 'warning';
                        result.message = 'ข้อความสั้นเกินไป';
                    }
                    break;
            }
            
            return result;
        }
        
        function renderDataTableFromUploadedData() {
            // ล้างตารางเดิม
            dataTableHeader.innerHTML = '';
            dataTableBody.innerHTML = '';
            
            if (!uploadedData || selectedColumns.length === 0) return;
            
            // สร้างหัวตาราง
            const headerRow = document.createElement('tr');
            
            // เพิ่มคอลัมน์หมายเลขแถว
            const rowNumHeader = document.createElement('th');
            rowNumHeader.textContent = '#';
            rowNumHeader.style.width = '50px';
            headerRow.appendChild(rowNumHeader);
            
            // เพิ่มหัวคอลัมน์ข้อมูลที่เลือก
            selectedColumns.forEach(columnName => {
                const th = document.createElement('th');
                
                // ตรวจสอบประเภทคอลัมน์ (ใช้ประเภทที่ผู้ใช้เลือก)
                const effectiveType = userSelectedDataTypes[columnName] || 
                                     detectColumnType(columnName, uploadedData.data[0] ? uploadedData.data[0][columnName] || '' : '');
                
                // เพิ่ม badge ประเภทข้อมูล
                const typeBadge = document.createElement('span');
                typeBadge.className = 'column-type-badge';
                typeBadge.textContent = getTypeDisplayName(effectiveType);
                typeBadge.style.marginLeft = '5px';
                typeBadge.style.padding = '2px 6px';
                typeBadge.style.borderRadius = '10px';
                typeBadge.style.backgroundColor = getTypeColor(effectiveType);
                typeBadge.style.color = 'white';
                
                th.innerHTML = `${columnName} `;
                th.appendChild(typeBadge);
                headerRow.appendChild(th);
            });
            
            dataTableHeader.appendChild(headerRow);
            
            // ✅ แก้ไข: เพิ่มฟิลเตอร์ในหัวตารางเป็น Dropdown
            setTimeout(() => {
                addColumnFilterDropdowns();
            }, 100);
            
            // สร้างแถวข้อมูล (แสดงตามจำนวนที่กำหนด)
            const displayRows = uploadedData.data.slice(0, currentRowLimit);
            
            // อัพเดตจำนวนแถวที่แสดง
            totalRows.textContent = uploadedData.data.length;
            currentRows.textContent = Math.min(currentRowLimit, uploadedData.data.length);
            totalRowCount.textContent = uploadedData.data.length;
            
            displayRows.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                
                // เพิ่มหมายเลขแถว
                const rowNumCell = document.createElement('td');
                rowNumCell.textContent = rowIndex + 1;
                rowNumCell.style.fontWeight = 'bold';
                tr.appendChild(rowNumCell);
                
                // เพิ่มข้อมูลแต่ละเซลล์
                selectedColumns.forEach((columnName, colIndex) => {
                    const td = document.createElement('td');
                    const cellValue = row[columnName] || '';
                    td.textContent = cellValue;
                    
                    // ตรวจสอบประเภทที่ควรใช้
                    const effectiveType = userSelectedDataTypes[columnName] || 
                                         detectColumnType(columnName, cellValue);
                    
                    // ตรวจสอบข้อมูล
                    const validation = validateCellData(columnName, cellValue, effectiveType, rowIndex, colIndex);
                    
                    // เพิ่มคลาสตามสถานะการตรวจสอบ
                    if (validation.status === 'error') {
                        td.className = 'cell-error cell-highlight';
                        td.title = validation.message;
                    } else if (validation.status === 'warning') {
                        td.className = 'cell-warning cell-highlight';
                        td.title = validation.message;
                    } else {
                        td.className = 'cell-valid';
                    }
                    
                    // เพิ่มข้อมูลสำหรับการแก้ไข
                    td.dataset.row = rowIndex;
                    td.dataset.col = colIndex;
                    td.dataset.column = columnName;
                    td.dataset.value = cellValue;
                    td.dataset.type = effectiveType;
                    
                    // Event listener สำหรับการแก้ไข
                    if (validation.status === 'error' || validation.status === 'warning') {
                        td.style.cursor = 'pointer';
                        td.addEventListener('click', () => openCellEditorForUploadedData(rowIndex, colIndex));
                    }
                    
                    tr.appendChild(td);
                });
                
                dataTableBody.appendChild(tr);
            });
            
            // อัพเดตข้อมูลตาราง
            currentColumns.textContent = selectedColumns.length;
            updateDataStatus();
        }
        
        function getTypeDisplayName(type) {
            const names = {
                'text': 'ข้อความ',
                'number': 'ตัวเลข',
                'date': 'วันที่',
                'enum': 'ค่าที่กำหนด',
                'identifier': 'รหัส'
            };
            return names[type] || type;
        }
        
        function getTypeColor(type) {
            const colors = {
                'text': '#1565c0',
                'number': '#2e7d32',
                'date': '#ef6c00',
                'enum': '#7b1fa2',
                'identifier': '#00695c'
            };
            return colors[type] || '#6c757d';
        }
        
        function updateDashboard() {
            const total = currentValidationResults.totalCells;
            const valid = currentValidationResults.validCells;
            const warning = currentValidationResults.warningCells;
            const error = currentValidationResults.errorCells;
            
            // คำนวณเปอร์เซ็นต์
            const validPercent = total > 0 ? Math.round((valid / total) * 100) : 0;
            const warningPercent = total > 0 ? Math.round((warning / total) * 100) : 0;
            const errorPercent = total > 0 ? Math.round((error / total) * 100) : 0;
            
            // อัพเดต Dashboard
            correctDataPercent.textContent = `${validPercent}%`;
            needReviewCount.textContent = warning;
            errorDataCount.textContent = error;
            
            // ✅ แก้ไข: แสดงปุ่ม "ต้องตรวจสอบ" ถ้ามีข้อมูลที่ต้องตรวจสอบ
            if (warning > 0) {
                showReviewBtn.style.display = 'inline-block';
                showReviewBtn.addEventListener('click', showReviewRows);
            } else {
                showReviewBtn.style.display = 'none';
            }
            
            // อัพเดต Progress bars
            correctDataBar.style.width = `${validPercent}%`;
            needReviewBar.style.width = `${warningPercent}%`;
            errorDataBar.style.width = `${errorPercent}%`;
            
            // อัพเดตจำนวนเซลล์ที่แก้ไขแล้ว
            const editedCount = countEditedCells();
            editedCellsCount.textContent = editedCount;
            const editedPercent = total > 0 ? Math.round((editedCount / total) * 100) : 0;
            editedCellsBar.style.width = `${Math.min(editedPercent, 100)}%`;
            
            // ✅ แก้ไข: ต้องมีข้อมูลถูกต้อง 100% จึงจะไปขั้นตอนต่อไปได้
            nextToStep4.disabled = validPercent !== 100 || error > 0;
        }
        
        function countEditedCells() {
            let count = 0;
            for (let rowIndex in cellValidationStatus) {
                for (let colIndex in cellValidationStatus[rowIndex]) {
                    if (cellValidationStatus[rowIndex][colIndex].edited) {
                        count++;
                    }
                }
            }
            return count;
        }
        
        function updateDataStatus() {
            const errorCount = currentValidationResults.errorCells;
            const warningCount = currentValidationResults.warningCells;
            
            if (errorCount > 0) {
                dataStatus.innerHTML = `<span style="cursor: pointer; text-decoration: underline;" id="showErrorsBtn">⚠️ มี ${errorCount} ข้อผิดพลาดที่ต้องแก้ไข</span>`;
                dataStatus.style.color = 'var(--danger-color)';
                dataStatus.style.backgroundColor = 'rgba(247, 37, 133, 0.1)';
                
                setTimeout(() => {
                    const showErrorsBtn = document.getElementById('showErrorsBtn');
                    if (showErrorsBtn) {
                        showErrorsBtn.addEventListener('click', function() {
                            showErrorRowsOnly();
                        });
                    }
                }, 100);
            } else if (warningCount > 0) {
                dataStatus.textContent = `⚠️ มี ${warningCount} รายการที่ต้องตรวจสอบ`;
                dataStatus.style.color = 'var(--warning-color)';
                dataStatus.style.backgroundColor = 'rgba(255, 152, 0, 0.1)';
            } else {
                dataStatus.textContent = '✓ ข้อมูลถูกต้องทั้งหมด (100%)';
                dataStatus.style.color = 'var(--success-color)';
                dataStatus.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
            }
        }
        
        // ✅ ฟังก์ชันใหม่: เพิ่มฟิลเตอร์ Dropdown ในหัวตาราง
        function addColumnFilterDropdowns() {
            const headerRow = document.getElementById('dataTableHeader').querySelector('tr');
            if (!headerRow) return;
            
            // ตรวจสอบว่ามีฟิลเตอร์อยู่แล้วหรือไม่
            if (headerRow.querySelector('.filter-dropdown')) {
                return;
            }
            
            // สร้างแถวที่สองสำหรับฟิลเตอร์
            const filterRow = document.createElement('tr');
            
            // เซลล์หมายเลขแถว
            const rowNumFilterCell = document.createElement('td');
            rowNumFilterCell.style.padding = '5px';
            rowNumFilterCell.innerHTML = '<button class="btn btn-sm btn-outline" id="clearFilters" style="font-size: 0.7rem; padding: 3px 8px;">ล้าง</button>';
            filterRow.appendChild(rowNumFilterCell);
            
            // สร้างฟิลเตอร์สำหรับแต่ละคอลัมน์
            selectedColumns.forEach((columnName, index) => {
                const filterCell = document.createElement('td');
                filterCell.style.padding = '5px';
                
                // ดึงค่าที่ไม่ซ้ำกันสำหรับคอลัมน์นี้ (ตัวอย่าง 100 แถวแรก)
                const uniqueValues = [];
                const sampleRows = uploadedData.data.slice(0, Math.min(100, uploadedData.data.length));
                const valueSet = new Set();
                
                sampleRows.forEach(row => {
                    const value = row[columnName] || '';
                    if (value.trim() !== '' && !valueSet.has(value)) {
                        valueSet.add(value);
                        uniqueValues.push(value);
                    }
                });
                
                // สร้าง dropdown
                const filterSelect = document.createElement('select');
                filterSelect.className = 'filter-dropdown';
                filterSelect.dataset.columnIndex = index;
                filterSelect.dataset.columnName = columnName;
                
                // เพิ่มตัวเลือก
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'ทั้งหมด';
                filterSelect.appendChild(defaultOption);
                
                // เพิ่มตัวเลือกจากค่าที่ไม่ซ้ำกัน (จำกัดที่ 50 รายการ)
                uniqueValues.slice(0, 50).forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value.length > 30 ? value.substring(0, 27) + '...' : value;
                    filterSelect.appendChild(option);
                });
                
                filterSelect.addEventListener('change', function() {
                    filterTableRowsByDropdown();
                });
                
                filterCell.appendChild(filterSelect);
                filterRow.appendChild(filterCell);
            });
            
            headerRow.parentNode.insertBefore(filterRow, headerRow.nextSibling);
            
            // เพิ่ม event listener สำหรับปุ่มล้าง
            document.getElementById('clearFilters').addEventListener('click', function() {
                clearAllFilters();
            });
        }
        
        function filterTableRowsByDropdown() {
            const filterSelects = document.querySelectorAll('.filter-dropdown');
            const rows = document.querySelectorAll('#dataTableBody tr');
            
            rows.forEach(row => {
                let shouldShow = true;
                
                filterSelects.forEach((filterSelect, index) => {
                    const filterValue = filterSelect.value;
                    if (filterValue === '') return;
                    
                    // ดึงค่าจากเซลล์ (ข้ามเซลล์แรกที่เป็นหมายเลขแถว)
                    const cell = row.children[index + 1]; // +1 เพราะข้ามเซลล์หมายเลขแถว
                    if (cell) {
                        const cellValue = cell.textContent;
                        if (cellValue !== filterValue) {
                            shouldShow = false;
                        }
                    }
                });
                
                row.style.display = shouldShow ? '' : 'none';
            });
        }
        
        function clearAllFilters() {
            const filterSelects = document.querySelectorAll('.filter-dropdown');
            filterSelects.forEach(select => {
                select.value = '';
            });
            
            const rows = document.querySelectorAll('#dataTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // ✅ ฟังก์ชันใหม่: แสดงเฉพาะแถวที่มีข้อผิดพลาด
        function showErrorRowsOnly() {
            const rows = document.querySelectorAll('#dataTableBody tr');
            let errorRowCount = 0;
            
            rows.forEach(row => {
                let hasError = false;
                const cells = row.querySelectorAll('td');
                
                cells.forEach(cell => {
                    if (cell.classList.contains('cell-error')) {
                        hasError = true;
                    }
                });
                
                if (hasError) {
                    row.style.display = '';
                    errorRowCount++;
                    row.style.backgroundColor = 'rgba(255, 235, 238, 0.5)';
                } else {
                    row.style.display = 'none';
                }
            });
            
            if (errorRowCount > 0) {
                const tableControls = document.querySelector('.data-table-controls');
                if (!document.getElementById('showAllRowsBtn')) {
                    const showAllBtn = document.createElement('button');
                    showAllBtn.id = 'showAllRowsBtn';
                    showAllBtn.className = 'btn btn-outline btn-sm';
                    showAllBtn.innerHTML = '<i class="fas fa-list"></i> แสดงทั้งหมด';
                    showAllBtn.style.marginLeft = '10px';
                    showAllBtn.addEventListener('click', function() {
                        showAllRowsInTable();
                    });
                    
                    const tableActions = document.querySelector('.table-actions');
                    if (tableActions) {
                        tableActions.appendChild(showAllBtn);
                    }
                }
                
                alert(`แสดงเฉพาะแถวที่มีข้อผิดพลาด: ${errorRowCount} แถว`);
            }
        }
        
        // ✅ ฟังก์ชันใหม่: แสดงเฉพาะแถวที่ต้องตรวจสอบ (warning)
        function showReviewRows() {
            const rows = document.querySelectorAll('#dataTableBody tr');
            let reviewRowCount = 0;
            
            rows.forEach(row => {
                let hasWarning = false;
                const cells = row.querySelectorAll('td');
                
                cells.forEach(cell => {
                    if (cell.classList.contains('cell-warning')) {
                        hasWarning = true;
                    }
                });
                
                if (hasWarning) {
                    row.style.display = '';
                    reviewRowCount++;
                    row.style.backgroundColor = 'rgba(255, 248, 225, 0.5)';
                } else {
                    row.style.display = 'none';
                }
            });
            
            if (reviewRowCount > 0) {
                const tableControls = document.querySelector('.data-table-controls');
                if (!document.getElementById('showAllRowsBtn')) {
                    const showAllBtn = document.createElement('button');
                    showAllBtn.id = 'showAllRowsBtn';
                    showAllBtn.className = 'btn btn-outline btn-sm';
                    showAllBtn.innerHTML = '<i class="fas fa-list"></i> แสดงทั้งหมด';
                    showAllBtn.style.marginLeft = '10px';
                    showAllBtn.addEventListener('click', function() {
                        showAllRowsInTable();
                    });
                    
                    const tableActions = document.querySelector('.table-actions');
                    if (tableActions) {
                        tableActions.appendChild(showAllBtn);
                    }
                }
                
                alert(`แสดงเฉพาะแถวที่ต้องตรวจสอบ: ${reviewRowCount} แถว`);
            }
        }
        
        function showAllRowsInTable() {
            const rows = document.querySelectorAll('#dataTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
                row.style.backgroundColor = '';
            });
            
            const showAllBtn = document.getElementById('showAllRowsBtn');
            if (showAllBtn) {
                showAllBtn.remove();
            }
        }
        
        // ✅ ฟังก์ชันสำหรับตัดแถวที่ว่างเปล่าทั้งหมด
        function removeEmptyRows() {
            if (!uploadedData || selectedColumns.length === 0) return 0;
            
            const originalRowCount = uploadedData.data.length;
            const filteredData = [];
            
            uploadedData.data.forEach(row => {
                // ตรวจสอบว่ามีข้อมูลอย่างน้อย 1 คอลัมน์ที่ไม่ว่าง
                let hasData = false;
                
                selectedColumns.forEach(columnName => {
                    const value = row[columnName] || '';
                    if (value.toString().trim() !== '') {
                        hasData = true;
                    }
                });
                
                if (hasData) {
                    filteredData.push(row);
                }
            });
            
            uploadedData.data = filteredData;
            uploadedData.totalRows = filteredData.length;
            
            const removedCount = originalRowCount - filteredData.length;
            if (removedCount > 0) {
                console.log(`✅ ตัดแถวที่ว่างทั้งหมดออกแล้ว: ${removedCount} แถว`);
            }
            
            return removedCount;
        }
        
        // ============================================
        // ตั้งค่า Event Listeners สำหรับฟังก์ชันเพิ่มเติม (Step 3)
        // ============================================
        function setupEnhancedEventListeners() {
            // Dashboard buttons
            refreshDashboard.addEventListener('click', () => {
                if (uploadedData) {
                    runDataValidationFromUploadedData();
                    updateDashboard();
                    updateDataStatus();
                    alert('✅ อัพเดต Dashboard เรียบร้อยแล้ว');
                }
            });
            
            fixAllErrors.addEventListener('click', () => {
                if (uploadedData) {
                    if (confirm('AI จะพยายามแก้ไขข้อผิดพลาดทั้งหมดอัตโนมัติ\nยืนยันดำเนินการ?')) {
                        autoFixAllErrorsForUploadedData();
                    }
                }
            });
            
            // Cell editor modal
            saveEdit.addEventListener('click', () => {
                if (uploadedData && editingCell) {
                    saveCellEditForUploadedData();
                }
            });
            
            cancelEdit.addEventListener('click', closeCellEditor);
            closeModal.addEventListener('click', closeCellEditor);
            
            // ปิด modal เมื่อคลิกนอก
            cellEditorModal.addEventListener('click', (e) => {
                if (e.target === cellEditorModal) {
                    closeCellEditor();
                }
            });
            
            // Data Type Configuration
            showDataTypeConfig.addEventListener('click', showDataTypeConfiguration);
            
            autoDetectTypes.addEventListener('click', autoDetectDataTypes);
            
            applyDataTypes.addEventListener('click', function() {
                dataTypeConfigVisible = false;
                dataTypeConfig.style.display = 'none';
                
                // รันการตรวจสอบใหม่ด้วยประเภทข้อมูลที่ตั้งค่า
                if (uploadedData) {
                    runDataValidationFromUploadedData();
                    alert('✅ ใช้การตั้งค่าประเภทข้อมูลเรียบร้อย!');
                }
            });
            
            // Table actions
            showAllRows.addEventListener('click', toggleAllRows);
            
            exportTable.addEventListener('click', exportTableToCSV);
            
            // ปุ่มต่อไปใน Step 3
            nextToStep4.addEventListener('click', () => {
                if (currentValidationResults.errorCells > 0) {
                    alert('ยังมีข้อผิดพลาดที่ต้องแก้ไข กรุณาตรวจสอบเซลล์สีแดง');
                    return;
                }
                
                // ✅ แก้ไข: ตรวจสอบว่าข้อมูลถูกต้อง 100% หรือไม่
                const validPercent = parseInt(correctDataPercent.textContent);
                if (validPercent !== 100) {
                    alert(`ข้อมูลถูกต้อง ${validPercent}% ยังไม่ครบ 100% กรุณาตรวจสอบและแก้ไขข้อมูลให้ถูกต้องทั้งหมด`);
                    return;
                }
                
                const editedCount = countEditedCells();
                
                alert(`✅ ตรวจสอบข้อมูลเสร็จสมบูรณ์\n✅ แก้ไขข้อมูลแล้ว: ${editedCount} เซลล์\n✅ ข้อมูลถูกต้อง: 100%\n\nกำลังไปยังขั้นตอนต่อไป...`);
                
                // ไปยังขั้นตอนที่ 4
                goToStep(4);
            });
        }
        
        // ฟังก์ชันเพิ่มเติมสำหรับ Step 3
        function showDataTypeConfiguration() {
            dataTypeConfigVisible = true;
            dataTypeConfig.style.display = 'block';
            renderDataTypeConfigurationTable();
        }
        
        function renderDataTypeConfigurationTable() {
            if (!uploadedData || selectedColumns.length === 0) return;
            
            const tableBody = document.getElementById('dataTypeTableBody');
            tableBody.innerHTML = '';
            
            selectedColumns.forEach((columnName) => {
                const row = document.createElement('tr');
                
                // หาตัวอย่างข้อมูล
                const sampleValues = uploadedData.data.slice(0, 5).map(row => row[columnName] || '');
                const nonEmptySamples = sampleValues.filter(v => v.trim() !== '');
                const sampleText = nonEmptySamples.length > 0 ? nonEmptySamples[0] : '(ค่าว่าง)';
                
                // ตรวจจับประเภทอัตโนมัติ
                const columnNameLower = columnName.toLowerCase();
                let currentType;
                
                // ✅ แก้ไข: กำหนดประเภทเริ่มต้นสำหรับคอลัมน์พิเศษ
                if (columnNameLower === 'ชื่อประเภทอ้อย') {
                    currentType = 'text';
                } else if (columnNameLower === 'ประเภทอ้อย') {
                    currentType = 'number';
                } else {
                    const autoType = detectColumnType(columnName, sampleText);
                    currentType = userSelectedDataTypes[columnName] || autoType;
                }
                
                row.innerHTML = `
                    <td><strong>${columnName}</strong></td>
                    <td class="data-sample-cell" title="${sampleText}">${sampleText}</td>
                    <td>
                        <select class="type-select" data-column="${columnName}">
                            <option value="text" ${currentType === 'text' ? 'selected' : ''}>ข้อความ</option>
                            <option value="number" ${currentType === 'number' ? 'selected' : ''}>ตัวเลข</option>
                            <option value="date" ${currentType === 'date' ? 'selected' : ''}>วันที่</option>
                            <option value="enum" ${currentType === 'enum' ? 'selected' : ''}>ค่าที่กำหนด</option>
                            <option value="identifier" ${currentType === 'identifier' ? 'selected' : ''}>รหัส</option>
                        </select>
                    </td>
                    <td>
                        <select class="format-select" data-column="${columnName}">
                            <option value="default" selected>ค่าเริ่มต้น</option>
                            ${currentType === 'number' ? 
                                '<option value="decimal">ทศนิยม</option><option value="integer">จำนวนเต็ม</option>' : 
                                currentType === 'date' ?
                                '<option value="YYYY-MM-DD">YYYY-MM-DD</option><option value="DD/MM/YYYY">DD/MM/YYYY</option><option value="YYYY/MM/DD">YYYY/MM/DD</option>' :
                                currentType === 'text' && columnNameLower === 'ชื่อประเภทอ้อย' ?
                                sugarcaneTypes.map(type => `<option value="${type}">${type}</option>`).join('') :
                                ''}
                        </select>
                    </td>
                    <td>
                        <select class="unit-select" data-column="${columnName}">
                            <option value="none" selected>ไม่มีหน่วย</option>
                            ${columnName.toLowerCase().includes('พื้นที่') ? 
                                '<option value="ไร่">ไร่</option><option value="งาน">งาน</option><option value="ตารางเมตร">ตร.ม.</option>' :
                                columnName.toLowerCase().includes('อายุ') ?
                                '<option value="วัน">วัน</option><option value="เดือน">เดือน</option><option value="ปี">ปี</option>' :
                                columnName.toLowerCase().includes('ปริมาณ') ?
                                '<option value="กิโลกรัม">กก.</option><option value="ตัน">ตัน</option>' : ''}
                        </select>
                    </td>
                    <td><input type="text" class="form-control" placeholder="คำอธิบาย..." value="${getColumnDescription(columnName)}"></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // เพิ่ม event listeners สำหรับ dropdown
            document.querySelectorAll('.type-select').forEach(select => {
                select.addEventListener('change', function() {
                    const column = this.dataset.column;
                    userSelectedDataTypes[column] = this.value;
                    
                    // อัพเดต format select ตามประเภท
                    const row = this.closest('tr');
                    const formatSelect = row.querySelector('.format-select');
                    const unitSelect = row.querySelector('.unit-select');
                    
                    // รีเซ็ต format
                    formatSelect.innerHTML = '<option value="default" selected>ค่าเริ่มต้น</option>';
                    
                    if (this.value === 'number') {
                        formatSelect.innerHTML += '<option value="decimal">ทศนิยม</option><option value="integer">จำนวนเต็ม</option>';
                    } else if (this.value === 'date') {
                        formatSelect.innerHTML += '<option value="YYYY-MM-DD">YYYY-MM-DD</option><option value="DD/MM/YYYY">DD/MM/YYYY</option><option value="YYYY/MM/DD">YYYY/MM/DD</option>';
                    } else if (this.value === 'text' && column.toLowerCase() === 'ชื่อประเภทอ้อย') {
                        sugarcaneTypes.forEach(type => {
                            formatSelect.innerHTML += `<option value="${type}">${type}</option>`;
                        });
                    }
                    
                    // รีเซ็ต unit
                    unitSelect.innerHTML = '<option value="none" selected>ไม่มีหน่วย</option>';
                    const colName = column.toLowerCase();
                    
                    if (colName.includes('พื้นที่')) {
                        unitSelect.innerHTML += '<option value="ไร่">ไร่</option><option value="งาน">งาน</option><option value="ตารางเมตร">ตร.ม.</option>';
                    } else if (colName.includes('อายุ')) {
                        unitSelect.innerHTML += '<option value="วัน">วัน</option><option value="เดือน">เดือน</option><option value="ปี">ปี</option>';
                    } else if (colName.includes('ปริมาณ')) {
                        unitSelect.innerHTML += '<option value="กิโลกรัม">กก.</option><option value="ตัน">ตัน</option>';
                    }
                });
            });
        }
        
        function getColumnDescription(columnName) {
            const descriptions = {
                'โซน': 'เขตพื้นที่',
                'รหัสนักเกษตร': 'รหัสประจำตัวนักเกษตร',
                'ชื่อนักเกษตร': 'ชื่อ-นามสกุลนักเกษตร',
                'ชื่อประเภทอ้อย': 'ประเภทของอ้อย เช่น ปลายฝนขยาย, ต้นฝนรื้อตอ',
                'ประเภทอ้อย': 'รหัสประเภทอ้อย เช่น 101, 102, 103, 104, 105',
                'เลขโควต้า': 'หมายเลขโควต้าที่ได้รับจัดสรร',
                'ชื่อชาวไร่': 'ชื่อ-นามสกุลชาวไร่',
                'เลขแปลงintech': 'หมายเลขแปลงในระบบ Intech',
                'lat': 'ค่าพิกัดละติจูด',
                'long': 'ค่าพิกัดลองจิจูด',
                'พื้นที่': 'ขนาดพื้นที่ปลูกอ้อย',
                'อายุ': 'อายุอ้อย (วัน)',
                'จำนวน': 'ปริมาณหรือจำนวน',
                'ปริมาณปุ๋ย': 'ปริมาณปุ๋ยที่ใช้',
                'โครงการ': 'ชื่อโครงการที่เกี่ยวข้อง',
                'วันที่ปลูก': 'วันที่ปลูกอ้อย',
                'ความเสี่ยงพื้นที่': 'ระดับความเสี่ยงของพื้นที่ปลูก',
                'ความลาดเอียงของพื้นที่': 'ความลาดเอียงของพื้นที่ปลูก'
            };
            
            // ค้นหาคำอธิบายจากชื่อคอลัมน์
            for (const key in descriptions) {
                if (columnName.toLowerCase().includes(key.toLowerCase())) {
                    return descriptions[key];
                }
            }
            
            return '';
        }
        
        function autoDetectDataTypes() {
            if (!uploadedData || selectedColumns.length === 0) return;
            
            selectedColumns.forEach(columnName => {
                const columnNameLower = columnName.toLowerCase();
                
                // ✅ แก้ไข: ตรวจจับคอลัมน์ "ชื่อประเภทอ้อย" เป็น text
                if (columnNameLower === 'ชื่อประเภทอ้อย') {
                    userSelectedDataTypes[columnName] = 'text';
                }
                // ✅ แก้ไข: ตรวจจับคอลัมน์ "ประเภทอ้อย" เป็น number
                else if (columnNameLower === 'ประเภทอ้อย') {
                    userSelectedDataTypes[columnName] = 'number';
                }
                // ตรวจจับประเภทอื่นๆ ตามตรรกะเดิม
                else {
                    const sampleValues = uploadedData.data.slice(0, 10).map(row => row[columnName] || '');
                    const nonEmptySamples = sampleValues.filter(v => v.trim() !== '');
                    
                    if (nonEmptySamples.length > 0) {
                        const detectedType = detectColumnType(columnName, nonEmptySamples[0]);
                        userSelectedDataTypes[columnName] = detectedType;
                    }
                }
            });
            
            renderDataTypeConfigurationTable();
            alert('✅ ตรวจจับประเภทข้อมูลอัตโนมัติเรียบร้อยแล้ว!');
        }
        
        function toggleAllRows() {
            isShowingAllRows = !isShowingAllRows;
            
            if (isShowingAllRows) {
                currentRowLimit = uploadedData.data.length;
                document.getElementById('toggleAllRows').innerHTML = 
                    `<i class="fas fa-compress"></i> ซ่อนบางส่วน (${currentRowLimit})`;
            } else {
                currentRowLimit = 50;
                document.getElementById('toggleAllRows').innerHTML = 
                    `<i class="fas fa-expand"></i> แสดงทั้งหมด (${uploadedData.data.length})`;
            }
            
            renderDataTableFromUploadedData();
        }
        
        function exportTableToCSV() {
            if (!uploadedData || selectedColumns.length === 0) return;
            
            // ✅ แก้ไข: ใช้คอลัมน์ตามลำดับเดิมในไฟล์ต้นฉบับ
            const exportColumns = [...uploadedData.headers].filter(col => 
                selectedColumns.includes(col)
            );
            
            // สร้าง CSV จากคอลัมน์ที่เลือก
            let csvContent = '';
            
            // เพิ่ม BOM สำหรับ UTF-8 เพื่อให้ Excel อ่านภาษาไทยได้ถูกต้อง
            csvContent += '\ufeff';
            
            // ✅ แก้ไข: ใช้คอลัมน์ตามลำดับเดิม
            csvContent += exportColumns.join(',') + '\n';
            
            // เพิ่มข้อมูลทั้งหมด
            uploadedData.data.forEach(row => {
                const rowValues = exportColumns.map(col => {
                    let value = row[col] || '';
                    
                    // แปลงอักขระพิเศษ
                    value = value.toString().replace(/"/g, '""'); // Escape quotes
                    
                    // ใส่ quotes ถ้ามี comma, newline หรือ quotes
                    if (value.includes(',') || value.includes('\n') || value.includes('\r') || value.includes('"')) {
                        value = `"${value}"`;
                    }
                    
                    return value;
                });
                csvContent += rowValues.join(',') + '\n';
            });
            
            // สร้าง blob และดาวน์โหลด
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `cleaned_${uploadedData.fileName.replace('.csv', '')}_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ ดาวน์โหลดไฟล์ CSV เรียบร้อย!\nจำนวนแถว: ${uploadedData.data.length}\nจำนวนคอลัมน์: ${exportColumns.length}\n✅ คอลัมน์เรียงตามลำดับเดิม`);
        }
        
        function openCellEditorForUploadedData(rowIndex, colIndex) {
            if (!uploadedData || !cellValidationStatus[rowIndex]) return;
            
            const columnName = selectedColumns[colIndex];
            const cell = document.querySelector(`td[data-row="${rowIndex}"][data-col="${colIndex}"]`);
            const currentValue = uploadedData.data[rowIndex][columnName] || '';
            const validation = cellValidationStatus[rowIndex][colIndex];
            const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, currentValue);
            
            // บันทึกข้อมูลเซลล์ที่กำลังแก้ไข
            editingCell = { rowIndex, colIndex, cell, columnName, currentValue, validation, columnType };
            
            // อัพเดตข้อมูลใน modal
            editColumnName.textContent = columnName;
            editRowNumber.textContent = rowIndex + 1;
            
            // ตั้งค่าประเภทข้อมูลใน dropdown
            editDataTypeSelect.value = columnType;
            
            editIssue.textContent = validation.message;
            editIssue.className = validation.status === 'error' ? 'error-text' : 'warning-text';
            
            // ตั้งค่าค่าใน input
            cellValueInput.value = currentValue;
            
            // ✅ แก้ไข: เพิ่มคำแนะนำเฉพาะสำหรับคอลัมน์พิเศษ
            valueSuggestions.innerHTML = '';
            
            if (columnName.toLowerCase() === 'ชื่อประเภทอ้อย') {
                valueSuggestions.innerHTML = `
                    <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 5px;">
                        <strong>คำแนะนำ:</strong> ปลายฝนขยาย, ปลายฝนรื้อตอ, ตอ1, ตอ2, ตอ3, ต้นฝนขยาย, ต้นฝนรื้อตอ, พื้นที่เสียหาย, >ตอ3
                    </div>
                `;
                
                // เพิ่มคำแนะนำเป็นปุ่มคลิกได้
                const suggestions = [
                    "ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ตอ1", "ตอ2", "ตอ3", 
                    "ต้นฝนขยาย", "ต้นฝนรื้อตอ", "พื้นที่เสียหาย", ">ตอ3"
                ];
                suggestions.forEach(suggestion => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'suggestion-item';
                    btn.textContent = suggestion;
                    btn.addEventListener('click', () => {
                        cellValueInput.value = suggestion;
                    });
                    valueSuggestions.appendChild(btn);
                });
            }
            else if (columnName.toLowerCase() === 'ประเภทอ้อย') {
                valueSuggestions.innerHTML = `
                    <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 5px;">
                        <strong>คำแนะนำ:</strong> 101, 102, 103, 104, 105, 106, 107, 108, 1050
                    </div>
                `;
                
                const suggestions = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];
                suggestions.forEach(suggestion => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'suggestion-item';
                    btn.textContent = suggestion;
                    btn.addEventListener('click', () => {
                        cellValueInput.value = suggestion;
                    });
                    valueSuggestions.appendChild(btn);
                });
            }
            else if (validation.suggestions && validation.suggestions.length > 0) {
                const suggestionTitle = document.createElement('div');
                suggestionTitle.textContent = 'คำแนะนำ:';
                suggestionTitle.style.fontSize = '0.8rem';
                suggestionTitle.style.color = '#6c757d';
                suggestionTitle.style.marginBottom = '5px';
                valueSuggestions.appendChild(suggestionTitle);
                
                validation.suggestions.forEach(suggestion => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'suggestion-item';
                    suggestionItem.textContent = suggestion;
                    suggestionItem.addEventListener('click', () => {
                        cellValueInput.value = suggestion;
                    });
                    valueSuggestions.appendChild(suggestionItem);
                });
            }
            
            // แสดง modal
            cellEditorModal.classList.add('show');
            cellValueInput.focus();
        }
        
        function saveCellEditForUploadedData() {
            if (!editingCell || !uploadedData) return;
            
            const newValue = cellValueInput.value.trim();
            const newDataType = editDataTypeSelect.value;
            const { rowIndex, colIndex, cell, columnName, currentValue, columnType } = editingCell;
            
            // อัพเดตประเภทข้อมูลถ้าผู้ใช้เปลี่ยน
            if (newDataType !== columnType) {
                userSelectedDataTypes[columnName] = newDataType;
            }
            
            // อัพเดตข้อมูล
            uploadedData.data[rowIndex][columnName] = newValue;
            
            // ตรวจสอบข้อมูลใหม่
            const newValidation = validateCellData(columnName, newValue, newDataType, rowIndex, colIndex);
            newValidation.edited = true;
            cellValidationStatus[rowIndex][colIndex] = newValidation;
            
            // อัพเดตเซลล์ในตาราง
            cell.textContent = newValue;
            cell.dataset.value = newValue;
            
            // อัพเดตคลาสตามสถานะใหม่
            cell.className = '';
            if (newValidation.status === 'error') {
                cell.className = 'cell-error cell-highlight';
                cell.title = newValidation.message;
            } else if (newValidation.status === 'warning') {
                cell.className = 'cell-warning cell-highlight';
                cell.title = newValidation.message;
            } else {
                cell.className = 'cell-valid';
            }
            
            // เปิดให้แก้ไขได้ถ้ายังมีปัญหา
            if (newValidation.status === 'error' || newValidation.status === 'warning') {
                cell.style.cursor = 'pointer';
                cell.addEventListener('click', () => openCellEditorForUploadedData(rowIndex, colIndex));
            }
            
            // รันการตรวจสอบใหม่
            runDataValidationFromUploadedData();
            
            // อัพเดต Dashboard และสถานะ
            updateDashboard();
            updateDataStatus();
            
            // ปิด modal
            closeCellEditor();
        }
        
        function closeCellEditor() {
            cellEditorModal.classList.remove('show');
            editingCell = null;
            cellValueInput.value = '';
            valueSuggestions.innerHTML = '';
        }
        
        function autoFixAllErrorsForUploadedData() {
            if (!uploadedData) return;
            
            let fixedCount = 0;
            const sampleRows = uploadedData.data.slice(0, currentRowLimit);
            
            sampleRows.forEach((row, rowIndex) => {
                selectedColumns.forEach((columnName, colIndex) => {
                    const validation = cellValidationStatus[rowIndex] ? cellValidationStatus[rowIndex][colIndex] : null;
                    
                    if (validation && validation.status === 'error') {
                        let cellValue = row[columnName] || '';
                        let fixedValue = cellValue;
                        const columnNameLower = columnName.toLowerCase();
                        const columnType = userSelectedDataTypes[columnName] || detectColumnType(columnName, cellValue);
                        
                        // ✅ แก้ไข: AI แก้ไขสำหรับคอลัมน์ "ชื่อประเภทอ้อย"
                        if (columnNameLower === 'ชื่อประเภทอ้อย') {
                            const validTypes = [
                                "ปลายฝนขยาย", "ปลายฝนรื้อตอ", "ตอ1", "ตอ2", "ตอ3", 
                                "ต้นฝนขยาย", "ต้นฝนรื้อตอ", "พื้นที่เสียหาย", ">ตอ3"
                            ];
                            
                            // พยายามหาค่าที่ใกล้เคียง
                            let bestMatch = null;
                            let bestScore = 0;
                            
                            validTypes.forEach(validType => {
                                // คำนวณความคล้ายคลึง
                                const similarity = calculateSimilarity(cellValue, validType);
                                if (similarity > bestScore && similarity > 0.3) {
                                    bestScore = similarity;
                                    bestMatch = validType;
                                }
                            });
                            
                            if (bestMatch) {
                                fixedValue = bestMatch;
                            } else {
                                // ถ้าไม่เจอค่าที่ใกล้เคียง ให้ใช้ค่าแรกในรายการ
                                fixedValue = validTypes[0];
                            }
                        }
                        // ✅ แก้ไข: AI แก้ไขสำหรับคอลัมน์ "ประเภทอ้อย"
                        else if (columnNameLower === 'ประเภทอ้อย') {
                            const validNumbers = ["101", "102", "103", "104", "105", "106", "107", "108", "1050"];
                            
                            // ลองแปลงเป็นตัวเลข
                            const numValue = parseFloat(cellValue);
                            if (isNaN(numValue)) {
                                // ถ้าไม่ใช่ตัวเลข ให้ใช้ค่าแรก
                                fixedValue = "101";
                            } else {
                                // หาค่าที่ใกล้เคียงที่สุด
                                let closest = validNumbers[0];
                                let minDiff = Math.abs(numValue - parseInt(closest));
                                
                                validNumbers.forEach(num => {
                                    const diff = Math.abs(numValue - parseInt(num));
                                    if (diff < minDiff) {
                                        minDiff = diff;
                                        closest = num;
                                    }
                                });
                                
                                fixedValue = closest;
                            }
                        }
                        else if (columnType === 'number' && isNaN(cellValue)) {
                            // ✅ แก้ไข: คอลัมน์ "ประเภทอ้อย" ใช้ค่า 101-105
                            if (columnName.toLowerCase().includes('ประเภทอ้อย')) {
                                fixedValue = '101'; // ค่าเริ่มต้นสำหรับประเภทอ้อย
                            } else if (columnName.toLowerCase() === 'lat') {
                                fixedValue = '13.7563'; // ค่า latitude ตัวอย่างสำหรับประเทศไทย
                            } else if (columnName.toLowerCase() === 'long') {
                                fixedValue = '100.5018'; // ค่า longitude ตัวอย่างสำหรับประเทศไทย
                            } else if (columnName.includes('พื้นที่')) {
                                fixedValue = '10.0';
                            } else if (columnName.includes('อายุ')) {
                                fixedValue = '120';
                            } else if (columnName.includes('โควต้า')) {
                                fixedValue = '100';
                            } else {
                                fixedValue = '0';
                            }
                        } else if (columnType === 'date' && !/^\d{4}-\d{1,2}-\d{1,2}$/.test(cellValue)) {
                            // พยายามแปลงรูปแบบวันที่
                            const dateMatch = cellValue.match(/(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})/);
                            if (dateMatch) {
                                const day = dateMatch[1].padStart(2, '0');
                                const month = dateMatch[2].padStart(2, '0');
                                const year = dateMatch[3];
                                fixedValue = `${year}/${month}/${day}`;
                            } else {
                                fixedValue = '2023/06/01';
                            }
                        }
                        
                        // บันทึกค่าที่แก้ไข
                        if (fixedValue !== cellValue) {
                            uploadedData.data[rowIndex][columnName] = fixedValue;
                            fixedCount++;
                            
                            // ทำเครื่องหมายว่าแก้ไขแล้ว
                            if (!cellValidationStatus[rowIndex]) {
                                cellValidationStatus[rowIndex] = {};
                            }
                            cellValidationStatus[rowIndex][colIndex].edited = true;
                        }
                    }
                });
            });
            
            // อัพเดตการตรวจสอบใหม่
            runDataValidationFromUploadedData();
            renderDataTableFromUploadedData();
            updateDashboard();
            updateDataStatus();
            
            alert(`AI ได้แก้ไขข้อผิดพลาด ${fixedCount} รายการ`);
        }
        
        // ฟังก์ชันช่วยคำนวณความคล้ายคลึง
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            return (longer.length - editDistance(longer, shorter)) / parseFloat(longer.length);
        }
        
        // ฟังก์ชันคำนวณระยะห่างระหว่างข้อความ
        function editDistance(s1, s2) {
            s1 = s1.toLowerCase();
            s2 = s2.toLowerCase();
            
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else {
                        if (j > 0) {
                            let newValue = costs[j - 1];
                            if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                                newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                            }
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }
        
        // ============================================
        // ระบบตรวจสอบเงื่อนไข (Step 4) - แก้ไขทั้งหมดตามข้อกำหนด
        // ============================================
        
        function initConditionChecking() {
            if (!uploadedData || !selectedColumns) {
                document.getElementById('checkingResults').innerHTML = `
                    <div class="result-summary">
                        <p><i class="fas fa-exclamation-triangle"></i> ยังไม่มีข้อมูล กรุณาไปที่ขั้นตอนที่ 1-3 ก่อน</p>
                    </div>
                `;
                return;
            }
            
            // ตั้งค่า event listeners
            setupConditionCheckingSystem();
            
            // เตรียมตารางสำหรับเงื่อนไขที่เลือก (แสดงทั้งหมด)
            prepareCheckingTable();
            
            // เพิ่มข้อมูลสำหรับเงื่อนไขปุ๋ย
            if (currentCondition === "fertilizer") {
                // เตรียมข้อมูลเบื้องต้นสำหรับการตรวจสอบปุ๋ย
                setTimeout(() => {
                    const resultsContainer = document.getElementById('checkingResults');
                    if (resultsContainer.querySelector('.result-summary')) {
                        const summary = resultsContainer.querySelector('.result-summary');
                        summary.innerHTML += `
                            <div style="margin-top: 15px; background: #fff3e0; padding: 10px; border-radius: 6px; border-left: 4px solid #ff9800;">
                                <p><strong><i class="fas fa-lightbulb"></i> คำแนะนำสำหรับการตรวจสอบปุ๋ย:</strong></p>
                                <ol style="font-size: 0.9em; margin-left: 20px;">
                                    <li>ระบบจะตรวจสอบความถูกต้องของสูตรปุ๋ย (รูปแบบ XX-XX-XX)</li>
                                    <li>ตรวจสอบประเภทการใส่ปุ๋ย (หว่าน, โรยข้างแถว, รองก้นหลุม, พ่นทางใบ)</li>
                                    <li>ตรวจสอบว่ามีการระบุทั้งประเภทและสูตรปุ๋ยคู่กันหรือไม่</li>
                                    <li>ตรวจสอบอายุอ้อย (ต้องเป็นตัวเลข ไม่ติดลบ)</li>
                                </ol>
                            </div>
                        `;
                    }
                }, 100);
            }
        }
        
        function setupConditionCheckingSystem() {
            // ปุ่มเลือกเงื่อนไข
            document.querySelectorAll('.condition-select-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // เอา active class ออกจากปุ่มทั้งหมด
                    document.querySelectorAll('.condition-select-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    // เพิ่ม active class ให้ปุ่มที่เลือก
                    this.classList.add('active');
                    
                    // ตั้งค่าเงื่อนไขปัจจุบัน
                    currentCondition = this.dataset.condition;
                    
                    // อัพเดต UI
                    document.getElementById('selectedCondition').textContent = 
                        getConditionDisplayName(currentCondition);
                    
                    // เตรียมตารางตามเงื่อนไขที่เลือก
                    prepareCheckingTable();
                });
            });
            
            // ✅ แก้ไข: ปุ่มเริ่มตรวจสอบเงื่อนไขที่เลือก
            document.getElementById('runSelectedCheck').addEventListener('click', function() {
                if (!checkingTableData || checkingTableData.length === 0) {
                    alert('กรุณาเตรียมข้อมูลก่อนเริ่มตรวจสอบ');
                    return;
                }
                
                // เรียกใช้ฟังก์ชันตรวจสอบตามเงื่อนไขปัจจุบัน
                if (currentCondition === "sugarcane") {
                    const results = performSugarcaneConditionCheck();
                    updateCheckingTableWithResults(results, currentCondition);
                    updateCheckingStats(results);
                    displayCheckingResults(results, currentCondition);
                    
                    // แสดงผล
                    const message = `✅ ตรวจสอบเงื่อนไข "${getConditionDisplayName(currentCondition)}" เสร็จสิ้น\n\n` +
                                   `ตรวจทั้งหมด: ${results.totalRows} แถว\n` +
                                   `ผ่าน: ${results.passed} แถว\n` +
                                   `ไม่ผ่าน: ${results.failed} แถว\n` +
                                   (results.warnings > 0 ? `ต้องตรวจสอบ: ${results.warnings} แถว\n` : '');
                    alert(message);
                } else if (currentCondition === "fertilizer") {
                    const results = performFertilizerConditionCheck();
                    updateCheckingTableWithResults(results, currentCondition);
                    updateCheckingStats(results);
                    displayCheckingResults(results, currentCondition);
                    
                    // แสดงผล
                    const message = `✅ ตรวจสอบเงื่อนไข "${getConditionDisplayName(currentCondition)}" เสร็จสิ้น\n\n` +
                                   `ตรวจทั้งหมด: ${results.totalRows} แถว\n` +
                                   `ผ่าน: ${results.passed} แถว\n` +
                                   `ไม่ผ่าน: ${results.failed} แถว\n`;
                    alert(message);
                }
            });
            
            // ปุ่มตรวจสอบเงื่อนไขทั้งหมด
            document.getElementById('runAllChecks').addEventListener('click', function() {
                runAllConditionChecks();
            });
            
            // ปุ่มส่งออกผลตรวจสอบ
            document.getElementById('exportCheckResults').addEventListener('click', exportCheckingResultsWithColors);
            
            // ปุ่มแสดงเฉพาะที่ไม่ผ่าน
            document.getElementById('showOnlyFailed').addEventListener('click', function() {
                showOnlyFailed = true;
                this.classList.add('active');
                document.getElementById('showAllResults').classList.remove('active');
                renderCheckingTableFiltered();
            });
            
            // ปุ่มแสดงทั้งหมด
            document.getElementById('showAllResults').addEventListener('click', function() {
                showOnlyFailed = false;
                this.classList.add('active');
                document.getElementById('showOnlyFailed').classList.remove('active');
                renderCheckingTableFiltered();
            });
        }
        
        function getConditionDisplayName(condition) {
            const names = {
                "sugarcane": "ประเภทอ้อย",
                "fertilizer": "ปุ๋ย"
            };
            return names[condition] || condition;
        }
        
        // ฟังก์ชันช่วยหาคอลัมน์จากรายการชื่อ
        function findColumnByName(columns, possibleNames) {
            for (const column of columns) {
                const columnLower = column.toLowerCase().trim();
                for (const name of possibleNames) {
                    if (columnLower.includes(name.toLowerCase())) {
                        return column;
                    }
                }
            }
            return null;
        }
        
        function prepareCheckingTable() {
            const tableBody = document.getElementById('checkingTableBody');
            tableBody.innerHTML = '';
            
            if (!uploadedData || !selectedColumns || selectedColumns.length === 0) {
                console.error('No uploaded data or selected columns');
                return;
            }
            
            // เตรียมตารางตามเงื่อนไขที่เลือก
            if (currentCondition === "sugarcane") {
                prepareSugarcaneCheckingTable();
            } else if (currentCondition === "fertilizer") {
                prepareFertilizerCheckingTable();
            } else {
                prepareGeneralCheckingTable();
            }
        }
        
        function prepareGeneralCheckingTable() {
            // สำหรับเงื่อนไขอื่นๆ
            const tableBody = document.getElementById('checkingTableBody');
            tableBody.innerHTML = '';
            
            // หาคอลัมน์ที่เกี่ยวข้องกับเงื่อนไข
            const conditionColumns = {
                "fertilizer": ["ปุ๋ย", "fertilizer", "ยา", "chemical"]
            };
            
            const keywords = conditionColumns[currentCondition] || [];
            const foundColumns = [];
            
            keywords.forEach(keyword => {
                const foundColumn = findColumnByName(selectedColumns, [keyword]);
                if (foundColumn && !foundColumns.includes(foundColumn)) {
                    foundColumns.push(foundColumn);
                }
            });
            
            if (foundColumns.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; background: #ffebee;">
                            <div style="color: #d32f2f; font-size: 1.2rem; margin-bottom: 15px;">
                                <i class="fas fa-exclamation-triangle"></i> <strong>ไม่พบคอลัมน์ที่เกี่ยวข้อง</strong>
                            </div>
                            <p>ไม่พบคอลัมน์ที่เกี่ยวข้องกับเงื่อนไข "${getConditionDisplayName(currentCondition)}"</p>
                            <p>กรุณาเลือกคอลัมน์ที่เกี่ยวข้องในขั้นตอนที่ 2</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // กรองข้อมูล
            const intechColumn = findColumnByName(selectedColumns, ["แปลงintech", "แปลง intech"]);
            const filteredData = uploadedData.data.filter(row => {
                if (intechColumn) {
                    const intechValue = row[intechColumn] || '';
                    return intechValue.trim() !== '';
                }
                return true;
            });
            
            checkingTableData = [];
            
            filteredData.forEach((row, index) => {
                const rowData = {
                    id: index + 1,
                    intechPlot: intechColumn ? row[intechColumn] || '' : '',
                    condition: getConditionDisplayName(currentCondition),
                    status: "รอตรวจสอบ",
                    notes: "ยังไม่ได้ตรวจสอบ",
                    passed: false,
                    failedCells: {}
                };
                
                // เพิ่มข้อมูลสำหรับคอลัมน์ที่พบ
                foundColumns.forEach(col => {
                    rowData[col] = row[col] || '';
                });
                
                checkingTableData.push(rowData);
            });
            
            // สร้าง header ตาราง
            const tableHeader = document.getElementById('checkingTableHeader');
            tableHeader.innerHTML = '';
            
            const headerRow = document.createElement('tr');
            
            // คอลัมน์พื้นฐาน
            const baseHeaders = ["ลำดับ", "เลขแปลงintech"];
            
            baseHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            // คอลัมน์ข้อมูล
            foundColumns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });
            
            // คอลัมน์เพิ่มเติม
            const extraHeaders = ["เงื่อนไขที่ตรวจ", "สถานะ", "หมายเหตุ"];
            extraHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            tableHeader.appendChild(headerRow);
            
            // แสดงตาราง
            renderGeneralCheckingTable();
            
            // อัพเดตจำนวนแถว
            document.getElementById('checkingRowsCount').textContent = checkingTableData.length;
            
            // แสดงข้อความแจ้งเตือนสำเร็จ
            const resultsContainer = document.getElementById('checkingResults');
            resultsContainer.innerHTML = `
                <div class="result-summary" style="background: #e8f5e9; border-left-color: #4caf50;">
                    <p><i class="fas fa-check-circle"></i> <strong>เตรียมตารางตรวจสอบ "${getConditionDisplayName(currentCondition)}" เสร็จเรียบร้อย</strong></p>
                    <p>พบข้อมูลทั้งหมด: <strong>${filteredData.length} แถว</strong></p>
                    <p>พบคอลัมน์: ${foundColumns.join(', ')}</p>
                    <p style="margin-top: 15px;">
                        <button class="btn btn-primary" id="startGeneralCheckBtn">
                            <i class="fas fa-play"></i> เริ่มตรวจสอบ
                        </button>
                    </p>
                </div>
            `;
            
            // เพิ่ม event listener ให้ปุ่มเริ่มตรวจสอบ
            document.getElementById('startGeneralCheckBtn').addEventListener('click', function() {
                runConditionCheck(currentCondition);
            });
        }
        
        function renderGeneralCheckingTable() {
            const tableBody = document.getElementById('checkingTableBody');
            tableBody.innerHTML = '';
            
            let displayedRows = 0;
            
            checkingTableData.forEach(rowData => {
                // กรองแสดงเฉพาะที่ไม่ผ่านถ้าเลือก
                if (showOnlyFailed && rowData.status === "ผ่าน") {
                    return;
                }
                
                displayedRows++;
                
                const tr = document.createElement('tr');
                
                // สร้างเซลล์ตามโครงสร้าง header
                const tableHeader = document.getElementById('checkingTableHeader');
                const headerRow = tableHeader.querySelector('tr');
                const cells = [];
                
                // คอลัมน์ลำดับ
                cells.push(rowData.id);
                
                // คอลัมน์เลขแปลงintech
                cells.push(rowData.intechPlot || '(ไม่พบข้อมูล)');
                
                // คอลัมน์ข้อมูล
                for (let i = 2; i < headerRow.cells.length - 3; i++) {
                    const headerCell = headerRow.cells[i];
                    const columnName = headerCell.textContent;
                    const cellValue = rowData[columnName] || '';
                    cells.push(cellValue);
                }
                
                // คอลัมน์เงื่อนไขที่ตรวจ
                cells.push(rowData.condition);
                
                // คอลัมน์สถานะ
                cells.push(createStatusBadge(rowData.status));
                
                // คอลัมน์หมายเหตุ
                cells.push(rowData.notes || '');
                
                // เพิ่มเซลล์ลงในแถว
                cells.forEach((cellContent, cellIndex) => {
                    const td = document.createElement('td');
                    
                    if (typeof cellContent === 'string' && cellContent.includes('status-badge')) {
                        td.innerHTML = cellContent;
                    } else {
                        td.textContent = cellContent;
                        
                        // ตรวจสอบค่าว่าง - แสดงเป็นสีเทา
                        if (cellContent === '') {
                            td.style.color = '#999';
                            td.style.fontStyle = 'italic';
                        }
                        
                        // ตรวจสอบข้อผิดพลาดในคอลัมน์
                        if (rowData.failedCells && rowData.failedCells[cellIndex]) {
                            td.style.color = 'var(--danger-color)';
                            td.style.fontWeight = 'bold';
                            td.style.backgroundColor = 'rgba(247, 37, 133, 0.1)';
                        }
                    }
                    
                    tr.appendChild(td);
                });
                
                tableBody.appendChild(tr);
            });
            
            // อัพเดตจำนวนแถวที่แสดง
            document.getElementById('checkingRowsCount').textContent = displayedRows;
        }
        
        function renderCheckingTableFiltered() {
            const tableBody = document.getElementById('checkingTableBody');
            tableBody.innerHTML = '';
            
            let displayedRows = 0;
            
            checkingTableData.forEach(rowData => {
                // กรองแสดงเฉพาะที่ไม่ผ่านถ้าเลือก
                if (showOnlyFailed && rowData.status === "ผ่าน") {
                    return;
                }
                
                displayedRows++;
                
                const tr = document.createElement('tr');
                
                // ✅ แก้ไข: เพิ่มเงื่อนไขสำหรับแสดงสีพื้นหลังแถบสีเหลืองสำหรับแถวที่ไม่มีข้อมูลวันที่ปลูก
                if (rowData.status === "ไม่มีข้อมูลวันที่ปลูก") {
                    tr.classList.add('warning-row');
                }
                
                // ฟังก์ชันช่วยจัดรูปแบบวันที่ปลูก
                const formatPlantingDate = (dateStr) => {
                    if (!dateStr || dateStr.trim() === '') return '';
                    
                    const dateStrTrimmed = dateStr.trim();
                    
                    // ลดความยาววันที่หากยาวเกิน
                    if (dateStrTrimmed.length > 15) {
                        // แปลงรูปแบบวันที่ให้สั้นลง
                        const dateMatch = dateStrTrimmed.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
                        if (dateMatch) {
                            const year = dateMatch[1];
                            const month = dateMatch[2];
                            const day = dateMatch[3];
                            
                            // ใช้รูปแบบ YYYY/MM/DD ที่สั้นกว่า
                            return `${year}/${month}/${day}`;
                        }
                        
                        // ถ้าแปลงไม่ได้ ให้ตัดข้อความ
                        return dateStrTrimmed.length > 20 ? 
                            dateStrTrimmed.substring(0, 17) + '...' : 
                            dateStrTrimmed;
                    }
                    
                    return dateStrTrimmed;
                };
                
                const formattedPlantingDate = formatPlantingDate(rowData.plantingDate);
                
                // สร้างเซลล์สำหรับแต่ละคอลัมน์
                const cells = [
                    rowData.id,
                    rowData.intechPlot || '(ไม่พบข้อมูล)',
                    rowData.sugarcaneType || '(ไม่พบข้อมูล)',
                    formattedPlantingDate || '(ไม่พบข้อมูล)',
                    rowData.age || '',
                    rowData.condition,
                    createStatusBadge(rowData.status),
                    rowData.notes
                ];
                
                cells.forEach((cellContent, cellIndex) => {
                    const td = document.createElement('td');
                    
                    if (typeof cellContent === 'string' && cellContent.includes('status-badge')) {
                        td.innerHTML = cellContent;
                    } else {
                        td.textContent = cellContent;
                        
                        // สำหรับคอลัมน์วันที่ปลูก (คอลัมน์ที่ 4)
                        if (cellIndex === 3 && rowData.plantingDate && rowData.plantingDate !== formattedPlantingDate) {
                            td.title = rowData.plantingDate; // แสดงวันที่เต็มเมื่อ hover
                            td.classList.add('date-cell-compact');
                        }
                        
                        // ถ้าเป็นเซลล์ที่ตรวจสอบไม่ผ่าน ให้เพิ่มสีแดง
                        if (rowData.failedCells && rowData.failedCells[cellIndex]) {
                            td.style.color = 'var(--danger-color)';
                            td.style.fontWeight = 'bold';
                            td.style.backgroundColor = 'rgba(247, 37, 133, 0.1)';
                        }
                        // ถ้าผ่าน ให้เพิ่มสีเขียว (เฉพาะคอลัมน์ประเภทอ้อยและวันที่ปลูก)
                        else if (rowData.passed && (cellIndex === 2 || cellIndex === 3)) {
                            td.style.color = 'var(--success-color)';
                            td.style.fontWeight = 'bold';
                            td.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
                        }
                    }
                    
                    tr.appendChild(td);
                });
                
                tableBody.appendChild(tr);
            });
            
            // อัพเดตจำนวนแถวที่แสดง
            document.getElementById('checkingRowsCount').textContent = displayedRows;
        }
        
        function createStatusBadge(status) {
            let badgeClass = "status-info";
            let badgeText = status;
            
            if (status === "ผ่าน") {
                badgeClass = "status-valid";
                badgeText = "ผ่าน";
            } else if (status === "ไม่ผ่าน") {
                badgeClass = "status-error";
                badgeText = "ไม่ผ่าน";
            } else if (status === "ต้องตรวจสอบ") {
                badgeClass = "status-warning";
                badgeText = "ต้องตรวจสอบ";
            } else if (status === "รอตรวจสอบ") {
                badgeClass = "status-warning";
                badgeText = "รอตรวจสอบ";
            } else if (status === "ไม่มีข้อมูลวันที่ปลูก") {
                badgeClass = "status-warning";
                badgeText = "ไม่มีข้อมูลวันที่ปลูก";
            }
            
            return `<span class="status-badge ${badgeClass}">${badgeText}</span>`;
        }
        
        // ✅ แก้ไขฟังก์ชัน parseDateString สำหรับปัญหา 2
        function parseDateString(dateStr) {
            if (!dateStr || dateStr.trim() === '') return null;
            
            try {
                const trimmedStr = dateStr.trim();
                let date;
                
                // ✅ แก้ไขเพิ่มเติม: รองรับรูปแบบ DD/MM/YYYY หรือ D/M/YYYY
                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(trimmedStr)) {
                    const parts = trimmedStr.split('/');
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // JavaScript months are 0-based
                    const year = parseInt(parts[2]);
                    
                    // ✅ ตรวจสอบว่าเป็นวันที่ถูกต้อง
                    date = new Date(year, month, day);
                    
                    // ตรวจสอบว่าวันที่ถูกต้อง (ป้องกัน 32/13/2025)
                    if (date.getDate() !== day || date.getMonth() !== month || date.getFullYear() !== year) {
                        return null;
                    }
                }
                // รูปแบบ: YYYY/MM/DD หรือ YYYY/M/D
                else if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(trimmedStr)) {
                    const parts = trimmedStr.split('/');
                    date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                }
                // รูปแบบ: YYYY-MM-DD
                else if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(trimmedStr)) {
                    const parts = trimmedStr.split('-');
                    date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                }
                // รูปแบบ: DD-MM-YYYY หรือ D-M-YYYY
                else if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(trimmedStr)) {
                    const parts = trimmedStr.split('-');
                    date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                }
                // รูปแบบอื่นๆ ลองใช้ Date.parse
                else {
                    date = new Date(trimmedStr);
                }
                
                // ตรวจสอบว่า date ถูกต้องหรือไม่
                if (isNaN(date.getTime())) {
                    return null;
                }
                
                return date;
            } catch (error) {
                console.error('Error parsing date:', dateStr, error);
                return null;
            }
        }
        
        // ✅ แก้ไขฟังก์ชัน prepareSugarcaneCheckingTable() สำหรับปัญหาการนับแถว
        function prepareSugarcaneCheckingTable() {
            const tableBody = document.getElementById('checkingTableBody');
            tableBody.innerHTML = '';
            
            // ✅ แก้ไข: ใช้คอลัมน์ตามที่กำหนดเท่านั้น และตรวจสอบทุกแถว
            const requiredColumns = [
                { name: "เลขแปลงintech", keywords: ["แปลงintech", "แปลง intech", "แปลง"] },
                { name: "ชื่อประเภทอ้อย", keywords: ["ชื่อประเภทอ้อย", "ประเภทอ้อย", "พันธุ์อ้อย"] },
                { name: "วันที่ปลูก", keywords: ["วันที่ปลูก", "วันปลูก", "planting date"] },
                { name: "อายุอ้อย", keywords: ["อายุอ้อย", "อายุ", "age", "วัน"] }
            ];
            
            // หาคอลัมน์ที่ตรงกับความต้องการ
            const foundColumns = {};
            
            requiredColumns.forEach(reqCol => {
                let foundColumn = null;
                
                // ค้นหาด้วยชื่อตรง
                for (const col of selectedColumns) {
                    const colLower = col.toLowerCase().trim();
                    const reqNameLower = reqCol.name.toLowerCase();
                    
                    if (colLower === reqNameLower) {
                        foundColumn = col;
                        break;
                    }
                }
                
                // ถ้าไม่เจอชื่อตรง ให้ค้นหาด้วยคำสำคัญ
                if (!foundColumn) {
                    for (const col of selectedColumns) {
                        const colLower = col.toLowerCase();
                        for (const keyword of reqCol.keywords) {
                            if (colLower.includes(keyword.toLowerCase())) {
                                foundColumn = col;
                                break;
                            }
                        }
                        if (foundColumn) break;
                    }
                }
                
                foundColumns[reqCol.name] = foundColumn;
            });
            
            // แสดงคอลัมน์ที่พบ
            console.log('Found columns for checking:', foundColumns);
            
            // ตรวจสอบว่ามีคอลัมน์ที่จำเป็นหรือไม่
            const missingColumns = [];
            Object.keys(foundColumns).forEach(key => {
                if (!foundColumns[key]) {
                    missingColumns.push(key);
                }
            });
            
            if (missingColumns.length > 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; background: #ffebee;">
                            <div style="color: #d32f2f; font-size: 1.2rem; margin-bottom: 15px;">
                                <i class="fas fa-exclamation-triangle"></i> <strong>ไม่พบคอลัมน์ที่จำเป็น</strong>
                            </div>
                            <p>กรุณาเลือกคอลัมน์เหล่านี้ในขั้นตอนที่ 2:</p>
                            <ul style="text-align: left; display: inline-block; margin-top: 10px;">
                                ${missingColumns.map(col => `<li>${col}</li>`).join('')}
                            </ul>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // ✅ แก้ไข: ใช้ข้อมูลทั้งหมด ไม่ต้องกรอง
            const totalRows = uploadedData.data.length;
            const hasHeaderRow = 1; // ถ้านับรวมหัวตาราง
            
            checkingTableData = [];
            
            // ✅ แก้ไข: ใช้ข้อมูลทั้งหมดจาก uploadedData
            uploadedData.data.forEach((row, rowIndex) => {
                // ตรวจสอบว่ามีเลขแปลงintech หรือไม่
                const intechValue = foundColumns["เลขแปลงintech"] ? row[foundColumns["เลขแปลงintech"]] || '' : '';
                const hasIntech = intechValue.trim() !== '';
                
                // สร้าง object สำหรับข้อมูลแถวนี้
                const rowData = {
                    id: rowIndex + 1, // หมายเลขแถว (เริ่มจาก 1)
                    originalRowIndex: rowIndex, // เก็บดัชนีแถวเดิม
                    hasIntech: hasIntech,
                    intechPlot: intechValue,
                    sugarcaneType: foundColumns["ชื่อประเภทอ้อย"] ? row[foundColumns["ชื่อประเภทอ้อย"]] || '' : '',
                    plantingDate: foundColumns["วันที่ปลูก"] ? row[foundColumns["วันที่ปลูก"]] || '' : '',
                    age: foundColumns["อายุอ้อย"] ? row[foundColumns["อายุอ้อย"]] || '' : '',
                    condition: getConditionDisplayName(currentCondition),
                    status: "รอตรวจสอบ",
                    notes: "ยังไม่ได้ตรวจสอบ",
                    passed: false,
                    failedCells: {}
                };
                
                checkingTableData.push(rowData);
            });
            
            // นับสถิติ
            const rowsWithIntech = checkingTableData.filter(row => row.hasIntech).length;
            const rowsWithoutIntech = checkingTableData.filter(row => !row.hasIntech).length;
            
            // สร้าง header ตาราง
            const tableHeader = document.getElementById('checkingTableHeader');
            tableHeader.innerHTML = '';
            
            const headerRow = document.createElement('tr');
            const headers = ["ลำดับ", "เลขแปลงintech", "ชื่อประเภทอ้อย", "วันที่ปลูก", "อายุอ้อย (วัน)", "เงื่อนไขที่ตรวจ", "สถานะ", "หมายเหตุ"];
            
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            tableHeader.appendChild(headerRow);
            
            // แสดงตาราง
            renderCheckingTableFiltered();
            
            // ✅ แก้ไข: อัพเดตจำนวนแถวที่แสดงอย่างถูกต้อง
            const checkingRowsCountElement = document.getElementById('checkingRowsCount');
            if (checkingRowsCountElement) {
                checkingRowsCountElement.textContent = totalRows;
            }
            
            // ✅ แก้ไข: แสดงข้อความที่ถูกต้อง
            const resultsContainer = document.getElementById('checkingResults');
            resultsContainer.innerHTML = `
                <div class="result-summary" style="background: #e8f5e9; border-left-color: #4caf50;">
                    <p><i class="fas fa-check-circle"></i> <strong>เตรียมตารางตรวจสอบประเภทอ้อยเสร็จเรียบร้อย</strong></p>
                    <p>ไฟล์ CSV ทั้งหมด: <strong>${totalRows + hasHeaderRow} แถว</strong> (รวมหัวตาราง)</p>
                    <p>ข้อมูลทั้งหมด (ไม่รวมหัวตาราง): <strong>${totalRows} แถว</strong></p>
                    <p>แถวที่มีเลขแปลงintech: <strong>${rowsWithIntech} แถว</strong></p>
                    <p>แถวที่ไม่มีเลขแปลงintech: <strong>${rowsWithoutIntech} แถว</strong></p>
                    <p>พบคอลัมน์ที่ใช้ตรวจสอบ:</p>
                    <ul>
                        <li><strong>เลขแปลงintech:</strong> "${foundColumns["เลขแปลงintech"]}"</li>
                        <li><strong>ชื่อประเภทอ้อย:</strong> "${foundColumns["ชื่อประเภทอ้อย"]}"</li>
                        <li><strong>วันที่ปลูก:</strong> "${foundColumns["วันที่ปลูก"]}"</li>
                        <li><strong>อายุอ้อย:</strong> "${foundColumns["อายุอ้อย"]}"</li>
                    </ul>
                    <p style="margin-top: 15px;">
                        <button class="btn btn-primary" id="startSugarcaneCheckBtn">
                            <i class="fas fa-play"></i> เริ่มตรวจสอบประเภทอ้อย
                        </button>
                    </p>
                </div>
            `;
            
            // เพิ่ม event listener ให้ปุ่มเริ่มตรวจสอบ
            document.getElementById('startSugarcaneCheckBtn').addEventListener('click', function() {
                // เรียกใช้ฟังก์ชันตรวจสอบตามเงื่อนไขปัจจุบัน
                if (currentCondition === "sugarcane") {
                    const results = performSugarcaneConditionCheck();
                    updateCheckingTableWithResults(results, currentCondition);
                    updateCheckingStats(results);
                    displayCheckingResults(results, currentCondition);
                    
                    // ✅ แก้ไข: แสดงผลสรุปที่ถูกต้อง
                    const message = `✅ ตรวจสอบเงื่อนไข "${getConditionDisplayName(currentCondition)}" เสร็จสิ้น\n\n` +
                                   `ไฟล์ทั้งหมด: ${totalRows + hasHeaderRow} แถว\n` +
                                   `ข้อมูลทั้งหมด: ${totalRows} แถว\n` +
                                   `ตรวจทั้งหมด: ${results.totalRows} แถว\n` +
                                   `ผ่าน: ${results.passed} แถว\n` +
                                   `ไม่ผ่าน: ${results.failed} แถว\n` +
                                   (results.warnings > 0 ? `ต้องตรวจสอบ: ${results.warnings} แถว\n` : '');
                    alert(message);
                }
            });
        }
        
        // ✅ แก้ไขฟังก์ชัน performSugarcaneConditionCheck() สำหรับปัญหา 2
        function performSugarcaneConditionCheck() {
            const results = {
                condition: "sugarcane",
                totalRows: checkingTableData.length,
                passed: 0,
                failed: 0,
                warnings: 0,
                pending: 0, // ✅ เพิ่ม: นับจำนวนที่รอตรวจสอบ
                issues: []
            };
            
            // ตรวจสอบแต่ละแถว
            checkingTableData.forEach((rowData, index) => {
                let passed = false;
                let pending = false; // ✅ เพิ่ม: สถานะรอตรวจสอบ
                let notes = "";
                let failedCells = {};
                
                // ตรวจสอบว่ามีข้อมูลประเภทอ้อยหรือไม่
                if (rowData.sugarcaneType && rowData.sugarcaneType.trim() !== '') {
                    const sugarcaneType = rowData.sugarcaneType.trim();
                    
                    // ตรวจสอบว่าประเภทอ้อยอยู่ในรายการที่กำหนดหรือไม่
                    if (sugarcaneTypes.includes(sugarcaneType)) {
                        // ตรวจสอบวันที่ปลูก
                        if (rowData.plantingDate && rowData.plantingDate.trim() !== '') {
                            try {
                                // แปลงวันที่ให้เป็นรูปแบบมาตรฐาน
                                const plantingDate = parseDateString(rowData.plantingDate.trim());
                                
                                if (plantingDate) {
                                    // ✅ แก้ไข: กำหนดช่วงวันที่สำหรับแต่ละประเภทอ้อย (เพิ่มช่วงปี 2567-2568)
                                    const sugarcaneDateRanges = {
                                        // ช่วงปี 2568-2569
                                        "ปลายฝนขยาย": [
                                            { start: "2025-10-01", end: "2026-02-28", description: "ตุลาคม 2568 - กุมภาพันธ์ 2569", year: "2568-2569" },
                                            { start: "2024-10-01", end: "2025-01-31", description: "ตุลาคม 2567 - มกราคม 2568", year: "2567-2568" }
                                        ],
                                        "ปลายฝนรื้อตอ": [
                                            { start: "2025-10-01", end: "2026-02-28", description: "ตุลาคม 2568 - กุมภาพันธ์ 2569", year: "2568-2569" },
                                            { start: "2024-10-01", end: "2025-01-31", description: "ตุลาคม 2567 - มกราคม 2568", year: "2567-2568" }
                                        ],
                                        "ปลายฝน": [
                                            { start: "2025-10-01", end: "2026-02-28", description: "ตุลาคม 2568 - กุมภาพันธ์ 2569", year: "2568-2569" },
                                            { start: "2024-10-01", end: "2025-01-31", description: "ตุลาคม 2567 - มกราคม 2568", year: "2567-2568" }
                                        ],
                                        "ต้นฝนขยาย": [
                                            { start: "2026-03-01", end: "2026-06-30", description: "มีนาคม 2569 - มิถุนายน 2569", year: "2569" },
                                            { start: "2024-02-01", end: "2025-05-31", description: "กุมภาพันธ์ 2567 - พฤษภาคม 2568", year: "2567-2568" }
                                        ],
                                        "ต้นฝนรื้อตอ": [
                                            { start: "2026-03-01", end: "2026-06-30", description: "มีนาคม 2569 - มิถุนายน 2569", year: "2569" },
                                            { start: "2024-02-01", end: "2025-05-31", description: "กุมภาพันธ์ 2567 - พฤษภาคม 2568", year: "2567-2568" }
                                        ],
                                        "ต้นฝน": [
                                            { start: "2026-03-01", end: "2026-06-30", description: "มีนาคม 2569 - มิถุนายน 2569", year: "2569" },
                                            { start: "2024-02-01", end: "2025-05-31", description: "กุมภาพันธ์ 2567 - พฤษภาคม 2568", year: "2567-2568" }
                                        ],
                                        "พันธุ์อ้อย": [
                                            { start: "2026-06-01", end: "2026-07-31", description: "มิถุนายน 2569 - กรกฎาคม 2569", year: "2569" },
                                            { start: "2024-06-01", end: "2024-06-30", description: "1 มิถุนายน 2567 - 30 มิถุนายน 2567", year: "2567" }
                                        ],
                                        "ตอ1": [
                                            { start: "2025-12-01", end: "2026-03-31", description: "ธันวาคม 2568 - มีนาคม 2569", year: "2568-2569" },
                                            { start: "2024-12-01", end: "2025-03-31", description: "ธันวาคม 2567 - มีนาคม 2568", year: "2567-2568" }
                                        ],
                                        "ตอ2": [
                                            { start: "2025-12-01", end: "2026-03-31", description: "ธันวาคม 2568 - มีนาคม 2569", year: "2568-2569" },
                                            { start: "2024-12-01", end: "2025-03-31", description: "ธันวาคม 2567 - มีนาคม 2568", year: "2567-2568" }
                                        ],
                                        "ตอ3": [
                                            { start: "2025-12-01", end: "2026-03-31", description: "ธันวาคม 2568 - มีนาคม 2569", year: "2568-2569" },
                                            { start: "2024-12-01", end: "2025-03-31", description: "ธันวาคม 2567 - มีนาคม 2568", year: "2567-2568" }
                                        ],
                                        ">ตอ3": [
                                            { start: "2025-12-01", end: "2026-03-31", description: "ธันวาคม 2568 - มีนาคม 2569", year: "2568-2569" },
                                            { start: "2024-12-01", end: "2025-03-31", description: "ธันวาคม 2567 - มีนาคม 2568", year: "2567-2568" }
                                        ]
                                    };
                                    
                                    // หาประเภทอ้อยที่ตรงกับ sugarcaneType หรือประเภทที่เกี่ยวข้อง
                                    let matchedType = null;
                                    let matchedRanges = null;
                                    
                                    // ✅ แก้ไข: ตรวจสอบหา ranges ที่ตรง (อาจมีหลายช่วง)
                                    for (const [typeKey, ranges] of Object.entries(sugarcaneDateRanges)) {
                                        // ตรวจสอบว่า sugarcaneType ตรงกับ typeKey หรือมีคำที่คล้ายกัน
                                        if (sugarcaneType.includes(typeKey) || typeKey.includes(sugarcaneType)) {
                                            matchedType = typeKey;
                                            matchedRanges = ranges;
                                            break;
                                        }
                                    }
                                    
                                    // ถ้าไม่เจอตรงๆ ให้ตรวจสอบประเภทหลัก
                                    if (!matchedRanges) {
                                        if (sugarcaneType.includes("ปลายฝน")) {
                                            matchedType = "ปลายฝน";
                                            matchedRanges = sugarcaneDateRanges["ปลายฝน"];
                                        } else if (sugarcaneType.includes("ต้นฝน")) {
                                            matchedType = "ต้นฝน";
                                            matchedRanges = sugarcaneDateRanges["ต้นฝน"];
                                        } else if (sugarcaneType.includes("พันธุ์")) {
                                            matchedType = "พันธุ์อ้อย";
                                            matchedRanges = sugarcaneDateRanges["พันธุ์อ้อย"];
                                        } else if (sugarcaneType.includes("ตอ") || sugarcaneType.includes(">ตอ3") || sugarcaneType.includes("บำรุง")) {
                                            matchedType = "ตอ1"; // ใช้ตอ1 เป็นตัวแทนสำหรับตอทั้งหมด
                                            matchedRanges = sugarcaneDateRanges["ตอ1"];
                                        }
                                    }
                                    
                                    if (matchedRanges && matchedRanges.length > 0) {
                                        // ✅ แก้ไข: ตรวจสอบกับทุกช่วงวันที่ที่กำหนด
                                        let isInAnyRange = false;
                                        let matchedRangeDescription = "";
                                        
                                        for (const range of matchedRanges) {
                                            const startDate = new Date(range.start);
                                            const endDate = new Date(range.end);
                                            
                                            // ตรวจสอบว่าวันที่ปลูกอยู่ในช่วงที่กำหนดหรือไม่
                                            if (plantingDate >= startDate && plantingDate <= endDate) {
                                                isInAnyRange = true;
                                                matchedRangeDescription = range.description;
                                                break;
                                            }
                                        }
                                        
                                        if (isInAnyRange) {
                                            // ✅ ถูกต้อง: วันที่ปลูกอยู่ในช่วงที่กำหนด
                                            const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", 
                                                                "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
                                            const plantingMonth = monthNames[plantingDate.getMonth()];
                                            const plantingYear = plantingDate.getFullYear() + 543;
                                            
                                            passed = true;
                                            notes = `✓ ถูกต้อง: ประเภทอ้อย "${sugarcaneType}" ปลูกเดือน ${plantingMonth} ${plantingYear} สอดคล้องกับช่วง ${matchedRangeDescription}`;
                                            rowData.passed = true;
                                        } else {
                                            // ✅ ไม่อยู่ในช่วงที่กำหนด: ให้สถานะ "รอตรวจสอบ"
                                            pending = true;
                                            
                                            const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", 
                                                                "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
                                            const plantingMonth = monthNames[plantingDate.getMonth()];
                                            const plantingYear = plantingDate.getFullYear() + 543;
                                            
                                            // แสดงช่วงวันที่ทั้งหมดที่รองรับ
                                            const allRangesDesc = matchedRanges.map(r => `${r.description} (ปี ${r.year})`).join(" หรือ ");
                                            
                                            notes = `⏳ รอตรวจสอบ: ปลูกเดือน ${plantingMonth} ${plantingYear} ไม่อยู่ในช่วงที่กำหนดสำหรับ "${sugarcaneType}" | ช่วงที่กำหนด: ${allRangesDesc} | หมายเหตุ: ไม่อยู่ในเงื่อนไข`;
                                            
                                            failedCells[2] = true; // คอลัมน์ชื่อประเภทอ้อย
                                            failedCells[3] = true; // คอลัมน์วันที่ปลูก
                                            rowData.passed = false;
                                            results.issues.push({
                                                row: rowData.originalRowIndex + 1,
                                                message: notes,
                                                type: sugarcaneType,
                                                plantingDate: rowData.plantingDate,
                                                actualMonth: plantingMonth,
                                                actualYear: plantingYear,
                                                expectedRanges: allRangesDesc,
                                                status: "รอตรวจสอบ"
                                            });
                                        }
                                    } else {
                                        // ไม่พบช่วงวันที่สำหรับประเภทนี้
                                        pending = true;
                                        notes = `⏳ รอตรวจสอบ: ประเภทอ้อย "${sugarcaneType}" ไม่มีช่วงวันที่กำหนดในระบบ | หมายเหตุ: ไม่อยู่ในเงื่อนไข`;
                                        failedCells[2] = true; // คอลัมน์ชื่อประเภทอ้อย
                                        rowData.passed = false;
                                        results.issues.push({
                                            row: rowData.originalRowIndex + 1,
                                            message: notes,
                                            type: sugarcaneType,
                                            status: "รอตรวจสอบ"
                                        });
                                    }
                                } else {
                                    // รูปแบบวันที่ไม่ถูกต้อง
                                    passed = false;
                                    notes = "✗ รูปแบบวันที่ไม่ถูกต้อง";
                                    failedCells[3] = true; // คอลัมน์วันที่ปลูก
                                    rowData.passed = false;
                                    results.issues.push({
                                        row: rowData.originalRowIndex + 1,
                                        message: notes,
                                        type: sugarcaneType,
                                        plantingDate: rowData.plantingDate
                                    });
                                }
                            } catch (error) {
                                passed = false;
                                notes = `✗ ข้อผิดพลาดในการตรวจสอบวันที่: ${error.message}`;
                                failedCells[3] = true; // คอลัมน์วันที่ปลูก
                                rowData.passed = false;
                                results.issues.push({
                                    row: rowData.originalRowIndex + 1,
                                    message: notes,
                                    type: sugarcaneType,
                                    plantingDate: rowData.plantingDate
                                });
                            }
                        } else {
                            // ✅ ไม่มีข้อมูลวันที่ปลูก
                            passed = false;
                            rowData.status = "ไม่มีข้อมูลวันที่ปลูก";
                            notes = "ยังไม่ได้ทำกิจกรรมงวด 1";
                            failedCells[3] = true; // คอลัมน์วันที่ปลูก
                            rowData.passed = false;
                            results.warnings++; // เพิ่มจำนวน warning
                            results.issues.push({
                                row: rowData.originalRowIndex + 1,
                                message: notes,
                                type: sugarcaneType,
                                status: "ไม่มีข้อมูลวันที่ปลูก"
                            });
                        }
                    } else {
                        // ประเภทอ้อยไม่ตรงกับค่ามาตรฐาน
                        passed = false;
                        notes = `✗ ประเภทอ้อย "${sugarcaneType}" ไม่ตรงกับค่ามาตรฐานที่กำหนด`;
                        failedCells[2] = true; // คอลัมน์ชื่อประเภทอ้อย
                        rowData.passed = false;
                        results.issues.push({
                            row: rowData.originalRowIndex + 1,
                            message: notes,
                            type: sugarcaneType
                        });
                    }
                } else {
                    // ไม่มีข้อมูลประเภทอ้อย
                    passed = false;
                    notes = "✗ ไม่มีข้อมูลประเภทอ้อย";
                    failedCells[2] = true; // คอลัมน์ชื่อประเภทอ้อย
                    rowData.passed = false;
                    results.issues.push({
                        row: rowData.originalRowIndex + 1,
                        message: notes
                    });
                }
                
                // กำหนดสถานะ
                if (passed) {
                    results.passed++;
                    rowData.status = "ผ่าน";
                } else if (pending) {
                    results.pending++; // ✅ เพิ่มจำนวนที่รอตรวจสอบ
                    rowData.status = "รอตรวจสอบ";
                } else if (rowData.status === "ไม่มีข้อมูลวันที่ปลูก") {
                    results.warnings++;
                } else {
                    results.failed++;
                    rowData.status = "ไม่ผ่าน";
                }
                
                // อัพเดตข้อมูลแถว
                rowData.condition = getConditionDisplayName("sugarcane");
                rowData.notes = notes;
                rowData.failedCells = failedCells;
            });
            
            return results;
        }
        
function prepareFertilizerCheckingTable() {
    const tableBody = document.getElementById('checkingTableBody');
    tableBody.innerHTML = '';
    
    // ค้นหาคอลัมน์ที่เกี่ยวข้องกับปุ๋ยตามโครงสร้างที่กำหนด
    const fertilizerColumns = [
        { name: "เลขแปลงintech", keywords: ["แปลงintech", "แปลง intech", "แปลง"] },
        { name: "ชื่อประเภทอ้อย", keywords: ["ชื่อประเภทอ้อย", "ประเภทอ้อย", "พันธุ์อ้อย"] },
        { name: "อายุอ้อย", keywords: ["อายุอ้อย", "อายุ", "age", "วัน"] },
        { name: "ประเภทการใส่ปุ๋ยงวด 1", keywords: ["ประเภทการใส่ปุ๋ยงวด 1", "ประเภทปุ๋ยงวด1", "ปุ๋ยงวด1"] },
        { name: "สูตรปุ๋ยเคมีครั้งที่1", keywords: ["สูตรปุ๋ยเคมีครั้งที่1", "สูตรปุ๋ย1", "ปุ๋ยเคมี1"] },
        { name: "ประเภทการใส่ปุ๋ยงวด 2", keywords: ["ประเภทการใส่ปุ๋ยงวด 2", "ประเภทปุ๋ยงวด2", "ปุ๋ยงวด2"] },
        { name: "ปุ๋ยเคมีงวด2", keywords: ["ปุ๋ยเคมีงวด2", "สูตรปุ๋ย2", "ปุ๋ยเคมี2"] },
        { name: "ประเภทการใส่ปุ๋ยงวด 3", keywords: ["ประเภทการใส่ปุ๋ยงวด 3", "ประเภทปุ๋ยงวด3", "ปุ๋ยงวด3"] },
        { name: "ปุ๋ยเคมีงวด 3", keywords: ["ปุ๋ยเคมีงวด 3", "สูตรปุ๋ย3", "ปุ๋ยเคมี3"] }
    ];
    
    // หาคอลัมน์ที่ตรงกับความต้องการ
    const foundColumns = {};
    
    fertilizerColumns.forEach(colDef => {
        let foundColumn = null;
        
        // ค้นหาด้วยชื่อตรง
        for (const col of selectedColumns) {
            const colLower = col.toLowerCase().trim();
            const reqNameLower = colDef.name.toLowerCase();
            
            if (colLower === reqNameLower) {
                foundColumn = col;
                break;
            }
        }
        
        // ถ้าไม่เจอชื่อตรง ให้ค้นหาด้วยคำสำคัญ
        if (!foundColumn) {
            for (const col of selectedColumns) {
                const colLower = col.toLowerCase();
                for (const keyword of colDef.keywords) {
                    if (colLower.includes(keyword.toLowerCase())) {
                        foundColumn = col;
                        break;
                    }
                }
                if (foundColumn) break;
            }
        }
        
        foundColumns[colDef.name] = foundColumn;
    });
    
    // แสดงคอลัมน์ที่พบ
    console.log('Found columns for fertilizer check:', foundColumns);
    
    // ตรวจสอบว่ามีคอลัมน์ที่จำเป็นหรือไม่
    const requiredColumns = ["เลขแปลงintech", "ชื่อประเภทอ้อย", "อายุอ้อย"];
    const missingRequiredColumns = [];
    
    requiredColumns.forEach(col => {
        if (!foundColumns[col]) {
            missingRequiredColumns.push(col);
        }
    });
    
    if (missingRequiredColumns.length > 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="12" style="text-align: center; padding: 40px; background: #ffebee;">
                    <div style="color: #d32f2f; font-size: 1.2rem; margin-bottom: 15px;">
                        <i class="fas fa-exclamation-triangle"></i> <strong>ไม่พบคอลัมน์ที่จำเป็น</strong>
                    </div>
                    <p>กรุณาเลือกคอลัมน์เหล่านี้ในขั้นตอนที่ 2:</p>
                    <ul style="text-align: left; display: inline-block; margin-top: 10px;">
                        ${missingRequiredColumns.map(col => `<li>${col}</li>`).join('')}
                    </ul>
                    <p style="margin-top: 15px; color: #666;">
                        <i class="fas fa-info-circle"></i> คอลัมน์ปุ๋ยอื่นๆ จะแสดงเป็นค่าว่างถ้าไม่พบ
                    </p>
                </td>
            </tr>
        `;
        return;
    }
    
    // ใช้ข้อมูลทั้งหมด
    checkingTableData = [];
    
    uploadedData.data.forEach((row, rowIndex) => {
        const rowData = {
            id: rowIndex + 1,
            originalRowIndex: rowIndex,
            intechPlot: foundColumns["เลขแปลงintech"] ? row[foundColumns["เลขแปลงintech"]] || '' : '',
            sugarcaneType: foundColumns["ชื่อประเภทอ้อย"] ? row[foundColumns["ชื่อประเภทอ้อย"]] || '' : '',
            age: foundColumns["อายุอ้อย"] ? row[foundColumns["อายุอ้อย"]] || '' : '',
            fertilizerType1: foundColumns["ประเภทการใส่ปุ๋ยงวด 1"] ? row[foundColumns["ประเภทการใส่ปุ๋ยงวด 1"]] || '' : '',
            fertilizerFormula1: foundColumns["สูตรปุ๋ยเคมีครั้งที่1"] ? row[foundColumns["สูตรปุ๋ยเคมีครั้งที่1"]] || '' : '',
            fertilizerType2: foundColumns["ประเภทการใส่ปุ๋ยงวด 2"] ? row[foundColumns["ประเภทการใส่ปุ๋ยงวด 2"]] || '' : '',
            fertilizerFormula2: foundColumns["ปุ๋ยเคมีงวด2"] ? row[foundColumns["ปุ๋ยเคมีงวด2"]] || '' : '',
            fertilizerType3: foundColumns["ประเภทการใส่ปุ๋ยงวด 3"] ? row[foundColumns["ประเภทการใส่ปุ๋ยงวด 3"]] || '' : '',
            fertilizerFormula3: foundColumns["ปุ๋ยเคมีงวด 3"] ? row[foundColumns["ปุ๋ยเคมีงวด 3"]] || '' : '',
            condition: getConditionDisplayName(currentCondition),
            status: "รอตรวจสอบ",
            notes: "ยังไม่ได้ตรวจสอบ",
            passed: false,
            failedCells: {}
        };
        
        checkingTableData.push(rowData);
    });
    
    // ✅ แก้ไข: สร้าง header ตารางใหม่ (เพิ่มคอลัมน์สถานะและหมายเหตุ)
    const tableHeader = document.getElementById('checkingTableHeader');
    tableHeader.innerHTML = '';
    
    const headerRow = document.createElement('tr');
    const headers = [
        "ลำดับ",
        "เลขแปลงintech", 
        "ชื่อประเภทอ้อย",
        "อายุอ้อย",
        "ประเภทการใส่ปุ๋ยงวด 1",
        "สูตรปุ๋ยเคมีครั้งที่1",
        "ประเภทการใส่ปุ๋ยงวด 2",
        "ปุ๋ยเคมีงวด2",
        "ประเภทการใส่ปุ๋ยงวด 3",
        "ปุ๋ยเคมีงวด 3",
        "สถานะ", // ✅ เพิ่มคอลัมน์สถานะ
        "หมายเหตุ" // ✅ เพิ่มคอลัมน์หมายเหตุ
    ];
    
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    
    tableHeader.appendChild(headerRow);
    
    // แสดงตาราง
renderFertilizerCheckingTable();

// ✅ แสดงคำแนะนำการเลื่อน
const scrollHint = document.getElementById('scrollHint');
if (scrollHint) {
    scrollHint.style.display = 'inline-block';
}

// อัพเดตจำนวนแถว
document.getElementById('checkingRowsCount').textContent = checkingTableData.length;
    
    // แสดงข้อความแจ้งเตือนสำเร็จ
    const resultsContainer = document.getElementById('checkingResults');
    
    // นับคอลัมน์ที่พบ
    const foundCount = Object.values(foundColumns).filter(col => col !== null).length;
    const totalColumns = fertilizerColumns.length;
    
    resultsContainer.innerHTML = `
        <div class="result-summary" style="background: #e8f5e9; border-left-color: #4caf50;">
            <p><i class="fas fa-check-circle"></i> <strong>เตรียมตารางตรวจสอบ "${getConditionDisplayName(currentCondition)}" เสร็จเรียบร้อย</strong></p>
            <p>พบข้อมูลทั้งหมด: <strong>${checkingTableData.length} แถว</strong></p>
            <p>พบคอลัมน์ปุ๋ย: ${foundCount}/${totalColumns} คอลัมน์</p>
            <div style="margin-top: 10px; background: white; padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
                <p><strong>คอลัมน์ที่พบ:</strong></p>
                <ul style="font-size: 0.9em; columns: 2; margin-top: 5px;">
                    ${fertilizerColumns.map(colDef => {
                        const foundCol = foundColumns[colDef.name];
                        if (foundCol) {
                            return `<li><span style="color: #4caf50;">✓</span> ${colDef.name}: "${foundCol}"</li>`;
                        } else {
                            return `<li><span style="color: #f44336;">✗</span> ${colDef.name}: ไม่พบ</li>`;
                        }
                    }).join('')}
                </ul>
            </div>
            <div style="margin-top: 10px; background: #e3f2fd; padding: 10px; border-radius: 6px; border: 1px solid #2196f3;">
                <p><strong><i class="fas fa-info-circle"></i> ข้อมูลการตรวจสอบปุ๋ย:</strong></p>
                <ul style="font-size: 0.9em; margin-top: 5px;">
                    <li>ระบบจะตรวจสอบความสัมพันธ์ระหว่างประเภทอ้อย-อายุ-ปุ๋ย</li>
                    <li>ประเภทปุ๋ยที่รับรอง: รองพื้น, แต่งหน้าครั้งที่1, แต่งหน้าครั้งที่2, แต่งหน้าครั้งที่3</li>
                    <li>สูตรปุ๋ยเคมี: แสดงข้อมูลเท่านั้น ไม่ตรวจสอบ</li>
                    <li>ผลการตรวจสอบจะแสดงในคอลัมน์ "สถานะ" และ "หมายเหตุ"</li>
                </ul>
            </div>
            <p style="margin-top: 15px;">
                <button class="btn btn-primary" id="startFertilizerCheckBtn">
                    <i class="fas fa-play"></i> เริ่มตรวจสอบปุ๋ย
                </button>
            </p>
        </div>
    `;
    
    // เพิ่ม event listener ให้ปุ่มเริ่มตรวจสอบ
    document.getElementById('startFertilizerCheckBtn').addEventListener('click', function() {
        const results = performFertilizerConditionCheck();
        updateCheckingTableWithResults(results, currentCondition);
        updateCheckingStats(results);
        displayCheckingResults(results, currentCondition);
        
        // แสดงผล
        const message = `✅ ตรวจสอบเงื่อนไข "${getConditionDisplayName(currentCondition)}" เสร็จสิ้น\n\n` +
                       `ตรวจทั้งหมด: ${results.totalRows} แถว\n` +
                       `ผ่าน: ${results.passed} แถว\n` +
                       `ไม่ผ่าน: ${results.failed} แถว\n` +
                       (results.warnings > 0 ? `ต้องตรวจสอบ: ${results.warnings} แถว\n` : '');
        alert(message);
    });
}
        
function renderFertilizerCheckingTable() {
    const tableBody = document.getElementById('checkingTableBody');
    tableBody.innerHTML = '';
    
    let displayedRows = 0;
    
    checkingTableData.forEach(rowData => {
        // กรองแสดงเฉพาะที่ไม่ผ่านถ้าเลือก
        if (showOnlyFailed && rowData.status === "ผ่าน") {
            return;
        }
        
        displayedRows++;
        
        const tr = document.createElement('tr');
        
        // ✅ แก้ไข: เพิ่มคอลัมน์สถานะและหมายเหตุ
        const cells = [
            rowData.id,
            rowData.intechPlot || '(ไม่พบข้อมูล)',
            rowData.sugarcaneType || '(ไม่พบข้อมูล)',
            rowData.age || '',
            rowData.fertilizerType1 || '',
            rowData.fertilizerFormula1 || '',
            rowData.fertilizerType2 || '',
            rowData.fertilizerFormula2 || '',
            rowData.fertilizerType3 || '',
            rowData.fertilizerFormula3 || '',
            createStatusBadge(rowData.status), // ✅ เพิ่มคอลัมน์สถานะ
            rowData.notes || '' // ✅ เพิ่มคอลัมน์หมายเหตุ
        ];
        
        cells.forEach((cellContent, cellIndex) => {
            const td = document.createElement('td');
            
            // สำหรับคอลัมน์อายุอ้อย (คอลัมน์ที่ 4)
            if (cellIndex === 3 && rowData.age) {
                const ageValue = parseFloat(rowData.age);
                if (!isNaN(ageValue)) {
                    // แสดงสีตามอายุ
                    if (ageValue < 0) {
                        td.style.color = 'var(--danger-color)';
                        td.style.fontWeight = 'bold';
                        td.title = 'อายุอ้อยไม่สามารถเป็นค่าติดลบได้';
                    } else if (ageValue > 365) {
                        td.style.color = 'var(--warning-color)';
                        td.style.fontWeight = 'bold';
                        td.title = 'อายุอ้อยมากกว่า 1 ปี';
                    }
                }
            }
            
            // สำหรับคอลัมน์ประเภทการใส่ปุ๋ย
            const fertilizerTypeCells = [4, 6, 8]; // คอลัมน์ 5, 7, 9 (index 4, 6, 8)
            if (fertilizerTypeCells.includes(cellIndex) && cellContent !== '') {
                const validTypes = ["รองพื้น", "แต่งหน้าครั้งที่1", "แต่งหน้าครั้งที่2", "แต่งหน้าครั้งที่3"]; // ✅ แก้ไขเหลือ 4 ประเภท
                if (!validTypes.includes(cellContent)) {
                    td.style.color = 'var(--danger-color)';
                    td.style.fontWeight = 'bold';
                    td.title = `ประเภทการใส่ปุ๋ยไม่ถูกต้อง ต้องเป็นหนึ่งใน: ${validTypes.join(', ')}`;
                }
            }
            
            // ✅ แก้ไข: ไม่ต้องตรวจสอบคอลัมน์สูตรปุ๋ยเคมี
            // สำหรับคอลัมน์สูตรปุ๋ยเคมี
            // const fertilizerFormulaCells = [5, 7, 9]; // คอลัมน์ 6, 8, 10 (index 5, 7, 9)
            // if (fertilizerFormulaCells.includes(cellIndex) && cellContent !== '') {
            //     // ไม่ต้องตรวจสอบรูปแบบสูตรปุ๋ยแล้ว
            // }
            
            // สำหรับคอลัมน์สถานะ (คอลัมน์ที่ 11, index 10)
            if (cellIndex === 10) {
                td.innerHTML = cellContent;
            } else {
                // ตรวจสอบค่าว่าง - แสดงเป็นสีเทา
                if (cellContent === '') {
                    td.style.color = '#999';
                    td.style.fontStyle = 'italic';
                } else {
                    td.textContent = cellContent;
                }
            }
            
            // ตรวจสอบข้อผิดพลาดในคอลัมน์
            if (rowData.failedCells && rowData.failedCells[cellIndex]) {
                td.style.color = 'var(--danger-color)';
                td.style.fontWeight = 'bold';
                td.style.backgroundColor = 'rgba(247, 37, 133, 0.1)';
            }
            
            // ถ้าผ่าน ให้เพิ่มสีเขียว
            if (rowData.passed && cellIndex > 0 && cellIndex < 10) {
                td.style.color = 'var(--success-color)';
                td.style.fontWeight = 'bold';
                td.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
            }
            
            tr.appendChild(td);
        });
        
        tableBody.appendChild(tr);
    });
    
    // อัพเดตจำนวนแถวที่แสดง
    document.getElementById('checkingRowsCount').textContent = displayedRows;
}
        
function performFertilizerConditionCheck() {
    const results = {
        condition: "fertilizer",
        totalRows: checkingTableData.length,
        passed: 0,
        failed: 0,
        warnings: 0,
        issues: []
    };

    // ✅ แก้ไข: ประเภทการใส่ปุ๋ยที่รับรองใหม่ (แค่ 4 ประเภท)
    const validFertilizerTypes = ["รองพื้น", "แต่งหน้าครั้งที่1", "แต่งหน้าครั้งที่2", "แต่งหน้าครั้งที่3"];

    checkingTableData.forEach((rowData, index) => {
        let passed = true;
        let notes = [];
        let failedCells = {};
        
        // ✅ แก้ไข: ไม่ต้องตรวจสอบอายุอ้อยเป็นตัวเลข ≥ 0
        let ageValue = null;
        if (rowData.age && rowData.age.trim() !== '') {
            ageValue = parseFloat(rowData.age);
        }

        // ตรวจสอบประเภทอ้อย
        const sugarcaneType = rowData.sugarcaneType ? rowData.sugarcaneType.trim() : '';
        const sugarcaneGroup = getSugarcaneGroup(sugarcaneType);
        
        // ✅ ตรวจสอบความสัมพันธ์ระหว่างประเภทอ้อย อายุ และประเภทการใส่ปุ๋ย
        if (sugarcaneGroup !== "unknown" && sugarcaneType !== '' && ageValue !== null && !isNaN(ageValue)) {
            // ตรวจสอบปุ๋ยงวด 1
            if (rowData.fertilizerType1 && rowData.fertilizerType1.trim() !== '') {
                const fertilizerType1 = rowData.fertilizerType1.trim();
                const expectedType1 = getExpectedFertilizerType(sugarcaneType, ageValue, 1);
                
                if (expectedType1) {
                    if (fertilizerType1 !== expectedType1) {
                        passed = false;
                        notes.push(`ปุ๋ยงวด 1 ควรเป็น "${expectedType1}" (ปัจจุบัน: "${fertilizerType1}")`);
                        failedCells[4] = true; // คอลัมน์ประเภทการใส่ปุ๋ยงวด 1
                    }
                }
                
                // ✅ แก้ไข: ตรวจสอบว่าประเภทการใส่ปุ๋ยถูกต้องตามรายการใหม่
                if (!validFertilizerTypes.includes(fertilizerType1)) {
                    passed = false;
                    notes.push(`ประเภทการใส่ปุ๋ยงวด 1 ไม่ถูกต้อง: "${fertilizerType1}"`);
                    failedCells[4] = true;
                }
            }
            
            // ตรวจสอบปุ๋ยงวด 2
            if (rowData.fertilizerType2 && rowData.fertilizerType2.trim() !== '') {
                const fertilizerType2 = rowData.fertilizerType2.trim();
                const expectedType2 = getExpectedFertilizerType(sugarcaneType, ageValue, 2);
                
                if (expectedType2) {
                    if (fertilizerType2 !== expectedType2) {
                        passed = false;
                        notes.push(`ปุ๋ยงวด 2 ควรเป็น "${expectedType2}" (ปัจจุบัน: "${fertilizerType2}")`);
                        failedCells[6] = true; // คอลัมน์ประเภทการใส่ปุ๋ยงวด 2
                    }
                }
                
                // ✅ แก้ไข: ตรวจสอบว่าประเภทการใส่ปุ๋ยถูกต้องตามรายการใหม่
                if (!validFertilizerTypes.includes(fertilizerType2)) {
                    passed = false;
                    notes.push(`ประเภทการใส่ปุ๋ยงวด 2 ไม่ถูกต้อง: "${fertilizerType2}"`);
                    failedCells[6] = true;
                }
            }

            // ตรวจสอบปุ๋ยงวด 3
            if (rowData.fertilizerType3 && rowData.fertilizerType3.trim() !== '') {
                const fertilizerType3 = rowData.fertilizerType3.trim();
                const expectedType3 = getExpectedFertilizerType(sugarcaneType, ageValue, 3);
                
                if (expectedType3) {
                    if (fertilizerType3 !== expectedType3) {
                        passed = false;
                        notes.push(`ปุ๋ยงวด 3 ควรเป็น "${expectedType3}" (ปัจจุบัน: "${fertilizerType3}")`);
                        failedCells[8] = true; // คอลัมน์ประเภทการใส่ปุ๋ยงวด 3
                    }
                }
                
                // ✅ แก้ไข: ตรวจสอบว่าประเภทการใส่ปุ๋ยถูกต้องตามรายการใหม่
                if (!validFertilizerTypes.includes(fertilizerType3)) {
                    passed = false;
                    notes.push(`ประเภทการใส่ปุ๋ยงวด 3 ไม่ถูกต้อง: "${fertilizerType3}"`);
                    failedCells[8] = true;
                }
            }
        } else {
            // ถ้าไม่มีข้อมูลประเภทอ้อยหรืออายุ
            if (sugarcaneType === '') {
                notes.push("ไม่มีข้อมูลประเภทอ้อย");
            }
            if (ageValue === null || isNaN(ageValue)) {
                notes.push("ไม่มีข้อมูลอายุอ้อยหรืออายุไม่ถูกต้อง");
            }
            
            // ✅ แก้ไข: ตรวจสอบแค่ว่าประเภทปุ๋ยอยู่ในรายการที่กำหนดหรือไม่
            if (rowData.fertilizerType1 && rowData.fertilizerType1.trim() !== '') {
                if (!validFertilizerTypes.includes(rowData.fertilizerType1.trim())) {
                    passed = false;
                    notes.push("ประเภทการใส่ปุ๋ยงวด 1 ไม่ถูกต้อง");
                    failedCells[4] = true;
                }
            }

            if (rowData.fertilizerType2 && rowData.fertilizerType2.trim() !== '') {
                if (!validFertilizerTypes.includes(rowData.fertilizerType2.trim())) {
                    passed = false;
                    notes.push("ประเภทการใส่ปุ๋ยงวด 2 ไม่ถูกต้อง");
                    failedCells[6] = true;
                }
            }

            if (rowData.fertilizerType3 && rowData.fertilizerType3.trim() !== '') {
                if (!validFertilizerTypes.includes(rowData.fertilizerType3.trim())) {
                    passed = false;
                    notes.push("ประเภทการใส่ปุ๋ยงวด 3 ไม่ถูกต้อง");
                    failedCells[8] = true;
                }
            }
        }

        if (passed && notes.length === 0) {
            results.passed++;
            rowData.status = "ผ่าน";
            rowData.notes = "✓ ปุ๋ยตรงกับเงื่อนไขความสัมพันธ์";
        } else if (sugarcaneType === '' || ageValue === null || isNaN(ageValue)) {
            results.warnings++;
            rowData.status = "รอตรวจสอบ";
            rowData.notes = notes.join('; ') || "ไม่มีข้อมูลประเภทอ้อยหรืออายุ";
        } else {
            results.failed++;
            rowData.status = "ไม่ผ่าน";
            rowData.notes = notes.join('; ');
            results.issues.push({
                row: index + 1,
                message: notes.join('; '),
                intechPlot: rowData.intechPlot,
                sugarcaneType: rowData.sugarcaneType,
                age: rowData.age
            });
        }

        rowData.passed = passed;
        rowData.failedCells = failedCells;
    });

    return results;
}

// ✅ เพิ่ม: ฟังก์ชันหาประเภทปุ๋ยที่ควรจะเป็นตามเงื่อนไข
function getExpectedFertilizerType(sugarcaneType, age, period) {
    const normalizedType = sugarcaneType.trim();
    
    // ตรวจสอบว่าประเภทอ้อยอยู่ในเงื่อนไขหรือไม่
    if (fertilizerConditions[normalizedType]) {
        const condition = fertilizerConditions[normalizedType];
        
        switch(period) {
            case 1: // งวด 1
                if (age >= condition.period1.minAge && age <= condition.period1.maxAge) {
                    return condition.period1.expected;
                }
                break;
            case 2: // งวด 2
                if (age >= condition.period2.minAge && age <= condition.period2.maxAge) {
                    return condition.period2.expected;
                }
                break;
            case 3: // งวด 3
                if (age >= condition.period3.minAge && age <= condition.period3.maxAge) {
                    return condition.period3.expected;
                }
                break;
        }
    }
    
    return null; // ถ้าไม่มีเงื่อนไขที่ตรง
}
        
        function updateCheckingTableWithResults(results, condition) {
            // อัพเดตข้อมูลในตาราง
            checkingTableData.forEach((rowData) => {
                rowData.condition = getConditionDisplayName(condition);
            });
            
            // แสดงตารางใหม่ตามเงื่อนไข
            if (condition === "fertilizer") {
                renderFertilizerCheckingTable();
            } else if (condition === "sugarcane") {
                renderCheckingTableFiltered();
            } else {
                renderGeneralCheckingTable();
            }
        }
        
        function updateCheckingStats(results) {
            document.getElementById('foundIssues').textContent = results.failed + results.warnings;
            document.getElementById('passedChecks').textContent = results.passed;
            document.getElementById('failedChecks').textContent = results.failed;
            
            // ✅ แก้ไข: เพิ่มการแสดงจำนวน warning
            const warningCount = results.warnings || 0;
            if (warningCount > 0) {
                if (!document.getElementById('warningChecks')) {
                    const warningSpan = document.createElement('span');
                    warningSpan.id = 'warningChecks';
                    warningSpan.innerHTML = `ต้องตรวจสอบ: <strong>${warningCount}</strong>`;
                    warningSpan.style.background = 'rgba(255, 152, 0, 0.1)';
                    warningSpan.style.padding = '8px 15px';
                    warningSpan.style.borderRadius = '20px';
                    warningSpan.style.color = 'var(--warning-color)';
                    document.querySelector('.checking-stats').appendChild(warningSpan);
                } else {
                    document.getElementById('warningChecks').innerHTML = 
                        `ต้องตรวจสอบ: <strong>${warningCount}</strong>`;
                }
            }
        }
        
        function displayCheckingResults(results, condition) {
            const resultsContainer = document.getElementById('checkingResults');
            
            // ✅ แก้ไข: คำนวณข้อมูลให้ถูกต้อง
            const totalRows = uploadedData.data.length;
            const hasHeaderRow = 1;
            const rowsWithIntech = checkingTableData ? checkingTableData.filter(row => row.hasIntech).length : 0;
            const rowsWithoutIntech = checkingTableData ? checkingTableData.filter(row => !row.hasIntech).length : 0;
            
            let html = `
                <div class="result-summary">
                    <p><i class="fas fa-check-circle" style="color: #4caf50;"></i> ตรวจสอบเงื่อนไข "<strong>${getConditionDisplayName(condition)}</strong>" เรียบร้อยแล้ว</p>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p><strong><i class="fas fa-info-circle"></i> สรุปข้อมูลไฟล์:</strong></p>
                        <ul style="margin-top: 5px;">
                            <li>ไฟล์ CSV ทั้งหมด: <strong>${totalRows + hasHeaderRow} แถว</strong> (รวมหัวตาราง)</li>
                            <li>ข้อมูลทั้งหมด: <strong>${totalRows} แถว</strong> (ไม่รวมหัวตาราง)</li>
                            <li>แถวที่มีเลขแปลงintech: <strong>${rowsWithIntech} แถว</strong></li>
                            <li>แถวที่ไม่มีเลขแปลงintech: <strong>${rowsWithoutIntech} แถว</strong></li>
                        </ul>
                    </div>
                    <div class="result-header">
                        <span class="result-condition">สรุปผลการตรวจสอบ</span>
                        <span class="result-count">ตรวจ ${results.totalRows} แถว</span>
                    </div>
                    <ul>
                        <li>ผ่าน: ${results.passed} รายการ</li>
                        <li>ไม่ผ่าน: ${results.failed} รายการ</li>
                        ${results.warnings > 0 ? `<li>ต้องตรวจสอบ: <span style="color: #ff9800; font-weight: bold;">${results.warnings} รายการ</span></li>` : ''}
                        ${results.pending > 0 ? `<li>รอตรวจสอบ: <span style="color: #ff9800; font-weight: bold;">${results.pending} รายการ</span> (ไม่อยู่ในเงื่อนไข)</li>` : ''}
                    </ul>
            `;
            
if (condition === "fertilizer") {
    html += `
        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
            <p><strong><i class="fas fa-info-circle"></i> มาตรฐานการตรวจสอบปุ๋ย:</strong></p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                    <h4 style="color: #2196f3; margin-bottom: 5px;">ประเภทการใส่ปุ๋ยที่รับรอง</h4>
                    <ul style="font-size: 0.9em;">
                        <li><strong>รองพื้น</strong> (อ้อยปลูกใหม่ อายุ 1-60 วัน)</li>
                        <li><strong>แต่งหน้าครั้งที่1</strong></li>
                        <li><strong>แต่งหน้าครั้งที่2</strong></li>
                        <li><strong>แต่งหน้าครั้งที่3</strong></li>
                    </ul>
                </div>
                <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                    <h4 style="color: #2196f3; margin-bottom: 5px;">รูปแบบสูตรปุ๋ยเคมี</h4>
                    <ul style="font-size: 0.9em;">
                        <li>แสดงข้อมูลเท่านั้น ไม่ตรวจสอบ</li>
                        <li>ตัวอย่าง: 16-16-16</li>
                        <li>ตัวอย่าง: 46-0-0</li>
                        <li>ตัวอย่าง: 21-7-18</li>
                    </ul>
                </div>
            </div>
            <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #ddd;">
                <h4 style="color: #2196f3; margin-bottom: 5px;">เงื่อนไขความสัมพันธ์ระหว่างประเภทอ้อย-อายุ-ปุ๋ย</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div>
                        <h5 style="color: #4caf50; margin-bottom: 5px;">อ้อยปลูกใหม่</h5>
                        <ul style="font-size: 0.85em;">
                            <li>อายุ 1-60 วัน → ปุ๋ยงวด 1 = <strong>รองพื้น</strong></li>
                            <li>อายุ 61-120 วัน → ปุ๋ยงวด 2 = <strong>แต่งหน้าครั้งที่1</strong></li>
                            <li>อายุ 121-180 วัน → ปุ๋ยงวด 3 = <strong>แต่งหน้าครั้งที่2</strong></li>
                        </ul>
                    </div>
                    <div>
                        <h5 style="color: #ff9800; margin-bottom: 5px;">อ้อยตอ</h5>
                        <ul style="font-size: 0.85em;">
                            <li>อายุ 1-60 วัน → ปุ๋ยงวด 1 = <strong>แต่งหน้าครั้งที่1</strong></li>
                            <li>อายุ 61-120 วัน → ปุ๋ยงวด 2 = <strong>แต่งหน้าครั้งที่2</strong></li>
                            <li>อายุ 121-180 วัน → ปุ๋ยงวด 3 = <strong>แต่งหน้าครั้งที่3</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `;
}
            
            if (results.issues.length > 0) {
                // จัดกลุ่มปัญหาตามสถานะ
                const issuesByStatus = {};
                results.issues.forEach(issue => {
                    const status = issue.status || 'ไม่ระบุสถานะ';
                    if (!issuesByStatus[status]) {
                        issuesByStatus[status] = [];
                    }
                    issuesByStatus[status].push(issue);
                });
                
                html += `
                    <div class="result-details">
                        <p><strong>ปัญหาที่พบ (จัดกลุ่มตามสถานะ):</strong></p>
                `;
                
                for (const [status, issues] of Object.entries(issuesByStatus)) {
                    html += `
                        <div class="result-item ${status.includes('ไม่ผ่าน') ? 'error' : 'warning'}" style="margin-bottom: 10px; cursor: pointer;" 
                             onclick="showSpecificIssues(${JSON.stringify(issues).replace(/"/g, '&quot;')}, '${status}')">
                            <div class="result-header">
                                <span class="result-condition">${status}</span>
                                <span class="result-count">พบปัญหา ${issues.length} รายการ</span>
                            </div>
                            <p style="margin-top: 5px; font-size: 0.9em;">
                                <i class="fas fa-mouse-pointer"></i> คลิกเพื่อดูรายละเอียด
                            </p>
                        </div>
                    `;
                }
                
                // เพิ่มข้อมูลสรุปช่วงวันที่สำหรับประเภทอ้อย
                if (condition === "sugarcane") {
                    html += `
                        <div style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 6px;">
                            <p><strong><i class="fas fa-calendar-alt"></i> ช่วงวันที่ที่กำหนดสำหรับแต่ละประเภทอ้อย:</strong></p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                                    <h4 style="color: #4361ee; margin-bottom: 5px;">ปี 2568-2569</h4>
                                    <ul style="font-size: 0.9em;">
                                        <li><strong>ปลายฝน</strong> (ปลายฝนขยาย/ปลายฝนรื้อตอ): ตุลาคม 2568 - กุมภาพันธ์ 2569</li>
                                        <li><strong>ต้นฝน</strong> (ต้นฝนขยาย/ต้นฝนรื้อตอ): มีนาคม 2569 - มิถุนายน 2569</li>
                                        <li><strong>พันธุ์อ้อย</strong>: มิถุนายน 2569 - กรกฎาคม 2569</li>
                                        <li><strong>ตอ/บำรุงตอ</strong> (ตอ1, ตอ2, ตอ3, >ตอ3): ธันวาคม 2568 - มีนาคม 2569</li>
                                    </ul>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                                    <h4 style="color: #3a0ca3; margin-bottom: 5px;">ปี 2567-2568</h4>
                                    <ul style="font-size: 0.9em;">
                                        <li><strong>ปลายฝน</strong> (ปลายฝนขยาย/ปลายฝนรื้อตอ): ตุลาคม 2567 - มกราคม 2568</li>
                                        <li><strong>ต้นฝน</strong> (ต้นฝนขยาย/ต้นฝนรื้อตอ): กุมภาพันธ์ 2567 - พฤษภาคม 2568</li>
                                        <li><strong>พันธุ์อ้อย</strong>: 1 มิถุนายน 2567 - 30 มิถุนายน 2567</li>
                                        <li><strong>ตอ/บำรุงตอ</strong> (ตอ1, ตอ2, ตอ3, >ตอ3): ธันวาคม 2567 - มีนาคม 2568</li>
                                    </ul>
                                </div>
                            </div>
                            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                <i class="fas fa-info-circle"></i> <strong>สีในตาราง:</strong>
                                <span style="color: #4CAF50;">เขียว</span> = ผ่าน, 
                                <span style="color: #F44336;">แดง</span> = ไม่ผ่าน, 
                                <span style="color: #FF9800;">เหลือง</span> = รอตรวจสอบ/ไม่มีข้อมูลวันที่ปลูก
                            </p>
                            <p style="margin-top: 5px; font-size: 0.9em; color: #ff9800;">
                                <i class="fas fa-exclamation-triangle"></i> <strong>หมายเหตุ:</strong> วันที่ปลูกที่ไม่อยู่ในเงื่อนไขข้างต้นจะได้รับสถานะ "รอตรวจสอบ"
                            </p>
                        </div>
                    `;
                }
                
                // ✅ เพิ่มการแสดงผลสำหรับแถวที่ไม่มีข้อมูลวันที่ปลูก
                const noPlantingDateIssues = results.issues.filter(issue => issue.status === "ไม่มีข้อมูลวันที่ปลูก");
                if (noPlantingDateIssues.length > 0) {
                    html += `
                        <div style="margin-top: 15px; padding: 10px; background: #fff3e0; border-radius: 6px; border-left: 4px solid #ff9800;">
                            <p><strong><i class="fas fa-exclamation-triangle" style="color: #ff9800;"></i> แถวที่ไม่มีข้อมูลวันที่ปลูก (${noPlantingDateIssues.length} รายการ):</strong></p>
                            <p>สถานะ: <span class="status-badge status-warning">ไม่มีข้อมูลวันที่ปลูก</span></p>
                            <p>หมายเหตุ: <strong>"ยังไม่ได้ทำกิจกรรมงวด 1"</strong></p>
                            <p style="margin-top: 8px; font-size: 0.9em; color: #e65100;">
                                <i class="fas fa-info-circle"></i> แถวเหล่านี้จะแสดงเป็นแถบสีเหลืองในตาราง
                            </p>
                        </div>
                    `;
                }
                
                // ✅ เพิ่มการแสดงผลสำหรับแถวที่รอตรวจสอบ
                const pendingIssues = results.issues.filter(issue => issue.status === "รอตรวจสอบ");
                if (pendingIssues.length > 0) {
                    html += `
                        <div style="margin-top: 15px; padding: 10px; background: #fff3e0; border-radius: 6px; border-left: 4px solid #ff9800;">
                            <p><strong><i class="fas fa-clock" style="color: #ff9800;"></i> แถวที่รอตรวจสอบ (${pendingIssues.length} รายการ):</strong></p>
                            <p>สถานะ: <span class="status-badge status-warning">รอตรวจสอบ</span></p>
                            <p>หมายเหตุ: <strong>"ไม่อยู่ในเงื่อนไข"</strong></p>
                            <p style="margin-top: 8px; font-size: 0.9em; color: #e65100;">
                                <i class="fas fa-info-circle"></i> วันที่ปลูกไม่อยู่ในช่วงที่กำหนดสำหรับประเภทอ้อยนั้น
                            </p>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            html += `</div>`;
            
            resultsContainer.innerHTML = html;
        }
        
        function runAllConditionChecks() {
            const conditions = ["sugarcane", "fertilizer"]; // ✅ แก้ไข: ตรวจสอบเฉพาะ "sugarcane" และ "fertilizer"
            const allResults = [];
            
            document.getElementById('runAllChecks').disabled = true;
            document.getElementById('runAllChecks').innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังตรวจสอบทั้งหมด...';
            
            // ตรวจสอบทีละเงื่อนไข
            let completedChecks = 0;
            
            conditions.forEach(condition => {
                setTimeout(() => {
                    // เตรียมตารางสำหรับเงื่อนไขนี้
                    currentCondition = condition;
                    prepareCheckingTable();
                    
                    // รอให้ตารางเตรียมพร้อม
                    setTimeout(() => {
                        let results;
                        
                        switch(condition) {
                            case "sugarcane":
                                results = performSugarcaneConditionCheck();
                                break;
                            case "fertilizer":
                                results = performFertilizerConditionCheck();
                                break;
                        }
                        
                        if (results) {
                            allResults.push(results);
                            updateCheckingTableWithResults(results, condition);
                        }
                        
                        completedChecks++;
                        
                        if (completedChecks === conditions.length) {
                            // เมื่อตรวจสอบทั้งหมดเสร็จ
                            displayAllCheckingResults(allResults);
                            
                            document.getElementById('runAllChecks').disabled = false;
                            document.getElementById('runAllChecks').innerHTML = '<i class="fas fa-play-circle"></i> ตรวจสอบเงื่อนไขทั้งหมด';
                        }
                    }, 500);
                }, 1000 * conditions.indexOf(condition));
            });
        }
        
        function displayAllCheckingResults(allResults) {
            const resultsContainer = document.getElementById('checkingResults');
            
            let html = `
                <div class="result-summary">
                    <p><i class="fas fa-check-circle" style="color: #4caf50;"></i> ตรวจสอบเงื่อนไขทั้งหมดเรียบร้อยแล้ว</p>
                    <div class="result-header">
                        <span class="result-condition">สรุปผลการตรวจสอบทั้งหมด</span>
                        <span class="result-count">ตรวจ ${allResults[0].totalRows} แถว</span>
                    </div>
            `;
            
            allResults.forEach(results => {
                const conditionName = getConditionDisplayName(results.condition);
                
                html += `
                    <div class="result-item ${results.failed > 0 || results.warnings > 0 ? 'error' : 'success'}" 
                         onclick="showSpecificIssues(${JSON.stringify(results.issues).replace(/"/g, '&quot;')}, '${conditionName}')">
                        <div class="result-header">
                            <span class="result-condition">${conditionName}</span>
                            <span class="result-count">ผ่าน ${results.passed}/${results.totalRows}</span>
                        </div>
                        <div class="result-details">
                            <p>พบปัญหา ${results.failed} รายการ${results.warnings > 0 ? `, ต้องตรวจสอบ ${results.warnings} รายการ` : ''}</p>
                            ${results.condition === "sugarcane" ? 
                                `<p style="font-size: 0.9em; color: #666;">ตรวจสอบความสัมพันธ์ระหว่างประเภทอ้อยและวันที่ปลูก</p>` : 
                                ''}
                            <p style="margin-top: 5px; font-size: 0.9em;">
                                <i class="fas fa-mouse-pointer"></i> คลิกเพื่อดูรายละเอียด
                            </p>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            resultsContainer.innerHTML = html;
        }
        
        // ✅ ฟังก์ชันใหม่: แสดงปัญหาที่เฉพาะเจาะจง
        window.showSpecificIssues = function(issues, issueType) {
            // กรองแถวที่มีปัญหาเหล่านี้
            const issueRows = issues.map(issue => issue.row);
            
            // กรองตารางแสดงเฉพาะแถวที่มีปัญหา
            const rows = document.querySelectorAll('#checkingTableBody tr');
            let shownCount = 0;
            
            rows.forEach(row => {
                const rowNumber = parseInt(row.cells[0].textContent);
                if (issueRows.includes(rowNumber)) {
                    row.style.display = '';
                    row.style.backgroundColor = issueType.includes('ไม่ผ่าน') ? 'rgba(255, 235, 238, 0.5)' : 'rgba(255, 248, 225, 0.5)';
                    shownCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // แสดงปุ่มเพื่อกลับไปแสดงทั้งหมด
            const tableControls = document.querySelector('.table-controls');
            if (!document.getElementById('backToAllResults')) {
                const backBtn = document.createElement('button');
                backBtn.id = 'backToAllResults';
                backBtn.className = 'btn btn-outline btn-sm';
                backBtn.innerHTML = `<i class="fas fa-arrow-left"></i> แสดงทั้งหมด`;
                backBtn.style.marginLeft = '10px';
                backBtn.addEventListener('click', function() {
                    showAllCheckingResults();
                });
                
                const tableActions = document.querySelector('.table-actions');
                if (tableActions) {
                    tableActions.appendChild(backBtn);
                }
            }
            
            // อัพเดตจำนวนแถวที่แสดง
            document.getElementById('checkingRowsCount').textContent = shownCount;
            
            // แสดงแจ้งเตือน
            alert(`แสดงปัญหา "${issueType}"\nพบ ${shownCount} แถวที่มีปัญหา`);
        };
        
        function showAllCheckingResults() {
            const rows = document.querySelectorAll('#checkingTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
                row.style.backgroundColor = '';
            });
            
            const backBtn = document.getElementById('backToAllResults');
            if (backBtn) {
                backBtn.remove();
            }
            
            document.getElementById('checkingRowsCount').textContent = checkingTableData.length;
        }
        
        function exportCheckingResultsWithColors() {
            if (checkingTableData.length === 0) {
                alert('ไม่มีข้อมูลผลการตรวจสอบ');
                return;
            }
            
            // สร้าง CSV พร้อม HTML formatting สำหรับสี
            let csvContent = '';
            
            // เพิ่ม BOM สำหรับ UTF-8 เพื่อให้ Excel อ่านภาษาไทยได้ถูกต้อง
            csvContent += '\ufeff';
            
            // รับ headers จากตาราง
            const tableHeader = document.getElementById('checkingTableHeader');
            const headerRow = tableHeader.querySelector('tr');
            const headers = [];
            
            for (let i = 0; i < headerRow.cells.length; i++) {
                headers.push(headerRow.cells[i].textContent);
            }
            
            csvContent += headers.join(',') + '\n';
            
            // data
            checkingTableData.forEach(row => {
                const rowData = [];
                
                // เก็บค่าจากแต่ละคอลัมน์
                for (let i = 0; i < headers.length; i++) {
                    const header = headers[i];
                    let cellValue = '';
                    
                    if (header === "ลำดับ") {
                        cellValue = row.id;
                    } else if (header === "สถานะ") {
                        cellValue = row.status;
                    } else if (header === "หมายเหตุ") {
                        cellValue = row.notes || '';
                    } else if (header === "เงื่อนไขที่ตรวจ") {
                        cellValue = row.condition || '';
                    } else {
                        // คอลัมน์ข้อมูลอื่นๆ
                        cellValue = row[header] || '';
                    }
                    
                    // Escape CSV
                    cellValue = escapeCSV(cellValue.toString());
                    
                    // เพิ่มสีตามสถานะ
                    if (header === "สถานะ") {
                        if (row.status === "ไม่ผ่าน") {
                            cellValue = `<font color='#FF0000'><b>${cellValue}</b></font>`;
                        } else if (row.status === "ผ่าน") {
                            cellValue = `<font color='#4CAF50'><b>${cellValue}</b></font>`;
                        } else if (row.status === "ต้องตรวจสอบ" || row.status === "ไม่มีข้อมูลวันที่ปลูก") {
                            cellValue = `<font color='#FF9800'><b>${cellValue}</b></font>`;
                        }
                    }
                    
                    rowData.push(`"${cellValue}"`);
                }
                
                csvContent += rowData.join(',') + '\n';
            });
            
            // ให้เลือกว่าจะดาวน์โหลดไฟล์แบบไหน
            const choice = confirm('ต้องการดาวน์โหลดไฟล์แบบไหน?\n\n"ตกลง" = ไฟล์ CSV พร้อมสีแดง/เขียว/เหลือง (เปิดใน Excel)\n"ยกเลิก" = ไฟล์ HTML table พร้อมสีเขียว-แดง-เหลือง');
            
            if (choice) {
                // ดาวน์โหลดเป็น CSV พร้อม HTML formatting
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `condition_check_results_${currentCondition}_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('ส่งออกผลการตรวจสอบเรียบร้อยแล้ว!\n\nไฟล์ CSV นี้มีสีแดงในเซลล์ที่ไม่สัมพันธ์ สีเขียวในเซลล์ที่สัมพันธ์ และสีเหลืองในแถวที่ไม่มีข้อมูลวันที่ปลูก\nโปรดเปิดใน Microsoft Excel เพื่อดูสี');
            } else {
                // สร้าง HTML table สำหรับ Excel
                const htmlContent = createHTMLTableForExport();
                
                // ดาวน์โหลดเป็น HTML table
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `condition_check_results_${currentCondition}_table_${new Date().toISOString().slice(0,10)}.html`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('ส่งออกผลการตรวจสอบเรียบร้อยแล้ว!\n\nไฟล์ HTML table นี้แสดงสีแดงสำหรับเซลล์ที่ไม่สัมพันธ์ สีเขียวสำหรับเซลล์ที่สัมพันธ์ และสีเหลืองสำหรับแถวที่ไม่มีข้อมูลวันที่ปลูก\nเปิดในเบราว์เซอร์เพื่อดูผลลัพธ์');
            }
        }
        
        function createHTMLTableForExport() {
            // รับ headers จากตาราง
            const tableHeader = document.getElementById('checkingTableHeader');
            const headerRow = tableHeader.querySelector('tr');
            const headers = [];
            
            for (let i = 0; i < headerRow.cells.length; i++) {
                headers.push(headerRow.cells[i].textContent);
            }
            
            let htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        table {
                            border-collapse: collapse;
                            width: 100%;
                            font-family: 'Prompt', sans-serif;
                        }
                        th {
                            background-color: #4361ee;
                            color: white;
                            padding: 12px;
                            text-align: left;
                            font-weight: bold;
                            border: 1px solid #ddd;
                        }
                        td {
                            padding: 8px;
                            border: 1px solid #ddd;
                        }
                        tr:nth-child(even) {
                            background-color: #f8f9fa;
                        }
                        .failed-cell {
                            color: #FF0000;
                            font-weight: bold;
                            background-color: #FFEBEE;
                        }
                        .passed-cell {
                            color: #4CAF50;
                            font-weight: bold;
                            background-color: #E8F5E9;
                        }
                        .passed-status {
                            color: #4CAF50;
                            font-weight: bold;
                        }
                        .failed-status {
                            color: #FF0000;
                            font-weight: bold;
                        }
                        .warning-row {
                            background-color: #FFF8E1 !important;
                            border-left: 4px solid #FF9800 !important;
                        }
                        .warning-status {
                            color: #FF9800;
                            font-weight: bold;
                        }
                    </style>
                </head>
                <body>
                    <h2>ผลการตรวจสอบเงื่อนไขข้อมูลอ้อย</h2>
                    <p>วันที่ส่งออก: ${new Date().toLocaleDateString('th-TH')}</p>
                    <p>เงื่อนไข: ${getConditionDisplayName(currentCondition)}</p>
                    <table>
                        <thead>
                            <tr>
                                ${headers.map(header => `<th>${header}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            checkingTableData.forEach(row => {
                const rowClass = row.status === 'ไม่มีข้อมูลวันที่ปลูก' ? 'class="warning-row"' : '';
                
                htmlContent += `<tr ${rowClass}>`;
                
                for (let i = 0; i < headers.length; i++) {
                    const header = headers[i];
                    let cellValue = '';
                    let cellClass = '';
                    
                    if (header === "ลำดับ") {
                        cellValue = row.id;
                    } else if (header === "สถานะ") {
                        cellValue = row.status;
                        if (row.status === "ไม่ผ่าน") {
                            cellClass = 'failed-status';
                        } else if (row.status === "ผ่าน") {
                            cellClass = 'passed-status';
                        } else if (row.status === "ต้องตรวจสอบ" || row.status === "ไม่มีข้อมูลวันที่ปลูก") {
                            cellClass = 'warning-status';
                        }
                    } else if (header === "หมายเหตุ") {
                        cellValue = row.notes || '';
                    } else if (header === "เงื่อนไขที่ตรวจ") {
                        cellValue = row.condition || '';
                    } else {
                        // คอลัมน์ข้อมูลอื่นๆ
                        cellValue = row[header] || '';
                        
                        // ตรวจสอบว่าเซลล์นี้มีปัญหาหรือไม่
                        if (row.failedCells && row.failedCells[i]) {
                            cellClass = 'failed-cell';
                        } else if (row.passed && i > 0 && i < headers.length - 3) {
                            cellClass = 'passed-cell';
                        }
                    }
                    
                    htmlContent += `<td class="${cellClass}">${cellValue}</td>`;
                }
                
                htmlContent += `</tr>`;
            });
            
            htmlContent += `
                        </tbody>
                    </table>
                    <div style="margin-top: 20px; font-size: 0.9em; color: #666;">
                        <p><strong>หมายเหตุ:</strong></p>
                        <ul>
                            <li><span style="color: #FF0000; font-weight: bold;">เซลล์สีแดง</span> = ข้อมูลไม่ถูกต้อง/ไม่สัมพันธ์กัน</li>
                            <li><span style="color: #4CAF50; font-weight: bold;">เซลล์สีเขียว</span> = ข้อมูลถูกต้อง/สัมพันธ์กัน</li>
                            <li><span style="color: #FF0000; font-weight: bold;">สถานะสีแดง</span> = แถวนั้นมีปัญหาที่ต้องแก้ไข</li>
                            <li><span style="color: #4CAF50; font-weight: bold;">สถานะสีเขียว</span> = ผ่านการตรวจสอบ</li>
                            <li><span style="color: #FF9800; font-weight: bold;">แถวสีเหลือง</span> = ไม่มีข้อมูลวันที่ปลูก</li>
                            <li><span style="color: #FF9800; font-weight: bold;">สถานะสีเหลือง</span> = ต้องตรวจสอบ/ไม่มีข้อมูลวันที่ปลูก</li>
                        </ul>
                    </div>
                </body>
                </html>
            `;
            
            return htmlContent;
        }
        
        function escapeCSV(text) {
            if (text === null || text === undefined) return '';
            const textStr = String(text);
            // Escape quotes
            return textStr.replace(/"/g, '""');
        }
        
        // ============================================
        // ขั้นตอนที่ 5: เลือกคอลัมน์สำหรับส่งออก
        // ============================================
        nextToStep5.addEventListener('click', function() {
            // ไปยังขั้นตอนที่ 5
            goToStep(5);
        });
        
        function initExportColumnSelection() {
            if (!uploadedData || !selectedColumns) {
                alert('ยังไม่มีข้อมูล กรุณาไปที่ขั้นตอนที่ 1-4 ก่อน');
                return;
            }
            
            // ✅ เริ่มต้นด้วยการเลือกคอลัมน์พื้นฐานที่จำเป็น
            exportColumns = [];
            
            // ค้นหาคอลัมน์ที่ตรงกับรายการที่ต้องการ
            autoExportColumns.forEach(targetCol => {
                const foundColumn = selectedColumns.find(col => 
                    col.toLowerCase().includes(targetCol.toLowerCase())
                );
                
                if (foundColumn && !exportColumns.includes(foundColumn)) {
                    exportColumns.push(foundColumn);
                }
            });
            
            // เพิ่มคอลัมน์อื่นๆ ที่เลือกในขั้นตอนที่ 2 แต่ยังไม่ได้เลือก
            selectedColumns.forEach(col => {
                if (!exportColumns.includes(col)) {
                    // ไม่ต้องเพิ่มอัตโนมัติ ให้ผู้ใช้เลือกเอง
                }
            });
            
            // เรียงลำดับคอลัมน์ตามลำดับเดิมในไฟล์
            exportColumns.sort((a, b) => {
                const indexA = uploadedData.headers.indexOf(a);
                const indexB = uploadedData.headers.indexOf(b);
                return indexA - indexB;
            });
            
            // สร้างรายการคอลัมน์สำหรับเลือก
            renderExportColumnGrid();
            
            // อัพเดตสถิติ
            updateExportColumnStats();
        }
        
        function renderExportColumnGrid() {
            exportColumnsGrid.innerHTML = '';
            
            const searchTerm = columnSearch.value.toLowerCase();
            
            selectedColumns.forEach(column => {
                const columnNameLower = column.toLowerCase();
                const isSelected = exportColumns.includes(column);
                const matchesSearch = searchTerm === '' || columnNameLower.includes(searchTerm);
                
                // ตรวจสอบว่าคอลัมน์นี้เป็นคอลัมน์ที่แนะนำหรือไม่
                const isRecommended = autoExportColumns.some(targetCol => 
                    columnNameLower.includes(targetCol.toLowerCase())
                );
                
                // ตรวจสอบประเภทคอลัมน์
                let columnType = '';
                
                if (columnNameLower.includes('ประเภทอ้อย') || columnNameLower.includes('sugarcane') || 
                    columnNameLower.includes('พันธุ์') || columnNameLower.includes('type')) {
                    columnType = 'ข้อมูลอ้อย';
                } else if (columnNameLower.includes('อายุ') || columnNameLower.includes('age') ||
                          columnNameLower.includes('งวด') || columnNameLower.includes('period') ||
                          columnNameLower.includes('กิจกรรม') || columnNameLower.includes('activity')) {
                    columnType = 'กิจกรรมงวด';
                } else if (columnNameLower.includes('โครงการ') || columnNameLower.includes('project')) {
                    columnType = 'โครงการ';
                } else if (columnNameLower.includes('ปุ๋ย') || columnNameLower.includes('fertilizer') ||
                          columnNameLower.includes('ยา') || columnNameLower.includes('chemical')) {
                    columnType = 'ปุ๋ย';
                } else if (columnNameLower.includes('วันที่') || columnNameLower.includes('date')) {
                    columnType = 'วันที่';
                } else if (columnNameLower.includes('รหัส') || columnNameLower.includes('code') || 
                          columnNameLower.includes('id') || columnNameLower.includes('หมายเลข')) {
                    columnType = 'รหัส';
                } else if (columnNameLower.includes('จำนวน') || columnNameLower.includes('quantity') ||
                          columnNameLower.includes('ปริมาณ') || columnNameLower.includes('amount') ||
                          columnNameLower.includes('พื้นที่') || columnNameLower.includes('area')) {
                    columnType = 'จำนวน';
                } else if (columnNameLower === 'lat' || columnNameLower === 'latitude') {
                    columnType = 'พิกัด lat';
                } else if (columnNameLower === 'long' || columnNameLower === 'longitude') {
                    columnType = 'พิกัด long';
                } else {
                    columnType = 'ข้อมูลทั่วไป';
                }
                
                // ตรวจสอบว่าควรแสดงคอลัมน์นี้ตาม filter ปัจจุบันหรือไม่
                let shouldShow = matchesSearch;
                
                if (currentColumnFilter === 'selected') {
                    shouldShow = shouldShow && isSelected;
                } else if (currentColumnFilter === 'unselected') {
                    shouldShow = shouldShow && !isSelected;
                } else if (currentColumnFilter === 'recommended') {
                    shouldShow = shouldShow && isRecommended;
                }
                
                const columnItem = document.createElement('div');
                columnItem.className = `export-column-item ${isSelected ? 'selected' : ''} ${isRecommended ? 'recommended' : ''}`;
                columnItem.style.display = shouldShow ? 'flex' : 'none';
                
                columnItem.innerHTML = `
                    <input type="checkbox" class="export-column-checkbox" ${isSelected ? 'checked' : ''} data-column="${column}">
                    <div class="export-column-info">
                        <div class="export-column-name" title="${column}">${column}</div>
                        <span class="export-column-type">${columnType}</span>
                        ${isRecommended ? '<span style="color: #4CAF50; font-size: 0.7rem; margin-left: 5px;"><i class="fas fa-star"></i> แนะนำ</span>' : ''}
                    </div>
                `;
                
                exportColumnsGrid.appendChild(columnItem);
                
                // เพิ่ม event listener สำหรับ checkbox
                const checkbox = columnItem.querySelector('.export-column-checkbox');
                checkbox.addEventListener('change', function() {
                    const columnName = this.dataset.column;
                    
                    if (this.checked) {
                        if (!exportColumns.includes(columnName)) {
                            exportColumns.push(columnName);
                        }
                    } else {
                        const index = exportColumns.indexOf(columnName);
                        if (index > -1) {
                            exportColumns.splice(index, 1);
                        }
                    }
                    
                    // อัพเดต UI
                    columnItem.classList.toggle('selected', this.checked);
                    updateExportColumnStats();
                });
            });
            
            // อัพเดตจำนวนคอลัมน์ที่แสดง
            updateExportFilteredCount();
        }
        
        function updateExportColumnStats() {
            exportSelectedCount.textContent = exportColumns.length;
            
            if (exportColumns.length === 0) {
                exportColumnsList.textContent = 'ยังไม่ได้เลือกคอลัมน์';
            } else {
                const displayedColumns = exportColumns.slice(0, 5);
                const moreCount = exportColumns.length - 5;
                exportColumnsList.textContent = displayedColumns.join(', ') + 
                    (moreCount > 0 ? ` และอีก ${moreCount} คอลัมน์...` : '');
            }
        }
        
        function updateExportFilteredCount() {
            const visibleColumns = Array.from(exportColumnsGrid.querySelectorAll('.export-column-item'))
                .filter(item => item.style.display !== 'none');
            // ไม่มี element สำหรับแสดงจำนวนที่กรองในขั้นตอนนี้
        }
        
        // Export filter buttons
        document.querySelectorAll('#panel5 .selection-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // อัพเดตปุ่มที่ active
                document.querySelectorAll('#panel5 .selection-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // ตั้งค่าตัวกรอง
                currentColumnFilter = this.dataset.filter;
                
                // กรองคอลัมน์
                renderExportColumnGrid();
            });
        });
        
        // Export Select all / Deselect all
        exportSelectAllBtn.addEventListener('click', function() {
            const visibleColumns = Array.from(exportColumnsGrid.querySelectorAll('.export-column-item'))
                .filter(item => item.style.display !== 'none');
            
            visibleColumns.forEach(item => {
                const checkbox = item.querySelector('.export-column-checkbox');
                const columnName = checkbox.dataset.column;
                
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    if (!exportColumns.includes(columnName)) {
                        exportColumns.push(columnName);
                    }
                    item.classList.add('selected');
                }
            });
            
            updateExportColumnStats();
        });
        
        exportDeselectAllBtn.addEventListener('click', function() {
            const visibleColumns = Array.from(exportColumnsGrid.querySelectorAll('.export-column-item'))
                .filter(item => item.style.display !== 'none');
            
            visibleColumns.forEach(item => {
                const checkbox = item.querySelector('.export-column-checkbox');
                const columnName = checkbox.dataset.column;
                
                if (checkbox.checked) {
                    checkbox.checked = false;
                    const index = exportColumns.indexOf(columnName);
                    if (index > -1) {
                        exportColumns.splice(index, 1);
                    }
                    item.classList.remove('selected');
                }
            });
            
            updateExportColumnStats();
        });
        
        // ============================================
        // ดาวน์โหลดข้อมูลที่ Clean แล้ว (ขั้นตอนที่ 5)
        // ============================================
        downloadCleanData.addEventListener('click', function() {
            if (!uploadedData) {
                alert('ไม่พบข้อมูล');
                return;
            }
            
            if (exportColumns.length === 0) {
                alert('ไม่มีคอลัมน์ที่เลือกสำหรับส่งออก');
                return;
            }
            
            // ✅ แก้ไข: ใช้คอลัมน์ตามลำดับเดิมในไฟล์ต้นฉบับ
            const exportColumnsOrdered = [];
            
            // เรียงลำดับคอลัมน์ตามไฟล์ต้นฉบับ
            uploadedData.headers.forEach(header => {
                if (exportColumns.includes(header)) {
                    exportColumnsOrdered.push(header);
                }
            });
            
            // สร้าง CSV จากคอลัมน์ที่เลือก
            let csvContent = '';
            
            // เพิ่ม BOM สำหรับ UTF-8 เพื่อให้ Excel อ่านภาษาไทยได้ถูกต้อง
            csvContent += '\ufeff';
            
            // ✅ แก้ไข: ใช้คอลัมน์ตามลำดับเดิม
            csvContent += exportColumnsOrdered.join(',') + '\n';
            
            // เพิ่มข้อมูล
            uploadedData.data.forEach(row => {
                const rowValues = exportColumnsOrdered.map(col => {
                    let value = row[col] || '';
                    
                    // แปลงอักขระพิเศษ
                    value = value.replace(/"/g, '""'); // Escape quotes
                    
                    // ใส่ quotes ถ้ามี comma หรือ newline
                    if (value.includes(',') || value.includes('\n') || value.includes('\r') || value.includes('"')) {
                        value = `"${value}"`;
                    }
                    
                    return value;
                });
                csvContent += rowValues.join(',') + '\n';
            });
            
            // สร้าง blob และดาวน์โหลด
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `cleaned_${uploadedData.fileName.replace('.csv', '')}_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('✅ ดาวน์โหลดไฟล์ที่ clean แล้วเรียบร้อย!\nจำนวนคอลัมน์: ' + exportColumnsOrdered.length + '\nจำนวนแถว: ' + uploadedData.data.length + '\n✅ คอลัมน์เรียงตามลำดับเดิมในไฟล์ต้นฉบับ');
        });
        
        // ============================================
        // ฟังก์ชันการนำทาง
        // ============================================
        backToStep1.addEventListener('click', function() {
            goToStep(1);
        });
        
        backToStep2.addEventListener('click', function() {
            goToStep(2);
        });
        
        backToStep3.addEventListener('click', function() {
            goToStep(3);
        });
        
        backToStep4.addEventListener('click', function() {
            goToStep(4);
        });
        
        // ============================================
        // เริ่มต้นระบบ
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // ตั้งค่า event listeners สำหรับฟังก์ชันใหม่
            setupEnhancedEventListeners();
            
            console.log('✅ ระบบตรวจสอบข้อมูลอ้อยพร้อมใช้งาน');
        });
    </script>
</body>
</html>
